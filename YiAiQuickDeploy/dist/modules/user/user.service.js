'use strict';const _0x25a50f=_0x1353;function _0x19ce(){const _0x3028e=['用户名已存在！','formatCreateOrUpdateDate','updateInfo','HttpException','digest','createUserFromOpenId','updateUserPassword','用户名已存在、请更换用户名！','4295135uwFQnw','__decorate','修改用户信息失败！','当前用户信息失效、请重新登录！','ConfigEntity','userEntity','10017495odqSIP','openId','VerificationService','username','error:\x20','3631639LxGifN','queryUserInfoById','maskEmail','map','./user.entity','updateUserStatus','无效的邀请码！','../verification/verification.service','split','$2y$','getInviteRecord','UserStatusEnum','BAD_REQUEST','UserService','createRandomUid','avatar','@nestjs/common','assign','getUserInfo','createUserAndVerifycation','用户名或者邮箱已被注册！','__param','status','@default.com','addBalanceToNewUser','超级管理员不可被操作！','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','Repository','consecutiveDays','__metadata','save','sign','queryOneUserInfo','startsWith','DESC','addBalanceToUser','whiteListEntity','LOCKED','getOwnPropertyDescriptor','forEach','cloneDeep','password','getConfigs','RechargeType','design:paramtypes','GlobalConfigService','client','getUserStatus','createHash','Not','crypto','userBalanceService','13530kVZVyk','userRecharge','verificationService','35yUIHYR','maskIpAddress','compareSync','length','userDefautlAvatar','ACTIVE','phone','findOne','role','132pwUPJt','verifyUserCredentials','Injectable','checkUserStatus','defineProperty','1001048UjBXic','3838ZDXZmC','getSuper','$2b$','findAndCount','qureyUserInfoByInviteCode','已生成过邀请码、请勿重复生成','decorate','../userBalance/userBalance.service','PENDING','getClientIp','verifyUserRegisterByPhone','md5','inviteLink','queryOne','update','MailerService','@nestjs-modules/mailer','修改用户状态成功！','$2a$','FORBIDDEN','不可将用户置为未激活状态！','136qUTkTn','hashSync','../chatgpt/whiteList.entity','find','BLACKLISTED','当前账户不存在！','当前用户不存在！','ADMIN_GIFT','user','registerIp','6gIUFbg','Connection','generateRandomString','lodash','InjectRepository','lastLoginIp','mailerService','当前绑定用户不存在！','connection','449LxKCyi','affected','globalConfigService','function','getUserOpenId','UNAUTHORIZED','WhiteListEntity','9270250QEHmYx','email','Like',']成功!','当前密码错误！','resetUserPass','重置密码失败！','您的账户已被封禁、如有疑问、请联系管理员！','createUser','HttpStatus','isBindWx','@nestjs/typeorm','hex','----,','该微信已绑定其他账号！','super','log','metadata','用户不存在！','saveRecordRechargeLog','inviteCode','绑定微信失败、请联系管理员！','修改用户状态失败！','updateStatus'];_0x19ce=function(){return _0x3028e;};return _0x19ce();}(function(_0x2433e6,_0x54dc53){const _0x500ee3=_0x1353,_0x10b5bc=_0x2433e6();while(!![]){try{const _0x1a3537=-parseInt(_0x500ee3(0x203))/0x1*(-parseInt(_0x500ee3(0x27b))/0x2)+-parseInt(_0x500ee3(0x269))/0x3*(parseInt(_0x500ee3(0x1f0))/0x4)+-parseInt(_0x500ee3(0x22a))/0x5*(-parseInt(_0x500ee3(0x1fa))/0x6)+-parseInt(_0x500ee3(0x26c))/0x7*(-parseInt(_0x500ee3(0x27a))/0x8)+parseInt(_0x500ee3(0x230))/0x9+parseInt(_0x500ee3(0x20a))/0xa+-parseInt(_0x500ee3(0x235))/0xb*(parseInt(_0x500ee3(0x275))/0xc);if(_0x1a3537===_0x54dc53)break;else _0x10b5bc['push'](_0x10b5bc['shift']());}catch(_0x1a7570){_0x10b5bc['push'](_0x10b5bc['shift']());}}}(_0x19ce,0x92d46));function _0x1353(_0x24bcd4,_0x255cbc){const _0x19cec2=_0x19ce();return _0x1353=function(_0x135357,_0x3bc45d){_0x135357=_0x135357-0x1e7;let _0x1ae75d=_0x19cec2[_0x135357];return _0x1ae75d;},_0x1353(_0x24bcd4,_0x255cbc);}var __decorate=this&&this[_0x25a50f(0x22b)]||function(_0xc9464e,_0x962e62,_0x121a45,_0x6a546f){const _0x54a932=_0x25a50f;var _0x15509d=arguments['length'],_0x4e4f8b=_0x15509d<0x3?_0x962e62:_0x6a546f===null?_0x6a546f=Object[_0x54a932(0x25b)](_0x962e62,_0x121a45):_0x6a546f,_0x1ed714;if(typeof Reflect==='object'&&typeof Reflect[_0x54a932(0x281)]===_0x54a932(0x206))_0x4e4f8b=Reflect[_0x54a932(0x281)](_0xc9464e,_0x962e62,_0x121a45,_0x6a546f);else{for(var _0xb0443d=_0xc9464e[_0x54a932(0x26f)]-0x1;_0xb0443d>=0x0;_0xb0443d--)if(_0x1ed714=_0xc9464e[_0xb0443d])_0x4e4f8b=(_0x15509d<0x3?_0x1ed714(_0x4e4f8b):_0x15509d>0x3?_0x1ed714(_0x962e62,_0x121a45,_0x4e4f8b):_0x1ed714(_0x962e62,_0x121a45))||_0x4e4f8b;}return _0x15509d>0x3&&_0x4e4f8b&&Object[_0x54a932(0x279)](_0x962e62,_0x121a45,_0x4e4f8b),_0x4e4f8b;},__metadata=this&&this[_0x25a50f(0x252)]||function(_0xb828be,_0x1b1496){const _0x42cd5b=_0x25a50f;if(typeof Reflect==='object'&&typeof Reflect[_0x42cd5b(0x21b)]===_0x42cd5b(0x206))return Reflect[_0x42cd5b(0x21b)](_0xb828be,_0x1b1496);},__param=this&&this[_0x25a50f(0x24a)]||function(_0x3e3b66,_0x6364b0){return function(_0x3b9da3,_0x224400){_0x6364b0(_0x3b9da3,_0x224400,_0x3e3b66);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['UserService']=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require(_0x25a50f(0x1eb)),verification_service_1=require(_0x25a50f(0x23c)),common_1=require(_0x25a50f(0x245)),typeorm_1=require(_0x25a50f(0x215)),typeorm_2=require('typeorm'),user_entity_1=require(_0x25a50f(0x239)),bcrypt=require('bcryptjs'),crypto=require(_0x25a50f(0x267)),_=require(_0x25a50f(0x1fd)),userBalance_service_1=require(_0x25a50f(0x282)),utils_1=require('../../common/utils'),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require('../globalConfig/config.entity'),whiteList_entity_1=require(_0x25a50f(0x1f2));let UserService=class UserService{constructor(_0x17e653,_0x932329,_0x1d581e,_0x54ae4b,_0x520754,_0xe4d4cd,_0x58664c,_0x261895){const _0xeaf744=_0x25a50f;this['userEntity']=_0x17e653,this[_0xeaf744(0x259)]=_0x932329,this[_0xeaf744(0x202)]=_0x1d581e,this[_0xeaf744(0x26b)]=_0x54ae4b,this[_0xeaf744(0x200)]=_0x520754,this['userBalanceService']=_0xe4d4cd,this['globalConfigService']=_0x58664c,this['configEntity']=_0x261895;}async[_0x25a50f(0x248)](_0x367a44,_0xaaa85a){const _0x510fd9=_0x25a50f,{username:_0x1af056,email:_0x1e7c92,password:_0x202f3a,invitedBy:_0x276909,client:client=0x0}=_0x367a44;if(_0x276909){const _0xfc65e6=await this[_0x510fd9(0x22f)][_0x510fd9(0x273)]({'where':{'inviteCode':_0x276909}});if(!_0xfc65e6)throw new common_1[(_0x510fd9(0x225))](_0x510fd9(0x23b),common_1[_0x510fd9(0x213)][_0x510fd9(0x241)]);}const _0xef432=[{'username':_0x1af056},{'email':_0x1e7c92}],_0x2d5e9f=await this['userEntity'][_0x510fd9(0x273)]({'where':_0xef432});if(_0x2d5e9f&&_0x2d5e9f[_0x510fd9(0x24b)]!==user_constant_1['UserStatusEnum'][_0x510fd9(0x283)])throw new common_1[(_0x510fd9(0x225))](_0x510fd9(0x249),common_1[_0x510fd9(0x213)][_0x510fd9(0x241)]);try{const _0xb4e046=_[_0x510fd9(0x25d)](_0x367a44),_0x27a08b=bcrypt[_0x510fd9(0x1f1)](_0x202f3a,0xa),_0x5d64db=(0x0,utils_1[_0x510fd9(0x284)])(_0xaaa85a);_0xb4e046[_0x510fd9(0x25e)]=_0x27a08b,_0xb4e046[_0x510fd9(0x1f9)]=_0x5d64db,_0xb4e046[_0x510fd9(0x263)]=client;let _0x537e23;if(!_0x2d5e9f){const _0x19dc57=await this[_0x510fd9(0x205)][_0x510fd9(0x25f)](['userDefautlAvatar']);_0xb4e046[_0x510fd9(0x244)]=_0x19dc57,_0x537e23=await this['userEntity']['save'](_0xb4e046);}else _0x537e23=_0x2d5e9f;const {username:_0x3619fb,email:_0x40084c,id:_0x186dd0,invitedBy:_0x3ecda9}=_0x537e23;await this[_0x510fd9(0x23a)](_0x186dd0,user_constant_1[_0x510fd9(0x240)][_0x510fd9(0x271)]);let _0x54bfc0;return _0x3ecda9&&(_0x54bfc0=await this[_0x510fd9(0x27f)](_0x3ecda9)),await this[_0x510fd9(0x268)][_0x510fd9(0x24d)](_0x186dd0,_0x54bfc0===null||_0x54bfc0===void 0x0?void 0x0:_0x54bfc0['id']),_0x537e23;}catch(_0x1d022a){console['log'](_0x510fd9(0x234),_0x1d022a);throw _0x1d022a;}}async[_0x25a50f(0x27c)](){const _0x5e1be2=_0x25a50f,_0x526868=await this[_0x5e1be2(0x22f)][_0x5e1be2(0x273)]({'where':{'role':_0x5e1be2(0x219)}});return _0x526868;}async[_0x25a50f(0x276)](_0x4a889c){const _0x3f2a94=_0x25a50f,{username:_0x406148,password:_0x8d0c05,uid:uid=0x0,phone:_0x1269ab}=_0x4a889c;let _0x403a75=null;if(uid>0x0){_0x403a75=await this[_0x3f2a94(0x22f)][_0x3f2a94(0x273)]({'where':{'id':uid}});if(!_0x403a75)throw new common_1[(_0x3f2a94(0x225))](_0x3f2a94(0x1f5),common_1[_0x3f2a94(0x213)][_0x3f2a94(0x1ee)]);if(_0x403a75['password'][_0x3f2a94(0x256)](_0x3f2a94(0x1ed))||_0x403a75[_0x3f2a94(0x25e)]['startsWith'](_0x3f2a94(0x27d))||_0x403a75[_0x3f2a94(0x25e)][_0x3f2a94(0x256)](_0x3f2a94(0x23e))){if(!bcrypt[_0x3f2a94(0x26e)](_0x8d0c05,_0x403a75[_0x3f2a94(0x25e)]))throw new common_1[(_0x3f2a94(0x225))](_0x3f2a94(0x20e),common_1[_0x3f2a94(0x213)][_0x3f2a94(0x241)]);}else{console[_0x3f2a94(0x21a)](_0x3f2a94(0x217));const _0x26d944=crypto[_0x3f2a94(0x265)](_0x3f2a94(0x286))['update'](_0x8d0c05)[_0x3f2a94(0x226)]('hex');console['log']('----,',_0x26d944);if(_0x26d944!==_0x403a75[_0x3f2a94(0x25e)])throw new common_1[(_0x3f2a94(0x225))](_0x3f2a94(0x20e),common_1['HttpStatus'][_0x3f2a94(0x241)]);}}if(_0x406148&&_0x8d0c05){const _0x2cbc6e=[{'username':_0x406148},{'email':_0x406148}];_0x403a75=await this[_0x3f2a94(0x22f)][_0x3f2a94(0x273)]({'where':_0x2cbc6e});if(!_0x403a75)throw new common_1[(_0x3f2a94(0x225))](_0x3f2a94(0x1f5),common_1['HttpStatus'][_0x3f2a94(0x1ee)]);if(_0x403a75[_0x3f2a94(0x25e)]['startsWith'](_0x3f2a94(0x1ed))||_0x403a75[_0x3f2a94(0x25e)][_0x3f2a94(0x256)]('$2b$')||_0x403a75[_0x3f2a94(0x25e)][_0x3f2a94(0x256)]('$2y$')){if(!bcrypt[_0x3f2a94(0x26e)](_0x8d0c05,_0x403a75['password']))throw new common_1[(_0x3f2a94(0x225))](_0x3f2a94(0x20e),common_1[_0x3f2a94(0x213)][_0x3f2a94(0x241)]);}else{console[_0x3f2a94(0x21a)](_0x3f2a94(0x217));const _0x113c2a=crypto[_0x3f2a94(0x265)](_0x3f2a94(0x286))[_0x3f2a94(0x1e9)](_0x8d0c05)[_0x3f2a94(0x226)]('hex');console[_0x3f2a94(0x21a)](_0x3f2a94(0x217),_0x113c2a);if(_0x113c2a!==_0x403a75['password'])throw new common_1[(_0x3f2a94(0x225))](_0x3f2a94(0x20e),common_1[_0x3f2a94(0x213)][_0x3f2a94(0x241)]);}}if(_0x1269ab&&_0x8d0c05){const _0x1428a2=[{'phone':_0x1269ab}];_0x403a75=await this['userEntity'][_0x3f2a94(0x273)]({'where':_0x1428a2});if(!_0x403a75)throw new common_1[(_0x3f2a94(0x225))](_0x3f2a94(0x1f5),common_1[_0x3f2a94(0x213)][_0x3f2a94(0x1ee)]);if(_0x403a75[_0x3f2a94(0x25e)]['startsWith'](_0x3f2a94(0x1ed))||_0x403a75['password'][_0x3f2a94(0x256)](_0x3f2a94(0x27d))||_0x403a75[_0x3f2a94(0x25e)][_0x3f2a94(0x256)](_0x3f2a94(0x23e))){if(!bcrypt['compareSync'](_0x8d0c05,_0x403a75[_0x3f2a94(0x25e)]))throw new common_1[(_0x3f2a94(0x225))]('当前密码错误！',common_1[_0x3f2a94(0x213)][_0x3f2a94(0x241)]);}else{console[_0x3f2a94(0x21a)](_0x3f2a94(0x217));const _0x7641fb=crypto['createHash'](_0x3f2a94(0x286))[_0x3f2a94(0x1e9)](_0x8d0c05)[_0x3f2a94(0x226)](_0x3f2a94(0x216));console[_0x3f2a94(0x21a)]('----,',_0x7641fb);if(_0x7641fb!==_0x403a75[_0x3f2a94(0x25e)])throw new common_1[(_0x3f2a94(0x225))]('当前密码错误！',common_1['HttpStatus'][_0x3f2a94(0x241)]);}}if(!_0x403a75)throw new common_1[(_0x3f2a94(0x225))]('当前账户不存在！',common_1[_0x3f2a94(0x213)][_0x3f2a94(0x1ee)]);if(_0x403a75[_0x3f2a94(0x24b)]!==user_constant_1[_0x3f2a94(0x240)]['ACTIVE'])throw new common_1[(_0x3f2a94(0x225))](user_constant_1['UserStatusErrMsg'][_0x403a75[_0x3f2a94(0x24b)]],common_1[_0x3f2a94(0x213)]['BAD_REQUEST']);return _0x403a75;}async['verifyUserPassword'](_0xb925e4,_0x57ec60){const _0x45be42=_0x25a50f,_0x4ea542=await this[_0x45be42(0x22f)][_0x45be42(0x273)]({'where':{'id':_0xb925e4}});if(_0x4ea542[_0x45be42(0x25e)][_0x45be42(0x256)]('$2a$')||_0x4ea542['password'][_0x45be42(0x256)](_0x45be42(0x27d))||_0x4ea542[_0x45be42(0x25e)][_0x45be42(0x256)](_0x45be42(0x23e)))return bcrypt[_0x45be42(0x26e)](_0x57ec60,_0x4ea542[_0x45be42(0x25e)]);else{const _0x11294d=crypto['createHash'](_0x45be42(0x286))[_0x45be42(0x1e9)](_0x57ec60)[_0x45be42(0x226)](_0x45be42(0x216));return console[_0x45be42(0x21a)](_0x45be42(0x217),_0x11294d),_0x11294d===_0x4ea542[_0x45be42(0x25e)];}}async['updateUserStatus'](_0x284e97,_0x1f717f){const _0x504580=_0x25a50f,_0x5a6369=await this[_0x504580(0x22f)]['update']({'id':_0x284e97},{'status':_0x1f717f});return _0x5a6369[_0x504580(0x204)]>0x0;}async[_0x25a50f(0x264)](_0x59f76d){const _0x51b614=_0x25a50f,_0x54be8b=await this[_0x51b614(0x22f)][_0x51b614(0x273)]({'where':{'id':_0x59f76d}});return _0x54be8b[_0x51b614(0x24b)];}async[_0x25a50f(0x236)](_0x4f0884){const _0x5d4016=_0x25a50f;return await this[_0x5d4016(0x22f)]['findOne']({'where':{'id':_0x4f0884}});}async[_0x25a50f(0x255)](_0x4dea54){const _0x584545=_0x25a50f;return await this[_0x584545(0x22f)][_0x584545(0x273)]({'where':{'id':_0x4dea54}});}async[_0x25a50f(0x278)](_0x99d170){const _0xfaa69f=_0x25a50f,{id:_0xf03cd2,role:_0x262986}=_0x99d170;if(_0x262986==='visitor')return!![];const _0x17e08b=await this[_0xfaa69f(0x22f)][_0xfaa69f(0x273)]({'where':{'id':_0xf03cd2}});if(!_0x17e08b)throw new common_1['HttpException'](_0xfaa69f(0x22d),common_1['HttpStatus']['UNAUTHORIZED']);if(_0x17e08b[_0xfaa69f(0x24b)]===user_constant_1['UserStatusEnum'][_0xfaa69f(0x1f4)])throw new common_1['HttpException'](_0xfaa69f(0x24f),common_1['HttpStatus']['BAD_REQUEST']);if(_0x17e08b[_0xfaa69f(0x24b)]===user_constant_1[_0xfaa69f(0x240)][_0xfaa69f(0x25a)])throw new common_1[(_0xfaa69f(0x225))](_0xfaa69f(0x211),common_1[_0xfaa69f(0x213)][_0xfaa69f(0x241)]);}async[_0x25a50f(0x247)](_0x109f5a){const _0x4bfba3=_0x25a50f,_0x3f494d=await this['userEntity'][_0x4bfba3(0x273)]({'where':{'id':_0x109f5a},'select':[_0x4bfba3(0x233),_0x4bfba3(0x244),_0x4bfba3(0x274),_0x4bfba3(0x20b),_0x4bfba3(0x254),_0x4bfba3(0x21e),_0x4bfba3(0x231),_0x4bfba3(0x251)]});if(!_0x3f494d)throw new common_1[(_0x4bfba3(0x225))](_0x4bfba3(0x22d),common_1[_0x4bfba3(0x213)][_0x4bfba3(0x208)]);_0x3f494d[_0x4bfba3(0x214)]=!!(_0x3f494d===null||_0x3f494d===void 0x0?void 0x0:_0x3f494d[_0x4bfba3(0x231)]),delete _0x3f494d[_0x4bfba3(0x231)];const _0x180def=await this[_0x4bfba3(0x268)]['queryUserBalance'](_0x109f5a);return{'userInfo':_0x3f494d,'userBalance':Object[_0x4bfba3(0x246)]({},_0x180def)};}async['getUserById'](_0x328d6d){return await this['userEntity']['findOne']({'where':{'id':_0x328d6d}});}async[_0x25a50f(0x207)](_0x240a4f){const _0x981aa8=_0x25a50f;return await this[_0x981aa8(0x22f)][_0x981aa8(0x273)]({'where':{'openId':_0x240a4f}});}async[_0x25a50f(0x224)](_0x123aaf,_0x2761a6){const _0x4d0163=_0x25a50f,{id:_0x3b2b48}=_0x2761a6[_0x4d0163(0x1f8)],_0x544fb9=await this[_0x4d0163(0x22f)][_0x4d0163(0x273)]({'where':{'id':_0x3b2b48}});if(!_0x544fb9)throw new common_1[(_0x4d0163(0x225))](_0x4d0163(0x1f6),common_1['HttpStatus'][_0x4d0163(0x241)]);if(_0x123aaf['username']&&_0x544fb9[_0x4d0163(0x233)]===_0x123aaf[_0x4d0163(0x233)])throw new common_1[(_0x4d0163(0x225))]('没有变更，无需更改！',common_1[_0x4d0163(0x213)][_0x4d0163(0x241)]);if(_0x123aaf[_0x4d0163(0x233)]){const _0x3b87aa=await this[_0x4d0163(0x22f)]['findOne']({'where':{'username':_0x123aaf[_0x4d0163(0x233)],'id':(0x0,typeorm_2[_0x4d0163(0x266)])(_0x3b2b48)}});if(_0x3b87aa)throw new common_1[(_0x4d0163(0x225))](_0x4d0163(0x222),common_1[_0x4d0163(0x213)][_0x4d0163(0x241)]);}const _0x50c958=await this[_0x4d0163(0x22f)][_0x4d0163(0x1e9)]({'id':_0x3b2b48},_0x123aaf);if(_0x50c958['affected']<=0x0)throw new common_1[(_0x4d0163(0x225))](_0x4d0163(0x22c),common_1[_0x4d0163(0x213)]['BAD_REQUEST']);return'修改用户信息成功！';}async[_0x25a50f(0x228)](_0x4a661d,_0x1ce4d8){const _0xff98fd=_0x25a50f,_0x5cbc29=bcrypt[_0xff98fd(0x1f1)](_0x1ce4d8,0xa),_0x56f72b=await this[_0xff98fd(0x22f)]['update']({'id':_0x4a661d},{'password':_0x5cbc29});if(_0x56f72b[_0xff98fd(0x204)]<=0x0)throw new common_1[(_0xff98fd(0x225))]('修改密码失败、请重新试试吧。',common_1[_0xff98fd(0x213)][_0xff98fd(0x241)]);}async['genInviteCode'](_0xa90033){const _0x56879c=_0x25a50f,{id:_0x5a7fc0}=_0xa90033[_0x56879c(0x1f8)],_0x52f86b=await this[_0x56879c(0x22f)][_0x56879c(0x273)]({'where':{'id':_0x5a7fc0}});if(!_0x52f86b||_0x52f86b[_0x56879c(0x21e)])throw new common_1[(_0x56879c(0x225))](_0x56879c(0x280),common_1[_0x56879c(0x213)][_0x56879c(0x241)]);const _0x343997=(0x0,utils_1[_0x56879c(0x1fc)])(),_0x4a3738=await this[_0x56879c(0x22f)]['findOne']({'where':{'inviteCode':_0x343997}});if(_0x4a3738)throw new common_1['HttpException']('生成邀请码失败，请重新试一次吧！',common_1[_0x56879c(0x213)][_0x56879c(0x241)]);const _0x4998d4=await this[_0x56879c(0x22f)]['update']({'id':_0x5a7fc0},{'inviteCode':_0x343997});if(_0x4998d4[_0x56879c(0x204)]<=0x0)throw new common_1[(_0x56879c(0x225))]('生成邀请码失败，请重新试一次吧！',common_1[_0x56879c(0x213)]['BAD_REQUEST']);return _0x343997;}async[_0x25a50f(0x23f)](_0x8bec33,_0x312a58){const _0x12a6f2=_0x25a50f;try{const {id:_0x28a84e}=_0x8bec33[_0x12a6f2(0x1f8)],{page:page=0x1,size:size=0xa}=_0x312a58,_0x70b6d2=await this['userEntity'][_0x12a6f2(0x273)]({'where':{'id':_0x28a84e}}),{inviteCode:_0x9f5694}=_0x70b6d2;if(!_0x9f5694)return[];const [_0xfad99c,_0x1de342]=await this[_0x12a6f2(0x22f)][_0x12a6f2(0x27e)]({'where':{'inviteCode':_0x9f5694},'order':{'id':_0x12a6f2(0x257)},'select':[_0x12a6f2(0x233),_0x12a6f2(0x20b),'createdAt','status',_0x12a6f2(0x244)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x12a6f2(0x223)])(_0xfad99c)[_0x12a6f2(0x238)](_0x5b45c7=>{const _0xd510e1=_0x12a6f2;return _0x5b45c7[_0xd510e1(0x20b)]=(0x0,utils_1[_0xd510e1(0x237)])(_0x5b45c7[_0xd510e1(0x20b)]),_0x5b45c7;}),{'rows':_0xfad99c,'count':_0x1de342};}catch(_0x210bcf){console[_0x12a6f2(0x21a)](_0x12a6f2(0x234),_0x210bcf);throw new common_1[(_0x12a6f2(0x225))]('获取邀请记录失败！',common_1[_0x12a6f2(0x213)][_0x12a6f2(0x241)]);}}async[_0x25a50f(0x1e7)](_0x4e1a30){const _0x4008d8=_0x25a50f,_0x1b4789=await this[_0x4008d8(0x22f)][_0x4008d8(0x273)]({'where':{'inviteCode':_0x4e1a30}});if(!_0x1b4789)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x1b4789,_0x3b8e30=await this['userEntity'][_0x4008d8(0x1e9)]({'inviteCode':_0x4e1a30},{'inviteLinkCount':inviteLinkCount+0x1});return _0x3b8e30[_0x4008d8(0x204)]?0x1:0x0;}async[_0x25a50f(0x27f)](_0x53eb54){const _0x5e3ba7=_0x25a50f;return await this[_0x5e3ba7(0x22f)][_0x5e3ba7(0x273)]({'where':{'inviteCode':_0x53eb54}});}async[_0x25a50f(0x26a)](_0x137876){const _0x14ac1e=_0x25a50f,{userId:_0x25be8e,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x137876;await this[_0x14ac1e(0x268)][_0x14ac1e(0x258)](_0x25be8e,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0xc21dea=await this[_0x14ac1e(0x268)][_0x14ac1e(0x21d)]({'userId':_0x25be8e,'rechargeType':balance_constant_1[_0x14ac1e(0x260)][_0x14ac1e(0x1f7)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0xc21dea;}async['queryAll'](_0x11b3d7,_0x5e758c){const _0x206ac1=_0x25a50f,{page:page=0x1,size:size=0xa,username:_0x1e0401,email:_0x10de2c,status:_0x3a97ed,keyword:_0x3f4d4a,phone:_0x5b98f3}=_0x11b3d7;let _0x4fb4e1={};_0x1e0401&&Object['assign'](_0x4fb4e1,{'username':(0x0,typeorm_2[_0x206ac1(0x20c)])('%'+_0x1e0401+'%')}),_0x10de2c&&Object[_0x206ac1(0x246)](_0x4fb4e1,{'email':(0x0,typeorm_2['Like'])('%'+_0x10de2c+'%')}),_0x5b98f3&&Object[_0x206ac1(0x246)](_0x4fb4e1,{'phone':(0x0,typeorm_2[_0x206ac1(0x20c)])('%'+_0x5b98f3+'%')}),_0x3a97ed&&Object[_0x206ac1(0x246)](_0x4fb4e1,{'status':_0x3a97ed});_0x3f4d4a&&(_0x4fb4e1=[{'username':(0x0,typeorm_2[_0x206ac1(0x20c)])('%'+_0x3f4d4a+'%')},{'email':(0x0,typeorm_2['Like'])('%'+_0x3f4d4a+'%')},{'phone':(0x0,typeorm_2[_0x206ac1(0x20c)])('%'+_0x3f4d4a+'%')}]);const [_0x278e64,_0x4a7488]=await this[_0x206ac1(0x22f)][_0x206ac1(0x27e)]({'skip':(page-0x1)*size,'where':_0x4fb4e1,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x206ac1(0x233),_0x206ac1(0x244),_0x206ac1(0x21e),_0x206ac1(0x274),_0x206ac1(0x254),_0x206ac1(0x24b),'id','email','createdAt',_0x206ac1(0x1ff),_0x206ac1(0x272)]}),_0xfa04da=_0x278e64[_0x206ac1(0x238)](_0x1f1376=>_0x1f1376['id']),_0x4a45f2=await this[_0x206ac1(0x268)]['queryUserBalanceByIds'](_0xfa04da);return _0x278e64[_0x206ac1(0x25c)](_0x434102=>_0x434102['balanceInfo']=_0x4a45f2[_0x206ac1(0x1f3)](_0x3269e2=>_0x3269e2['userId']===_0x434102['id'])),_0x5e758c['user'][_0x206ac1(0x274)]!=='super'&&_0x278e64['forEach'](_0x3126dc=>_0x3126dc[_0x206ac1(0x20b)]=(0x0,utils_1[_0x206ac1(0x237)])(_0x3126dc[_0x206ac1(0x20b)])),_0x5e758c['user'][_0x206ac1(0x274)]!=='super'&&_0x278e64[_0x206ac1(0x25c)](_0x2d18b7=>_0x2d18b7['lastLoginIp']=(0x0,utils_1['maskIpAddress'])(_0x2d18b7[_0x206ac1(0x1ff)])),_0x5e758c['user'][_0x206ac1(0x274)]!==_0x206ac1(0x219)&&_0x278e64[_0x206ac1(0x25c)](_0x5a3e3c=>_0x5a3e3c[_0x206ac1(0x272)]=(0x0,utils_1[_0x206ac1(0x26d)])(_0x5a3e3c[_0x206ac1(0x272)])),{'rows':_0x278e64,'count':_0x4a7488};}async[_0x25a50f(0x1e8)]({id:_0x23f6a7}){const _0xf4438e=_0x25a50f;return await this[_0xf4438e(0x22f)][_0xf4438e(0x273)]({'where':{'id':_0x23f6a7},'select':[_0xf4438e(0x233),_0xf4438e(0x244),_0xf4438e(0x21e),'role',_0xf4438e(0x254),'status']});}async[_0x25a50f(0x221)](_0x4962f0){const _0x2a607c=_0x25a50f,{id:_0x540ce6,status:_0x412caa}=_0x4962f0,_0x357fb3=await this[_0x2a607c(0x22f)]['findOne']({'where':{'id':_0x540ce6}});if(!_0x357fb3)throw new common_1['HttpException'](_0x2a607c(0x21c),common_1['HttpStatus'][_0x2a607c(0x241)]);if(_0x357fb3[_0x2a607c(0x274)]===_0x2a607c(0x219))throw new common_1[(_0x2a607c(0x225))]('超级管理员不可被操作！',common_1[_0x2a607c(0x213)][_0x2a607c(0x241)]);if(_0x357fb3['status']===user_constant_1['UserStatusEnum']['PENDING'])throw new common_1[(_0x2a607c(0x225))]('未激活用户不可手动变更状态！',common_1[_0x2a607c(0x213)][_0x2a607c(0x241)]);if(_0x357fb3[_0x2a607c(0x274)]===_0x2a607c(0x219))throw new common_1[(_0x2a607c(0x225))](_0x2a607c(0x24e),common_1[_0x2a607c(0x213)][_0x2a607c(0x241)]);if(_0x412caa===user_constant_1[_0x2a607c(0x240)][_0x2a607c(0x283)])throw new common_1[(_0x2a607c(0x225))](_0x2a607c(0x1ef),common_1[_0x2a607c(0x213)]['BAD_REQUEST']);const _0x46cba4=await this[_0x2a607c(0x22f)][_0x2a607c(0x1e9)]({'id':_0x540ce6},{'status':_0x412caa});if(_0x46cba4[_0x2a607c(0x204)]<=0x0)throw new common_1[(_0x2a607c(0x225))](_0x2a607c(0x220),common_1[_0x2a607c(0x213)][_0x2a607c(0x241)]);return _0x2a607c(0x1ec);}async[_0x25a50f(0x20f)](_0xd439c2){const _0x345488=_0x25a50f,{id:_0x4cd3d0}=_0xd439c2,_0xaba6e4=await this['userEntity'][_0x345488(0x273)]({'where':{'id':_0x4cd3d0}});if(!_0xaba6e4)throw new common_1[(_0x345488(0x225))](_0x345488(0x21c),common_1[_0x345488(0x213)][_0x345488(0x241)]);const _0x3663f5='123456',_0x4244d5=bcrypt[_0x345488(0x1f1)](_0x3663f5,0xa),_0x51fb22=await this['userEntity'][_0x345488(0x1e9)]({'id':_0x4cd3d0},{'password':_0x4244d5});if(_0x51fb22[_0x345488(0x204)]<=0x0)throw new common_1[(_0x345488(0x225))](_0x345488(0x210),common_1[_0x345488(0x213)]['BAD_REQUEST']);return'密码重置为['+_0x3663f5+_0x345488(0x20d);}async['savaLoginIp'](_0x11eed1,_0x109352){const _0x240b30=_0x25a50f;return await this[_0x240b30(0x22f)][_0x240b30(0x1e9)]({'id':_0x11eed1},{'lastLoginIp':_0x109352});}async['getUserFromOpenId'](_0xa0a613,_0x479b32){const _0x29efe0=_0x25a50f,_0x1aaf6a=await this[_0x29efe0(0x22f)]['findOne']({'where':{'openId':_0xa0a613}});if(!_0x1aaf6a){const _0x8f5cfa=_0x479b32?_0x479b32[_0x29efe0(0x23d)](':')[0x1]:'',_0x55563f=await this[_0x29efe0(0x27f)](_0x8f5cfa),_0x47c0f1=await this[_0x29efe0(0x227)](_0xa0a613,_0x8f5cfa);return await this[_0x29efe0(0x268)]['addBalanceToNewUser'](_0x47c0f1['id'],_0x8f5cfa?_0x55563f===null||_0x55563f===void 0x0?void 0x0:_0x55563f['id']:null),_0x47c0f1;}return _0x1aaf6a;}async['createUserFromOpenId'](_0x42f364,_0x4bb8f2){const _0x577d15=_0x25a50f,_0x1cd4d0=await this[_0x577d15(0x205)][_0x577d15(0x25f)]([_0x577d15(0x270)]),_0x3e8361={'avatar':_0x1cd4d0,'username':'用户'+(0x0,utils_1[_0x577d15(0x243)])(),'status':user_constant_1[_0x577d15(0x240)][_0x577d15(0x271)],'sex':0x0,'email':(0x0,utils_1['createRandomUid'])()+_0x577d15(0x24c),'invitedBy':_0x4bb8f2,'openId':_0x42f364},_0x1ed24d=await this[_0x577d15(0x22f)][_0x577d15(0x253)](_0x3e8361);return _0x1ed24d;}async['bindWx'](_0x3f7cb5,_0x251737){const _0x4f65f1=_0x25a50f;try{const _0x3d65a0=await this[_0x4f65f1(0x22f)][_0x4f65f1(0x273)]({'where':{'id':_0x251737}});if(!_0x3d65a0)return{'status':![],'msg':_0x4f65f1(0x201)};const _0xafc0da=await this[_0x4f65f1(0x22f)][_0x4f65f1(0x273)]({'where':{'openId':_0x3f7cb5}});if(_0xafc0da)return{'status':![],'msg':_0x4f65f1(0x218)};const _0x18e15c=await this['userEntity'][_0x4f65f1(0x1e9)]({'id':_0x251737},{'openId':_0x3f7cb5});if(_0x18e15c[_0x4f65f1(0x204)]<=0x0)return{'status':![],'msg':_0x4f65f1(0x21f)};return{'status':!![],'msg':'恭喜您绑定成功、后续可直接扫码登录了！'};}catch(_0x5a0f6c){return{'status':![],'msg':_0x4f65f1(0x21f)};}}async['getOpenIdByUserId'](_0x544f07){const _0xa0c23c=_0x25a50f,_0x1347fe=await this[_0xa0c23c(0x22f)]['findOne']({'where':{'id':_0x544f07}});return _0x1347fe===null||_0x1347fe===void 0x0?void 0x0:_0x1347fe[_0xa0c23c(0x231)];}async[_0x25a50f(0x285)](_0x1a00fc){const _0x46565f=_0x25a50f,{username:_0x5e9ee5,password:_0x31b25f,phone:_0x757bdf,phoneCode:_0xccac41}=_0x1a00fc,_0x5a2973=await this[_0x46565f(0x22f)][_0x46565f(0x273)]({'where':[{'username':_0x5e9ee5},{'phone':_0x757bdf}]});if(_0x5a2973&&_0x5a2973[_0x46565f(0x233)]===_0x5e9ee5)throw new common_1[(_0x46565f(0x225))](_0x46565f(0x229),common_1['HttpStatus'][_0x46565f(0x241)]);if(_0x5a2973&&_0x5a2973[_0x46565f(0x272)]===_0x757bdf)throw new common_1['HttpException']('当前手机号已注册、请勿重复注册！',common_1[_0x46565f(0x213)]['BAD_REQUEST']);}async[_0x25a50f(0x212)](_0x4997ae){const _0x21066c=_0x25a50f;return await this[_0x21066c(0x22f)]['save'](_0x4997ae);}};UserService=__decorate([(0x0,common_1[_0x25a50f(0x277)])(),__param(0x0,(0x0,typeorm_1[_0x25a50f(0x1fe)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x25a50f(0x1fe)])(whiteList_entity_1[_0x25a50f(0x209)])),__param(0x7,(0x0,typeorm_1[_0x25a50f(0x1fe)])(config_entity_1[_0x25a50f(0x22e)])),__metadata(_0x25a50f(0x261),[typeorm_2['Repository'],typeorm_2[_0x25a50f(0x250)],typeorm_2[_0x25a50f(0x1fb)],verification_service_1[_0x25a50f(0x232)],mailer_1[_0x25a50f(0x1ea)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x25a50f(0x262)],typeorm_2['Repository']])],UserService),exports[_0x25a50f(0x242)]=UserService;