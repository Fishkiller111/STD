'use strict';function _0x3fa7(){const _0x2dbcac=['typeorm','DESC','Not','lodash','绑定微信失败、请联系管理员！','生成邀请码失败，请重新试一次吧！','whiteListEntity','assign','verificationService','phone','findOne','hex','GlobalConfigService','formatCreateOrUpdateDate','compareSync','queryOneUserInfo','当前用户信息失效、请重新登录！','forEach','您的账户已被封禁、如有疑问、请联系管理员！','getConfigs','email','ACTIVE','error:\x20','UserService','Repository','verifyUserRegisterByPhone','修改用户状态成功！','用户名或者邮箱已被注册！','getSuper','BAD_REQUEST','UNAUTHORIZED','updateUserPassword','update','Like','@nestjs/common','RechargeType','maskIpAddress','$2b$','updateInfo','createHash','当前账户不存在！','super','超级管理员不可被操作！','getUserInfo',']成功!','Connection','3588608zAKBhc','当前密码错误！','userBalanceService','findAndCount','updateUserStatus','356895FUileT','没有变更，无需更改！','获取邀请记录失败！','isBindWx','当前绑定用户不存在！','FORBIDDEN','UserBalanceService','queryOne','123456','split','831dhTINm','getInviteRecord','----,','InjectRepository','maskEmail','user','$2a$','userDefautlAvatar','savaLoginIp','HttpStatus','用户名已存在！','mailerService','已生成过邀请码、请勿重复生成','bindWx','修改用户状态失败！','function','未激活用户不可手动变更状态！','当前手机号已注册、请勿重复注册！','bcryptjs','getOwnPropertyDescriptor','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','__metadata','__decorate','inviteCode','connection','saveRecordRechargeLog','queryUserBalanceByIds','save','VerificationService','__esModule','用户名已存在、请更换用户名！','checkUserStatus','defineProperty','BLACKLISTED','affected','addBalanceToNewUser','用户不存在！','createUser','md5','role','username','../verification/verification.service','1362894lAzuLW','createRandomUid','UserEntity','verifyUserPassword','恭喜您绑定成功、后续可直接扫码登录了！','3eayoFl','crypto','该微信已绑定其他账号！','../userBalance/userBalance.service','getUserById','userId','Injectable','addBalanceToUser','UserStatusEnum','hashSync','lastLoginIp','1890620HBKLgW','startsWith','PENDING','修改用户信息失败！','log','queryUserInfoById','密码重置为[','userRecharge','updateStatus','status','queryUserBalance','1598osMJmR','registerIp','sign','configEntity','digest','metadata','globalConfigService','../../common/constants/balance.constant','length','avatar','3454330orGWaf','ConfigEntity','cloneDeep','resetUserPass','HttpException','../chatgpt/whiteList.entity','../globalConfig/config.entity','@nestjs-modules/mailer','createdAt','userEntity','WhiteListEntity','map','object','ADMIN_GIFT','UserStatusErrMsg','verifyUserCredentials','client','14TGldiM','重置密码失败！','decorate','无效的邀请码！','consecutiveDays','openId','createUserFromOpenId','$2y$','@nestjs/typeorm','password','qureyUserInfoByInviteCode','600305AUdTsW'];_0x3fa7=function(){return _0x2dbcac;};return _0x3fa7();}const _0x377eab=_0x1ed7;(function(_0x3130a7,_0x20aff5){const _0x4059e9=_0x1ed7,_0x4f5765=_0x3130a7();while(!![]){try{const _0x4a2cfe=parseInt(_0x4059e9(0x129))/0x1*(parseInt(_0x4059e9(0x16e))/0x2)+parseInt(_0x4059e9(0x158))/0x3*(-parseInt(_0x4059e9(0x163))/0x4)+-parseInt(_0x4059e9(0xeb))/0x5+-parseInt(_0x4059e9(0x153))/0x6*(parseInt(_0x4059e9(0x189))/0x7)+parseInt(_0x4059e9(0x11a))/0x8+-parseInt(_0x4059e9(0x11f))/0x9+parseInt(_0x4059e9(0x178))/0xa;if(_0x4a2cfe===_0x20aff5)break;else _0x4f5765['push'](_0x4f5765['shift']());}catch(_0x49c644){_0x4f5765['push'](_0x4f5765['shift']());}}}(_0x3fa7,0x5aa6d));function _0x1ed7(_0x4bd61d,_0x4ef006){const _0x3fa74c=_0x3fa7();return _0x1ed7=function(_0x1ed75e,_0x56472c){_0x1ed75e=_0x1ed75e-0xe7;let _0xa8904=_0x3fa74c[_0x1ed75e];return _0xa8904;},_0x1ed7(_0x4bd61d,_0x4ef006);}var __decorate=this&&this[_0x377eab(0x13f)]||function(_0x109a06,_0x14a6fd,_0x343ad7,_0xa5ac7){const _0xfa2165=_0x377eab;var _0x132cb5=arguments[_0xfa2165(0x176)],_0x4bba8b=_0x132cb5<0x3?_0x14a6fd:_0xa5ac7===null?_0xa5ac7=Object[_0xfa2165(0x13c)](_0x14a6fd,_0x343ad7):_0xa5ac7,_0x1e0848;if(typeof Reflect==='object'&&typeof Reflect[_0xfa2165(0x18b)]==='function')_0x4bba8b=Reflect[_0xfa2165(0x18b)](_0x109a06,_0x14a6fd,_0x343ad7,_0xa5ac7);else{for(var _0x4ba978=_0x109a06[_0xfa2165(0x176)]-0x1;_0x4ba978>=0x0;_0x4ba978--)if(_0x1e0848=_0x109a06[_0x4ba978])_0x4bba8b=(_0x132cb5<0x3?_0x1e0848(_0x4bba8b):_0x132cb5>0x3?_0x1e0848(_0x14a6fd,_0x343ad7,_0x4bba8b):_0x1e0848(_0x14a6fd,_0x343ad7))||_0x4bba8b;}return _0x132cb5>0x3&&_0x4bba8b&&Object[_0xfa2165(0x149)](_0x14a6fd,_0x343ad7,_0x4bba8b),_0x4bba8b;},__metadata=this&&this[_0x377eab(0x13e)]||function(_0x424319,_0x33088c){const _0x20c529=_0x377eab;if(typeof Reflect===_0x20c529(0x184)&&typeof Reflect[_0x20c529(0x173)]===_0x20c529(0x138))return Reflect[_0x20c529(0x173)](_0x424319,_0x33088c);},__param=this&&this['__param']||function(_0x4c623b,_0x12cc70){return function(_0x45e264,_0xcbb295){_0x12cc70(_0x45e264,_0xcbb295,_0x4c623b);};};Object[_0x377eab(0x149)](exports,_0x377eab(0x146),{'value':!![]}),exports[_0x377eab(0x103)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require(_0x377eab(0x17f)),verification_service_1=require(_0x377eab(0x152)),common_1=require(_0x377eab(0x10e)),typeorm_1=require(_0x377eab(0xe8)),typeorm_2=require(_0x377eab(0xec)),user_entity_1=require('./user.entity'),bcrypt=require(_0x377eab(0x13b)),crypto=require(_0x377eab(0x159)),_=require(_0x377eab(0xef)),userBalance_service_1=require(_0x377eab(0x15b)),utils_1=require('../../common/utils'),balance_constant_1=require(_0x377eab(0x175)),config_entity_1=require(_0x377eab(0x17e)),whiteList_entity_1=require(_0x377eab(0x17d));let UserService=class UserService{constructor(_0x53a964,_0x35ab87,_0x1ab94d,_0x38e097,_0x6f853c,_0x2fe225,_0x122507,_0x1a06ad){const _0x4c2c29=_0x377eab;this[_0x4c2c29(0x181)]=_0x53a964,this[_0x4c2c29(0xf2)]=_0x35ab87,this[_0x4c2c29(0x141)]=_0x1ab94d,this[_0x4c2c29(0xf4)]=_0x38e097,this[_0x4c2c29(0x134)]=_0x6f853c,this['userBalanceService']=_0x2fe225,this[_0x4c2c29(0x174)]=_0x122507,this[_0x4c2c29(0x171)]=_0x1a06ad;}async['createUserAndVerifycation'](_0x2d46be,_0x4b66ab){const _0xe82f1c=_0x377eab,{username:_0x55c742,email:_0x3f844e,password:_0x2599eb,invitedBy:_0x321ee9,client:client=0x0}=_0x2d46be;if(_0x321ee9){const _0x4525f2=await this[_0xe82f1c(0x181)]['findOne']({'where':{'inviteCode':_0x321ee9}});if(!_0x4525f2)throw new common_1[(_0xe82f1c(0x17c))](_0xe82f1c(0x18c),common_1[_0xe82f1c(0x132)][_0xe82f1c(0x109)]);}const _0x590206=[{'username':_0x55c742},{'email':_0x3f844e}],_0x2b78b0=await this['userEntity'][_0xe82f1c(0xf6)]({'where':_0x590206});if(_0x2b78b0&&_0x2b78b0[_0xe82f1c(0x16c)]!==user_constant_1[_0xe82f1c(0x160)][_0xe82f1c(0x165)])throw new common_1[(_0xe82f1c(0x17c))](_0xe82f1c(0x107),common_1[_0xe82f1c(0x132)][_0xe82f1c(0x109)]);try{const _0x34982a=_[_0xe82f1c(0x17a)](_0x2d46be),_0x12e854=bcrypt['hashSync'](_0x2599eb,0xa),_0x51750c=(0x0,utils_1['getClientIp'])(_0x4b66ab);_0x34982a[_0xe82f1c(0xe9)]=_0x12e854,_0x34982a[_0xe82f1c(0x16f)]=_0x51750c,_0x34982a[_0xe82f1c(0x188)]=client;let _0x23b73e;if(!_0x2b78b0){const _0x4eec50=await this['globalConfigService']['getConfigs']([_0xe82f1c(0x130)]);_0x34982a['avatar']=_0x4eec50,_0x23b73e=await this['userEntity']['save'](_0x34982a);}else _0x23b73e=_0x2b78b0;const {username:_0x5b4d88,email:_0x551b6a,id:_0x3f1546,invitedBy:_0x27643d}=_0x23b73e;await this[_0xe82f1c(0x11e)](_0x3f1546,user_constant_1['UserStatusEnum'][_0xe82f1c(0x101)]);let _0x2cf899;return _0x27643d&&(_0x2cf899=await this[_0xe82f1c(0xea)](_0x27643d)),await this[_0xe82f1c(0x11c)][_0xe82f1c(0x14c)](_0x3f1546,_0x2cf899===null||_0x2cf899===void 0x0?void 0x0:_0x2cf899['id']),_0x23b73e;}catch(_0x4621ea){console[_0xe82f1c(0x167)](_0xe82f1c(0x102),_0x4621ea);throw _0x4621ea;}}async[_0x377eab(0x108)](){const _0x41c6a2=_0x377eab,_0x2f1192=await this[_0x41c6a2(0x181)][_0x41c6a2(0xf6)]({'where':{'role':_0x41c6a2(0x115)}});return _0x2f1192;}async[_0x377eab(0x187)](_0x1f109c){const _0x318e4f=_0x377eab,{username:_0x35216a,password:_0x354481,uid:uid=0x0,phone:_0x211f23}=_0x1f109c;let _0x26e7d1=null;if(uid>0x0){_0x26e7d1=await this[_0x318e4f(0x181)][_0x318e4f(0xf6)]({'where':{'id':uid}});if(!_0x26e7d1)throw new common_1[(_0x318e4f(0x17c))](_0x318e4f(0x114),common_1[_0x318e4f(0x132)][_0x318e4f(0x124)]);if(_0x26e7d1[_0x318e4f(0xe9)]['startsWith'](_0x318e4f(0x12f))||_0x26e7d1[_0x318e4f(0xe9)][_0x318e4f(0x164)]('$2b$')||_0x26e7d1[_0x318e4f(0xe9)][_0x318e4f(0x164)]('$2y$')){if(!bcrypt[_0x318e4f(0xfa)](_0x354481,_0x26e7d1['password']))throw new common_1['HttpException']('当前密码错误！',common_1[_0x318e4f(0x132)][_0x318e4f(0x109)]);}else{console[_0x318e4f(0x167)]('----,');const _0x27d4a7=crypto[_0x318e4f(0x113)](_0x318e4f(0x14f))[_0x318e4f(0x10c)](_0x354481)[_0x318e4f(0x172)](_0x318e4f(0xf7));console[_0x318e4f(0x167)]('----,',_0x27d4a7);if(_0x27d4a7!==_0x26e7d1['password'])throw new common_1['HttpException'](_0x318e4f(0x11b),common_1[_0x318e4f(0x132)][_0x318e4f(0x109)]);}}if(_0x35216a&&_0x354481){const _0x268cc5=[{'username':_0x35216a},{'email':_0x35216a}];_0x26e7d1=await this['userEntity']['findOne']({'where':_0x268cc5});if(!_0x26e7d1)throw new common_1[(_0x318e4f(0x17c))]('当前账户不存在！',common_1[_0x318e4f(0x132)][_0x318e4f(0x124)]);if(_0x26e7d1['password'][_0x318e4f(0x164)](_0x318e4f(0x12f))||_0x26e7d1['password'][_0x318e4f(0x164)](_0x318e4f(0x111))||_0x26e7d1[_0x318e4f(0xe9)][_0x318e4f(0x164)]('$2y$')){if(!bcrypt['compareSync'](_0x354481,_0x26e7d1[_0x318e4f(0xe9)]))throw new common_1[(_0x318e4f(0x17c))](_0x318e4f(0x11b),common_1['HttpStatus'][_0x318e4f(0x109)]);}else{console['log']('----,');const _0x448421=crypto[_0x318e4f(0x113)]('md5')[_0x318e4f(0x10c)](_0x354481)[_0x318e4f(0x172)](_0x318e4f(0xf7));console[_0x318e4f(0x167)](_0x318e4f(0x12b),_0x448421);if(_0x448421!==_0x26e7d1[_0x318e4f(0xe9)])throw new common_1[(_0x318e4f(0x17c))](_0x318e4f(0x11b),common_1['HttpStatus'][_0x318e4f(0x109)]);}}if(_0x211f23&&_0x354481){const _0x19434e=[{'phone':_0x211f23}];_0x26e7d1=await this[_0x318e4f(0x181)][_0x318e4f(0xf6)]({'where':_0x19434e});if(!_0x26e7d1)throw new common_1[(_0x318e4f(0x17c))]('当前账户不存在！',common_1[_0x318e4f(0x132)][_0x318e4f(0x124)]);if(_0x26e7d1['password'][_0x318e4f(0x164)]('$2a$')||_0x26e7d1[_0x318e4f(0xe9)][_0x318e4f(0x164)](_0x318e4f(0x111))||_0x26e7d1[_0x318e4f(0xe9)][_0x318e4f(0x164)](_0x318e4f(0xe7))){if(!bcrypt['compareSync'](_0x354481,_0x26e7d1[_0x318e4f(0xe9)]))throw new common_1[(_0x318e4f(0x17c))](_0x318e4f(0x11b),common_1[_0x318e4f(0x132)]['BAD_REQUEST']);}else{console[_0x318e4f(0x167)](_0x318e4f(0x12b));const _0x48ffc2=crypto['createHash']('md5')['update'](_0x354481)[_0x318e4f(0x172)](_0x318e4f(0xf7));console[_0x318e4f(0x167)](_0x318e4f(0x12b),_0x48ffc2);if(_0x48ffc2!==_0x26e7d1[_0x318e4f(0xe9)])throw new common_1[(_0x318e4f(0x17c))](_0x318e4f(0x11b),common_1[_0x318e4f(0x132)][_0x318e4f(0x109)]);}}if(!_0x26e7d1)throw new common_1['HttpException']('当前账户不存在！',common_1['HttpStatus'][_0x318e4f(0x124)]);if(_0x26e7d1[_0x318e4f(0x16c)]!==user_constant_1['UserStatusEnum'][_0x318e4f(0x101)])throw new common_1['HttpException'](user_constant_1[_0x318e4f(0x186)][_0x26e7d1[_0x318e4f(0x16c)]],common_1[_0x318e4f(0x132)]['BAD_REQUEST']);return _0x26e7d1;}async[_0x377eab(0x156)](_0x228130,_0x501b0a){const _0x44730f=_0x377eab,_0x3e277c=await this[_0x44730f(0x181)][_0x44730f(0xf6)]({'where':{'id':_0x228130}});if(_0x3e277c[_0x44730f(0xe9)][_0x44730f(0x164)](_0x44730f(0x12f))||_0x3e277c[_0x44730f(0xe9)]['startsWith'](_0x44730f(0x111))||_0x3e277c[_0x44730f(0xe9)][_0x44730f(0x164)]('$2y$'))return bcrypt[_0x44730f(0xfa)](_0x501b0a,_0x3e277c[_0x44730f(0xe9)]);else{const _0x4627f7=crypto[_0x44730f(0x113)](_0x44730f(0x14f))[_0x44730f(0x10c)](_0x501b0a)[_0x44730f(0x172)]('hex');return console[_0x44730f(0x167)](_0x44730f(0x12b),_0x4627f7),_0x4627f7===_0x3e277c[_0x44730f(0xe9)];}}async[_0x377eab(0x11e)](_0x3aa82a,_0x5c89b7){const _0x32f40d=_0x377eab,_0x53f18c=await this['userEntity'][_0x32f40d(0x10c)]({'id':_0x3aa82a},{'status':_0x5c89b7});return _0x53f18c[_0x32f40d(0x14b)]>0x0;}async['getUserStatus'](_0x4f575f){const _0x1eab0c=_0x377eab,_0x30f40c=await this[_0x1eab0c(0x181)][_0x1eab0c(0xf6)]({'where':{'id':_0x4f575f}});return _0x30f40c['status'];}async[_0x377eab(0x168)](_0x28f5b9){const _0x482a2b=_0x377eab;return await this['userEntity'][_0x482a2b(0xf6)]({'where':{'id':_0x28f5b9}});}async[_0x377eab(0xfb)](_0x485813){const _0xe363f7=_0x377eab;return await this[_0xe363f7(0x181)][_0xe363f7(0xf6)]({'where':{'id':_0x485813}});}async[_0x377eab(0x148)](_0xf1539b){const _0x22acae=_0x377eab,{id:_0x53b2de,role:_0x35d285}=_0xf1539b;if(_0x35d285==='visitor')return!![];const _0x3d4442=await this['userEntity'][_0x22acae(0xf6)]({'where':{'id':_0x53b2de}});if(!_0x3d4442)throw new common_1['HttpException'](_0x22acae(0xfc),common_1['HttpStatus'][_0x22acae(0x10a)]);if(_0x3d4442[_0x22acae(0x16c)]===user_constant_1[_0x22acae(0x160)][_0x22acae(0x14a)])throw new common_1['HttpException'](_0x22acae(0x13d),common_1[_0x22acae(0x132)][_0x22acae(0x109)]);if(_0x3d4442['status']===user_constant_1[_0x22acae(0x160)]['LOCKED'])throw new common_1[(_0x22acae(0x17c))](_0x22acae(0xfe),common_1['HttpStatus'][_0x22acae(0x109)]);}async[_0x377eab(0x117)](_0x9c552d){const _0x38f6e9=_0x377eab,_0x7cb82c=await this['userEntity'][_0x38f6e9(0xf6)]({'where':{'id':_0x9c552d},'select':[_0x38f6e9(0x151),_0x38f6e9(0x177),_0x38f6e9(0x150),_0x38f6e9(0x100),_0x38f6e9(0x170),_0x38f6e9(0x140),'openId',_0x38f6e9(0x18d)]});if(!_0x7cb82c)throw new common_1[(_0x38f6e9(0x17c))]('当前用户信息失效、请重新登录！',common_1[_0x38f6e9(0x132)][_0x38f6e9(0x10a)]);_0x7cb82c[_0x38f6e9(0x122)]=!!(_0x7cb82c===null||_0x7cb82c===void 0x0?void 0x0:_0x7cb82c['openId']),delete _0x7cb82c[_0x38f6e9(0x18e)];const _0xe1c2c0=await this[_0x38f6e9(0x11c)][_0x38f6e9(0x16d)](_0x9c552d);return{'userInfo':_0x7cb82c,'userBalance':Object[_0x38f6e9(0xf3)]({},_0xe1c2c0)};}async[_0x377eab(0x15c)](_0x98d4ad){const _0x5b6b76=_0x377eab;return await this[_0x5b6b76(0x181)]['findOne']({'where':{'id':_0x98d4ad}});}async['getUserOpenId'](_0x5cea64){const _0x7bc984=_0x377eab;return await this[_0x7bc984(0x181)][_0x7bc984(0xf6)]({'where':{'openId':_0x5cea64}});}async[_0x377eab(0x112)](_0x36e82d,_0x5312fa){const _0x136dbc=_0x377eab,{id:_0x386de4}=_0x5312fa[_0x136dbc(0x12e)],_0x34cbc3=await this[_0x136dbc(0x181)]['findOne']({'where':{'id':_0x386de4}});if(!_0x34cbc3)throw new common_1['HttpException']('当前用户不存在！',common_1[_0x136dbc(0x132)]['BAD_REQUEST']);if(_0x36e82d[_0x136dbc(0x151)]&&_0x34cbc3['username']===_0x36e82d['username'])throw new common_1[(_0x136dbc(0x17c))](_0x136dbc(0x120),common_1[_0x136dbc(0x132)][_0x136dbc(0x109)]);if(_0x36e82d['username']){const _0x2f7a86=await this[_0x136dbc(0x181)]['findOne']({'where':{'username':_0x36e82d[_0x136dbc(0x151)],'id':(0x0,typeorm_2[_0x136dbc(0xee)])(_0x386de4)}});if(_0x2f7a86)throw new common_1[(_0x136dbc(0x17c))](_0x136dbc(0x133),common_1[_0x136dbc(0x132)][_0x136dbc(0x109)]);}const _0x1d8b1d=await this[_0x136dbc(0x181)][_0x136dbc(0x10c)]({'id':_0x386de4},_0x36e82d);if(_0x1d8b1d['affected']<=0x0)throw new common_1[(_0x136dbc(0x17c))](_0x136dbc(0x166),common_1[_0x136dbc(0x132)]['BAD_REQUEST']);return'修改用户信息成功！';}async[_0x377eab(0x10b)](_0x38798d,_0x368be5){const _0x5277c1=_0x377eab,_0x1c040e=bcrypt[_0x5277c1(0x161)](_0x368be5,0xa),_0x3b7095=await this['userEntity']['update']({'id':_0x38798d},{'password':_0x1c040e});if(_0x3b7095[_0x5277c1(0x14b)]<=0x0)throw new common_1[(_0x5277c1(0x17c))]('修改密码失败、请重新试试吧。',common_1[_0x5277c1(0x132)][_0x5277c1(0x109)]);}async['genInviteCode'](_0x5cc193){const _0xa89303=_0x377eab,{id:_0x59be3f}=_0x5cc193['user'],_0x268b95=await this['userEntity'][_0xa89303(0xf6)]({'where':{'id':_0x59be3f}});if(!_0x268b95||_0x268b95['inviteCode'])throw new common_1['HttpException'](_0xa89303(0x135),common_1[_0xa89303(0x132)][_0xa89303(0x109)]);const _0x125944=(0x0,utils_1['generateRandomString'])(),_0xf8c70e=await this[_0xa89303(0x181)][_0xa89303(0xf6)]({'where':{'inviteCode':_0x125944}});if(_0xf8c70e)throw new common_1[(_0xa89303(0x17c))](_0xa89303(0xf1),common_1[_0xa89303(0x132)][_0xa89303(0x109)]);const _0x2c6f29=await this[_0xa89303(0x181)][_0xa89303(0x10c)]({'id':_0x59be3f},{'inviteCode':_0x125944});if(_0x2c6f29[_0xa89303(0x14b)]<=0x0)throw new common_1['HttpException'](_0xa89303(0xf1),common_1[_0xa89303(0x132)][_0xa89303(0x109)]);return _0x125944;}async[_0x377eab(0x12a)](_0x4175c1,_0x4c37cc){const _0x5c35d7=_0x377eab;try{const {id:_0x456408}=_0x4175c1[_0x5c35d7(0x12e)],{page:page=0x1,size:size=0xa}=_0x4c37cc,_0x5c67b3=await this[_0x5c35d7(0x181)][_0x5c35d7(0xf6)]({'where':{'id':_0x456408}}),{inviteCode:_0x28dfbe}=_0x5c67b3;if(!_0x28dfbe)return[];const [_0x17cda5,_0x4f4689]=await this['userEntity'][_0x5c35d7(0x11d)]({'where':{'inviteCode':_0x28dfbe},'order':{'id':_0x5c35d7(0xed)},'select':['username','email',_0x5c35d7(0x180),_0x5c35d7(0x16c),_0x5c35d7(0x177)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x5c35d7(0xf9)])(_0x17cda5)[_0x5c35d7(0x183)](_0xbe5ecf=>{const _0x4ac51e=_0x5c35d7;return _0xbe5ecf[_0x4ac51e(0x100)]=(0x0,utils_1[_0x4ac51e(0x12d)])(_0xbe5ecf[_0x4ac51e(0x100)]),_0xbe5ecf;}),{'rows':_0x17cda5,'count':_0x4f4689};}catch(_0x973ffe){console[_0x5c35d7(0x167)](_0x5c35d7(0x102),_0x973ffe);throw new common_1[(_0x5c35d7(0x17c))](_0x5c35d7(0x121),common_1[_0x5c35d7(0x132)][_0x5c35d7(0x109)]);}}async['inviteLink'](_0x37580f){const _0x2e5464=_0x377eab,_0x5c0ebc=await this[_0x2e5464(0x181)][_0x2e5464(0xf6)]({'where':{'inviteCode':_0x37580f}});if(!_0x5c0ebc)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x5c0ebc,_0x4d3ef8=await this[_0x2e5464(0x181)][_0x2e5464(0x10c)]({'inviteCode':_0x37580f},{'inviteLinkCount':inviteLinkCount+0x1});return _0x4d3ef8[_0x2e5464(0x14b)]?0x1:0x0;}async[_0x377eab(0xea)](_0x560da9){const _0x50afdc=_0x377eab;return await this[_0x50afdc(0x181)][_0x50afdc(0xf6)]({'where':{'inviteCode':_0x560da9}});}async[_0x377eab(0x16a)](_0x4df170){const _0x2dc111=_0x377eab,{userId:_0x1d27c5,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4df170;await this[_0x2dc111(0x11c)][_0x2dc111(0x15f)](_0x1d27c5,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x511597=await this['userBalanceService'][_0x2dc111(0x142)]({'userId':_0x1d27c5,'rechargeType':balance_constant_1[_0x2dc111(0x10f)][_0x2dc111(0x185)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x511597;}async['queryAll'](_0x9821af,_0x98777){const _0x3a62ca=_0x377eab,{page:page=0x1,size:size=0xa,username:_0x3bad38,email:_0x2c0b86,status:_0x307750,keyword:_0x304bc8,phone:_0x429010}=_0x9821af;let _0x47c804={};_0x3bad38&&Object[_0x3a62ca(0xf3)](_0x47c804,{'username':(0x0,typeorm_2['Like'])('%'+_0x3bad38+'%')}),_0x2c0b86&&Object['assign'](_0x47c804,{'email':(0x0,typeorm_2[_0x3a62ca(0x10d)])('%'+_0x2c0b86+'%')}),_0x429010&&Object[_0x3a62ca(0xf3)](_0x47c804,{'phone':(0x0,typeorm_2[_0x3a62ca(0x10d)])('%'+_0x429010+'%')}),_0x307750&&Object['assign'](_0x47c804,{'status':_0x307750});_0x304bc8&&(_0x47c804=[{'username':(0x0,typeorm_2[_0x3a62ca(0x10d)])('%'+_0x304bc8+'%')},{'email':(0x0,typeorm_2[_0x3a62ca(0x10d)])('%'+_0x304bc8+'%')},{'phone':(0x0,typeorm_2[_0x3a62ca(0x10d)])('%'+_0x304bc8+'%')}]);const [_0xea45ac,_0x500485]=await this[_0x3a62ca(0x181)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x47c804,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x3a62ca(0x151),'avatar','inviteCode',_0x3a62ca(0x150),_0x3a62ca(0x170),'status','id',_0x3a62ca(0x100),_0x3a62ca(0x180),_0x3a62ca(0x162),'phone']}),_0x43d371=_0xea45ac['map'](_0x34c51b=>_0x34c51b['id']),_0xc9a4=await this[_0x3a62ca(0x11c)][_0x3a62ca(0x143)](_0x43d371);return _0xea45ac[_0x3a62ca(0xfd)](_0x530422=>_0x530422['balanceInfo']=_0xc9a4['find'](_0x1c0b5f=>_0x1c0b5f[_0x3a62ca(0x15d)]===_0x530422['id'])),_0x98777['user']['role']!==_0x3a62ca(0x115)&&_0xea45ac[_0x3a62ca(0xfd)](_0x53a3fa=>_0x53a3fa['email']=(0x0,utils_1['maskEmail'])(_0x53a3fa[_0x3a62ca(0x100)])),_0x98777[_0x3a62ca(0x12e)][_0x3a62ca(0x150)]!==_0x3a62ca(0x115)&&_0xea45ac[_0x3a62ca(0xfd)](_0x5a9496=>_0x5a9496[_0x3a62ca(0x162)]=(0x0,utils_1['maskIpAddress'])(_0x5a9496[_0x3a62ca(0x162)])),_0x98777[_0x3a62ca(0x12e)]['role']!==_0x3a62ca(0x115)&&_0xea45ac[_0x3a62ca(0xfd)](_0x12fb81=>_0x12fb81[_0x3a62ca(0xf5)]=(0x0,utils_1[_0x3a62ca(0x110)])(_0x12fb81[_0x3a62ca(0xf5)])),{'rows':_0xea45ac,'count':_0x500485};}async[_0x377eab(0x126)]({id:_0x4c2147}){const _0x3fd85e=_0x377eab;return await this[_0x3fd85e(0x181)]['findOne']({'where':{'id':_0x4c2147},'select':[_0x3fd85e(0x151),'avatar',_0x3fd85e(0x140),_0x3fd85e(0x150),_0x3fd85e(0x170),'status']});}async[_0x377eab(0x16b)](_0x10f7e3){const _0x5f0fff=_0x377eab,{id:_0x5d5518,status:_0x1db185}=_0x10f7e3,_0x138c91=await this['userEntity'][_0x5f0fff(0xf6)]({'where':{'id':_0x5d5518}});if(!_0x138c91)throw new common_1[(_0x5f0fff(0x17c))](_0x5f0fff(0x14d),common_1[_0x5f0fff(0x132)][_0x5f0fff(0x109)]);if(_0x138c91[_0x5f0fff(0x150)]===_0x5f0fff(0x115))throw new common_1['HttpException'](_0x5f0fff(0x116),common_1['HttpStatus'][_0x5f0fff(0x109)]);if(_0x138c91[_0x5f0fff(0x16c)]===user_constant_1[_0x5f0fff(0x160)]['PENDING'])throw new common_1[(_0x5f0fff(0x17c))](_0x5f0fff(0x139),common_1[_0x5f0fff(0x132)][_0x5f0fff(0x109)]);if(_0x138c91[_0x5f0fff(0x150)]===_0x5f0fff(0x115))throw new common_1[(_0x5f0fff(0x17c))](_0x5f0fff(0x116),common_1[_0x5f0fff(0x132)][_0x5f0fff(0x109)]);if(_0x1db185===user_constant_1[_0x5f0fff(0x160)]['PENDING'])throw new common_1['HttpException']('不可将用户置为未激活状态！',common_1['HttpStatus'][_0x5f0fff(0x109)]);const _0x20e33a=await this['userEntity'][_0x5f0fff(0x10c)]({'id':_0x5d5518},{'status':_0x1db185});if(_0x20e33a[_0x5f0fff(0x14b)]<=0x0)throw new common_1[(_0x5f0fff(0x17c))](_0x5f0fff(0x137),common_1[_0x5f0fff(0x132)][_0x5f0fff(0x109)]);return _0x5f0fff(0x106);}async[_0x377eab(0x17b)](_0x2a0dde){const _0xc87811=_0x377eab,{id:_0x4972b8}=_0x2a0dde,_0x4898d8=await this['userEntity'][_0xc87811(0xf6)]({'where':{'id':_0x4972b8}});if(!_0x4898d8)throw new common_1[(_0xc87811(0x17c))]('用户不存在！',common_1[_0xc87811(0x132)][_0xc87811(0x109)]);const _0x345df3=_0xc87811(0x127),_0x28e010=bcrypt[_0xc87811(0x161)](_0x345df3,0xa),_0x3c4deb=await this[_0xc87811(0x181)][_0xc87811(0x10c)]({'id':_0x4972b8},{'password':_0x28e010});if(_0x3c4deb[_0xc87811(0x14b)]<=0x0)throw new common_1[(_0xc87811(0x17c))](_0xc87811(0x18a),common_1[_0xc87811(0x132)][_0xc87811(0x109)]);return _0xc87811(0x169)+_0x345df3+_0xc87811(0x118);}async[_0x377eab(0x131)](_0x1266af,_0x119537){return await this['userEntity']['update']({'id':_0x1266af},{'lastLoginIp':_0x119537});}async['getUserFromOpenId'](_0x3512c2,_0x1ed2ac){const _0x38191f=_0x377eab,_0x34ef60=await this[_0x38191f(0x181)][_0x38191f(0xf6)]({'where':{'openId':_0x3512c2}});if(!_0x34ef60){const _0x2a0dc1=_0x1ed2ac?_0x1ed2ac[_0x38191f(0x128)](':')[0x1]:'',_0x4c70db=await this[_0x38191f(0xea)](_0x2a0dc1),_0x542574=await this[_0x38191f(0x18f)](_0x3512c2,_0x2a0dc1);return await this[_0x38191f(0x11c)]['addBalanceToNewUser'](_0x542574['id'],_0x2a0dc1?_0x4c70db===null||_0x4c70db===void 0x0?void 0x0:_0x4c70db['id']:null),_0x542574;}return _0x34ef60;}async[_0x377eab(0x18f)](_0x3d4db6,_0x854964){const _0x479c39=_0x377eab,_0x793a91=await this[_0x479c39(0x174)][_0x479c39(0xff)](['userDefautlAvatar']),_0x27735b={'avatar':_0x793a91,'username':'用户'+(0x0,utils_1[_0x479c39(0x154)])(),'status':user_constant_1[_0x479c39(0x160)][_0x479c39(0x101)],'sex':0x0,'email':(0x0,utils_1['createRandomUid'])()+'@default.com','invitedBy':_0x854964,'openId':_0x3d4db6},_0x4f7aaf=await this[_0x479c39(0x181)][_0x479c39(0x144)](_0x27735b);return _0x4f7aaf;}async[_0x377eab(0x136)](_0x434661,_0x4b6f3b){const _0x2e06a1=_0x377eab;try{const _0x229d1c=await this[_0x2e06a1(0x181)][_0x2e06a1(0xf6)]({'where':{'id':_0x4b6f3b}});if(!_0x229d1c)return{'status':![],'msg':_0x2e06a1(0x123)};const _0x3be584=await this[_0x2e06a1(0x181)]['findOne']({'where':{'openId':_0x434661}});if(_0x3be584)return{'status':![],'msg':_0x2e06a1(0x15a)};const _0x495cae=await this[_0x2e06a1(0x181)][_0x2e06a1(0x10c)]({'id':_0x4b6f3b},{'openId':_0x434661});if(_0x495cae[_0x2e06a1(0x14b)]<=0x0)return{'status':![],'msg':_0x2e06a1(0xf0)};return{'status':!![],'msg':_0x2e06a1(0x157)};}catch(_0x48cd75){return{'status':![],'msg':_0x2e06a1(0xf0)};}}async['getOpenIdByUserId'](_0x386b6e){const _0xef9d1c=_0x377eab,_0x46cafc=await this['userEntity'][_0xef9d1c(0xf6)]({'where':{'id':_0x386b6e}});return _0x46cafc===null||_0x46cafc===void 0x0?void 0x0:_0x46cafc[_0xef9d1c(0x18e)];}async[_0x377eab(0x105)](_0x3169b3){const _0x4ae6b6=_0x377eab,{username:_0x32121c,password:_0xc3e01f,phone:_0x32231e,phoneCode:_0x177516}=_0x3169b3,_0x585031=await this[_0x4ae6b6(0x181)][_0x4ae6b6(0xf6)]({'where':[{'username':_0x32121c},{'phone':_0x32231e}]});if(_0x585031&&_0x585031[_0x4ae6b6(0x151)]===_0x32121c)throw new common_1[(_0x4ae6b6(0x17c))](_0x4ae6b6(0x147),common_1[_0x4ae6b6(0x132)]['BAD_REQUEST']);if(_0x585031&&_0x585031[_0x4ae6b6(0xf5)]===_0x32231e)throw new common_1['HttpException'](_0x4ae6b6(0x13a),common_1[_0x4ae6b6(0x132)][_0x4ae6b6(0x109)]);}async[_0x377eab(0x14e)](_0x4ce7e0){const _0x6765e8=_0x377eab;return await this[_0x6765e8(0x181)][_0x6765e8(0x144)](_0x4ce7e0);}};UserService=__decorate([(0x0,common_1[_0x377eab(0x15e)])(),__param(0x0,(0x0,typeorm_1[_0x377eab(0x12c)])(user_entity_1[_0x377eab(0x155)])),__param(0x1,(0x0,typeorm_1[_0x377eab(0x12c)])(whiteList_entity_1[_0x377eab(0x182)])),__param(0x7,(0x0,typeorm_1[_0x377eab(0x12c)])(config_entity_1[_0x377eab(0x179)])),__metadata('design:paramtypes',[typeorm_2[_0x377eab(0x104)],typeorm_2[_0x377eab(0x104)],typeorm_2[_0x377eab(0x119)],verification_service_1[_0x377eab(0x145)],mailer_1['MailerService'],userBalance_service_1[_0x377eab(0x125)],globalConfig_service_1[_0x377eab(0xf8)],typeorm_2[_0x377eab(0x104)]])],UserService),exports[_0x377eab(0x103)]=UserService;