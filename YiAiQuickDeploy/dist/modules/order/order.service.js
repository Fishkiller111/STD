'use strict';const _0x5df4c7=_0x43c1;function _0x43c1(_0x33b600,_0x5743b1){const _0x2fb9a8=_0x2fb9();return _0x43c1=function(_0x43c138,_0x81406c){_0x43c138=_0x43c138-0x1e4;let _0x56785c=_0x2fb9a8[_0x43c138];return _0x56785c;},_0x43c1(_0x33b600,_0x5743b1);}(function(_0x19b1a0,_0x1cd2d5){const _0x1b9f5a=_0x43c1,_0x115b36=_0x19b1a0();while(!![]){try{const _0x4ab6eb=-parseInt(_0x1b9f5a(0x236))/0x1+-parseInt(_0x1b9f5a(0x1fd))/0x2+-parseInt(_0x1b9f5a(0x20b))/0x3*(parseInt(_0x1b9f5a(0x1e7))/0x4)+parseInt(_0x1b9f5a(0x21d))/0x5+-parseInt(_0x1b9f5a(0x234))/0x6+-parseInt(_0x1b9f5a(0x1e4))/0x7*(-parseInt(_0x1b9f5a(0x1f2))/0x8)+-parseInt(_0x1b9f5a(0x210))/0x9*(-parseInt(_0x1b9f5a(0x218))/0xa);if(_0x4ab6eb===_0x1cd2d5)break;else _0x115b36['push'](_0x115b36['shift']());}catch(_0x18f050){_0x115b36['push'](_0x115b36['shift']());}}}(_0x2fb9,0xd5704));var __decorate=this&&this[_0x5df4c7(0x21a)]||function(_0x37280f,_0x29f06e,_0x568ec4,_0x5f163d){const _0x20fb9e=_0x5df4c7;var _0xfe9b6f=arguments[_0x20fb9e(0x1ef)],_0x1def21=_0xfe9b6f<0x3?_0x29f06e:_0x5f163d===null?_0x5f163d=Object['getOwnPropertyDescriptor'](_0x29f06e,_0x568ec4):_0x5f163d,_0x30e9ae;if(typeof Reflect===_0x20fb9e(0x220)&&typeof Reflect[_0x20fb9e(0x22b)]===_0x20fb9e(0x20f))_0x1def21=Reflect[_0x20fb9e(0x22b)](_0x37280f,_0x29f06e,_0x568ec4,_0x5f163d);else{for(var _0x13919d=_0x37280f[_0x20fb9e(0x1ef)]-0x1;_0x13919d>=0x0;_0x13919d--)if(_0x30e9ae=_0x37280f[_0x13919d])_0x1def21=(_0xfe9b6f<0x3?_0x30e9ae(_0x1def21):_0xfe9b6f>0x3?_0x30e9ae(_0x29f06e,_0x568ec4,_0x1def21):_0x30e9ae(_0x29f06e,_0x568ec4))||_0x1def21;}return _0xfe9b6f>0x3&&_0x1def21&&Object[_0x20fb9e(0x228)](_0x29f06e,_0x568ec4,_0x1def21),_0x1def21;},__metadata=this&&this['__metadata']||function(_0x583641,_0x2f6fbe){const _0x2b6109=_0x5df4c7;if(typeof Reflect===_0x2b6109(0x220)&&typeof Reflect[_0x2b6109(0x1e6)]===_0x2b6109(0x20f))return Reflect[_0x2b6109(0x1e6)](_0x583641,_0x2f6fbe);},__param=this&&this[_0x5df4c7(0x20e)]||function(_0x42f528,_0x37c2fa){return function(_0x19dfd9,_0x429f46){_0x37c2fa(_0x19dfd9,_0x429f46,_0x42f528);};};Object[_0x5df4c7(0x228)](exports,_0x5df4c7(0x231),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x5df4c7(0x20a)),typeorm_2=require('typeorm'),order_entity_1=require(_0x5df4c7(0x235)),cramiPackage_entity_1=require(_0x5df4c7(0x1ff)),utils_1=require(_0x5df4c7(0x204)),pay_service_1=require(_0x5df4c7(0x1ed)),globalConfig_service_1=require(_0x5df4c7(0x206));let OrderService=class OrderService{constructor(_0x582e41,_0x56e762,_0x1334df,_0x26740a,_0x4abb9e){const _0x3e3cd=_0x5df4c7;this[_0x3e3cd(0x233)]=_0x582e41,this[_0x3e3cd(0x1e8)]=_0x56e762,this[_0x3e3cd(0x212)]=_0x1334df,this[_0x3e3cd(0x1fc)]=_0x26740a,this[_0x3e3cd(0x201)]=_0x4abb9e;}async[_0x5df4c7(0x227)](_0x585caf,_0x40cc36){const _0x3fd62d=_0x5df4c7;try{const {goodsId:_0x1470f0,count:count=0x1,payType:_0x42e461}=_0x585caf,{id:_0x41b344}=_0x40cc36[_0x3fd62d(0x1f9)];if(_0x41b344>0xf4240)throw new common_1[(_0x3fd62d(0x22d))](_0x3fd62d(0x21b),common_1[_0x3fd62d(0x1f1)][_0x3fd62d(0x230)]);const _0x38658f=await this[_0x3fd62d(0x1fa)](_0x41b344,_0x1470f0,count,_0x42e461),_0x434a35=await this[_0x3fd62d(0x1fc)]['pay'](_0x41b344,_0x38658f[_0x3fd62d(0x232)],_0x42e461);return Object[_0x3fd62d(0x1fb)](Object[_0x3fd62d(0x1fb)]({},_0x434a35),{'orderId':_0x38658f[_0x3fd62d(0x232)],'platform':_0x38658f[_0x3fd62d(0x215)],'total':_0x38658f[_0x3fd62d(0x21e)]});}catch(_0x342bc3){if(_0x342bc3[_0x3fd62d(0x1f6)]===0x191)throw new common_1['HttpException'](_0x342bc3['message'],common_1[_0x3fd62d(0x1f1)][_0x3fd62d(0x230)]);throw new common_1[(_0x3fd62d(0x22d))](_0x342bc3['message']||_0x3fd62d(0x219),common_1[_0x3fd62d(0x1f1)][_0x3fd62d(0x202)]);}}async[_0x5df4c7(0x200)](_0x21a9a6,_0x1f2dfc){const _0x24c324=_0x5df4c7,{status:_0x631c98,transactionNo:_0x460388}=_0x21a9a6[_0x24c324(0x22f)],{id:_0x54eeaa}=_0x21a9a6[_0x24c324(0x1f9)],_0x4c6180=await this[_0x24c324(0x233)][_0x24c324(0x1f5)]({'where':{'userId':_0x54eeaa,'orderId':_0x460388}});if(!_0x4c6180)throw new common_1[(_0x24c324(0x22d))](_0x24c324(0x222),common_1[_0x24c324(0x1f1)]['BAD_REQUEST']);return _0x4c6180;}async[_0x5df4c7(0x1fa)](_0x4158df,_0x377895,_0x2eceb5,_0x26f57e){const _0x28d6ec=_0x5df4c7,_0x3011a0=await this[_0x28d6ec(0x201)][_0x28d6ec(0x211)](),_0x238d8b=await this[_0x28d6ec(0x1e8)][_0x28d6ec(0x1f5)]({'where':{'id':_0x377895}});if(!_0x238d8b)throw new common_1[(_0x28d6ec(0x22d))](_0x28d6ec(0x226),common_1[_0x28d6ec(0x1f1)][_0x28d6ec(0x202)]);const _0x5286c3={};_0x5286c3[_0x28d6ec(0x232)]=(0x0,utils_1[_0x28d6ec(0x223)])(),_0x5286c3[_0x28d6ec(0x207)]=_0x4158df,_0x5286c3['goodsId']=_0x377895,_0x5286c3['price']=Number(_0x238d8b[_0x28d6ec(0x1f4)]),_0x5286c3[_0x28d6ec(0x214)]=_0x2eceb5,_0x5286c3[_0x28d6ec(0x21e)]=Number(_0x238d8b[_0x28d6ec(0x1f4)])*_0x2eceb5,_0x5286c3['payPlatform']=_0x3011a0,_0x5286c3[_0x28d6ec(0x213)]=_0x26f57e;const _0x310b07=await this[_0x28d6ec(0x233)]['save'](_0x5286c3);return console[_0x28d6ec(0x20d)](_0x28d6ec(0x205),_0x310b07),_0x310b07;}async[_0x5df4c7(0x21f)](_0x258901,_0x33528a,_0x2ff1f0){const _0x1fbc4e=_0x5df4c7;return await this[_0x1fbc4e(0x233)][_0x1fbc4e(0x224)]({'where':{'userId':_0x258901},'order':{'id':'DESC'},'skip':(_0x33528a-0x1)*_0x2ff1f0,'take':_0x2ff1f0});}async[_0x5df4c7(0x1ea)](_0x2f71bb){const _0x10273b=_0x5df4c7,{page:_0x4bac1f,size:_0x21c096,userId:_0x11489f,platform:_0x2e98ac,status:_0xbfb1a7}=_0x2f71bb,_0x4f35e8={};if(_0x11489f)_0x4f35e8[_0x10273b(0x207)]=_0x11489f;if(_0x2e98ac)_0x4f35e8['payPlatform']=_0x2e98ac;if(_0xbfb1a7)_0x4f35e8['status']=_0xbfb1a7;const [_0x2f5d41,_0x1bac69]=await this[_0x10273b(0x233)][_0x10273b(0x224)]({'order':{'id':'DESC'},'where':_0x4f35e8,'skip':(_0x4bac1f-0x1)*_0x21c096,'take':_0x21c096}),_0x1b2e0e=_0x2f5d41[_0x10273b(0x1e9)](_0x48adc0=>_0x48adc0['userId']),_0x3a46f6=_0x2f5d41[_0x10273b(0x1e9)](_0x837fc0=>_0x837fc0['goodsId']),_0x470c57=await this[_0x10273b(0x212)][_0x10273b(0x1f7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1b2e0e)},'select':['id',_0x10273b(0x1e5),_0x10273b(0x20c)]}),_0x47bb66=await this[_0x10273b(0x1e8)][_0x10273b(0x1f7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3a46f6)},'select':['id',_0x10273b(0x209),_0x10273b(0x229),_0x10273b(0x22e)]});_0x2f5d41[_0x10273b(0x208)](_0x58d554=>{const _0x50409a=_0x10273b;_0x58d554['userInfo']=_0x470c57[_0x50409a(0x1f7)](_0x2dde2a=>_0x2dde2a['id']===_0x58d554['userId']),_0x58d554['goodsInfo']=_0x47bb66[_0x50409a(0x1f7)](_0x5eaac4=>_0x5eaac4['id']===_0x58d554[_0x50409a(0x1f8)]);});const _0x77992b=await this[_0x10273b(0x233)][_0x10273b(0x237)](_0x10273b(0x238))[_0x10273b(0x22a)](_0x10273b(0x217),{'status':0x1})[_0x10273b(0x22c)]('SUM(order.price)',_0x10273b(0x1ee))[_0x10273b(0x225)]();return Object[_0x10273b(0x1fb)]({'rows':_0x2f5d41,'count':_0x1bac69},_0x77992b);}async[_0x5df4c7(0x216)](_0x4adf38){const _0x102b8b=_0x5df4c7,{orderId:_0x4b9171}=_0x4adf38,_0x151338=await this['orderEntity']['findOne']({'where':{'orderId':_0x4b9171}});if(!_0x151338)throw new common_1[(_0x102b8b(0x22d))](_0x102b8b(0x222),common_1[_0x102b8b(0x1f1)][_0x102b8b(0x202)]);return await this[_0x102b8b(0x233)][_0x102b8b(0x1fe)]({'orderId':_0x4b9171});}async[_0x5df4c7(0x1ec)](){const _0x1c83d0=_0x5df4c7;return await this[_0x1c83d0(0x233)][_0x1c83d0(0x1fe)]({'status':0x0});}};function _0x2fb9(){const _0x2ae1bf=['../../common/utils','order:\x20','../globalConfig/globalConfig.service','userId','forEach','name','@nestjs/common','2613gIsapq','email','log','__param','function','9RJsrpw','queryPayType','userEntity','channel','count','payPlatform','deleteOrder','order.status\x20=\x20:status','13729510LwhHvQ','购买失败!','__decorate','请先注册账号后购买商品！','Repository','7839370FgFGEs','total','query','object','Injectable','订单不存在!','createOrderId','findAndCount','getRawOne','套餐不存在!','buy','defineProperty','coverImg','where','decorate','select','HttpException','des','params','UNAUTHORIZED','__esModule','orderId','orderEntity','4285206UwfbED','./order.entity','1251928iPOmtA','createQueryBuilder','order','31157qwlkUF','username','metadata','876rjZKfI','cramiPackageEntity','map','queryAllOrder','InjectRepository','deleteNotPay','../pay/pay.service','total_price','length','GlobalConfigService','HttpStatus','2488lAUlMg','OrderService','price','findOne','status','find','goodsId','user','create','assign','payService','2587928EgAicF','delete','../crami/cramiPackage.entity','queryByOrderId','globalConfigService','BAD_REQUEST','CramiPackageEntity'];_0x2fb9=function(){return _0x2ae1bf;};return _0x2fb9();}OrderService=__decorate([(0x0,common_1[_0x5df4c7(0x221)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0x5df4c7(0x1eb)])(cramiPackage_entity_1[_0x5df4c7(0x203)])),__param(0x2,(0x0,typeorm_1[_0x5df4c7(0x1eb)])(user_entity_1['UserEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x5df4c7(0x21c)],typeorm_2[_0x5df4c7(0x21c)],typeorm_2[_0x5df4c7(0x21c)],pay_service_1['PayService'],globalConfig_service_1[_0x5df4c7(0x1f0)]])],OrderService),exports[_0x5df4c7(0x1f3)]=OrderService;