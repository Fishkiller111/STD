'use strict';const _0x20c277=_0x1952;(function(_0x57d6a0,_0x1d0f39){const _0x273ebf=_0x1952,_0x1149bd=_0x57d6a0();while(!![]){try{const _0x4b49b2=-parseInt(_0x273ebf(0x172))/0x1*(-parseInt(_0x273ebf(0x16a))/0x2)+parseInt(_0x273ebf(0x151))/0x3*(-parseInt(_0x273ebf(0x186))/0x4)+parseInt(_0x273ebf(0x180))/0x5*(parseInt(_0x273ebf(0x134))/0x6)+parseInt(_0x273ebf(0x17b))/0x7*(parseInt(_0x273ebf(0x183))/0x8)+-parseInt(_0x273ebf(0x187))/0x9*(-parseInt(_0x273ebf(0x141))/0xa)+parseInt(_0x273ebf(0x181))/0xb*(-parseInt(_0x273ebf(0x14e))/0xc)+-parseInt(_0x273ebf(0x146))/0xd;if(_0x4b49b2===_0x1d0f39)break;else _0x1149bd['push'](_0x1149bd['shift']());}catch(_0x542462){_0x1149bd['push'](_0x1149bd['shift']());}}}(_0x4bb0,0xb6d2e));function _0x1952(_0x28d883,_0x47595c){const _0x4bb07d=_0x4bb0();return _0x1952=function(_0x1952c6,_0x34a7c5){_0x1952c6=_0x1952c6-0x132;let _0x5884e1=_0x4bb07d[_0x1952c6];return _0x5884e1;},_0x1952(_0x28d883,_0x47595c);}var __decorate=this&&this['__decorate']||function(_0x3b7468,_0x2b0dcf,_0x3e413a,_0x2c6ad2){const _0x5bbdc1=_0x1952;var _0x12f2b2=arguments['length'],_0x347f41=_0x12f2b2<0x3?_0x2b0dcf:_0x2c6ad2===null?_0x2c6ad2=Object[_0x5bbdc1(0x16e)](_0x2b0dcf,_0x3e413a):_0x2c6ad2,_0x14ef4d;if(typeof Reflect===_0x5bbdc1(0x13c)&&typeof Reflect['decorate']===_0x5bbdc1(0x138))_0x347f41=Reflect[_0x5bbdc1(0x16c)](_0x3b7468,_0x2b0dcf,_0x3e413a,_0x2c6ad2);else{for(var _0x2a2ec6=_0x3b7468['length']-0x1;_0x2a2ec6>=0x0;_0x2a2ec6--)if(_0x14ef4d=_0x3b7468[_0x2a2ec6])_0x347f41=(_0x12f2b2<0x3?_0x14ef4d(_0x347f41):_0x12f2b2>0x3?_0x14ef4d(_0x2b0dcf,_0x3e413a,_0x347f41):_0x14ef4d(_0x2b0dcf,_0x3e413a))||_0x347f41;}return _0x12f2b2>0x3&&_0x347f41&&Object['defineProperty'](_0x2b0dcf,_0x3e413a,_0x347f41),_0x347f41;},__metadata=this&&this[_0x20c277(0x137)]||function(_0x50dab3,_0x1f14f1){const _0x429391=_0x20c277;if(typeof Reflect===_0x429391(0x13c)&&typeof Reflect[_0x429391(0x167)]===_0x429391(0x138))return Reflect[_0x429391(0x167)](_0x50dab3,_0x1f14f1);},__param=this&&this[_0x20c277(0x144)]||function(_0x15c986,_0x11b4d0){return function(_0x50e8bd,_0x293375){_0x11b4d0(_0x50e8bd,_0x293375,_0x15c986);};};Object[_0x20c277(0x17d)](exports,_0x20c277(0x161),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require('../user/user.entity'),typeorm_1=require(_0x20c277(0x135)),common_1=require(_0x20c277(0x154)),typeorm_2=require(_0x20c277(0x13d)),order_entity_1=require(_0x20c277(0x16d)),cramiPackage_entity_1=require(_0x20c277(0x139)),utils_1=require(_0x20c277(0x165)),pay_service_1=require('../pay/pay.service'),globalConfig_service_1=require(_0x20c277(0x170));let OrderService=class OrderService{constructor(_0x2b6ea3,_0x1e97b0,_0x3c5ebb,_0x4150f3,_0x42e221){const _0x925a6a=_0x20c277;this[_0x925a6a(0x15c)]=_0x2b6ea3,this[_0x925a6a(0x169)]=_0x1e97b0,this[_0x925a6a(0x171)]=_0x3c5ebb,this[_0x925a6a(0x182)]=_0x4150f3,this[_0x925a6a(0x168)]=_0x42e221;}async['buy'](_0x49ffa5,_0x2b7454){const _0x5a32c3=_0x20c277;try{const {goodsId:_0x33d5f1,count:count=0x1,payType:_0x3eb226}=_0x49ffa5,{id:_0x8e35a0}=_0x2b7454['user'];if(_0x8e35a0>0xf4240)throw new common_1[(_0x5a32c3(0x177))](_0x5a32c3(0x163),common_1['HttpStatus'][_0x5a32c3(0x17f)]);const _0x3671ae=await this[_0x5a32c3(0x16b)](_0x8e35a0,_0x33d5f1,count,_0x3eb226),_0x3c5ec4=await this[_0x5a32c3(0x182)][_0x5a32c3(0x15b)](_0x8e35a0,_0x3671ae[_0x5a32c3(0x175)],_0x3eb226);return Object[_0x5a32c3(0x145)](Object[_0x5a32c3(0x145)]({},_0x3c5ec4),{'orderId':_0x3671ae['orderId'],'platform':_0x3671ae[_0x5a32c3(0x14d)],'total':_0x3671ae[_0x5a32c3(0x176)]});}catch(_0x55e409){if(_0x55e409[_0x5a32c3(0x156)]===0x191)throw new common_1[(_0x5a32c3(0x177))](_0x55e409[_0x5a32c3(0x133)],common_1[_0x5a32c3(0x142)]['UNAUTHORIZED']);throw new common_1[(_0x5a32c3(0x177))](_0x55e409[_0x5a32c3(0x133)]||'购买失败!',common_1[_0x5a32c3(0x142)]['BAD_REQUEST']);}}async[_0x20c277(0x14b)](_0x3fbb95,_0x29f115){const _0x362e98=_0x20c277,{status:_0x5bc6c2,transactionNo:_0x518e11}=_0x3fbb95[_0x362e98(0x13b)],{id:_0x298908}=_0x3fbb95[_0x362e98(0x16f)],_0x58a30a=await this['orderEntity'][_0x362e98(0x178)]({'where':{'userId':_0x298908,'orderId':_0x518e11}});if(!_0x58a30a)throw new common_1['HttpException'](_0x362e98(0x15f),common_1['HttpStatus'][_0x362e98(0x132)]);return _0x58a30a;}async['create'](_0x5b1e99,_0x18c070,_0x357e0,_0x142e8d){const _0x1a1a62=_0x20c277,_0x3e2639=await this[_0x1a1a62(0x168)]['queryPayType'](),_0x4fb325=await this['cramiPackageEntity'][_0x1a1a62(0x178)]({'where':{'id':_0x18c070}});if(!_0x4fb325)throw new common_1['HttpException']('套餐不存在!',common_1[_0x1a1a62(0x142)][_0x1a1a62(0x132)]);const _0x5b5d8c={};_0x5b5d8c[_0x1a1a62(0x175)]=(0x0,utils_1[_0x1a1a62(0x160)])(),_0x5b5d8c[_0x1a1a62(0x14f)]=_0x5b1e99,_0x5b5d8c[_0x1a1a62(0x136)]=_0x18c070,_0x5b5d8c[_0x1a1a62(0x158)]=Number(_0x4fb325[_0x1a1a62(0x158)]),_0x5b5d8c[_0x1a1a62(0x148)]=_0x357e0,_0x5b5d8c[_0x1a1a62(0x176)]=Number(_0x4fb325['price'])*_0x357e0,_0x5b5d8c[_0x1a1a62(0x14d)]=_0x3e2639,_0x5b5d8c[_0x1a1a62(0x166)]=_0x142e8d;const _0x3ffe91=await this[_0x1a1a62(0x15c)][_0x1a1a62(0x17a)](_0x5b5d8c);return console[_0x1a1a62(0x179)]('order:\x20',_0x3ffe91),_0x3ffe91;}async[_0x20c277(0x13e)](_0x5bcc22,_0x4841fd,_0x2f237a){const _0xfcea19=_0x20c277;return await this[_0xfcea19(0x15c)][_0xfcea19(0x149)]({'where':{'userId':_0x5bcc22},'order':{'id':_0xfcea19(0x173)},'skip':(_0x4841fd-0x1)*_0x2f237a,'take':_0x2f237a});}async[_0x20c277(0x14a)](_0x2ba854){const _0x3b0df8=_0x20c277,{page:_0x251b6b,size:_0x5b425d,userId:_0x29bebf,platform:_0x1d64c1,status:_0x48c369}=_0x2ba854,_0x169557={};if(_0x29bebf)_0x169557[_0x3b0df8(0x14f)]=_0x29bebf;if(_0x1d64c1)_0x169557[_0x3b0df8(0x14d)]=_0x1d64c1;if(_0x48c369)_0x169557[_0x3b0df8(0x156)]=_0x48c369;const [_0x163880,_0x22c770]=await this['orderEntity'][_0x3b0df8(0x149)]({'order':{'id':_0x3b0df8(0x173)},'where':_0x169557,'skip':(_0x251b6b-0x1)*_0x5b425d,'take':_0x5b425d}),_0x5f6d70=_0x163880[_0x3b0df8(0x157)](_0x1a590d=>_0x1a590d[_0x3b0df8(0x14f)]),_0x739c45=_0x163880[_0x3b0df8(0x157)](_0x58952a=>_0x58952a[_0x3b0df8(0x136)]),_0x9e7c71=await this[_0x3b0df8(0x171)][_0x3b0df8(0x17c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5f6d70)},'select':['id',_0x3b0df8(0x185),_0x3b0df8(0x17e)]}),_0x2066bf=await this[_0x3b0df8(0x169)][_0x3b0df8(0x17c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x739c45)},'select':['id','name','coverImg',_0x3b0df8(0x14c)]});_0x163880[_0x3b0df8(0x153)](_0x46994f=>{const _0x12cd4d=_0x3b0df8;_0x46994f[_0x12cd4d(0x159)]=_0x9e7c71[_0x12cd4d(0x17c)](_0x1f1afe=>_0x1f1afe['id']===_0x46994f[_0x12cd4d(0x14f)]),_0x46994f['goodsInfo']=_0x2066bf[_0x12cd4d(0x17c)](_0x3b0720=>_0x3b0720['id']===_0x46994f[_0x12cd4d(0x136)]);});const _0x1d186d=await this['orderEntity']['createQueryBuilder'](_0x3b0df8(0x15d))[_0x3b0df8(0x13f)](_0x3b0df8(0x162),{'status':0x1})[_0x3b0df8(0x152)](_0x3b0df8(0x184),_0x3b0df8(0x150))[_0x3b0df8(0x13a)]();return Object['assign']({'rows':_0x163880,'count':_0x22c770},_0x1d186d);}async[_0x20c277(0x143)](_0x289a0f){const _0x9c5968=_0x20c277,{orderId:_0x4717cb}=_0x289a0f,_0x2a839e=await this['orderEntity'][_0x9c5968(0x178)]({'where':{'orderId':_0x4717cb}});if(!_0x2a839e)throw new common_1[(_0x9c5968(0x177))](_0x9c5968(0x15f),common_1[_0x9c5968(0x142)][_0x9c5968(0x132)]);return await this[_0x9c5968(0x15c)][_0x9c5968(0x15e)]({'orderId':_0x4717cb});}async['deleteNotPay'](){const _0x589e77=_0x20c277;return await this[_0x589e77(0x15c)][_0x589e77(0x15e)]({'status':0x0});}};function _0x4bb0(){const _0x2a082e=['__metadata','function','../crami/cramiPackage.entity','getRawOne','params','object','typeorm','query','where','Repository','10439610OHtKgR','HttpStatus','deleteOrder','__param','assign','17558151CDeKkM','PayService','count','findAndCount','queryAllOrder','queryByOrderId','des','payPlatform','12756msXbee','userId','total_price','3VfkcYN','select','forEach','@nestjs/common','design:paramtypes','status','map','price','userInfo','InjectRepository','pay','orderEntity','order','delete','订单不存在!','createOrderId','__esModule','order.status\x20=\x20:status','请先注册账号后购买商品！','UserEntity','../../common/utils','channel','metadata','globalConfigService','cramiPackageEntity','1260286TkihCJ','create','decorate','./order.entity','getOwnPropertyDescriptor','user','../globalConfig/globalConfig.service','userEntity','2oHrBoy','DESC','Injectable','orderId','total','HttpException','findOne','log','save','19831wyQdhs','find','defineProperty','email','UNAUTHORIZED','5KogMpB','8459sicfAd','payService','1576fSfrIu','SUM(order.price)','username','4179036TbmqEc','9RghrOq','BAD_REQUEST','message','6595986kCqXZo','@nestjs/typeorm','goodsId'];_0x4bb0=function(){return _0x2a082e;};return _0x4bb0();}OrderService=__decorate([(0x0,common_1[_0x20c277(0x174)])(),__param(0x0,(0x0,typeorm_1[_0x20c277(0x15a)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x20c277(0x164)])),__metadata(_0x20c277(0x155),[typeorm_2['Repository'],typeorm_2[_0x20c277(0x140)],typeorm_2[_0x20c277(0x140)],pay_service_1[_0x20c277(0x147)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports['OrderService']=OrderService;