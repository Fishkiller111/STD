'use strict';const _0x4a51c1=_0x5770;(function(_0x3690e4,_0x5b9093){const _0x31c4cb=_0x5770,_0x18b38c=_0x3690e4();while(!![]){try{const _0x320749=parseInt(_0x31c4cb(0xbf))/0x1*(parseInt(_0x31c4cb(0xa2))/0x2)+parseInt(_0x31c4cb(0x9a))/0x3+-parseInt(_0x31c4cb(0xb2))/0x4*(parseInt(_0x31c4cb(0xd4))/0x5)+-parseInt(_0x31c4cb(0xc8))/0x6*(-parseInt(_0x31c4cb(0xc0))/0x7)+parseInt(_0x31c4cb(0xc2))/0x8*(-parseInt(_0x31c4cb(0xb6))/0x9)+parseInt(_0x31c4cb(0xdb))/0xa*(-parseInt(_0x31c4cb(0xc6))/0xb)+parseInt(_0x31c4cb(0xd2))/0xc*(-parseInt(_0x31c4cb(0xc3))/0xd);if(_0x320749===_0x5b9093)break;else _0x18b38c['push'](_0x18b38c['shift']());}catch(_0x47c7b5){_0x18b38c['push'](_0x18b38c['shift']());}}}(_0x3a23,0x9ebb8));var __decorate=this&&this['__decorate']||function(_0x1d0abc,_0x14a01d,_0x24b78b,_0x54c3eb){const _0x371ed4=_0x5770;var _0x737bf3=arguments[_0x371ed4(0xb4)],_0x3e5b27=_0x737bf3<0x3?_0x14a01d:_0x54c3eb===null?_0x54c3eb=Object[_0x371ed4(0xaf)](_0x14a01d,_0x24b78b):_0x54c3eb,_0x2e2e42;if(typeof Reflect===_0x371ed4(0xb1)&&typeof Reflect['decorate']===_0x371ed4(0xe3))_0x3e5b27=Reflect[_0x371ed4(0xe5)](_0x1d0abc,_0x14a01d,_0x24b78b,_0x54c3eb);else{for(var _0x43adc3=_0x1d0abc[_0x371ed4(0xb4)]-0x1;_0x43adc3>=0x0;_0x43adc3--)if(_0x2e2e42=_0x1d0abc[_0x43adc3])_0x3e5b27=(_0x737bf3<0x3?_0x2e2e42(_0x3e5b27):_0x737bf3>0x3?_0x2e2e42(_0x14a01d,_0x24b78b,_0x3e5b27):_0x2e2e42(_0x14a01d,_0x24b78b))||_0x3e5b27;}return _0x737bf3>0x3&&_0x3e5b27&&Object[_0x371ed4(0x99)](_0x14a01d,_0x24b78b,_0x3e5b27),_0x3e5b27;},__metadata=this&&this[_0x4a51c1(0xcc)]||function(_0x238474,_0x5c4232){const _0x174b51=_0x4a51c1;if(typeof Reflect==='object'&&typeof Reflect[_0x174b51(0x9d)]===_0x174b51(0xe3))return Reflect[_0x174b51(0x9d)](_0x238474,_0x5c4232);},__param=this&&this['__param']||function(_0x3a4609,_0x488684){return function(_0x242910,_0x46751e){_0x488684(_0x242910,_0x46751e,_0x3a4609);};};function _0x5770(_0x185ba2,_0x14442a){const _0x3a23de=_0x3a23();return _0x5770=function(_0x57700b,_0x2d0099){_0x57700b=_0x57700b-0x90;let _0x444deb=_0x3a23de[_0x57700b];return _0x444deb;},_0x5770(_0x185ba2,_0x14442a);}Object[_0x4a51c1(0x99)](exports,_0x4a51c1(0xaa),{'value':!![]}),exports[_0x4a51c1(0xa0)]=void 0x0;function _0x3a23(){const _0x494d55=['map','2189748JOkOYb','query','6CDUOFI','email','assign','findOne','__metadata','购买失败!','username','params','订单不存在!','DESC','1500XwwIyH','../user/user.entity','2359025hhpieY','userEntity','deleteNotPay','design:paramtypes','HttpStatus','Repository','Injectable','30VKDtcw','delete','log','globalConfigService','des','createOrderId','goodsId','createQueryBuilder','function','select','decorate','userId','price','BAD_REQUEST','order:\x20','OrderEntity','forEach','InjectRepository','@nestjs/typeorm','create','message','../pay/pay.service','defineProperty','3055773IYNIPj','where','userInfo','metadata','orderEntity','user','OrderService','find','467438wDnxLa','goodsInfo','UserEntity','status','SUM(order.price)','total','PayService','getRawOne','__esModule','findAndCount','@nestjs/common','order','HttpException','getOwnPropertyDescriptor','name','object','4OOnVbi','buy','length','total_price','171qkgAsB','payPlatform','请先注册账号后购买商品！','orderId','UNAUTHORIZED','套餐不存在!','queryAllOrder','save','order.status\x20=\x20:status','3CmPAlQ','5972148kNCVZM','cramiPackageEntity','73520YrqzOS','70629YatcfT','payService'];_0x3a23=function(){return _0x494d55;};return _0x3a23();}const user_entity_1=require(_0x4a51c1(0xd3)),typeorm_1=require(_0x4a51c1(0x95)),common_1=require(_0x4a51c1(0xac)),typeorm_2=require('typeorm'),order_entity_1=require('./order.entity'),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),utils_1=require('../../common/utils'),pay_service_1=require(_0x4a51c1(0x98)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let OrderService=class OrderService{constructor(_0xd05a06,_0x15f916,_0x559734,_0x262854,_0x40e995){const _0x282e14=_0x4a51c1;this[_0x282e14(0x9e)]=_0xd05a06,this[_0x282e14(0xc1)]=_0x15f916,this[_0x282e14(0xd5)]=_0x559734,this[_0x282e14(0xc4)]=_0x262854,this[_0x282e14(0xde)]=_0x40e995;}async[_0x4a51c1(0xb3)](_0x33cf87,_0x4d713d){const _0x1ced6a=_0x4a51c1;try{const {goodsId:_0x4b03e5,count:count=0x1,payType:_0x56cbd3}=_0x33cf87,{id:_0x5d7c98}=_0x4d713d[_0x1ced6a(0x9f)];if(_0x5d7c98>0xf4240)throw new common_1['HttpException'](_0x1ced6a(0xb8),common_1[_0x1ced6a(0xd8)][_0x1ced6a(0xba)]);const _0x3af6e6=await this[_0x1ced6a(0x96)](_0x5d7c98,_0x4b03e5,count,_0x56cbd3),_0x425435=await this[_0x1ced6a(0xc4)]['pay'](_0x5d7c98,_0x3af6e6[_0x1ced6a(0xb9)],_0x56cbd3);return Object[_0x1ced6a(0xca)](Object[_0x1ced6a(0xca)]({},_0x425435),{'orderId':_0x3af6e6['orderId'],'platform':_0x3af6e6[_0x1ced6a(0xb7)],'total':_0x3af6e6[_0x1ced6a(0xa7)]});}catch(_0x2ea44d){if(_0x2ea44d[_0x1ced6a(0xa5)]===0x191)throw new common_1[(_0x1ced6a(0xae))](_0x2ea44d[_0x1ced6a(0x97)],common_1[_0x1ced6a(0xd8)][_0x1ced6a(0xba)]);throw new common_1[(_0x1ced6a(0xae))](_0x2ea44d[_0x1ced6a(0x97)]||_0x1ced6a(0xcd),common_1['HttpStatus'][_0x1ced6a(0x90)]);}}async['queryByOrderId'](_0x2143a0,_0x547236){const _0x521ec6=_0x4a51c1,{status:_0x214339,transactionNo:_0x4bede1}=_0x2143a0[_0x521ec6(0xcf)],{id:_0x3b96c8}=_0x2143a0[_0x521ec6(0x9f)],_0x3028d1=await this[_0x521ec6(0x9e)][_0x521ec6(0xcb)]({'where':{'userId':_0x3b96c8,'orderId':_0x4bede1}});if(!_0x3028d1)throw new common_1['HttpException'](_0x521ec6(0xd0),common_1[_0x521ec6(0xd8)][_0x521ec6(0x90)]);return _0x3028d1;}async[_0x4a51c1(0x96)](_0x2a81ab,_0x3b4cee,_0x14743a,_0x118809){const _0xc8de87=_0x4a51c1,_0xfb4297=await this[_0xc8de87(0xde)]['queryPayType'](),_0x168218=await this['cramiPackageEntity'][_0xc8de87(0xcb)]({'where':{'id':_0x3b4cee}});if(!_0x168218)throw new common_1['HttpException'](_0xc8de87(0xbb),common_1[_0xc8de87(0xd8)]['BAD_REQUEST']);const _0x3b1be7={};_0x3b1be7[_0xc8de87(0xb9)]=(0x0,utils_1[_0xc8de87(0xe0)])(),_0x3b1be7[_0xc8de87(0xe6)]=_0x2a81ab,_0x3b1be7[_0xc8de87(0xe1)]=_0x3b4cee,_0x3b1be7['price']=Number(_0x168218[_0xc8de87(0xe7)]),_0x3b1be7['count']=_0x14743a,_0x3b1be7[_0xc8de87(0xa7)]=Number(_0x168218[_0xc8de87(0xe7)])*_0x14743a,_0x3b1be7['payPlatform']=_0xfb4297,_0x3b1be7['channel']=_0x118809;const _0x3342c9=await this[_0xc8de87(0x9e)][_0xc8de87(0xbd)](_0x3b1be7);return console[_0xc8de87(0xdd)](_0xc8de87(0x91),_0x3342c9),_0x3342c9;}async[_0x4a51c1(0xc7)](_0x1f64ae,_0x13ca75,_0x2aecec){const _0x3457b8=_0x4a51c1;return await this[_0x3457b8(0x9e)][_0x3457b8(0xab)]({'where':{'userId':_0x1f64ae},'order':{'id':_0x3457b8(0xd1)},'skip':(_0x13ca75-0x1)*_0x2aecec,'take':_0x2aecec});}async[_0x4a51c1(0xbc)](_0x2d99fa){const _0x3846c2=_0x4a51c1,{page:_0x551147,size:_0x2e1127,userId:_0x456f8c,platform:_0x5033cd,status:_0x27c3e7}=_0x2d99fa,_0x1ed870={};if(_0x456f8c)_0x1ed870['userId']=_0x456f8c;if(_0x5033cd)_0x1ed870[_0x3846c2(0xb7)]=_0x5033cd;if(_0x27c3e7)_0x1ed870['status']=_0x27c3e7;const [_0x4935b9,_0x185799]=await this['orderEntity'][_0x3846c2(0xab)]({'order':{'id':'DESC'},'where':_0x1ed870,'skip':(_0x551147-0x1)*_0x2e1127,'take':_0x2e1127}),_0x49ae82=_0x4935b9['map'](_0x480176=>_0x480176[_0x3846c2(0xe6)]),_0x514149=_0x4935b9[_0x3846c2(0xc5)](_0x2e6fc8=>_0x2e6fc8[_0x3846c2(0xe1)]),_0x43a82d=await this[_0x3846c2(0xd5)][_0x3846c2(0xa1)]({'where':{'id':(0x0,typeorm_2['In'])(_0x49ae82)},'select':['id',_0x3846c2(0xce),_0x3846c2(0xc9)]}),_0x31b133=await this[_0x3846c2(0xc1)][_0x3846c2(0xa1)]({'where':{'id':(0x0,typeorm_2['In'])(_0x514149)},'select':['id',_0x3846c2(0xb0),'coverImg',_0x3846c2(0xdf)]});_0x4935b9[_0x3846c2(0x93)](_0x2f77db=>{const _0x5c1278=_0x3846c2;_0x2f77db[_0x5c1278(0x9c)]=_0x43a82d[_0x5c1278(0xa1)](_0x54394e=>_0x54394e['id']===_0x2f77db[_0x5c1278(0xe6)]),_0x2f77db[_0x5c1278(0xa3)]=_0x31b133['find'](_0x1fc5a1=>_0x1fc5a1['id']===_0x2f77db[_0x5c1278(0xe1)]);});const _0x33985b=await this[_0x3846c2(0x9e)][_0x3846c2(0xe2)](_0x3846c2(0xad))[_0x3846c2(0x9b)](_0x3846c2(0xbe),{'status':0x1})[_0x3846c2(0xe4)](_0x3846c2(0xa6),_0x3846c2(0xb5))[_0x3846c2(0xa9)]();return Object[_0x3846c2(0xca)]({'rows':_0x4935b9,'count':_0x185799},_0x33985b);}async['deleteOrder'](_0x197936){const _0x5b5eb9=_0x4a51c1,{orderId:_0x5eff05}=_0x197936,_0x338a5=await this[_0x5b5eb9(0x9e)][_0x5b5eb9(0xcb)]({'where':{'orderId':_0x5eff05}});if(!_0x338a5)throw new common_1['HttpException']('订单不存在!',common_1[_0x5b5eb9(0xd8)][_0x5b5eb9(0x90)]);return await this[_0x5b5eb9(0x9e)]['delete']({'orderId':_0x5eff05});}async[_0x4a51c1(0xd6)](){const _0x349f74=_0x4a51c1;return await this[_0x349f74(0x9e)][_0x349f74(0xdc)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0x4a51c1(0xda)])(),__param(0x0,(0x0,typeorm_1[_0x4a51c1(0x94)])(order_entity_1[_0x4a51c1(0x92)])),__param(0x1,(0x0,typeorm_1[_0x4a51c1(0x94)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x4a51c1(0x94)])(user_entity_1[_0x4a51c1(0xa4)])),__metadata(_0x4a51c1(0xd7),[typeorm_2[_0x4a51c1(0xd9)],typeorm_2[_0x4a51c1(0xd9)],typeorm_2['Repository'],pay_service_1[_0x4a51c1(0xa8)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports['OrderService']=OrderService;