'use strict';const _0x24a42a=_0x80b8;(function(_0x5ddeb7,_0x5236ad){const _0x38b0f9=_0x80b8,_0x4fccd4=_0x5ddeb7();while(!![]){try{const _0x4faf52=-parseInt(_0x38b0f9(0x205))/0x1+parseInt(_0x38b0f9(0x1b8))/0x2*(-parseInt(_0x38b0f9(0x1ff))/0x3)+parseInt(_0x38b0f9(0x227))/0x4+-parseInt(_0x38b0f9(0x1f4))/0x5*(parseInt(_0x38b0f9(0x1e1))/0x6)+parseInt(_0x38b0f9(0x1d0))/0x7+parseInt(_0x38b0f9(0x210))/0x8+parseInt(_0x38b0f9(0x229))/0x9;if(_0x4faf52===_0x5236ad)break;else _0x4fccd4['push'](_0x4fccd4['shift']());}catch(_0x59bdbe){_0x4fccd4['push'](_0x4fccd4['shift']());}}}(_0xc6e6,0xd074f));var __decorate=this&&this[_0x24a42a(0x1ec)]||function(_0x440b8d,_0x75449,_0x3d21ca,_0x5135c9){const _0x5c68e1=_0x24a42a;var _0x67d4e9=arguments[_0x5c68e1(0x206)],_0x599422=_0x67d4e9<0x3?_0x75449:_0x5135c9===null?_0x5135c9=Object[_0x5c68e1(0x1bb)](_0x75449,_0x3d21ca):_0x5135c9,_0x1a5688;if(typeof Reflect===_0x5c68e1(0x222)&&typeof Reflect[_0x5c68e1(0x1de)]===_0x5c68e1(0x221))_0x599422=Reflect[_0x5c68e1(0x1de)](_0x440b8d,_0x75449,_0x3d21ca,_0x5135c9);else{for(var _0x4f4c21=_0x440b8d[_0x5c68e1(0x206)]-0x1;_0x4f4c21>=0x0;_0x4f4c21--)if(_0x1a5688=_0x440b8d[_0x4f4c21])_0x599422=(_0x67d4e9<0x3?_0x1a5688(_0x599422):_0x67d4e9>0x3?_0x1a5688(_0x75449,_0x3d21ca,_0x599422):_0x1a5688(_0x75449,_0x3d21ca))||_0x599422;}return _0x67d4e9>0x3&&_0x599422&&Object['defineProperty'](_0x75449,_0x3d21ca,_0x599422),_0x599422;},__metadata=this&&this[_0x24a42a(0x21c)]||function(_0x4954e2,_0x28ff75){const _0x438099=_0x24a42a;if(typeof Reflect===_0x438099(0x222)&&typeof Reflect[_0x438099(0x1d1)]==='function')return Reflect[_0x438099(0x1d1)](_0x4954e2,_0x28ff75);},__param=this&&this['__param']||function(_0x32c8db,_0x555c71){return function(_0x3adaab,_0x3b7998){_0x555c71(_0x3adaab,_0x3b7998,_0x32c8db);};};Object[_0x24a42a(0x1e2)](exports,'__esModule',{'value':!![]}),exports[_0x24a42a(0x208)]=void 0x0;function _0x80b8(_0x3c33d9,_0x519b85){const _0xc6e66a=_0xc6e6();return _0x80b8=function(_0x30088f,_0x25e12a){_0x30088f=_0x30088f-0x1b8;let _0x5526ff=_0xc6e66a[_0x30088f];return _0x5526ff;},_0x80b8(_0x3c33d9,_0x519b85);}const common_1=require(_0x24a42a(0x1e5)),typeorm_1=require(_0x24a42a(0x20b)),chatLog_entity_1=require(_0x24a42a(0x225)),typeorm_2=require(_0x24a42a(0x1bd)),balance_constant_1=require(_0x24a42a(0x1c8)),user_entity_1=require(_0x24a42a(0x1ea)),utils_1=require(_0x24a42a(0x1d2)),exceljs_1=require(_0x24a42a(0x1cc)),chatGroup_entity_1=require(_0x24a42a(0x1cb));let ChatLogService=class ChatLogService{constructor(_0x448757,_0x16c82d,_0x3fd99f){const _0x5cdd48=_0x24a42a;this[_0x5cdd48(0x1f0)]=_0x448757,this[_0x5cdd48(0x223)]=_0x16c82d,this[_0x5cdd48(0x1fa)]=_0x3fd99f;}async['saveChatLog'](_0x41aaeb){const _0x1c52a7=_0x24a42a;return await this[_0x1c52a7(0x1f0)][_0x1c52a7(0x1c6)](_0x41aaeb);}async[_0x24a42a(0x1e7)](_0x189116,_0x197714){const _0x1cdb3c=_0x24a42a,{id:_0x5c121f}=_0x189116[_0x1cdb3c(0x214)],{model:_0x730883}=_0x197714,_0x1ee720={'userId':_0x5c121f,'type':balance_constant_1[_0x1cdb3c(0x1f1)][_0x1cdb3c(0x209)]};_0x730883&&(_0x1ee720[_0x1cdb3c(0x1c2)]=_0x730883,_0x730883==='DALL-E2'&&(_0x1ee720['model']=(0x0,typeorm_2['In'])([_0x1cdb3c(0x1c0),_0x1cdb3c(0x1e6)])));const _0x584279=await this[_0x1cdb3c(0x1f0)][_0x1cdb3c(0x20c)]({'where':_0x1ee720,'order':{'id':_0x1cdb3c(0x1ba)},'select':['id',_0x1cdb3c(0x1fe),_0x1cdb3c(0x20f),_0x1cdb3c(0x1cd),_0x1cdb3c(0x1c5),_0x1cdb3c(0x1c2),_0x1cdb3c(0x1f3),_0x1cdb3c(0x1be),_0x1cdb3c(0x22a)]});return _0x584279[_0x1cdb3c(0x1d6)](_0xb4980d=>{const _0x3acae8=_0x1cdb3c;if(_0xb4980d[_0x3acae8(0x1be)]==='paintCount'){const _0x6bfec8=_0xb4980d[_0x3acae8(0x1c2)]==='mj'?0x136:0xa0,_0x52c62c=_0xb4980d[_0x3acae8(0x1fe)][_0x3acae8(0x1dd)](_0x3acae8(0x224))?'tencent':_0x3acae8(0x1ef),_0x12e3dd=_0x52c62c==='tencent'?_0x3acae8(0x1f2)+_0x6bfec8+_0x3acae8(0x1df):_0x3acae8(0x1e4)+_0x6bfec8;_0xb4980d[_0x3acae8(0x1dc)]=_0xb4980d['answer']+_0x12e3dd;try{_0xb4980d[_0x3acae8(0x22a)]=_0xb4980d[_0x3acae8(0x22a)]?JSON[_0x3acae8(0x207)](_0xb4980d[_0x3acae8(0x22a)]):null;}catch(_0x6cb137){_0xb4980d[_0x3acae8(0x22a)]={};}}}),_0x584279;}async[_0x24a42a(0x1b9)](_0x300e9f){const _0x1ff7b0=_0x24a42a,{page:page=0x1,size:size=0x14,rec:_0x4ff2b3,userId:_0x587d1e,model:_0x500927}=_0x300e9f,_0x420302={'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':(0x0,typeorm_2['Not'])(''),'answer':(0x0,typeorm_2[_0x1ff7b0(0x1ee)])('')};_0x4ff2b3&&Object['assign'](_0x420302,{'rec':_0x4ff2b3}),_0x587d1e&&Object['assign'](_0x420302,{'userId':_0x587d1e});_0x500927&&(_0x420302[_0x1ff7b0(0x1c2)]=_0x500927,_0x500927===_0x1ff7b0(0x1c0)&&(_0x420302['model']=(0x0,typeorm_2['In'])([_0x1ff7b0(0x1c0),'dall-e-3'])));const [_0x3b3215,_0x51aeb2]=await this['chatLogEntity'][_0x1ff7b0(0x1f6)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x420302});return _0x3b3215[_0x1ff7b0(0x1d6)](_0x37477d=>{const _0x16db42=_0x1ff7b0;var _0x4ee6b8;if(_0x37477d[_0x16db42(0x1be)]==='paintCount'){const _0x3eb509=_0x37477d[_0x16db42(0x1c2)]==='mj'?0x136:0xa0,_0x31b55b=_0x37477d[_0x16db42(0x1fe)][_0x16db42(0x1dd)]('cos')?_0x16db42(0x212):_0x16db42(0x1ef),_0x354bf8=_0x31b55b==='tencent'?'?imageView2/1/w/'+_0x3eb509+_0x16db42(0x1df):'?x-oss-process=image/resize,w_'+_0x3eb509;_0x37477d['thumbImg']=_0x37477d[_0x16db42(0x1fe)]+_0x354bf8;try{const _0x5ddced=_0x37477d[_0x16db42(0x1f3)]?JSON['parse'](_0x37477d[_0x16db42(0x1f3)]):null;_0x5ddced&&(_0x5ddced?_0x37477d['isGroup']=((_0x4ee6b8=_0x5ddced===null||_0x5ddced===void 0x0?void 0x0:_0x5ddced['components'][0x0])===null||_0x4ee6b8===void 0x0?void 0x0:_0x4ee6b8[_0x16db42(0x217)][_0x16db42(0x206)])===0x5:_0x37477d[_0x16db42(0x226)]=![]);}catch(_0x2aea9e){console['log'](_0x16db42(0x1d8),_0x2aea9e);}}}),{'rows':_0x3b3215,'count':_0x51aeb2};}async[_0x24a42a(0x1d7)](_0x27c5b4){const _0x126161=_0x24a42a,{id:_0xe735e6}=_0x27c5b4,_0x43b005=await this[_0x126161(0x1f0)]['findOne']({'where':{'id':_0xe735e6,'type':balance_constant_1[_0x126161(0x1f1)][_0x126161(0x209)]}});if(!_0x43b005)throw new common_1[(_0x126161(0x211))](_0x126161(0x1fc),common_1[_0x126161(0x219)][_0x126161(0x21d)]);const _0x1a87cc=_0x43b005[_0x126161(0x1c9)]===0x1?0x0:0x1,_0x4f5492=await this['chatLogEntity'][_0x126161(0x1c4)]({'id':_0xe735e6},{'rec':_0x1a87cc});if(_0x4f5492[_0x126161(0x1da)]>0x0)return(_0x1a87cc?'推荐':_0x126161(0x215))+'图片成功！';throw new common_1['HttpException'](_0x126161(0x203),common_1[_0x126161(0x219)]['BAD_REQUEST']);}async[_0x24a42a(0x1d5)](_0x2497f0,_0x270dc5){const _0x278174=_0x24a42a,_0xf3830b={'type':balance_constant_1['DeductionKey'][_0x278174(0x20a)]},{page:page=0x1,size:size=0x1e,prompt:_0x1d2291,email:_0x2dff13}=_0x2497f0;_0x1d2291&&Object[_0x278174(0x201)](_0xf3830b,{'prompt':(0x0,typeorm_2[_0x278174(0x220)])('%'+_0x1d2291+'%')});if(_0x2dff13){const _0x291a4f=await this[_0x278174(0x223)][_0x278174(0x1fd)]({'where':{'email':_0x2dff13}});(_0x291a4f===null||_0x291a4f===void 0x0?void 0x0:_0x291a4f['id'])&&Object[_0x278174(0x201)](_0xf3830b,{'userId':_0x291a4f['id']});}const [_0x4d70b4,_0x32a63e]=await this['chatLogEntity'][_0x278174(0x1f6)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0xf3830b}),_0x2b2201=_0x4d70b4[_0x278174(0x202)](_0x27e59f=>_0x27e59f['userId']),_0x435f1e=await this[_0x278174(0x223)][_0x278174(0x20c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2b2201)}}),_0x3bc864=_0x4d70b4[_0x278174(0x202)](_0x297e8c=>{const _0x189dea=_0x278174,_0x4edd96=_0x435f1e[_0x189dea(0x20c)](_0x41880c=>_0x41880c['id']===_0x297e8c['userId']);return{'username':_0x4edd96?_0x4edd96['username']:'','email':_0x4edd96?_0x4edd96['email']:'','prompt':_0x297e8c[_0x189dea(0x20f)],'answer':_0x297e8c[_0x189dea(0x1fe)],'createdAt':(0x0,utils_1['formatDate'])(_0x297e8c['createdAt'])};}),_0x11c9b8=new exceljs_1['default']['Workbook'](),_0x21c57d=_0x11c9b8['addWorksheet'](_0x278174(0x1db));_0x21c57d[_0x278174(0x20d)]=[{'header':_0x278174(0x21b),'key':'username','width':0x14},{'header':_0x278174(0x1cf),'key':'email','width':0x14},{'header':_0x278174(0x204),'key':_0x278174(0x1d9),'width':0x14},{'header':_0x278174(0x1f5),'key':'prompt','width':0x50},{'header':_0x278174(0x20e),'key':'answer','width':0x96}],_0x3bc864['forEach'](_0x157122=>_0x21c57d['addRow'](_0x157122)),_0x270dc5[_0x278174(0x21f)]('Content-Type',_0x278174(0x1c1)),_0x270dc5[_0x278174(0x21f)]('Content-Disposition',_0x278174(0x1c7)+_0x278174(0x216)),await _0x11c9b8[_0x278174(0x21a)][_0x278174(0x1d3)](_0x270dc5),_0x270dc5['end']();}async['querAllChatLog'](_0x3795ec,_0xdb0f68){const _0x5a8740=_0x24a42a,{page:page=0x1,size:size=0x14,userId:_0x5c0ab5,prompt:_0x31eb53}=_0x3795ec,_0x5da950={'type':balance_constant_1[_0x5a8740(0x1f1)][_0x5a8740(0x20a)],'prompt':(0x0,typeorm_2[_0x5a8740(0x1ee)])('')};_0x5c0ab5&&Object['assign'](_0x5da950,{'userId':_0x5c0ab5}),_0x31eb53&&Object[_0x5a8740(0x201)](_0x5da950,{'prompt':(0x0,typeorm_2[_0x5a8740(0x220)])('%'+_0x31eb53+'%')});const [_0x1036ab,_0x5a1a99]=await this[_0x5a8740(0x1f0)]['findAndCount']({'order':{'id':_0x5a8740(0x1ba)},'skip':(page-0x1)*size,'take':size,'where':_0x5da950}),_0xfcee3d=_0x1036ab['map'](_0x1a7dd7=>_0x1a7dd7['userId']),_0x5cb13b=await this['userEntity'][_0x5a8740(0x20c)]({'where':{'id':(0x0,typeorm_2['In'])(_0xfcee3d)},'select':['id',_0x5a8740(0x21e),'email']});return _0x1036ab[_0x5a8740(0x1d6)](_0x3d0bb2=>{const _0xac5dea=_0x5a8740,{username:_0x50c9a1,email:_0x1c4b8a}=_0x5cb13b[_0xac5dea(0x20c)](_0x32a2a1=>_0x32a2a1['id']===_0x3d0bb2[_0xac5dea(0x1d4)])||{};_0x3d0bb2[_0xac5dea(0x21e)]=_0x50c9a1,_0x3d0bb2['email']=_0x1c4b8a;}),_0xdb0f68['user'][_0x5a8740(0x1eb)]!==_0x5a8740(0x228)&&_0x1036ab[_0x5a8740(0x1d6)](_0x1e373e=>_0x1e373e['email']=(0x0,utils_1[_0x5a8740(0x1ca)])(_0x1e373e['email'])),_0x1036ab[_0x5a8740(0x1d6)](_0x553cfb=>{const _0x3e5221=_0x5a8740;!_0x553cfb[_0x3e5221(0x1bf)]&&(_0x553cfb[_0x3e5221(0x1bf)]=(_0x553cfb===null||_0x553cfb===void 0x0?void 0x0:_0x553cfb[_0x3e5221(0x1d4)])+_0x3e5221(0x1f7)),!_0x553cfb[_0x3e5221(0x21e)]&&(_0x553cfb[_0x3e5221(0x21e)]='游客'+(_0x553cfb===null||_0x553cfb===void 0x0?void 0x0:_0x553cfb[_0x3e5221(0x1d4)]));}),{'rows':_0x1036ab,'count':_0x5a1a99};}async[_0x24a42a(0x1bc)](_0x4bd4a7,_0x486c04){const _0xdb1e49=_0x24a42a,{id:_0x827f3b}=_0x4bd4a7['user'],{groupId:_0x55364a}=_0x486c04,_0x5a3af0={'userId':_0x827f3b,'isDelete':![]};_0x55364a&&Object[_0xdb1e49(0x201)](_0x5a3af0,{'groupId':_0x55364a});if(_0x55364a){const _0x324046=await this['chatGroupEntity'][_0xdb1e49(0x1e3)]({'where':{'isDelete':![]}});if(_0x324046===0x0)return[];}const _0x3981fc=await this[_0xdb1e49(0x1f0)][_0xdb1e49(0x20c)]({'where':_0x5a3af0});return _0x3981fc[_0xdb1e49(0x202)](_0x5a2c0b=>{const _0x14ee1e=_0xdb1e49,{prompt:_0x4afe2f,role:_0x183d72,answer:_0x31b57e,createdAt:_0x280759,model:_0x52bb36,conversationOptions:_0x4ef905,requestOptions:_0x1d47be,id:_0x544385,imageUrl:_0x139b1e}=_0x5a2c0b;let _0x3bb66a=null,_0x4c9760=null;try{_0x3bb66a=JSON[_0x14ee1e(0x207)](_0x4ef905),_0x4c9760=JSON['parse'](_0x1d47be);}catch(_0xde637e){}return{'chatId':_0x544385,'dateTime':(0x0,utils_1['formatDate'])(_0x280759),'text':_0x183d72===_0x14ee1e(0x214)?_0x4afe2f:_0x31b57e,'inversion':_0x183d72===_0x14ee1e(0x214),'error':![],'conversationOptions':_0x3bb66a,'requestOptions':_0x4c9760,'imageUrl':_0x139b1e,'model':_0x52bb36};});}async['deleteChatLog'](_0x447cac,_0x31342f){const _0x3d6e87=_0x24a42a,{id:_0x3b65de}=_0x447cac[_0x3d6e87(0x214)],{id:_0x2cb171}=_0x31342f,_0x1db968=await this['chatLogEntity']['findOne']({'where':{'id':_0x2cb171,'userId':_0x3b65de}});if(!_0x1db968)throw new common_1[(_0x3d6e87(0x211))](_0x3d6e87(0x1c3),common_1[_0x3d6e87(0x219)][_0x3d6e87(0x21d)]);const _0x1d6e3f=await this[_0x3d6e87(0x1f0)][_0x3d6e87(0x1c4)]({'id':_0x2cb171},{'isDelete':!![]});if(_0x1d6e3f[_0x3d6e87(0x1da)]>0x0)return _0x3d6e87(0x1e9);else throw new common_1[(_0x3d6e87(0x211))](_0x3d6e87(0x1c3),common_1[_0x3d6e87(0x219)]['BAD_REQUEST']);}async[_0x24a42a(0x1e0)](_0x36f954,_0x4af311){const _0x103cc4=_0x24a42a,{groupId:_0x44e918}=_0x4af311,{id:_0x28da4a}=_0x36f954[_0x103cc4(0x214)],_0x421f0a=await this[_0x103cc4(0x1fa)][_0x103cc4(0x1fd)]({'where':{'id':_0x44e918,'userId':_0x28da4a}});if(!_0x421f0a)throw new common_1[(_0x103cc4(0x211))](_0x103cc4(0x1c3),common_1[_0x103cc4(0x219)][_0x103cc4(0x21d)]);const _0x1a3e24=await this['chatLogEntity'][_0x103cc4(0x1c4)]({'groupId':_0x44e918},{'isDelete':!![]});if(_0x1a3e24[_0x103cc4(0x1da)]>0x0)return _0x103cc4(0x1e9);if(_0x1a3e24[_0x103cc4(0x1da)]===0x0)throw new common_1[(_0x103cc4(0x211))](_0x103cc4(0x1f8),common_1[_0x103cc4(0x219)][_0x103cc4(0x21d)]);}async[_0x24a42a(0x1fb)](_0x14ba6b,_0x5ab89b){const _0x2c2f5f=_0x24a42a,{id:_0x41747f}=_0x14ba6b[_0x2c2f5f(0x214)],{appId:_0x1ad139,page:page=0x1,size:size=0xa}=_0x5ab89b,[_0x36dc9d,_0x46c55f]=await this[_0x2c2f5f(0x1f0)][_0x2c2f5f(0x1f6)]({'where':{'userId':_0x41747f,'appId':_0x1ad139,'role':_0x2c2f5f(0x1ce)},'order':{'id':_0x2c2f5f(0x1ba)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x36dc9d,'count':_0x46c55f};}};ChatLogService=__decorate([(0x0,common_1[_0x24a42a(0x200)])(),__param(0x0,(0x0,typeorm_1[_0x24a42a(0x213)])(chatLog_entity_1[_0x24a42a(0x1e8)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x24a42a(0x1ed)])),__param(0x2,(0x0,typeorm_1[_0x24a42a(0x213)])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x24a42a(0x1f9),[typeorm_2['Repository'],typeorm_2[_0x24a42a(0x218)],typeorm_2['Repository']])],ChatLogService),exports['ChatLogService']=ChatLogService;function _0xc6e6(){const _0x105cfc=['回答答案','prompt','11799304HhOQPC','HttpException','tencent','InjectRepository','user','取消推荐','chat.xlsx','components','Repository','HttpStatus','xlsx','用户名','__metadata','BAD_REQUEST','username','setHeader','Like','function','object','userEntity','cos','./chatLog.entity','isGroup','283336flHgip','super','24711255iRvHhV','fileInfo','331324WmgBYL','querAllDrawLog','DESC','getOwnPropertyDescriptor','chatList','typeorm','type','email','DALL-E2','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','model','你删除的对话记录不存在、请检查！','update','group','save','attachment;\x20filename=','../../common/constants/balance.constant','rec','maskEmail','../chatGroup/chatGroup.entity','exceljs','message_id','assistant','用户邮箱','1911224bVrtYD','metadata','../../common/utils','write','userId','exportExcel','forEach','recDrawImg','querAllDrawLog\x20Json\x20parse\x20error','createdAt','affected','chatlog','thumbImg','includes','decorate','/q/55','delByGroupId','9649938JPhnEM','defineProperty','count','?x-oss-process=image/resize,w_','@nestjs/common','dall-e-3','querDrawLog','ChatLogEntity','删除对话记录成功！','../user/user.entity','role','__decorate','UserEntity','Not','ali','chatLogEntity','DeductionKey','?imageView2/1/w/','extend','5RDKLJI','提问问题','findAndCount','@nine.com','当前页面已经没有东西可以删除了！','design:paramtypes','chatGroupEntity','byAppId','你推荐的图片不存在、请检查！','findOne','answer','24spxovY','Injectable','assign','map','你操作的图片不存在、请检查！','提问时间','777016yvYiyJ','length','parse','ChatLogService','PAINT_TYPE','CHAT_TYPE','@nestjs/typeorm','find','columns'];_0xc6e6=function(){return _0x105cfc;};return _0xc6e6();}