'use strict';const _0x46868e=_0x16a3;(function(_0x245acd,_0x978947){const _0x742062=_0x16a3,_0x5ef701=_0x245acd();while(!![]){try{const _0x38c721=-parseInt(_0x742062(0x108))/0x1*(-parseInt(_0x742062(0x111))/0x2)+-parseInt(_0x742062(0xc9))/0x3+parseInt(_0x742062(0xc8))/0x4+parseInt(_0x742062(0xe6))/0x5+-parseInt(_0x742062(0x134))/0x6*(parseInt(_0x742062(0xcf))/0x7)+-parseInt(_0x742062(0xd0))/0x8*(-parseInt(_0x742062(0xd5))/0x9)+parseInt(_0x742062(0x124))/0xa;if(_0x38c721===_0x978947)break;else _0x5ef701['push'](_0x5ef701['shift']());}catch(_0x415278){_0x5ef701['push'](_0x5ef701['shift']());}}}(_0x3b7f,0xe9774));function _0x16a3(_0x55c584,_0x318186){const _0x3b7fe6=_0x3b7f();return _0x16a3=function(_0x16a30c,_0x2c9933){_0x16a30c=_0x16a30c-0xc6;let _0x99d643=_0x3b7fe6[_0x16a30c];return _0x99d643;},_0x16a3(_0x55c584,_0x318186);}function _0x3b7f(){const _0x5e44a7=['xlsx','DeductionKey','1727747iLTYfr','137032aAaGiW','./chatLog.entity','thumbImg','__decorate','HttpStatus','837tfqwqW','log','../../common/utils','prompt','querAllDrawLog\x20Json\x20parse\x20error','type','dall-e-3','end','extend','当前页面已经没有东西可以删除了！','byAppId','group','?imageView2/1/w/','delByGroupId','cos','ali','userId','1546475nBqrfV','BAD_REQUEST','exceljs','assign','design:paramtypes','ChatLogEntity','@nine.com','@nestjs/typeorm','length','图片成功！','你推荐的图片不存在、请检查！','model','role','answer','chat.xlsx','maskEmail','forEach','Repository','count','?x-oss-process=image/resize,w_','chatlog','update','../chatGroup/chatGroup.entity','recDrawImg','ChatGroupEntity','取消推荐','InjectRepository','saveChatLog','map','parse','DESC','components','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','isGroup','2989StlJGf','rec','object','回答答案','Like','HttpException','email','user','function','130lWOOHD','columns','tencent','__param','save','PAINT_TYPE','DALL-E2','userEntity','CHAT_TYPE','exportExcel','find','chatLogEntity','querAllDrawLog','deleteChatLog','formatDate','Content-Type','chatGroupEntity','fileInfo','setHeader','1631600AaXbsR','提问时间','Workbook','findAndCount','defineProperty','decorate','/q/55','用户名','write','提问问题','__esModule','metadata','username','attachment;\x20filename=','你操作的图片不存在、请检查！','addWorksheet','36MZEPga','../user/user.entity','message_id','ChatLogService','paintCount','Not','你删除的对话记录不存在、请检查！','6084756QcyVee','4031172ziSLuy','includes','findOne','affected'];_0x3b7f=function(){return _0x5e44a7;};return _0x3b7f();}var __decorate=this&&this[_0x46868e(0xd3)]||function(_0x276005,_0x32882a,_0x5c2345,_0x9c56e0){const _0x5dd7c6=_0x46868e;var _0x18d194=arguments[_0x5dd7c6(0xee)],_0xe5d36=_0x18d194<0x3?_0x32882a:_0x9c56e0===null?_0x9c56e0=Object['getOwnPropertyDescriptor'](_0x32882a,_0x5c2345):_0x9c56e0,_0x5120b0;if(typeof Reflect===_0x5dd7c6(0x10a)&&typeof Reflect[_0x5dd7c6(0x129)]===_0x5dd7c6(0x110))_0xe5d36=Reflect[_0x5dd7c6(0x129)](_0x276005,_0x32882a,_0x5c2345,_0x9c56e0);else{for(var _0x3dea8b=_0x276005[_0x5dd7c6(0xee)]-0x1;_0x3dea8b>=0x0;_0x3dea8b--)if(_0x5120b0=_0x276005[_0x3dea8b])_0xe5d36=(_0x18d194<0x3?_0x5120b0(_0xe5d36):_0x18d194>0x3?_0x5120b0(_0x32882a,_0x5c2345,_0xe5d36):_0x5120b0(_0x32882a,_0x5c2345))||_0xe5d36;}return _0x18d194>0x3&&_0xe5d36&&Object[_0x5dd7c6(0x128)](_0x32882a,_0x5c2345,_0xe5d36),_0xe5d36;},__metadata=this&&this['__metadata']||function(_0x3d1e80,_0xd2c18){const _0x2fd39f=_0x46868e;if(typeof Reflect==='object'&&typeof Reflect[_0x2fd39f(0x12f)]==='function')return Reflect[_0x2fd39f(0x12f)](_0x3d1e80,_0xd2c18);},__param=this&&this[_0x46868e(0x114)]||function(_0x5be369,_0x10696f){return function(_0x32c3ec,_0x44e357){_0x10696f(_0x32c3ec,_0x44e357,_0x5be369);};};Object[_0x46868e(0x128)](exports,_0x46868e(0x12e),{'value':!![]}),exports[_0x46868e(0x137)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x46868e(0xed)),chatLog_entity_1=require(_0x46868e(0xd1)),typeorm_2=require('typeorm'),balance_constant_1=require('../../common/constants/balance.constant'),user_entity_1=require(_0x46868e(0x135)),utils_1=require(_0x46868e(0xd7)),exceljs_1=require(_0x46868e(0xe8)),chatGroup_entity_1=require(_0x46868e(0xfc));let ChatLogService=class ChatLogService{constructor(_0x16d9a0,_0x24324d,_0x13a8d2){const _0x32f28b=_0x46868e;this[_0x32f28b(0x11c)]=_0x16d9a0,this['userEntity']=_0x24324d,this[_0x32f28b(0x121)]=_0x13a8d2;}async[_0x46868e(0x101)](_0x4c43c1){const _0x1e09f4=_0x46868e;return await this['chatLogEntity'][_0x1e09f4(0x115)](_0x4c43c1);}async['querDrawLog'](_0x3f6736,_0x122b17){const _0x479f42=_0x46868e,{id:_0x1e342c}=_0x3f6736[_0x479f42(0x10f)],{model:_0x52529a}=_0x122b17,_0x5f4bdc={'userId':_0x1e342c,'type':balance_constant_1[_0x479f42(0xce)][_0x479f42(0x116)]};_0x52529a&&(_0x5f4bdc[_0x479f42(0xf1)]=_0x52529a,_0x52529a===_0x479f42(0x117)&&(_0x5f4bdc[_0x479f42(0xf1)]=(0x0,typeorm_2['In'])([_0x479f42(0x117),_0x479f42(0xdb)])));const _0x552f40=await this['chatLogEntity'][_0x479f42(0x11b)]({'where':_0x5f4bdc,'order':{'id':'DESC'},'select':['id',_0x479f42(0xf3),_0x479f42(0xd8),_0x479f42(0x136),_0x479f42(0xe0),_0x479f42(0xf1),_0x479f42(0xdd),_0x479f42(0xda),_0x479f42(0x122)]});return _0x552f40[_0x479f42(0xf6)](_0x43b475=>{const _0x5767c9=_0x479f42;if(_0x43b475['type']===_0x5767c9(0x138)){const _0x30ce1c=_0x43b475[_0x5767c9(0xf1)]==='mj'?0x136:0xa0,_0xd2e294=_0x43b475[_0x5767c9(0xf3)]['includes']('cos')?_0x5767c9(0x113):_0x5767c9(0xe4),_0x324c14=_0xd2e294===_0x5767c9(0x113)?'?imageView2/1/w/'+_0x30ce1c+'/q/55':_0x5767c9(0xf9)+_0x30ce1c;_0x43b475['thumbImg']=_0x43b475[_0x5767c9(0xf3)]+_0x324c14;try{_0x43b475[_0x5767c9(0x122)]=_0x43b475[_0x5767c9(0x122)]?JSON[_0x5767c9(0x103)](_0x43b475[_0x5767c9(0x122)]):null;}catch(_0x1ed62f){_0x43b475[_0x5767c9(0x122)]={};}}}),_0x552f40;}async[_0x46868e(0x11d)](_0x36fee2){const _0x447271=_0x46868e,{page:page=0x1,size:size=0x14,rec:_0x29af08,userId:_0x45c9dd,model:_0x554d6e}=_0x36fee2,_0x21a2a2={'type':balance_constant_1[_0x447271(0xce)][_0x447271(0x116)],'prompt':(0x0,typeorm_2[_0x447271(0xc6)])(''),'answer':(0x0,typeorm_2[_0x447271(0xc6)])('')};_0x29af08&&Object[_0x447271(0xe9)](_0x21a2a2,{'rec':_0x29af08}),_0x45c9dd&&Object['assign'](_0x21a2a2,{'userId':_0x45c9dd});_0x554d6e&&(_0x21a2a2[_0x447271(0xf1)]=_0x554d6e,_0x554d6e==='DALL-E2'&&(_0x21a2a2[_0x447271(0xf1)]=(0x0,typeorm_2['In'])([_0x447271(0x117),_0x447271(0xdb)])));const [_0x170557,_0x412b3f]=await this[_0x447271(0x11c)][_0x447271(0x127)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x21a2a2});return _0x170557[_0x447271(0xf6)](_0x296d9b=>{const _0x5be083=_0x447271;var _0x171503;if(_0x296d9b[_0x5be083(0xda)]===_0x5be083(0x138)){const _0x8c6c95=_0x296d9b['model']==='mj'?0x136:0xa0,_0x63af7c=_0x296d9b['answer'][_0x5be083(0xca)](_0x5be083(0xe3))?_0x5be083(0x113):_0x5be083(0xe4),_0x3e844e=_0x63af7c===_0x5be083(0x113)?_0x5be083(0xe1)+_0x8c6c95+_0x5be083(0x12a):_0x5be083(0xf9)+_0x8c6c95;_0x296d9b[_0x5be083(0xd2)]=_0x296d9b[_0x5be083(0xf3)]+_0x3e844e;try{const _0x540457=_0x296d9b[_0x5be083(0xdd)]?JSON[_0x5be083(0x103)](_0x296d9b[_0x5be083(0xdd)]):null;_0x540457&&(_0x540457?_0x296d9b[_0x5be083(0x107)]=((_0x171503=_0x540457===null||_0x540457===void 0x0?void 0x0:_0x540457['components'][0x0])===null||_0x171503===void 0x0?void 0x0:_0x171503[_0x5be083(0x105)]['length'])===0x5:_0x296d9b[_0x5be083(0x107)]=![]);}catch(_0x3ba831){console[_0x5be083(0xd6)](_0x5be083(0xd9),_0x3ba831);}}}),{'rows':_0x170557,'count':_0x412b3f};}async[_0x46868e(0xfd)](_0x23f6c1){const _0x10db9e=_0x46868e,{id:_0x5a16df}=_0x23f6c1,_0x314e09=await this[_0x10db9e(0x11c)][_0x10db9e(0xcb)]({'where':{'id':_0x5a16df,'type':balance_constant_1['DeductionKey'][_0x10db9e(0x116)]}});if(!_0x314e09)throw new common_1[(_0x10db9e(0x10d))](_0x10db9e(0xf0),common_1[_0x10db9e(0xd4)][_0x10db9e(0xe7)]);const _0x300de4=_0x314e09[_0x10db9e(0x109)]===0x1?0x0:0x1,_0x38c5aa=await this[_0x10db9e(0x11c)]['update']({'id':_0x5a16df},{'rec':_0x300de4});if(_0x38c5aa[_0x10db9e(0xcc)]>0x0)return(_0x300de4?'推荐':_0x10db9e(0xff))+_0x10db9e(0xef);throw new common_1['HttpException'](_0x10db9e(0x132),common_1['HttpStatus'][_0x10db9e(0xe7)]);}async[_0x46868e(0x11a)](_0x10b738,_0x32ec41){const _0x272e97=_0x46868e,_0x2a03fa={'type':balance_constant_1[_0x272e97(0xce)]['CHAT_TYPE']},{page:page=0x1,size:size=0x1e,prompt:_0x247309,email:_0x53d07d}=_0x10b738;_0x247309&&Object['assign'](_0x2a03fa,{'prompt':(0x0,typeorm_2[_0x272e97(0x10c)])('%'+_0x247309+'%')});if(_0x53d07d){const _0x2654b8=await this[_0x272e97(0x118)]['findOne']({'where':{'email':_0x53d07d}});(_0x2654b8===null||_0x2654b8===void 0x0?void 0x0:_0x2654b8['id'])&&Object['assign'](_0x2a03fa,{'userId':_0x2654b8['id']});}const [_0x1b9111,_0xb18ea0]=await this['chatLogEntity'][_0x272e97(0x127)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x2a03fa}),_0x293496=_0x1b9111[_0x272e97(0x102)](_0x103c55=>_0x103c55[_0x272e97(0xe5)]),_0x1715bc=await this[_0x272e97(0x118)][_0x272e97(0x11b)]({'where':{'id':(0x0,typeorm_2['In'])(_0x293496)}}),_0x3ff816=_0x1b9111['map'](_0x40c9ac=>{const _0x4954c2=_0x272e97,_0x172e33=_0x1715bc['find'](_0x3c5edf=>_0x3c5edf['id']===_0x40c9ac[_0x4954c2(0xe5)]);return{'username':_0x172e33?_0x172e33[_0x4954c2(0x130)]:'','email':_0x172e33?_0x172e33[_0x4954c2(0x10e)]:'','prompt':_0x40c9ac[_0x4954c2(0xd8)],'answer':_0x40c9ac[_0x4954c2(0xf3)],'createdAt':(0x0,utils_1[_0x4954c2(0x11f)])(_0x40c9ac['createdAt'])};}),_0x1043d1=new exceljs_1['default'][(_0x272e97(0x126))](),_0x1bfa40=_0x1043d1[_0x272e97(0x133)](_0x272e97(0xfa));_0x1bfa40[_0x272e97(0x112)]=[{'header':_0x272e97(0x12b),'key':'username','width':0x14},{'header':'用户邮箱','key':_0x272e97(0x10e),'width':0x14},{'header':_0x272e97(0x125),'key':'createdAt','width':0x14},{'header':_0x272e97(0x12d),'key':_0x272e97(0xd8),'width':0x50},{'header':_0x272e97(0x10b),'key':_0x272e97(0xf3),'width':0x96}],_0x3ff816['forEach'](_0x480ae2=>_0x1bfa40['addRow'](_0x480ae2)),_0x32ec41[_0x272e97(0x123)](_0x272e97(0x120),_0x272e97(0x106)),_0x32ec41['setHeader']('Content-Disposition',_0x272e97(0x131)+_0x272e97(0xf4)),await _0x1043d1[_0x272e97(0xcd)][_0x272e97(0x12c)](_0x32ec41),_0x32ec41[_0x272e97(0xdc)]();}async['querAllChatLog'](_0x1d6cb9,_0xbcd7cf){const _0x3a1364=_0x46868e,{page:page=0x1,size:size=0x14,userId:_0x1ec0d7,prompt:_0x584996}=_0x1d6cb9,_0x30d4e1={'type':balance_constant_1['DeductionKey'][_0x3a1364(0x119)],'prompt':(0x0,typeorm_2[_0x3a1364(0xc6)])('')};_0x1ec0d7&&Object['assign'](_0x30d4e1,{'userId':_0x1ec0d7}),_0x584996&&Object[_0x3a1364(0xe9)](_0x30d4e1,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x584996+'%')});const [_0x21975c,_0x2a77fc]=await this['chatLogEntity'][_0x3a1364(0x127)]({'order':{'id':_0x3a1364(0x104)},'skip':(page-0x1)*size,'take':size,'where':_0x30d4e1}),_0x360517=_0x21975c['map'](_0x39edec=>_0x39edec[_0x3a1364(0xe5)]),_0x38efef=await this[_0x3a1364(0x118)][_0x3a1364(0x11b)]({'where':{'id':(0x0,typeorm_2['In'])(_0x360517)},'select':['id','username',_0x3a1364(0x10e)]});return _0x21975c['forEach'](_0x27515c=>{const _0x4770ef=_0x3a1364,{username:_0x4a76cd,email:_0x44fca6}=_0x38efef['find'](_0xfd6503=>_0xfd6503['id']===_0x27515c[_0x4770ef(0xe5)])||{};_0x27515c[_0x4770ef(0x130)]=_0x4a76cd,_0x27515c[_0x4770ef(0x10e)]=_0x44fca6;}),_0xbcd7cf['user'][_0x3a1364(0xf2)]!=='super'&&_0x21975c[_0x3a1364(0xf6)](_0x390369=>_0x390369[_0x3a1364(0x10e)]=(0x0,utils_1[_0x3a1364(0xf5)])(_0x390369[_0x3a1364(0x10e)])),_0x21975c[_0x3a1364(0xf6)](_0xb6de=>{const _0x5b6ee2=_0x3a1364;!_0xb6de['email']&&(_0xb6de['email']=(_0xb6de===null||_0xb6de===void 0x0?void 0x0:_0xb6de[_0x5b6ee2(0xe5)])+_0x5b6ee2(0xec)),!_0xb6de[_0x5b6ee2(0x130)]&&(_0xb6de[_0x5b6ee2(0x130)]='游客'+(_0xb6de===null||_0xb6de===void 0x0?void 0x0:_0xb6de[_0x5b6ee2(0xe5)]));}),{'rows':_0x21975c,'count':_0x2a77fc};}async['chatList'](_0xccea10,_0x54455e){const _0x12a29f=_0x46868e,{id:_0x205471}=_0xccea10[_0x12a29f(0x10f)],{groupId:_0x553fd7}=_0x54455e,_0x4b1782={'userId':_0x205471,'isDelete':![]};_0x553fd7&&Object[_0x12a29f(0xe9)](_0x4b1782,{'groupId':_0x553fd7});if(_0x553fd7){const _0x48c7a1=await this[_0x12a29f(0x121)][_0x12a29f(0xf8)]({'where':{'isDelete':![]}});if(_0x48c7a1===0x0)return[];}const _0xda8556=await this[_0x12a29f(0x11c)][_0x12a29f(0x11b)]({'where':_0x4b1782});return _0xda8556['map'](_0xcd1a07=>{const _0x3654e4=_0x12a29f,{prompt:_0x2f71d5,role:_0x42a047,answer:_0x2e6994,createdAt:_0x31c942,model:_0x32bc7f,conversationOptions:_0x396a69,requestOptions:_0x5f2972,id:_0xe554f2,imageUrl:_0x55eb2b}=_0xcd1a07;let _0x52cabf=null,_0x2232f7=null;try{_0x52cabf=JSON['parse'](_0x396a69),_0x2232f7=JSON[_0x3654e4(0x103)](_0x5f2972);}catch(_0x52f3aa){}return{'chatId':_0xe554f2,'dateTime':(0x0,utils_1['formatDate'])(_0x31c942),'text':_0x42a047===_0x3654e4(0x10f)?_0x2f71d5:_0x2e6994,'inversion':_0x42a047===_0x3654e4(0x10f),'error':![],'conversationOptions':_0x52cabf,'requestOptions':_0x2232f7,'imageUrl':_0x55eb2b,'model':_0x32bc7f};});}async[_0x46868e(0x11e)](_0x4f82c1,_0x5d0fee){const _0x19979d=_0x46868e,{id:_0x48c9a1}=_0x4f82c1[_0x19979d(0x10f)],{id:_0x3fec99}=_0x5d0fee,_0x4dd3b9=await this[_0x19979d(0x11c)]['findOne']({'where':{'id':_0x3fec99,'userId':_0x48c9a1}});if(!_0x4dd3b9)throw new common_1[(_0x19979d(0x10d))]('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x19979d(0xe7)]);const _0xc0361c=await this[_0x19979d(0x11c)][_0x19979d(0xfb)]({'id':_0x3fec99},{'isDelete':!![]});if(_0xc0361c['affected']>0x0)return'删除对话记录成功！';else throw new common_1[(_0x19979d(0x10d))](_0x19979d(0xc7),common_1[_0x19979d(0xd4)]['BAD_REQUEST']);}async[_0x46868e(0xe2)](_0x57dff8,_0x18ea40){const _0x574e4e=_0x46868e,{groupId:_0x4919b4}=_0x18ea40,{id:_0xeb82d6}=_0x57dff8['user'],_0x3a3f2b=await this[_0x574e4e(0x121)][_0x574e4e(0xcb)]({'where':{'id':_0x4919b4,'userId':_0xeb82d6}});if(!_0x3a3f2b)throw new common_1[(_0x574e4e(0x10d))](_0x574e4e(0xc7),common_1[_0x574e4e(0xd4)][_0x574e4e(0xe7)]);const _0xe54ed=await this[_0x574e4e(0x11c)][_0x574e4e(0xfb)]({'groupId':_0x4919b4},{'isDelete':!![]});if(_0xe54ed[_0x574e4e(0xcc)]>0x0)return'删除对话记录成功！';if(_0xe54ed[_0x574e4e(0xcc)]===0x0)throw new common_1['HttpException'](_0x574e4e(0xde),common_1[_0x574e4e(0xd4)]['BAD_REQUEST']);}async[_0x46868e(0xdf)](_0x12963b,_0x35a5a1){const _0x4e45f1=_0x46868e,{id:_0x339404}=_0x12963b[_0x4e45f1(0x10f)],{appId:_0x58fd1f,page:page=0x1,size:size=0xa}=_0x35a5a1,[_0x51555f,_0x5370a6]=await this[_0x4e45f1(0x11c)][_0x4e45f1(0x127)]({'where':{'userId':_0x339404,'appId':_0x58fd1f,'role':'assistant'},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x51555f,'count':_0x5370a6};}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x46868e(0x100)])(chatLog_entity_1[_0x46868e(0xeb)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x46868e(0x100)])(chatGroup_entity_1[_0x46868e(0xfe)])),__metadata(_0x46868e(0xea),[typeorm_2[_0x46868e(0xf7)],typeorm_2['Repository'],typeorm_2[_0x46868e(0xf7)]])],ChatLogService),exports[_0x46868e(0x137)]=ChatLogService;