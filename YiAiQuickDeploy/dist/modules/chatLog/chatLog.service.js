'use strict';const _0x3020a0=_0x4dca;(function(_0x57d249,_0x28cf53){const _0x31964d=_0x4dca,_0x1b8514=_0x57d249();while(!![]){try{const _0x1853c5=parseInt(_0x31964d(0x10f))/0x1+-parseInt(_0x31964d(0xa5))/0x2+-parseInt(_0x31964d(0xf0))/0x3+-parseInt(_0x31964d(0xfa))/0x4+-parseInt(_0x31964d(0xfd))/0x5*(-parseInt(_0x31964d(0x100))/0x6)+parseInt(_0x31964d(0x110))/0x7+parseInt(_0x31964d(0x107))/0x8;if(_0x1853c5===_0x28cf53)break;else _0x1b8514['push'](_0x1b8514['shift']());}catch(_0x2bd74c){_0x1b8514['push'](_0x1b8514['shift']());}}}(_0x4a34,0x7f5e0));var __decorate=this&&this[_0x3020a0(0xac)]||function(_0x3c45a2,_0x49c4ff,_0x429067,_0xa10ed2){const _0x5bbb29=_0x3020a0;var _0x484d9c=arguments['length'],_0x2483a4=_0x484d9c<0x3?_0x49c4ff:_0xa10ed2===null?_0xa10ed2=Object['getOwnPropertyDescriptor'](_0x49c4ff,_0x429067):_0xa10ed2,_0xf284c2;if(typeof Reflect===_0x5bbb29(0xbc)&&typeof Reflect[_0x5bbb29(0xc8)]==='function')_0x2483a4=Reflect[_0x5bbb29(0xc8)](_0x3c45a2,_0x49c4ff,_0x429067,_0xa10ed2);else{for(var _0x42db15=_0x3c45a2[_0x5bbb29(0xe9)]-0x1;_0x42db15>=0x0;_0x42db15--)if(_0xf284c2=_0x3c45a2[_0x42db15])_0x2483a4=(_0x484d9c<0x3?_0xf284c2(_0x2483a4):_0x484d9c>0x3?_0xf284c2(_0x49c4ff,_0x429067,_0x2483a4):_0xf284c2(_0x49c4ff,_0x429067))||_0x2483a4;}return _0x484d9c>0x3&&_0x2483a4&&Object[_0x5bbb29(0xb7)](_0x49c4ff,_0x429067,_0x2483a4),_0x2483a4;},__metadata=this&&this[_0x3020a0(0xf7)]||function(_0x41cdbe,_0xd391f3){const _0x4b135c=_0x3020a0;if(typeof Reflect===_0x4b135c(0xbc)&&typeof Reflect[_0x4b135c(0x106)]===_0x4b135c(0xef))return Reflect[_0x4b135c(0x106)](_0x41cdbe,_0xd391f3);},__param=this&&this['__param']||function(_0x30f62f,_0x34a652){return function(_0x234c84,_0x277b6d){_0x34a652(_0x234c84,_0x277b6d,_0x30f62f);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x3020a0(0xd9)]=void 0x0;const common_1=require(_0x3020a0(0xb4)),typeorm_1=require(_0x3020a0(0xab)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require(_0x3020a0(0xb3)),balance_constant_1=require(_0x3020a0(0xc5)),user_entity_1=require(_0x3020a0(0x111)),utils_1=require('../../common/utils'),exceljs_1=require(_0x3020a0(0xd3)),chatGroup_entity_1=require(_0x3020a0(0xf6));function _0x4a34(){const _0x372b15=['@nestjs/typeorm','__decorate','chatList','querAllDrawLog\x20Json\x20parse\x20error','Content-Type','addWorksheet','InjectRepository','Not','typeorm','@nestjs/common','saveChatLog','write','defineProperty','@nine.com','chatlog','group','ali','object','Repository','用户邮箱','isGroup','Injectable','super','findAndCount','extend','findOne','../../common/constants/balance.constant','assistant','createdAt','decorate','parse','querDrawLog','user','回答答案','DALL-E2','end','forEach','type','Like','/q/55','exceljs','userId','你删除的对话记录不存在、请检查！','thumbImg','prompt','model','ChatLogService','HttpException','Content-Disposition','username','exportExcel','update','deleteChatLog','find','?imageView2/1/w/','maskEmail','affected','UserEntity','dall-e-3','setHeader','HttpStatus','图片成功！','length','paintCount','delByGroupId','PAINT_TYPE','components','chatGroupEntity','function','821175nWfeHJ','design:paramtypes','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','提问问题','chatLogEntity','?x-oss-process=image/resize,w_','../chatGroup/chatGroup.entity','__metadata','assign','用户名','3149292hoBzPf','includes','DeductionKey','10kqOHzp','userEntity','save','21786NPxMjw','cos','tencent','role','ChatLogEntity','attachment;\x20filename=','metadata','7495144psohmM','answer','当前页面已经没有东西可以删除了！','message_id','rec','email','DESC','CHAT_TYPE','779978vtMJfV','5915658BwqQzg','../user/user.entity','querAllChatLog','formatDate','BAD_REQUEST','map','1972966ISjTBu','default','取消推荐','fileInfo','删除对话记录成功！','addRow'];_0x4a34=function(){return _0x372b15;};return _0x4a34();}let ChatLogService=class ChatLogService{constructor(_0x3ef032,_0x25b855,_0x5217a9){const _0x177599=_0x3020a0;this[_0x177599(0xf4)]=_0x3ef032,this[_0x177599(0xfe)]=_0x25b855,this['chatGroupEntity']=_0x5217a9;}async[_0x3020a0(0xb5)](_0xe371f5){const _0x25b822=_0x3020a0;return await this['chatLogEntity'][_0x25b822(0xff)](_0xe371f5);}async[_0x3020a0(0xca)](_0x4c56ab,_0x2e8eb7){const _0x2d107c=_0x3020a0,{id:_0x177114}=_0x4c56ab['user'],{model:_0x21d9c5}=_0x2e8eb7,_0x171335={'userId':_0x177114,'type':balance_constant_1[_0x2d107c(0xfc)][_0x2d107c(0xec)]};_0x21d9c5&&(_0x171335[_0x2d107c(0xd8)]=_0x21d9c5,_0x21d9c5===_0x2d107c(0xcd)&&(_0x171335[_0x2d107c(0xd8)]=(0x0,typeorm_2['In'])([_0x2d107c(0xcd),_0x2d107c(0xe5)])));const _0x137a34=await this['chatLogEntity'][_0x2d107c(0xe0)]({'where':_0x171335,'order':{'id':_0x2d107c(0x10d)},'select':['id','answer','prompt',_0x2d107c(0x10a),_0x2d107c(0xba),_0x2d107c(0xd8),_0x2d107c(0xc3),_0x2d107c(0xd0),_0x2d107c(0xa8)]});return _0x137a34['forEach'](_0x459349=>{const _0x2712f0=_0x2d107c;if(_0x459349['type']==='paintCount'){const _0x14582b=_0x459349[_0x2712f0(0xd8)]==='mj'?0x136:0xa0,_0x28e327=_0x459349[_0x2712f0(0x108)][_0x2712f0(0xfb)](_0x2712f0(0x101))?_0x2712f0(0x102):'ali',_0x13b175=_0x28e327==='tencent'?_0x2712f0(0xe1)+_0x14582b+_0x2712f0(0xd2):_0x2712f0(0xf5)+_0x14582b;_0x459349[_0x2712f0(0xd6)]=_0x459349['answer']+_0x13b175;try{_0x459349[_0x2712f0(0xa8)]=_0x459349[_0x2712f0(0xa8)]?JSON[_0x2712f0(0xc9)](_0x459349['fileInfo']):null;}catch(_0x1fdf5d){_0x459349['fileInfo']={};}}}),_0x137a34;}async['querAllDrawLog'](_0x36abec){const _0x7bd546=_0x3020a0,{page:page=0x1,size:size=0x14,rec:_0x4f1907,userId:_0x2c302b,model:_0x8306d1}=_0x36abec,_0x1edb73={'type':balance_constant_1['DeductionKey'][_0x7bd546(0xec)],'prompt':(0x0,typeorm_2[_0x7bd546(0xb2)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x4f1907&&Object[_0x7bd546(0xf8)](_0x1edb73,{'rec':_0x4f1907}),_0x2c302b&&Object[_0x7bd546(0xf8)](_0x1edb73,{'userId':_0x2c302b});_0x8306d1&&(_0x1edb73[_0x7bd546(0xd8)]=_0x8306d1,_0x8306d1===_0x7bd546(0xcd)&&(_0x1edb73[_0x7bd546(0xd8)]=(0x0,typeorm_2['In'])([_0x7bd546(0xcd),_0x7bd546(0xe5)])));const [_0x705926,_0x40aa84]=await this[_0x7bd546(0xf4)][_0x7bd546(0xc2)]({'order':{'id':_0x7bd546(0x10d)},'skip':(page-0x1)*size,'take':size,'where':_0x1edb73});return _0x705926[_0x7bd546(0xcf)](_0x3b6c1a=>{const _0x4c9d63=_0x7bd546;var _0x327669;if(_0x3b6c1a['type']===_0x4c9d63(0xea)){const _0x4b2e27=_0x3b6c1a['model']==='mj'?0x136:0xa0,_0xb6fb88=_0x3b6c1a[_0x4c9d63(0x108)]['includes']('cos')?_0x4c9d63(0x102):_0x4c9d63(0xbb),_0x2498e8=_0xb6fb88===_0x4c9d63(0x102)?_0x4c9d63(0xe1)+_0x4b2e27+_0x4c9d63(0xd2):_0x4c9d63(0xf5)+_0x4b2e27;_0x3b6c1a[_0x4c9d63(0xd6)]=_0x3b6c1a[_0x4c9d63(0x108)]+_0x2498e8;try{const _0x2f1e8d=_0x3b6c1a['extend']?JSON[_0x4c9d63(0xc9)](_0x3b6c1a['extend']):null;_0x2f1e8d&&(_0x2f1e8d?_0x3b6c1a[_0x4c9d63(0xbf)]=((_0x327669=_0x2f1e8d===null||_0x2f1e8d===void 0x0?void 0x0:_0x2f1e8d[_0x4c9d63(0xed)][0x0])===null||_0x327669===void 0x0?void 0x0:_0x327669['components']['length'])===0x5:_0x3b6c1a[_0x4c9d63(0xbf)]=![]);}catch(_0x34665c){console['log'](_0x4c9d63(0xae),_0x34665c);}}}),{'rows':_0x705926,'count':_0x40aa84};}async['recDrawImg'](_0x8aad5a){const _0x30023f=_0x3020a0,{id:_0x1256b2}=_0x8aad5a,_0xc748b1=await this['chatLogEntity'][_0x30023f(0xc4)]({'where':{'id':_0x1256b2,'type':balance_constant_1[_0x30023f(0xfc)]['PAINT_TYPE']}});if(!_0xc748b1)throw new common_1[(_0x30023f(0xda))]('你推荐的图片不存在、请检查！',common_1[_0x30023f(0xe7)][_0x30023f(0xa3)]);const _0x3c7d12=_0xc748b1[_0x30023f(0x10b)]===0x1?0x0:0x1,_0x5b38fd=await this[_0x30023f(0xf4)][_0x30023f(0xde)]({'id':_0x1256b2},{'rec':_0x3c7d12});if(_0x5b38fd[_0x30023f(0xe3)]>0x0)return(_0x3c7d12?'推荐':_0x30023f(0xa7))+_0x30023f(0xe8);throw new common_1[(_0x30023f(0xda))]('你操作的图片不存在、请检查！',common_1[_0x30023f(0xe7)]['BAD_REQUEST']);}async[_0x3020a0(0xdd)](_0x49e758,_0x497913){const _0x117c63=_0x3020a0,_0x43d517={'type':balance_constant_1[_0x117c63(0xfc)][_0x117c63(0x10e)]},{page:page=0x1,size:size=0x1e,prompt:_0x5e0d89,email:_0x1f5e30}=_0x49e758;_0x5e0d89&&Object[_0x117c63(0xf8)](_0x43d517,{'prompt':(0x0,typeorm_2[_0x117c63(0xd1)])('%'+_0x5e0d89+'%')});if(_0x1f5e30){const _0x5539c0=await this['userEntity'][_0x117c63(0xc4)]({'where':{'email':_0x1f5e30}});(_0x5539c0===null||_0x5539c0===void 0x0?void 0x0:_0x5539c0['id'])&&Object[_0x117c63(0xf8)](_0x43d517,{'userId':_0x5539c0['id']});}const [_0x4b5ef0,_0x3894e2]=await this[_0x117c63(0xf4)][_0x117c63(0xc2)]({'order':{'id':_0x117c63(0x10d)},'skip':(page-0x1)*size,'take':size,'where':_0x43d517}),_0x2d1a65=_0x4b5ef0['map'](_0x583a55=>_0x583a55[_0x117c63(0xd4)]),_0x1c8a9f=await this[_0x117c63(0xfe)][_0x117c63(0xe0)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2d1a65)}}),_0x32a32b=_0x4b5ef0[_0x117c63(0xa4)](_0x1efe6b=>{const _0x5d11a8=_0x117c63,_0x4f2dcc=_0x1c8a9f[_0x5d11a8(0xe0)](_0x39aadb=>_0x39aadb['id']===_0x1efe6b[_0x5d11a8(0xd4)]);return{'username':_0x4f2dcc?_0x4f2dcc[_0x5d11a8(0xdc)]:'','email':_0x4f2dcc?_0x4f2dcc[_0x5d11a8(0x10c)]:'','prompt':_0x1efe6b['prompt'],'answer':_0x1efe6b[_0x5d11a8(0x108)],'createdAt':(0x0,utils_1[_0x5d11a8(0xa2)])(_0x1efe6b['createdAt'])};}),_0x194c34=new exceljs_1[(_0x117c63(0xa6))]['Workbook'](),_0x5caf2d=_0x194c34[_0x117c63(0xb0)](_0x117c63(0xb9));_0x5caf2d['columns']=[{'header':_0x117c63(0xf9),'key':_0x117c63(0xdc),'width':0x14},{'header':_0x117c63(0xbe),'key':_0x117c63(0x10c),'width':0x14},{'header':'提问时间','key':_0x117c63(0xc7),'width':0x14},{'header':_0x117c63(0xf3),'key':_0x117c63(0xd7),'width':0x50},{'header':_0x117c63(0xcc),'key':'answer','width':0x96}],_0x32a32b['forEach'](_0x59bae1=>_0x5caf2d[_0x117c63(0xaa)](_0x59bae1)),_0x497913[_0x117c63(0xe6)](_0x117c63(0xaf),_0x117c63(0xf2)),_0x497913[_0x117c63(0xe6)](_0x117c63(0xdb),_0x117c63(0x105)+'chat.xlsx'),await _0x194c34['xlsx'][_0x117c63(0xb6)](_0x497913),_0x497913[_0x117c63(0xce)]();}async[_0x3020a0(0x112)](_0x3d751a,_0x527d24){const _0x557f29=_0x3020a0,{page:page=0x1,size:size=0x14,userId:_0x49b3ec,prompt:_0x3b78b9}=_0x3d751a,_0x3d15c2={'type':balance_constant_1[_0x557f29(0xfc)][_0x557f29(0x10e)],'prompt':(0x0,typeorm_2['Not'])('')};_0x49b3ec&&Object[_0x557f29(0xf8)](_0x3d15c2,{'userId':_0x49b3ec}),_0x3b78b9&&Object[_0x557f29(0xf8)](_0x3d15c2,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x3b78b9+'%')});const [_0x4782f8,_0x1ca904]=await this[_0x557f29(0xf4)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3d15c2}),_0x1d4a82=_0x4782f8[_0x557f29(0xa4)](_0x18424c=>_0x18424c[_0x557f29(0xd4)]),_0xe38f39=await this[_0x557f29(0xfe)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1d4a82)},'select':['id',_0x557f29(0xdc),_0x557f29(0x10c)]});return _0x4782f8['forEach'](_0x17fc3a=>{const _0x403c43=_0x557f29,{username:_0x6cccec,email:_0x372d7b}=_0xe38f39['find'](_0x1a2137=>_0x1a2137['id']===_0x17fc3a[_0x403c43(0xd4)])||{};_0x17fc3a['username']=_0x6cccec,_0x17fc3a[_0x403c43(0x10c)]=_0x372d7b;}),_0x527d24[_0x557f29(0xcb)][_0x557f29(0x103)]!==_0x557f29(0xc1)&&_0x4782f8['forEach'](_0x5878af=>_0x5878af['email']=(0x0,utils_1[_0x557f29(0xe2)])(_0x5878af[_0x557f29(0x10c)])),_0x4782f8['forEach'](_0xf81006=>{const _0x2be834=_0x557f29;!_0xf81006[_0x2be834(0x10c)]&&(_0xf81006[_0x2be834(0x10c)]=(_0xf81006===null||_0xf81006===void 0x0?void 0x0:_0xf81006[_0x2be834(0xd4)])+_0x2be834(0xb8)),!_0xf81006[_0x2be834(0xdc)]&&(_0xf81006[_0x2be834(0xdc)]='游客'+(_0xf81006===null||_0xf81006===void 0x0?void 0x0:_0xf81006[_0x2be834(0xd4)]));}),{'rows':_0x4782f8,'count':_0x1ca904};}async[_0x3020a0(0xad)](_0x21c138,_0x43795b){const _0x86daa9=_0x3020a0,{id:_0x4af09b}=_0x21c138['user'],{groupId:_0x3c4eab}=_0x43795b,_0x8132d8={'userId':_0x4af09b,'isDelete':![]};_0x3c4eab&&Object[_0x86daa9(0xf8)](_0x8132d8,{'groupId':_0x3c4eab});if(_0x3c4eab){const _0x4dc319=await this[_0x86daa9(0xee)]['count']({'where':{'isDelete':![]}});if(_0x4dc319===0x0)return[];}const _0x29fa4c=await this[_0x86daa9(0xf4)]['find']({'where':_0x8132d8});return _0x29fa4c[_0x86daa9(0xa4)](_0x4aac6d=>{const _0x30d442=_0x86daa9,{prompt:_0x4cb570,role:_0x23f5ed,answer:_0x583f9e,createdAt:_0x5acdea,model:_0x21d1e8,conversationOptions:_0x1ca7ba,requestOptions:_0x2d0b1c,id:_0x5d1fd6,imageUrl:_0xc4ae78}=_0x4aac6d;let _0x1701a5=null,_0x4b6865=null;try{_0x1701a5=JSON[_0x30d442(0xc9)](_0x1ca7ba),_0x4b6865=JSON[_0x30d442(0xc9)](_0x2d0b1c);}catch(_0x239351){}return{'chatId':_0x5d1fd6,'dateTime':(0x0,utils_1[_0x30d442(0xa2)])(_0x5acdea),'text':_0x23f5ed===_0x30d442(0xcb)?_0x4cb570:_0x583f9e,'inversion':_0x23f5ed==='user','error':![],'conversationOptions':_0x1701a5,'requestOptions':_0x4b6865,'imageUrl':_0xc4ae78,'model':_0x21d1e8};});}async[_0x3020a0(0xdf)](_0x59600d,_0x24869c){const _0x212f1a=_0x3020a0,{id:_0x34f50c}=_0x59600d[_0x212f1a(0xcb)],{id:_0x360525}=_0x24869c,_0x17f8bf=await this[_0x212f1a(0xf4)][_0x212f1a(0xc4)]({'where':{'id':_0x360525,'userId':_0x34f50c}});if(!_0x17f8bf)throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x212f1a(0xe7)][_0x212f1a(0xa3)]);const _0x499be1=await this['chatLogEntity']['update']({'id':_0x360525},{'isDelete':!![]});if(_0x499be1['affected']>0x0)return _0x212f1a(0xa9);else throw new common_1[(_0x212f1a(0xda))](_0x212f1a(0xd5),common_1[_0x212f1a(0xe7)][_0x212f1a(0xa3)]);}async[_0x3020a0(0xeb)](_0x925c81,_0x5be1a6){const _0x149f76=_0x3020a0,{groupId:_0x5a0033}=_0x5be1a6,{id:_0x4faed2}=_0x925c81[_0x149f76(0xcb)],_0xf964b4=await this[_0x149f76(0xee)]['findOne']({'where':{'id':_0x5a0033,'userId':_0x4faed2}});if(!_0xf964b4)throw new common_1[(_0x149f76(0xda))]('你删除的对话记录不存在、请检查！',common_1[_0x149f76(0xe7)][_0x149f76(0xa3)]);const _0x5a21ef=await this[_0x149f76(0xf4)][_0x149f76(0xde)]({'groupId':_0x5a0033},{'isDelete':!![]});if(_0x5a21ef[_0x149f76(0xe3)]>0x0)return _0x149f76(0xa9);if(_0x5a21ef['affected']===0x0)throw new common_1[(_0x149f76(0xda))](_0x149f76(0x109),common_1['HttpStatus'][_0x149f76(0xa3)]);}async['byAppId'](_0x3b2cb4,_0x18147d){const _0x4f84da=_0x3020a0,{id:_0x5720b2}=_0x3b2cb4[_0x4f84da(0xcb)],{appId:_0x194c55,page:page=0x1,size:size=0xa}=_0x18147d,[_0x594c0e,_0x33b677]=await this['chatLogEntity'][_0x4f84da(0xc2)]({'where':{'userId':_0x5720b2,'appId':_0x194c55,'role':_0x4f84da(0xc6)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x594c0e,'count':_0x33b677};}};function _0x4dca(_0x1f6027,_0x223217){const _0x4a348d=_0x4a34();return _0x4dca=function(_0x4dca56,_0x1ae424){_0x4dca56=_0x4dca56-0xa2;let _0xa67945=_0x4a348d[_0x4dca56];return _0xa67945;},_0x4dca(_0x1f6027,_0x223217);}ChatLogService=__decorate([(0x0,common_1[_0x3020a0(0xc0)])(),__param(0x0,(0x0,typeorm_1[_0x3020a0(0xb1)])(chatLog_entity_1[_0x3020a0(0x104)])),__param(0x1,(0x0,typeorm_1[_0x3020a0(0xb1)])(user_entity_1[_0x3020a0(0xe4)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x3020a0(0xf1),[typeorm_2[_0x3020a0(0xbd)],typeorm_2[_0x3020a0(0xbd)],typeorm_2[_0x3020a0(0xbd)]])],ChatLogService),exports[_0x3020a0(0xd9)]=ChatLogService;