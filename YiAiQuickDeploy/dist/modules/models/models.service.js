'use strict';const _0x4084ed=_0x2daa;function _0x2daa(_0x34f00b,_0x57db40){const _0x156938=_0x1569();return _0x2daa=function(_0x2daa8c,_0x214368){_0x2daa8c=_0x2daa8c-0x14c;let _0x42eb84=_0x156938[_0x2daa8c];return _0x42eb84;},_0x2daa(_0x34f00b,_0x57db40);}(function(_0x1097df,_0x4206e9){const _0x26e877=_0x2daa,_0x3f45fd=_0x1097df();while(!![]){try{const _0x171543=parseInt(_0x26e877(0x175))/0x1+-parseInt(_0x26e877(0x178))/0x2+parseInt(_0x26e877(0x161))/0x3+parseInt(_0x26e877(0x180))/0x4+-parseInt(_0x26e877(0x158))/0x5+-parseInt(_0x26e877(0x186))/0x6+parseInt(_0x26e877(0x14e))/0x7;if(_0x171543===_0x4206e9)break;else _0x3f45fd['push'](_0x3f45fd['shift']());}catch(_0x5be50f){_0x3f45fd['push'](_0x3f45fd['shift']());}}}(_0x1569,0x3290c));function _0x1569(){const _0xb5510f=['delModel','lockKey','__decorate','queryModelType','parse\x20error:\x20','getRandomDrawKey','../../common/constants/status.constant','val','setModel','modelName','from','HttpException','Injectable','BAD_REQUEST','log','../../common/utils','4682622jyktXy','update','keyPoolIndexMap','decorate','InjectRepository','error:\x20','object','createQueryBuilder','modelOrder','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','1716350XfkkiC','super','user','ModelsMapCn','key','affected','getCurrentModelKeyInfo','forEach','当前未指定特殊模型KEY、前往后台模型池设置吧！','748944tztjHZ','defineProperty','find','getRandomItemFromArray','length','ModelsService','parse','getAllKey','push','useCount\x20+\x201','reduce','initCalcKey','function','当前调用模型已经被移除、请重新选择模型！','map','findOne','getOwnPropertyDescriptor','where','modelsList','modelsTypeEntity','60798BbplZg','HttpStatus','@nestjs/common','538454utHRRQ','onModuleInit','modelMaps','ModelsEntity','Logger','modelsEntity','@nestjs/typeorm','Repository','242104dCMjic','set','setModelType','delete','delModelType','status','1321830CLUywN','modelTypes','execute','sort','model','typeorm','metadata','keyPoolMap','keys','values','keyList','secret','stringify'];_0x1569=function(){return _0xb5510f;};return _0x1569();}var __decorate=this&&this[_0x4084ed(0x195)]||function(_0xf97be3,_0x4c040a,_0x4b7e71,_0x1fad63){const _0x2b4b25=_0x4084ed;var _0x30f685=arguments[_0x2b4b25(0x165)],_0x3ae6da=_0x30f685<0x3?_0x4c040a:_0x1fad63===null?_0x1fad63=Object[_0x2b4b25(0x171)](_0x4c040a,_0x4b7e71):_0x1fad63,_0x1f3d5a;if(typeof Reflect==='object'&&typeof Reflect[_0x2b4b25(0x151)]===_0x2b4b25(0x16d))_0x3ae6da=Reflect[_0x2b4b25(0x151)](_0xf97be3,_0x4c040a,_0x4b7e71,_0x1fad63);else{for(var _0xce5a20=_0xf97be3[_0x2b4b25(0x165)]-0x1;_0xce5a20>=0x0;_0xce5a20--)if(_0x1f3d5a=_0xf97be3[_0xce5a20])_0x3ae6da=(_0x30f685<0x3?_0x1f3d5a(_0x3ae6da):_0x30f685>0x3?_0x1f3d5a(_0x4c040a,_0x4b7e71,_0x3ae6da):_0x1f3d5a(_0x4c040a,_0x4b7e71))||_0x3ae6da;}return _0x30f685>0x3&&_0x3ae6da&&Object['defineProperty'](_0x4c040a,_0x4b7e71,_0x3ae6da),_0x3ae6da;},__metadata=this&&this['__metadata']||function(_0xca06ab,_0x7d3ca3){const _0x2989d0=_0x4084ed;if(typeof Reflect===_0x2989d0(0x154)&&typeof Reflect[_0x2989d0(0x18c)]===_0x2989d0(0x16d))return Reflect[_0x2989d0(0x18c)](_0xca06ab,_0x7d3ca3);},__param=this&&this['__param']||function(_0x4992a8,_0x1accae){return function(_0x3ae088,_0x19dc18){_0x1accae(_0x3ae088,_0x19dc18,_0x4992a8);};};Object[_0x4084ed(0x162)](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x4084ed(0x177)),typeorm_1=require(_0x4084ed(0x17e)),typeorm_2=require(_0x4084ed(0x18b)),models_entity_1=require('./models.entity'),status_constant_1=require(_0x4084ed(0x199)),utils_1=require(_0x4084ed(0x14d)),modelType_entity_1=require('./modelType.entity');let ModelsService=class ModelsService{constructor(_0x58d1af,_0x3a5bf2){const _0x569347=_0x4084ed;this[_0x569347(0x17d)]=_0x58d1af,this[_0x569347(0x174)]=_0x3a5bf2,this['modelTypes']=[],this[_0x569347(0x17a)]={},this['keyList']={},this[_0x569347(0x18d)]={},this[_0x569347(0x150)]={};}async[_0x4084ed(0x179)](){const _0x37a7a5=_0x4084ed;await this[_0x37a7a5(0x16c)]();}async['initCalcKey'](){const _0x5bd83d=_0x4084ed;this['keyPoolMap']={},this[_0x5bd83d(0x150)]={},this[_0x5bd83d(0x190)]={},this[_0x5bd83d(0x17a)]={},this['modelTypes']=[];const _0x4b9c00=await this[_0x5bd83d(0x17d)][_0x5bd83d(0x163)]({'where':{'status':!![]}}),_0x4abafd=_0x4b9c00[_0x5bd83d(0x16b)]((_0x120209,_0x42d72b)=>{const _0x481103=_0x5bd83d;return!_0x120209[_0x42d72b['keyType']]?_0x120209[_0x42d72b['keyType']]=[_0x42d72b]:_0x120209[_0x42d72b['keyType']][_0x481103(0x169)](_0x42d72b),_0x120209;},{});this[_0x5bd83d(0x187)]=Object['keys'](_0x4abafd)[_0x5bd83d(0x16f)](_0x5cad0e=>{const _0x5da1c4=_0x5bd83d;return{'label':status_constant_1[_0x5da1c4(0x15b)][_0x5cad0e],'val':_0x5cad0e};}),this[_0x5bd83d(0x17a)]=_0x4abafd,this[_0x5bd83d(0x190)]={},_0x4b9c00[_0x5bd83d(0x15f)](_0x1a523f=>{const _0x25c872=_0x5bd83d,{keyType:_0x907825,model:_0x49bce5,keyWeight:_0x2ce344}=_0x1a523f;if(!this['keyPoolMap'][_0x49bce5])this[_0x25c872(0x18d)][_0x49bce5]=[];for(let _0x5d9b06=0x0;_0x5d9b06<_0x2ce344;_0x5d9b06++){this[_0x25c872(0x18d)][_0x49bce5][_0x25c872(0x169)](_0x1a523f);}if(!this[_0x25c872(0x150)][_0x49bce5])this[_0x25c872(0x150)][_0x49bce5]=0x0;if(!this[_0x25c872(0x190)][_0x907825])this[_0x25c872(0x190)][_0x907825]={};if(!this['keyList'][_0x907825][_0x49bce5])this[_0x25c872(0x190)][_0x907825][_0x49bce5]=[];this['keyList'][_0x907825][_0x49bce5][_0x25c872(0x169)](_0x1a523f);});}async[_0x4084ed(0x194)](_0x1689d6,_0x5923c2,_0x2b0fbf=-0x1){const _0x212044=_0x4084ed,_0x2125bf=await this[_0x212044(0x17d)][_0x212044(0x14f)]({'id':_0x1689d6},{'status':![],'keyStatus':_0x2b0fbf,'remark':_0x5923c2});common_1[_0x212044(0x17c)]['error']('key:\x20'+_0x1689d6+_0x212044(0x157)),this[_0x212044(0x16c)]();}async[_0x4084ed(0x15e)](_0x34c462){const _0x3bbc5b=_0x4084ed;if(!this[_0x3bbc5b(0x18d)][_0x34c462])throw new common_1[(_0x3bbc5b(0x19e))](_0x3bbc5b(0x16e),common_1[_0x3bbc5b(0x176)][_0x3bbc5b(0x1a0)]);this['keyPoolIndexMap'][_0x34c462]++;const _0x151eb4=this['keyPoolIndexMap'][_0x34c462];if(_0x151eb4>=this['keyPoolMap'][_0x34c462]['length'])this[_0x3bbc5b(0x150)][_0x34c462]=0x0;const _0x3586c9=this[_0x3bbc5b(0x18d)][_0x34c462][this[_0x3bbc5b(0x150)][_0x34c462]];return _0x3586c9;}async['getBaseConfig'](_0xf6edd8){const _0x30f8ee=_0x4084ed;if(!this['modelTypes'][_0x30f8ee(0x165)]||!Object[_0x30f8ee(0x18e)](this[_0x30f8ee(0x17a)])[_0x30f8ee(0x165)])return;const _0x51f3bd=_0xf6edd8?this['modelTypes'][_0x30f8ee(0x163)](_0xbbcecd=>Number(_0xbbcecd['val'])===0x1):this[_0x30f8ee(0x187)][0x0];if(!_0x51f3bd)return;const {keyType:_0xf10f06,modelName:_0x161c5c,model:_0x1bc3fd,maxModelTokens:_0x14dfd0,maxResponseTokens:_0x5bfa6e,deductType:_0x49d0a8,deduct:_0x109110,maxRounds:_0x193a5a}=this[_0x30f8ee(0x17a)][_0x51f3bd[_0x30f8ee(0x19a)]][0x0];return{'modelTypeInfo':_0x51f3bd,'modelInfo':{'keyType':_0xf10f06,'modelName':_0x161c5c,'model':_0x1bc3fd,'maxModelTokens':_0x14dfd0,'maxResponseTokens':_0x5bfa6e,'topN':0.8,'systemMessage':'','deductType':_0x49d0a8,'deduct':_0x109110,'maxRounds':_0x193a5a,'rounds':0x8}};}async[_0x4084ed(0x19b)](_0xd0eb23){const _0x31a3cc=_0x4084ed;try{const {id:_0x48d0a4}=_0xd0eb23;_0xd0eb23['status']&&(_0xd0eb23['keyStatus']=0x1);if(_0x48d0a4){const _0x357d9c=await this[_0x31a3cc(0x17d)][_0x31a3cc(0x14f)]({'id':_0x48d0a4},_0xd0eb23);return await this[_0x31a3cc(0x16c)](),_0x357d9c[_0x31a3cc(0x15d)]>0x0;}else{const {keyType:_0x243d01,key:_0x1a9e1e}=_0xd0eb23;if(Number(_0x243d01!==0x1)){const _0x224fce=await this[_0x31a3cc(0x17d)]['save'](_0xd0eb23);return await this[_0x31a3cc(0x16c)](),_0x224fce;}else{const _0x39c024=_0x1a9e1e[_0x31a3cc(0x16f)](_0x10c236=>{const _0xc279a9=_0x31a3cc;try{const _0x2f1360=JSON[_0xc279a9(0x167)](JSON[_0xc279a9(0x192)](_0xd0eb23));return _0x2f1360[_0xc279a9(0x15c)]=_0x10c236,_0x2f1360;}catch(_0x1dfe71){console[_0xc279a9(0x14c)](_0xc279a9(0x197),_0x1dfe71);}}),_0x4db0d8=await this[_0x31a3cc(0x17d)]['save'](_0x39c024);return await this[_0x31a3cc(0x16c)](),_0x4db0d8;}}}catch(_0x3b2d69){console[_0x31a3cc(0x14c)](_0x31a3cc(0x153),_0x3b2d69);}}async[_0x4084ed(0x193)]({id:_0x3b43a8}){const _0x49031f=_0x4084ed;if(!_0x3b43a8)throw new common_1['HttpException']('缺失必要参数！',common_1[_0x49031f(0x176)][_0x49031f(0x1a0)]);const _0xd76c20=await this[_0x49031f(0x17d)][_0x49031f(0x170)]({'where':{'id':_0x3b43a8}});if(!_0xd76c20)throw new common_1['HttpException']('当前账号不存在！',common_1[_0x49031f(0x176)][_0x49031f(0x1a0)]);const _0x197717=await this[_0x49031f(0x17d)][_0x49031f(0x183)]({'id':_0x3b43a8});return await this[_0x49031f(0x16c)](),_0x197717;}async['queryModels'](_0x395564,_0x11d5ce){const _0x824fd7=_0x4084ed,{role:_0x14bb38}=_0x395564[_0x824fd7(0x15a)],{keyType:_0x118513,key:_0x40629d,status:_0x47af07,model:_0x481c15,page:page=0x1,size:size=0xa}=_0x11d5ce;let _0x16e6a4={};_0x118513&&(_0x16e6a4['keyType']=_0x118513),_0x481c15&&(_0x16e6a4[_0x824fd7(0x18a)]=_0x481c15),_0x47af07&&(_0x16e6a4[_0x824fd7(0x185)]=Number(_0x47af07)===0x1?!![]:![]),_0x40629d&&(_0x16e6a4[_0x824fd7(0x15c)]=(0x0,typeorm_2['Like'])('%'+_0x40629d+'%'));const [_0x30fbb2,_0x495c5c]=await this[_0x824fd7(0x17d)]['findAndCount']({'where':_0x16e6a4,'order':{'modelOrder':'ASC'},'skip':(page-0x1)*size,'take':size});return _0x14bb38!==_0x824fd7(0x159)&&_0x30fbb2['forEach'](_0x52cb77=>{const _0x347549=_0x824fd7;_0x52cb77[_0x347549(0x15c)]&&(_0x52cb77[_0x347549(0x15c)]=(0x0,utils_1['hideString'])(_0x52cb77['key'])),_0x52cb77['secret']&&(_0x52cb77[_0x347549(0x191)]=(0x0,utils_1['hideString'])(_0x52cb77[_0x347549(0x191)]));}),{'rows':_0x30fbb2,'count':_0x495c5c};}async[_0x4084ed(0x173)](){const _0x544df8=_0x4084ed,_0x1f1912=JSON['parse'](JSON[_0x544df8(0x192)](this[_0x544df8(0x17a)]));return Object['keys'](_0x1f1912)['forEach'](_0x1e91a0=>{const _0x58b377=_0x544df8;_0x1f1912[_0x1e91a0]=_0x1f1912[_0x1e91a0][_0x58b377(0x189)]((_0x23d763,_0x5ad281)=>_0x23d763[_0x58b377(0x156)]-_0x5ad281[_0x58b377(0x156)]),_0x1f1912[_0x1e91a0]=Array[_0x58b377(0x19d)](_0x1f1912[_0x1e91a0][_0x58b377(0x16f)](_0x4e9b83=>{const {modelName:_0x2bee8c,model:_0x52167c,deduct:_0x3e42a8,deductType:_0xc1c4e1,maxRounds:_0x3226f9}=_0x4e9b83;return{'modelName':_0x2bee8c,'model':_0x52167c,'deduct':_0x3e42a8,'deductType':_0xc1c4e1,'maxRounds':_0x3226f9};})['reduce']((_0x1f365a,_0x5987a9)=>_0x1f365a[_0x58b377(0x181)](_0x5987a9[_0x58b377(0x19c)],_0x5987a9),new Map())[_0x58b377(0x18f)]());}),{'modelTypeList':this[_0x544df8(0x187)],'modelMaps':_0x1f1912};}async['saveUseLog'](_0xb2fe44,_0x5e7e6c){const _0x267493=_0x4084ed;await this[_0x267493(0x17d)][_0x267493(0x155)]()[_0x267493(0x14f)](models_entity_1[_0x267493(0x17b)])[_0x267493(0x181)]({'useCount':()=>_0x267493(0x16a),'useToken':()=>'useToken\x20+\x20'+_0x5e7e6c})[_0x267493(0x172)]('id\x20=\x20:id',{'id':_0xb2fe44})[_0x267493(0x188)]();}async[_0x4084ed(0x198)](){const _0x5a8180=_0x4084ed,_0x42c86c=await this[_0x5a8180(0x17d)][_0x5a8180(0x163)]({'where':{'isDraw':!![],'status':!![]}});if(!_0x42c86c[_0x5a8180(0x165)])throw new common_1[(_0x5a8180(0x19e))](_0x5a8180(0x160),common_1['HttpStatus'][_0x5a8180(0x1a0)]);return(0x0,utils_1[_0x5a8180(0x164)])(_0x42c86c);}async[_0x4084ed(0x168)](){const _0x4bf4df=_0x4084ed;return await this[_0x4bf4df(0x17d)][_0x4bf4df(0x163)]();}async[_0x4084ed(0x196)](_0x426d57){return 0x1;}async[_0x4084ed(0x182)](_0x1d526c){return 0x1;}async[_0x4084ed(0x184)](_0x533a7e){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x4084ed(0x19f)])(),__param(0x0,(0x0,typeorm_1[_0x4084ed(0x152)])(models_entity_1[_0x4084ed(0x17b)])),__param(0x1,(0x0,typeorm_1[_0x4084ed(0x152)])(modelType_entity_1['ModelsTypeEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x4084ed(0x17f)],typeorm_2[_0x4084ed(0x17f)]])],ModelsService),exports[_0x4084ed(0x166)]=ModelsService;