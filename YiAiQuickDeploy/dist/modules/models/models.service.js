'use strict';const _0x4da714=_0x29ac;(function(_0x4947ec,_0x2ab95a){const _0xf690e3=_0x29ac,_0x1a2619=_0x4947ec();while(!![]){try{const _0x114066=-parseInt(_0xf690e3(0xcc))/0x1+-parseInt(_0xf690e3(0x121))/0x2+parseInt(_0xf690e3(0xf7))/0x3*(-parseInt(_0xf690e3(0x101))/0x4)+-parseInt(_0xf690e3(0x123))/0x5*(parseInt(_0xf690e3(0x104))/0x6)+parseInt(_0xf690e3(0x100))/0x7*(parseInt(_0xf690e3(0xe2))/0x8)+-parseInt(_0xf690e3(0x11f))/0x9+-parseInt(_0xf690e3(0xe5))/0xa*(-parseInt(_0xf690e3(0xf4))/0xb);if(_0x114066===_0x2ab95a)break;else _0x1a2619['push'](_0x1a2619['shift']());}catch(_0x2dda5a){_0x1a2619['push'](_0x1a2619['shift']());}}}(_0x220c,0x94d96));function _0x220c(){const _0x4de6b1=['reduce','Injectable','keyList','当前账号不存在！','object','Repository','findAndCount','keyPoolIndexMap','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','getCurrentModelKeyInfo','length','hideString','缺失必要参数！','createQueryBuilder','keyPoolMap','BAD_REQUEST','./modelType.entity','88WnVMvx','queryModels','../../common/constants/status.constant','53310YwuTjF','function','model','push','modelOrder','../../common/utils','stringify','id\x20=\x20:id','HttpStatus','setModelType','design:paramtypes','sort','set','__param','affected','8536ymHAPN','modelsEntity','forEach','2671143HjgJGz','status','find','saveUseLog','modelMaps','keyType','getBaseConfig','findOne','secret','522039hcTJBl','4NBeDgl','queryModelType','super','9414sxIOkU','update','delete','typeorm','modelsList','onModuleInit','defineProperty','getRandomDrawKey','ModelsService','parse','save','initCalcKey','__metadata','error:\x20','@nestjs/typeorm','modelTypes','__decorate','error','HttpException','modelsTypeEntity','keyStatus','ASC','__esModule','当前调用模型已经被移除、请重新选择模型！','lockKey','map','ModelsEntity','8314794LUrIvN','val','2128404fsOaFv','delModelType','1670thwicp','@nestjs/common','ModelsMapCn','log','ModelsTypeEntity','Like','945022NHRReu','delModel','metadata','key','keys'];_0x220c=function(){return _0x4de6b1;};return _0x220c();}function _0x29ac(_0x5b9f1c,_0x5e1b4e){const _0x220c4e=_0x220c();return _0x29ac=function(_0x29acd7,_0x326f81){_0x29acd7=_0x29acd7-0xc7;let _0x2cd7fc=_0x220c4e[_0x29acd7];return _0x2cd7fc;},_0x29ac(_0x5b9f1c,_0x5e1b4e);}var __decorate=this&&this[_0x4da714(0x114)]||function(_0xed74fd,_0x59b567,_0x4a907f,_0x2bd3da){const _0x525622=_0x4da714;var _0x4514fa=arguments['length'],_0x3ddd59=_0x4514fa<0x3?_0x59b567:_0x2bd3da===null?_0x2bd3da=Object['getOwnPropertyDescriptor'](_0x59b567,_0x4a907f):_0x2bd3da,_0x4556ae;if(typeof Reflect===_0x525622(0xd5)&&typeof Reflect['decorate']==='function')_0x3ddd59=Reflect['decorate'](_0xed74fd,_0x59b567,_0x4a907f,_0x2bd3da);else{for(var _0x4ab0e3=_0xed74fd[_0x525622(0xdb)]-0x1;_0x4ab0e3>=0x0;_0x4ab0e3--)if(_0x4556ae=_0xed74fd[_0x4ab0e3])_0x3ddd59=(_0x4514fa<0x3?_0x4556ae(_0x3ddd59):_0x4514fa>0x3?_0x4556ae(_0x59b567,_0x4a907f,_0x3ddd59):_0x4556ae(_0x59b567,_0x4a907f))||_0x3ddd59;}return _0x4514fa>0x3&&_0x3ddd59&&Object[_0x525622(0x10a)](_0x59b567,_0x4a907f,_0x3ddd59),_0x3ddd59;},__metadata=this&&this[_0x4da714(0x110)]||function(_0x18e7e3,_0x4ab2cc){const _0x253d3f=_0x4da714;if(typeof Reflect==='object'&&typeof Reflect[_0x253d3f(0xce)]===_0x253d3f(0xe6))return Reflect['metadata'](_0x18e7e3,_0x4ab2cc);},__param=this&&this[_0x4da714(0xf2)]||function(_0x383fa4,_0x48c720){return function(_0x59b2ff,_0x19a5c7){_0x48c720(_0x59b2ff,_0x19a5c7,_0x383fa4);};};Object[_0x4da714(0x10a)](exports,_0x4da714(0x11a),{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x4da714(0xc7)),typeorm_1=require(_0x4da714(0x112)),typeorm_2=require(_0x4da714(0x107)),models_entity_1=require('./models.entity'),status_constant_1=require(_0x4da714(0xe4)),utils_1=require(_0x4da714(0xea)),modelType_entity_1=require(_0x4da714(0xe1));let ModelsService=class ModelsService{constructor(_0x4d6f38,_0x14acd1){const _0x2f48ca=_0x4da714;this[_0x2f48ca(0xf5)]=_0x4d6f38,this[_0x2f48ca(0x117)]=_0x14acd1,this[_0x2f48ca(0x113)]=[],this[_0x2f48ca(0xfb)]={},this['keyList']={},this['keyPoolMap']={},this[_0x2f48ca(0xd8)]={};}async[_0x4da714(0x109)](){const _0x487452=_0x4da714;await this[_0x487452(0x10f)]();}async['initCalcKey'](){const _0x2b9774=_0x4da714;this[_0x2b9774(0xdf)]={},this[_0x2b9774(0xd8)]={},this[_0x2b9774(0xd3)]={},this[_0x2b9774(0xfb)]={},this[_0x2b9774(0x113)]=[];const _0xc0dc87=await this[_0x2b9774(0xf5)][_0x2b9774(0xf9)]({'where':{'status':!![]}}),_0xc12953=_0xc0dc87['reduce']((_0x45fe88,_0x1e4418)=>{const _0x39c2b3=_0x2b9774;return!_0x45fe88[_0x1e4418[_0x39c2b3(0xfc)]]?_0x45fe88[_0x1e4418[_0x39c2b3(0xfc)]]=[_0x1e4418]:_0x45fe88[_0x1e4418['keyType']][_0x39c2b3(0xe8)](_0x1e4418),_0x45fe88;},{});this['modelTypes']=Object[_0x2b9774(0xd0)](_0xc12953)[_0x2b9774(0x11d)](_0x23e767=>{const _0x51b45a=_0x2b9774;return{'label':status_constant_1[_0x51b45a(0xc8)][_0x23e767],'val':_0x23e767};}),this[_0x2b9774(0xfb)]=_0xc12953,this[_0x2b9774(0xd3)]={},_0xc0dc87['forEach'](_0x121df1=>{const _0x2984e7=_0x2b9774,{keyType:_0x464227,model:_0x3cc62f,keyWeight:_0x522e00}=_0x121df1;if(!this[_0x2984e7(0xdf)][_0x3cc62f])this[_0x2984e7(0xdf)][_0x3cc62f]=[];for(let _0x598804=0x0;_0x598804<_0x522e00;_0x598804++){this[_0x2984e7(0xdf)][_0x3cc62f]['push'](_0x121df1);}if(!this['keyPoolIndexMap'][_0x3cc62f])this[_0x2984e7(0xd8)][_0x3cc62f]=0x0;if(!this['keyList'][_0x464227])this[_0x2984e7(0xd3)][_0x464227]={};if(!this[_0x2984e7(0xd3)][_0x464227][_0x3cc62f])this[_0x2984e7(0xd3)][_0x464227][_0x3cc62f]=[];this[_0x2984e7(0xd3)][_0x464227][_0x3cc62f][_0x2984e7(0xe8)](_0x121df1);});}async[_0x4da714(0x11c)](_0x120a0b,_0x3e901f,_0x49c434=-0x1){const _0x2fc0e8=_0x4da714,_0x304a8b=await this[_0x2fc0e8(0xf5)][_0x2fc0e8(0x105)]({'id':_0x120a0b},{'status':![],'keyStatus':_0x49c434,'remark':_0x3e901f});common_1['Logger'][_0x2fc0e8(0x115)]('key:\x20'+_0x120a0b+_0x2fc0e8(0xd9)),this['initCalcKey']();}async[_0x4da714(0xda)](_0x31ada4){const _0x29191b=_0x4da714;if(!this[_0x29191b(0xdf)][_0x31ada4])throw new common_1[(_0x29191b(0x116))](_0x29191b(0x11b),common_1[_0x29191b(0xed)][_0x29191b(0xe0)]);this['keyPoolIndexMap'][_0x31ada4]++;const _0x129e11=this[_0x29191b(0xd8)][_0x31ada4];if(_0x129e11>=this['keyPoolMap'][_0x31ada4][_0x29191b(0xdb)])this[_0x29191b(0xd8)][_0x31ada4]=0x0;const _0x41797b=this[_0x29191b(0xdf)][_0x31ada4][this[_0x29191b(0xd8)][_0x31ada4]];return _0x41797b;}async[_0x4da714(0xfd)](_0x2a04fb){const _0x6c7560=_0x4da714;if(!this[_0x6c7560(0x113)][_0x6c7560(0xdb)]||!Object[_0x6c7560(0xd0)](this[_0x6c7560(0xfb)])[_0x6c7560(0xdb)])return;const _0x273acc=_0x2a04fb?this[_0x6c7560(0x113)][_0x6c7560(0xf9)](_0x498eea=>Number(_0x498eea[_0x6c7560(0x120)])===0x1):this[_0x6c7560(0x113)][0x0];if(!_0x273acc)return;const {keyType:_0x4bc5ae,modelName:_0x4f6bb7,model:_0x378c24,maxModelTokens:_0x5be7be,maxResponseTokens:_0x1b626d,deductType:_0x4ec787,deduct:_0x29b8a1,maxRounds:_0x2b4614}=this[_0x6c7560(0xfb)][_0x273acc[_0x6c7560(0x120)]][0x0];return{'modelTypeInfo':_0x273acc,'modelInfo':{'keyType':_0x4bc5ae,'modelName':_0x4f6bb7,'model':_0x378c24,'maxModelTokens':_0x5be7be,'maxResponseTokens':_0x1b626d,'topN':0.8,'systemMessage':'','deductType':_0x4ec787,'deduct':_0x29b8a1,'maxRounds':_0x2b4614,'rounds':0x8}};}async['setModel'](_0x1ddf11){const _0x307d81=_0x4da714;try{const {id:_0x2a2b97}=_0x1ddf11;_0x1ddf11['status']&&(_0x1ddf11[_0x307d81(0x118)]=0x1);if(_0x2a2b97){const _0x38f60e=await this['modelsEntity'][_0x307d81(0x105)]({'id':_0x2a2b97},_0x1ddf11);return await this[_0x307d81(0x10f)](),_0x38f60e[_0x307d81(0xf3)]>0x0;}else{const {keyType:_0x285993,key:_0x1cdc1a}=_0x1ddf11;if(Number(_0x285993!==0x1)){const _0x432a3b=await this[_0x307d81(0xf5)]['save'](_0x1ddf11);return await this[_0x307d81(0x10f)](),_0x432a3b;}else{const _0x40ffe6=_0x1cdc1a[_0x307d81(0x11d)](_0x9a2eee=>{const _0xa36952=_0x307d81;try{const _0x4f95f4=JSON[_0xa36952(0x10d)](JSON[_0xa36952(0xeb)](_0x1ddf11));return _0x4f95f4[_0xa36952(0xcf)]=_0x9a2eee,_0x4f95f4;}catch(_0x4160c8){console[_0xa36952(0xc9)]('parse\x20error:\x20',_0x4160c8);}}),_0x30edfc=await this[_0x307d81(0xf5)][_0x307d81(0x10e)](_0x40ffe6);return await this[_0x307d81(0x10f)](),_0x30edfc;}}}catch(_0x3c579d){console[_0x307d81(0xc9)](_0x307d81(0x111),_0x3c579d);}}async[_0x4da714(0xcd)]({id:_0x3d389b}){const _0x1d756f=_0x4da714;if(!_0x3d389b)throw new common_1[(_0x1d756f(0x116))](_0x1d756f(0xdd),common_1[_0x1d756f(0xed)][_0x1d756f(0xe0)]);const _0x57f705=await this[_0x1d756f(0xf5)][_0x1d756f(0xfe)]({'where':{'id':_0x3d389b}});if(!_0x57f705)throw new common_1['HttpException'](_0x1d756f(0xd4),common_1[_0x1d756f(0xed)][_0x1d756f(0xe0)]);const _0x18161b=await this[_0x1d756f(0xf5)][_0x1d756f(0x106)]({'id':_0x3d389b});return await this['initCalcKey'](),_0x18161b;}async[_0x4da714(0xe3)](_0x2a816e,_0x2791b8){const _0x526ad6=_0x4da714,{role:_0x535fc7}=_0x2a816e['user'],{keyType:_0x2076eb,key:_0x53ea9e,status:_0x4649c7,model:_0x35addc,page:page=0x1,size:size=0xa}=_0x2791b8;let _0x68916a={};_0x2076eb&&(_0x68916a[_0x526ad6(0xfc)]=_0x2076eb),_0x35addc&&(_0x68916a[_0x526ad6(0xe7)]=_0x35addc),_0x4649c7&&(_0x68916a[_0x526ad6(0xf8)]=Number(_0x4649c7)===0x1?!![]:![]),_0x53ea9e&&(_0x68916a[_0x526ad6(0xcf)]=(0x0,typeorm_2[_0x526ad6(0xcb)])('%'+_0x53ea9e+'%'));const [_0x332662,_0x52e783]=await this[_0x526ad6(0xf5)][_0x526ad6(0xd7)]({'where':_0x68916a,'order':{'modelOrder':_0x526ad6(0x119)},'skip':(page-0x1)*size,'take':size});return _0x535fc7!==_0x526ad6(0x103)&&_0x332662[_0x526ad6(0xf6)](_0x12f1cf=>{const _0x562146=_0x526ad6;_0x12f1cf['key']&&(_0x12f1cf[_0x562146(0xcf)]=(0x0,utils_1[_0x562146(0xdc)])(_0x12f1cf[_0x562146(0xcf)])),_0x12f1cf[_0x562146(0xff)]&&(_0x12f1cf[_0x562146(0xff)]=(0x0,utils_1[_0x562146(0xdc)])(_0x12f1cf[_0x562146(0xff)]));}),{'rows':_0x332662,'count':_0x52e783};}async[_0x4da714(0x108)](){const _0x26058a=_0x4da714,_0x3fc521=JSON[_0x26058a(0x10d)](JSON[_0x26058a(0xeb)](this[_0x26058a(0xfb)]));return Object[_0x26058a(0xd0)](_0x3fc521)[_0x26058a(0xf6)](_0x524794=>{const _0x58fea3=_0x26058a;_0x3fc521[_0x524794]=_0x3fc521[_0x524794][_0x58fea3(0xf0)]((_0x128f61,_0x5fa4a)=>_0x128f61[_0x58fea3(0xe9)]-_0x5fa4a[_0x58fea3(0xe9)]),_0x3fc521[_0x524794]=Array['from'](_0x3fc521[_0x524794][_0x58fea3(0x11d)](_0x4fd3d2=>{const {modelName:_0x2e8652,model:_0x23ca5b,deduct:_0x507e0f,deductType:_0x9197aa,maxRounds:_0x35178e}=_0x4fd3d2;return{'modelName':_0x2e8652,'model':_0x23ca5b,'deduct':_0x507e0f,'deductType':_0x9197aa,'maxRounds':_0x35178e};})[_0x58fea3(0xd1)]((_0x5d2365,_0x26cb2d)=>_0x5d2365['set'](_0x26cb2d['modelName'],_0x26cb2d),new Map())['values']());}),{'modelTypeList':this[_0x26058a(0x113)],'modelMaps':_0x3fc521};}async[_0x4da714(0xfa)](_0x580a01,_0x232c5d){const _0x31811d=_0x4da714;await this[_0x31811d(0xf5)][_0x31811d(0xde)]()[_0x31811d(0x105)](models_entity_1[_0x31811d(0x11e)])[_0x31811d(0xf1)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>'useToken\x20+\x20'+_0x232c5d})['where'](_0x31811d(0xec),{'id':_0x580a01})['execute']();}async[_0x4da714(0x10b)](){const _0x1986be=_0x4da714,_0x82764a=await this[_0x1986be(0xf5)]['find']({'where':{'isDraw':!![],'status':!![]}});if(!_0x82764a[_0x1986be(0xdb)])throw new common_1['HttpException']('当前未指定特殊模型KEY、前往后台模型池设置吧！',common_1[_0x1986be(0xed)]['BAD_REQUEST']);return(0x0,utils_1['getRandomItemFromArray'])(_0x82764a);}async['getAllKey'](){const _0x1fb80b=_0x4da714;return await this['modelsEntity'][_0x1fb80b(0xf9)]();}async[_0x4da714(0x102)](_0x321b4e){return 0x1;}async[_0x4da714(0xee)](_0x538be6){return 0x1;}async[_0x4da714(0x122)](_0x3584e2){return 0x1;}};ModelsService=__decorate([(0x0,common_1[_0x4da714(0xd2)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1[_0x4da714(0x11e)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(modelType_entity_1[_0x4da714(0xca)])),__metadata(_0x4da714(0xef),[typeorm_2['Repository'],typeorm_2[_0x4da714(0xd6)]])],ModelsService),exports[_0x4da714(0x10c)]=ModelsService;