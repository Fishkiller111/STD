'use strict';const _0x15887b=_0x2fa9;(function(_0x5b6d48,_0x5cfc61){const _0x3015ae=_0x2fa9,_0x4642d7=_0x5b6d48();while(!![]){try{const _0x54a0da=-parseInt(_0x3015ae(0x169))/0x1+-parseInt(_0x3015ae(0x17e))/0x2+-parseInt(_0x3015ae(0x174))/0x3+parseInt(_0x3015ae(0x167))/0x4*(-parseInt(_0x3015ae(0x178))/0x5)+-parseInt(_0x3015ae(0x170))/0x6*(parseInt(_0x3015ae(0x17b))/0x7)+parseInt(_0x3015ae(0x168))/0x8+parseInt(_0x3015ae(0x171))/0x9;if(_0x54a0da===_0x5cfc61)break;else _0x4642d7['push'](_0x4642d7['shift']());}catch(_0x36d718){_0x4642d7['push'](_0x4642d7['shift']());}}}(_0x4146,0xa1419));var __decorate=this&&this[_0x15887b(0x197)]||function(_0x5d906c,_0x1014af,_0x37b5ba,_0x1a5e8a){const _0x1d5c41=_0x15887b;var _0x5d80a2=arguments[_0x1d5c41(0x15d)],_0x536ed8=_0x5d80a2<0x3?_0x1014af:_0x1a5e8a===null?_0x1a5e8a=Object[_0x1d5c41(0x181)](_0x1014af,_0x37b5ba):_0x1a5e8a,_0x3069ca;if(typeof Reflect===_0x1d5c41(0x18d)&&typeof Reflect[_0x1d5c41(0x17c)]==='function')_0x536ed8=Reflect[_0x1d5c41(0x17c)](_0x5d906c,_0x1014af,_0x37b5ba,_0x1a5e8a);else{for(var _0x481e54=_0x5d906c[_0x1d5c41(0x15d)]-0x1;_0x481e54>=0x0;_0x481e54--)if(_0x3069ca=_0x5d906c[_0x481e54])_0x536ed8=(_0x5d80a2<0x3?_0x3069ca(_0x536ed8):_0x5d80a2>0x3?_0x3069ca(_0x1014af,_0x37b5ba,_0x536ed8):_0x3069ca(_0x1014af,_0x37b5ba))||_0x536ed8;}return _0x5d80a2>0x3&&_0x536ed8&&Object[_0x1d5c41(0x173)](_0x1014af,_0x37b5ba,_0x536ed8),_0x536ed8;},__metadata=this&&this[_0x15887b(0x15a)]||function(_0x567d8a,_0x2281fc){const _0x217de3=_0x15887b;if(typeof Reflect===_0x217de3(0x18d)&&typeof Reflect['metadata']==='function')return Reflect[_0x217de3(0x161)](_0x567d8a,_0x2281fc);},__param=this&&this[_0x15887b(0x191)]||function(_0x47c656,_0xc47cf0){return function(_0x4fa1fc,_0xb4b50){_0xc47cf0(_0x4fa1fc,_0xb4b50,_0x47c656);};};function _0x4146(){const _0x5945c5=['globalConfigService','2017-05-25','__esModule','SendSms','908SBVHfv','7013528ovFVhP','409099Bhbafh','../globalConfig/globalConfig.service','now','update','验证码发送失败！','GlobalConfigService','POST','6okDUGq','28559628gAiTsH','../../common/constants/status.constant','defineProperty','1848984UOhMnF','verifycationEntity','ceil','createdAt','6515bmJGBB','typeorm','@nestjs/typeorm','8021559RfAEeJ','decorate','@alicloud/pop-core','1844666OAADvf','save','stringify','getOwnPropertyDescriptor','../../common/utils','https://dysmsapi.aliyuncs.com','DESC','Message','createRandomCode','findOne','VerificationService','HttpException','../redisCache/redisCache.service','HttpStatus','验证码已过期','object','sendPhoneCode','RedisCacheService','验证码错误','__param','InjectRepository','确实必要参数错误！','getPhoneVerifyConfig','getTime','code','__decorate',':CAPTCHA:','getNamespace','BAD_REQUEST','./verifycation.entity','expiresAt','VerificationUseStatusEnum','@nestjs/common','del','used','图形验证码已过期、请重新输入!','__metadata','当前验证码已被使用！','verifyCode','length','USED','验证码不存在','get','metadata','redisCacheService'];_0x4146=function(){return _0x5945c5;};return _0x4146();}Object['defineProperty'](exports,_0x15887b(0x165),{'value':!![]}),exports[_0x15887b(0x188)]=void 0x0;function _0x2fa9(_0x2a0a75,_0x5c4e71){const _0x414630=_0x4146();return _0x2fa9=function(_0x2fa9bf,_0x4e81e2){_0x2fa9bf=_0x2fa9bf-0x151;let _0x2f1e63=_0x414630[_0x2fa9bf];return _0x2f1e63;},_0x2fa9(_0x2a0a75,_0x5c4e71);}const globalConfig_service_1=require(_0x15887b(0x16a)),status_constant_1=require(_0x15887b(0x172)),typeorm_1=require(_0x15887b(0x17a)),typeorm_2=require(_0x15887b(0x179)),verifycation_entity_1=require(_0x15887b(0x153)),common_1=require(_0x15887b(0x156)),utils_1=require(_0x15887b(0x182)),redisCache_service_1=require(_0x15887b(0x18a)),Core=require(_0x15887b(0x17d));let VerificationService=class VerificationService{constructor(_0x3e30ea,_0x61a3e5,_0x39b4e8){const _0x473e69=_0x15887b;this['verifycationEntity']=_0x3e30ea,this[_0x473e69(0x163)]=_0x61a3e5,this[_0x473e69(0x162)]=_0x39b4e8;}async['createVerification'](_0x23508e,_0x3a3a26,_0x39c3cc=0x1e*0x3c){const _0x3a3e22=_0x15887b,_0x3b67c8=await this[_0x3a3e22(0x175)][_0x3a3e22(0x187)]({'where':{'userId':_0x23508e['id'],'type':_0x3a3a26},'order':{'createdAt':_0x3a3e22(0x184)}});if(_0x3b67c8&&_0x3b67c8[_0x3a3e22(0x177)][_0x3a3e22(0x195)]()+0x1*0x3c*0x3e8>Date[_0x3a3e22(0x16b)]()){const _0x16b068=Math[_0x3a3e22(0x176)]((_0x3b67c8[_0x3a3e22(0x177)]['getTime']()+0x1*0x3c*0x3e8-Date[_0x3a3e22(0x16b)]())/0x3e8);throw new common_1[(_0x3a3e22(0x189))](_0x16b068+'S内不得重新发送',common_1[_0x3a3e22(0x18b)][_0x3a3e22(0x152)]);}const _0x386b0e=(0x0,utils_1[_0x3a3e22(0x186)])(),_0xc7253c=new Date(Date[_0x3a3e22(0x16b)]()+_0x39c3cc*0x3e8),{id:_0x369d8b,email:_0x5990c7}=_0x23508e,_0x1230f7={'userId':_0x369d8b,'type':_0x3a3a26,'code':_0x386b0e,'expiresAt':_0xc7253c,'email':_0x5990c7};return await this['verifycationEntity'][_0x3a3e22(0x17f)](_0x1230f7);}async[_0x15887b(0x15c)]({code:_0x6e8ebf,id:_0x6d186b},_0xcdec4){const _0x18f5d5=_0x15887b,_0x51ab9d=await this[_0x18f5d5(0x175)][_0x18f5d5(0x187)]({'where':{'id':_0x6d186b,'type':_0xcdec4},'order':{'createdAt':_0x18f5d5(0x184)}});if(!_0x51ab9d)throw new common_1[(_0x18f5d5(0x189))](_0x18f5d5(0x15f),common_1[_0x18f5d5(0x18b)][_0x18f5d5(0x152)]);if(_0x51ab9d[_0x18f5d5(0x158)]===status_constant_1[_0x18f5d5(0x155)][_0x18f5d5(0x15e)])throw new common_1['HttpException'](_0x18f5d5(0x15b),common_1[_0x18f5d5(0x18b)][_0x18f5d5(0x152)]);else _0x51ab9d[_0x18f5d5(0x158)]=status_constant_1[_0x18f5d5(0x155)]['USED'],await this[_0x18f5d5(0x175)][_0x18f5d5(0x16c)]({'id':_0x6d186b},_0x51ab9d);if(Number(_0x51ab9d[_0x18f5d5(0x196)])!==Number(_0x6e8ebf))throw new common_1[(_0x18f5d5(0x189))](_0x18f5d5(0x190),common_1['HttpStatus']['BAD_REQUEST']);if(_0x51ab9d[_0x18f5d5(0x154)]<new Date())throw new common_1['HttpException'](_0x18f5d5(0x18c),common_1[_0x18f5d5(0x18b)][_0x18f5d5(0x152)]);return _0x51ab9d;}async['verifyCaptcha'](_0x5b3e5b){const _0x4e988d=_0x15887b,{captchaId:_0x11e598,captchaCode:_0xfbf860}=_0x5b3e5b,_0x57c546=await this[_0x4e988d(0x163)][_0x4e988d(0x151)](),_0x318713=_0x57c546+_0x4e988d(0x198)+_0x11e598,_0x35f9fb=await this[_0x4e988d(0x162)][_0x4e988d(0x160)]({'key':_0x318713});await this['redisCacheService'][_0x4e988d(0x157)]({'key':_0x318713});if(!_0x35f9fb)throw new common_1[(_0x4e988d(0x189))](_0x4e988d(0x159),common_1[_0x4e988d(0x18b)]['BAD_REQUEST']);if(!_0x35f9fb||_0x35f9fb!==_0xfbf860)throw new common_1[(_0x4e988d(0x189))]('图形验证码错误、请检查填写!',common_1['HttpStatus'][_0x4e988d(0x152)]);}async[_0x15887b(0x18e)](_0x2c4db5){const _0x5720b8=_0x15887b;var _0x175eee;const {accessKeyId:_0xfdf2c1,accessKeySecret:_0x6b9e94,SignName:_0x5e7272,TemplateCode:_0x52ed7b}=await this[_0x5720b8(0x163)][_0x5720b8(0x194)](),{phone:_0x454e7a,code:_0x21abc0}=_0x2c4db5;if(!_0x454e7a||!_0x21abc0)throw new common_1[(_0x5720b8(0x189))](_0x5720b8(0x193),common_1[_0x5720b8(0x18b)][_0x5720b8(0x152)]);const _0x492e9c=new Core({'accessKeyId':_0xfdf2c1,'accessKeySecret':_0x6b9e94,'endpoint':_0x5720b8(0x183),'apiVersion':_0x5720b8(0x164)}),_0x13c7f4={'PhoneNumbers':_0x454e7a,'SignName':_0x5e7272,'TemplateCode':_0x52ed7b,'TemplateParam':JSON[_0x5720b8(0x180)]({'code':_0x21abc0})},_0x3f2171={'method':_0x5720b8(0x16f),'formatParams':![]};try{const _0x42a278=await _0x492e9c['request'](_0x5720b8(0x166),_0x13c7f4,_0x3f2171);if(_0x42a278['Code']==='OK')return!![];else throw new common_1[(_0x5720b8(0x189))](_0x42a278[_0x5720b8(0x185)]||_0x5720b8(0x16d),common_1[_0x5720b8(0x18b)][_0x5720b8(0x152)]);}catch(_0x7b253e){throw new common_1[(_0x5720b8(0x189))](((_0x175eee=_0x7b253e===null||_0x7b253e===void 0x0?void 0x0:_0x7b253e['data'])===null||_0x175eee===void 0x0?void 0x0:_0x175eee[_0x5720b8(0x185)])||_0x5720b8(0x16d),common_1[_0x5720b8(0x18b)][_0x5720b8(0x152)]);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x15887b(0x192)])(verifycation_entity_1['VerifycationEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],globalConfig_service_1[_0x15887b(0x16e)],redisCache_service_1[_0x15887b(0x18f)]])],VerificationService),exports[_0x15887b(0x188)]=VerificationService;