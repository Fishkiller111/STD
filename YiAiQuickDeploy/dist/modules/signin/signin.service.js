'use strict';const _0x48d378=_0x5245;(function(_0x3513af,_0x5dafc1){const _0x44c927=_0x5245,_0x192ae4=_0x3513af();while(!![]){try{const _0x3ba3b7=-parseInt(_0x44c927(0x168))/0x1*(-parseInt(_0x44c927(0x172))/0x2)+parseInt(_0x44c927(0x17a))/0x3*(-parseInt(_0x44c927(0x14f))/0x4)+-parseInt(_0x44c927(0x18b))/0x5*(parseInt(_0x44c927(0x187))/0x6)+-parseInt(_0x44c927(0x179))/0x7*(parseInt(_0x44c927(0x181))/0x8)+parseInt(_0x44c927(0x166))/0x9+-parseInt(_0x44c927(0x17b))/0xa*(parseInt(_0x44c927(0x183))/0xb)+-parseInt(_0x44c927(0x151))/0xc*(-parseInt(_0x44c927(0x15d))/0xd);if(_0x3ba3b7===_0x5dafc1)break;else _0x192ae4['push'](_0x192ae4['shift']());}catch(_0x5bf1d5){_0x192ae4['push'](_0x192ae4['shift']());}}}(_0x2baa,0xdf99b));var __decorate=this&&this['__decorate']||function(_0x668801,_0x1a1d48,_0x186507,_0x1d4118){const _0x14e9cd=_0x5245;var _0x1fc358=arguments[_0x14e9cd(0x188)],_0x67dc20=_0x1fc358<0x3?_0x1a1d48:_0x1d4118===null?_0x1d4118=Object[_0x14e9cd(0x177)](_0x1a1d48,_0x186507):_0x1d4118,_0x4ff521;if(typeof Reflect==='object'&&typeof Reflect[_0x14e9cd(0x148)]===_0x14e9cd(0x15e))_0x67dc20=Reflect['decorate'](_0x668801,_0x1a1d48,_0x186507,_0x1d4118);else{for(var _0x51fc13=_0x668801[_0x14e9cd(0x188)]-0x1;_0x51fc13>=0x0;_0x51fc13--)if(_0x4ff521=_0x668801[_0x51fc13])_0x67dc20=(_0x1fc358<0x3?_0x4ff521(_0x67dc20):_0x1fc358>0x3?_0x4ff521(_0x1a1d48,_0x186507,_0x67dc20):_0x4ff521(_0x1a1d48,_0x186507))||_0x67dc20;}return _0x1fc358>0x3&&_0x67dc20&&Object['defineProperty'](_0x1a1d48,_0x186507,_0x67dc20),_0x67dc20;},__metadata=this&&this[_0x48d378(0x17d)]||function(_0x1af182,_0x2bfe74){const _0x5253d2=_0x48d378;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x5253d2(0x15a)](_0x1af182,_0x2bfe74);},__param=this&&this[_0x48d378(0x17c)]||function(_0x2ed028,_0x91f23a){return function(_0x59125a,_0x2d95aa){_0x91f23a(_0x59125a,_0x2d95aa,_0x2ed028);};};function _0x5245(_0x533127,_0x544d99){const _0x2baacd=_0x2baa();return _0x5245=function(_0x5245bb,_0x3972bd){_0x5245bb=_0x5245bb-0x146;let _0x2cc1ca=_0x2baacd[_0x5245bb];return _0x2cc1ca;},_0x5245(_0x533127,_0x544d99);}Object[_0x48d378(0x186)](exports,_0x48d378(0x16d),{'value':!![]}),exports[_0x48d378(0x16f)]=void 0x0;const globalConfig_service_1=require(_0x48d378(0x164)),userBalance_service_1=require(_0x48d378(0x18f)),common_1=require(_0x48d378(0x167)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x48d378(0x17f)),typeorm_2=require(_0x48d378(0x171)),date_1=require('../../common/utils/date'),user_entity_1=require(_0x48d378(0x161)),balance_constant_1=require('../../common/constants/balance.constant');function _0x2baa(){const _0x327058=['10815441DNemVi','639JbsWJm','5908790NzWaCy','__param','__metadata','endOf','@nestjs/typeorm','find','8QrOGzq','save','22QrGDFP','design:paramtypes','day','defineProperty','1914gFbZLv','length','sign','BAD_REQUEST','17210kfwFbr','format','UserBalanceService','saveRecordRechargeLog','../userBalance/userBalance.service','HttpStatus','signinEntity','debug','getDate','decorate','RechargeType','subtract','Repository','Logger','andWhere','signin.userId\x20=\x20:userId','10156MGryWw','userBalanceService','51743508BBVcge','YYYY-MM-DD\x20HH:mm:ss','globalConfigService','用户不存在','getSigninLog','昨天没签到、今天重置天数！','error:\x20','user','isSigned','metadata','Sign\x20in\x20successful.','signInDate','13cUJGmy','function','UserEntity','userEntity','../user/user.entity','default','Injectable','../globalConfig/globalConfig.service','昨天签到了、今天是连续签到！','8496342SfEKLI','@nestjs/common','6374iKoDkh','month','InjectRepository','SigninEntity','addBalanceToUser','__esModule','YYYY-MM-DD','SigninService','HttpException','typeorm','8VfcEdO','push','startOf','log','update','getOwnPropertyDescriptor','findOne'];_0x2baa=function(){return _0x327058;};return _0x2baa();}let SigninService=class SigninService{constructor(_0x189d04,_0x407170,_0x75ded1,_0x45ab4e){const _0x4c4683=_0x48d378;this[_0x4c4683(0x191)]=_0x189d04,this['userEntity']=_0x407170,this[_0x4c4683(0x150)]=_0x75ded1,this['globalConfigService']=_0x45ab4e;}async[_0x48d378(0x189)](_0x2aa8c8){const _0x52d139=_0x48d378,{id:_0x167ec5}=_0x2aa8c8[_0x52d139(0x158)],_0x513300=(0x0,date_1[_0x52d139(0x162)])(new Date())['format'](_0x52d139(0x16e)),_0xafd051=await this['signinEntity'][_0x52d139(0x178)]({'where':{'userId':_0x167ec5,'signInDate':_0x513300}});if(_0xafd051)throw new common_1[(_0x52d139(0x170))]('今日已签到、改天再来吧!.',common_1[_0x52d139(0x190)][_0x52d139(0x18a)]);const {model3Count:_0x45232a,model4Count:_0x2e8e4e,drawMjCount:_0x50d4f9}=await this[_0x52d139(0x153)]['getSignatureGiftConfig']();await this['signinEntity'][_0x52d139(0x182)]({'userId':_0x167ec5,'signInTime':new Date(),'signInDate':_0x513300,'isSigned':!![]}),await this[_0x52d139(0x150)][_0x52d139(0x16c)](_0x167ec5,{'model3Count':_0x45232a,'model4Count':_0x2e8e4e,'drawMjCount':_0x50d4f9}),await this[_0x52d139(0x150)][_0x52d139(0x18e)]({'userId':_0x167ec5,'rechargeType':balance_constant_1[_0x52d139(0x149)]['SIGN_IN'],'model3Count':_0x45232a,'model4Count':_0x2e8e4e,'drawMjCount':_0x50d4f9});const _0x10cb05=(0x0,date_1[_0x52d139(0x162)])(new Date())[_0x52d139(0x14a)](0x1,_0x52d139(0x185))[_0x52d139(0x18c)](_0x52d139(0x16e)),_0x42e8a0=await this[_0x52d139(0x191)][_0x52d139(0x178)]({'where':{'userId':_0x167ec5,'signInDate':_0x10cb05}});if(_0x42e8a0){common_1[_0x52d139(0x14c)][_0x52d139(0x146)]('用户'+_0x167ec5+_0x52d139(0x165),_0x52d139(0x16f));const _0x56166d=await this[_0x52d139(0x160)][_0x52d139(0x178)]({'where':{'id':_0x167ec5}});if(!_0x56166d)throw new common_1[(_0x52d139(0x170))](_0x52d139(0x154),common_1['HttpStatus'][_0x52d139(0x18a)]);const {consecutiveDays:consecutiveDays=0x0}=_0x56166d;await this[_0x52d139(0x160)][_0x52d139(0x176)]({'id':_0x167ec5},{'consecutiveDays':consecutiveDays+0x1});}else common_1['Logger'][_0x52d139(0x146)]('用户'+_0x167ec5+_0x52d139(0x156),'SigninService'),await this[_0x52d139(0x160)][_0x52d139(0x176)]({'id':_0x167ec5},{'consecutiveDays':0x1});return _0x52d139(0x15b);}async[_0x48d378(0x155)](_0xa809dd){const _0x3bdc06=_0x48d378;try{const {id:_0x2bc3c4}=_0xa809dd['user'],_0xd13e78=(0x0,date_1['default'])()[_0x3bdc06(0x174)](_0x3bdc06(0x169))[_0x3bdc06(0x18c)](_0x3bdc06(0x152)),_0x4514c9=(0x0,date_1['default'])()[_0x3bdc06(0x17e)](_0x3bdc06(0x169))[_0x3bdc06(0x18c)](_0x3bdc06(0x152)),_0x39dc5c=this[_0x3bdc06(0x191)]['createQueryBuilder']('signin'),_0x2e1b38=await _0x39dc5c['select']('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')[_0x3bdc06(0x14d)](_0x3bdc06(0x14e),{'userId':_0xa809dd[_0x3bdc06(0x158)]['id']})[_0x3bdc06(0x14d)]('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0xd13e78})[_0x3bdc06(0x14d)]('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0x4514c9})['getRawMany'](),_0x43b1c8=new Date(_0xd13e78),_0x232cc2=new Date(_0x4514c9),_0x1e9655=[],_0x2a124c=new Date(_0x43b1c8);while(_0x2a124c<=_0x232cc2){_0x1e9655[_0x3bdc06(0x173)]((0x0,date_1[_0x3bdc06(0x162)])(new Date(_0x2a124c))['format'](_0x3bdc06(0x16e))),_0x2a124c['setDate'](_0x2a124c[_0x3bdc06(0x147)]()+0x1);}const _0x4849eb=[];for(const _0xeda756 of _0x1e9655){const _0x48341c=_0x2e1b38[_0x3bdc06(0x180)](_0x2d613a=>_0x2d613a[_0x3bdc06(0x15c)]===_0xeda756);!_0x48341c?_0x4849eb[_0x3bdc06(0x173)]({'signInDate':_0xeda756,'isSigned':![]}):(_0x48341c[_0x3bdc06(0x159)]=!![],_0x4849eb['push'](_0x48341c));}return _0x4849eb;}catch(_0x118764){console[_0x3bdc06(0x175)](_0x3bdc06(0x157),_0x118764);throw new common_1['HttpException']('获取签到数据失败！',common_1[_0x3bdc06(0x190)][_0x3bdc06(0x18a)]);}}};SigninService=__decorate([(0x0,common_1[_0x48d378(0x163)])(),__param(0x0,(0x0,typeorm_1[_0x48d378(0x16a)])(signIn_entity_1[_0x48d378(0x16b)])),__param(0x1,(0x0,typeorm_1[_0x48d378(0x16a)])(user_entity_1[_0x48d378(0x15f)])),__metadata(_0x48d378(0x184),[typeorm_2[_0x48d378(0x14b)],typeorm_2[_0x48d378(0x14b)],userBalance_service_1[_0x48d378(0x18d)],globalConfig_service_1['GlobalConfigService']])],SigninService),exports[_0x48d378(0x16f)]=SigninService;