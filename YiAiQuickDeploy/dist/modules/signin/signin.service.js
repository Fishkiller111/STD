'use strict';const _0x2570d9=_0x467c;function _0x31f4(){const _0x1a6640=['getDate','getRawMany','677936hSxtTu','createQueryBuilder','getSignatureGiftConfig','SigninService','Logger','debug','1623402tItyxo','昨天签到了、今天是连续签到！','@nestjs/common','findOne','isSigned','userBalanceService','__decorate','object','GlobalConfigService','../../common/constants/balance.constant','30564oclrzH','@nestjs/typeorm','push','endOf','globalConfigService','../userBalance/userBalance.service','error:\x20','getOwnPropertyDescriptor','BAD_REQUEST','function','UserEntity','signinEntity','day','metadata','signin.signInTime\x20<=\x20:lastDay','defineProperty','__metadata','用户不存在','user','signin','signInDate','RechargeType','获取签到数据失败！','YYYY-MM-DD','1334396GiHoJi','sign','../../common/utils/date','select','setDate','signin.signInTime\x20>=\x20:firstDay','default','634976hhrHLx','userEntity','HttpStatus','YYYY-MM-DD\x20HH:mm:ss','Repository','decorate','design:paramtypes','andWhere','HttpException','SIGN_IN','../user/user.entity','837430PVTqYg','12IFhehw','108ScLPxs','getSigninLog','今日已签到、改天再来吧!.','../globalConfig/globalConfig.service','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','format','signin.userId\x20=\x20:userId','update','save','__param','308324puZJLk','Injectable','saveRecordRechargeLog','昨天没签到、今天重置天数！','subtract'];_0x31f4=function(){return _0x1a6640;};return _0x31f4();}(function(_0x523d71,_0x1ef292){const _0x2989f6=_0x467c,_0x3a3fa9=_0x523d71();while(!![]){try{const _0x2478fa=-parseInt(_0x2989f6(0x187))/0x1+parseInt(_0x2989f6(0x19e))/0x2*(-parseInt(_0x2989f6(0x17c))/0x3)+-parseInt(_0x2989f6(0x18e))/0x4+-parseInt(_0x2989f6(0x17b))/0x5+-parseInt(_0x2989f6(0x194))/0x6+parseInt(_0x2989f6(0x1b6))/0x7+-parseInt(_0x2989f6(0x1bd))/0x8*(-parseInt(_0x2989f6(0x17d))/0x9);if(_0x2478fa===_0x1ef292)break;else _0x3a3fa9['push'](_0x3a3fa9['shift']());}catch(_0x3a2c13){_0x3a3fa9['push'](_0x3a3fa9['shift']());}}}(_0x31f4,0x288d7));var __decorate=this&&this[_0x2570d9(0x19a)]||function(_0x56d01b,_0x1aa359,_0x438a47,_0x59675d){const _0x5b5adc=_0x2570d9;var _0x5d507c=arguments['length'],_0x313373=_0x5d507c<0x3?_0x1aa359:_0x59675d===null?_0x59675d=Object[_0x5b5adc(0x1a5)](_0x1aa359,_0x438a47):_0x59675d,_0x166510;if(typeof Reflect===_0x5b5adc(0x19b)&&typeof Reflect['decorate']==='function')_0x313373=Reflect[_0x5b5adc(0x1c2)](_0x56d01b,_0x1aa359,_0x438a47,_0x59675d);else{for(var _0x31d09f=_0x56d01b['length']-0x1;_0x31d09f>=0x0;_0x31d09f--)if(_0x166510=_0x56d01b[_0x31d09f])_0x313373=(_0x5d507c<0x3?_0x166510(_0x313373):_0x5d507c>0x3?_0x166510(_0x1aa359,_0x438a47,_0x313373):_0x166510(_0x1aa359,_0x438a47))||_0x313373;}return _0x5d507c>0x3&&_0x313373&&Object[_0x5b5adc(0x1ad)](_0x1aa359,_0x438a47,_0x313373),_0x313373;},__metadata=this&&this[_0x2570d9(0x1ae)]||function(_0x15134,_0x45380c){const _0x165ed3=_0x2570d9;if(typeof Reflect===_0x165ed3(0x19b)&&typeof Reflect[_0x165ed3(0x1ab)]===_0x165ed3(0x1a7))return Reflect[_0x165ed3(0x1ab)](_0x15134,_0x45380c);},__param=this&&this[_0x2570d9(0x186)]||function(_0x567b1d,_0x53145e){return function(_0x481919,_0x2941ef){_0x53145e(_0x481919,_0x2941ef,_0x567b1d);};};Object[_0x2570d9(0x1ad)](exports,'__esModule',{'value':!![]}),exports[_0x2570d9(0x191)]=void 0x0;const globalConfig_service_1=require(_0x2570d9(0x180)),userBalance_service_1=require(_0x2570d9(0x1a3)),common_1=require(_0x2570d9(0x196)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x2570d9(0x19f)),typeorm_2=require('typeorm'),date_1=require(_0x2570d9(0x1b8)),user_entity_1=require(_0x2570d9(0x17a)),balance_constant_1=require(_0x2570d9(0x19d));let SigninService=class SigninService{constructor(_0x33f66b,_0x191928,_0x5ad38b,_0x113eb5){const _0x2195fb=_0x2570d9;this[_0x2195fb(0x1a9)]=_0x33f66b,this[_0x2195fb(0x1be)]=_0x191928,this[_0x2195fb(0x199)]=_0x5ad38b,this[_0x2195fb(0x1a2)]=_0x113eb5;}async[_0x2570d9(0x1b7)](_0x5c0e2e){const _0x5b0846=_0x2570d9,{id:_0x40839b}=_0x5c0e2e[_0x5b0846(0x1b0)],_0x2b5be7=(0x0,date_1[_0x5b0846(0x1bc)])(new Date())[_0x5b0846(0x182)](_0x5b0846(0x1b5)),_0x552cef=await this['signinEntity']['findOne']({'where':{'userId':_0x40839b,'signInDate':_0x2b5be7}});if(_0x552cef)throw new common_1[(_0x5b0846(0x178))](_0x5b0846(0x17f),common_1[_0x5b0846(0x1bf)]['BAD_REQUEST']);const {model3Count:_0x5c5878,model4Count:_0x525aa7,drawMjCount:_0x2f9235}=await this[_0x5b0846(0x1a2)][_0x5b0846(0x190)]();await this['signinEntity'][_0x5b0846(0x185)]({'userId':_0x40839b,'signInTime':new Date(),'signInDate':_0x2b5be7,'isSigned':!![]}),await this['userBalanceService']['addBalanceToUser'](_0x40839b,{'model3Count':_0x5c5878,'model4Count':_0x525aa7,'drawMjCount':_0x2f9235}),await this[_0x5b0846(0x199)][_0x5b0846(0x189)]({'userId':_0x40839b,'rechargeType':balance_constant_1[_0x5b0846(0x1b3)][_0x5b0846(0x179)],'model3Count':_0x5c5878,'model4Count':_0x525aa7,'drawMjCount':_0x2f9235});const _0x5c792e=(0x0,date_1['default'])(new Date())[_0x5b0846(0x18b)](0x1,_0x5b0846(0x1aa))['format'](_0x5b0846(0x1b5)),_0x519159=await this[_0x5b0846(0x1a9)][_0x5b0846(0x197)]({'where':{'userId':_0x40839b,'signInDate':_0x5c792e}});if(_0x519159){common_1['Logger']['debug']('用户'+_0x40839b+_0x5b0846(0x195),_0x5b0846(0x191));const _0x5f370f=await this[_0x5b0846(0x1be)][_0x5b0846(0x197)]({'where':{'id':_0x40839b}});if(!_0x5f370f)throw new common_1['HttpException'](_0x5b0846(0x1af),common_1[_0x5b0846(0x1bf)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x5f370f;await this['userEntity'][_0x5b0846(0x184)]({'id':_0x40839b},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x5b0846(0x192)][_0x5b0846(0x193)]('用户'+_0x40839b+_0x5b0846(0x18a),_0x5b0846(0x191)),await this[_0x5b0846(0x1be)]['update']({'id':_0x40839b},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async[_0x2570d9(0x17e)](_0x1d4fb6){const _0x2f70c2=_0x2570d9;try{const {id:_0xf2b297}=_0x1d4fb6[_0x2f70c2(0x1b0)],_0x581f8c=(0x0,date_1[_0x2f70c2(0x1bc)])()['startOf']('month')[_0x2f70c2(0x182)](_0x2f70c2(0x1c0)),_0x360bd4=(0x0,date_1['default'])()[_0x2f70c2(0x1a1)]('month')[_0x2f70c2(0x182)](_0x2f70c2(0x1c0)),_0x234250=this['signinEntity'][_0x2f70c2(0x18f)](_0x2f70c2(0x1b1)),_0x54c098=await _0x234250[_0x2f70c2(0x1b9)](_0x2f70c2(0x181))['andWhere'](_0x2f70c2(0x183),{'userId':_0x1d4fb6['user']['id']})['andWhere'](_0x2f70c2(0x1bb),{'firstDay':_0x581f8c})[_0x2f70c2(0x177)](_0x2f70c2(0x1ac),{'lastDay':_0x360bd4})[_0x2f70c2(0x18d)](),_0x50a740=new Date(_0x581f8c),_0x350360=new Date(_0x360bd4),_0x35588a=[],_0x5810f0=new Date(_0x50a740);while(_0x5810f0<=_0x350360){_0x35588a[_0x2f70c2(0x1a0)]((0x0,date_1['default'])(new Date(_0x5810f0))['format'](_0x2f70c2(0x1b5))),_0x5810f0[_0x2f70c2(0x1ba)](_0x5810f0[_0x2f70c2(0x18c)]()+0x1);}const _0x4a0ed6=[];for(const _0x5a867c of _0x35588a){const _0x13b720=_0x54c098['find'](_0x2252e1=>_0x2252e1[_0x2f70c2(0x1b2)]===_0x5a867c);!_0x13b720?_0x4a0ed6[_0x2f70c2(0x1a0)]({'signInDate':_0x5a867c,'isSigned':![]}):(_0x13b720[_0x2f70c2(0x198)]=!![],_0x4a0ed6[_0x2f70c2(0x1a0)](_0x13b720));}return _0x4a0ed6;}catch(_0x8dbcfe){console['log'](_0x2f70c2(0x1a4),_0x8dbcfe);throw new common_1['HttpException'](_0x2f70c2(0x1b4),common_1['HttpStatus'][_0x2f70c2(0x1a6)]);}}};function _0x467c(_0x189475,_0x415f59){const _0x31f499=_0x31f4();return _0x467c=function(_0x467c4b,_0xe52938){_0x467c4b=_0x467c4b-0x176;let _0x26530b=_0x31f499[_0x467c4b];return _0x26530b;},_0x467c(_0x189475,_0x415f59);}SigninService=__decorate([(0x0,common_1[_0x2570d9(0x188)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1['SigninEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x2570d9(0x1a8)])),__metadata(_0x2570d9(0x176),[typeorm_2[_0x2570d9(0x1c1)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x2570d9(0x19c)]])],SigninService),exports[_0x2570d9(0x191)]=SigninService;