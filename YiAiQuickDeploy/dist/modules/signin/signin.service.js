'use strict';const _0x5b01d4=_0x1e4c;function _0x1e4c(_0x589bd9,_0x79991){const _0x402f87=_0x402f();return _0x1e4c=function(_0x1e4cf4,_0x28ff2d){_0x1e4cf4=_0x1e4cf4-0x97;let _0x148f86=_0x402f87[_0x1e4cf4];return _0x148f86;},_0x1e4c(_0x589bd9,_0x79991);}function _0x402f(){const _0x2d3cf4=['SigninService','./signIn.entity','865624mTJnyl','HttpStatus','signInDate','log','208CwaLRE','../user/user.entity','15253018MRxOZU','saveRecordRechargeLog','user','findOne','Logger','YYYY-MM-DD\x20HH:mm:ss','GlobalConfigService','9hSlPZu','../../common/constants/balance.constant','650266SrpRsj','object','error:\x20','sign','defineProperty','format','@nestjs/typeorm','update','debug','HttpException','今日已签到、改天再来吧!.','subtract','signinEntity','__metadata','createQueryBuilder','UserBalanceService','__decorate','design:paramtypes','signin.signInTime\x20>=\x20:firstDay','select','setDate','1683245BvjjQW','Sign\x20in\x20successful.','../globalConfig/globalConfig.service','month','712104fAzVXz','@nestjs/common','UserEntity','Repository','__esModule','Injectable','../../common/utils/date','typeorm','save','default','getSigninLog','3387rPmXcG','BAD_REQUEST','12zaWCED','push','InjectRepository','getOwnPropertyDescriptor','12omkAev','../userBalance/userBalance.service','YYYY-MM-DD','signin.userId\x20=\x20:userId','昨天没签到、今天重置天数！','metadata','49zJBsrw','2324390NiKVbk','andWhere','function','day','userBalanceService','获取签到数据失败！','globalConfigService','userEntity','decorate','signin.signInTime\x20<=\x20:lastDay','addBalanceToUser'];_0x402f=function(){return _0x2d3cf4;};return _0x402f();}(function(_0x463b96,_0x163fce){const _0x41c4ed=_0x1e4c,_0x3ab383=_0x463b96();while(!![]){try{const _0x42fe95=-parseInt(_0x41c4ed(0xa7))/0x1+parseInt(_0x41c4ed(0x9c))/0x2*(parseInt(_0x41c4ed(0xcb))/0x3)+-parseInt(_0x41c4ed(0x98))/0x4+-parseInt(_0x41c4ed(0xbc))/0x5*(-parseInt(_0x41c4ed(0xcd))/0x6)+-parseInt(_0x41c4ed(0xd7))/0x7*(parseInt(_0x41c4ed(0xc0))/0x8)+parseInt(_0x41c4ed(0xa5))/0x9*(-parseInt(_0x41c4ed(0xd8))/0xa)+-parseInt(_0x41c4ed(0x9e))/0xb*(-parseInt(_0x41c4ed(0xd1))/0xc);if(_0x42fe95===_0x163fce)break;else _0x3ab383['push'](_0x3ab383['shift']());}catch(_0x9a598f){_0x3ab383['push'](_0x3ab383['shift']());}}}(_0x402f,0x6f1ee));var __decorate=this&&this[_0x5b01d4(0xb7)]||function(_0x352bc3,_0x4860d4,_0x133ce9,_0x8ad328){const _0x5552a1=_0x5b01d4;var _0x30a63e=arguments['length'],_0x238c17=_0x30a63e<0x3?_0x4860d4:_0x8ad328===null?_0x8ad328=Object[_0x5552a1(0xd0)](_0x4860d4,_0x133ce9):_0x8ad328,_0x5543ee;if(typeof Reflect===_0x5552a1(0xa8)&&typeof Reflect[_0x5552a1(0xe0)]===_0x5552a1(0xda))_0x238c17=Reflect[_0x5552a1(0xe0)](_0x352bc3,_0x4860d4,_0x133ce9,_0x8ad328);else{for(var _0x12fc72=_0x352bc3['length']-0x1;_0x12fc72>=0x0;_0x12fc72--)if(_0x5543ee=_0x352bc3[_0x12fc72])_0x238c17=(_0x30a63e<0x3?_0x5543ee(_0x238c17):_0x30a63e>0x3?_0x5543ee(_0x4860d4,_0x133ce9,_0x238c17):_0x5543ee(_0x4860d4,_0x133ce9))||_0x238c17;}return _0x30a63e>0x3&&_0x238c17&&Object[_0x5552a1(0xab)](_0x4860d4,_0x133ce9,_0x238c17),_0x238c17;},__metadata=this&&this[_0x5b01d4(0xb4)]||function(_0x8bb513,_0x105169){const _0x5b998c=_0x5b01d4;if(typeof Reflect===_0x5b998c(0xa8)&&typeof Reflect[_0x5b998c(0xd6)]===_0x5b998c(0xda))return Reflect[_0x5b998c(0xd6)](_0x8bb513,_0x105169);},__param=this&&this['__param']||function(_0x18b230,_0x47565a){return function(_0x4036f3,_0x126b53){_0x47565a(_0x4036f3,_0x126b53,_0x18b230);};};Object['defineProperty'](exports,_0x5b01d4(0xc4),{'value':!![]}),exports['SigninService']=void 0x0;const globalConfig_service_1=require(_0x5b01d4(0xbe)),userBalance_service_1=require(_0x5b01d4(0xd2)),common_1=require(_0x5b01d4(0xc1)),signIn_entity_1=require(_0x5b01d4(0x97)),typeorm_1=require(_0x5b01d4(0xad)),typeorm_2=require(_0x5b01d4(0xc7)),date_1=require(_0x5b01d4(0xc6)),user_entity_1=require(_0x5b01d4(0x9d)),balance_constant_1=require(_0x5b01d4(0xa6));let SigninService=class SigninService{constructor(_0x43026d,_0x4e9013,_0xfd671e,_0x1b608a){const _0x461e22=_0x5b01d4;this[_0x461e22(0xb3)]=_0x43026d,this['userEntity']=_0x4e9013,this['userBalanceService']=_0xfd671e,this[_0x461e22(0xde)]=_0x1b608a;}async[_0x5b01d4(0xaa)](_0x2ea0ca){const _0x561db4=_0x5b01d4,{id:_0x388a5e}=_0x2ea0ca[_0x561db4(0xa0)],_0x3d9323=(0x0,date_1['default'])(new Date())[_0x561db4(0xac)](_0x561db4(0xd3)),_0x143b56=await this['signinEntity'][_0x561db4(0xa1)]({'where':{'userId':_0x388a5e,'signInDate':_0x3d9323}});if(_0x143b56)throw new common_1[(_0x561db4(0xb0))](_0x561db4(0xb1),common_1[_0x561db4(0x99)][_0x561db4(0xcc)]);const {model3Count:_0x5d23d0,model4Count:_0x2f510b,drawMjCount:_0x2c5e4e}=await this[_0x561db4(0xde)]['getSignatureGiftConfig']();await this[_0x561db4(0xb3)][_0x561db4(0xc8)]({'userId':_0x388a5e,'signInTime':new Date(),'signInDate':_0x3d9323,'isSigned':!![]}),await this[_0x561db4(0xdc)][_0x561db4(0xe2)](_0x388a5e,{'model3Count':_0x5d23d0,'model4Count':_0x2f510b,'drawMjCount':_0x2c5e4e}),await this[_0x561db4(0xdc)][_0x561db4(0x9f)]({'userId':_0x388a5e,'rechargeType':balance_constant_1['RechargeType']['SIGN_IN'],'model3Count':_0x5d23d0,'model4Count':_0x2f510b,'drawMjCount':_0x2c5e4e});const _0x30c73b=(0x0,date_1[_0x561db4(0xc9)])(new Date())[_0x561db4(0xb2)](0x1,_0x561db4(0xdb))[_0x561db4(0xac)]('YYYY-MM-DD'),_0x4d285d=await this[_0x561db4(0xb3)][_0x561db4(0xa1)]({'where':{'userId':_0x388a5e,'signInDate':_0x30c73b}});if(_0x4d285d){common_1[_0x561db4(0xa2)][_0x561db4(0xaf)]('用户'+_0x388a5e+'昨天签到了、今天是连续签到！',_0x561db4(0xe3));const _0x40f6c8=await this[_0x561db4(0xdf)]['findOne']({'where':{'id':_0x388a5e}});if(!_0x40f6c8)throw new common_1[(_0x561db4(0xb0))]('用户不存在',common_1[_0x561db4(0x99)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x40f6c8;await this[_0x561db4(0xdf)][_0x561db4(0xae)]({'id':_0x388a5e},{'consecutiveDays':consecutiveDays+0x1});}else common_1[_0x561db4(0xa2)]['debug']('用户'+_0x388a5e+_0x561db4(0xd5),_0x561db4(0xe3)),await this[_0x561db4(0xdf)]['update']({'id':_0x388a5e},{'consecutiveDays':0x1});return _0x561db4(0xbd);}async[_0x5b01d4(0xca)](_0x27b30a){const _0x40e088=_0x5b01d4;try{const {id:_0x2fcc48}=_0x27b30a[_0x40e088(0xa0)],_0x238ec9=(0x0,date_1['default'])()['startOf'](_0x40e088(0xbf))[_0x40e088(0xac)]('YYYY-MM-DD\x20HH:mm:ss'),_0x40b571=(0x0,date_1['default'])()['endOf']('month')[_0x40e088(0xac)](_0x40e088(0xa3)),_0x1b5748=this['signinEntity'][_0x40e088(0xb5)]('signin'),_0x4140a1=await _0x1b5748[_0x40e088(0xba)]('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')[_0x40e088(0xd9)](_0x40e088(0xd4),{'userId':_0x27b30a[_0x40e088(0xa0)]['id']})[_0x40e088(0xd9)](_0x40e088(0xb9),{'firstDay':_0x238ec9})[_0x40e088(0xd9)](_0x40e088(0xe1),{'lastDay':_0x40b571})['getRawMany'](),_0x8cf68f=new Date(_0x238ec9),_0x4c7997=new Date(_0x40b571),_0x32b6e6=[],_0xc00c04=new Date(_0x8cf68f);while(_0xc00c04<=_0x4c7997){_0x32b6e6['push']((0x0,date_1[_0x40e088(0xc9)])(new Date(_0xc00c04))['format'](_0x40e088(0xd3))),_0xc00c04[_0x40e088(0xbb)](_0xc00c04['getDate']()+0x1);}const _0x43e88a=[];for(const _0x36127c of _0x32b6e6){const _0x55a230=_0x4140a1['find'](_0xd6e54d=>_0xd6e54d[_0x40e088(0x9a)]===_0x36127c);!_0x55a230?_0x43e88a[_0x40e088(0xce)]({'signInDate':_0x36127c,'isSigned':![]}):(_0x55a230['isSigned']=!![],_0x43e88a[_0x40e088(0xce)](_0x55a230));}return _0x43e88a;}catch(_0x21cea7){console[_0x40e088(0x9b)](_0x40e088(0xa9),_0x21cea7);throw new common_1['HttpException'](_0x40e088(0xdd),common_1[_0x40e088(0x99)][_0x40e088(0xcc)]);}}};SigninService=__decorate([(0x0,common_1[_0x5b01d4(0xc5)])(),__param(0x0,(0x0,typeorm_1[_0x5b01d4(0xcf)])(signIn_entity_1['SigninEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x5b01d4(0xc2)])),__metadata(_0x5b01d4(0xb8),[typeorm_2[_0x5b01d4(0xc3)],typeorm_2[_0x5b01d4(0xc3)],userBalance_service_1[_0x5b01d4(0xb6)],globalConfig_service_1[_0x5b01d4(0xa4)]])],SigninService),exports[_0x5b01d4(0xe3)]=SigninService;