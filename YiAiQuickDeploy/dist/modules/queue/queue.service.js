'use strict';function _0x33a2(_0x55589e,_0x39e02a){const _0x1ee3fb=_0x1ee3();return _0x33a2=function(_0x33a263,_0x14a405){_0x33a263=_0x33a263-0xff;let _0x4d8867=_0x1ee3fb[_0x33a263];return _0x4d8867;},_0x33a2(_0x55589e,_0x39e02a);}const _0x45f877=_0x33a2;(function(_0x1c6086,_0x36b9c6){const _0x1bcba2=_0x33a2,_0x55beec=_0x1c6086();while(!![]){try{const _0xbaa6c4=parseInt(_0x1bcba2(0x10b))/0x1+parseInt(_0x1bcba2(0x12b))/0x2+-parseInt(_0x1bcba2(0x127))/0x3+parseInt(_0x1bcba2(0x108))/0x4*(-parseInt(_0x1bcba2(0x12f))/0x5)+parseInt(_0x1bcba2(0x11e))/0x6+parseInt(_0x1bcba2(0x11b))/0x7+-parseInt(_0x1bcba2(0x125))/0x8*(parseInt(_0x1bcba2(0x128))/0x9);if(_0xbaa6c4===_0x36b9c6)break;else _0x55beec['push'](_0x55beec['shift']());}catch(_0x4ef0d7){_0x55beec['push'](_0x55beec['shift']());}}}(_0x1ee3,0x3be98));function _0x1ee3(){const _0x8d22d5=['getOwnPropertyDescriptor','clean','__metadata','addDrawQueue','jobIds','decorate','__esModule','__param','UPSCALE','checkLimit','QueueService','length','1746059GUviAN','function','@nestjs/bull','2629542qvjzdw','getConfigs','mjDrawQueue','midjourneyService','HttpException','../userBalance/userBalance.service','MidjourneyService','8qCNjBH','design:paramtypes','749268ubBVJc','6419781yQholf','mjDraw','user','521348umuHhx','BAD_REQUEST','缺少必要参数！','__decorate','265uildls','addMjDrawQueue','createRandomUid','../midjourney/midjourney.service','defineProperty','object','@nestjs/common','mjTimeoutMs','active','onApplicationBootstrap','UserBalanceService','validateBalance','InjectQueue','metadata','add','push','getDrawActionDetail','9508svOEvr','MJDRAW','cleanQueue','386078YoyHmn','globalConfigService','assign','../../common/utils'];_0x1ee3=function(){return _0x8d22d5;};return _0x1ee3();}var __decorate=this&&this[_0x45f877(0x12e)]||function(_0xc87b2c,_0x39b6bb,_0x3af98d,_0x1af095){const _0x1dc342=_0x45f877;var _0xc8ced4=arguments[_0x1dc342(0x11a)],_0x546913=_0xc8ced4<0x3?_0x39b6bb:_0x1af095===null?_0x1af095=Object[_0x1dc342(0x10f)](_0x39b6bb,_0x3af98d):_0x1af095,_0x4a7aca;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x1dc342(0x11c))_0x546913=Reflect[_0x1dc342(0x114)](_0xc87b2c,_0x39b6bb,_0x3af98d,_0x1af095);else{for(var _0x213ebb=_0xc87b2c['length']-0x1;_0x213ebb>=0x0;_0x213ebb--)if(_0x4a7aca=_0xc87b2c[_0x213ebb])_0x546913=(_0xc8ced4<0x3?_0x4a7aca(_0x546913):_0xc8ced4>0x3?_0x4a7aca(_0x39b6bb,_0x3af98d,_0x546913):_0x4a7aca(_0x39b6bb,_0x3af98d))||_0x546913;}return _0xc8ced4>0x3&&_0x546913&&Object[_0x1dc342(0x133)](_0x39b6bb,_0x3af98d,_0x546913),_0x546913;},__metadata=this&&this[_0x45f877(0x111)]||function(_0x4519bc,_0x14e75f){const _0x1dbeb3=_0x45f877;if(typeof Reflect===_0x1dbeb3(0x134)&&typeof Reflect[_0x1dbeb3(0x104)]===_0x1dbeb3(0x11c))return Reflect['metadata'](_0x4519bc,_0x14e75f);},__param=this&&this[_0x45f877(0x116)]||function(_0x32e1b2,_0xef4aa0){return function(_0x5a8411,_0x1b9640){_0xef4aa0(_0x5a8411,_0x1b9640,_0x32e1b2);};};Object['defineProperty'](exports,_0x45f877(0x115),{'value':!![]}),exports['QueueService']=void 0x0;const common_1=require(_0x45f877(0x135)),bull_1=require(_0x45f877(0x11d)),utils_1=require(_0x45f877(0x10e)),midjourney_service_1=require(_0x45f877(0x132)),userBalance_service_1=require(_0x45f877(0x123)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let QueueService=class QueueService{constructor(_0x44bd30,_0x105b4e,_0xe033a8,_0x5986c7){const _0x4a42aa=_0x45f877;this[_0x4a42aa(0x120)]=_0x44bd30,this[_0x4a42aa(0x121)]=_0x105b4e,this['userBalanceService']=_0xe033a8,this[_0x4a42aa(0x10c)]=_0x5986c7,this['jobIds']=[];}async[_0x45f877(0x100)](){const _0x2c3676=_0x45f877;await this[_0x2c3676(0x120)][_0x2c3676(0x110)](0x0,_0x2c3676(0xff)),await this[_0x2c3676(0x121)][_0x2c3676(0x10a)]();}async[_0x45f877(0x130)](_0x5aba93,_0x19b59a){const _0x422cc6=_0x45f877,{imgUrl:_0x238aa7,orderId:_0x5c0471,action:_0x245fb2,drawId:_0x2de4f2}=_0x5aba93;await this[_0x422cc6(0x121)][_0x422cc6(0x118)](_0x19b59a),await this['userBalanceService'][_0x422cc6(0x102)](_0x19b59a,_0x422cc6(0x129),_0x245fb2===_0x422cc6(0x117)?0x1:0x4);if(_0x245fb2==='IMAGINE'){const _0x4a5ba7=''+(0x0,utils_1[_0x422cc6(0x131)])(),_0x3aa12a=Object['assign'](Object[_0x422cc6(0x10d)]({},_0x5aba93),{'userId':_0x19b59a[_0x422cc6(0x12a)]['id'],'randomDrawId':_0x4a5ba7}),_0x1da125=await this['midjourneyService']['addDrawQueue'](_0x3aa12a),_0x1a2e3f=await this[_0x422cc6(0x10c)][_0x422cc6(0x11f)]([_0x422cc6(0x136)])||0x30d40,_0x586261=await this[_0x422cc6(0x120)][_0x422cc6(0x105)]('mjDraw',{'id':_0x1da125['id'],'action':_0x245fb2,'userId':_0x19b59a[_0x422cc6(0x12a)]['id']},{'delay':0x3e8,'timeout':+_0x1a2e3f});return this[_0x422cc6(0x113)][_0x422cc6(0x106)](_0x586261['id']),!![];}else{const {orderId:_0x47850f,action:_0x31c563,drawId:_0x3717b5}=_0x5aba93,_0x22d19f=await this['midjourneyService'][_0x422cc6(0x107)](_0x31c563,_0x3717b5,_0x47850f),_0x5b67ad=Object[_0x422cc6(0x10d)](Object[_0x422cc6(0x10d)](Object[_0x422cc6(0x10d)]({},_0x5aba93),{'userId':_0x19b59a[_0x422cc6(0x12a)]['id']}),_0x22d19f),_0x39e221=await this[_0x422cc6(0x121)][_0x422cc6(0x112)](_0x5b67ad),_0x5cfb97=await this[_0x422cc6(0x10c)][_0x422cc6(0x11f)]([_0x422cc6(0x136)])||0x30d40,_0x4cd2f0=await this['mjDrawQueue'][_0x422cc6(0x105)](_0x422cc6(0x129),{'id':_0x39e221['id'],'action':_0x31c563,'userId':_0x19b59a['user']['id']},{'delay':0x3e8,'timeout':+_0x5cfb97});this[_0x422cc6(0x113)][_0x422cc6(0x106)](_0x4cd2f0['id']);return;}if(!_0x2de4f2||!_0x5c0471)throw new common_1[(_0x422cc6(0x122))](_0x422cc6(0x12d),common_1['HttpStatus'][_0x422cc6(0x12c)]);}async['getQueue'](){const _0x477df3=_0x45f877;return{'jobIds':this[_0x477df3(0x113)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x45f877(0x103)])(_0x45f877(0x109))),__metadata(_0x45f877(0x126),[Object,midjourney_service_1[_0x45f877(0x124)],userBalance_service_1[_0x45f877(0x101)],globalConfig_service_1['GlobalConfigService']])],QueueService),exports[_0x45f877(0x119)]=QueueService;