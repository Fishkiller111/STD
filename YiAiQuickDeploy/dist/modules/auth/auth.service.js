'use strict';function _0x3dd6(){const _0x22355d=['jwtService','&registerSuccessEmailTeamName=','find','register','registerByPhone','127.0.0.1','registerSuccessEmailTeamName','text','saveToken','MailerService','createRandomUid','../userBalance/userBalance.service','/api/auth/registerSuccess?id=','updateUserStatus','#fff','5180arIlgw','sign','sendPhoneCode','response','验证码发送成功、请填写验证码完成注册！','updatePassword','userService','userDefautlAvatar','无权此操作！','ConfigEntity','verifyCaptcha','mailerService','@nestjs/jwt','HttpStatus','&registerFailEmailTitle=','visitor','__esModule','userId','__param','HttpException','getClientIp','registerFailEmailTeamName','UserStatusErrMsg','updatePassByOther','defineProperty','globalConfigService','&email=','getInfo','length','object','ttl','getNamespace','getIp','configKey','registerSuccessEmailTitle','createTokenFromFingerprint','JwtService','captcha','login','getConfigs','loginByOpenId','验证码已过期、请重新发送！','15588cPcXEG','../user/user.service','configEntity','verifyUserCredentials',':PHONECODE:','../globalConfig/globalConfig.service','3852EOXeal','redirect','getOwnPropertyDescriptor','decorate','createUserAndVerifycation','191883lDiHXk','address','../../common/constants/user.constant','registerFailEmailTitle','9322UHmxwH','createUser','client','onModuleInit','verifyUserPassword','configVal','savaLoginIp','redisCacheService','VerificationEnum','VerificationService','@nine.com','无权此操作、请联系管理员！','24276340GOaLWG','Repository','registerSuccessEmaileAppend','metadata',':CAPTCHA:','RedisCacheService','秒内不得重复发送短信！','Registration','internal','44aZpWdI','function','../mailer/mailer.service','验证码类型错误','账户已被激活过','password','qureyUserInfoByInviteCode','get','design:paramtypes','密码修改成功','updateUserPassword','59NkdxNs','ACTIVE','../redisCache/redisCache.service','addBalanceToNewUser','queryUserInfoById','verifyCode','userBalanceService','验证码填写错误、请重新输入！','2311344uXqNqk','createRandomCode','oldPassword','&registerSuccessEmaileAppend=','forEach','loginByPhone','&registerSuccessEmailTitle=','@nestjs/common','verificationService','createMathExpr','&username=','user','旧密码错误、请检查提交','family','4398032NqnJJC','getUserStatus','&registerFailEmailTeamName=','../verification/verification.service','740CfmOae','avatar','UserStatusEnum','set','AuthService','verifyUserRegisterByPhone','svg-captcha','keys','BAD_REQUEST','networkInterfaces'];_0x3dd6=function(){return _0x22355d;};return _0x3dd6();}const _0x206c7e=_0x1873;(function(_0x325640,_0xc987a3){const _0x856eaa=_0x1873,_0x1dfb79=_0x325640();while(!![]){try{const _0x2aa5d1=-parseInt(_0x856eaa(0x13a))/0x1*(parseInt(_0x856eaa(0x11a))/0x2)+-parseInt(_0x856eaa(0x116))/0x3*(parseInt(_0x856eaa(0x12f))/0x4)+parseInt(_0x856eaa(0x154))/0x5*(-parseInt(_0x856eaa(0x111))/0x6)+-parseInt(_0x856eaa(0x142))/0x7+parseInt(_0x856eaa(0x150))/0x8+parseInt(_0x856eaa(0x10b))/0x9*(-parseInt(_0x856eaa(0xe1))/0xa)+parseInt(_0x856eaa(0x126))/0xb;if(_0x2aa5d1===_0xc987a3)break;else _0x1dfb79['push'](_0x1dfb79['shift']());}catch(_0x3b6b43){_0x1dfb79['push'](_0x1dfb79['shift']());}}}(_0x3dd6,0x6f43c));var __decorate=this&&this['__decorate']||function(_0x48819c,_0x5bc5d8,_0x5f18ca,_0x20dcd6){const _0x5bf221=_0x1873;var _0x374464=arguments['length'],_0x2103e0=_0x374464<0x3?_0x5bc5d8:_0x20dcd6===null?_0x20dcd6=Object[_0x5bf221(0x113)](_0x5bc5d8,_0x5f18ca):_0x20dcd6,_0x539d9b;if(typeof Reflect===_0x5bf221(0xfe)&&typeof Reflect[_0x5bf221(0x114)]===_0x5bf221(0x130))_0x2103e0=Reflect['decorate'](_0x48819c,_0x5bc5d8,_0x5f18ca,_0x20dcd6);else{for(var _0x21ede8=_0x48819c[_0x5bf221(0xfd)]-0x1;_0x21ede8>=0x0;_0x21ede8--)if(_0x539d9b=_0x48819c[_0x21ede8])_0x2103e0=(_0x374464<0x3?_0x539d9b(_0x2103e0):_0x374464>0x3?_0x539d9b(_0x5bc5d8,_0x5f18ca,_0x2103e0):_0x539d9b(_0x5bc5d8,_0x5f18ca))||_0x2103e0;}return _0x374464>0x3&&_0x2103e0&&Object[_0x5bf221(0xf9)](_0x5bc5d8,_0x5f18ca,_0x2103e0),_0x2103e0;},__metadata=this&&this['__metadata']||function(_0x142a0f,_0x290f40){const _0x414d99=_0x1873;if(typeof Reflect===_0x414d99(0xfe)&&typeof Reflect[_0x414d99(0x129)]===_0x414d99(0x130))return Reflect['metadata'](_0x142a0f,_0x290f40);},__param=this&&this[_0x206c7e(0xf3)]||function(_0x2d8064,_0x29e86c){return function(_0x15abd6,_0x1d7f56){_0x29e86c(_0x15abd6,_0x1d7f56,_0x2d8064);};};function _0x1873(_0x1f023d,_0x1b2290){const _0x3dd6c0=_0x3dd6();return _0x1873=function(_0x1873ab,_0x12d2b5){_0x1873ab=_0x1873ab-0xda;let _0x214306=_0x3dd6c0[_0x1873ab];return _0x214306;},_0x1873(_0x1f023d,_0x1b2290);}Object[_0x206c7e(0xf9)](exports,_0x206c7e(0xf1),{'value':!![]}),exports[_0x206c7e(0x158)]=void 0x0;const globalConfig_service_1=require(_0x206c7e(0x110)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x206c7e(0x153)),common_1=require(_0x206c7e(0x149)),jwt_1=require(_0x206c7e(0xed)),user_service_1=require(_0x206c7e(0x10c)),mailer_service_1=require(_0x206c7e(0x131)),user_constant_1=require(_0x206c7e(0x118)),userBalance_service_1=require(_0x206c7e(0xdd)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require(_0x206c7e(0x13c)),svgCaptcha=require(_0x206c7e(0x15a)),bcrypt=require('bcryptjs');let AuthService=class AuthService{constructor(_0x134cd4,_0x26f223,_0x4304c9,_0x3c203b,_0x195f39,_0x8e0a4f,_0x16b3b8,_0x3244a4){const _0x5caa0b=_0x206c7e;this[_0x5caa0b(0x10d)]=_0x134cd4,this[_0x5caa0b(0xe7)]=_0x26f223,this[_0x5caa0b(0x15e)]=_0x4304c9,this[_0x5caa0b(0xec)]=_0x3c203b,this[_0x5caa0b(0x14a)]=_0x195f39,this[_0x5caa0b(0x140)]=_0x8e0a4f,this[_0x5caa0b(0x121)]=_0x16b3b8,this[_0x5caa0b(0xfa)]=_0x3244a4;}async[_0x206c7e(0x11d)](){const _0x507ea5=_0x206c7e;this[_0x507ea5(0x101)]();}async[_0x206c7e(0x161)](_0x2ddbdd,_0x5454dc){const _0x2c7683=_0x206c7e,_0xaa073d=await this[_0x2c7683(0xe7)][_0x2c7683(0x115)](_0x2ddbdd,_0x5454dc),{username:_0x560a78,email:_0xe2cd73,client:_0x52e7b0,id:_0x345f6e}=_0xaa073d,_0x22667e={'username':_0x560a78,'email':_0xe2cd73,'id':_0x345f6e};return _0x52e7b0&&(_0x22667e[_0x2c7683(0x11c)]=_0x52e7b0),_0x22667e;}async[_0x206c7e(0x162)](_0x33c8c4,_0x1a690e){const _0x160194=_0x206c7e,{username:_0x1059c4,password:_0x2e4ba2,phone:_0x160049,phoneCode:_0x50f8c6,invitedBy:_0x3552a4}=_0x33c8c4;await this[_0x160194(0xe7)][_0x160194(0x159)](_0x33c8c4);const _0x18f697=await this[_0x160194(0xfa)][_0x160194(0x100)](),_0x91537a=_0x18f697+':PHONECODE:'+_0x160049,_0xa695f1=await this['redisCacheService'][_0x160194(0x136)]({'key':_0x91537a});if(!_0xa695f1)throw new common_1[(_0x160194(0xf4))](_0x160194(0x10a),common_1[_0x160194(0xee)]['BAD_REQUEST']);if(_0x50f8c6!==_0xa695f1)throw new common_1['HttpException'](_0x160194(0x141),common_1[_0x160194(0xee)][_0x160194(0x15c)]);const _0x31aad3=(0x0,utils_1['createRandomUid'])()+_0x160194(0x124),_0x2857e0={'username':_0x1059c4,'password':_0x2e4ba2,'phone':_0x160049,'invitedBy':_0x3552a4,'email':_0x31aad3,'status':user_constant_1[_0x160194(0x156)]['ACTIVE']},_0x574944=await this['globalConfigService'][_0x160194(0x108)]([_0x160194(0xe8)]);_0x2857e0[_0x160194(0x155)]=_0x574944;const _0xfab7f0=bcrypt['hashSync'](_0x2e4ba2,0xa);_0x2857e0[_0x160194(0x134)]=_0xfab7f0;const _0x3a552a=await this['userService'][_0x160194(0x11b)](_0x2857e0);let _0x143694;_0x3552a4&&(_0x143694=await this[_0x160194(0xe7)][_0x160194(0x135)](_0x3552a4));await this[_0x160194(0x140)][_0x160194(0x13d)](_0x3a552a['id'],_0x143694===null||_0x143694===void 0x0?void 0x0:_0x143694['id']);return;}async[_0x206c7e(0x107)](_0x34a37c,_0x1ea9d1){const _0x1e9e2f=_0x206c7e,_0xa37e63=await this[_0x1e9e2f(0xe7)][_0x1e9e2f(0x10e)](_0x34a37c),{username:_0x31b8ef,id:_0x263108,email:_0x52d65d,role:_0x32421d,openId:_0x5152a7,client:_0x22155c}=_0xa37e63,_0x5614a5=(0x0,utils_1['getClientIp'])(_0x1ea9d1);await this['userService'][_0x1e9e2f(0x120)](_0x263108,_0x5614a5);const _0x361082=await this[_0x1e9e2f(0x15e)][_0x1e9e2f(0xe2)]({'username':_0x31b8ef,'id':_0x263108,'email':_0x52d65d,'role':_0x32421d,'openId':_0x5152a7,'client':_0x22155c});return await this['redisCacheService']['saveToken'](_0x263108,_0x361082),_0x361082;}async[_0x206c7e(0x147)](_0x2d70d8,_0x4f3e94){const _0x2df4d7=_0x206c7e,_0x5dbd8b=await this[_0x2df4d7(0xe7)][_0x2df4d7(0x10e)](_0x2d70d8),{username:_0x4652a5,id:_0x29e9cf,email:_0x3fedb8,role:_0x2a0d3b,openId:_0x13ac36,client:_0x143c54}=_0x5dbd8b,_0x284c61=(0x0,utils_1[_0x2df4d7(0xf5)])(_0x4f3e94);await this[_0x2df4d7(0xe7)]['savaLoginIp'](_0x29e9cf,_0x284c61);const {phone:_0x1ddf96}=_0x2d70d8,_0x4c8533=await this[_0x2df4d7(0x15e)][_0x2df4d7(0xe2)]({'username':_0x4652a5,'id':_0x29e9cf,'email':_0x3fedb8,'role':_0x2a0d3b,'openId':_0x13ac36,'client':_0x143c54,'phone':_0x1ddf96});return await this['redisCacheService'][_0x2df4d7(0xda)](_0x29e9cf,_0x4c8533),_0x4c8533;}async[_0x206c7e(0x109)](_0x4630dd,_0x5ebda2){const _0x15fba9=_0x206c7e,{status:_0x52a476}=_0x4630dd;if(_0x52a476!==user_constant_1[_0x15fba9(0x156)][_0x15fba9(0x13b)])throw new common_1['HttpException'](user_constant_1[_0x15fba9(0xf7)][_0x52a476],common_1[_0x15fba9(0xee)][_0x15fba9(0x15c)]);const {username:_0x214004,id:_0x1d9564,email:_0x51d1a3,role:_0x327c2d,openId:_0x4776be,client:_0x3afe72}=_0x4630dd,_0x3ab608=(0x0,utils_1[_0x15fba9(0xf5)])(_0x5ebda2);await this[_0x15fba9(0xe7)][_0x15fba9(0x120)](_0x1d9564,_0x3ab608);const _0x2123e3=await this[_0x15fba9(0x15e)][_0x15fba9(0xe2)]({'username':_0x214004,'id':_0x1d9564,'email':_0x51d1a3,'role':_0x327c2d,'openId':_0x4776be,'client':_0x3afe72});return await this['redisCacheService'][_0x15fba9(0xda)](_0x1d9564,_0x2123e3),_0x2123e3;}async[_0x206c7e(0xfc)](_0x453d39){const _0x57406c=_0x206c7e,{id:_0x451117}=_0x453d39[_0x57406c(0x14d)];return await this[_0x57406c(0xe7)]['getUserInfo'](_0x451117);}async['activateAccount'](_0x532da8,_0x4f92fb){const _0x512fb1=_0x206c7e,_0x106402=await this[_0x512fb1(0x10d)][_0x512fb1(0x160)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x512fb1(0x103),_0x512fb1(0x164),_0x512fb1(0x128),_0x512fb1(0x119),'registerFailEmailTeamName'])}}),_0x453c57=_0x106402['reduce']((_0x3198e0,_0x10c0d9)=>{const _0x549e0a=_0x512fb1;return _0x3198e0[_0x10c0d9[_0x549e0a(0x102)]]=_0x10c0d9[_0x549e0a(0x11f)],_0x3198e0;},{});try{const _0x9d8a2c=await this[_0x512fb1(0x14a)][_0x512fb1(0x13f)](_0x532da8,verification_constant_1[_0x512fb1(0x122)][_0x512fb1(0x12d)]),{type:_0x45a224,userId:_0x1ebdec}=_0x9d8a2c;if(_0x45a224!==verification_constant_1[_0x512fb1(0x122)]['Registration'])throw new common_1['HttpException'](_0x512fb1(0x132),common_1[_0x512fb1(0xee)]['BAD_REQUEST']);const _0xe163c2=await this[_0x512fb1(0xe7)][_0x512fb1(0x151)](_0x1ebdec);if(_0xe163c2===user_constant_1[_0x512fb1(0x156)][_0x512fb1(0x13b)])throw new common_1[(_0x512fb1(0xf4))](_0x512fb1(0x133),common_1[_0x512fb1(0xee)][_0x512fb1(0x15c)]);await this[_0x512fb1(0xe7)][_0x512fb1(0xdf)](_0x9d8a2c[_0x512fb1(0xf2)],user_constant_1['UserStatusEnum'][_0x512fb1(0x13b)]);const _0x297b9f=await this[_0x512fb1(0xe7)][_0x512fb1(0x13e)](_0x9d8a2c[_0x512fb1(0xf2)]),{username:_0x460ab6,email:_0x57bf10,id:_0x399b4a,invitedBy:_0x133960}=_0x297b9f;let _0x3b6854;_0x133960&&(_0x3b6854=await this[_0x512fb1(0xe7)][_0x512fb1(0x135)](_0x133960)),await this[_0x512fb1(0x140)][_0x512fb1(0x13d)](_0x399b4a,_0x3b6854===null||_0x3b6854===void 0x0?void 0x0:_0x3b6854['id']),_0x4f92fb[_0x512fb1(0x112)](_0x512fb1(0xde)+_0x399b4a['toString']()['padStart'](0x4,'0')+_0x512fb1(0x14c)+_0x460ab6+_0x512fb1(0xfb)+_0x57bf10+_0x512fb1(0x148)+_0x453c57['registerSuccessEmailTitle']+_0x512fb1(0x15f)+_0x453c57['registerSuccessEmailTeamName']+_0x512fb1(0x145)+_0x453c57[_0x512fb1(0x128)]);}catch(_0xdae065){console['log']('error:\x20',_0xdae065);const _0x5c6982=_0xdae065[_0x512fb1(0xe4)];_0x4f92fb['redirect']('/api/auth/registerError?message='+_0x5c6982+_0x512fb1(0xef)+_0x453c57[_0x512fb1(0x119)]+_0x512fb1(0x152)+_0x453c57[_0x512fb1(0xf6)]);}}async[_0x206c7e(0xe6)](_0x414035,_0x4e058c){const _0x48d6a5=_0x206c7e,{id:_0x4e206f,client:_0x49a402,role:_0x472e2d}=_0x414035['user'];if(_0x49a402&&Number(_0x49a402)>0x0)throw new common_1['HttpException'](_0x48d6a5(0x125),common_1[_0x48d6a5(0xee)][_0x48d6a5(0x15c)]);if(_0x472e2d==='admin')throw new common_1['HttpException']('非法操作、请联系管理员！',common_1['HttpStatus'][_0x48d6a5(0x15c)]);const _0x61f11=await this[_0x48d6a5(0xe7)][_0x48d6a5(0x11e)](_0x4e206f,_0x4e058c[_0x48d6a5(0x144)]);if(!_0x61f11)throw new common_1[(_0x48d6a5(0xf4))](_0x48d6a5(0x14e),common_1['HttpStatus'][_0x48d6a5(0x15c)]);return this[_0x48d6a5(0xe7)][_0x48d6a5(0x139)](_0x4e206f,_0x4e058c['password']),_0x48d6a5(0x138);}async[_0x206c7e(0xf8)](_0xddbb24,_0x4451ac){const _0x593aaa=_0x206c7e,{id:_0x413730,client:_0x594a55}=_0xddbb24['user'];if(!_0x594a55)throw new common_1[(_0x593aaa(0xf4))](_0x593aaa(0xe9),common_1[_0x593aaa(0xee)]['BAD_REQUEST']);return this[_0x593aaa(0xe7)][_0x593aaa(0x139)](_0x413730,_0x4451ac['password']),_0x593aaa(0x138);}[_0x206c7e(0x101)](){const _0x29ca7e=_0x206c7e;let _0x5f2f5b;const _0x8192d6=os[_0x29ca7e(0x15d)]();Object[_0x29ca7e(0x15b)](_0x8192d6)[_0x29ca7e(0x146)](_0x573987=>{const _0x52e81f=_0x29ca7e,_0x13c513=_0x8192d6[_0x573987];for(let _0x3e498f=0x0;_0x3e498f<_0x13c513[_0x52e81f(0xfd)];_0x3e498f++){const _0x20254c=_0x13c513[_0x3e498f];if(_0x20254c[_0x52e81f(0x14f)]==='IPv4'&&_0x20254c[_0x52e81f(0x117)]!==_0x52e81f(0x163)&&!_0x20254c[_0x52e81f(0x12e)]){_0x5f2f5b=_0x20254c[_0x52e81f(0x117)];break;}}}),this['ipAddress']=_0x5f2f5b;}async[_0x206c7e(0x106)](_0x21e4bb){const _0x5aba94=_0x206c7e,_0x454264=await this['globalConfigService']['getNamespace'](),{color:color=_0x5aba94(0xe0)}=_0x21e4bb,_0x592404=svgCaptcha[_0x5aba94(0x14b)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x11645c=_0x592404[_0x5aba94(0x165)],_0x57fa16=(0x0,utils_1[_0x5aba94(0xdc)])(),_0x42040e=_0x454264+_0x5aba94(0x12a)+_0x57fa16;return await this[_0x5aba94(0x121)][_0x5aba94(0x157)]({'key':_0x42040e,'val':_0x592404['text']},0x5*0x3c),{'svgCode':_0x592404['data'],'code':_0x57fa16};}async[_0x206c7e(0xe3)](_0x100d69){const _0x3f7444=_0x206c7e;await this['verificationService'][_0x3f7444(0xeb)](_0x100d69);const {phone:_0x51acb9}=_0x100d69,_0x4168a6=await this[_0x3f7444(0xfa)][_0x3f7444(0x100)](),_0x5bc8e8=_0x4168a6+_0x3f7444(0x10f)+_0x51acb9,_0x10de3f=await this[_0x3f7444(0x121)][_0x3f7444(0xff)](_0x5bc8e8);if(_0x10de3f&&_0x10de3f>0x0)throw new common_1[(_0x3f7444(0xf4))](_0x10de3f+_0x3f7444(0x12c),common_1[_0x3f7444(0xee)][_0x3f7444(0x15c)]);const _0x20d618=(0x0,utils_1[_0x3f7444(0x143)])(),_0xa1ec6b={'phone':_0x51acb9,'code':_0x20d618};return await this[_0x3f7444(0x14a)][_0x3f7444(0xe3)](_0xa1ec6b),await this[_0x3f7444(0x121)]['set']({'key':_0x5bc8e8,'val':_0x20d618},0x1*0x3c),_0x3f7444(0xe5);}[_0x206c7e(0x104)](_0x2c22af){const _0x9105a5=_0x206c7e,_0xfbea73=this['jwtService']['sign']({'username':'游客'+_0x2c22af,'id':_0x2c22af,'email':_0x2c22af+_0x9105a5(0x124),'role':_0x9105a5(0xf0),'openId':null,'client':null});return _0xfbea73;}};AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x206c7e(0xea)])),__metadata(_0x206c7e(0x137),[typeorm_1[_0x206c7e(0x127)],user_service_1['UserService'],jwt_1[_0x206c7e(0x105)],mailer_service_1[_0x206c7e(0xdb)],verification_service_1[_0x206c7e(0x123)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0x206c7e(0x12b)],globalConfig_service_1['GlobalConfigService']])],AuthService),exports['AuthService']=AuthService;