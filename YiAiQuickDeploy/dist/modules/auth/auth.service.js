'use strict';const _0x5ba822=_0x3a92;function _0x3a92(_0x5844f5,_0x53f104){const _0x38798c=_0x3879();return _0x3a92=function(_0x3a92c7,_0x426616){_0x3a92c7=_0x3a92c7-0x91;let _0x985bcd=_0x38798c[_0x3a92c7];return _0x985bcd;},_0x3a92(_0x5844f5,_0x53f104);}(function(_0x948b4,_0x106543){const _0x12bd20=_0x3a92,_0x326a1f=_0x948b4();while(!![]){try{const _0xfaac47=-parseInt(_0x12bd20(0xb7))/0x1*(-parseInt(_0x12bd20(0xc2))/0x2)+-parseInt(_0x12bd20(0x98))/0x3*(-parseInt(_0x12bd20(0x112))/0x4)+-parseInt(_0x12bd20(0x93))/0x5+-parseInt(_0x12bd20(0xd5))/0x6*(-parseInt(_0x12bd20(0xc8))/0x7)+parseInt(_0x12bd20(0xd3))/0x8+-parseInt(_0x12bd20(0xe7))/0x9*(parseInt(_0x12bd20(0xf9))/0xa)+parseInt(_0x12bd20(0xad))/0xb;if(_0xfaac47===_0x106543)break;else _0x326a1f['push'](_0x326a1f['shift']());}catch(_0x2a1eb3){_0x326a1f['push'](_0x326a1f['shift']());}}}(_0x3879,0xe1fc9));var __decorate=this&&this[_0x5ba822(0x9e)]||function(_0x3d16d9,_0x34c991,_0x5847c7,_0x221f97){const _0x5e61df=_0x5ba822;var _0x5b7cc6=arguments[_0x5e61df(0xc3)],_0x4cf4e5=_0x5b7cc6<0x3?_0x34c991:_0x221f97===null?_0x221f97=Object[_0x5e61df(0xae)](_0x34c991,_0x5847c7):_0x221f97,_0x3897f1;if(typeof Reflect===_0x5e61df(0xdd)&&typeof Reflect[_0x5e61df(0xea)]===_0x5e61df(0xed))_0x4cf4e5=Reflect[_0x5e61df(0xea)](_0x3d16d9,_0x34c991,_0x5847c7,_0x221f97);else{for(var _0x24442e=_0x3d16d9[_0x5e61df(0xc3)]-0x1;_0x24442e>=0x0;_0x24442e--)if(_0x3897f1=_0x3d16d9[_0x24442e])_0x4cf4e5=(_0x5b7cc6<0x3?_0x3897f1(_0x4cf4e5):_0x5b7cc6>0x3?_0x3897f1(_0x34c991,_0x5847c7,_0x4cf4e5):_0x3897f1(_0x34c991,_0x5847c7))||_0x4cf4e5;}return _0x5b7cc6>0x3&&_0x4cf4e5&&Object[_0x5e61df(0xa9)](_0x34c991,_0x5847c7,_0x4cf4e5),_0x4cf4e5;},__metadata=this&&this['__metadata']||function(_0x595518,_0x3e4157){const _0x2af3e2=_0x5ba822;if(typeof Reflect===_0x2af3e2(0xdd)&&typeof Reflect['metadata']===_0x2af3e2(0xed))return Reflect[_0x2af3e2(0x9a)](_0x595518,_0x3e4157);},__param=this&&this['__param']||function(_0x47f9fe,_0x5ef083){return function(_0xed04f9,_0x488467){_0x5ef083(_0xed04f9,_0x488467,_0x47f9fe);};};Object['defineProperty'](exports,_0x5ba822(0xe1),{'value':!![]}),exports['AuthService']=void 0x0;const globalConfig_service_1=require(_0x5ba822(0x10b)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x5ba822(0x113)),common_1=require(_0x5ba822(0xc1)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x5ba822(0x106)),mailer_service_1=require(_0x5ba822(0xa6)),user_constant_1=require(_0x5ba822(0xe6)),userBalance_service_1=require('../userBalance/userBalance.service'),config_entity_1=require(_0x5ba822(0xab)),typeorm_1=require(_0x5ba822(0xb5)),typeorm_2=require(_0x5ba822(0xa8)),utils_1=require(_0x5ba822(0xf2)),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x5ba822(0x10a)),bcrypt=require(_0x5ba822(0x107));let AuthService=class AuthService{constructor(_0x5534e1,_0x1c1f47,_0x2823b8,_0x51f8fd,_0x7791cf,_0x5c73ab,_0x1afd77,_0x15963c){const _0x4582be=_0x5ba822;this[_0x4582be(0xcd)]=_0x5534e1,this[_0x4582be(0xf7)]=_0x1c1f47,this['jwtService']=_0x2823b8,this[_0x4582be(0xe0)]=_0x51f8fd,this[_0x4582be(0xb4)]=_0x7791cf,this[_0x4582be(0x10d)]=_0x5c73ab,this[_0x4582be(0xd6)]=_0x1afd77,this[_0x4582be(0xdc)]=_0x15963c;}async[_0x5ba822(0xc7)](){const _0x5a4cc5=_0x5ba822;this[_0x5a4cc5(0xe3)]();}async['register'](_0x455d70,_0x31e871){const _0x365ee3=_0x5ba822,_0x37630a=await this[_0x365ee3(0xf7)][_0x365ee3(0x100)](_0x455d70,_0x31e871),{username:_0x51e663,email:_0x485d7e,client:_0x599af4,id:_0xc38f56}=_0x37630a,_0xe527f0={'username':_0x51e663,'email':_0x485d7e,'id':_0xc38f56};return _0x599af4&&(_0xe527f0[_0x365ee3(0xfd)]=_0x599af4),_0xe527f0;}async[_0x5ba822(0xc4)](_0x16aa64,_0x200a3e){const _0x481c4e=_0x5ba822,{username:_0x48f043,password:_0x5c4357,phone:_0x12bf91,phoneCode:_0x491540,invitedBy:_0x18682e}=_0x16aa64;await this[_0x481c4e(0xf7)][_0x481c4e(0xf6)](_0x16aa64);const _0x175dd3=await this[_0x481c4e(0xdc)][_0x481c4e(0x10c)](),_0x11c345=_0x175dd3+_0x481c4e(0xda)+_0x12bf91,_0x34b9bb=await this[_0x481c4e(0xd6)][_0x481c4e(0xf1)]({'key':_0x11c345});if(!_0x34b9bb)throw new common_1['HttpException']('验证码已过期、请重新发送！',common_1[_0x481c4e(0xf5)][_0x481c4e(0xca)]);if(_0x491540!==_0x34b9bb)throw new common_1[(_0x481c4e(0xcf))](_0x481c4e(0x116),common_1[_0x481c4e(0xf5)][_0x481c4e(0xca)]);const _0x4c77f1=(0x0,utils_1[_0x481c4e(0xd7)])()+_0x481c4e(0xbe),_0x18d74a={'username':_0x48f043,'password':_0x5c4357,'phone':_0x12bf91,'invitedBy':_0x18682e,'email':_0x4c77f1,'status':user_constant_1[_0x481c4e(0xd4)][_0x481c4e(0x10f)]},_0x318736=await this[_0x481c4e(0xdc)]['getConfigs'](['userDefautlAvatar']);_0x18d74a[_0x481c4e(0xb6)]=_0x318736;const _0x3f8aea=bcrypt['hashSync'](_0x5c4357,0xa);_0x18d74a[_0x481c4e(0xf0)]=_0x3f8aea;const _0x5f3b94=await this[_0x481c4e(0xf7)]['createUser'](_0x18d74a);let _0x2ca33e;_0x18682e&&(_0x2ca33e=await this['userService'][_0x481c4e(0x95)](_0x18682e));await this[_0x481c4e(0x10d)][_0x481c4e(0x97)](_0x5f3b94['id'],_0x2ca33e===null||_0x2ca33e===void 0x0?void 0x0:_0x2ca33e['id']);return;}async[_0x5ba822(0xc9)](_0xeeb98,_0x5a0de0){const _0x295ef4=_0x5ba822,_0xe54633=await this[_0x295ef4(0xf7)][_0x295ef4(0xde)](_0xeeb98),{username:_0x40fedb,id:_0x2f1ba1,email:_0xe512ca,role:_0x3dbcbc,openId:_0x2fb7ed,client:_0x3ecb75}=_0xe54633,_0x20bc1d=(0x0,utils_1[_0x295ef4(0x94)])(_0x5a0de0);await this[_0x295ef4(0xf7)]['savaLoginIp'](_0x2f1ba1,_0x20bc1d);const _0x423137=await this[_0x295ef4(0x110)][_0x295ef4(0x91)]({'username':_0x40fedb,'id':_0x2f1ba1,'email':_0xe512ca,'role':_0x3dbcbc,'openId':_0x2fb7ed,'client':_0x3ecb75});return await this[_0x295ef4(0xd6)][_0x295ef4(0x9f)](_0x2f1ba1,_0x423137),_0x423137;}async[_0x5ba822(0xd1)](_0x4e99a4,_0x154bdf){const _0x9e8322=_0x5ba822,_0xcac44f=await this['userService']['verifyUserCredentials'](_0x4e99a4),{username:_0x2e2169,id:_0x428d58,email:_0x122690,role:_0xe4dbf9,openId:_0x5bbeef,client:_0x1e8316}=_0xcac44f,_0x2ed8c0=(0x0,utils_1[_0x9e8322(0x94)])(_0x154bdf);await this[_0x9e8322(0xf7)]['savaLoginIp'](_0x428d58,_0x2ed8c0);const {phone:_0x477aef}=_0x4e99a4,_0x54deba=await this['jwtService']['sign']({'username':_0x2e2169,'id':_0x428d58,'email':_0x122690,'role':_0xe4dbf9,'openId':_0x5bbeef,'client':_0x1e8316,'phone':_0x477aef});return await this['redisCacheService']['saveToken'](_0x428d58,_0x54deba),_0x54deba;}async[_0x5ba822(0xc5)](_0x3889a5,_0x3b1804){const _0x15e090=_0x5ba822,{status:_0x5e129d}=_0x3889a5;if(_0x5e129d!==user_constant_1[_0x15e090(0xd4)][_0x15e090(0x10f)])throw new common_1[(_0x15e090(0xcf))](user_constant_1[_0x15e090(0x114)][_0x5e129d],common_1[_0x15e090(0xf5)][_0x15e090(0xca)]);const {username:_0x10f418,id:_0x2392ce,email:_0xab733f,role:_0x5d4b37,openId:_0x354791,client:_0x43e854}=_0x3889a5,_0x234073=(0x0,utils_1[_0x15e090(0x94)])(_0x3b1804);await this['userService']['savaLoginIp'](_0x2392ce,_0x234073);const _0x4db47b=await this[_0x15e090(0x110)][_0x15e090(0x91)]({'username':_0x10f418,'id':_0x2392ce,'email':_0xab733f,'role':_0x5d4b37,'openId':_0x354791,'client':_0x43e854});return await this[_0x15e090(0xd6)]['saveToken'](_0x2392ce,_0x4db47b),_0x4db47b;}async['getInfo'](_0x5e519d){const _0x341aeb=_0x5ba822,{id:_0x5864a3}=_0x5e519d[_0x341aeb(0x103)];return await this['userService'][_0x341aeb(0x99)](_0x5864a3);}async[_0x5ba822(0xa2)](_0x57844c,_0x3e3f74){const _0x4c4ddd=_0x5ba822,_0x1833c3=await this[_0x4c4ddd(0xcd)]['find']({'where':{'configKey':(0x0,typeorm_1['In'])([_0x4c4ddd(0xb2),_0x4c4ddd(0x9d),_0x4c4ddd(0x111),_0x4c4ddd(0xa5),_0x4c4ddd(0xf4)])}}),_0x28245d=_0x1833c3[_0x4c4ddd(0xce)]((_0x40f5a4,_0x40093f)=>{const _0x5e4a29=_0x4c4ddd;return _0x40f5a4[_0x40093f[_0x5e4a29(0xdb)]]=_0x40093f[_0x5e4a29(0xdf)],_0x40f5a4;},{});try{const _0x40064a=await this['verificationService'][_0x4c4ddd(0x101)](_0x57844c,verification_constant_1[_0x4c4ddd(0x104)][_0x4c4ddd(0xfa)]),{type:_0x477d13,userId:_0x5acf26}=_0x40064a;if(_0x477d13!==verification_constant_1[_0x4c4ddd(0x104)][_0x4c4ddd(0xfa)])throw new common_1[(_0x4c4ddd(0xcf))](_0x4c4ddd(0xbc),common_1[_0x4c4ddd(0xf5)][_0x4c4ddd(0xca)]);const _0x10286c=await this[_0x4c4ddd(0xf7)]['getUserStatus'](_0x5acf26);if(_0x10286c===user_constant_1[_0x4c4ddd(0xd4)][_0x4c4ddd(0x10f)])throw new common_1[(_0x4c4ddd(0xcf))](_0x4c4ddd(0xe4),common_1['HttpStatus'][_0x4c4ddd(0xca)]);await this[_0x4c4ddd(0xf7)][_0x4c4ddd(0xeb)](_0x40064a[_0x4c4ddd(0xe5)],user_constant_1['UserStatusEnum'][_0x4c4ddd(0x10f)]);const _0x520e46=await this['userService']['queryUserInfoById'](_0x40064a['userId']),{username:_0x2e8d1a,email:_0x2e2800,id:_0x313085,invitedBy:_0x123012}=_0x520e46;let _0xcd3254;_0x123012&&(_0xcd3254=await this['userService'][_0x4c4ddd(0x95)](_0x123012)),await this[_0x4c4ddd(0x10d)][_0x4c4ddd(0x97)](_0x313085,_0xcd3254===null||_0xcd3254===void 0x0?void 0x0:_0xcd3254['id']),_0x3e3f74[_0x4c4ddd(0xbd)](_0x4c4ddd(0xb8)+_0x313085[_0x4c4ddd(0xb3)]()[_0x4c4ddd(0xba)](0x4,'0')+'&username='+_0x2e8d1a+_0x4c4ddd(0xe2)+_0x2e2800+_0x4c4ddd(0xd2)+_0x28245d[_0x4c4ddd(0xb2)]+_0x4c4ddd(0xc0)+_0x28245d[_0x4c4ddd(0x9d)]+_0x4c4ddd(0x115)+_0x28245d['registerSuccessEmaileAppend']);}catch(_0x4f93c6){console['log'](_0x4c4ddd(0xb0),_0x4f93c6);const _0x55af9e=_0x4f93c6[_0x4c4ddd(0x96)];_0x3e3f74['redirect'](_0x4c4ddd(0xd0)+_0x55af9e+'&registerFailEmailTitle='+_0x28245d[_0x4c4ddd(0xa5)]+_0x4c4ddd(0xa1)+_0x28245d[_0x4c4ddd(0xf4)]);}}async[_0x5ba822(0xf8)](_0xceaf05,_0x4656c2){const _0x49a646=_0x5ba822,{id:_0x255d44,client:_0x259cb5,role:_0xdeb2}=_0xceaf05[_0x49a646(0x103)];if(_0x259cb5&&Number(_0x259cb5)>0x0)throw new common_1['HttpException'](_0x49a646(0xf3),common_1['HttpStatus']['BAD_REQUEST']);if(_0xdeb2==='admin')throw new common_1['HttpException'](_0x49a646(0xfe),common_1['HttpStatus'][_0x49a646(0xca)]);const _0xa00eb6=await this[_0x49a646(0xf7)]['verifyUserPassword'](_0x255d44,_0x4656c2['oldPassword']);if(!_0xa00eb6)throw new common_1[(_0x49a646(0xcf))](_0x49a646(0xec),common_1[_0x49a646(0xf5)][_0x49a646(0xca)]);return this[_0x49a646(0xf7)][_0x49a646(0xc6)](_0x255d44,_0x4656c2[_0x49a646(0xf0)]),_0x49a646(0x10e);}async[_0x5ba822(0xac)](_0x3cd0f4,_0x4974b1){const _0x40ce5d=_0x5ba822,{id:_0x101e09,client:_0xadca97}=_0x3cd0f4['user'];if(!_0xadca97)throw new common_1['HttpException']('无权此操作！',common_1['HttpStatus']['BAD_REQUEST']);return this[_0x40ce5d(0xf7)][_0x40ce5d(0xc6)](_0x101e09,_0x4974b1[_0x40ce5d(0xf0)]),_0x40ce5d(0x10e);}[_0x5ba822(0xe3)](){const _0x113c31=_0x5ba822;let _0x4f1213;const _0x5b7ad7=os['networkInterfaces']();Object[_0x113c31(0xee)](_0x5b7ad7)[_0x113c31(0x109)](_0x16ac0b=>{const _0x5802fe=_0x113c31,_0x125e44=_0x5b7ad7[_0x16ac0b];for(let _0x134e48=0x0;_0x134e48<_0x125e44[_0x5802fe(0xc3)];_0x134e48++){const _0x2d8dc0=_0x125e44[_0x134e48];if(_0x2d8dc0[_0x5802fe(0xa3)]==='IPv4'&&_0x2d8dc0[_0x5802fe(0xaf)]!==_0x5802fe(0x105)&&!_0x2d8dc0[_0x5802fe(0x108)]){_0x4f1213=_0x2d8dc0[_0x5802fe(0xaf)];break;}}}),this[_0x113c31(0xcb)]=_0x4f1213;}async[_0x5ba822(0xff)](_0x5a7961){const _0x1ea495=_0x5ba822,_0x31aa8f=await this['globalConfigService'][_0x1ea495(0x10c)](),{color:color='#fff'}=_0x5a7961,_0x37dfb0=svgCaptcha[_0x1ea495(0xfc)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x589700=_0x37dfb0[_0x1ea495(0xa7)],_0x2e62a2=(0x0,utils_1[_0x1ea495(0xd7)])(),_0x1d82cb=_0x31aa8f+':CAPTCHA:'+_0x2e62a2;return await this[_0x1ea495(0xd6)]['set']({'key':_0x1d82cb,'val':_0x37dfb0['text']},0x5*0x3c),{'svgCode':_0x37dfb0['data'],'code':_0x2e62a2};}async[_0x5ba822(0xe8)](_0x43f4ed){const _0x26f7c9=_0x5ba822;await this[_0x26f7c9(0xb4)][_0x26f7c9(0xaa)](_0x43f4ed);const {phone:_0x16ba3c}=_0x43f4ed,_0x5da1fa=await this['globalConfigService']['getNamespace'](),_0x2760bf=_0x5da1fa+':PHONECODE:'+_0x16ba3c,_0x1682e0=await this['redisCacheService']['ttl'](_0x2760bf);if(_0x1682e0&&_0x1682e0>0x0)throw new common_1[(_0x26f7c9(0xcf))](_0x1682e0+_0x26f7c9(0xb1),common_1[_0x26f7c9(0xf5)][_0x26f7c9(0xca)]);const _0x1aed11=(0x0,utils_1[_0x26f7c9(0xef)])(),_0x11f932={'phone':_0x16ba3c,'code':_0x1aed11};return await this['verificationService'][_0x26f7c9(0xe8)](_0x11f932),await this[_0x26f7c9(0xd6)][_0x26f7c9(0x102)]({'key':_0x2760bf,'val':_0x1aed11},0x1*0x3c),_0x26f7c9(0xa0);}[_0x5ba822(0xd8)](_0x9e62c){const _0x373039=_0x5ba822,_0x473f9c=this[_0x373039(0x110)][_0x373039(0x91)]({'username':'游客'+_0x9e62c,'id':_0x9e62c,'email':_0x9e62c+_0x373039(0xbe),'role':_0x373039(0x9c),'openId':null,'client':null});return _0x473f9c;}};AuthService=__decorate([(0x0,common_1[_0x5ba822(0xa4)])(),__param(0x0,(0x0,typeorm_2[_0x5ba822(0xcc)])(config_entity_1[_0x5ba822(0xfb)])),__metadata(_0x5ba822(0xbb),[typeorm_1[_0x5ba822(0xb9)],user_service_1[_0x5ba822(0xe9)],jwt_1['JwtService'],mailer_service_1[_0x5ba822(0x92)],verification_service_1[_0x5ba822(0x9b)],userBalance_service_1[_0x5ba822(0xd9)],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x5ba822(0xbf)]])],AuthService),exports['AuthService']=AuthService;function _0x3879(){const _0x174bb7=['updatePassByOther','4141720QLzkfk','getOwnPropertyDescriptor','address','error:\x20','秒内不得重复发送短信！','registerSuccessEmailTitle','toString','verificationService','typeorm','avatar','4146EHbqhU','/api/auth/registerSuccess?id=','Repository','padStart','design:paramtypes','验证码类型错误','redirect','@nine.com','GlobalConfigService','&registerSuccessEmailTeamName=','@nestjs/common','626VWwguM','length','registerByPhone','loginByOpenId','updateUserPassword','onModuleInit','14hCdkzP','login','BAD_REQUEST','ipAddress','InjectRepository','configEntity','reduce','HttpException','/api/auth/registerError?message=','loginByPhone','&registerSuccessEmailTitle=','2512072qrJszS','UserStatusEnum','615834iGNAdr','redisCacheService','createRandomUid','createTokenFromFingerprint','UserBalanceService',':PHONECODE:','configKey','globalConfigService','object','verifyUserCredentials','configVal','mailerService','__esModule','&email=','getIp','账户已被激活过','userId','../../common/constants/user.constant','994419QLQZtg','sendPhoneCode','UserService','decorate','updateUserStatus','旧密码错误、请检查提交','function','keys','createRandomCode','password','get','../../common/utils','无权此操作、请联系管理员！','registerFailEmailTeamName','HttpStatus','verifyUserRegisterByPhone','userService','updatePassword','50wjwHZl','Registration','ConfigEntity','createMathExpr','client','非法操作、请联系管理员！','captcha','createUserAndVerifycation','verifyCode','set','user','VerificationEnum','127.0.0.1','../user/user.service','bcryptjs','internal','forEach','svg-captcha','../globalConfig/globalConfig.service','getNamespace','userBalanceService','密码修改成功','ACTIVE','jwtService','registerSuccessEmaileAppend','1104644PrdFZp','../verification/verification.service','UserStatusErrMsg','&registerSuccessEmaileAppend=','验证码填写错误、请重新输入！','sign','MailerService','4957850fupNYg','getClientIp','qureyUserInfoByInviteCode','response','addBalanceToNewUser','3orbCnn','getUserInfo','metadata','VerificationService','visitor','registerSuccessEmailTeamName','__decorate','saveToken','验证码发送成功、请填写验证码完成注册！','&registerFailEmailTeamName=','activateAccount','family','Injectable','registerFailEmailTitle','../mailer/mailer.service','text','@nestjs/typeorm','defineProperty','verifyCaptcha','../globalConfig/config.entity'];_0x3879=function(){return _0x174bb7;};return _0x3879();}