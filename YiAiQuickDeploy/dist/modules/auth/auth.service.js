'use strict';const _0x3e3b9c=_0x3652;(function(_0xb2792a,_0xe1daea){const _0x48f1e4=_0x3652,_0x1a82d8=_0xb2792a();while(!![]){try{const _0x395e37=-parseInt(_0x48f1e4(0x1c1))/0x1+parseInt(_0x48f1e4(0x199))/0x2+-parseInt(_0x48f1e4(0x1a5))/0x3*(parseInt(_0x48f1e4(0x1a0))/0x4)+parseInt(_0x48f1e4(0x1df))/0x5*(parseInt(_0x48f1e4(0x1e2))/0x6)+parseInt(_0x48f1e4(0x1a4))/0x7*(-parseInt(_0x48f1e4(0x1d5))/0x8)+-parseInt(_0x48f1e4(0x19e))/0x9*(parseInt(_0x48f1e4(0x194))/0xa)+parseInt(_0x48f1e4(0x1aa))/0xb*(parseInt(_0x48f1e4(0x184))/0xc);if(_0x395e37===_0xe1daea)break;else _0x1a82d8['push'](_0x1a82d8['shift']());}catch(_0x124e59){_0x1a82d8['push'](_0x1a82d8['shift']());}}}(_0x1610,0xd95db));var __decorate=this&&this[_0x3e3b9c(0x1c9)]||function(_0x100b19,_0x4d3b1c,_0x37cc25,_0x1cc13d){const _0x35a22b=_0x3e3b9c;var _0x4bf81f=arguments[_0x35a22b(0x1cd)],_0x402982=_0x4bf81f<0x3?_0x4d3b1c:_0x1cc13d===null?_0x1cc13d=Object[_0x35a22b(0x192)](_0x4d3b1c,_0x37cc25):_0x1cc13d,_0x1f8831;if(typeof Reflect===_0x35a22b(0x1f2)&&typeof Reflect['decorate']===_0x35a22b(0x1b2))_0x402982=Reflect['decorate'](_0x100b19,_0x4d3b1c,_0x37cc25,_0x1cc13d);else{for(var _0x4f3642=_0x100b19[_0x35a22b(0x1cd)]-0x1;_0x4f3642>=0x0;_0x4f3642--)if(_0x1f8831=_0x100b19[_0x4f3642])_0x402982=(_0x4bf81f<0x3?_0x1f8831(_0x402982):_0x4bf81f>0x3?_0x1f8831(_0x4d3b1c,_0x37cc25,_0x402982):_0x1f8831(_0x4d3b1c,_0x37cc25))||_0x402982;}return _0x4bf81f>0x3&&_0x402982&&Object[_0x35a22b(0x1b7)](_0x4d3b1c,_0x37cc25,_0x402982),_0x402982;},__metadata=this&&this[_0x3e3b9c(0x179)]||function(_0x4b9fed,_0x244b03){const _0x3c8407=_0x3e3b9c;if(typeof Reflect===_0x3c8407(0x1f2)&&typeof Reflect[_0x3c8407(0x180)]===_0x3c8407(0x1b2))return Reflect['metadata'](_0x4b9fed,_0x244b03);},__param=this&&this[_0x3e3b9c(0x1ef)]||function(_0x232c18,_0x19c8ff){return function(_0x3da9e3,_0x37f78a){_0x19c8ff(_0x3da9e3,_0x37f78a,_0x232c18);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x3e3b9c(0x1f9)]=void 0x0;function _0x3652(_0x524596,_0x34861c){const _0x1610f2=_0x1610();return _0x3652=function(_0x365209,_0x327d35){_0x365209=_0x365209-0x179;let _0x769196=_0x1610f2[_0x365209];return _0x769196;},_0x3652(_0x524596,_0x34861c);}function _0x1610(){const _0x288632=['getIp','getUserInfo','getNamespace','length','HttpStatus','loginByOpenId','InjectRepository','../../common/constants/verification.constant','秒内不得重复发送短信！','../mailer/mailer.service','UserStatusEnum','56nyrKln','registerFailEmailTeamName','padStart','Registration','get','savaLoginIp','GlobalConfigService','密码修改成功','design:paramtypes','../verification/verification.service','1310350EadFgY','/api/auth/registerSuccess?id=','internal','12PfpwKq','createRandomUid','ACTIVE','UserService','BAD_REQUEST','HttpException','loginByPhone',':CAPTCHA:','JwtService','redirect','#fff','updateUserPassword','registerByPhone','__param','visitor','jwtService','object','set','createUser','ttl','ipAddress','createRandomCode','log','AuthService','captcha','UserStatusErrMsg','configVal','networkInterfaces','__metadata','getClientIp','login','globalConfigService','registerFailEmailTitle','reduce','user','metadata','toString','&username=','verifyUserPassword','51719064HATCAp','../../common/constants/user.constant','error:\x20','queryUserInfoById','saveToken','../user/user.service','verificationService','updatePassword','response','验证码填写错误、请重新输入！','IPv4','qureyUserInfoByInviteCode','registerSuccessEmailTitle','sign','getOwnPropertyDescriptor','@nestjs/typeorm','20RJFiRp','../globalConfig/globalConfig.service','VerificationEnum','text','无权此操作、请联系管理员！','175624KRJUgc','&registerSuccessEmaileAppend=','registerSuccessEmailTeamName','&registerFailEmailTitle=','无权此操作！','4612446fyUOAr','data','34108iOQVLA','redisCacheService','mailerService',':PHONECODE:','821492HsUEFd','489SBlPSO','userBalanceService','ConfigEntity','sendPhoneCode','userService','11FeVfgT','createUserAndVerifycation','&registerSuccessEmailTitle=','旧密码错误、请检查提交','createTokenFromFingerprint','getUserStatus','userId','registerSuccessEmaileAppend','function','activateAccount','hashSync','bcryptjs','&registerFailEmailTeamName=','defineProperty','updateUserStatus','verifyUserRegisterByPhone','@nine.com','client','family','userDefautlAvatar','verifyUserCredentials','password','register','795162WSQSTd','verifyCode','../userBalance/userBalance.service','address','@nestjs/jwt','addBalanceToNewUser','Injectable','../redisCache/redisCache.service','__decorate'];_0x1610=function(){return _0x288632;};return _0x1610();}const globalConfig_service_1=require(_0x3e3b9c(0x195)),verification_constant_1=require(_0x3e3b9c(0x1d1)),verification_service_1=require(_0x3e3b9c(0x1de)),common_1=require('@nestjs/common'),jwt_1=require(_0x3e3b9c(0x1c5)),user_service_1=require(_0x3e3b9c(0x189)),mailer_service_1=require(_0x3e3b9c(0x1d3)),user_constant_1=require(_0x3e3b9c(0x185)),userBalance_service_1=require(_0x3e3b9c(0x1c3)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require('typeorm'),typeorm_2=require(_0x3e3b9c(0x193)),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require(_0x3e3b9c(0x1c8)),svgCaptcha=require('svg-captcha'),bcrypt=require(_0x3e3b9c(0x1b5));let AuthService=class AuthService{constructor(_0x294c51,_0x2ed734,_0x34d044,_0x161414,_0x382982,_0x14d6cc,_0x1736c5,_0x4a64a1){const _0x35548e=_0x3e3b9c;this['configEntity']=_0x294c51,this[_0x35548e(0x1a9)]=_0x2ed734,this[_0x35548e(0x1f1)]=_0x34d044,this[_0x35548e(0x1a2)]=_0x161414,this[_0x35548e(0x18a)]=_0x382982,this[_0x35548e(0x1a6)]=_0x14d6cc,this[_0x35548e(0x1a1)]=_0x1736c5,this[_0x35548e(0x17c)]=_0x4a64a1;}async['onModuleInit'](){const _0x474ae7=_0x3e3b9c;this[_0x474ae7(0x1ca)]();}async[_0x3e3b9c(0x1c0)](_0x356292,_0x52ed8b){const _0x2f92e0=_0x3e3b9c,_0x31cec2=await this['userService'][_0x2f92e0(0x1ab)](_0x356292,_0x52ed8b),{username:_0x30e6db,email:_0x166518,client:_0x2591e0,id:_0x4d1a87}=_0x31cec2,_0x113b02={'username':_0x30e6db,'email':_0x166518,'id':_0x4d1a87};return _0x2591e0&&(_0x113b02[_0x2f92e0(0x1bb)]=_0x2591e0),_0x113b02;}async[_0x3e3b9c(0x1ee)](_0x487c30,_0x59343d){const _0x595111=_0x3e3b9c,{username:_0x49393c,password:_0x32c329,phone:_0x20f5c6,phoneCode:_0xdb3704,invitedBy:_0x19a133}=_0x487c30;await this[_0x595111(0x1a9)][_0x595111(0x1b9)](_0x487c30);const _0x2eb7f4=await this[_0x595111(0x17c)][_0x595111(0x1cc)](),_0x6ebdd0=_0x2eb7f4+_0x595111(0x1a3)+_0x20f5c6,_0x1f6645=await this[_0x595111(0x1a1)][_0x595111(0x1d9)]({'key':_0x6ebdd0});if(!_0x1f6645)throw new common_1[(_0x595111(0x1e7))]('验证码已过期、请重新发送！',common_1[_0x595111(0x1ce)][_0x595111(0x1e6)]);if(_0xdb3704!==_0x1f6645)throw new common_1[(_0x595111(0x1e7))](_0x595111(0x18d),common_1[_0x595111(0x1ce)][_0x595111(0x1e6)]);const _0x2c776d=(0x0,utils_1[_0x595111(0x1e3)])()+'@nine.com',_0x6d0b7f={'username':_0x49393c,'password':_0x32c329,'phone':_0x20f5c6,'invitedBy':_0x19a133,'email':_0x2c776d,'status':user_constant_1[_0x595111(0x1d4)]['ACTIVE']},_0x1ad79c=await this[_0x595111(0x17c)]['getConfigs']([_0x595111(0x1bd)]);_0x6d0b7f['avatar']=_0x1ad79c;const _0x4fcb1a=bcrypt[_0x595111(0x1b4)](_0x32c329,0xa);_0x6d0b7f[_0x595111(0x1bf)]=_0x4fcb1a;const _0x433555=await this['userService'][_0x595111(0x1f4)](_0x6d0b7f);let _0x14a432;_0x19a133&&(_0x14a432=await this[_0x595111(0x1a9)]['qureyUserInfoByInviteCode'](_0x19a133));await this['userBalanceService'][_0x595111(0x1c6)](_0x433555['id'],_0x14a432===null||_0x14a432===void 0x0?void 0x0:_0x14a432['id']);return;}async[_0x3e3b9c(0x17b)](_0x106b08,_0x7385ba){const _0x2aa74b=_0x3e3b9c,_0x54a714=await this[_0x2aa74b(0x1a9)][_0x2aa74b(0x1be)](_0x106b08),{username:_0x3a7a6f,id:_0x598c55,email:_0xbff0d3,role:_0x244ed1,openId:_0x49c271,client:_0x5c0fe3}=_0x54a714,_0x127397=(0x0,utils_1['getClientIp'])(_0x7385ba);await this[_0x2aa74b(0x1a9)]['savaLoginIp'](_0x598c55,_0x127397);const _0x3a7f21=await this['jwtService'][_0x2aa74b(0x191)]({'username':_0x3a7a6f,'id':_0x598c55,'email':_0xbff0d3,'role':_0x244ed1,'openId':_0x49c271,'client':_0x5c0fe3});return await this[_0x2aa74b(0x1a1)]['saveToken'](_0x598c55,_0x3a7f21),_0x3a7f21;}async[_0x3e3b9c(0x1e8)](_0x428988,_0x1b3209){const _0x12b22e=_0x3e3b9c,_0x39fbf1=await this[_0x12b22e(0x1a9)][_0x12b22e(0x1be)](_0x428988),{username:_0x29a433,id:_0x3f5b09,email:_0x581393,role:_0xbecadc,openId:_0x515f44,client:_0x2ca0b7}=_0x39fbf1,_0x14c2c2=(0x0,utils_1[_0x12b22e(0x17a)])(_0x1b3209);await this[_0x12b22e(0x1a9)][_0x12b22e(0x1da)](_0x3f5b09,_0x14c2c2);const {phone:_0x66eb4}=_0x428988,_0x585e53=await this[_0x12b22e(0x1f1)][_0x12b22e(0x191)]({'username':_0x29a433,'id':_0x3f5b09,'email':_0x581393,'role':_0xbecadc,'openId':_0x515f44,'client':_0x2ca0b7,'phone':_0x66eb4});return await this[_0x12b22e(0x1a1)]['saveToken'](_0x3f5b09,_0x585e53),_0x585e53;}async[_0x3e3b9c(0x1cf)](_0xd9f6bc,_0x1f88c1){const _0x199248=_0x3e3b9c,{status:_0x2ee694}=_0xd9f6bc;if(_0x2ee694!==user_constant_1[_0x199248(0x1d4)][_0x199248(0x1e4)])throw new common_1['HttpException'](user_constant_1[_0x199248(0x1fb)][_0x2ee694],common_1['HttpStatus'][_0x199248(0x1e6)]);const {username:_0xb2545b,id:_0x1c40de,email:_0x44783f,role:_0x47c571,openId:_0x3a71b3,client:_0x33a72f}=_0xd9f6bc,_0x3da7b6=(0x0,utils_1[_0x199248(0x17a)])(_0x1f88c1);await this[_0x199248(0x1a9)]['savaLoginIp'](_0x1c40de,_0x3da7b6);const _0x1e30df=await this['jwtService'][_0x199248(0x191)]({'username':_0xb2545b,'id':_0x1c40de,'email':_0x44783f,'role':_0x47c571,'openId':_0x3a71b3,'client':_0x33a72f});return await this[_0x199248(0x1a1)][_0x199248(0x188)](_0x1c40de,_0x1e30df),_0x1e30df;}async['getInfo'](_0x42e696){const _0x319cb5=_0x3e3b9c,{id:_0x2ddda3}=_0x42e696['user'];return await this[_0x319cb5(0x1a9)][_0x319cb5(0x1cb)](_0x2ddda3);}async[_0x3e3b9c(0x1b3)](_0x171dbc,_0xc92f15){const _0x153aa2=_0x3e3b9c,_0x274af3=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_1['In'])([_0x153aa2(0x190),_0x153aa2(0x19b),'registerSuccessEmaileAppend',_0x153aa2(0x17d),_0x153aa2(0x1d6)])}}),_0x4dc5eb=_0x274af3[_0x153aa2(0x17e)]((_0x17102d,_0x4794a9)=>{const _0x124b45=_0x153aa2;return _0x17102d[_0x4794a9['configKey']]=_0x4794a9[_0x124b45(0x1fc)],_0x17102d;},{});try{const _0xaba170=await this[_0x153aa2(0x18a)][_0x153aa2(0x1c2)](_0x171dbc,verification_constant_1[_0x153aa2(0x196)][_0x153aa2(0x1d8)]),{type:_0x3ffa65,userId:_0x208413}=_0xaba170;if(_0x3ffa65!==verification_constant_1[_0x153aa2(0x196)]['Registration'])throw new common_1[(_0x153aa2(0x1e7))]('验证码类型错误',common_1[_0x153aa2(0x1ce)]['BAD_REQUEST']);const _0x38aa80=await this[_0x153aa2(0x1a9)][_0x153aa2(0x1af)](_0x208413);if(_0x38aa80===user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1[(_0x153aa2(0x1e7))]('账户已被激活过',common_1['HttpStatus'][_0x153aa2(0x1e6)]);await this['userService'][_0x153aa2(0x1b8)](_0xaba170[_0x153aa2(0x1b0)],user_constant_1[_0x153aa2(0x1d4)][_0x153aa2(0x1e4)]);const _0x2b4e8=await this['userService'][_0x153aa2(0x187)](_0xaba170['userId']),{username:_0x12cf33,email:_0x118c4c,id:_0x16834f,invitedBy:_0x37793a}=_0x2b4e8;let _0x3506ae;_0x37793a&&(_0x3506ae=await this['userService'][_0x153aa2(0x18f)](_0x37793a)),await this[_0x153aa2(0x1a6)]['addBalanceToNewUser'](_0x16834f,_0x3506ae===null||_0x3506ae===void 0x0?void 0x0:_0x3506ae['id']),_0xc92f15[_0x153aa2(0x1eb)](_0x153aa2(0x1e0)+_0x16834f[_0x153aa2(0x181)]()[_0x153aa2(0x1d7)](0x4,'0')+_0x153aa2(0x182)+_0x12cf33+'&email='+_0x118c4c+_0x153aa2(0x1ac)+_0x4dc5eb[_0x153aa2(0x190)]+'&registerSuccessEmailTeamName='+_0x4dc5eb[_0x153aa2(0x19b)]+_0x153aa2(0x19a)+_0x4dc5eb[_0x153aa2(0x1b1)]);}catch(_0x564aff){console[_0x153aa2(0x1f8)](_0x153aa2(0x186),_0x564aff);const _0x5159c7=_0x564aff[_0x153aa2(0x18c)];_0xc92f15[_0x153aa2(0x1eb)]('/api/auth/registerError?message='+_0x5159c7+_0x153aa2(0x19c)+_0x4dc5eb[_0x153aa2(0x17d)]+_0x153aa2(0x1b6)+_0x4dc5eb['registerFailEmailTeamName']);}}async[_0x3e3b9c(0x18b)](_0x385a1a,_0x1d351e){const _0x101a0a=_0x3e3b9c,{id:_0x5300bf,client:_0x35762f,role:_0x2eb032}=_0x385a1a['user'];if(_0x35762f&&Number(_0x35762f)>0x0)throw new common_1['HttpException'](_0x101a0a(0x198),common_1[_0x101a0a(0x1ce)][_0x101a0a(0x1e6)]);if(_0x2eb032==='admin')throw new common_1[(_0x101a0a(0x1e7))]('非法操作、请联系管理员！',common_1[_0x101a0a(0x1ce)][_0x101a0a(0x1e6)]);const _0x373df8=await this[_0x101a0a(0x1a9)][_0x101a0a(0x183)](_0x5300bf,_0x1d351e['oldPassword']);if(!_0x373df8)throw new common_1['HttpException'](_0x101a0a(0x1ad),common_1[_0x101a0a(0x1ce)]['BAD_REQUEST']);return this[_0x101a0a(0x1a9)][_0x101a0a(0x1ed)](_0x5300bf,_0x1d351e['password']),_0x101a0a(0x1dc);}async['updatePassByOther'](_0x35882f,_0x5685db){const _0x21f4da=_0x3e3b9c,{id:_0x1112b2,client:_0x24e9cf}=_0x35882f[_0x21f4da(0x17f)];if(!_0x24e9cf)throw new common_1['HttpException'](_0x21f4da(0x19d),common_1[_0x21f4da(0x1ce)][_0x21f4da(0x1e6)]);return this['userService'][_0x21f4da(0x1ed)](_0x1112b2,_0x5685db[_0x21f4da(0x1bf)]),_0x21f4da(0x1dc);}[_0x3e3b9c(0x1ca)](){const _0x22acd2=_0x3e3b9c;let _0x2aed38;const _0x2a45ac=os[_0x22acd2(0x1fd)]();Object['keys'](_0x2a45ac)['forEach'](_0x3b1d9a=>{const _0x521904=_0x22acd2,_0x4058cc=_0x2a45ac[_0x3b1d9a];for(let _0x1aed53=0x0;_0x1aed53<_0x4058cc['length'];_0x1aed53++){const _0x4dad92=_0x4058cc[_0x1aed53];if(_0x4dad92[_0x521904(0x1bc)]===_0x521904(0x18e)&&_0x4dad92[_0x521904(0x1c4)]!=='127.0.0.1'&&!_0x4dad92[_0x521904(0x1e1)]){_0x2aed38=_0x4dad92[_0x521904(0x1c4)];break;}}}),this[_0x22acd2(0x1f6)]=_0x2aed38;}async[_0x3e3b9c(0x1fa)](_0x4ccfd4){const _0x4bfcaa=_0x3e3b9c,_0x160ba3=await this['globalConfigService'][_0x4bfcaa(0x1cc)](),{color:color=_0x4bfcaa(0x1ec)}=_0x4ccfd4,_0x5eeab0=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5c59e6=_0x5eeab0[_0x4bfcaa(0x197)],_0x2425a2=(0x0,utils_1[_0x4bfcaa(0x1e3)])(),_0x6468f7=_0x160ba3+_0x4bfcaa(0x1e9)+_0x2425a2;return await this['redisCacheService'][_0x4bfcaa(0x1f3)]({'key':_0x6468f7,'val':_0x5eeab0[_0x4bfcaa(0x197)]},0x5*0x3c),{'svgCode':_0x5eeab0[_0x4bfcaa(0x19f)],'code':_0x2425a2};}async[_0x3e3b9c(0x1a8)](_0x48fd0a){const _0x22813a=_0x3e3b9c;await this['verificationService']['verifyCaptcha'](_0x48fd0a);const {phone:_0x444549}=_0x48fd0a,_0x2dd4cd=await this[_0x22813a(0x17c)]['getNamespace'](),_0x326f1f=_0x2dd4cd+_0x22813a(0x1a3)+_0x444549,_0x50546f=await this['redisCacheService'][_0x22813a(0x1f5)](_0x326f1f);if(_0x50546f&&_0x50546f>0x0)throw new common_1[(_0x22813a(0x1e7))](_0x50546f+_0x22813a(0x1d2),common_1[_0x22813a(0x1ce)]['BAD_REQUEST']);const _0x4feb47=(0x0,utils_1[_0x22813a(0x1f7)])(),_0x83879a={'phone':_0x444549,'code':_0x4feb47};return await this['verificationService'][_0x22813a(0x1a8)](_0x83879a),await this[_0x22813a(0x1a1)]['set']({'key':_0x326f1f,'val':_0x4feb47},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}[_0x3e3b9c(0x1ae)](_0x2e4bed){const _0xc94395=_0x3e3b9c,_0x534070=this[_0xc94395(0x1f1)][_0xc94395(0x191)]({'username':'游客'+_0x2e4bed,'id':_0x2e4bed,'email':_0x2e4bed+_0xc94395(0x1ba),'role':_0xc94395(0x1f0),'openId':null,'client':null});return _0x534070;}};AuthService=__decorate([(0x0,common_1[_0x3e3b9c(0x1c7)])(),__param(0x0,(0x0,typeorm_2[_0x3e3b9c(0x1d0)])(config_entity_1[_0x3e3b9c(0x1a7)])),__metadata(_0x3e3b9c(0x1dd),[typeorm_1['Repository'],user_service_1[_0x3e3b9c(0x1e5)],jwt_1[_0x3e3b9c(0x1ea)],mailer_service_1['MailerService'],verification_service_1['VerificationService'],userBalance_service_1['UserBalanceService'],redisCache_service_1['RedisCacheService'],globalConfig_service_1[_0x3e3b9c(0x1db)]])],AuthService),exports['AuthService']=AuthService;