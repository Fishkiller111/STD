'use strict';const _0x1450a0=_0x18d2;(function(_0x59db25,_0x513f43){const _0x5043f6=_0x18d2,_0x2d756f=_0x59db25();while(!![]){try{const _0x3aff91=-parseInt(_0x5043f6(0x199))/0x1*(parseInt(_0x5043f6(0x18a))/0x2)+parseInt(_0x5043f6(0x17f))/0x3*(parseInt(_0x5043f6(0x17d))/0x4)+parseInt(_0x5043f6(0xf5))/0x5*(parseInt(_0x5043f6(0x125))/0x6)+-parseInt(_0x5043f6(0xfa))/0x7+-parseInt(_0x5043f6(0x12f))/0x8*(parseInt(_0x5043f6(0x11e))/0x9)+parseInt(_0x5043f6(0x169))/0xa+-parseInt(_0x5043f6(0x184))/0xb*(parseInt(_0x5043f6(0xfe))/0xc);if(_0x3aff91===_0x513f43)break;else _0x2d756f['push'](_0x2d756f['shift']());}catch(_0x436572){_0x2d756f['push'](_0x2d756f['shift']());}}}(_0x27d2,0xec2ef));function _0x27d2(){const _0x308b48=['type','queryEpay','notifyPockyt','@nestjs/typeorm','payEpaySecret','text','success','scene_info','192.168.1.100','2644660OzwKAC','join','3DCRJwx','payMpayApiQueryUrl','goodsId','unsupported\x20pay\x20type','message','22yuBQtu','alipay','../user/user.service','queryWeChat','支付请求失败!','transactions_h5','4Acisvn','time','map','UserBalanceService','TRANSACTION.SUCCESS','query','payHupiSecret','out_trade_no','resource','hex','toFixed','../crami/cramiPackage.entity','object','mpay','PayService','206237MAdwwM','design:paramtypes','order:','校验签名通过','event_type','__esModule','total_fee','response','data','payEpayApiQueryUrl','payWeChatMchId','name','log','money','payMpayPid','payType:\x20','keys','payMpaySecret','payWeChatPublicKey','status:\x20','15YUsbhk','affected','payWeChat','globalConfigService','套餐不存在!','913360fCqDMt','本次支付类型:\x20','pay','createRandomNonceStr','4759548ECTnfz','wxpay','payEpayPid','@nestjs/common','jsapi','payWeChatAppId','payEpay','createHash','payMpayReturnUrl','SUCCESS','nonce_str','trade_order_id','payHupi','post','getConfigs','param','transactions_jsapi','payWeChatNotifyUrl','pid','payWeChatPrivateKey','clientip','wechat-pay:\x20','getOpenIdByUserId','status','function','notify','epay','update','trade_status','1.1','notifyWeChat','../userBalance/userBalance.service','63mJqtRk','decorate','notifyMpay','../../common/utils','onModuleInit','userService','wechatpay-node-v3','1937394rQgBSx','decipher_gcm','key','payWeChatSecret','native','Injectable','trade_state','notifyEpay','metadata','hash','1363112dtvUWj','errRaw','CramiPackageEntity','订单不存在!','notifyHupi','微信支付通知params:\x20','includes','order','getOwnPropertyDescriptor','get','out_trade_order','BAD_REQUEST','支付请求失败:\x20','return_url','../globalConfig/globalConfig.service','payEpayApiPayUrl','jsapi支付结果返回值:\x20','notify_url','payPlatform','payHupiAppId','total','userBalanceService','payHupiGatewayUrl','payHupiNotifyUrl','default','sign','HttpStatus','MD5','../order/order.entity','Repository','reference','version','now','h5_info','title','OrderEntity','appid','TRADE_SUCCESS','InjectRepository','importDynamic','findOne','attach','defineProperty','failed','crypto','addBalanceToOrder','transactions_native','axios','__metadata','HttpException','__param','校验签名','WxPay','length','payHupiReturnUrl','用户openId:\x20','digest','toString','18664800FKeyTC','typeorm','error:\x20','sign_type','md5','GlobalConfigService','orderEntity','hupi','cramiPackageEntity','payMpayNotifyUrl','payMpayApiPayUrl'];_0x27d2=function(){return _0x308b48;};return _0x27d2();}function _0x18d2(_0x20e8b4,_0x2b528a){const _0x27d237=_0x27d2();return _0x18d2=function(_0x18d2ae,_0x45e26e){_0x18d2ae=_0x18d2ae-0xf3;let _0x1beb54=_0x27d237[_0x18d2ae];return _0x1beb54;},_0x18d2(_0x20e8b4,_0x2b528a);}var __decorate=this&&this['__decorate']||function(_0x30deed,_0x5975b6,_0x3ab877,_0x27c6c0){const _0x3ca6ba=_0x18d2;var _0x4093a2=arguments[_0x3ca6ba(0x164)],_0x4c861d=_0x4093a2<0x3?_0x5975b6:_0x27c6c0===null?_0x27c6c0=Object[_0x3ca6ba(0x137)](_0x5975b6,_0x3ab877):_0x27c6c0,_0x2b7db5;if(typeof Reflect===_0x3ca6ba(0x196)&&typeof Reflect[_0x3ca6ba(0x11f)]===_0x3ca6ba(0x116))_0x4c861d=Reflect[_0x3ca6ba(0x11f)](_0x30deed,_0x5975b6,_0x3ab877,_0x27c6c0);else{for(var _0x428718=_0x30deed[_0x3ca6ba(0x164)]-0x1;_0x428718>=0x0;_0x428718--)if(_0x2b7db5=_0x30deed[_0x428718])_0x4c861d=(_0x4093a2<0x3?_0x2b7db5(_0x4c861d):_0x4093a2>0x3?_0x2b7db5(_0x5975b6,_0x3ab877,_0x4c861d):_0x2b7db5(_0x5975b6,_0x3ab877))||_0x4c861d;}return _0x4093a2>0x3&&_0x4c861d&&Object[_0x3ca6ba(0x159)](_0x5975b6,_0x3ab877,_0x4c861d),_0x4c861d;},__metadata=this&&this[_0x1450a0(0x15f)]||function(_0x53199a,_0xc4cc94){const _0x4c97c5=_0x1450a0;if(typeof Reflect==='object'&&typeof Reflect[_0x4c97c5(0x12d)]===_0x4c97c5(0x116))return Reflect['metadata'](_0x53199a,_0xc4cc94);},__param=this&&this[_0x1450a0(0x161)]||function(_0xf071a0,_0xe74022){return function(_0x4ae106,_0x3afe99){_0xe74022(_0x4ae106,_0x3afe99,_0xf071a0);};};Object[_0x1450a0(0x159)](exports,_0x1450a0(0x19e),{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require(_0x1450a0(0x177)),typeorm_2=require(_0x1450a0(0x16a)),common_1=require(_0x1450a0(0x101)),crypto=require(_0x1450a0(0x15b)),axios_1=require(_0x1450a0(0x15e)),order_entity_1=require(_0x1450a0(0x14b)),cramiPackage_entity_1=require(_0x1450a0(0x195)),userBalance_service_1=require(_0x1450a0(0x11d)),globalConfig_service_1=require(_0x1450a0(0x13d)),utils_1=require(_0x1450a0(0x121)),user_service_1=require(_0x1450a0(0x186));let PayService=class PayService{constructor(_0x4bde4f,_0x170c40,_0x45068e,_0x96c8af,_0xa8af35){const _0x97eb70=_0x1450a0;this[_0x97eb70(0x171)]=_0x4bde4f,this[_0x97eb70(0x16f)]=_0x170c40,this[_0x97eb70(0x144)]=_0x45068e,this['globalConfigService']=_0x96c8af,this[_0x97eb70(0x123)]=_0xa8af35;}async[_0x1450a0(0x122)](){const _0x2d6811=_0x1450a0,_0x50fb5b=await(0x0,utils_1[_0x2d6811(0x156)])(_0x2d6811(0x124));this[_0x2d6811(0x163)]=(_0x50fb5b===null||_0x50fb5b===void 0x0?void 0x0:_0x50fb5b['default'])?_0x50fb5b['default']:_0x50fb5b;}async[_0x1450a0(0x117)](_0x38c224){const _0x12a3d8=_0x1450a0;if(_0x38c224[_0x12a3d8(0x10d)]==_0x12a3d8(0x118))return this['notifyEpay'](_0x38c224);if(_0x38c224['attach']==_0x12a3d8(0x170))return this[_0x12a3d8(0x133)](_0x38c224);if(_0x38c224['verifySign']!=='')return this['notifyPockyt'](_0x38c224);if(typeof _0x38c224[_0x12a3d8(0x192)]=='object')return this[_0x12a3d8(0x11c)](_0x38c224);return this[_0x12a3d8(0x120)](_0x38c224);}async[_0x1450a0(0xfc)](_0x52a4e8,_0x393b6c,_0x2c4182='wxpay'){const _0x49c6c0=_0x1450a0,_0x460635=await this['orderEntity']['findOne']({'where':{'userId':_0x52a4e8,'orderId':_0x393b6c}});if(!_0x460635)throw new common_1['HttpException'](_0x49c6c0(0x132),common_1[_0x49c6c0(0x149)][_0x49c6c0(0x13a)]);const _0x3f653b=await this[_0x49c6c0(0x171)][_0x49c6c0(0x157)]({'where':{'id':_0x460635[_0x49c6c0(0x181)]}});if(!_0x3f653b)throw new common_1[(_0x49c6c0(0x160))](_0x49c6c0(0xf9),common_1[_0x49c6c0(0x149)][_0x49c6c0(0x13a)]);console[_0x49c6c0(0x1a5)](_0x49c6c0(0xfb),_0x460635[_0x49c6c0(0x141)]);try{if(_0x460635['payPlatform']=='wechat')return this[_0x49c6c0(0xf7)](_0x52a4e8,_0x393b6c,_0x2c4182);if(_0x460635[_0x49c6c0(0x141)]==_0x49c6c0(0x118))return this['payEpay'](_0x52a4e8,_0x393b6c,_0x2c4182);if(_0x460635['payPlatform']==_0x49c6c0(0x197))return this['payMpay'](_0x52a4e8,_0x393b6c,_0x2c4182);if(_0x460635['payPlatform']==_0x49c6c0(0x170))return this['payHupi'](_0x52a4e8,_0x393b6c,_0x2c4182);}catch(_0x41559a){console['log'](_0x49c6c0(0x13b),_0x41559a);throw new common_1[(_0x49c6c0(0x160))](_0x49c6c0(0x188),common_1[_0x49c6c0(0x149)][_0x49c6c0(0x13a)]);}}async[_0x1450a0(0x18f)](_0x3b6639){const _0x1a0a71=_0x1450a0,_0x2d85d8=await this[_0x1a0a71(0x16f)][_0x1a0a71(0x157)]({'where':{'orderId':_0x3b6639}});if(!_0x2d85d8)throw new common_1['HttpException'](_0x1a0a71(0x132),common_1[_0x1a0a71(0x149)][_0x1a0a71(0x13a)]);return _0x2d85d8;}async[_0x1450a0(0x176)](_0x3f2484){const _0x751872=_0x1450a0,_0x337c5f=_0x3f2484[_0x751872(0x14d)],_0x2122f1=await this['orderEntity']['findOne']({'where':{'orderId':_0x337c5f}});console['log'](_0x751872(0x19b)+_0x2122f1);if(!_0x2122f1)return _0x751872(0x15a);const _0x7605dd=await this[_0x751872(0x16f)][_0x751872(0x119)]({'orderId':_0x337c5f},{'status':0x1,'paydAt':new Date()});if(_0x7605dd[_0x751872(0xf6)]!=0x1)return _0x751872(0x15a);return await this[_0x751872(0x144)]['addBalanceToOrder'](_0x2122f1),'success';}async[_0x1450a0(0x133)](_0x4299fa){const _0x12a894=_0x1450a0,_0x275298=await this[_0x12a894(0xf8)][_0x12a894(0x10c)]([_0x12a894(0x190)]),_0x563c5a=_0x4299fa[_0x12a894(0x12e)];delete _0x4299fa[_0x12a894(0x12e)];if(this['sign'](_0x4299fa,_0x275298)!=_0x563c5a)return'failed';const _0x3f21e6=await this['orderEntity'][_0x12a894(0x157)]({'where':{'orderId':_0x4299fa[_0x12a894(0x109)],'status':0x0}});if(!_0x3f21e6)return _0x12a894(0x15a);await this[_0x12a894(0x144)][_0x12a894(0x15c)](_0x3f21e6);const _0x32a1aa=await this[_0x12a894(0x16f)][_0x12a894(0x119)]({'orderId':_0x4299fa[_0x12a894(0x109)]},{'status':0x1,'paydAt':new Date()});if(_0x32a1aa['affected']!=0x1)return'failed';return'success';}async[_0x1450a0(0x10a)](_0x5a2fa0,_0xb12028,_0x390364=_0x1450a0(0xff)){const _0x1543f7=_0x1450a0,_0x27ae73=await this['orderEntity'][_0x1543f7(0x157)]({'where':{'userId':_0x5a2fa0,'orderId':_0xb12028}});if(!_0x27ae73)throw new common_1['HttpException'](_0x1543f7(0x132),common_1[_0x1543f7(0x149)][_0x1543f7(0x13a)]);const _0xb75abb=await this[_0x1543f7(0x171)][_0x1543f7(0x157)]({'where':{'id':_0x27ae73[_0x1543f7(0x181)]}});if(!_0xb75abb)throw new common_1[(_0x1543f7(0x160))](_0x1543f7(0xf9),common_1[_0x1543f7(0x149)][_0x1543f7(0x13a)]);const {payHupiAppId:_0x1af9b7,payHupiSecret:_0xda7b5,payHupiNotifyUrl:_0x27f59d,payHupiReturnUrl:_0x479cf7,payHupiGatewayUrl:_0x56a1c6}=await this[_0x1543f7(0xf8)]['getConfigs']([_0x1543f7(0x142),'payHupiSecret',_0x1543f7(0x146),_0x1543f7(0x165),_0x1543f7(0x145)]),_0x3607ae={};_0x3607ae[_0x1543f7(0x14e)]='1.1',_0x3607ae[_0x1543f7(0x153)]=_0x1af9b7,_0x3607ae[_0x1543f7(0x18b)]=(Date[_0x1543f7(0x14f)]()/0x3e8)[_0x1543f7(0x194)](0x0),_0x3607ae[_0x1543f7(0x108)]=(0x0,utils_1[_0x1543f7(0xfd)])(0x20),_0x3607ae['trade_order_id']=_0xb12028,_0x3607ae[_0x1543f7(0x151)]=_0xb75abb['name'],_0x3607ae[_0x1543f7(0x19f)]=_0x27ae73[_0x1543f7(0x143)],_0x3607ae[_0x1543f7(0x140)]=_0x27f59d,_0x3607ae[_0x1543f7(0x13c)]=_0x479cf7,_0x3607ae[_0x1543f7(0x158)]=_0x1543f7(0x170),_0x3607ae[_0x1543f7(0x12e)]=this['sign'](_0x3607ae,_0xda7b5);const {data:{errcode:_0x47ca61,errmsg:_0xb8a512,url_qrcode:_0x14ed8c,url:_0x17a9c3}}=await axios_1[_0x1543f7(0x147)][_0x1543f7(0x10b)](_0x56a1c6||'https://api.xunhupay.com/payment/do.html',_0x3607ae);if(_0x47ca61!=0x0)throw new common_1['HttpException'](_0xb8a512,common_1[_0x1543f7(0x149)][_0x1543f7(0x13a)]);return{'url_qrcode':_0x14ed8c,'url':_0x17a9c3};}async['queryHupi'](_0x262703){const _0x9690c1=_0x1450a0,{payHupiAppId:_0x2b8fc1,payHupiSecret:_0x722e8a}=await this[_0x9690c1(0xf8)]['getConfigs'](['payHupiAppId',_0x9690c1(0x190)]),_0x44ac4a={};_0x44ac4a[_0x9690c1(0x14e)]=_0x9690c1(0x11b),_0x44ac4a[_0x9690c1(0x153)]=_0x2b8fc1,_0x44ac4a['time']=(Date['now']()/0x3e8)['toFixed'](0x0),_0x44ac4a[_0x9690c1(0x108)]=(0x0,utils_1[_0x9690c1(0xfd)])(0x20),_0x44ac4a[_0x9690c1(0x139)]=_0x262703,_0x44ac4a[_0x9690c1(0x12e)]=this[_0x9690c1(0x148)](_0x44ac4a,_0x722e8a);const {data:{errcode:_0x2e0beb,errmsg:_0x412b85,data:_0xedfa7}}=await axios_1[_0x9690c1(0x147)][_0x9690c1(0x10b)]('https://api.xunhupay.com/payment/query.html',_0x44ac4a);if(_0x2e0beb!=0x0)throw new common_1[(_0x9690c1(0x160))](_0x412b85,common_1[_0x9690c1(0x149)][_0x9690c1(0x13a)]);return _0xedfa7;}async[_0x1450a0(0x12c)](_0x28e4ee){const _0x316fbc=_0x1450a0,_0x5ab569=_0x28e4ee[_0x316fbc(0x148)];delete _0x28e4ee[_0x316fbc(0x148)],delete _0x28e4ee[_0x316fbc(0x16c)];const _0x24512b=await this[_0x316fbc(0xf8)]['getConfigs']([_0x316fbc(0x178)]);if(this['sign'](_0x28e4ee,_0x24512b)!=_0x5ab569)return _0x316fbc(0x15a);console[_0x316fbc(0x1a5)](_0x316fbc(0x19c));const _0x1fbce4=await this[_0x316fbc(0x16f)]['findOne']({'where':{'orderId':_0x28e4ee[_0x316fbc(0x191)],'status':0x0}});if(!_0x1fbce4)return'failed';const _0xbd771f=_0x28e4ee[_0x316fbc(0x11a)]==_0x316fbc(0x154)?0x1:0x2,_0x261198=await this[_0x316fbc(0x16f)][_0x316fbc(0x119)]({'orderId':_0x28e4ee['out_trade_no']},{'status':_0xbd771f,'paydAt':new Date()});_0xbd771f===0x1&&await this[_0x316fbc(0x144)][_0x316fbc(0x15c)](_0x1fbce4);if(_0x261198[_0x316fbc(0xf6)]!=0x1)return'failed';return _0x316fbc(0x17a);}async[_0x1450a0(0x104)](_0x190deb,_0x4b5367,_0x14cc01=_0x1450a0(0x185)){const _0x3b847c=_0x1450a0,_0x2f1c73=await this['orderEntity'][_0x3b847c(0x157)]({'where':{'userId':_0x190deb,'orderId':_0x4b5367}});if(!_0x2f1c73)throw new common_1['HttpException'](_0x3b847c(0x132),common_1[_0x3b847c(0x149)][_0x3b847c(0x13a)]);const _0x4f4794=await this['cramiPackageEntity'][_0x3b847c(0x157)]({'where':{'id':_0x2f1c73[_0x3b847c(0x181)]}});if(!_0x4f4794)throw new common_1[(_0x3b847c(0x160))](_0x3b847c(0xf9),common_1[_0x3b847c(0x149)]['BAD_REQUEST']);const {payEpayPid:_0x40f120,payEpaySecret:_0x69df48,payEpayNotifyUrl:_0x40c3a6,payEpayReturnUrl:_0x11dd4d,payEpayApiPayUrl:_0x4cb719}=await this['globalConfigService'][_0x3b847c(0x10c)](['payEpayPid',_0x3b847c(0x178),'payEpayNotifyUrl','payEpayReturnUrl',_0x3b847c(0x13e)]);let _0x442760;_0x40f120[_0x3b847c(0x164)]<=0x10?_0x442760=Number(_0x40f120):_0x442760=BigInt(_0x40f120);const _0x1813de={};_0x1813de[_0x3b847c(0x110)]=_0x442760,_0x1813de[_0x3b847c(0x174)]=_0x14cc01,_0x1813de[_0x3b847c(0x191)]=_0x4b5367,_0x1813de['name']=_0x4f4794[_0x3b847c(0x1a4)],_0x1813de[_0x3b847c(0x1a6)]=_0x2f1c73[_0x3b847c(0x143)],_0x1813de[_0x3b847c(0x112)]='192.168.1.100',_0x1813de['device']='pc',_0x1813de[_0x3b847c(0x140)]=_0x40c3a6,_0x1813de[_0x3b847c(0x13c)]=_0x11dd4d,_0x1813de[_0x3b847c(0x10d)]=_0x3b847c(0x118),_0x1813de[_0x3b847c(0x148)]=this[_0x3b847c(0x148)](_0x1813de,_0x69df48),_0x1813de[_0x3b847c(0x16c)]=_0x3b847c(0x14a);const _0x16d924=new URLSearchParams(_0x1813de)[_0x3b847c(0x168)](),_0x42b753=_0x4cb719+'?'+_0x16d924;if(_0x4cb719[_0x3b847c(0x135)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x42b753,'channel':_0x14cc01,'isRedirect':!![]};else{const _0x28c0aa=await axios_1[_0x3b847c(0x147)][_0x3b847c(0x138)](_0x4cb719,{'params':_0x1813de});console['log']('epay\x20--->\x20res:\x20',_0x28c0aa[_0x3b847c(0x1a1)]);const {data:{code:_0x447f86,msg:_0x5d8e8c,qrcode:_0x5344c7}}=_0x28c0aa;if(_0x447f86!=0x1)throw new common_1[(_0x3b847c(0x160))](_0x5d8e8c,common_1[_0x3b847c(0x149)][_0x3b847c(0x13a)]);return{'url_qrcode':_0x5344c7,'redirectUrl':null,'channel':_0x14cc01,'isRedirect':![]};}}async[_0x1450a0(0x175)](_0x4b609a){const _0x2b070b=_0x1450a0,{payEpayPid:_0x500fcc,payEpaySecret:_0xa90bf6,payEpayApiQueryUrl:_0x26cca4}=await this[_0x2b070b(0xf8)][_0x2b070b(0x10c)]([_0x2b070b(0x100),_0x2b070b(0x178),_0x2b070b(0x1a2)]),_0x5cd67e={};_0x5cd67e['act']=_0x2b070b(0x136),_0x5cd67e[_0x2b070b(0x191)]=_0x4b609a,_0x5cd67e[_0x2b070b(0x110)]=_0x500fcc,_0x5cd67e[_0x2b070b(0x127)]=_0xa90bf6;const {data:{code:_0x4c3ae6,msg:_0xa98e73,data:_0x512627}}=await axios_1[_0x2b070b(0x147)][_0x2b070b(0x138)](_0x26cca4,{'params':_0x5cd67e});if(_0x4c3ae6!=0x1)throw new common_1[(_0x2b070b(0x160))](_0xa98e73,common_1[_0x2b070b(0x149)][_0x2b070b(0x13a)]);return _0x512627;}async['notifyMpay'](_0x3a42d9){const _0x359943=_0x1450a0,_0x5a0c0d=_0x3a42d9['sign'];delete _0x3a42d9[_0x359943(0x148)],delete _0x3a42d9['sign_type'];const _0x304924=await this[_0x359943(0xf8)]['getConfigs']([_0x359943(0x1aa)]);console['log'](_0x359943(0x162));if(this[_0x359943(0x148)](_0x3a42d9,_0x304924)!=_0x5a0c0d)return _0x359943(0x15a);console['log'](_0x359943(0x19c));const _0x3ba2b9=await this[_0x359943(0x16f)]['findOne']({'where':{'orderId':_0x3a42d9['out_trade_no'],'status':0x0}});if(!_0x3ba2b9)return _0x359943(0x15a);const _0x2e3b54=_0x3a42d9[_0x359943(0x11a)]==_0x359943(0x154)?0x1:0x2;console[_0x359943(0x1a5)](_0x359943(0xf4),_0x2e3b54);const _0x2b0ec1=await this[_0x359943(0x16f)]['update']({'orderId':_0x3a42d9[_0x359943(0x191)]},{'status':_0x2e3b54,'paydAt':new Date()});_0x2e3b54===0x1&&await this[_0x359943(0x144)][_0x359943(0x15c)](_0x3ba2b9);if(_0x2b0ec1[_0x359943(0xf6)]!=0x1)return _0x359943(0x15a);return _0x359943(0x17a);}async['payMpay'](_0x175a11,_0x3b29fd,_0x597d28=_0x1450a0(0xff)){const _0x169720=_0x1450a0,_0x1950af=await this[_0x169720(0x16f)][_0x169720(0x157)]({'where':{'userId':_0x175a11,'orderId':_0x3b29fd}});if(!_0x1950af)throw new common_1[(_0x169720(0x160))]('订单不存在!',common_1[_0x169720(0x149)][_0x169720(0x13a)]);const _0x4276d9=await this[_0x169720(0x171)][_0x169720(0x157)]({'where':{'id':_0x1950af['goodsId']}});if(!_0x4276d9)throw new common_1[(_0x169720(0x160))](_0x169720(0xf9),common_1[_0x169720(0x149)][_0x169720(0x13a)]);const {payMpayPid:_0x358926,payMpaySecret:_0x35addf,payMpayNotifyUrl:_0x1e624a,payMpayReturnUrl:_0x543d97,payMpayApiPayUrl:_0x111d9e}=await this[_0x169720(0xf8)][_0x169720(0x10c)]([_0x169720(0x1a7),_0x169720(0x1aa),_0x169720(0x172),_0x169720(0x106),_0x169720(0x173)]),_0x71e628={};_0x71e628[_0x169720(0x110)]=Number(_0x358926),_0x71e628['type']=_0x597d28,_0x71e628[_0x169720(0x191)]=_0x3b29fd,_0x71e628[_0x169720(0x1a4)]=_0x4276d9[_0x169720(0x1a4)],_0x71e628[_0x169720(0x1a6)]=_0x1950af[_0x169720(0x143)],_0x71e628[_0x169720(0x140)]=_0x1e624a,_0x71e628[_0x169720(0x13c)]=_0x543d97,_0x71e628['sign']=this['sign'](_0x71e628,_0x35addf),_0x71e628['sign_type']=_0x169720(0x14a);const _0xb979e0=new URLSearchParams(_0x71e628)[_0x169720(0x168)](),_0x17d960=_0x111d9e+'?'+_0xb979e0;return{'url_qrcode':null,'redirectUrl':_0x17d960,'channel':_0x597d28,'isRedirect':!![]};const _0x1610de=await axios_1[_0x169720(0x147)][_0x169720(0x138)](_0x111d9e,{'params':_0x71e628});}async['queryMpay'](_0x3a24ac){const _0x371fd5=_0x1450a0,{payMpayApiQueryUrl:_0x41eba1}=await this[_0x371fd5(0xf8)][_0x371fd5(0x10c)]([_0x371fd5(0x1a7),'payMpaySecret',_0x371fd5(0x180)]),_0x3c3dd0={};_0x3c3dd0[_0x371fd5(0x174)]=0x2,_0x3c3dd0['order_no']=_0x3a24ac;const {data:{code:_0x40705b,msg:_0x1023fa,data:_0x2a26ec}}=await axios_1[_0x371fd5(0x147)][_0x371fd5(0x138)](_0x41eba1,{'params':_0x3c3dd0});if(_0x40705b!=0x1)throw new common_1[(_0x371fd5(0x160))](_0x1023fa,common_1[_0x371fd5(0x149)][_0x371fd5(0x13a)]);return _0x2a26ec;}async['notifyWeChat'](_0x4bbc39){const _0xd37443=_0x1450a0;console['log'](_0xd37443(0x134),_0x4bbc39);const {payWeChatAppId:_0x31e201,payWeChatMchId:_0x4d922d,payWeChatSecret:_0x55301e,payWeChatPublicKey:_0x5a9cce,payWeChatPrivateKey:_0x2f5a6c}=await this[_0xd37443(0xf8)]['getConfigs']([_0xd37443(0x103),_0xd37443(0x1a3),_0xd37443(0x128),_0xd37443(0xf3),'payWeChatPrivateKey']),_0x1420e4=new this[(_0xd37443(0x163))]({'appid':_0x31e201,'mchid':_0x4d922d,'publicKey':_0x5a9cce,'privateKey':_0x2f5a6c});try{if(_0x4bbc39[_0xd37443(0x19d)]==_0xd37443(0x18e)){const {ciphertext:_0x932eb0,associated_data:_0x13ee1d,nonce:_0x9fe8ae}=_0x4bbc39[_0xd37443(0x192)],_0x55e6e8=_0x1420e4[_0xd37443(0x126)](_0x932eb0,_0x13ee1d,_0x9fe8ae,_0x55301e),_0x584296=await this[_0xd37443(0x16f)][_0xd37443(0x157)]({'where':{'orderId':_0x55e6e8[_0xd37443(0x191)],'status':0x0}});if(!_0x584296)return _0xd37443(0x15a);const _0xa78055=_0x55e6e8[_0xd37443(0x12b)]==_0xd37443(0x107)?0x1:0x2,_0x329c64=await this[_0xd37443(0x16f)][_0xd37443(0x119)]({'orderId':_0x55e6e8[_0xd37443(0x191)]},{'status':_0xa78055,'paydAt':new Date()});_0xa78055===0x1&&await this['userBalanceService'][_0xd37443(0x15c)](_0x584296);if(_0x329c64[_0xd37443(0xf6)]!=0x1)return _0xd37443(0x15a);}return _0xd37443(0x17a);}catch(_0x475ceb){return console[_0xd37443(0x1a5)](_0xd37443(0x16b),_0x475ceb),console[_0xd37443(0x1a5)]('支付通知验证失败:\x20',_0x475ceb),'failed';}}async['payWeChat'](_0x5b33e0,_0x42cbd7,_0x392be3=_0x1450a0(0x129)){const _0x51a7c4=_0x1450a0;var _0x2965c7,_0x1d1339,_0x19561e;console['log'](_0x51a7c4(0x1a8),_0x392be3);const _0xdd8850=await this['orderEntity'][_0x51a7c4(0x157)]({'where':{'userId':_0x5b33e0,'orderId':_0x42cbd7}});if(!_0xdd8850)throw new common_1[(_0x51a7c4(0x160))](_0x51a7c4(0x132),common_1[_0x51a7c4(0x149)][_0x51a7c4(0x13a)]);const _0x506718=await this[_0x51a7c4(0x171)][_0x51a7c4(0x157)]({'where':{'id':_0xdd8850['goodsId']}});if(!_0x506718)throw new common_1[(_0x51a7c4(0x160))](_0x51a7c4(0xf9),common_1['HttpStatus'][_0x51a7c4(0x13a)]);const {payWeChatAppId:_0xd728e5,payWeChatMchId:_0x15f17a,payWeChatPublicKey:_0x355942,payWeChatPrivateKey:_0x3d7175,payWeChatNotifyUrl:_0x2d358e,payWeChatH5Name:_0x381ed5,payWeChatH5Url:_0x5ef6b2}=await this[_0x51a7c4(0xf8)][_0x51a7c4(0x10c)]([_0x51a7c4(0x103),_0x51a7c4(0x1a3),_0x51a7c4(0xf3),_0x51a7c4(0x111),_0x51a7c4(0x10f),'payWeChatH5Name','payWeChatH5Url']),_0xa72599=new this[(_0x51a7c4(0x163))]({'appid':_0xd728e5,'mchid':_0x15f17a,'publicKey':_0x355942,'privateKey':_0x3d7175}),_0x5ccfdc={'appid':_0xd728e5,'mchid':_0x15f17a,'description':_0x506718[_0x51a7c4(0x1a4)],'out_trade_no':_0x42cbd7,'notify_url':_0x2d358e,'amount':{'total':Number(_0xdd8850['total']*0x64)},'scene_info':{'payer_client_ip':_0x51a7c4(0x17c)}};console['log'](_0x51a7c4(0x113),_0x5ccfdc);if(_0x392be3=='h5'){_0x5ccfdc[_0x51a7c4(0x17b)][_0x51a7c4(0x150)]={'type':'Wap','app_name':_0x381ed5,'app_url':_0x5ef6b2};const _0x5616cd=await _0xa72599[_0x51a7c4(0x189)](_0x5ccfdc);if(_0x5616cd[_0x51a7c4(0x115)]===0x193){const _0x3221cf=(_0x19561e=(_0x1d1339=(_0x2965c7=_0x5616cd===null||_0x5616cd===void 0x0?void 0x0:_0x5616cd[_0x51a7c4(0x130)])===null||_0x2965c7===void 0x0?void 0x0:_0x2965c7[_0x51a7c4(0x1a0)])===null||_0x1d1339===void 0x0?void 0x0:_0x1d1339[_0x51a7c4(0x179)])===null||_0x19561e===void 0x0?void 0x0:_0x19561e[_0x51a7c4(0x183)];throw new common_1[(_0x51a7c4(0x160))]((_0x5616cd===null||_0x5616cd===void 0x0?void 0x0:_0x5616cd['message'])||'微信H5支付失败！',common_1['HttpStatus'][_0x51a7c4(0x13a)]);}const {h5_url:_0x1b9fb7}=_0x5616cd;return{'url':_0x1b9fb7};}if(_0x392be3==_0x51a7c4(0x102)){const _0x1734a5=await this[_0x51a7c4(0x123)][_0x51a7c4(0x114)](_0x5b33e0);console[_0x51a7c4(0x1a5)](_0x51a7c4(0x166),_0x1734a5),_0x5ccfdc['payer']={'openid':_0x1734a5};const _0x58da79=await _0xa72599[_0x51a7c4(0x10e)](_0x5ccfdc);return console['log'](_0x51a7c4(0x13f),_0x58da79),_0x58da79;}if(_0x392be3==_0x51a7c4(0x129)){const _0x55c2b0=await _0xa72599[_0x51a7c4(0x15d)](_0x5ccfdc),{code_url:_0x4080a7}=_0x55c2b0;return!_0x4080a7&&console['log']('wx-native',_0x55c2b0),{'url_qrcode':_0x4080a7,'isRedirect':![]};}throw new common_1[(_0x51a7c4(0x160))](_0x51a7c4(0x182),common_1[_0x51a7c4(0x149)][_0x51a7c4(0x13a)]);}async[_0x1450a0(0x187)](_0x9eb432){const _0x39561c=_0x1450a0,{payWeChatAppId:_0x1aef2d,payWeChatMchId:_0x395237,payWeChatPublicKey:_0x199892,payWeChatPrivateKey:_0x35e214,payWeChatNotifyUrl:_0xa7e49d,payWeChatH5Name:_0x3993d5,payWeChatH5Url:_0x447258}=await this[_0x39561c(0xf8)][_0x39561c(0x10c)]([_0x39561c(0x103),'payWeChatMchId',_0x39561c(0xf3),_0x39561c(0x111)]),_0x2a9d3f=new this[(_0x39561c(0x163))]({'appid':_0x1aef2d,'mchid':_0x395237,'publicKey':_0x199892,'privateKey':_0x35e214}),_0x4c91ee=await _0x2a9d3f[_0x39561c(0x18f)]({'out_trade_no':_0x9eb432});return _0x4c91ee;}[_0x1450a0(0x148)](_0x361225,_0x34a9ef){const _0x506e6e=_0x1450a0,_0x2aa1a3=Object[_0x506e6e(0x1a9)](_0x361225)['sort']()[_0x506e6e(0x18c)](_0x215a77=>_0x215a77+'='+_0x361225[_0x215a77])[_0x506e6e(0x17e)]('&')+_0x34a9ef;return crypto[_0x506e6e(0x105)](_0x506e6e(0x16d))[_0x506e6e(0x119)](_0x2aa1a3)[_0x506e6e(0x167)](_0x506e6e(0x193));}};PayService=__decorate([(0x0,common_1[_0x1450a0(0x12a)])(),__param(0x0,(0x0,typeorm_1[_0x1450a0(0x155)])(cramiPackage_entity_1[_0x1450a0(0x131)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x1450a0(0x152)])),__metadata(_0x1450a0(0x19a),[typeorm_2[_0x1450a0(0x14c)],typeorm_2[_0x1450a0(0x14c)],userBalance_service_1[_0x1450a0(0x18d)],globalConfig_service_1[_0x1450a0(0x16e)],user_service_1['UserService']])],PayService),exports[_0x1450a0(0x198)]=PayService;