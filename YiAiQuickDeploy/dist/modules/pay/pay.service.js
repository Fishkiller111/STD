'use strict';const _0x5068fc=_0x17c3;(function(_0x597f6d,_0x14dee3){const _0x506681=_0x17c3,_0xea3e4f=_0x597f6d();while(!![]){try{const _0x5569ca=parseInt(_0x506681(0x100))/0x1+parseInt(_0x506681(0x107))/0x2+-parseInt(_0x506681(0x120))/0x3+parseInt(_0x506681(0x16d))/0x4*(-parseInt(_0x506681(0x168))/0x5)+-parseInt(_0x506681(0x10a))/0x6+-parseInt(_0x506681(0x15a))/0x7+parseInt(_0x506681(0x160))/0x8;if(_0x5569ca===_0x14dee3)break;else _0xea3e4f['push'](_0xea3e4f['shift']());}catch(_0x10af12){_0xea3e4f['push'](_0xea3e4f['shift']());}}}(_0x17a1,0x591d8));function _0x17a1(){const _0x24903f=['3313415HHvLlX','event_type','hex','out_trade_no','@nestjs/typeorm','queryHupi','10650072YQVExa','payWeChatMchId','payWeChatPrivateKey','payMpay','total','payHupiGatewayUrl','pay','payMpayReturnUrl','507585qDNANs','1.1','payEpay','192.168.1.100','epay','20VnamaD','version','attach','getConfigs','generateSign','message','resource','orderEntity','device','post','../../common/utils/verifySign','校验签名','success','payHupiReturnUrl','PayService','payHupiSecret','alipay','time','name','defineProperty','native','metadata','trade_state','payMpaySecret','WxPay','payEpayReturnUrl','订单不存在!','findOne','length','套餐不存在!','queryEpay','addBalanceToOrder','payMpayPid','微信H5支付失败！','text','getOpenIdByUserId','UserBalanceService','error:\x20','importDynamic','return_url','onModuleInit','notifyHupi','function','Repository','payMpayNotifyUrl','typeorm','__metadata','key','query','failed','createRandomNonceStr','get','status:\x20','clientip','order','affected','../crami/cramiPackage.entity','update','default','appid','支付请求失败:\x20','payWeChatAppId','data','notify_url','支付通知验证失败:\x20','payMpayApiQueryUrl','userBalanceService','payPlatform','648906CqSbjx','queryMpay','TRADE_SUCCESS','payWeChatSecret','globalConfigService','generateVerifySign','payWeChatH5Name','275620YZqnne','status','notifyMpay','928350bxlAlD','now','payEpayPid','getOwnPropertyDescriptor','https://api.xunhupay.com/payment/do.html','design:paramtypes','join','@nestjs/common','title','wechatpay-node-v3','GlobalConfigService','BAD_REQUEST','hash','userService','order_no','wxpay','payEpayApiPayUrl','createHash','payEpaySecret','MD5','用户openId:\x20','payType:\x20','1851912EYzVHl','UserService','payWeChat','trade_order_id','md5','payHupiNotifyUrl','InjectRepository','notifyEpay','本次支付类型:\x20','map','pid','out_trade_order','submit.php','param','TRANSACTION.SUCCESS','trade_status','__esModule','hupi','OrderEntity','../user/user.service','sign_type','校验签名通过','transactions_h5','nonce_str','jsapi','HttpException','keys','../userBalance/userBalance.service','includes','payHupi','sign','log','sort','decorate','reference','wechat-pay:\x20','payer','object','response','goodsId','notifyPockyt','toString','toFixed','payWeChatPublicKey','transactions_native','queryWeChat','h5_info','HttpStatus','payEpayNotifyUrl','act','money','cramiPackageEntity','微信支付通知params:\x20','errRaw','transactions_jsapi','order:','verifySign','type'];_0x17a1=function(){return _0x24903f;};return _0x17a1();}var __decorate=this&&this['__decorate']||function(_0x3f14e5,_0x3f9099,_0x1efba7,_0x1bdce0){const _0x15e023=_0x17c3;var _0x3c8e07=arguments[_0x15e023(0x189)],_0x25bf11=_0x3c8e07<0x3?_0x3f9099:_0x1bdce0===null?_0x1bdce0=Object[_0x15e023(0x10d)](_0x3f9099,_0x1efba7):_0x1bdce0,_0x57cb54;if(typeof Reflect===_0x15e023(0x145)&&typeof Reflect[_0x15e023(0x141)]==='function')_0x25bf11=Reflect[_0x15e023(0x141)](_0x3f14e5,_0x3f9099,_0x1efba7,_0x1bdce0);else{for(var _0x36acab=_0x3f14e5[_0x15e023(0x189)]-0x1;_0x36acab>=0x0;_0x36acab--)if(_0x57cb54=_0x3f14e5[_0x36acab])_0x25bf11=(_0x3c8e07<0x3?_0x57cb54(_0x25bf11):_0x3c8e07>0x3?_0x57cb54(_0x3f9099,_0x1efba7,_0x25bf11):_0x57cb54(_0x3f9099,_0x1efba7))||_0x25bf11;}return _0x3c8e07>0x3&&_0x25bf11&&Object[_0x15e023(0x180)](_0x3f9099,_0x1efba7,_0x25bf11),_0x25bf11;},__metadata=this&&this[_0x5068fc(0x19b)]||function(_0xdfaac4,_0x5188cd){const _0x55cde4=_0x5068fc;if(typeof Reflect===_0x55cde4(0x145)&&typeof Reflect[_0x55cde4(0x182)]===_0x55cde4(0x197))return Reflect[_0x55cde4(0x182)](_0xdfaac4,_0x5188cd);},__param=this&&this['__param']||function(_0x40942f,_0xf4ec86){return function(_0xa546da,_0x2f8a7b){_0xf4ec86(_0xa546da,_0x2f8a7b,_0x40942f);};};function _0x17c3(_0x93d3b4,_0x181512){const _0x17a185=_0x17a1();return _0x17c3=function(_0x17c3c2,_0x430970){_0x17c3c2=_0x17c3c2-0xf6;let _0x80748e=_0x17a185[_0x17c3c2];return _0x80748e;},_0x17c3(_0x93d3b4,_0x181512);}Object[_0x5068fc(0x180)](exports,_0x5068fc(0x130),{'value':!![]}),exports[_0x5068fc(0x17b)]=void 0x0;const typeorm_1=require(_0x5068fc(0x15e)),typeorm_2=require(_0x5068fc(0x19a)),common_1=require(_0x5068fc(0x111)),crypto=require('crypto'),axios_1=require('axios'),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require(_0x5068fc(0x1a5)),userBalance_service_1=require(_0x5068fc(0x13b)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require('../../common/utils'),user_service_1=require(_0x5068fc(0x133)),verifySign_1=require(_0x5068fc(0x177));let PayService=class PayService{constructor(_0x452957,_0x5a1e21,_0x270283,_0x348d42,_0x25b032){const _0x5b7a08=_0x5068fc;this[_0x5b7a08(0x153)]=_0x452957,this['orderEntity']=_0x5a1e21,this[_0x5b7a08(0xfe)]=_0x270283,this[_0x5b7a08(0x104)]=_0x348d42,this[_0x5b7a08(0x117)]=_0x25b032;}async[_0x5068fc(0x195)](){const _0x36852d=_0x5068fc,_0x562ef1=await(0x0,utils_1[_0x36852d(0x193)])(_0x36852d(0x113));this['WxPay']=(_0x562ef1===null||_0x562ef1===void 0x0?void 0x0:_0x562ef1['default'])?_0x562ef1[_0x36852d(0xf6)]:_0x562ef1;}async['notify'](_0x85371f){const _0x26840c=_0x5068fc;if(_0x85371f[_0x26840c(0x12d)]=='epay')return this[_0x26840c(0x127)](_0x85371f);if(_0x85371f[_0x26840c(0x16f)]=='hupi')return this['notifyHupi'](_0x85371f);if(_0x85371f[_0x26840c(0x158)]!=='')return this[_0x26840c(0x148)](_0x85371f);if(typeof _0x85371f[_0x26840c(0x173)]==_0x26840c(0x145))return this['notifyWeChat'](_0x85371f);return this[_0x26840c(0x109)](_0x85371f);}async[_0x5068fc(0x166)](_0x44ad54,_0xb900e,_0x43e0ac=_0x5068fc(0x119)){const _0x44432d=_0x5068fc,_0x24b375=await this[_0x44432d(0x174)][_0x44432d(0x188)]({'where':{'userId':_0x44ad54,'orderId':_0xb900e}});if(!_0x24b375)throw new common_1[(_0x44432d(0x139))](_0x44432d(0x187),common_1[_0x44432d(0x14f)][_0x44432d(0x115)]);const _0x5a796b=await this[_0x44432d(0x153)]['findOne']({'where':{'id':_0x24b375['goodsId']}});if(!_0x5a796b)throw new common_1[(_0x44432d(0x139))]('套餐不存在!',common_1[_0x44432d(0x14f)][_0x44432d(0x115)]);console[_0x44432d(0x13f)](_0x44432d(0x128),_0x24b375['payPlatform']);try{if(_0x24b375[_0x44432d(0xff)]=='wechat')return this[_0x44432d(0x122)](_0x44ad54,_0xb900e,_0x43e0ac);if(_0x24b375['payPlatform']==_0x44432d(0x16c))return this[_0x44432d(0x16a)](_0x44ad54,_0xb900e,_0x43e0ac);if(_0x24b375[_0x44432d(0xff)]=='mpay')return this['payMpay'](_0x44ad54,_0xb900e,_0x43e0ac);if(_0x24b375[_0x44432d(0xff)]==_0x44432d(0x131))return this['payHupi'](_0x44ad54,_0xb900e,_0x43e0ac);}catch(_0x347644){console[_0x44432d(0x13f)](_0x44432d(0xf8),_0x347644);throw new common_1['HttpException']('支付请求失败!',common_1[_0x44432d(0x14f)][_0x44432d(0x115)]);}}async[_0x5068fc(0x19d)](_0x58342d){const _0x40d974=_0x5068fc,_0x3aee95=await this[_0x40d974(0x174)][_0x40d974(0x188)]({'where':{'orderId':_0x58342d}});if(!_0x3aee95)throw new common_1['HttpException'](_0x40d974(0x187),common_1[_0x40d974(0x14f)][_0x40d974(0x115)]);return _0x3aee95;}async[_0x5068fc(0x148)](_0x67ff21){const _0x188138=_0x5068fc,_0x5db5bf=_0x67ff21[_0x188138(0x142)],_0x193a81=await this[_0x188138(0x174)][_0x188138(0x188)]({'where':{'orderId':_0x5db5bf}});console[_0x188138(0x13f)](_0x188138(0x157)+_0x193a81);if(!_0x193a81)return'failed';const _0xc6fa0b=await this[_0x188138(0x174)][_0x188138(0x1a6)]({'orderId':_0x5db5bf},{'status':0x1,'paydAt':new Date()});if(_0xc6fa0b[_0x188138(0x1a4)]!=0x1)return _0x188138(0x19e);return await this[_0x188138(0xfe)][_0x188138(0x18c)](_0x193a81),_0x188138(0x179);}async[_0x5068fc(0x196)](_0x4ce532){const _0x1d4748=_0x5068fc,_0x46e1fc=await this['globalConfigService'][_0x1d4748(0x170)]([_0x1d4748(0x17c)]),_0xc6b6ae=_0x4ce532[_0x1d4748(0x116)];delete _0x4ce532['hash'];if(this[_0x1d4748(0x13e)](_0x4ce532,_0x46e1fc)!=_0xc6b6ae)return _0x1d4748(0x19e);const _0x1f5ac0=await this[_0x1d4748(0x174)][_0x1d4748(0x188)]({'where':{'orderId':_0x4ce532[_0x1d4748(0x123)],'status':0x0}});if(!_0x1f5ac0)return _0x1d4748(0x19e);await this[_0x1d4748(0xfe)][_0x1d4748(0x18c)](_0x1f5ac0);const _0x4ef823=await this[_0x1d4748(0x174)][_0x1d4748(0x1a6)]({'orderId':_0x4ce532[_0x1d4748(0x123)]},{'status':0x1,'paydAt':new Date()});if(_0x4ef823['affected']!=0x1)return _0x1d4748(0x19e);return _0x1d4748(0x179);}async[_0x5068fc(0x13d)](_0x24a2be,_0x132922,_0x2e9fdb='wxpay'){const _0x2b0359=_0x5068fc,_0x3b4d20=await this['orderEntity'][_0x2b0359(0x188)]({'where':{'userId':_0x24a2be,'orderId':_0x132922}});if(!_0x3b4d20)throw new common_1[(_0x2b0359(0x139))](_0x2b0359(0x187),common_1[_0x2b0359(0x14f)]['BAD_REQUEST']);const _0x54d958=await this['cramiPackageEntity'][_0x2b0359(0x188)]({'where':{'id':_0x3b4d20[_0x2b0359(0x147)]}});if(!_0x54d958)throw new common_1['HttpException'](_0x2b0359(0x18a),common_1['HttpStatus']['BAD_REQUEST']);const {payHupiAppId:_0x50fc49,payHupiSecret:_0x448481,payHupiNotifyUrl:_0x3a6339,payHupiReturnUrl:_0x4d0e44,payHupiGatewayUrl:_0x4403b5}=await this[_0x2b0359(0x104)][_0x2b0359(0x170)](['payHupiAppId',_0x2b0359(0x17c),_0x2b0359(0x125),_0x2b0359(0x17a),_0x2b0359(0x165)]),_0x11251e={};_0x11251e[_0x2b0359(0x16e)]=_0x2b0359(0x169),_0x11251e[_0x2b0359(0xf7)]=_0x50fc49,_0x11251e['time']=(Date['now']()/0x3e8)[_0x2b0359(0x14a)](0x0),_0x11251e[_0x2b0359(0x137)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x11251e[_0x2b0359(0x123)]=_0x132922,_0x11251e[_0x2b0359(0x112)]=_0x54d958['name'],_0x11251e['total_fee']=_0x3b4d20[_0x2b0359(0x164)],_0x11251e[_0x2b0359(0xfb)]=_0x3a6339,_0x11251e[_0x2b0359(0x194)]=_0x4d0e44,_0x11251e[_0x2b0359(0x16f)]=_0x2b0359(0x131),_0x11251e[_0x2b0359(0x116)]=this[_0x2b0359(0x13e)](_0x11251e,_0x448481);const {data:{errcode:_0x472a17,errmsg:_0x1ed7ac,url_qrcode:_0x49808d,url:_0x4af798}}=await axios_1['default'][_0x2b0359(0x176)](_0x4403b5||_0x2b0359(0x10e),_0x11251e);if(_0x472a17!=0x0)throw new common_1['HttpException'](_0x1ed7ac,common_1[_0x2b0359(0x14f)][_0x2b0359(0x115)]);return{'url_qrcode':_0x49808d,'url':_0x4af798};}async[_0x5068fc(0x15f)](_0x25201f){const _0x726c88=_0x5068fc,{payHupiAppId:_0x177d3a,payHupiSecret:_0x7c692e}=await this[_0x726c88(0x104)][_0x726c88(0x170)](['payHupiAppId',_0x726c88(0x17c)]),_0x2efbcc={};_0x2efbcc[_0x726c88(0x16e)]=_0x726c88(0x169),_0x2efbcc['appid']=_0x177d3a,_0x2efbcc[_0x726c88(0x17e)]=(Date[_0x726c88(0x10b)]()/0x3e8)[_0x726c88(0x14a)](0x0),_0x2efbcc[_0x726c88(0x137)]=(0x0,utils_1[_0x726c88(0x19f)])(0x20),_0x2efbcc[_0x726c88(0x12b)]=_0x25201f,_0x2efbcc[_0x726c88(0x116)]=this[_0x726c88(0x13e)](_0x2efbcc,_0x7c692e);const {data:{errcode:_0x5c1103,errmsg:_0x394a73,data:_0x595ff7}}=await axios_1[_0x726c88(0xf6)][_0x726c88(0x176)]('https://api.xunhupay.com/payment/query.html',_0x2efbcc);if(_0x5c1103!=0x0)throw new common_1[(_0x726c88(0x139))](_0x394a73,common_1[_0x726c88(0x14f)][_0x726c88(0x115)]);return _0x595ff7;}async[_0x5068fc(0x127)](_0x5be523){const _0x439723=_0x5068fc,_0x173474=_0x5be523[_0x439723(0x13e)];delete _0x5be523[_0x439723(0x13e)],delete _0x5be523['sign_type'];const _0x4616e3=await this['globalConfigService'][_0x439723(0x170)]([_0x439723(0x11c)]);if(this[_0x439723(0x13e)](_0x5be523,_0x4616e3)!=_0x173474)return _0x439723(0x19e);console[_0x439723(0x13f)](_0x439723(0x135));const _0x282bc0=await this[_0x439723(0x174)][_0x439723(0x188)]({'where':{'orderId':_0x5be523[_0x439723(0x15d)],'status':0x0}});if(!_0x282bc0)return _0x439723(0x19e);const _0x49eb86=_0x5be523['trade_status']==_0x439723(0x102)?0x1:0x2,_0xd5caa7=await this['orderEntity'][_0x439723(0x1a6)]({'orderId':_0x5be523[_0x439723(0x15d)]},{'status':_0x49eb86,'paydAt':new Date()});_0x49eb86===0x1&&await this[_0x439723(0xfe)][_0x439723(0x18c)](_0x282bc0);if(_0xd5caa7[_0x439723(0x1a4)]!=0x1)return _0x439723(0x19e);return _0x439723(0x179);}async[_0x5068fc(0x16a)](_0x2d8372,_0xc24af4,_0x2e1868=_0x5068fc(0x17d)){const _0x1dc8c9=_0x5068fc,_0x394358=await this['orderEntity'][_0x1dc8c9(0x188)]({'where':{'userId':_0x2d8372,'orderId':_0xc24af4}});if(!_0x394358)throw new common_1[(_0x1dc8c9(0x139))](_0x1dc8c9(0x187),common_1[_0x1dc8c9(0x14f)][_0x1dc8c9(0x115)]);const _0x230bce=await this[_0x1dc8c9(0x153)][_0x1dc8c9(0x188)]({'where':{'id':_0x394358['goodsId']}});if(!_0x230bce)throw new common_1[(_0x1dc8c9(0x139))](_0x1dc8c9(0x18a),common_1[_0x1dc8c9(0x14f)][_0x1dc8c9(0x115)]);const {payEpayPid:_0x5184ae,payEpaySecret:_0x1e4e44,payEpayNotifyUrl:_0x76d2b8,payEpayReturnUrl:_0x212bb9,payEpayApiPayUrl:_0xefd501}=await this[_0x1dc8c9(0x104)][_0x1dc8c9(0x170)]([_0x1dc8c9(0x10c),_0x1dc8c9(0x11c),_0x1dc8c9(0x150),_0x1dc8c9(0x186),_0x1dc8c9(0x11a)]);let _0x14fa62;_0x5184ae[_0x1dc8c9(0x189)]<=0x10?_0x14fa62=Number(_0x5184ae):_0x14fa62=BigInt(_0x5184ae);const _0x35fd43={};_0x35fd43[_0x1dc8c9(0x12a)]=_0x14fa62,_0x35fd43['type']=_0x2e1868,_0x35fd43[_0x1dc8c9(0x15d)]=_0xc24af4,_0x35fd43[_0x1dc8c9(0x17f)]=_0x230bce['name'],_0x35fd43[_0x1dc8c9(0x152)]=_0x394358[_0x1dc8c9(0x164)],_0x35fd43[_0x1dc8c9(0x1a2)]='192.168.1.100',_0x35fd43[_0x1dc8c9(0x175)]='pc',_0x35fd43[_0x1dc8c9(0xfb)]=_0x76d2b8,_0x35fd43[_0x1dc8c9(0x194)]=_0x212bb9,_0x35fd43['param']=_0x1dc8c9(0x16c),_0x35fd43['sign']=this[_0x1dc8c9(0x13e)](_0x35fd43,_0x1e4e44),_0x35fd43['sign_type']='MD5';const _0x38f58e=new URLSearchParams(_0x35fd43)[_0x1dc8c9(0x149)](),_0x44a7a1=_0xefd501+'?'+_0x38f58e;if(_0xefd501[_0x1dc8c9(0x13c)](_0x1dc8c9(0x12c)))return{'url_qrcode':null,'redirectUrl':_0x44a7a1,'channel':_0x2e1868,'isRedirect':!![]};else{const _0x80504=await axios_1[_0x1dc8c9(0xf6)][_0x1dc8c9(0x1a0)](_0xefd501,{'params':_0x35fd43});console[_0x1dc8c9(0x13f)]('epay\x20--->\x20res:\x20',_0x80504[_0x1dc8c9(0xfa)]);const {data:{code:_0x31d366,msg:_0x3efaa2,qrcode:_0x736c06}}=_0x80504;if(_0x31d366!=0x1)throw new common_1[(_0x1dc8c9(0x139))](_0x3efaa2,common_1[_0x1dc8c9(0x14f)][_0x1dc8c9(0x115)]);return{'url_qrcode':_0x736c06,'redirectUrl':null,'channel':_0x2e1868,'isRedirect':![]};}}async[_0x5068fc(0x18b)](_0x184c9e){const _0xf973ab=_0x5068fc,{payEpayPid:_0xefcb68,payEpaySecret:_0x5dab8f,payEpayApiQueryUrl:_0xac429b}=await this[_0xf973ab(0x104)][_0xf973ab(0x170)]([_0xf973ab(0x10c),_0xf973ab(0x11c),'payEpayApiQueryUrl']),_0xe6a7d4={};_0xe6a7d4[_0xf973ab(0x151)]=_0xf973ab(0x1a3),_0xe6a7d4[_0xf973ab(0x15d)]=_0x184c9e,_0xe6a7d4[_0xf973ab(0x12a)]=_0xefcb68,_0xe6a7d4[_0xf973ab(0x19c)]=_0x5dab8f;const {data:{code:_0x2674ec,msg:_0x26a24,data:_0x33081a}}=await axios_1[_0xf973ab(0xf6)][_0xf973ab(0x1a0)](_0xac429b,{'params':_0xe6a7d4});if(_0x2674ec!=0x1)throw new common_1[(_0xf973ab(0x139))](_0x26a24,common_1[_0xf973ab(0x14f)][_0xf973ab(0x115)]);return _0x33081a;}async[_0x5068fc(0x109)](_0x10428e){const _0x2c66be=_0x5068fc,_0x2d2a5f=_0x10428e[_0x2c66be(0x13e)];delete _0x10428e[_0x2c66be(0x13e)],delete _0x10428e['sign_type'];const _0x38167c=await this[_0x2c66be(0x104)]['getConfigs']([_0x2c66be(0x184)]);console['log'](_0x2c66be(0x178));if(this['sign'](_0x10428e,_0x38167c)!=_0x2d2a5f)return'failed';console[_0x2c66be(0x13f)]('校验签名通过');const _0x35ac3a=await this['orderEntity']['findOne']({'where':{'orderId':_0x10428e[_0x2c66be(0x15d)],'status':0x0}});if(!_0x35ac3a)return _0x2c66be(0x19e);const _0x5ceadf=_0x10428e[_0x2c66be(0x12f)]==_0x2c66be(0x102)?0x1:0x2;console[_0x2c66be(0x13f)](_0x2c66be(0x1a1),_0x5ceadf);const _0x2adfc6=await this[_0x2c66be(0x174)][_0x2c66be(0x1a6)]({'orderId':_0x10428e[_0x2c66be(0x15d)]},{'status':_0x5ceadf,'paydAt':new Date()});_0x5ceadf===0x1&&await this['userBalanceService'][_0x2c66be(0x18c)](_0x35ac3a);if(_0x2adfc6[_0x2c66be(0x1a4)]!=0x1)return _0x2c66be(0x19e);return _0x2c66be(0x179);}async[_0x5068fc(0x171)](_0x4bce47){const _0x5340f1=_0x5068fc;if(!_0x4bce47[_0x5340f1(0x142)])return'failed';return _0x5340f1(0x179);}async[_0x5068fc(0x163)](_0x2a510d,_0x50f6f0,_0x1ee3ab=_0x5068fc(0x119)){const _0x343842=_0x5068fc,_0x563c84=await this['orderEntity'][_0x343842(0x188)]({'where':{'userId':_0x2a510d,'orderId':_0x50f6f0}});if(!_0x563c84)throw new common_1[(_0x343842(0x139))](_0x343842(0x187),common_1[_0x343842(0x14f)][_0x343842(0x115)]);const _0x89b13d=await this[_0x343842(0x153)][_0x343842(0x188)]({'where':{'id':_0x563c84[_0x343842(0x147)]}});if(!_0x89b13d)throw new common_1[(_0x343842(0x139))](_0x343842(0x18a),common_1[_0x343842(0x14f)][_0x343842(0x115)]);const {payMpayPid:_0x2aaa4a,payMpaySecret:_0x11104b,payMpayNotifyUrl:_0x28004e,payMpayReturnUrl:_0x5c3102,payMpayApiPayUrl:_0x4a4755}=await this[_0x343842(0x104)][_0x343842(0x170)]([_0x343842(0x18d),_0x343842(0x184),_0x343842(0x199),_0x343842(0x167),'payMpayApiPayUrl']),_0x3e3385={};_0x3e3385[_0x343842(0x12a)]=Number(_0x2aaa4a),_0x3e3385[_0x343842(0x159)]=_0x1ee3ab,_0x3e3385[_0x343842(0x15d)]=_0x50f6f0,_0x3e3385[_0x343842(0x17f)]=_0x89b13d['name'],_0x3e3385[_0x343842(0x152)]=_0x563c84[_0x343842(0x164)],_0x3e3385['notify_url']=_0x28004e,_0x3e3385['return_url']=_0x5c3102,_0x3e3385[_0x343842(0x13e)]=this[_0x343842(0x13e)](_0x3e3385,_0x11104b),_0x3e3385[_0x343842(0x134)]=_0x343842(0x11d);const _0x1dde17=new URLSearchParams(_0x3e3385)[_0x343842(0x149)](),_0x21c8b9=_0x4a4755+'?'+_0x1dde17;return{'url_qrcode':null,'redirectUrl':_0x21c8b9,'channel':_0x1ee3ab,'isRedirect':!![]};}async[_0x5068fc(0x101)](_0x5f5995){const _0x2be52f=_0x5068fc,{payMpayApiQueryUrl:_0x5c3604}=await this['globalConfigService'][_0x2be52f(0x170)]([_0x2be52f(0x18d),_0x2be52f(0x184),_0x2be52f(0xfd)]),_0x3bb574={};_0x3bb574[_0x2be52f(0x159)]=0x2,_0x3bb574[_0x2be52f(0x118)]=_0x5f5995;const {data:{code:_0x2bd649,msg:_0x51cf7a,data:_0x52c27c}}=await axios_1[_0x2be52f(0xf6)]['get'](_0x5c3604,{'params':_0x3bb574});if(_0x2bd649!=0x1)throw new common_1['HttpException'](_0x51cf7a,common_1[_0x2be52f(0x14f)][_0x2be52f(0x115)]);return _0x52c27c;}async['notifyWeChat'](_0x3d3de2){const _0x481770=_0x5068fc;console['log'](_0x481770(0x154),_0x3d3de2);const {payWeChatAppId:_0x20eeb2,payWeChatMchId:_0x2acad3,payWeChatSecret:_0x4c29dc,payWeChatPublicKey:_0x5dbc6c,payWeChatPrivateKey:_0x1ec9f0}=await this[_0x481770(0x104)]['getConfigs']([_0x481770(0xf9),_0x481770(0x161),_0x481770(0x103),_0x481770(0x14b),_0x481770(0x162)]),_0x41695f=new this[(_0x481770(0x185))]({'appid':_0x20eeb2,'mchid':_0x2acad3,'publicKey':_0x5dbc6c,'privateKey':_0x1ec9f0});try{if(_0x3d3de2[_0x481770(0x15b)]==_0x481770(0x12e)){const {ciphertext:_0x289f2e,associated_data:_0x2e5760,nonce:_0x1b97c7}=_0x3d3de2[_0x481770(0x173)],_0x446e59=_0x41695f['decipher_gcm'](_0x289f2e,_0x2e5760,_0x1b97c7,_0x4c29dc),_0x56132a=await this[_0x481770(0x174)][_0x481770(0x188)]({'where':{'orderId':_0x446e59[_0x481770(0x15d)],'status':0x0}});if(!_0x56132a)return _0x481770(0x19e);const _0x1575d6=_0x446e59[_0x481770(0x183)]=='SUCCESS'?0x1:0x2,_0xeecde1=await this['orderEntity'][_0x481770(0x1a6)]({'orderId':_0x446e59['out_trade_no']},{'status':_0x1575d6,'paydAt':new Date()});_0x1575d6===0x1&&await this[_0x481770(0xfe)][_0x481770(0x18c)](_0x56132a);if(_0xeecde1[_0x481770(0x1a4)]!=0x1)return _0x481770(0x19e);}return'success';}catch(_0x11e8fd){return console[_0x481770(0x13f)](_0x481770(0x192),_0x11e8fd),console['log'](_0x481770(0xfc),_0x11e8fd),_0x481770(0x19e);}}async[_0x5068fc(0x122)](_0x4b4a52,_0x53e8c8,_0x1f0121=_0x5068fc(0x181)){const _0x3ca971=_0x5068fc;var _0x5be5dc,_0x5be365,_0x228744;console[_0x3ca971(0x13f)](_0x3ca971(0x11f),_0x1f0121);const _0x1cdf7f=await this[_0x3ca971(0x174)]['findOne']({'where':{'userId':_0x4b4a52,'orderId':_0x53e8c8}});if(!_0x1cdf7f)throw new common_1['HttpException'](_0x3ca971(0x187),common_1[_0x3ca971(0x14f)][_0x3ca971(0x115)]);const _0x29f243=await this[_0x3ca971(0x153)][_0x3ca971(0x188)]({'where':{'id':_0x1cdf7f[_0x3ca971(0x147)]}});if(!_0x29f243)throw new common_1['HttpException']('套餐不存在!',common_1[_0x3ca971(0x14f)][_0x3ca971(0x115)]);const {payWeChatAppId:_0x477d54,payWeChatMchId:_0x21ff04,payWeChatPublicKey:_0x3105ca,payWeChatPrivateKey:_0x56eeca,payWeChatNotifyUrl:_0x2c7b5b,payWeChatH5Name:_0x3b2ca1,payWeChatH5Url:_0x2fa13d}=await this['globalConfigService'][_0x3ca971(0x170)]([_0x3ca971(0xf9),_0x3ca971(0x161),_0x3ca971(0x14b),_0x3ca971(0x162),'payWeChatNotifyUrl',_0x3ca971(0x106),'payWeChatH5Url']),_0x46cf4c=new this[(_0x3ca971(0x185))]({'appid':_0x477d54,'mchid':_0x21ff04,'publicKey':_0x3105ca,'privateKey':_0x56eeca}),_0x4d1dd0={'appid':_0x477d54,'mchid':_0x21ff04,'description':_0x29f243[_0x3ca971(0x17f)],'out_trade_no':_0x53e8c8,'notify_url':_0x2c7b5b,'amount':{'total':Number(_0x1cdf7f[_0x3ca971(0x164)]*0x64)},'scene_info':{'payer_client_ip':_0x3ca971(0x16b)}};console[_0x3ca971(0x13f)](_0x3ca971(0x143),_0x4d1dd0);if(_0x1f0121=='h5'){_0x4d1dd0['scene_info'][_0x3ca971(0x14e)]={'type':'Wap','app_name':_0x3b2ca1,'app_url':_0x2fa13d};const _0x53792a=await _0x46cf4c[_0x3ca971(0x136)](_0x4d1dd0);if(_0x53792a[_0x3ca971(0x108)]===0x193){const _0x31f264=(_0x228744=(_0x5be365=(_0x5be5dc=_0x53792a===null||_0x53792a===void 0x0?void 0x0:_0x53792a[_0x3ca971(0x155)])===null||_0x5be5dc===void 0x0?void 0x0:_0x5be5dc[_0x3ca971(0x146)])===null||_0x5be365===void 0x0?void 0x0:_0x5be365[_0x3ca971(0x18f)])===null||_0x228744===void 0x0?void 0x0:_0x228744[_0x3ca971(0x172)];throw new common_1[(_0x3ca971(0x139))]((_0x53792a===null||_0x53792a===void 0x0?void 0x0:_0x53792a[_0x3ca971(0x172)])||_0x3ca971(0x18e),common_1[_0x3ca971(0x14f)]['BAD_REQUEST']);}const {h5_url:_0xcadf40}=_0x53792a;return{'url':_0xcadf40};}if(_0x1f0121==_0x3ca971(0x138)){const _0x3794c5=await this[_0x3ca971(0x117)][_0x3ca971(0x190)](_0x4b4a52);console[_0x3ca971(0x13f)](_0x3ca971(0x11e),_0x3794c5),_0x4d1dd0[_0x3ca971(0x144)]={'openid':_0x3794c5};const _0x65417a=await _0x46cf4c[_0x3ca971(0x156)](_0x4d1dd0);return console[_0x3ca971(0x13f)]('jsapi支付结果返回值:\x20',_0x65417a),_0x65417a;}if(_0x1f0121==_0x3ca971(0x181)){const _0x2e299d=await _0x46cf4c[_0x3ca971(0x14c)](_0x4d1dd0),{code_url:_0xbab86f}=_0x2e299d;return!_0xbab86f&&console[_0x3ca971(0x13f)]('wx-native',_0x2e299d),{'url_qrcode':_0xbab86f,'isRedirect':![]};}throw new common_1['HttpException']('unsupported\x20pay\x20type',common_1[_0x3ca971(0x14f)][_0x3ca971(0x115)]);}async[_0x5068fc(0x14d)](_0x48e95e){const _0x1ccff8=_0x5068fc,{payWeChatAppId:_0x5f2cd7,payWeChatMchId:_0x5949d5,payWeChatPublicKey:_0x39d69a,payWeChatPrivateKey:_0x8f775f,payWeChatNotifyUrl:_0x59a6a3,payWeChatH5Name:_0x5cab73,payWeChatH5Url:_0xf60add}=await this['globalConfigService'][_0x1ccff8(0x170)]([_0x1ccff8(0xf9),'payWeChatMchId','payWeChatPublicKey',_0x1ccff8(0x162)]),_0x240ac9=new this[(_0x1ccff8(0x185))]({'appid':_0x5f2cd7,'mchid':_0x5949d5,'publicKey':_0x39d69a,'privateKey':_0x8f775f}),_0x3d3aef=await _0x240ac9[_0x1ccff8(0x19d)]({'out_trade_no':_0x48e95e});return _0x3d3aef;}['sign'](_0x101142,_0x3c876c){const _0xf51123=_0x5068fc,_0x5e01c9=Object[_0xf51123(0x13a)](_0x101142)[_0xf51123(0x140)]()[_0xf51123(0x129)](_0x4fd483=>_0x4fd483+'='+_0x101142[_0x4fd483])[_0xf51123(0x110)]('&')+_0x3c876c;return crypto[_0xf51123(0x11b)](_0xf51123(0x124))['update'](_0x5e01c9)['digest'](_0xf51123(0x15c));}['getVerifySign'](_0x449e20){const _0x45bcfa=_0x5068fc,_0xde289b=(0x0,verifySign_1[_0x45bcfa(0x105)])(_0x449e20);return _0xde289b;}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5068fc(0x126)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x5068fc(0x126)])(order_entity_1[_0x5068fc(0x132)])),__metadata(_0x5068fc(0x10f),[typeorm_2[_0x5068fc(0x198)],typeorm_2[_0x5068fc(0x198)],userBalance_service_1[_0x5068fc(0x191)],globalConfig_service_1[_0x5068fc(0x114)],user_service_1[_0x5068fc(0x121)]])],PayService),exports['PayService']=PayService;