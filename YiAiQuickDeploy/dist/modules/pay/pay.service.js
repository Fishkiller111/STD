'use strict';const _0x21b780=_0x2098;(function(_0x3c6202,_0x30059d){const _0x3dc045=_0x2098,_0x1cb840=_0x3c6202();while(!![]){try{const _0x2d0c7c=parseInt(_0x3dc045(0xda))/0x1*(parseInt(_0x3dc045(0xce))/0x2)+parseInt(_0x3dc045(0xaa))/0x3*(-parseInt(_0x3dc045(0xa7))/0x4)+parseInt(_0x3dc045(0x135))/0x5+parseInt(_0x3dc045(0xe3))/0x6+-parseInt(_0x3dc045(0x115))/0x7+-parseInt(_0x3dc045(0xef))/0x8*(-parseInt(_0x3dc045(0x10f))/0x9)+-parseInt(_0x3dc045(0xa2))/0xa;if(_0x2d0c7c===_0x30059d)break;else _0x1cb840['push'](_0x1cb840['shift']());}catch(_0x4c2929){_0x1cb840['push'](_0x1cb840['shift']());}}}(_0xcec7,0x4f65e));function _0x2098(_0x5ad2d9,_0x3fa8d6){const _0xcec7e7=_0xcec7();return _0x2098=function(_0x209804,_0x342d3d){_0x209804=_0x209804-0x9d;let _0x2ff3a2=_0xcec7e7[_0x209804];return _0x2ff3a2;},_0x2098(_0x5ad2d9,_0x3fa8d6);}function _0xcec7(){const _0x55afa1=['version','design:paramtypes','../../common/utils','order_no','payHupiReturnUrl','out_trade_no','onModuleInit','text','queryHupi','CramiPackageEntity','wx-native','attach','status','notifyHupi','transactions_h5','data','notifyEpay','4wXAPnJ','Wap','hupi','log','payWeChatPrivateKey','type','queryMpay','findOne','payEpayApiQueryUrl','payEpaySecret','now','affected','225662eudgDo','payHupi','HttpException','UserBalanceService','@nestjs/common','order:','../userBalance/userBalance.service','update','MD5','2648766npeiqp','getOwnPropertyDescriptor','trade_status','submit.php','epay','map','校验签名','../order/order.entity','post','query','HttpStatus','queryEpay','32Vwozll','SUCCESS','default','function','decipher_gcm','__decorate','../crami/cramiPackage.entity','微信支付通知params:\x20','includes','param','order','wechat','trade_state','TRANSACTION.SUCCESS','payMpayNotifyUrl','time','notifyPockyt','192.168.1.100','mpay','money','payWeChat','payEpayNotifyUrl','__esModule','clientip','decorate','md5','payMpayPid','payMpaySecret','payMpayApiQueryUrl','globalConfigService','object','success','1458279lFEeay','digest','notifyMpay','GlobalConfigService','queryWeChat','appid','3849307eJLaRI','toFixed','userBalanceService','join','createHash','failed','Repository','payWeChatAppId','BAD_REQUEST','payWeChatPublicKey','title','epay\x20--->\x20res:\x20','total_fee','status:\x20','goodsId','pid','payHupiSecret','getConfigs','https://api.xunhupay.com/payment/query.html','支付请求失败!','payEpayApiPayUrl','length','InjectRepository','WxPay','cramiPackageEntity','metadata','alipay','@nestjs/typeorm','reference','nonce_str','payHupiNotifyUrl','trade_order_id','3010165grKiNU','支付通知验证失败:\x20','transactions_jsapi','hash','scene_info','hex','jsapi','payMpay','name','payWeChatSecret','payWeChatMchId','校验签名通过','device','sign_type','订单不存在!','支付请求失败:\x20','notifyWeChat','toString','payWeChatH5Url','payWeChatNotifyUrl','notify','createRandomNonceStr','sign','payPlatform','addBalanceToOrder','payEpay','sort','total','userService','getOpenIdByUserId','10624680uwSFng','verifySign','orderEntity','transactions_native','notify_url','4gKQWCV','pay','https://api.xunhupay.com/payment/do.html','616077RLvHFC','native','resource','1.1','defineProperty','return_url','importDynamic','__metadata','wechatpay-node-v3','UserService','error:\x20','payEpayPid','PayService','套餐不存在!','get','unsupported\x20pay\x20type','payHupiGatewayUrl','message','crypto'];_0xcec7=function(){return _0x55afa1;};return _0xcec7();}var __decorate=this&&this[_0x21b780(0xf4)]||function(_0x25dc80,_0xecd017,_0x3b33ad,_0x14ae85){const _0x31b91d=_0x21b780;var _0x538d73=arguments[_0x31b91d(0x12a)],_0x4aba07=_0x538d73<0x3?_0xecd017:_0x14ae85===null?_0x14ae85=Object[_0x31b91d(0xe4)](_0xecd017,_0x3b33ad):_0x14ae85,_0x35fb5d;if(typeof Reflect===_0x31b91d(0x10d)&&typeof Reflect[_0x31b91d(0x107)]==='function')_0x4aba07=Reflect[_0x31b91d(0x107)](_0x25dc80,_0xecd017,_0x3b33ad,_0x14ae85);else{for(var _0x181296=_0x25dc80[_0x31b91d(0x12a)]-0x1;_0x181296>=0x0;_0x181296--)if(_0x35fb5d=_0x25dc80[_0x181296])_0x4aba07=(_0x538d73<0x3?_0x35fb5d(_0x4aba07):_0x538d73>0x3?_0x35fb5d(_0xecd017,_0x3b33ad,_0x4aba07):_0x35fb5d(_0xecd017,_0x3b33ad))||_0x4aba07;}return _0x538d73>0x3&&_0x4aba07&&Object['defineProperty'](_0xecd017,_0x3b33ad,_0x4aba07),_0x4aba07;},__metadata=this&&this[_0x21b780(0xb1)]||function(_0x18e6e3,_0x131529){const _0x37b366=_0x21b780;if(typeof Reflect===_0x37b366(0x10d)&&typeof Reflect['metadata']===_0x37b366(0xf2))return Reflect[_0x37b366(0x12e)](_0x18e6e3,_0x131529);},__param=this&&this['__param']||function(_0x405c44,_0x35ce70){return function(_0x210653,_0x6666b2){_0x35ce70(_0x210653,_0x6666b2,_0x405c44);};};Object[_0x21b780(0xae)](exports,_0x21b780(0x105),{'value':!![]}),exports[_0x21b780(0xb6)]=void 0x0;const typeorm_1=require(_0x21b780(0x130)),typeorm_2=require('typeorm'),common_1=require(_0x21b780(0xde)),crypto=require(_0x21b780(0xbc)),axios_1=require('axios'),order_entity_1=require(_0x21b780(0xea)),cramiPackage_entity_1=require(_0x21b780(0xf5)),userBalance_service_1=require(_0x21b780(0xe0)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require(_0x21b780(0xbf)),user_service_1=require('../user/user.service');let PayService=class PayService{constructor(_0x5bdc0e,_0x23b859,_0x9834c3,_0x2f479f,_0x324919){const _0x459790=_0x21b780;this[_0x459790(0x12d)]=_0x5bdc0e,this[_0x459790(0xa4)]=_0x23b859,this[_0x459790(0x117)]=_0x9834c3,this['globalConfigService']=_0x2f479f,this[_0x459790(0xa0)]=_0x324919;}async[_0x21b780(0xc3)](){const _0x55fba2=_0x21b780,_0x17bbec=await(0x0,utils_1[_0x55fba2(0xb0)])(_0x55fba2(0xb2));this[_0x55fba2(0x12c)]=(_0x17bbec===null||_0x17bbec===void 0x0?void 0x0:_0x17bbec[_0x55fba2(0xf1)])?_0x17bbec[_0x55fba2(0xf1)]:_0x17bbec;}async[_0x21b780(0x149)](_0x5d43ab){const _0x4d81e2=_0x21b780;if(_0x5d43ab[_0x4d81e2(0xf8)]=='epay')return this[_0x4d81e2(0xcd)](_0x5d43ab);if(_0x5d43ab[_0x4d81e2(0xc8)]==_0x4d81e2(0xd0))return this[_0x4d81e2(0xca)](_0x5d43ab);if(_0x5d43ab[_0x4d81e2(0xa3)]!=='')return this[_0x4d81e2(0xff)](_0x5d43ab);if(typeof _0x5d43ab[_0x4d81e2(0xac)]==_0x4d81e2(0x10d))return this[_0x4d81e2(0x145)](_0x5d43ab);return this['notifyMpay'](_0x5d43ab);}async[_0x21b780(0xa8)](_0x5b1b1f,_0x39c445,_0x4d934c='wxpay'){const _0x41a52d=_0x21b780,_0xe1e5b8=await this['orderEntity']['findOne']({'where':{'userId':_0x5b1b1f,'orderId':_0x39c445}});if(!_0xe1e5b8)throw new common_1[(_0x41a52d(0xdc))]('订单不存在!',common_1[_0x41a52d(0xed)]['BAD_REQUEST']);const _0x46000b=await this[_0x41a52d(0x12d)][_0x41a52d(0xd5)]({'where':{'id':_0xe1e5b8[_0x41a52d(0x123)]}});if(!_0x46000b)throw new common_1[(_0x41a52d(0xdc))](_0x41a52d(0xb7),common_1[_0x41a52d(0xed)][_0x41a52d(0x11d)]);console[_0x41a52d(0xd1)]('本次支付类型:\x20',_0xe1e5b8[_0x41a52d(0x14c)]);try{if(_0xe1e5b8[_0x41a52d(0x14c)]==_0x41a52d(0xfa))return this[_0x41a52d(0x103)](_0x5b1b1f,_0x39c445,_0x4d934c);if(_0xe1e5b8['payPlatform']==_0x41a52d(0xe7))return this[_0x41a52d(0x9d)](_0x5b1b1f,_0x39c445,_0x4d934c);if(_0xe1e5b8['payPlatform']==_0x41a52d(0x101))return this['payMpay'](_0x5b1b1f,_0x39c445,_0x4d934c);if(_0xe1e5b8[_0x41a52d(0x14c)]==_0x41a52d(0xd0))return this['payHupi'](_0x5b1b1f,_0x39c445,_0x4d934c);}catch(_0x5daea0){console[_0x41a52d(0xd1)](_0x41a52d(0x144),_0x5daea0);throw new common_1[(_0x41a52d(0xdc))](_0x41a52d(0x128),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x21b780(0xec)](_0x2080c9){const _0x341b00=_0x21b780,_0x2800c0=await this[_0x341b00(0xa4)][_0x341b00(0xd5)]({'where':{'orderId':_0x2080c9}});if(!_0x2800c0)throw new common_1[(_0x341b00(0xdc))](_0x341b00(0x143),common_1[_0x341b00(0xed)][_0x341b00(0x11d)]);return _0x2800c0;}async[_0x21b780(0xff)](_0x6adb32){const _0x4705f2=_0x21b780,_0x3d1fb3=_0x6adb32[_0x4705f2(0x131)],_0x23e550=await this[_0x4705f2(0xa4)][_0x4705f2(0xd5)]({'where':{'orderId':_0x3d1fb3}});console[_0x4705f2(0xd1)](_0x4705f2(0xdf)+_0x23e550);if(!_0x23e550)return _0x4705f2(0x11a);const _0x473c0a=await this['orderEntity'][_0x4705f2(0xe1)]({'orderId':_0x3d1fb3},{'status':0x1,'paydAt':new Date()});if(_0x473c0a[_0x4705f2(0xd9)]!=0x1)return _0x4705f2(0x11a);return await this[_0x4705f2(0x117)][_0x4705f2(0x14d)](_0x23e550),_0x4705f2(0x10e);}async['notifyHupi'](_0x33f989){const _0x5c6546=_0x21b780,_0x28337b=await this[_0x5c6546(0x10c)][_0x5c6546(0x126)](['payHupiSecret']),_0x5d5a0c=_0x33f989[_0x5c6546(0x138)];delete _0x33f989[_0x5c6546(0x138)];if(this[_0x5c6546(0x14b)](_0x33f989,_0x28337b)!=_0x5d5a0c)return'failed';const _0x1153ee=await this[_0x5c6546(0xa4)][_0x5c6546(0xd5)]({'where':{'orderId':_0x33f989[_0x5c6546(0x134)],'status':0x0}});if(!_0x1153ee)return _0x5c6546(0x11a);await this[_0x5c6546(0x117)][_0x5c6546(0x14d)](_0x1153ee);const _0x59e7f2=await this[_0x5c6546(0xa4)]['update']({'orderId':_0x33f989[_0x5c6546(0x134)]},{'status':0x1,'paydAt':new Date()});if(_0x59e7f2[_0x5c6546(0xd9)]!=0x1)return _0x5c6546(0x11a);return'success';}async[_0x21b780(0xdb)](_0x2d597d,_0xb0b7ee,_0x22ceff='wxpay'){const _0x5ee08f=_0x21b780,_0x7d7cae=await this[_0x5ee08f(0xa4)][_0x5ee08f(0xd5)]({'where':{'userId':_0x2d597d,'orderId':_0xb0b7ee}});if(!_0x7d7cae)throw new common_1['HttpException']('订单不存在!',common_1[_0x5ee08f(0xed)][_0x5ee08f(0x11d)]);const _0x3723a2=await this['cramiPackageEntity'][_0x5ee08f(0xd5)]({'where':{'id':_0x7d7cae[_0x5ee08f(0x123)]}});if(!_0x3723a2)throw new common_1[(_0x5ee08f(0xdc))]('套餐不存在!',common_1['HttpStatus']['BAD_REQUEST']);const {payHupiAppId:_0x94d14f,payHupiSecret:_0x2d9164,payHupiNotifyUrl:_0x400154,payHupiReturnUrl:_0x3257fa,payHupiGatewayUrl:_0x45065b}=await this[_0x5ee08f(0x10c)][_0x5ee08f(0x126)](['payHupiAppId','payHupiSecret',_0x5ee08f(0x133),_0x5ee08f(0xc1),_0x5ee08f(0xba)]),_0xced46={};_0xced46[_0x5ee08f(0xbd)]=_0x5ee08f(0xad),_0xced46[_0x5ee08f(0x114)]=_0x94d14f,_0xced46[_0x5ee08f(0xfe)]=(Date[_0x5ee08f(0xd8)]()/0x3e8)[_0x5ee08f(0x116)](0x0),_0xced46[_0x5ee08f(0x132)]=(0x0,utils_1[_0x5ee08f(0x14a)])(0x20),_0xced46[_0x5ee08f(0x134)]=_0xb0b7ee,_0xced46[_0x5ee08f(0x11f)]=_0x3723a2[_0x5ee08f(0x13d)],_0xced46[_0x5ee08f(0x121)]=_0x7d7cae[_0x5ee08f(0x9f)],_0xced46[_0x5ee08f(0xa6)]=_0x400154,_0xced46[_0x5ee08f(0xaf)]=_0x3257fa,_0xced46[_0x5ee08f(0xc8)]=_0x5ee08f(0xd0),_0xced46[_0x5ee08f(0x138)]=this[_0x5ee08f(0x14b)](_0xced46,_0x2d9164);const {data:{errcode:_0x53c7a1,errmsg:_0x5055ba,url_qrcode:_0x1ca4bb,url:_0x3b3f06}}=await axios_1[_0x5ee08f(0xf1)][_0x5ee08f(0xeb)](_0x45065b||_0x5ee08f(0xa9),_0xced46);if(_0x53c7a1!=0x0)throw new common_1['HttpException'](_0x5055ba,common_1[_0x5ee08f(0xed)][_0x5ee08f(0x11d)]);return{'url_qrcode':_0x1ca4bb,'url':_0x3b3f06};}async[_0x21b780(0xc5)](_0x446348){const _0x410e8a=_0x21b780,{payHupiAppId:_0x47bb13,payHupiSecret:_0x794ae1}=await this[_0x410e8a(0x10c)][_0x410e8a(0x126)](['payHupiAppId',_0x410e8a(0x125)]),_0x66ab79={};_0x66ab79[_0x410e8a(0xbd)]=_0x410e8a(0xad),_0x66ab79[_0x410e8a(0x114)]=_0x47bb13,_0x66ab79[_0x410e8a(0xfe)]=(Date['now']()/0x3e8)[_0x410e8a(0x116)](0x0),_0x66ab79[_0x410e8a(0x132)]=(0x0,utils_1[_0x410e8a(0x14a)])(0x20),_0x66ab79['out_trade_order']=_0x446348,_0x66ab79[_0x410e8a(0x138)]=this[_0x410e8a(0x14b)](_0x66ab79,_0x794ae1);const {data:{errcode:_0xead421,errmsg:_0x1c5b64,data:_0x5e82e9}}=await axios_1['default'][_0x410e8a(0xeb)](_0x410e8a(0x127),_0x66ab79);if(_0xead421!=0x0)throw new common_1[(_0x410e8a(0xdc))](_0x1c5b64,common_1[_0x410e8a(0xed)]['BAD_REQUEST']);return _0x5e82e9;}async['notifyEpay'](_0x423d18){const _0x5266e2=_0x21b780,_0x28bf23=_0x423d18[_0x5266e2(0x14b)];delete _0x423d18['sign'],delete _0x423d18[_0x5266e2(0x142)];const _0x4a44af=await this[_0x5266e2(0x10c)][_0x5266e2(0x126)]([_0x5266e2(0xd7)]);if(this[_0x5266e2(0x14b)](_0x423d18,_0x4a44af)!=_0x28bf23)return _0x5266e2(0x11a);console[_0x5266e2(0xd1)]('校验签名通过');const _0x5ca0d3=await this['orderEntity'][_0x5266e2(0xd5)]({'where':{'orderId':_0x423d18[_0x5266e2(0xc2)],'status':0x0}});if(!_0x5ca0d3)return _0x5266e2(0x11a);const _0x1dac3d=_0x423d18[_0x5266e2(0xe5)]=='TRADE_SUCCESS'?0x1:0x2,_0x4a1f2c=await this[_0x5266e2(0xa4)][_0x5266e2(0xe1)]({'orderId':_0x423d18[_0x5266e2(0xc2)]},{'status':_0x1dac3d,'paydAt':new Date()});_0x1dac3d===0x1&&await this['userBalanceService'][_0x5266e2(0x14d)](_0x5ca0d3);if(_0x4a1f2c[_0x5266e2(0xd9)]!=0x1)return'failed';return _0x5266e2(0x10e);}async['payEpay'](_0x5a99cf,_0x31a75b,_0x425beb=_0x21b780(0x12f)){const _0xf1fce6=_0x21b780,_0x16a053=await this[_0xf1fce6(0xa4)][_0xf1fce6(0xd5)]({'where':{'userId':_0x5a99cf,'orderId':_0x31a75b}});if(!_0x16a053)throw new common_1[(_0xf1fce6(0xdc))](_0xf1fce6(0x143),common_1['HttpStatus']['BAD_REQUEST']);const _0x1c4db1=await this['cramiPackageEntity'][_0xf1fce6(0xd5)]({'where':{'id':_0x16a053[_0xf1fce6(0x123)]}});if(!_0x1c4db1)throw new common_1[(_0xf1fce6(0xdc))](_0xf1fce6(0xb7),common_1[_0xf1fce6(0xed)][_0xf1fce6(0x11d)]);const {payEpayPid:_0x268af1,payEpaySecret:_0x132416,payEpayNotifyUrl:_0x3e995a,payEpayReturnUrl:_0xc1266c,payEpayApiPayUrl:_0xde8918}=await this[_0xf1fce6(0x10c)][_0xf1fce6(0x126)]([_0xf1fce6(0xb5),_0xf1fce6(0xd7),_0xf1fce6(0x104),'payEpayReturnUrl',_0xf1fce6(0x129)]);let _0x5aea21;_0x268af1['length']<=0x10?_0x5aea21=Number(_0x268af1):_0x5aea21=BigInt(_0x268af1);const _0x2cc5ce={};_0x2cc5ce[_0xf1fce6(0x124)]=_0x5aea21,_0x2cc5ce[_0xf1fce6(0xd3)]=_0x425beb,_0x2cc5ce[_0xf1fce6(0xc2)]=_0x31a75b,_0x2cc5ce[_0xf1fce6(0x13d)]=_0x1c4db1[_0xf1fce6(0x13d)],_0x2cc5ce[_0xf1fce6(0x102)]=_0x16a053['total'],_0x2cc5ce[_0xf1fce6(0x106)]=_0xf1fce6(0x100),_0x2cc5ce[_0xf1fce6(0x141)]='pc',_0x2cc5ce[_0xf1fce6(0xa6)]=_0x3e995a,_0x2cc5ce[_0xf1fce6(0xaf)]=_0xc1266c,_0x2cc5ce[_0xf1fce6(0xf8)]=_0xf1fce6(0xe7),_0x2cc5ce[_0xf1fce6(0x14b)]=this['sign'](_0x2cc5ce,_0x132416),_0x2cc5ce[_0xf1fce6(0x142)]='MD5';const _0x3b5b02=new URLSearchParams(_0x2cc5ce)[_0xf1fce6(0x146)](),_0x52e68f=_0xde8918+'?'+_0x3b5b02;if(_0xde8918[_0xf1fce6(0xf7)](_0xf1fce6(0xe6)))return{'url_qrcode':null,'redirectUrl':_0x52e68f,'channel':_0x425beb,'isRedirect':!![]};else{const _0x5d102b=await axios_1['default'][_0xf1fce6(0xb8)](_0xde8918,{'params':_0x2cc5ce});console[_0xf1fce6(0xd1)](_0xf1fce6(0x120),_0x5d102b[_0xf1fce6(0xcc)]);const {data:{code:_0x4f4f77,msg:_0x8a13ce,qrcode:_0x7117c5}}=_0x5d102b;if(_0x4f4f77!=0x1)throw new common_1[(_0xf1fce6(0xdc))](_0x8a13ce,common_1[_0xf1fce6(0xed)]['BAD_REQUEST']);return{'url_qrcode':_0x7117c5,'redirectUrl':null,'channel':_0x425beb,'isRedirect':![]};}}async[_0x21b780(0xee)](_0x5bafd8){const _0x47b9a2=_0x21b780,{payEpayPid:_0x4cf7dd,payEpaySecret:_0x57d15f,payEpayApiQueryUrl:_0x1ed01f}=await this[_0x47b9a2(0x10c)][_0x47b9a2(0x126)](['payEpayPid',_0x47b9a2(0xd7),_0x47b9a2(0xd6)]),_0x4262d0={};_0x4262d0['act']=_0x47b9a2(0xf9),_0x4262d0[_0x47b9a2(0xc2)]=_0x5bafd8,_0x4262d0['pid']=_0x4cf7dd,_0x4262d0['key']=_0x57d15f;const {data:{code:_0x470628,msg:_0x26f436,data:_0x67ca00}}=await axios_1[_0x47b9a2(0xf1)]['get'](_0x1ed01f,{'params':_0x4262d0});if(_0x470628!=0x1)throw new common_1[(_0x47b9a2(0xdc))](_0x26f436,common_1['HttpStatus'][_0x47b9a2(0x11d)]);return _0x67ca00;}async[_0x21b780(0x111)](_0x569d38){const _0x139522=_0x21b780,_0x159b78=_0x569d38[_0x139522(0x14b)];delete _0x569d38[_0x139522(0x14b)],delete _0x569d38[_0x139522(0x142)];const _0x237896=await this['globalConfigService'][_0x139522(0x126)](['payMpaySecret']);console[_0x139522(0xd1)](_0x139522(0xe9));if(this[_0x139522(0x14b)](_0x569d38,_0x237896)!=_0x159b78)return _0x139522(0x11a);console['log'](_0x139522(0x140));const _0x19e216=await this[_0x139522(0xa4)][_0x139522(0xd5)]({'where':{'orderId':_0x569d38[_0x139522(0xc2)],'status':0x0}});if(!_0x19e216)return _0x139522(0x11a);const _0x45b58b=_0x569d38[_0x139522(0xe5)]=='TRADE_SUCCESS'?0x1:0x2;console[_0x139522(0xd1)](_0x139522(0x122),_0x45b58b);const _0x3cc384=await this[_0x139522(0xa4)]['update']({'orderId':_0x569d38[_0x139522(0xc2)]},{'status':_0x45b58b,'paydAt':new Date()});_0x45b58b===0x1&&await this['userBalanceService'][_0x139522(0x14d)](_0x19e216);if(_0x3cc384[_0x139522(0xd9)]!=0x1)return _0x139522(0x11a);return _0x139522(0x10e);}async[_0x21b780(0x13c)](_0x678d0b,_0x17a9e4,_0x265330='wxpay'){const _0x388569=_0x21b780,_0xdd793b=await this[_0x388569(0xa4)][_0x388569(0xd5)]({'where':{'userId':_0x678d0b,'orderId':_0x17a9e4}});if(!_0xdd793b)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus']['BAD_REQUEST']);const _0x18bf04=await this[_0x388569(0x12d)][_0x388569(0xd5)]({'where':{'id':_0xdd793b[_0x388569(0x123)]}});if(!_0x18bf04)throw new common_1[(_0x388569(0xdc))](_0x388569(0xb7),common_1[_0x388569(0xed)][_0x388569(0x11d)]);const {payMpayPid:_0x7d8117,payMpaySecret:_0x543efb,payMpayNotifyUrl:_0x476df5,payMpayReturnUrl:_0x1cf0c4,payMpayApiPayUrl:_0x4fa03b}=await this[_0x388569(0x10c)][_0x388569(0x126)]([_0x388569(0x109),_0x388569(0x10a),_0x388569(0xfd),'payMpayReturnUrl','payMpayApiPayUrl']),_0x2681fd={};_0x2681fd[_0x388569(0x124)]=Number(_0x7d8117),_0x2681fd[_0x388569(0xd3)]=_0x265330,_0x2681fd['out_trade_no']=_0x17a9e4,_0x2681fd[_0x388569(0x13d)]=_0x18bf04[_0x388569(0x13d)],_0x2681fd['money']=_0xdd793b[_0x388569(0x9f)],_0x2681fd['notify_url']=_0x476df5,_0x2681fd[_0x388569(0xaf)]=_0x1cf0c4,_0x2681fd[_0x388569(0x14b)]=this[_0x388569(0x14b)](_0x2681fd,_0x543efb),_0x2681fd[_0x388569(0x142)]=_0x388569(0xe2);const _0x2bdc93=new URLSearchParams(_0x2681fd)['toString'](),_0x2a71f9=_0x4fa03b+'?'+_0x2bdc93;return{'url_qrcode':null,'redirectUrl':_0x2a71f9,'channel':_0x265330,'isRedirect':!![]};const _0x3aa30c=await axios_1[_0x388569(0xf1)][_0x388569(0xb8)](_0x4fa03b,{'params':_0x2681fd});}async[_0x21b780(0xd4)](_0x3d3519){const _0x47e261=_0x21b780,{payMpayApiQueryUrl:_0x2a9e49}=await this['globalConfigService'][_0x47e261(0x126)]([_0x47e261(0x109),'payMpaySecret',_0x47e261(0x10b)]),_0x3dd6c4={};_0x3dd6c4['type']=0x2,_0x3dd6c4[_0x47e261(0xc0)]=_0x3d3519;const {data:{code:_0x30645e,msg:_0x3ec32c,data:_0x11f8d5}}=await axios_1[_0x47e261(0xf1)]['get'](_0x2a9e49,{'params':_0x3dd6c4});if(_0x30645e!=0x1)throw new common_1[(_0x47e261(0xdc))](_0x3ec32c,common_1[_0x47e261(0xed)][_0x47e261(0x11d)]);return _0x11f8d5;}async[_0x21b780(0x145)](_0x1d21f7){const _0x42498a=_0x21b780;console[_0x42498a(0xd1)](_0x42498a(0xf6),_0x1d21f7);const {payWeChatAppId:_0x43c880,payWeChatMchId:_0x6f5b85,payWeChatSecret:_0x3e5f94,payWeChatPublicKey:_0x1426c4,payWeChatPrivateKey:_0x3c9a9e}=await this['globalConfigService'][_0x42498a(0x126)]([_0x42498a(0x11c),_0x42498a(0x13f),_0x42498a(0x13e),_0x42498a(0x11e),_0x42498a(0xd2)]),_0x4c92bd=new this[(_0x42498a(0x12c))]({'appid':_0x43c880,'mchid':_0x6f5b85,'publicKey':_0x1426c4,'privateKey':_0x3c9a9e});try{if(_0x1d21f7['event_type']==_0x42498a(0xfc)){const {ciphertext:_0x206638,associated_data:_0x3e3967,nonce:_0x5034c3}=_0x1d21f7[_0x42498a(0xac)],_0x4fa7e9=_0x4c92bd[_0x42498a(0xf3)](_0x206638,_0x3e3967,_0x5034c3,_0x3e5f94),_0x35a851=await this[_0x42498a(0xa4)][_0x42498a(0xd5)]({'where':{'orderId':_0x4fa7e9[_0x42498a(0xc2)],'status':0x0}});if(!_0x35a851)return _0x42498a(0x11a);const _0x198557=_0x4fa7e9[_0x42498a(0xfb)]==_0x42498a(0xf0)?0x1:0x2,_0x527ead=await this['orderEntity'][_0x42498a(0xe1)]({'orderId':_0x4fa7e9['out_trade_no']},{'status':_0x198557,'paydAt':new Date()});_0x198557===0x1&&await this['userBalanceService'][_0x42498a(0x14d)](_0x35a851);if(_0x527ead[_0x42498a(0xd9)]!=0x1)return _0x42498a(0x11a);}return _0x42498a(0x10e);}catch(_0xeecf2d){return console[_0x42498a(0xd1)](_0x42498a(0xb4),_0xeecf2d),console[_0x42498a(0xd1)](_0x42498a(0x136),_0xeecf2d),_0x42498a(0x11a);}}async['payWeChat'](_0x44062e,_0x3a8f0f,_0x433dae='native'){const _0x1989d8=_0x21b780;var _0x512848,_0x280bf1,_0x409f7f;console[_0x1989d8(0xd1)]('payType:\x20',_0x433dae);const _0x2e7390=await this['orderEntity'][_0x1989d8(0xd5)]({'where':{'userId':_0x44062e,'orderId':_0x3a8f0f}});if(!_0x2e7390)throw new common_1[(_0x1989d8(0xdc))](_0x1989d8(0x143),common_1[_0x1989d8(0xed)][_0x1989d8(0x11d)]);const _0x45f0fc=await this[_0x1989d8(0x12d)][_0x1989d8(0xd5)]({'where':{'id':_0x2e7390[_0x1989d8(0x123)]}});if(!_0x45f0fc)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus']['BAD_REQUEST']);const {payWeChatAppId:_0x446e6f,payWeChatMchId:_0x3a74e3,payWeChatPublicKey:_0x3a002d,payWeChatPrivateKey:_0x5906b2,payWeChatNotifyUrl:_0x1ede71,payWeChatH5Name:_0x40d3b5,payWeChatH5Url:_0xa7ab80}=await this[_0x1989d8(0x10c)][_0x1989d8(0x126)]([_0x1989d8(0x11c),_0x1989d8(0x13f),'payWeChatPublicKey',_0x1989d8(0xd2),_0x1989d8(0x148),'payWeChatH5Name',_0x1989d8(0x147)]),_0x211512=new this[(_0x1989d8(0x12c))]({'appid':_0x446e6f,'mchid':_0x3a74e3,'publicKey':_0x3a002d,'privateKey':_0x5906b2}),_0x5d49b0={'appid':_0x446e6f,'mchid':_0x3a74e3,'description':_0x45f0fc[_0x1989d8(0x13d)],'out_trade_no':_0x3a8f0f,'notify_url':_0x1ede71,'amount':{'total':Number(_0x2e7390[_0x1989d8(0x9f)]*0x64)},'scene_info':{'payer_client_ip':_0x1989d8(0x100)}};console[_0x1989d8(0xd1)]('wechat-pay:\x20',_0x5d49b0);if(_0x433dae=='h5'){_0x5d49b0[_0x1989d8(0x139)]['h5_info']={'type':_0x1989d8(0xcf),'app_name':_0x40d3b5,'app_url':_0xa7ab80};const _0x7436de=await _0x211512[_0x1989d8(0xcb)](_0x5d49b0);if(_0x7436de[_0x1989d8(0xc9)]===0x193){const _0x2e2590=(_0x409f7f=(_0x280bf1=(_0x512848=_0x7436de===null||_0x7436de===void 0x0?void 0x0:_0x7436de['errRaw'])===null||_0x512848===void 0x0?void 0x0:_0x512848['response'])===null||_0x280bf1===void 0x0?void 0x0:_0x280bf1[_0x1989d8(0xc4)])===null||_0x409f7f===void 0x0?void 0x0:_0x409f7f[_0x1989d8(0xbb)];throw new common_1[(_0x1989d8(0xdc))]((_0x7436de===null||_0x7436de===void 0x0?void 0x0:_0x7436de[_0x1989d8(0xbb)])||'微信H5支付失败！',common_1[_0x1989d8(0xed)][_0x1989d8(0x11d)]);}const {h5_url:_0x141cdf}=_0x7436de;return{'url':_0x141cdf};}if(_0x433dae==_0x1989d8(0x13b)){const _0xc8e322=await this[_0x1989d8(0xa0)][_0x1989d8(0xa1)](_0x44062e);console[_0x1989d8(0xd1)]('用户openId:\x20',_0xc8e322),_0x5d49b0['payer']={'openid':_0xc8e322};const _0x2fa2fe=await _0x211512[_0x1989d8(0x137)](_0x5d49b0);return console[_0x1989d8(0xd1)]('jsapi支付结果返回值:\x20',_0x2fa2fe),_0x2fa2fe;}if(_0x433dae==_0x1989d8(0xab)){const _0x312c83=await _0x211512[_0x1989d8(0xa5)](_0x5d49b0),{code_url:_0x2d1a8e}=_0x312c83;return!_0x2d1a8e&&console[_0x1989d8(0xd1)](_0x1989d8(0xc7),_0x312c83),{'url_qrcode':_0x2d1a8e,'isRedirect':![]};}throw new common_1[(_0x1989d8(0xdc))](_0x1989d8(0xb9),common_1['HttpStatus'][_0x1989d8(0x11d)]);}async[_0x21b780(0x113)](_0x452aaf){const _0x167f1a=_0x21b780,{payWeChatAppId:_0x454ab2,payWeChatMchId:_0x510a67,payWeChatPublicKey:_0xead7ab,payWeChatPrivateKey:_0x34af06,payWeChatNotifyUrl:_0x18d9a6,payWeChatH5Name:_0xb83024,payWeChatH5Url:_0x4f2ac4}=await this[_0x167f1a(0x10c)][_0x167f1a(0x126)]([_0x167f1a(0x11c),'payWeChatMchId','payWeChatPublicKey',_0x167f1a(0xd2)]),_0x47c19a=new this[(_0x167f1a(0x12c))]({'appid':_0x454ab2,'mchid':_0x510a67,'publicKey':_0xead7ab,'privateKey':_0x34af06}),_0x410eda=await _0x47c19a[_0x167f1a(0xec)]({'out_trade_no':_0x452aaf});return _0x410eda;}[_0x21b780(0x14b)](_0x713346,_0x4ff79e){const _0x4ac65a=_0x21b780,_0x36f382=Object['keys'](_0x713346)[_0x4ac65a(0x9e)]()[_0x4ac65a(0xe8)](_0x166504=>_0x166504+'='+_0x713346[_0x166504])[_0x4ac65a(0x118)]('&')+_0x4ff79e;return crypto[_0x4ac65a(0x119)](_0x4ac65a(0x108))[_0x4ac65a(0xe1)](_0x36f382)[_0x4ac65a(0x110)](_0x4ac65a(0x13a));}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x21b780(0x12b)])(cramiPackage_entity_1[_0x21b780(0xc6)])),__param(0x1,(0x0,typeorm_1[_0x21b780(0x12b)])(order_entity_1['OrderEntity'])),__metadata(_0x21b780(0xbe),[typeorm_2['Repository'],typeorm_2[_0x21b780(0x11b)],userBalance_service_1[_0x21b780(0xdd)],globalConfig_service_1[_0x21b780(0x112)],user_service_1[_0x21b780(0xb3)]])],PayService),exports[_0x21b780(0xb6)]=PayService;