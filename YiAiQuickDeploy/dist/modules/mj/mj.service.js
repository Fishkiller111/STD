'use strict';const _0x569530=_0x3a8f;function _0x546e(){const _0x1dbc69=['http://172.247.48.137:8000/mj/draw','set','当前图片没有绘画信息、无法放大!','checkRateLimit','freeQueueUsers','map','enlarge','历史中存在当前图片、直接获取！','response','test','Injectable','decorate','queueCount','metadata','axios','saveChatLog','execute','variationSingleImg','../fanyi/fanyi.service','findCurrentPromptResult','当前用户\x20','1301200gxomAp','mjGuildId','getClientIp','当前图片已经放大过了、请勿重复放大!','HttpException','pollForUpscaleResult','Not','uploadService','uploadFileFromUrl','find','绘画任务开始','本次比对的随机ID:\x20','substring','message_id','includes','http://172.247.48.137:8000/mj/list?channel_id=','queryMessageList','now','get','mjAuthorization','chatLogService','defineProperty','sendDrawInteractions','checkAuth','放大单张图片请求失败...','max','../chatLog/chatLog.service','442KlSHxT','1388SoEtLd','mjVersion','开始请求变换图片\x20队列+1:\x20','../../common/utils','GlobalConfigService','PAINT_TYPE','BadwordsService','enlargeWorking','mjRateLimit','user','drawWorking','log','https://discord.com/api/v9/interactions','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','mjDraw','7386HgiRFd','1730ppoSBw','__decorate','mjId','data','mjservice','findCurrentVariationImgResult','2228Zapnfm','存入图片完成:\x20','function','当前提示词已经在任务队列中了、请勿重复提交。。。','Like','7741215iYnHgp','pollForVariationResult','balanceEntity','ChatLogService','InjectRepository','findCurrentEnlargeImgResult','stringify','2589ESmDsV','url','object','getConfigs','IsNull','__param','axios:\x20','findOne','error:\x20','mjNotSaveImg','removeEmoji','../../common/constants/balance.constant','开始请求用户','createQueryBuilder','checkFree','放大图片任务结束\x20队列-1:\x20','error','变换图片任务结束\x20队列-1:\x20','prompt','INTERNAL_SERVER_ERROR','BalanceEntity','\x20请求过于频繁！','default','DeductionKey','开始查询绘画结果轮询','fanyiService','查询期间出现错误：','绘制图片任务结束\x20队列-1:\x20','getMjDefaultParams','deductBalance','由于速率限制、当前普通用户限制为','balance\x20-\x201','BAD_REQUEST','\x20次开始查询','mjApplicationId','历史这些id已经被获取过了\x20不能拿了:\x20','绘画失败','当前图片没有绘画信息、无法变体!','mjChannelId','/messages?limit=50','mjProxy','match','Repository','开始轮询单张变换图片结果','@nestjs/typeorm','badwordsService','绘制图片任务异常中断\x20队列-1:\x20','randomId:\x20','放大当前图片失败','update','22zdDmpG','baiduFanyiAppId','where','axios\x20get:\x20','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','sleep','getOwnPropertyDescriptor','网络连接失败，请稍后再试！','extractContent','baiduFanyiSecret','orderId','globalConfigService','https://discord.com/api/v9/channels/','rateLimits','放大图片任务异常中断\x20队列-1:\x20','design:paramtypes','您当前暂无MJ绘画余额！！！','../userBalance/balance.entity','变化图片任务异常中断\x20队列-1:\x20','admin','length','variationId','拿到了远程地址:\x20','components','filter','replace','MjService','历史记录中不存在当前图片、请确认您放大的图片是否存在','chatLogEntity','createRandomUid','\x20次开始查询[变换图片]','__metadata','sendSmInteractions','parse','upscaleSingleImg','../upload/upload.service','UploadService','秒请求一次、请合理使用！','当前用户','FanyiService','prompt\x20-------->\x20\x20','message','4899671yXDYkS','userId\x20=\x20:userId','push','HttpStatus','5084270SMRqej'];_0x546e=function(){return _0x1dbc69;};return _0x546e();}function _0x3a8f(_0x1cdc7a,_0x499ddd){const _0x546e66=_0x546e();return _0x3a8f=function(_0x3a8fb6,_0x218987){_0x3a8fb6=_0x3a8fb6-0x1f2;let _0xcbfd4=_0x546e66[_0x3a8fb6];return _0xcbfd4;},_0x3a8f(_0x1cdc7a,_0x499ddd);}(function(_0x51fc3b,_0x2d808){const _0x23a0c0=_0x3a8f,_0x4963b6=_0x51fc3b();while(!![]){try{const _0x187b10=parseInt(_0x23a0c0(0x288))/0x1*(parseInt(_0x23a0c0(0x271))/0x2)+parseInt(_0x23a0c0(0x294))/0x3*(-parseInt(_0x23a0c0(0x272))/0x4)+-parseInt(_0x23a0c0(0x282))/0x5*(parseInt(_0x23a0c0(0x281))/0x6)+parseInt(_0x23a0c0(0x23c))/0x7+-parseInt(_0x23a0c0(0x256))/0x8+-parseInt(_0x23a0c0(0x28d))/0x9+-parseInt(_0x23a0c0(0x240))/0xa*(-parseInt(_0x23a0c0(0x212))/0xb);if(_0x187b10===_0x2d808)break;else _0x4963b6['push'](_0x4963b6['shift']());}catch(_0x5af1ab){_0x4963b6['push'](_0x4963b6['shift']());}}}(_0x546e,0x708df));var __decorate=this&&this[_0x569530(0x283)]||function(_0x41da36,_0x24ba58,_0x198d8d,_0x4c7a8d){const _0x21f06b=_0x569530;var _0x17adbf=arguments['length'],_0x43d8c3=_0x17adbf<0x3?_0x24ba58:_0x4c7a8d===null?_0x4c7a8d=Object[_0x21f06b(0x218)](_0x24ba58,_0x198d8d):_0x4c7a8d,_0x2962f3;if(typeof Reflect==='object'&&typeof Reflect[_0x21f06b(0x24c)]===_0x21f06b(0x28a))_0x43d8c3=Reflect[_0x21f06b(0x24c)](_0x41da36,_0x24ba58,_0x198d8d,_0x4c7a8d);else{for(var _0x273438=_0x41da36['length']-0x1;_0x273438>=0x0;_0x273438--)if(_0x2962f3=_0x41da36[_0x273438])_0x43d8c3=(_0x17adbf<0x3?_0x2962f3(_0x43d8c3):_0x17adbf>0x3?_0x2962f3(_0x24ba58,_0x198d8d,_0x43d8c3):_0x2962f3(_0x24ba58,_0x198d8d))||_0x43d8c3;}return _0x17adbf>0x3&&_0x43d8c3&&Object[_0x21f06b(0x26b)](_0x24ba58,_0x198d8d,_0x43d8c3),_0x43d8c3;},__metadata=this&&this[_0x569530(0x231)]||function(_0x598e16,_0x50ad60){const _0xc45ce4=_0x569530;if(typeof Reflect===_0xc45ce4(0x296)&&typeof Reflect[_0xc45ce4(0x24e)]===_0xc45ce4(0x28a))return Reflect[_0xc45ce4(0x24e)](_0x598e16,_0x50ad60);},__param=this&&this[_0x569530(0x299)]||function(_0x4bd300,_0x110481){return function(_0x3c2a14,_0x4d4040){_0x110481(_0x3c2a14,_0x4d4040,_0x4bd300);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x569530(0x22c)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),upload_service_1=require(_0x569530(0x235)),common_1=require('@nestjs/common'),axios_1=require(_0x569530(0x24f)),chatLog_service_1=require(_0x569530(0x270)),balance_constant_1=require(_0x569530(0x29f)),utils_1=require(_0x569530(0x275)),chatLog_entity_1=require('../chatLog/chatLog.entity'),typeorm_1=require('typeorm'),typeorm_2=require(_0x569530(0x20c)),balance_entity_1=require(_0x569530(0x223)),fanyi_service_1=require(_0x569530(0x253)),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x209786,_0xd96b3f,_0x3e6564,_0x33ad9b,_0x428287,_0xdb316c,_0x13c313){const _0x2f98f7=_0x569530;this[_0x2f98f7(0x22e)]=_0x209786,this['balanceEntity']=_0xd96b3f,this[_0x2f98f7(0x25d)]=_0x3e6564,this[_0x2f98f7(0x26a)]=_0x33ad9b,this[_0x2f98f7(0x21d)]=_0x428287,this[_0x2f98f7(0x1f9)]=_0xdb316c,this[_0x2f98f7(0x20d)]=_0x13c313,this['rateLimits']={},this['drawWorking']=[],this[_0x2f98f7(0x279)]=[],this[_0x2f98f7(0x24d)]=0x0,this[_0x2f98f7(0x245)]={};}async[_0x569530(0x280)](_0x7922ce){const _0x4a59f7=_0x569530,{jobId:_0x2943e7,prompt:_0xaf7c4e,startTime:_0x3cba70,userId:_0x566297}=_0x7922ce;return console[_0x4a59f7(0x27d)](_0x4a59f7(0x260),_0x4a59f7(0x286)),await new Promise(_0x310e38=>setTimeout(_0x310e38,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x5002f1,_0x187c76){const _0x3f3de5=_0x569530;await this[_0x3f3de5(0x26d)](_0x187c76),await this[_0x3f3de5(0x20d)]['checkBadWords'](_0x5002f1[_0x3f3de5(0x1f2)],_0x187c76[_0x3f3de5(0x27b)]['id']);const _0x238692=_0x5002f1[_0x3f3de5(0x1f2)];let _0x990431=_0x5002f1[_0x3f3de5(0x1f2)];const {baiduFanyiAppId:_0x2be54d,baiduFanyiSecret:_0x34ac18}=await this[_0x3f3de5(0x21d)]['getConfigs']([_0x3f3de5(0x213),_0x3f3de5(0x21b)]);_0x2be54d&&_0x34ac18&&(_0x990431=await this['fanyiService']['convertToEnglish'](_0x238692));const _0x1ffc71='['+(0x0,utils_1[_0x3f3de5(0x22f)])()+']',_0x56708f=_0x1ffc71+'\x20'+_0x990431;console[_0x3f3de5(0x27d)](_0x3f3de5(0x20f),_0x1ffc71),console[_0x3f3de5(0x27d)](_0x3f3de5(0x23a),_0x56708f);const _0x801d1=this[_0x3f3de5(0x27c)][_0x3f3de5(0x25f)](_0x599ef2=>_0x599ef2[_0x3f3de5(0x264)](_0x5002f1[_0x3f3de5(0x1f2)]));if(_0x801d1)throw new common_1[(_0x3f3de5(0x25a))](_0x3f3de5(0x28b),common_1[_0x3f3de5(0x23f)][_0x3f3de5(0x200)]);if(this[_0x3f3de5(0x24d)]>=0x3)throw new common_1[(_0x3f3de5(0x25a))](_0x3f3de5(0x216),common_1[_0x3f3de5(0x23f)][_0x3f3de5(0x200)]);await this[_0x3f3de5(0x244)](_0x187c76),this[_0x3f3de5(0x24d)]++,console[_0x3f3de5(0x27d)](_0x3f3de5(0x2a0)+_0x187c76[_0x3f3de5(0x27b)]['id']+'\x20队列+1:\x20',this[_0x3f3de5(0x24d)]);try{const _0x386e7e=await this[_0x3f3de5(0x22e)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x3f3de5(0x28c)])('%'+_0x56708f+'%')}}),_0x146b16=_0x386e7e[_0x3f3de5(0x246)](_0x2958bc=>_0x2958bc[_0x3f3de5(0x263)]);this[_0x3f3de5(0x27c)][_0x3f3de5(0x23e)](_0x56708f);let _0x33123d;const _0x25c19e=await this[_0x3f3de5(0x26c)](_0x56708f,_0x146b16,_0x1ffc71);_0x25c19e?(console['log'](_0x3f3de5(0x248)),_0x33123d=_0x25c19e):_0x33123d=await this['pollForResult'](_0x56708f,_0x146b16,_0x1ffc71);this[_0x3f3de5(0x24d)]--,this[_0x3f3de5(0x24d)]<0x0&&(this[_0x3f3de5(0x24d)]=0x0),console['log'](_0x3f3de5(0x1fb),this[_0x3f3de5(0x24d)]);const {id:_0x4d9353,content:_0x2aac38,channel_id:_0x303438,attachments:attachments=[],timestamp:_0x179efa}=_0x33123d;if(!attachments[_0x3f3de5(0x226)]||!attachments[0x0][_0x3f3de5(0x295)])throw new common_1['HttpException'](_0x3f3de5(0x204),common_1[_0x3f3de5(0x23f)][_0x3f3de5(0x200)]);const {filename:_0x2c98bc,url:_0x564ed2,width:_0x15d90a,height:_0x461363,size:_0x1823eb}=attachments[0x0];console[_0x3f3de5(0x27d)](_0x3f3de5(0x228),_0x564ed2);const _0x4dc470=this[_0x3f3de5(0x21d)][_0x3f3de5(0x297)]([_0x3f3de5(0x29d)]);let _0x18e3a1='';(!Number(_0x4dc470)||Number(_0x4dc470)===0x0)&&(_0x18e3a1=await this[_0x3f3de5(0x25d)]['uploadFileFromUrl']({'filename':_0x2c98bc,'url':_0x564ed2}),console[_0x3f3de5(0x27d)](_0x3f3de5(0x289),_0x18e3a1));const _0x502d37={'curIp':(0x0,utils_1['getClientIp'])(_0x187c76),'userId':_0x187c76[_0x3f3de5(0x27b)]['id'],'type':balance_constant_1[_0x3f3de5(0x1f7)]['PAINT_TYPE'],'prompt':_0x56708f,'answer':_0x18e3a1,'model':'mj','extend':this['removeEmoji'](JSON['stringify'](_0x33123d)),'message_id':_0x4d9353,'variationId':_0x4d9353,'upscaleId':_0x4d9353,'group':0x1,'isSaveImg':!Number(_0x4dc470)||Number(_0x4dc470)===0x0,'fileInfo':JSON['stringify']({'width':_0x15d90a,'height':_0x461363,'size':_0x1823eb,'filename':_0x2c98bc,'cosUrl':_0x18e3a1})};return await this[_0x3f3de5(0x26a)][_0x3f3de5(0x250)](_0x502d37),await this[_0x3f3de5(0x1fd)](_0x187c76),this[_0x3f3de5(0x27c)]=this[_0x3f3de5(0x27c)][_0x3f3de5(0x22a)](_0x490b5d=>_0x490b5d!==_0x5002f1['prompt']),_0x18e3a1;}catch(_0x6759f5){this[_0x3f3de5(0x24d)]--,this['queueCount']<0x0&&(this[_0x3f3de5(0x24d)]=0x0),console[_0x3f3de5(0x27d)](_0x3f3de5(0x20e),this[_0x3f3de5(0x24d)]),this[_0x3f3de5(0x27c)]=this['drawWorking'][_0x3f3de5(0x22a)](_0x76862d=>_0x76862d!==_0x5002f1[_0x3f3de5(0x1f2)]);throw new common_1[(_0x3f3de5(0x25a))](_0x6759f5[_0x3f3de5(0x249)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x569530(0x234)](_0x4d07ec,_0x307f65){const _0x1d8eda=_0x569530;if(this[_0x1d8eda(0x24d)]>=0x3)throw new common_1[(_0x1d8eda(0x25a))](_0x1d8eda(0x216),common_1[_0x1d8eda(0x23f)][_0x1d8eda(0x200)]);this[_0x1d8eda(0x24d)]++,console[_0x1d8eda(0x27d)]('用户'+_0x307f65[_0x1d8eda(0x27b)]['id']+'开始请求放大图片\x20队列+1:\x20',this[_0x1d8eda(0x24d)]);const {message_id:_0x443e75,orderId:_0x89d388}=_0x4d07ec;try{const _0x1143c8=await this[_0x1d8eda(0x22e)][_0x1d8eda(0x29b)]({'where':{'message_id':_0x443e75}});if(!_0x1143c8)throw new common_1[(_0x1d8eda(0x25a))](_0x1d8eda(0x22d),common_1[_0x1d8eda(0x23f)][_0x1d8eda(0x200)]);const _0x1f8a6a=await this[_0x1d8eda(0x22e)][_0x1d8eda(0x29b)]({'where':{'upscaleId':_0x443e75,'action':_0x1d8eda(0x247),'orderId':_0x89d388}});if(_0x1f8a6a)throw new common_1[(_0x1d8eda(0x25a))](_0x1d8eda(0x259),common_1[_0x1d8eda(0x23f)][_0x1d8eda(0x200)]);const {prompt:_0x3398c4,extend:_0x3b83a5}=_0x1143c8;let _0x17228e=null;try{_0x17228e=JSON['parse'](_0x3b83a5);}catch(_0x4f1f25){_0x17228e=[];}const {components:components=[]}=_0x17228e;if(!components[_0x1d8eda(0x226)])throw new common_1[(_0x1d8eda(0x25a))](_0x1d8eda(0x243),common_1['HttpStatus'][_0x1d8eda(0x200)]);const _0x343964=components[0x0][_0x1d8eda(0x229)][_0x89d388-0x1],{custom_id:_0x3460e3}=_0x343964;console[_0x1d8eda(0x27d)]('放大custom_id:\x20',_0x3460e3);const _0x4e9d95={'message_id':_0x443e75,'custom_id':_0x3460e3,'prompt':_0x3398c4,'orderId':_0x89d388};await this[_0x1d8eda(0x232)](_0x4e9d95),console[_0x1d8eda(0x27d)]('发送放大指令成功');const _0x35a38e=await this['chatLogEntity']['find']({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x3398c4+'%')}}),_0xed1d3b=_0x35a38e[_0x1d8eda(0x246)](_0x3c9884=>_0x3c9884[_0x1d8eda(0x263)]);console['log'](_0x1d8eda(0x203),_0xed1d3b);const _0x282061=await this[_0x1d8eda(0x25b)](_0x4e9d95,_0xed1d3b);this[_0x1d8eda(0x24d)]--,this[_0x1d8eda(0x24d)]<0x0&&(this[_0x1d8eda(0x24d)]=0x0),console[_0x1d8eda(0x27d)](_0x1d8eda(0x2a3),this['queueCount']);const {id:_0x2d27e3,content:_0x3ab3b8,channel_id:_0x5a8b79,attachments:attachments=[],timestamp:_0x268d0a}=_0x282061;if(!attachments[_0x1d8eda(0x226)]||!attachments[0x0][_0x1d8eda(0x295)])throw new common_1[(_0x1d8eda(0x25a))](_0x1d8eda(0x210),common_1[_0x1d8eda(0x23f)][_0x1d8eda(0x200)]);const {filename:_0xe08b26,url:_0x2cb4b3,width:_0x58a020,height:_0x1dc444,size:_0x4367ad}=attachments[0x0],_0xd5a8d=this[_0x1d8eda(0x21d)]['getConfigs']([_0x1d8eda(0x29d)]);let _0x24b0fd='';(!Number(_0xd5a8d)||Number(_0xd5a8d)===0x0)&&(_0x24b0fd=await this[_0x1d8eda(0x25d)]['uploadFileFromUrl']({'filename':_0xe08b26,'url':_0x2cb4b3}),console['log'](_0x1d8eda(0x289),_0x24b0fd));const _0x1dede5={'curIp':(0x0,utils_1['getClientIp'])(_0x307f65),'userId':_0x307f65[_0x1d8eda(0x27b)]['id'],'type':balance_constant_1[_0x1d8eda(0x1f7)][_0x1d8eda(0x277)],'prompt':_0x3398c4,'answer':_0x24b0fd,'model':'mj','extend':this[_0x1d8eda(0x29e)](JSON[_0x1d8eda(0x293)](_0x282061)),'message_id':_0x443e75,'upscaleId':_0x2d27e3,'variationId':_0x2d27e3,'action':_0x1d8eda(0x247),'orderId':_0x4e9d95['orderId'],'isSaveImg':!Number(_0xd5a8d)||Number(_0xd5a8d)===0x0,'fileInfo':JSON[_0x1d8eda(0x293)]({'width':_0x58a020,'height':_0x1dc444,'size':_0x4367ad,'filename':_0xe08b26,'cosUrl':_0x24b0fd})};return await this[_0x1d8eda(0x26a)][_0x1d8eda(0x250)](_0x1dede5),_0x24b0fd;}catch(_0x3e68a2){console['log'](_0x1d8eda(0x29c),_0x3e68a2),this[_0x1d8eda(0x24d)]--,this['queueCount']<0x0&&(this[_0x1d8eda(0x24d)]=0x0),console[_0x1d8eda(0x27d)](_0x1d8eda(0x220),this[_0x1d8eda(0x24d)]);throw new common_1[(_0x1d8eda(0x25a))](_0x3e68a2[_0x1d8eda(0x249)],common_1[_0x1d8eda(0x23f)][_0x1d8eda(0x200)]);}}async[_0x569530(0x252)](_0x4b7768,_0xd19fe3){const _0x148c30=_0x569530;if(this['queueCount']>=0x3)throw new common_1[(_0x148c30(0x25a))](_0x148c30(0x216),common_1['HttpStatus'][_0x148c30(0x200)]);await this[_0x148c30(0x26d)](_0xd19fe3),await this[_0x148c30(0x244)](_0xd19fe3),this[_0x148c30(0x24d)]++,console[_0x148c30(0x27d)]('用户'+_0xd19fe3['user']['id']+_0x148c30(0x274),this['queueCount']);const {message_id:_0xf38db,orderId:_0x381c9b}=_0x4b7768;try{const _0x250c1f=await this['chatLogEntity'][_0x148c30(0x29b)]({'where':{'message_id':_0xf38db}});if(!_0x250c1f)throw new common_1[(_0x148c30(0x25a))](_0x148c30(0x27f),common_1[_0x148c30(0x23f)][_0x148c30(0x200)]);const {prompt:_0x491a2d,extend:_0x424948}=_0x250c1f;let _0x2b227e=null;try{_0x2b227e=JSON[_0x148c30(0x233)](_0x424948);}catch(_0x3c3ece){_0x2b227e=[];}const {components:components=[]}=_0x2b227e;if(!components[_0x148c30(0x226)])throw new common_1[(_0x148c30(0x25a))](_0x148c30(0x205),common_1['HttpStatus'][_0x148c30(0x200)]);const _0x26680e=components[0x1][_0x148c30(0x229)][_0x381c9b-0x1],{custom_id:_0x124cc2}=_0x26680e,_0x4dbf08=await this[_0x148c30(0x22e)]['find']({'where':{'variationId':(0x0,typeorm_1[_0x148c30(0x25c)])((0x0,typeorm_1[_0x148c30(0x298)])()),'prompt':(0x0,typeorm_1[_0x148c30(0x28c)])('%'+_0x491a2d+'%')}}),_0x7cfefe=_0x4dbf08[_0x148c30(0x246)](_0x454fc5=>_0x454fc5[_0x148c30(0x227)]),_0x1fad19={'message_id':_0xf38db,'custom_id':_0x124cc2,'prompt':_0x491a2d,'orderId':_0x381c9b};await this[_0x148c30(0x232)](_0x1fad19);const _0x67d064=await this[_0x148c30(0x28e)](_0x1fad19,_0x7cfefe);this['queueCount']--,this['queueCount']<0x0&&(this[_0x148c30(0x24d)]=0x0),console['log'](_0x148c30(0x2a5),this[_0x148c30(0x24d)]);const {id:_0x153ebe,content:_0x17388b,channel_id:_0xee77a0,attachments:attachments=[],timestamp:_0x4a2848}=_0x67d064;if(!attachments[_0x148c30(0x226)]||!attachments[0x0][_0x148c30(0x295)])throw new common_1[(_0x148c30(0x25a))]('变换当前图片失败',common_1[_0x148c30(0x23f)][_0x148c30(0x200)]);const {filename:_0x3b043c,url:_0x541abe,width:_0x372239,height:_0x1fdff1,size:_0x2ff9b}=attachments[0x0],_0x5792dd=this[_0x148c30(0x21d)]['getConfigs']([_0x148c30(0x29d)]);let _0x5e3dcc='';(!Number(_0x5792dd)||Number(_0x5792dd)===0x0)&&(_0x5e3dcc=await this[_0x148c30(0x25d)][_0x148c30(0x25e)]({'filename':_0x3b043c,'url':_0x541abe}),console['log'](_0x148c30(0x289),_0x5e3dcc));const _0x45bdfb={'curIp':(0x0,utils_1[_0x148c30(0x258)])(_0xd19fe3),'userId':_0xd19fe3[_0x148c30(0x27b)]['id'],'type':balance_constant_1['DeductionKey'][_0x148c30(0x277)],'prompt':_0x491a2d,'answer':_0x5e3dcc,'model':'mj','group':0x1,'extend':this[_0x148c30(0x29e)](JSON[_0x148c30(0x293)](_0x67d064)),'message_id':_0x153ebe,'upscaleId':_0x153ebe,'variationId':_0x153ebe,'action':_0x148c30(0x247),'orderId':_0x1fad19[_0x148c30(0x21c)],'isSaveImg':!Number(_0x5792dd)||Number(_0x5792dd)===0x0,'fileInfo':JSON[_0x148c30(0x293)]({'width':_0x372239,'height':_0x1fdff1,'size':_0x2ff9b,'filename':_0x3b043c,'cosUrl':_0x5e3dcc})};return await this[_0x148c30(0x26a)][_0x148c30(0x250)](_0x45bdfb),_0x5e3dcc;}catch(_0x184d90){console[_0x148c30(0x27d)](_0x148c30(0x29c),_0x184d90),this[_0x148c30(0x24d)]--,this[_0x148c30(0x24d)]<0x0&&(this['queueCount']=0x0),console[_0x148c30(0x27d)](_0x148c30(0x224),this['queueCount']);throw new common_1[(_0x148c30(0x25a))](_0x184d90[_0x148c30(0x249)],common_1[_0x148c30(0x23f)][_0x148c30(0x200)]);}}async['sendSmInteractions'](_0x128a41){const _0x18287d=_0x569530,{message_id:_0xf86d22,custom_id:_0x1e95e1}=_0x128a41,{application_id:_0x18a159,guild_id:_0x2c4809,channel_id:_0x4b3f54,session_id:_0x192139,version:_0x454efe,id:_0x4d97eb,authorization:_0x2b8aa3,mjProxy:_0x483873}=await this[_0x18287d(0x1fc)](),_0x26f8a5=_0x483873==0x1?_0x18287d(0x241):_0x18287d(0x27e),_0x248e98={'authorization':_0x2b8aa3},_0x4fadfd={'type':0x3,'guild_id':_0x2c4809,'channel_id':_0x4b3f54,'message_flags':0x0,'message_id':_0xf86d22,'application_id':_0x18a159,'session_id':_0x192139,'data':{'component_type':0x2,'custom_id':_0x1e95e1}};try{await axios_1[_0x18287d(0x1f6)]['post'](_0x26f8a5,_0x4fadfd,{'headers':_0x248e98}),console[_0x18287d(0x27d)]('绘图指令完成');}catch(_0x353111){console[_0x18287d(0x27d)](_0x18287d(0x29c),_0x353111);throw new common_1[(_0x18287d(0x25a))](_0x18287d(0x26e),common_1['HttpStatus'][_0x18287d(0x200)]);}}async['pollForUpscaleResult'](_0x411db9,_0x2a88d2){const _0x25046b=_0x569530,{message_id:_0x4f373d,custom_id:_0xd9c173,prompt:_0x3676bd,orderId:_0xc2dd60}=_0x411db9;let _0x2807e=null,_0x38553f=0x0;while(!_0x2807e&&_0x38553f<0xa){try{const _0x4e5697=Date[_0x25046b(0x267)](),_0x3c22bf=await this['queryMessageList']();console['log']('第\x20'+(_0x38553f+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x3c22bf[_0x25046b(0x226)]);_0x3c22bf&&_0x3c22bf['length']&&(_0x2807e=await this[_0x25046b(0x292)](_0x3c22bf,_0x411db9,_0x2a88d2));const _0x40f9fd=Date[_0x25046b(0x267)]()-_0x4e5697,_0x31fc0e=0xbb8;await this[_0x25046b(0x217)](Math[_0x25046b(0x26f)](_0x31fc0e-_0x40f9fd,0x0)),_0x38553f++;}catch(_0x45a59f){console[_0x25046b(0x2a4)](_0x25046b(0x1fa)+_0x45a59f[_0x25046b(0x23b)]);}}return _0x2807e;}async['pollForVariationResult'](_0x2efb00,_0x71f1bc){const _0x4ba918=_0x569530,{message_id:_0x1c0a25,custom_id:_0x5ef5cb,prompt:_0x4d6fa1,orderId:_0x99f72f}=_0x2efb00;console['log'](_0x4ba918(0x20b));let _0x2bbc74=null,_0x271f2a=0x0;while(!_0x2bbc74&&_0x271f2a<0xa){try{console[_0x4ba918(0x27d)]('第\x20'+(_0x271f2a+0x1)+_0x4ba918(0x230));const _0xc867dc=Date[_0x4ba918(0x267)](),_0x3c2c5f=await this[_0x4ba918(0x266)]();_0x3c2c5f&&_0x3c2c5f[_0x4ba918(0x226)]&&(_0x2bbc74=await this[_0x4ba918(0x287)](_0x3c2c5f,_0x2efb00,_0x71f1bc));const _0x556a3b=Date['now']()-_0xc867dc,_0xd63f8c=0x1f40;await this[_0x4ba918(0x217)](Math[_0x4ba918(0x26f)](_0xd63f8c-_0x556a3b,0x0)),_0x271f2a++;}catch(_0xc255a6){console[_0x4ba918(0x2a4)]('查询期间出现错误：'+_0xc255a6[_0x4ba918(0x23b)]);}}if(!_0x2bbc74)throw new common_1[(_0x4ba918(0x25a))]('变换当前图片超时！',common_1['HttpStatus'][_0x4ba918(0x200)]);return _0x2bbc74;}async['findCurrentEnlargeImgResult'](_0x37a242,_0x13c770,_0x18a26e){const _0x12c61c=_0x569530,{message_id:_0x2887df,custom_id:_0x4584ae,prompt:_0xa6b82d,orderId:_0x573ae2}=_0x13c770,_0x41a1e6=_0xa6b82d[_0x12c61c(0x262)](0x0,0xc);console[_0x12c61c(0x27d)]('本次放大图片的id:\x20',_0x41a1e6);const _0x5b0f89=_0x37a242[_0x12c61c(0x25f)](_0x29fdd2=>{const _0x48d5d9=_0x12c61c,{content:_0x2b8576}=_0x29fdd2;if(!this[_0x48d5d9(0x21a)](_0x2b8576))return![];const {prompt:_0x5101fb,order:_0x18d86d}=this[_0x48d5d9(0x21a)](_0x2b8576);return _0x5101fb[_0x48d5d9(0x264)](_0x41a1e6)&&_0x13c770[_0x48d5d9(0x21c)]===_0x18d86d&&!_0x18a26e[_0x48d5d9(0x264)](_0x29fdd2['id']);});return _0x5b0f89;}async[_0x569530(0x287)](_0x49dad4,_0x36a9fb,_0x428df9){const _0x37e452=_0x569530,{message_id:_0x4e7049,custom_id:_0xabeb4b,prompt:_0x280a2e,orderId:_0x4b5ba4}=_0x36a9fb,_0x117142=_0x280a2e[_0x37e452(0x262)](0x0,0xc),_0x42e518=_0x49dad4[_0x37e452(0x25f)](_0x4bd54=>{const _0x3d3c9d=_0x37e452,{content:_0x3a54f0}=_0x4bd54,_0x3434db=_0x3a54f0['match'](/\*\*(.+?)\*\*/),_0x54c4ac=_0x3434db?_0x3434db[0x1]:'';if(!_0x54c4ac)return![];return _0x54c4ac['includes'](_0x117142)&&!_0x428df9[_0x3d3c9d(0x264)](_0x4bd54['id']);});return _0x42e518;}async['sendDrawInteractions'](_0x12b0f6,_0x4f1732,_0x13be95){const _0x1210b5=_0x569530,_0x44f199=await this[_0x1210b5(0x266)](),_0x45a39c=await this[_0x1210b5(0x254)](_0x44f199,_0x13be95,_0x4f1732);if(_0x45a39c)return console[_0x1210b5(0x27d)]('有历史信息之间返回:\x20',_0x45a39c),_0x45a39c;const {application_id:_0x28653d,guild_id:_0x592fd4,channel_id:_0x3176db,session_id:_0x4e0598,version:_0x134521,id:_0x4df1ba,authorization:_0x246e66,mjProxy:_0x2ccb91}=await this[_0x1210b5(0x1fc)](),_0x146f30={'type':0x2,'application_id':_0x28653d,'guild_id':_0x592fd4,'channel_id':_0x3176db,'session_id':_0x4e0598,'data':{'version':_0x134521,'id':_0x4df1ba,'name':'imagine','type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x12b0f6}],'attachments':[]}};try{const _0x469d66=_0x2ccb91==0x1?_0x1210b5(0x241):_0x1210b5(0x27e),_0x22d587={'authorization':_0x246e66},_0x473b55=await axios_1[_0x1210b5(0x1f6)]['post'](_0x469d66,_0x146f30,{'headers':_0x22d587});return console[_0x1210b5(0x27d)]('发送绘画指令结果:\x20',_0x473b55['data']),![];}catch(_0x149856){console['log'](_0x1210b5(0x29a),_0x149856);throw new common_1[(_0x1210b5(0x25a))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1['HttpStatus'][_0x1210b5(0x200)]);}}async['pollForResult'](_0x31ad38,_0x595ed1,_0x4dd6d3){const _0x1cd451=_0x569530;console['log'](_0x1cd451(0x1f8));const _0x3c3a63=Date[_0x1cd451(0x267)]();try{const _0x3cf5e9=0xd,_0x46be3e=0x2ee0,_0x5b20a2=0x1388,_0xc7ac21=0x3c*0x3e8;let _0x298c96=0x0,_0x2d5bba=![],_0x9c402f=null;while(!_0x9c402f&&_0x298c96<_0x3cf5e9){console[_0x1cd451(0x27d)]('第\x20'+(_0x298c96+0x1)+_0x1cd451(0x201));Date[_0x1cd451(0x267)]()-_0x3c3a63>=_0xc7ac21&&(_0x2d5bba=!![]);await this[_0x1cd451(0x217)](_0x2d5bba?_0x5b20a2:_0x46be3e);const _0x423b0e=await this[_0x1cd451(0x266)]();_0x9c402f=await this[_0x1cd451(0x254)](_0x423b0e,_0x4dd6d3,_0x595ed1),_0x298c96++;}if(!_0x9c402f)throw new common_1[(_0x1cd451(0x25a))]('绘画超时，请稍后再试！',common_1[_0x1cd451(0x23f)]['BAD_REQUEST']);const _0x4033d8=Date[_0x1cd451(0x267)]();return console[_0x1cd451(0x27d)]('本次绘图耗时:\x20'+Math['floor']((_0x4033d8-_0x3c3a63)/0x3e8)+'\x20S'),_0x9c402f;}catch(_0x4e314a){console[_0x1cd451(0x2a4)](_0x4e314a[_0x1cd451(0x23b)]);throw new common_1[(_0x1cd451(0x25a))](_0x1cd451(0x219),common_1[_0x1cd451(0x23f)][_0x1cd451(0x1f3)]);}}async[_0x569530(0x254)](_0x5275ca,_0x53a8cb,_0x237e85){const _0x1b75e8=_0x569530;if(!_0x5275ca||!_0x5275ca[_0x1b75e8(0x226)])return;console[_0x1b75e8(0x27d)](_0x1b75e8(0x261),_0x53a8cb);const _0x2d813a=_0x5275ca[_0x1b75e8(0x25f)](_0x51c495=>{const _0x4526ad=_0x1b75e8,{attachments:attachments=[],content:_0x494989,edited_timestamp:_0x5546c7}=_0x51c495;return _0x494989[_0x4526ad(0x264)](_0x53a8cb)&&attachments[_0x4526ad(0x226)]>0x0&&!_0x5546c7&&!_0x237e85['includes'](_0x51c495['id']);});return _0x2d813a||null;}async[_0x569530(0x266)](){const _0x42c416=_0x569530;try{const {application_id:_0x934bc9,guild_id:_0x233a55,channel_id:_0x5312ac,session_id:_0x5d1fb4,version:_0xe677fb,id:_0x1ed056,authorization:_0x43912b,mjProxy:_0x410d72}=await this['getMjDefaultParams'](),_0xe3b7d7=_0x410d72==0x1?_0x42c416(0x265)+_0x5312ac:_0x42c416(0x21e)+_0x5312ac+_0x42c416(0x207),_0x44af20={'authorization':_0x43912b},_0x5ebe22=await axios_1['default'][_0x42c416(0x268)](_0xe3b7d7,{'headers':_0x44af20});return _0x5ebe22[_0x42c416(0x285)];}catch(_0x5a0dee){console[_0x42c416(0x27d)](_0x42c416(0x215),_0x5a0dee);throw new common_1[(_0x42c416(0x25a))]('查询绘制结果失败...',common_1['HttpStatus'][_0x42c416(0x200)]);}}async[_0x569530(0x217)](_0x231cb2){return new Promise(_0x36e12a=>setTimeout(_0x36e12a,_0x231cb2));}[_0x569530(0x21a)](_0x51ef8e){const _0x51efcc=_0x569530,_0xe9335b=_0x51ef8e[_0x51efcc(0x209)](/\*\*(.+?)\*\*/),_0x472a99=_0x51ef8e[_0x51efcc(0x209)](/- Image #(\d+)/);if(!_0xe9335b||!_0x472a99)return null;const _0x43b8ae=_0xe9335b[0x1],_0x5b34fe=parseInt(_0x472a99[0x1]);return{'prompt':_0x43b8ae,'order':_0x5b34fe};}async['getMjDefaultParams'](){const _0x44c056=_0x569530,_0x155b8f=await this[_0x44c056(0x21d)][_0x44c056(0x297)]([_0x44c056(0x284),_0x44c056(0x202),_0x44c056(0x257),_0x44c056(0x206),'mjSessionId','mjVersion','mjAuthorization',_0x44c056(0x27a),_0x44c056(0x208)]),_0x1365aa={'application_id':_0x155b8f[_0x44c056(0x202)],'guild_id':_0x155b8f[_0x44c056(0x257)],'channel_id':_0x155b8f[_0x44c056(0x206)],'session_id':_0x155b8f['mjSessionId'],'version':_0x155b8f[_0x44c056(0x273)],'id':_0x155b8f['mjId'],'authorization':_0x155b8f[_0x44c056(0x269)],'mjRateLimit':_0x155b8f[_0x44c056(0x27a)],'mjProxy':_0x155b8f[_0x44c056(0x208)]||0x0};return _0x1365aa;}[_0x569530(0x29e)](_0x4609a2){const _0x25962e=_0x569530,_0x518247=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x4609a2[_0x25962e(0x22b)](_0x518247,'');}async['checkAuth'](_0x5bd598){const _0x1b8aba=_0x569530,_0x4e7bb1=await this[_0x1b8aba(0x28f)][_0x1b8aba(0x29b)]({'where':{'userId':_0x5bd598['user']['id']}}),{id:_0x17d957,balance:_0x23b5ad}=_0x4e7bb1;if(!_0x23b5ad||(_0x4e7bb1===null||_0x4e7bb1===void 0x0?void 0x0:_0x4e7bb1['balance'])<0x1)throw new common_1['HttpException'](_0x1b8aba(0x222),common_1[_0x1b8aba(0x23f)][_0x1b8aba(0x200)]);}async[_0x569530(0x2a2)](_0x15ba6b){const _0x7ce207=_0x569530,{id:_0x65b8a7,role:_0x58ea6a}=_0x15ba6b[_0x7ce207(0x27b)];!this[_0x7ce207(0x245)][_0x65b8a7]?this[_0x7ce207(0x245)][_0x65b8a7]=0x1:this[_0x7ce207(0x245)][_0x65b8a7]=this[_0x7ce207(0x245)][_0x65b8a7]+0x1,console[_0x7ce207(0x27d)](_0x7ce207(0x238)+_0x65b8a7+'使用的次数：',this[_0x7ce207(0x245)][_0x65b8a7]);}async[_0x569530(0x244)](_0x2de95b){const _0x2b631a=_0x569530,{id:_0x4d3fde,role:_0x556ccb}=_0x2de95b[_0x2b631a(0x27b)];if([_0x2b631a(0x225),'super'][_0x2b631a(0x264)](_0x556ccb))return!![];const {mjRateLimit:_0x52b55c}=await this['getMjDefaultParams']();if(this[_0x2b631a(0x21f)][_0x4d3fde]){const _0x18bf87=this[_0x2b631a(0x21f)][_0x4d3fde];if(_0x18bf87>Date['now']()){console[_0x2b631a(0x27d)](_0x2b631a(0x255)+_0x4d3fde+_0x2b631a(0x1f5));throw new common_1[(_0x2b631a(0x25a))](_0x2b631a(0x1fe)+_0x52b55c+_0x2b631a(0x237),common_1['HttpStatus'][_0x2b631a(0x200)]);}else this['rateLimits'][_0x4d3fde]=Date['now']()+Number(_0x52b55c)*0x3e8;}else{const _0x23dc18=Date[_0x2b631a(0x267)]();this[_0x2b631a(0x21f)][_0x4d3fde]=_0x23dc18+0x3e8*Number(_0x52b55c);}}async[_0x569530(0x1fd)](_0x243785){const _0x4d4718=_0x569530;await this[_0x4d4718(0x28f)][_0x4d4718(0x2a1)]()[_0x4d4718(0x211)](balance_entity_1[_0x4d4718(0x1f4)])[_0x4d4718(0x242)]({'balance':()=>_0x4d4718(0x1ff)})[_0x4d4718(0x214)](_0x4d4718(0x23d),{'userId':_0x243785[_0x4d4718(0x27b)]['id']})[_0x4d4718(0x251)]();}async[_0x569530(0x24a)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x569530(0x24b)])(),__param(0x0,(0x0,typeorm_2[_0x569530(0x291)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x569530(0x291)])(balance_entity_1['BalanceEntity'])),__metadata(_0x569530(0x221),[typeorm_1['Repository'],typeorm_1[_0x569530(0x20a)],upload_service_1[_0x569530(0x236)],chatLog_service_1[_0x569530(0x290)],globalConfig_service_1[_0x569530(0x276)],fanyi_service_1[_0x569530(0x239)],badwords_service_1[_0x569530(0x278)]])],MjService),exports[_0x569530(0x22c)]=MjService;