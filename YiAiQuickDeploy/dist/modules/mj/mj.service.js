'use strict';function _0xae24(_0x566e5c,_0x308d7a){const _0x28a348=_0x28a3();return _0xae24=function(_0xae242,_0x35f1f7){_0xae242=_0xae242-0x69;let _0x444fdf=_0x28a348[_0xae242];return _0x444fdf;},_0xae24(_0x566e5c,_0x308d7a);}const _0x56d761=_0xae24;(function(_0x4b9086,_0x3322da){const _0x561498=_0xae24,_0xab4109=_0x4b9086();while(!![]){try{const _0x7227d5=-parseInt(_0x561498(0xe9))/0x1*(parseInt(_0x561498(0x7e))/0x2)+parseInt(_0x561498(0xc7))/0x3+parseInt(_0x561498(0x72))/0x4+-parseInt(_0x561498(0x116))/0x5*(parseInt(_0x561498(0xe5))/0x6)+-parseInt(_0x561498(0xdc))/0x7+parseInt(_0x561498(0xa2))/0x8*(-parseInt(_0x561498(0x78))/0x9)+parseInt(_0x561498(0x8c))/0xa;if(_0x7227d5===_0x3322da)break;else _0xab4109['push'](_0xab4109['shift']());}catch(_0x51df7a){_0xab4109['push'](_0xab4109['shift']());}}}(_0x28a3,0x21254));var __decorate=this&&this[_0x56d761(0xf5)]||function(_0x1e51f7,_0x60240e,_0x2a7bf4,_0x1e8d20){const _0x4d77fc=_0x56d761;var _0x4962a3=arguments[_0x4d77fc(0xdf)],_0x229fa9=_0x4962a3<0x3?_0x60240e:_0x1e8d20===null?_0x1e8d20=Object[_0x4d77fc(0x7c)](_0x60240e,_0x2a7bf4):_0x1e8d20,_0x35bc52;if(typeof Reflect===_0x4d77fc(0x104)&&typeof Reflect[_0x4d77fc(0x95)]===_0x4d77fc(0xb1))_0x229fa9=Reflect[_0x4d77fc(0x95)](_0x1e51f7,_0x60240e,_0x2a7bf4,_0x1e8d20);else{for(var _0x2a2326=_0x1e51f7[_0x4d77fc(0xdf)]-0x1;_0x2a2326>=0x0;_0x2a2326--)if(_0x35bc52=_0x1e51f7[_0x2a2326])_0x229fa9=(_0x4962a3<0x3?_0x35bc52(_0x229fa9):_0x4962a3>0x3?_0x35bc52(_0x60240e,_0x2a7bf4,_0x229fa9):_0x35bc52(_0x60240e,_0x2a7bf4))||_0x229fa9;}return _0x4962a3>0x3&&_0x229fa9&&Object[_0x4d77fc(0x69)](_0x60240e,_0x2a7bf4,_0x229fa9),_0x229fa9;},__metadata=this&&this[_0x56d761(0xa4)]||function(_0xe02af2,_0x467361){const _0x2594b3=_0x56d761;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x2594b3(0xb1))return Reflect[_0x2594b3(0xba)](_0xe02af2,_0x467361);},__param=this&&this[_0x56d761(0x6d)]||function(_0xd8ace4,_0x3df65e){return function(_0x21105a,_0x5adf82){_0x3df65e(_0x21105a,_0x5adf82,_0xd8ace4);};};Object[_0x56d761(0x69)](exports,_0x56d761(0xd4),{'value':!![]}),exports[_0x56d761(0x70)]=void 0x0;const globalConfig_service_1=require(_0x56d761(0xc9)),upload_service_1=require(_0x56d761(0x7b)),common_1=require(_0x56d761(0xae)),axios_1=require(_0x56d761(0xfd)),chatLog_service_1=require(_0x56d761(0xb4)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x56d761(0xd1)),typeorm_1=require(_0x56d761(0x6f)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x56d761(0x113)),fanyi_service_1=require(_0x56d761(0x80)),badwords_service_1=require(_0x56d761(0xfb));let MjService=class MjService{constructor(_0x444800,_0x1e6307,_0x1fc6c8,_0x50ca24,_0x5a2f45,_0x4b9583,_0x51dd28){const _0x17f247=_0x56d761;this[_0x17f247(0xaf)]=_0x444800,this[_0x17f247(0x77)]=_0x1e6307,this['uploadService']=_0x1fc6c8,this[_0x17f247(0x110)]=_0x50ca24,this['globalConfigService']=_0x5a2f45,this[_0x17f247(0xa7)]=_0x4b9583,this[_0x17f247(0xec)]=_0x51dd28,this[_0x17f247(0x73)]={},this[_0x17f247(0xc2)]=[],this[_0x17f247(0xe6)]=[],this[_0x17f247(0x102)]=0x0,this[_0x17f247(0xd0)]={};}async[_0x56d761(0x11a)](_0x568159){const _0x2cd7b8=_0x56d761,{jobId:_0x2376b5,prompt:_0x1a7ac3,startTime:_0x300e3a,userId:_0x260581}=_0x568159;return console[_0x2cd7b8(0xc0)](_0x2cd7b8(0xef),_0x2cd7b8(0xd3)),await new Promise(_0x3d7a2b=>setTimeout(_0x3d7a2b,0x1388)),{'a':0x1,'b':0x2};}async[_0x56d761(0x101)](_0x39e383,_0x402646){const _0x911fca=_0x56d761;await this['checkAuth'](_0x402646),await this[_0x911fca(0xec)][_0x911fca(0xff)](_0x39e383[_0x911fca(0xde)],_0x402646[_0x911fca(0x8b)]['id']);const _0x8e4c91=_0x39e383['prompt'];let _0x3c1baf=_0x39e383['prompt'];const {baiduFanyiAppId:_0x1a99d3,baiduFanyiSecret:_0x306c51}=await this[_0x911fca(0xbc)][_0x911fca(0x9b)]([_0x911fca(0xf2),'baiduFanyiSecret']);_0x1a99d3&&_0x306c51&&(_0x3c1baf=await this[_0x911fca(0xa7)][_0x911fca(0xcc)](_0x8e4c91));const _0x514dbb='['+(0x0,utils_1[_0x911fca(0xf0)])()+']',_0x3287f0=_0x514dbb+'\x20'+_0x3c1baf;console['log'](_0x911fca(0x86),_0x514dbb),console[_0x911fca(0xc0)]('prompt\x20-------->\x20\x20',_0x3287f0);const _0x2d9677=this[_0x911fca(0xc2)]['find'](_0x97f5c=>_0x97f5c[_0x911fca(0xb3)](_0x39e383[_0x911fca(0xde)]));if(_0x2d9677)throw new common_1[(_0x911fca(0x111))]('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1['HttpStatus'][_0x911fca(0xee)]);if(this[_0x911fca(0x102)]>=0x3)throw new common_1[(_0x911fca(0x111))](_0x911fca(0xed),common_1[_0x911fca(0xbf)]['BAD_REQUEST']);await this[_0x911fca(0xf4)](_0x402646),this['queueCount']++,console[_0x911fca(0xc0)](_0x911fca(0xe3)+_0x402646[_0x911fca(0x8b)]['id']+_0x911fca(0x114),this[_0x911fca(0x102)]);try{const _0x8c3117=await this[_0x911fca(0xaf)][_0x911fca(0xa0)]({'where':{'prompt':(0x0,typeorm_1[_0x911fca(0x9a)])('%'+_0x3287f0+'%')}}),_0x137084=_0x8c3117[_0x911fca(0x92)](_0x13c848=>_0x13c848['message_id']);this[_0x911fca(0xc2)]['push'](_0x3287f0);let _0xc3de1f;const _0x588283=await this[_0x911fca(0x112)](_0x3287f0,_0x137084,_0x514dbb);_0x588283?(console['log'](_0x911fca(0xd9)),_0xc3de1f=_0x588283):_0xc3de1f=await this['pollForResult'](_0x3287f0,_0x137084,_0x514dbb);this[_0x911fca(0x102)]--,this[_0x911fca(0x102)]<0x0&&(this[_0x911fca(0x102)]=0x0),console[_0x911fca(0xc0)](_0x911fca(0xbd),this[_0x911fca(0x102)]);const {id:_0x150422,content:_0x24fe9a,channel_id:_0x10cd2d,attachments:attachments=[],timestamp:_0x33722c}=_0xc3de1f;if(!attachments['length']||!attachments[0x0][_0x911fca(0x6b)])throw new common_1[(_0x911fca(0x111))](_0x911fca(0x79),common_1['HttpStatus'][_0x911fca(0xee)]);const {filename:_0x1ba7ab,url:_0x3ca8b9,width:_0x4db422,height:_0x37286e,size:_0x4c1eb2}=attachments[0x0];console[_0x911fca(0xc0)](_0x911fca(0x96),_0x3ca8b9);const _0x5468d4=this[_0x911fca(0xbc)]['getConfigs']([_0x911fca(0x81)]);let _0xa1ab92='';(!Number(_0x5468d4)||Number(_0x5468d4)===0x0)&&(_0xa1ab92=await this[_0x911fca(0xb5)]['uploadFileFromUrl']({'filename':_0x1ba7ab,'url':_0x3ca8b9}),console[_0x911fca(0xc0)](_0x911fca(0xd7),_0xa1ab92));const _0x3b8c5d={'curIp':(0x0,utils_1[_0x911fca(0xaa)])(_0x402646),'userId':_0x402646[_0x911fca(0x8b)]['id'],'type':balance_constant_1[_0x911fca(0x119)][_0x911fca(0xa3)],'prompt':_0x3287f0,'answer':_0xa1ab92,'model':'mj','extend':this[_0x911fca(0x109)](JSON['stringify'](_0xc3de1f)),'message_id':_0x150422,'variationId':_0x150422,'upscaleId':_0x150422,'group':0x1,'isSaveImg':!Number(_0x5468d4)||Number(_0x5468d4)===0x0,'fileInfo':JSON[_0x911fca(0x74)]({'width':_0x4db422,'height':_0x37286e,'size':_0x4c1eb2,'filename':_0x1ba7ab,'cosUrl':_0xa1ab92})};return await this['chatLogService'][_0x911fca(0x76)](_0x3b8c5d),await this[_0x911fca(0xf3)](_0x402646),this[_0x911fca(0xc2)]=this[_0x911fca(0xc2)][_0x911fca(0xb2)](_0x34b7db=>_0x34b7db!==_0x39e383[_0x911fca(0xde)]),_0xa1ab92;}catch(_0xe27f5f){this['queueCount']--,this[_0x911fca(0x102)]<0x0&&(this['queueCount']=0x0),console[_0x911fca(0xc0)](_0x911fca(0x87),this[_0x911fca(0x102)]),this['drawWorking']=this['drawWorking'][_0x911fca(0xb2)](_0x5a216d=>_0x5a216d!==_0x39e383[_0x911fca(0xde)]);throw new common_1[(_0x911fca(0x111))](_0xe27f5f[_0x911fca(0x6a)],common_1[_0x911fca(0xbf)][_0x911fca(0xee)]);}}async[_0x56d761(0xa5)](_0x3fe8e2,_0x239ae1){const _0x19773f=_0x56d761;if(this[_0x19773f(0x102)]>=0x3)throw new common_1[(_0x19773f(0x111))](_0x19773f(0xed),common_1[_0x19773f(0xbf)][_0x19773f(0xee)]);this['queueCount']++,console[_0x19773f(0xc0)]('用户'+_0x239ae1['user']['id']+'开始请求放大图片\x20队列+1:\x20',this[_0x19773f(0x102)]);const {message_id:_0x5b19b8,orderId:_0x358d06}=_0x3fe8e2;try{const _0x49db80=await this[_0x19773f(0xaf)][_0x19773f(0xd2)]({'where':{'message_id':_0x5b19b8}});if(!_0x49db80)throw new common_1[(_0x19773f(0x111))]('历史记录中不存在当前图片、请确认您放大的图片是否存在',common_1[_0x19773f(0xbf)][_0x19773f(0xee)]);const _0x1215da=await this['chatLogEntity'][_0x19773f(0xd2)]({'where':{'upscaleId':_0x5b19b8,'action':_0x19773f(0xeb),'orderId':_0x358d06}});if(_0x1215da)throw new common_1[(_0x19773f(0x111))]('当前图片已经放大过了、请勿重复放大!',common_1[_0x19773f(0xbf)][_0x19773f(0xee)]);const {prompt:_0x1a2106,extend:_0x533376}=_0x49db80;let _0x5a68e8=null;try{_0x5a68e8=JSON[_0x19773f(0xad)](_0x533376);}catch(_0x393cf6){_0x5a68e8=[];}const {components:components=[]}=_0x5a68e8;if(!components[_0x19773f(0xdf)])throw new common_1[(_0x19773f(0x111))](_0x19773f(0xc4),common_1[_0x19773f(0xbf)][_0x19773f(0xee)]);const _0x595cb4=components[0x0][_0x19773f(0x118)][_0x358d06-0x1],{custom_id:_0x22cebf}=_0x595cb4;console[_0x19773f(0xc0)](_0x19773f(0xfa),_0x22cebf);const _0x2cc72b={'message_id':_0x5b19b8,'custom_id':_0x22cebf,'prompt':_0x1a2106,'orderId':_0x358d06};await this[_0x19773f(0x89)](_0x2cc72b),console['log'](_0x19773f(0x9c));const _0x379194=await this[_0x19773f(0xaf)][_0x19773f(0xa0)]({'where':{'prompt':(0x0,typeorm_1[_0x19773f(0x9a)])('%'+_0x1a2106+'%')}}),_0x362446=_0x379194[_0x19773f(0x92)](_0xda0fe4=>_0xda0fe4['message_id']);console[_0x19773f(0xc0)](_0x19773f(0xf6),_0x362446);const _0x51079e=await this[_0x19773f(0xd8)](_0x2cc72b,_0x362446);this[_0x19773f(0x102)]--,this['queueCount']<0x0&&(this[_0x19773f(0x102)]=0x0),console['log'](_0x19773f(0xcd),this['queueCount']);const {id:_0x17e03c,content:_0x568206,channel_id:_0x578624,attachments:attachments=[],timestamp:_0x2d8ed0}=_0x51079e;if(!attachments['length']||!attachments[0x0][_0x19773f(0x6b)])throw new common_1[(_0x19773f(0x111))](_0x19773f(0x8e),common_1[_0x19773f(0xbf)][_0x19773f(0xee)]);const {filename:_0x6b7d3b,url:_0x11101c,width:_0x24e4a8,height:_0x16fda3,size:_0x55186b}=attachments[0x0],_0x438c95=this[_0x19773f(0xbc)][_0x19773f(0x9b)]([_0x19773f(0x81)]);let _0x423d1e='';(!Number(_0x438c95)||Number(_0x438c95)===0x0)&&(_0x423d1e=await this['uploadService']['uploadFileFromUrl']({'filename':_0x6b7d3b,'url':_0x11101c}),console[_0x19773f(0xc0)]('存入图片完成:\x20',_0x423d1e));const _0x54eefc={'curIp':(0x0,utils_1[_0x19773f(0xaa)])(_0x239ae1),'userId':_0x239ae1[_0x19773f(0x8b)]['id'],'type':balance_constant_1[_0x19773f(0x119)][_0x19773f(0xa3)],'prompt':_0x1a2106,'answer':_0x423d1e,'model':'mj','extend':this[_0x19773f(0x109)](JSON[_0x19773f(0x74)](_0x51079e)),'message_id':_0x5b19b8,'upscaleId':_0x17e03c,'variationId':_0x17e03c,'action':'enlarge','orderId':_0x2cc72b[_0x19773f(0xb9)],'isSaveImg':!Number(_0x438c95)||Number(_0x438c95)===0x0,'fileInfo':JSON[_0x19773f(0x74)]({'width':_0x24e4a8,'height':_0x16fda3,'size':_0x55186b,'filename':_0x6b7d3b,'cosUrl':_0x423d1e})};return await this[_0x19773f(0x110)][_0x19773f(0x76)](_0x54eefc),_0x423d1e;}catch(_0x350df9){console['log'](_0x19773f(0x82),_0x350df9),this[_0x19773f(0x102)]--,this[_0x19773f(0x102)]<0x0&&(this['queueCount']=0x0),console[_0x19773f(0xc0)]('放大图片任务异常中断\x20队列-1:\x20',this[_0x19773f(0x102)]);throw new common_1['HttpException'](_0x350df9[_0x19773f(0x6a)],common_1[_0x19773f(0xbf)]['BAD_REQUEST']);}}async[_0x56d761(0xbe)](_0x409787,_0x51a734){const _0x13c92d=_0x56d761;if(this['queueCount']>=0x3)throw new common_1[(_0x13c92d(0x111))](_0x13c92d(0xed),common_1['HttpStatus'][_0x13c92d(0xee)]);await this[_0x13c92d(0xcf)](_0x51a734),await this[_0x13c92d(0xf4)](_0x51a734),this[_0x13c92d(0x102)]++,console[_0x13c92d(0xc0)]('用户'+_0x51a734[_0x13c92d(0x8b)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x13c92d(0x102)]);const {message_id:_0x18b239,orderId:_0x43de21}=_0x409787;try{const _0x44cd98=await this[_0x13c92d(0xaf)][_0x13c92d(0xd2)]({'where':{'message_id':_0x18b239}});if(!_0x44cd98)throw new common_1[(_0x13c92d(0x111))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1[_0x13c92d(0xbf)][_0x13c92d(0xee)]);const {prompt:_0x279d0d,extend:_0xf7b00f}=_0x44cd98;let _0x6b290d=null;try{_0x6b290d=JSON[_0x13c92d(0xad)](_0xf7b00f);}catch(_0x11f7ac){_0x6b290d=[];}const {components:components=[]}=_0x6b290d;if(!components[_0x13c92d(0xdf)])throw new common_1[(_0x13c92d(0x111))](_0x13c92d(0xc5),common_1[_0x13c92d(0xbf)]['BAD_REQUEST']);const _0x244833=components[0x1][_0x13c92d(0x118)][_0x43de21-0x1],{custom_id:_0xc279d0}=_0x244833,_0x48347a=await this[_0x13c92d(0xaf)]['find']({'where':{'variationId':(0x0,typeorm_1[_0x13c92d(0x9d)])((0x0,typeorm_1['IsNull'])()),'prompt':(0x0,typeorm_1[_0x13c92d(0x9a)])('%'+_0x279d0d+'%')}}),_0x4062f2=_0x48347a['map'](_0x5f1aa8=>_0x5f1aa8[_0x13c92d(0xfc)]),_0x48a4e5={'message_id':_0x18b239,'custom_id':_0xc279d0,'prompt':_0x279d0d,'orderId':_0x43de21};await this['sendSmInteractions'](_0x48a4e5);const _0x1bb3d7=await this[_0x13c92d(0x91)](_0x48a4e5,_0x4062f2);this['queueCount']--,this[_0x13c92d(0x102)]<0x0&&(this['queueCount']=0x0),console[_0x13c92d(0xc0)]('变换图片任务结束\x20队列-1:\x20',this[_0x13c92d(0x102)]);const {id:_0x270413,content:_0x14f53f,channel_id:_0x1d30a5,attachments:attachments=[],timestamp:_0x441c97}=_0x1bb3d7;if(!attachments[_0x13c92d(0xdf)]||!attachments[0x0][_0x13c92d(0x6b)])throw new common_1['HttpException'](_0x13c92d(0x7a),common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0x4eaf08,url:_0x563278,width:_0x4bf928,height:_0x493740,size:_0x4b843e}=attachments[0x0],_0x3e31da=this['globalConfigService'][_0x13c92d(0x9b)]([_0x13c92d(0x81)]);let _0xbb1281='';(!Number(_0x3e31da)||Number(_0x3e31da)===0x0)&&(_0xbb1281=await this[_0x13c92d(0xb5)][_0x13c92d(0xe0)]({'filename':_0x4eaf08,'url':_0x563278}),console[_0x13c92d(0xc0)](_0x13c92d(0xd7),_0xbb1281));const _0x5c7598={'curIp':(0x0,utils_1['getClientIp'])(_0x51a734),'userId':_0x51a734[_0x13c92d(0x8b)]['id'],'type':balance_constant_1[_0x13c92d(0x119)]['PAINT_TYPE'],'prompt':_0x279d0d,'answer':_0xbb1281,'model':'mj','group':0x1,'extend':this[_0x13c92d(0x109)](JSON['stringify'](_0x1bb3d7)),'message_id':_0x270413,'upscaleId':_0x270413,'variationId':_0x270413,'action':_0x13c92d(0xeb),'orderId':_0x48a4e5[_0x13c92d(0xb9)],'isSaveImg':!Number(_0x3e31da)||Number(_0x3e31da)===0x0,'fileInfo':JSON[_0x13c92d(0x74)]({'width':_0x4bf928,'height':_0x493740,'size':_0x4b843e,'filename':_0x4eaf08,'cosUrl':_0xbb1281})};return await this[_0x13c92d(0x110)][_0x13c92d(0x76)](_0x5c7598),_0xbb1281;}catch(_0x20d851){console[_0x13c92d(0xc0)](_0x13c92d(0x82),_0x20d851),this[_0x13c92d(0x102)]--,this[_0x13c92d(0x102)]<0x0&&(this[_0x13c92d(0x102)]=0x0),console['log'](_0x13c92d(0x105),this[_0x13c92d(0x102)]);throw new common_1[(_0x13c92d(0x111))](_0x20d851['response'],common_1[_0x13c92d(0xbf)][_0x13c92d(0xee)]);}}async[_0x56d761(0x89)](_0x1b83c9){const _0x3ac8a4=_0x56d761,{message_id:_0x5e911e,custom_id:_0x12826e}=_0x1b83c9,{application_id:_0xa7f1d4,guild_id:_0x29abb5,channel_id:_0x23f30a,session_id:_0x4a8fcd,version:_0x263d0c,id:_0x5306fe,authorization:_0x58c1ee,mjProxy:_0x16a5ca}=await this[_0x3ac8a4(0xb6)](),_0x1a94b5=_0x16a5ca==0x1?_0x3ac8a4(0xf7):_0x3ac8a4(0xa8),_0x19e832={'authorization':_0x58c1ee},_0x55013f={'type':0x3,'guild_id':_0x29abb5,'channel_id':_0x23f30a,'message_flags':0x0,'message_id':_0x5e911e,'application_id':_0xa7f1d4,'session_id':_0x4a8fcd,'data':{'component_type':0x2,'custom_id':_0x12826e}};try{await axios_1[_0x3ac8a4(0xac)][_0x3ac8a4(0x90)](_0x1a94b5,_0x55013f,{'headers':_0x19e832}),console[_0x3ac8a4(0xc0)]('绘图指令完成');}catch(_0x2afca3){console['log']('error:\x20',_0x2afca3);throw new common_1[(_0x3ac8a4(0x111))](_0x3ac8a4(0xa1),common_1[_0x3ac8a4(0xbf)][_0x3ac8a4(0xee)]);}}async[_0x56d761(0xd8)](_0x331db8,_0x2c3002){const _0xa7f75a=_0x56d761,{message_id:_0x174e95,custom_id:_0x144190,prompt:_0x12e1e3,orderId:_0x5de92e}=_0x331db8;let _0x3cff09=null,_0x17c970=0x0;while(!_0x3cff09&&_0x17c970<0xa){try{const _0xd235aa=Date[_0xa7f75a(0x117)](),_0x250ac6=await this[_0xa7f75a(0x98)]();console['log']('第\x20'+(_0x17c970+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x250ac6[_0xa7f75a(0xdf)]);_0x250ac6&&_0x250ac6[_0xa7f75a(0xdf)]&&(_0x3cff09=await this['findCurrentEnlargeImgResult'](_0x250ac6,_0x331db8,_0x2c3002));const _0x26f9af=Date[_0xa7f75a(0x117)]()-_0xd235aa,_0x5bbeee=0xbb8;await this[_0xa7f75a(0x10d)](Math['max'](_0x5bbeee-_0x26f9af,0x0)),_0x17c970++;}catch(_0xfe2c3f){console[_0xa7f75a(0xa9)](_0xa7f75a(0x7d)+_0xfe2c3f[_0xa7f75a(0xe7)]);}}return _0x3cff09;}async[_0x56d761(0x91)](_0x5a5c4,_0x42ba93){const _0x478166=_0x56d761,{message_id:_0x97befb,custom_id:_0x1f09a3,prompt:_0x356d15,orderId:_0x6dde53}=_0x5a5c4;console[_0x478166(0xc0)]('开始轮询单张变换图片结果');let _0x5b4f00=null,_0x2efff8=0x0;while(!_0x5b4f00&&_0x2efff8<0xa){try{console[_0x478166(0xc0)]('第\x20'+(_0x2efff8+0x1)+_0x478166(0xb0));const _0x391c03=Date[_0x478166(0x117)](),_0x22c748=await this['queryMessageList']();_0x22c748&&_0x22c748[_0x478166(0xdf)]&&(_0x5b4f00=await this[_0x478166(0x10b)](_0x22c748,_0x5a5c4,_0x42ba93));const _0x39ba1b=Date[_0x478166(0x117)]()-_0x391c03,_0x2a94f0=0x1f40;await this[_0x478166(0x10d)](Math[_0x478166(0x83)](_0x2a94f0-_0x39ba1b,0x0)),_0x2efff8++;}catch(_0x1cb151){console[_0x478166(0xa9)](_0x478166(0x7d)+_0x1cb151['message']);}}if(!_0x5b4f00)throw new common_1['HttpException'](_0x478166(0x108),common_1['HttpStatus']['BAD_REQUEST']);return _0x5b4f00;}async[_0x56d761(0x84)](_0x29cdcd,_0x294441,_0x5f3ecc){const _0x3996ea=_0x56d761,{message_id:_0x2337d1,custom_id:_0xeaafaf,prompt:_0x6ffe12,orderId:_0x28c068}=_0x294441,_0x372ba7=_0x6ffe12['substring'](0x0,0xc);console['log'](_0x3996ea(0x71),_0x372ba7);const _0x1ef6de=_0x29cdcd[_0x3996ea(0xa0)](_0x16846e=>{const _0x46226d=_0x3996ea,{content:_0x1d182a}=_0x16846e;if(!this['extractContent'](_0x1d182a))return![];const {prompt:_0x323605,order:_0x258aa4}=this[_0x46226d(0xce)](_0x1d182a);return _0x323605[_0x46226d(0xb3)](_0x372ba7)&&_0x294441[_0x46226d(0xb9)]===_0x258aa4&&!_0x5f3ecc[_0x46226d(0xb3)](_0x16846e['id']);});return _0x1ef6de;}async[_0x56d761(0x10b)](_0x1db5a2,_0x752336,_0x5f0549){const _0x395db4=_0x56d761,{message_id:_0x2eea70,custom_id:_0x577ab3,prompt:_0x3cfe9a,orderId:_0xd36a79}=_0x752336,_0x531807=_0x3cfe9a[_0x395db4(0xe8)](0x0,0xc),_0xbf3a2e=_0x1db5a2[_0x395db4(0xa0)](_0x2b5318=>{const _0x49b7f5=_0x395db4,{content:_0xd7268b}=_0x2b5318,_0x4e62ef=_0xd7268b[_0x49b7f5(0x10f)](/\*\*(.+?)\*\*/),_0x5173bc=_0x4e62ef?_0x4e62ef[0x1]:'';if(!_0x5173bc)return![];return _0x5173bc[_0x49b7f5(0xb3)](_0x531807)&&!_0x5f0549[_0x49b7f5(0xb3)](_0x2b5318['id']);});return _0xbf3a2e;}async['sendDrawInteractions'](_0x5952d0,_0x556557,_0x10fa31){const _0x33bfed=_0x56d761,_0x98f1a2=await this[_0x33bfed(0x98)](),_0x57ae43=await this['findCurrentPromptResult'](_0x98f1a2,_0x10fa31,_0x556557);if(_0x57ae43)return console[_0x33bfed(0xc0)]('有历史信息之间返回:\x20',_0x57ae43),_0x57ae43;const {application_id:_0x5375c6,guild_id:_0x5dcd23,channel_id:_0x175286,session_id:_0x17a34c,version:_0x1c1f37,id:_0x195429,authorization:_0x4eb08e,mjProxy:_0x47e78c}=await this[_0x33bfed(0xb6)](),_0x5cee43={'type':0x2,'application_id':_0x5375c6,'guild_id':_0x5dcd23,'channel_id':_0x175286,'session_id':_0x17a34c,'data':{'version':_0x1c1f37,'id':_0x195429,'name':_0x33bfed(0xe4),'type':0x1,'options':[{'type':0x3,'name':_0x33bfed(0xde),'value':_0x5952d0}],'attachments':[]}};try{const _0x5d6602=_0x47e78c==0x1?_0x33bfed(0xf7):_0x33bfed(0xa8),_0x582140={'authorization':_0x4eb08e},_0x1f3ca1=await axios_1[_0x33bfed(0xac)][_0x33bfed(0x90)](_0x5d6602,_0x5cee43,{'headers':_0x582140});return console[_0x33bfed(0xc0)]('发送绘画指令结果:\x20',_0x1f3ca1[_0x33bfed(0x103)]),![];}catch(_0x32e3a7){console[_0x33bfed(0xc0)](_0x33bfed(0xdd),_0x32e3a7);throw new common_1[(_0x33bfed(0x111))](_0x33bfed(0x100),common_1[_0x33bfed(0xbf)][_0x33bfed(0xee)]);}}async[_0x56d761(0x8d)](_0x41c2fc,_0x10d226,_0x34b1d1){const _0x35aad7=_0x56d761;console[_0x35aad7(0xc0)](_0x35aad7(0xd5));const _0x3f380d=Date[_0x35aad7(0x117)]();try{const _0x3b0a7b=0xd,_0x3802b2=0x2ee0,_0x39ea7f=0x1388,_0x345ef1=0x3c*0x3e8;let _0x2e1b2f=0x0,_0x23ca04=![],_0x1cb149=null;while(!_0x1cb149&&_0x2e1b2f<_0x3b0a7b){console[_0x35aad7(0xc0)]('第\x20'+(_0x2e1b2f+0x1)+'\x20次开始查询');Date[_0x35aad7(0x117)]()-_0x3f380d>=_0x345ef1&&(_0x23ca04=!![]);await this[_0x35aad7(0x10d)](_0x23ca04?_0x39ea7f:_0x3802b2);const _0x1a4c7c=await this[_0x35aad7(0x98)]();_0x1cb149=await this[_0x35aad7(0x8a)](_0x1a4c7c,_0x34b1d1,_0x10d226),_0x2e1b2f++;}if(!_0x1cb149)throw new common_1[(_0x35aad7(0x111))](_0x35aad7(0x8f),common_1[_0x35aad7(0xbf)][_0x35aad7(0xee)]);const _0x243aa1=Date[_0x35aad7(0x117)]();return console['log']('本次绘图耗时:\x20'+Math[_0x35aad7(0x9f)]((_0x243aa1-_0x3f380d)/0x3e8)+'\x20S'),_0x1cb149;}catch(_0x5802f0){console[_0x35aad7(0xa9)](_0x5802f0[_0x35aad7(0xe7)]);throw new common_1[(_0x35aad7(0x111))]('网络连接失败，请稍后再试！',common_1['HttpStatus']['INTERNAL_SERVER_ERROR']);}}async['findCurrentPromptResult'](_0x1a688c,_0x1558e7,_0x185ad7){const _0x53e86a=_0x56d761;if(!_0x1a688c||!_0x1a688c['length'])return;console[_0x53e86a(0xc0)](_0x53e86a(0x7f),_0x1558e7);const _0x48e07b=_0x1a688c[_0x53e86a(0xa0)](_0x23739c=>{const _0x3264b7=_0x53e86a,{attachments:attachments=[],content:_0x2e916b,edited_timestamp:_0x597b76}=_0x23739c;return _0x2e916b['includes'](_0x1558e7)&&attachments[_0x3264b7(0xdf)]>0x0&&!_0x597b76&&!_0x185ad7[_0x3264b7(0xb3)](_0x23739c['id']);});return _0x48e07b||null;}async[_0x56d761(0x98)](){const _0x57a4a5=_0x56d761;try{const {application_id:_0x343aed,guild_id:_0x490b98,channel_id:_0x3431ab,session_id:_0x35ea8c,version:_0x20ad58,id:_0x164279,authorization:_0x5eaee5,mjProxy:_0x50ca3a}=await this[_0x57a4a5(0xb6)](),_0x8c3f70=_0x50ca3a==0x1?_0x57a4a5(0x10c)+_0x3431ab:_0x57a4a5(0xd6)+_0x3431ab+_0x57a4a5(0xc6),_0x445ea3={'authorization':_0x5eaee5},_0x282161=await axios_1[_0x57a4a5(0xac)][_0x57a4a5(0xf9)](_0x8c3f70,{'headers':_0x445ea3});return _0x282161[_0x57a4a5(0x103)];}catch(_0x735d9d){console[_0x57a4a5(0xc0)](_0x57a4a5(0x10e),_0x735d9d);throw new common_1[(_0x57a4a5(0x111))](_0x57a4a5(0x107),common_1['HttpStatus'][_0x57a4a5(0xee)]);}}async['sleep'](_0x2df454){return new Promise(_0x12f21a=>setTimeout(_0x12f21a,_0x2df454));}['extractContent'](_0x2e421){const _0x4d5269=_0x56d761,_0x1dfe56=_0x2e421['match'](/\*\*(.+?)\*\*/),_0x101030=_0x2e421[_0x4d5269(0x10f)](/- Image #(\d+)/);if(!_0x1dfe56||!_0x101030)return null;const _0x9dc535=_0x1dfe56[0x1],_0xa652e8=parseInt(_0x101030[0x1]);return{'prompt':_0x9dc535,'order':_0xa652e8};}async[_0x56d761(0xb6)](){const _0x2261e1=_0x56d761,_0x1d9799=await this[_0x2261e1(0xbc)][_0x2261e1(0x9b)]([_0x2261e1(0x10a),'mjApplicationId',_0x2261e1(0x88),_0x2261e1(0x6c),'mjSessionId','mjVersion','mjAuthorization',_0x2261e1(0x97),_0x2261e1(0xe2)]),_0xdde10={'application_id':_0x1d9799['mjApplicationId'],'guild_id':_0x1d9799[_0x2261e1(0x88)],'channel_id':_0x1d9799[_0x2261e1(0x6c)],'session_id':_0x1d9799[_0x2261e1(0x75)],'version':_0x1d9799['mjVersion'],'id':_0x1d9799[_0x2261e1(0x10a)],'authorization':_0x1d9799['mjAuthorization'],'mjRateLimit':_0x1d9799[_0x2261e1(0x97)],'mjProxy':_0x1d9799[_0x2261e1(0xe2)]||0x0};return _0xdde10;}[_0x56d761(0x109)](_0x1f699f){const _0x1e5fb3=_0x56d761,_0x460127=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x1f699f[_0x1e5fb3(0xb7)](_0x460127,'');}async[_0x56d761(0xcf)](_0x120106){const _0x5d48ba=_0x56d761,_0x28fa7d=await this[_0x5d48ba(0x77)]['findOne']({'where':{'userId':_0x120106[_0x5d48ba(0x8b)]['id']}}),{id:_0x1bb37e,balance:_0x13296e}=_0x28fa7d;if(!_0x13296e||(_0x28fa7d===null||_0x28fa7d===void 0x0?void 0x0:_0x28fa7d[_0x5d48ba(0x99)])<0x1)throw new common_1[(_0x5d48ba(0x111))](_0x5d48ba(0x115),common_1['HttpStatus'][_0x5d48ba(0xee)]);}async[_0x56d761(0xda)](_0x1ae835){const _0x4eb25c=_0x56d761,{id:_0x8c623d,role:_0x11bc99}=_0x1ae835['user'];!this[_0x4eb25c(0xd0)][_0x8c623d]?this[_0x4eb25c(0xd0)][_0x8c623d]=0x1:this['freeQueueUsers'][_0x8c623d]=this[_0x4eb25c(0xd0)][_0x8c623d]+0x1,console[_0x4eb25c(0xc0)](_0x4eb25c(0xfe)+_0x8c623d+_0x4eb25c(0x94),this[_0x4eb25c(0xd0)][_0x8c623d]);}async[_0x56d761(0xf4)](_0x258124){const _0x927c8c=_0x56d761,{id:_0x131e75,role:_0x1150e7}=_0x258124['user'];if(['admin','super'][_0x927c8c(0xb3)](_0x1150e7))return!![];const {mjRateLimit:_0x580c23}=await this[_0x927c8c(0xb6)]();if(this[_0x927c8c(0x73)][_0x131e75]){const _0x5850c0=this[_0x927c8c(0x73)][_0x131e75];if(_0x5850c0>Date['now']()){console[_0x927c8c(0xc0)](_0x927c8c(0x106)+_0x131e75+'\x20请求过于频繁！');throw new common_1['HttpException'](_0x927c8c(0xc1)+_0x580c23+'秒请求一次、请合理使用！',common_1[_0x927c8c(0xbf)][_0x927c8c(0xee)]);}else this['rateLimits'][_0x131e75]=Date[_0x927c8c(0x117)]()+Number(_0x580c23)*0x3e8;}else{const _0x4468a3=Date['now']();this[_0x927c8c(0x73)][_0x131e75]=_0x4468a3+0x3e8*Number(_0x580c23);}}async[_0x56d761(0xf3)](_0x548093){const _0x1f4fdc=_0x56d761;await this[_0x1f4fdc(0x77)][_0x1f4fdc(0x93)]()[_0x1f4fdc(0xf1)](balance_entity_1[_0x1f4fdc(0xb8)])[_0x1f4fdc(0xab)]({'balance':()=>_0x1f4fdc(0xa6)})[_0x1f4fdc(0xea)](_0x1f4fdc(0x6e),{'userId':_0x548093[_0x1f4fdc(0x8b)]['id']})[_0x1f4fdc(0xc3)]();}async[_0x56d761(0x85)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x56d761(0xca)])(),__param(0x0,(0x0,typeorm_2[_0x56d761(0xc8)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(balance_entity_1[_0x56d761(0xb8)])),__metadata(_0x56d761(0xdb),[typeorm_1[_0x56d761(0xbb)],typeorm_1[_0x56d761(0xbb)],upload_service_1[_0x56d761(0x9e)],chatLog_service_1[_0x56d761(0xcb)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x56d761(0xe1)],badwords_service_1[_0x56d761(0xf8)]])],MjService),exports['MjService']=MjService;function _0x28a3(){const _0x107b8c=['max','findCurrentEnlargeImgResult','test','randomId:\x20','绘制图片任务异常中断\x20队列-1:\x20','mjGuildId','sendSmInteractions','findCurrentPromptResult','user','5099550KDADga','pollForResult','放大当前图片失败','绘画超时，请稍后再试！','post','pollForVariationResult','map','createQueryBuilder','使用的次数：','decorate','拿到了远程地址:\x20','mjRateLimit','queryMessageList','balance','Like','getConfigs','发送放大指令成功','Not','UploadService','floor','find','放大单张图片请求失败...','16aVDlsj','PAINT_TYPE','__metadata','upscaleSingleImg','balance\x20-\x201','fanyiService','https://discord.com/api/v9/interactions','error','getClientIp','set','default','parse','@nestjs/common','chatLogEntity','\x20次开始查询[变换图片]','function','filter','includes','../chatLog/chatLog.service','uploadService','getMjDefaultParams','replace','BalanceEntity','orderId','metadata','Repository','globalConfigService','绘制图片任务结束\x20队列-1:\x20','variationSingleImg','HttpStatus','log','由于速率限制、当前普通用户限制为','drawWorking','execute','当前图片没有绘画信息、无法放大!','当前图片没有绘画信息、无法变体!','/messages?limit=50','381537SJbkBx','InjectRepository','../globalConfig/globalConfig.service','Injectable','ChatLogService','convertToEnglish','放大图片任务结束\x20队列-1:\x20','extractContent','checkAuth','freeQueueUsers','../chatLog/chatLog.entity','findOne','mjservice','__esModule','开始查询绘画结果轮询','https://discord.com/api/v9/channels/','存入图片完成:\x20','pollForUpscaleResult','历史中存在当前图片、直接获取！','checkFree','design:paramtypes','231700wKckMd','axios:\x20','prompt','length','uploadFileFromUrl','FanyiService','mjProxy','开始请求用户','imagine','6zcpyop','enlargeWorking','message','substring','52PwJUdx','where','enlarge','badwordsService','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','BAD_REQUEST','绘画任务开始','createRandomUid','update','baiduFanyiAppId','deductBalance','checkRateLimit','__decorate','历史这些id已经被获取过了\x20不能拿了:\x20','http://172.247.48.137:8000/mj/draw','BadwordsService','get','放大custom_id:\x20','../badwords/badwords.service','variationId','axios','当前用户','checkBadWords','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','draw','queueCount','data','object','变化图片任务异常中断\x20队列-1:\x20','当前用户\x20','查询绘制结果失败...','变换当前图片超时！','removeEmoji','mjId','findCurrentVariationImgResult','http://172.247.48.137:8000/mj/list?channel_id=','sleep','axios\x20get:\x20','match','chatLogService','HttpException','sendDrawInteractions','../userBalance/balance.entity','\x20队列+1:\x20','您当前暂无MJ绘画余额！！！','1286505aGQqBz','now','components','DeductionKey','mjDraw','defineProperty','response','url','mjChannelId','__param','userId\x20=\x20:userId','typeorm','MjService','本次放大图片的id:\x20','245028UjUouN','rateLimits','stringify','mjSessionId','saveChatLog','balanceEntity','160551ynzESH','绘画失败','变换当前图片失败','../upload/upload.service','getOwnPropertyDescriptor','查询期间出现错误：','9098jBiAZV','本次比对的随机ID:\x20','../fanyi/fanyi.service','mjNotSaveImg','error:\x20'];_0x28a3=function(){return _0x107b8c;};return _0x28a3();}