'use strict';const _0x2f019f=_0x2538;function _0x48b3(){const _0x420728=['uploadService','message_id','pollForUpscaleResult','BalanceEntity','/messages?limit=50','存入图片完成:\x20','findCurrentVariationImgResult','metadata','test','uploadFileFromUrl','本次放大图片的id:\x20','使用的次数：','绘画失败','sendDrawInteractions','当前用户\x20','Like','function','enlargeWorking','开始轮询单张变换图片结果','放大图片任务异常中断\x20队列-1:\x20','randomId:\x20','error:\x20','map','saveChatLog','绘制图片任务结束\x20队列-1:\x20','变化图片任务异常中断\x20队列-1:\x20','绘画任务开始','baiduFanyiAppId','response','../fanyi/fanyi.service','mjGuildId','117564qPtigi','prompt','@nestjs/common','MjService','checkRateLimit','balance','typeorm','log','variationSingleImg','开始查询绘画结果轮询','replace','PAINT_TYPE','queryMessageList','mjId','balanceEntity','queueCount','message','deductBalance','defineProperty','push','globalConfigService','../globalConfig/globalConfig.service','checkFree','您当前暂无MJ绘画余额！！！','mjProxy','HttpStatus','chatLogEntity','url','variationId','开始请求放大图片\x20队列+1:\x20','HttpException','mjAuthorization','admin','发送绘画指令结果:\x20','当前提示词已经在任务队列中了、请勿重复提交。。。','变换当前图片超时！','88786AzrGVa','object','stringify','createQueryBuilder','sleep','default','\x20次开始查询[变换图片]','update','BAD_REQUEST','axios:\x20','post','execute','rateLimits','有历史信息之间返回:\x20','7TYyyzJ','本次比对的随机ID:\x20','substring','removeEmoji','599570eQLUwb','__param','badwordsService','mjRateLimit','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','34962qsbaET','axios\x20get:\x20','INTERNAL_SERVER_ERROR','InjectRepository','18cKpkiD','getMjDefaultParams','DeductionKey','GlobalConfigService','length','放大当前图片失败','UploadService','当前图片已经放大过了、请勿重复放大!','mjNotSaveImg','prompt\x20-------->\x20\x20','balance\x20-\x201','chatLogService','__esModule','now','放大custom_id:\x20','1587128VQztGV','decorate','秒请求一次、请合理使用！','getClientIp','mjChannelId','enlarge','max','set','extractContent','sendSmInteractions','checkAuth','变换图片任务结束\x20队列-1:\x20','upscaleSingleImg','where','历史中存在当前图片、直接获取！','FanyiService','http://172.247.48.137:8000/mj/draw','10MNkNja','mjservice','mjDraw','1102974xQXICL','findCurrentPromptResult','user','draw','../chatLog/chatLog.entity','findOne','查询期间出现错误：','mjSessionId','includes','find','绘制图片任务异常中断\x20队列-1:\x20','freeQueueUsers','getConfigs','data','../../common/constants/balance.constant','4700muRnXi','pollForVariationResult','绘画超时，请稍后再试！','209FRXgXz','filter','mjVersion','__decorate','由于速率限制、当前普通用户限制为','mjApplicationId','Injectable','fanyiService','https://discord.com/api/v9/interactions','findCurrentEnlargeImgResult','当前用户','绘图指令完成','放大单张图片请求失败...','design:paramtypes','drawWorking','21GTqtKR','__metadata','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','error','orderId','http://172.247.48.137:8000/mj/list?channel_id=','IsNull','match','发送放大指令成功'];_0x48b3=function(){return _0x420728;};return _0x48b3();}(function(_0x56b650,_0xb7b916){const _0x4f2534=_0x2538,_0x424e94=_0x56b650();while(!![]){try{const _0x51bfa3=-parseInt(_0x4f2534(0x179))/0x1+-parseInt(_0x4f2534(0x190))/0x2*(-parseInt(_0x4f2534(0x1d8))/0x3)+-parseInt(_0x4f2534(0x1c6))/0x4*(parseInt(_0x4f2534(0x1b4))/0x5)+parseInt(_0x4f2534(0x1b7))/0x6+parseInt(_0x4f2534(0x187))/0x7*(parseInt(_0x4f2534(0x1a3))/0x8)+-parseInt(_0x4f2534(0x194))/0x9*(parseInt(_0x4f2534(0x18b))/0xa)+parseInt(_0x4f2534(0x1c9))/0xb*(-parseInt(_0x4f2534(0x155))/0xc);if(_0x51bfa3===_0xb7b916)break;else _0x424e94['push'](_0x424e94['shift']());}catch(_0xc21d2e){_0x424e94['push'](_0x424e94['shift']());}}}(_0x48b3,0x1a382));var __decorate=this&&this[_0x2f019f(0x1cc)]||function(_0x237db7,_0x256cab,_0x2ca27e,_0x19c394){const _0x4b396c=_0x2f019f;var _0x536e41=arguments['length'],_0x193101=_0x536e41<0x3?_0x256cab:_0x19c394===null?_0x19c394=Object['getOwnPropertyDescriptor'](_0x256cab,_0x2ca27e):_0x19c394,_0x274441;if(typeof Reflect===_0x4b396c(0x17a)&&typeof Reflect[_0x4b396c(0x1a4)]===_0x4b396c(0x1f1))_0x193101=Reflect[_0x4b396c(0x1a4)](_0x237db7,_0x256cab,_0x2ca27e,_0x19c394);else{for(var _0x1c3722=_0x237db7[_0x4b396c(0x198)]-0x1;_0x1c3722>=0x0;_0x1c3722--)if(_0x274441=_0x237db7[_0x1c3722])_0x193101=(_0x536e41<0x3?_0x274441(_0x193101):_0x536e41>0x3?_0x274441(_0x256cab,_0x2ca27e,_0x193101):_0x274441(_0x256cab,_0x2ca27e))||_0x193101;}return _0x536e41>0x3&&_0x193101&&Object[_0x4b396c(0x167)](_0x256cab,_0x2ca27e,_0x193101),_0x193101;},__metadata=this&&this[_0x2f019f(0x1d9)]||function(_0x1a422a,_0x4b877d){const _0x415e81=_0x2f019f;if(typeof Reflect===_0x415e81(0x17a)&&typeof Reflect[_0x415e81(0x1e8)]===_0x415e81(0x1f1))return Reflect[_0x415e81(0x1e8)](_0x1a422a,_0x4b877d);},__param=this&&this[_0x2f019f(0x18c)]||function(_0x1597b3,_0xbd4566){return function(_0xd8d2f4,_0x1cf972){_0xbd4566(_0xd8d2f4,_0x1cf972,_0x1597b3);};};Object[_0x2f019f(0x167)](exports,_0x2f019f(0x1a0),{'value':!![]}),exports[_0x2f019f(0x158)]=void 0x0;const globalConfig_service_1=require(_0x2f019f(0x16a)),upload_service_1=require('../upload/upload.service'),common_1=require(_0x2f019f(0x157)),axios_1=require('axios'),chatLog_service_1=require('../chatLog/chatLog.service'),balance_constant_1=require(_0x2f019f(0x1c5)),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x2f019f(0x1bb)),typeorm_1=require(_0x2f019f(0x15b)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x2f019f(0x153)),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x4848f4,_0x132623,_0x18caec,_0x51aac1,_0x4646f1,_0x23b330,_0x5dce5e){const _0x38fd5a=_0x2f019f;this[_0x38fd5a(0x16f)]=_0x4848f4,this[_0x38fd5a(0x163)]=_0x132623,this['uploadService']=_0x18caec,this[_0x38fd5a(0x19f)]=_0x51aac1,this[_0x38fd5a(0x169)]=_0x4646f1,this[_0x38fd5a(0x1d0)]=_0x23b330,this['badwordsService']=_0x5dce5e,this[_0x38fd5a(0x185)]={},this[_0x38fd5a(0x1d7)]=[],this[_0x38fd5a(0x1f2)]=[],this[_0x38fd5a(0x164)]=0x0,this[_0x38fd5a(0x1c2)]={};}async[_0x2f019f(0x1b6)](_0x38ec34){const _0x128f7e=_0x2f019f,{jobId:_0x34a140,prompt:_0x4e9522,startTime:_0x3557b6,userId:_0x5f2c68}=_0x38ec34;return console[_0x128f7e(0x15c)](_0x128f7e(0x150),_0x128f7e(0x1b5)),await new Promise(_0x283ab4=>setTimeout(_0x283ab4,0x1388)),{'a':0x1,'b':0x2};}async[_0x2f019f(0x1ba)](_0x24aa0b,_0x3982fc){const _0x8af285=_0x2f019f;await this['checkAuth'](_0x3982fc),await this[_0x8af285(0x18d)]['checkBadWords'](_0x24aa0b[_0x8af285(0x156)],_0x3982fc[_0x8af285(0x1b9)]['id']);const _0x4520cf=_0x24aa0b[_0x8af285(0x156)];let _0x4b686e=_0x24aa0b[_0x8af285(0x156)];const {baiduFanyiAppId:_0x1ff175,baiduFanyiSecret:_0x53ef35}=await this['globalConfigService'][_0x8af285(0x1c3)]([_0x8af285(0x151),'baiduFanyiSecret']);_0x1ff175&&_0x53ef35&&(_0x4b686e=await this[_0x8af285(0x1d0)]['convertToEnglish'](_0x4520cf));const _0x15bd93='['+(0x0,utils_1['createRandomUid'])()+']',_0x78cedf=_0x15bd93+'\x20'+_0x4b686e;console[_0x8af285(0x15c)](_0x8af285(0x1f5),_0x15bd93),console[_0x8af285(0x15c)](_0x8af285(0x19d),_0x78cedf);const _0x7cc76b=this[_0x8af285(0x1d7)]['find'](_0x16c18b=>_0x16c18b[_0x8af285(0x1bf)](_0x24aa0b[_0x8af285(0x156)]));if(_0x7cc76b)throw new common_1['HttpException'](_0x8af285(0x177),common_1['HttpStatus'][_0x8af285(0x181)]);if(this[_0x8af285(0x164)]>=0x3)throw new common_1[(_0x8af285(0x173))](_0x8af285(0x1da),common_1[_0x8af285(0x16e)]['BAD_REQUEST']);await this[_0x8af285(0x159)](_0x3982fc),this['queueCount']++,console[_0x8af285(0x15c)]('开始请求用户'+_0x3982fc[_0x8af285(0x1b9)]['id']+'\x20队列+1:\x20',this[_0x8af285(0x164)]);try{const _0x22a3a2=await this[_0x8af285(0x16f)][_0x8af285(0x1c0)]({'where':{'prompt':(0x0,typeorm_1[_0x8af285(0x1f0)])('%'+_0x78cedf+'%')}}),_0x149e7b=_0x22a3a2[_0x8af285(0x1f7)](_0x4a2ef3=>_0x4a2ef3[_0x8af285(0x1e2)]);this[_0x8af285(0x1d7)][_0x8af285(0x168)](_0x78cedf);let _0x1d7d59;const _0x20d37a=await this[_0x8af285(0x1ee)](_0x78cedf,_0x149e7b,_0x15bd93);_0x20d37a?(console[_0x8af285(0x15c)](_0x8af285(0x1b1)),_0x1d7d59=_0x20d37a):_0x1d7d59=await this['pollForResult'](_0x78cedf,_0x149e7b,_0x15bd93);this[_0x8af285(0x164)]--,this[_0x8af285(0x164)]<0x0&&(this[_0x8af285(0x164)]=0x0),console[_0x8af285(0x15c)](_0x8af285(0x1f9),this[_0x8af285(0x164)]);const {id:_0x14811c,content:_0x54de85,channel_id:_0x487b95,attachments:attachments=[],timestamp:_0x23061f}=_0x1d7d59;if(!attachments[_0x8af285(0x198)]||!attachments[0x0][_0x8af285(0x170)])throw new common_1[(_0x8af285(0x173))](_0x8af285(0x1ed),common_1[_0x8af285(0x16e)][_0x8af285(0x181)]);const {filename:_0xec3c50,url:_0xd32724,width:_0x27dba5,height:_0x409be9,size:_0x3e237a}=attachments[0x0];console[_0x8af285(0x15c)]('拿到了远程地址:\x20',_0xd32724);const _0x351c8e=this[_0x8af285(0x169)][_0x8af285(0x1c3)]([_0x8af285(0x19c)]);let _0x415eaa='';(!Number(_0x351c8e)||Number(_0x351c8e)===0x0)&&(_0x415eaa=await this[_0x8af285(0x1e1)]['uploadFileFromUrl']({'filename':_0xec3c50,'url':_0xd32724}),console[_0x8af285(0x15c)](_0x8af285(0x1e6),_0x415eaa));const _0x309510={'curIp':(0x0,utils_1[_0x8af285(0x1a6)])(_0x3982fc),'userId':_0x3982fc[_0x8af285(0x1b9)]['id'],'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':_0x78cedf,'answer':_0x415eaa,'model':'mj','extend':this['removeEmoji'](JSON[_0x8af285(0x17b)](_0x1d7d59)),'message_id':_0x14811c,'variationId':_0x14811c,'upscaleId':_0x14811c,'group':0x1,'isSaveImg':!Number(_0x351c8e)||Number(_0x351c8e)===0x0,'fileInfo':JSON[_0x8af285(0x17b)]({'width':_0x27dba5,'height':_0x409be9,'size':_0x3e237a,'filename':_0xec3c50,'cosUrl':_0x415eaa})};return await this[_0x8af285(0x19f)][_0x8af285(0x1f8)](_0x309510),await this['deductBalance'](_0x3982fc),this['drawWorking']=this[_0x8af285(0x1d7)]['filter'](_0x3fb095=>_0x3fb095!==_0x24aa0b['prompt']),_0x415eaa;}catch(_0x2a33e8){this[_0x8af285(0x164)]--,this[_0x8af285(0x164)]<0x0&&(this[_0x8af285(0x164)]=0x0),console[_0x8af285(0x15c)](_0x8af285(0x1c1),this['queueCount']),this['drawWorking']=this[_0x8af285(0x1d7)][_0x8af285(0x1ca)](_0x433b6f=>_0x433b6f!==_0x24aa0b[_0x8af285(0x156)]);throw new common_1[(_0x8af285(0x173))](_0x2a33e8[_0x8af285(0x152)],common_1['HttpStatus'][_0x8af285(0x181)]);}}async[_0x2f019f(0x1af)](_0x1c8c40,_0x1dc280){const _0x2da09f=_0x2f019f;if(this['queueCount']>=0x3)throw new common_1[(_0x2da09f(0x173))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x2da09f(0x16e)][_0x2da09f(0x181)]);this[_0x2da09f(0x164)]++,console[_0x2da09f(0x15c)]('用户'+_0x1dc280[_0x2da09f(0x1b9)]['id']+_0x2da09f(0x172),this[_0x2da09f(0x164)]);const {message_id:_0x5b774d,orderId:_0x4fc669}=_0x1c8c40;try{const _0x448416=await this[_0x2da09f(0x16f)][_0x2da09f(0x1bc)]({'where':{'message_id':_0x5b774d}});if(!_0x448416)throw new common_1['HttpException']('历史记录中不存在当前图片、请确认您放大的图片是否存在',common_1[_0x2da09f(0x16e)][_0x2da09f(0x181)]);const _0x1cb1ff=await this['chatLogEntity'][_0x2da09f(0x1bc)]({'where':{'upscaleId':_0x5b774d,'action':_0x2da09f(0x1a8),'orderId':_0x4fc669}});if(_0x1cb1ff)throw new common_1['HttpException'](_0x2da09f(0x19b),common_1[_0x2da09f(0x16e)][_0x2da09f(0x181)]);const {prompt:_0x199b1a,extend:_0x331951}=_0x448416;let _0x1e8ce3=null;try{_0x1e8ce3=JSON['parse'](_0x331951);}catch(_0x1705bb){_0x1e8ce3=[];}const {components:components=[]}=_0x1e8ce3;if(!components[_0x2da09f(0x198)])throw new common_1[(_0x2da09f(0x173))]('当前图片没有绘画信息、无法放大!',common_1[_0x2da09f(0x16e)]['BAD_REQUEST']);const _0x57b696=components[0x0]['components'][_0x4fc669-0x1],{custom_id:_0x5a4a67}=_0x57b696;console[_0x2da09f(0x15c)](_0x2da09f(0x1a2),_0x5a4a67);const _0x3abbb7={'message_id':_0x5b774d,'custom_id':_0x5a4a67,'prompt':_0x199b1a,'orderId':_0x4fc669};await this[_0x2da09f(0x1ac)](_0x3abbb7),console[_0x2da09f(0x15c)](_0x2da09f(0x1e0));const _0x64b3c0=await this[_0x2da09f(0x16f)]['find']({'where':{'prompt':(0x0,typeorm_1[_0x2da09f(0x1f0)])('%'+_0x199b1a+'%')}}),_0x15c9ef=_0x64b3c0[_0x2da09f(0x1f7)](_0x40dc8a=>_0x40dc8a['message_id']);console[_0x2da09f(0x15c)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0x15c9ef);const _0x5eca41=await this[_0x2da09f(0x1e3)](_0x3abbb7,_0x15c9ef);this['queueCount']--,this[_0x2da09f(0x164)]<0x0&&(this['queueCount']=0x0),console[_0x2da09f(0x15c)]('放大图片任务结束\x20队列-1:\x20',this[_0x2da09f(0x164)]);const {id:_0x10125f,content:_0x4c3721,channel_id:_0x1fd1b5,attachments:attachments=[],timestamp:_0x774e69}=_0x5eca41;if(!attachments['length']||!attachments[0x0][_0x2da09f(0x170)])throw new common_1[(_0x2da09f(0x173))](_0x2da09f(0x199),common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0x12e26a,url:_0xf84b0b,width:_0x456e2d,height:_0x371e32,size:_0x383054}=attachments[0x0],_0x2f28e7=this['globalConfigService'][_0x2da09f(0x1c3)]([_0x2da09f(0x19c)]);let _0xd3704='';(!Number(_0x2f28e7)||Number(_0x2f28e7)===0x0)&&(_0xd3704=await this['uploadService']['uploadFileFromUrl']({'filename':_0x12e26a,'url':_0xf84b0b}),console[_0x2da09f(0x15c)](_0x2da09f(0x1e6),_0xd3704));const _0x424f70={'curIp':(0x0,utils_1['getClientIp'])(_0x1dc280),'userId':_0x1dc280[_0x2da09f(0x1b9)]['id'],'type':balance_constant_1[_0x2da09f(0x196)][_0x2da09f(0x160)],'prompt':_0x199b1a,'answer':_0xd3704,'model':'mj','extend':this[_0x2da09f(0x18a)](JSON['stringify'](_0x5eca41)),'message_id':_0x5b774d,'upscaleId':_0x10125f,'variationId':_0x10125f,'action':_0x2da09f(0x1a8),'orderId':_0x3abbb7['orderId'],'isSaveImg':!Number(_0x2f28e7)||Number(_0x2f28e7)===0x0,'fileInfo':JSON['stringify']({'width':_0x456e2d,'height':_0x371e32,'size':_0x383054,'filename':_0x12e26a,'cosUrl':_0xd3704})};return await this['chatLogService']['saveChatLog'](_0x424f70),_0xd3704;}catch(_0x57e635){console[_0x2da09f(0x15c)](_0x2da09f(0x1f6),_0x57e635),this[_0x2da09f(0x164)]--,this[_0x2da09f(0x164)]<0x0&&(this['queueCount']=0x0),console['log'](_0x2da09f(0x1f4),this['queueCount']);throw new common_1['HttpException'](_0x57e635['response'],common_1[_0x2da09f(0x16e)][_0x2da09f(0x181)]);}}async[_0x2f019f(0x15d)](_0xfd9543,_0x4e755c){const _0x3a7e23=_0x2f019f;if(this[_0x3a7e23(0x164)]>=0x3)throw new common_1[(_0x3a7e23(0x173))](_0x3a7e23(0x1da),common_1[_0x3a7e23(0x16e)][_0x3a7e23(0x181)]);await this[_0x3a7e23(0x1ad)](_0x4e755c),await this[_0x3a7e23(0x159)](_0x4e755c),this[_0x3a7e23(0x164)]++,console[_0x3a7e23(0x15c)]('用户'+_0x4e755c[_0x3a7e23(0x1b9)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x3a7e23(0x164)]);const {message_id:_0x68e7e6,orderId:_0x27176d}=_0xfd9543;try{const _0x1da3a5=await this[_0x3a7e23(0x16f)][_0x3a7e23(0x1bc)]({'where':{'message_id':_0x68e7e6}});if(!_0x1da3a5)throw new common_1[(_0x3a7e23(0x173))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1[_0x3a7e23(0x16e)][_0x3a7e23(0x181)]);const {prompt:_0x2ccbec,extend:_0x338596}=_0x1da3a5;let _0x58ecdc=null;try{_0x58ecdc=JSON['parse'](_0x338596);}catch(_0xc433b4){_0x58ecdc=[];}const {components:components=[]}=_0x58ecdc;if(!components[_0x3a7e23(0x198)])throw new common_1[(_0x3a7e23(0x173))]('当前图片没有绘画信息、无法变体!',common_1[_0x3a7e23(0x16e)][_0x3a7e23(0x181)]);const _0x3b7861=components[0x1]['components'][_0x27176d-0x1],{custom_id:_0xffa51f}=_0x3b7861,_0x42cbd0=await this[_0x3a7e23(0x16f)][_0x3a7e23(0x1c0)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x3a7e23(0x1de)])()),'prompt':(0x0,typeorm_1[_0x3a7e23(0x1f0)])('%'+_0x2ccbec+'%')}}),_0x3db390=_0x42cbd0['map'](_0x48444f=>_0x48444f[_0x3a7e23(0x171)]),_0x18b418={'message_id':_0x68e7e6,'custom_id':_0xffa51f,'prompt':_0x2ccbec,'orderId':_0x27176d};await this['sendSmInteractions'](_0x18b418);const _0x11b734=await this[_0x3a7e23(0x1c7)](_0x18b418,_0x3db390);this['queueCount']--,this[_0x3a7e23(0x164)]<0x0&&(this[_0x3a7e23(0x164)]=0x0),console[_0x3a7e23(0x15c)](_0x3a7e23(0x1ae),this['queueCount']);const {id:_0x11ed73,content:_0x93c9fa,channel_id:_0x290be5,attachments:attachments=[],timestamp:_0x27004d}=_0x11b734;if(!attachments['length']||!attachments[0x0][_0x3a7e23(0x170)])throw new common_1[(_0x3a7e23(0x173))]('变换当前图片失败',common_1['HttpStatus'][_0x3a7e23(0x181)]);const {filename:_0x413d13,url:_0x3822ce,width:_0x4f3352,height:_0x1813c9,size:_0x103f1e}=attachments[0x0],_0x1fa728=this[_0x3a7e23(0x169)][_0x3a7e23(0x1c3)]([_0x3a7e23(0x19c)]);let _0x30e2da='';(!Number(_0x1fa728)||Number(_0x1fa728)===0x0)&&(_0x30e2da=await this[_0x3a7e23(0x1e1)][_0x3a7e23(0x1ea)]({'filename':_0x413d13,'url':_0x3822ce}),console[_0x3a7e23(0x15c)](_0x3a7e23(0x1e6),_0x30e2da));const _0x4632e9={'curIp':(0x0,utils_1['getClientIp'])(_0x4e755c),'userId':_0x4e755c['user']['id'],'type':balance_constant_1[_0x3a7e23(0x196)][_0x3a7e23(0x160)],'prompt':_0x2ccbec,'answer':_0x30e2da,'model':'mj','group':0x1,'extend':this['removeEmoji'](JSON[_0x3a7e23(0x17b)](_0x11b734)),'message_id':_0x11ed73,'upscaleId':_0x11ed73,'variationId':_0x11ed73,'action':_0x3a7e23(0x1a8),'orderId':_0x18b418[_0x3a7e23(0x1dc)],'isSaveImg':!Number(_0x1fa728)||Number(_0x1fa728)===0x0,'fileInfo':JSON[_0x3a7e23(0x17b)]({'width':_0x4f3352,'height':_0x1813c9,'size':_0x103f1e,'filename':_0x413d13,'cosUrl':_0x30e2da})};return await this['chatLogService'][_0x3a7e23(0x1f8)](_0x4632e9),_0x30e2da;}catch(_0x5e9ec6){console['log'](_0x3a7e23(0x1f6),_0x5e9ec6),this[_0x3a7e23(0x164)]--,this[_0x3a7e23(0x164)]<0x0&&(this['queueCount']=0x0),console[_0x3a7e23(0x15c)](_0x3a7e23(0x14f),this[_0x3a7e23(0x164)]);throw new common_1['HttpException'](_0x5e9ec6[_0x3a7e23(0x152)],common_1['HttpStatus'][_0x3a7e23(0x181)]);}}async['sendSmInteractions'](_0x3e2309){const _0xce6a1d=_0x2f019f,{message_id:_0x298326,custom_id:_0x38135f}=_0x3e2309,{application_id:_0x56f2b9,guild_id:_0x5720e8,channel_id:_0x488f46,session_id:_0x44b53e,version:_0x10e00f,id:_0x18abdc,authorization:_0x192c9c,mjProxy:_0x1a6ce9}=await this['getMjDefaultParams'](),_0x3af75a=_0x1a6ce9==0x1?_0xce6a1d(0x1b3):_0xce6a1d(0x1d1),_0x3ea214={'authorization':_0x192c9c},_0x135c2c={'type':0x3,'guild_id':_0x5720e8,'channel_id':_0x488f46,'message_flags':0x0,'message_id':_0x298326,'application_id':_0x56f2b9,'session_id':_0x44b53e,'data':{'component_type':0x2,'custom_id':_0x38135f}};try{await axios_1[_0xce6a1d(0x17e)][_0xce6a1d(0x183)](_0x3af75a,_0x135c2c,{'headers':_0x3ea214}),console[_0xce6a1d(0x15c)](_0xce6a1d(0x1d4));}catch(_0xa3e8a){console['log'](_0xce6a1d(0x1f6),_0xa3e8a);throw new common_1['HttpException'](_0xce6a1d(0x1d5),common_1[_0xce6a1d(0x16e)][_0xce6a1d(0x181)]);}}async[_0x2f019f(0x1e3)](_0x4d000c,_0x39fd50){const _0x5a60c5=_0x2f019f,{message_id:_0x4fc549,custom_id:_0xac0cd1,prompt:_0x402e62,orderId:_0x375306}=_0x4d000c;let _0x6ed6ae=null,_0xb1f9ec=0x0;while(!_0x6ed6ae&&_0xb1f9ec<0xa){try{const _0x2bbdac=Date['now'](),_0x185f04=await this[_0x5a60c5(0x161)]();console['log']('第\x20'+(_0xb1f9ec+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x185f04[_0x5a60c5(0x198)]);_0x185f04&&_0x185f04[_0x5a60c5(0x198)]&&(_0x6ed6ae=await this[_0x5a60c5(0x1d2)](_0x185f04,_0x4d000c,_0x39fd50));const _0x2670bc=Date['now']()-_0x2bbdac,_0x2cfc5f=0xbb8;await this['sleep'](Math[_0x5a60c5(0x1a9)](_0x2cfc5f-_0x2670bc,0x0)),_0xb1f9ec++;}catch(_0x2c6c17){console['error']('查询期间出现错误：'+_0x2c6c17['message']);}}return _0x6ed6ae;}async[_0x2f019f(0x1c7)](_0x1bb88e,_0x253ef2){const _0x4dde69=_0x2f019f,{message_id:_0x41ecb8,custom_id:_0x34fffd,prompt:_0x4415fb,orderId:_0x308370}=_0x1bb88e;console[_0x4dde69(0x15c)](_0x4dde69(0x1f3));let _0x29aa56=null,_0x26b1fb=0x0;while(!_0x29aa56&&_0x26b1fb<0xa){try{console[_0x4dde69(0x15c)]('第\x20'+(_0x26b1fb+0x1)+_0x4dde69(0x17f));const _0x1218a7=Date[_0x4dde69(0x1a1)](),_0x7f3338=await this['queryMessageList']();_0x7f3338&&_0x7f3338[_0x4dde69(0x198)]&&(_0x29aa56=await this[_0x4dde69(0x1e7)](_0x7f3338,_0x1bb88e,_0x253ef2));const _0xf40c2b=Date[_0x4dde69(0x1a1)]()-_0x1218a7,_0x1da673=0x1f40;await this['sleep'](Math[_0x4dde69(0x1a9)](_0x1da673-_0xf40c2b,0x0)),_0x26b1fb++;}catch(_0x423fb3){console['error'](_0x4dde69(0x1bd)+_0x423fb3['message']);}}if(!_0x29aa56)throw new common_1[(_0x4dde69(0x173))](_0x4dde69(0x178),common_1[_0x4dde69(0x16e)][_0x4dde69(0x181)]);return _0x29aa56;}async[_0x2f019f(0x1d2)](_0x185aad,_0x11c32e,_0x16c02e){const _0xf89f35=_0x2f019f,{message_id:_0x4ad741,custom_id:_0x461be4,prompt:_0x39f5c3,orderId:_0x32b8ab}=_0x11c32e,_0x197e2c=_0x39f5c3[_0xf89f35(0x189)](0x0,0xc);console[_0xf89f35(0x15c)](_0xf89f35(0x1eb),_0x197e2c);const _0x1857ac=_0x185aad['find'](_0x241648=>{const _0x3dea9b=_0xf89f35,{content:_0x5ca557}=_0x241648;if(!this['extractContent'](_0x5ca557))return![];const {prompt:_0x1b34af,order:_0x226141}=this['extractContent'](_0x5ca557);return _0x1b34af[_0x3dea9b(0x1bf)](_0x197e2c)&&_0x11c32e[_0x3dea9b(0x1dc)]===_0x226141&&!_0x16c02e[_0x3dea9b(0x1bf)](_0x241648['id']);});return _0x1857ac;}async[_0x2f019f(0x1e7)](_0x5ebd99,_0x35c2d6,_0x4e6c09){const _0x48ab0a=_0x2f019f,{message_id:_0x318e3d,custom_id:_0x5a6c41,prompt:_0x449457,orderId:_0x5045e3}=_0x35c2d6,_0x3ec8e9=_0x449457[_0x48ab0a(0x189)](0x0,0xc),_0xbfabb1=_0x5ebd99[_0x48ab0a(0x1c0)](_0x2bd686=>{const _0x49aee8=_0x48ab0a,{content:_0x2300ea}=_0x2bd686,_0x18f041=_0x2300ea[_0x49aee8(0x1df)](/\*\*(.+?)\*\*/),_0x5d28c0=_0x18f041?_0x18f041[0x1]:'';if(!_0x5d28c0)return![];return _0x5d28c0['includes'](_0x3ec8e9)&&!_0x4e6c09['includes'](_0x2bd686['id']);});return _0xbfabb1;}async[_0x2f019f(0x1ee)](_0x5cb5cc,_0x47d23e,_0x53efaa){const _0x17a243=_0x2f019f,_0x420a0f=await this[_0x17a243(0x161)](),_0x4061c2=await this['findCurrentPromptResult'](_0x420a0f,_0x53efaa,_0x47d23e);if(_0x4061c2)return console[_0x17a243(0x15c)](_0x17a243(0x186),_0x4061c2),_0x4061c2;const {application_id:_0x93ee8f,guild_id:_0x3f26c2,channel_id:_0x2abfab,session_id:_0xfc9b0d,version:_0x4b044e,id:_0x519461,authorization:_0x5bdd2f,mjProxy:_0x19b769}=await this[_0x17a243(0x195)](),_0x439cf3={'type':0x2,'application_id':_0x93ee8f,'guild_id':_0x3f26c2,'channel_id':_0x2abfab,'session_id':_0xfc9b0d,'data':{'version':_0x4b044e,'id':_0x519461,'name':'imagine','type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x5cb5cc}],'attachments':[]}};try{const _0x53ff32=_0x19b769==0x1?_0x17a243(0x1b3):_0x17a243(0x1d1),_0x18ce3e={'authorization':_0x5bdd2f},_0x16d98c=await axios_1[_0x17a243(0x17e)][_0x17a243(0x183)](_0x53ff32,_0x439cf3,{'headers':_0x18ce3e});return console[_0x17a243(0x15c)](_0x17a243(0x176),_0x16d98c[_0x17a243(0x1c4)]),![];}catch(_0x57ebd9){console[_0x17a243(0x15c)](_0x17a243(0x182),_0x57ebd9);throw new common_1[(_0x17a243(0x173))](_0x17a243(0x18f),common_1[_0x17a243(0x16e)][_0x17a243(0x181)]);}}async['pollForResult'](_0x157023,_0x2afae7,_0x3fa755){const _0x4e8b6c=_0x2f019f;console[_0x4e8b6c(0x15c)](_0x4e8b6c(0x15e));const _0x49fae4=Date[_0x4e8b6c(0x1a1)]();try{const _0x427cd0=0xd,_0x40cfda=0x2ee0,_0x3eb68e=0x1388,_0x1c69f2=0x3c*0x3e8;let _0x41e601=0x0,_0x270bb4=![],_0x324a7f=null;while(!_0x324a7f&&_0x41e601<_0x427cd0){console[_0x4e8b6c(0x15c)]('第\x20'+(_0x41e601+0x1)+'\x20次开始查询');Date[_0x4e8b6c(0x1a1)]()-_0x49fae4>=_0x1c69f2&&(_0x270bb4=!![]);await this[_0x4e8b6c(0x17d)](_0x270bb4?_0x3eb68e:_0x40cfda);const _0x4770b2=await this[_0x4e8b6c(0x161)]();_0x324a7f=await this[_0x4e8b6c(0x1b8)](_0x4770b2,_0x3fa755,_0x2afae7),_0x41e601++;}if(!_0x324a7f)throw new common_1[(_0x4e8b6c(0x173))](_0x4e8b6c(0x1c8),common_1['HttpStatus'][_0x4e8b6c(0x181)]);const _0x172fe0=Date[_0x4e8b6c(0x1a1)]();return console[_0x4e8b6c(0x15c)]('本次绘图耗时:\x20'+Math['floor']((_0x172fe0-_0x49fae4)/0x3e8)+'\x20S'),_0x324a7f;}catch(_0x3937cc){console[_0x4e8b6c(0x1db)](_0x3937cc[_0x4e8b6c(0x165)]);throw new common_1['HttpException']('网络连接失败，请稍后再试！',common_1[_0x4e8b6c(0x16e)][_0x4e8b6c(0x192)]);}}async['findCurrentPromptResult'](_0xc94c4f,_0xade5c5,_0x1888e1){const _0x3e6bc4=_0x2f019f;if(!_0xc94c4f||!_0xc94c4f[_0x3e6bc4(0x198)])return;console[_0x3e6bc4(0x15c)](_0x3e6bc4(0x188),_0xade5c5);const _0x5581c3=_0xc94c4f[_0x3e6bc4(0x1c0)](_0x446db7=>{const _0x3f344b=_0x3e6bc4,{attachments:attachments=[],content:_0x174663,edited_timestamp:_0x2a6dcb}=_0x446db7;return _0x174663[_0x3f344b(0x1bf)](_0xade5c5)&&attachments[_0x3f344b(0x198)]>0x0&&!_0x2a6dcb&&!_0x1888e1[_0x3f344b(0x1bf)](_0x446db7['id']);});return _0x5581c3||null;}async[_0x2f019f(0x161)](){const _0x30324c=_0x2f019f;try{const {application_id:_0x2c7d9d,guild_id:_0x28d961,channel_id:_0x3ddcf0,session_id:_0x221544,version:_0xa23f6d,id:_0x59be17,authorization:_0x4839d4,mjProxy:_0x28e91b}=await this[_0x30324c(0x195)](),_0x428207=_0x28e91b==0x1?_0x30324c(0x1dd)+_0x3ddcf0:'https://discord.com/api/v9/channels/'+_0x3ddcf0+_0x30324c(0x1e5),_0x1245c1={'authorization':_0x4839d4},_0x547af7=await axios_1[_0x30324c(0x17e)]['get'](_0x428207,{'headers':_0x1245c1});return _0x547af7['data'];}catch(_0x425543){console['log'](_0x30324c(0x191),_0x425543);throw new common_1[(_0x30324c(0x173))]('查询绘制结果失败...',common_1[_0x30324c(0x16e)][_0x30324c(0x181)]);}}async[_0x2f019f(0x17d)](_0x459ac2){return new Promise(_0x315dbb=>setTimeout(_0x315dbb,_0x459ac2));}[_0x2f019f(0x1ab)](_0x44b1fd){const _0x3bfb2a=_0x2f019f,_0x4fd0b8=_0x44b1fd[_0x3bfb2a(0x1df)](/\*\*(.+?)\*\*/),_0x477910=_0x44b1fd[_0x3bfb2a(0x1df)](/- Image #(\d+)/);if(!_0x4fd0b8||!_0x477910)return null;const _0xb26cff=_0x4fd0b8[0x1],_0xda700f=parseInt(_0x477910[0x1]);return{'prompt':_0xb26cff,'order':_0xda700f};}async[_0x2f019f(0x195)](){const _0x5463bd=_0x2f019f,_0x2a4b45=await this[_0x5463bd(0x169)][_0x5463bd(0x1c3)]([_0x5463bd(0x162),_0x5463bd(0x1ce),_0x5463bd(0x154),_0x5463bd(0x1a7),_0x5463bd(0x1be),_0x5463bd(0x1cb),'mjAuthorization',_0x5463bd(0x18e),'mjProxy']),_0x2f8af2={'application_id':_0x2a4b45[_0x5463bd(0x1ce)],'guild_id':_0x2a4b45['mjGuildId'],'channel_id':_0x2a4b45[_0x5463bd(0x1a7)],'session_id':_0x2a4b45[_0x5463bd(0x1be)],'version':_0x2a4b45[_0x5463bd(0x1cb)],'id':_0x2a4b45[_0x5463bd(0x162)],'authorization':_0x2a4b45[_0x5463bd(0x174)],'mjRateLimit':_0x2a4b45['mjRateLimit'],'mjProxy':_0x2a4b45[_0x5463bd(0x16d)]||0x0};return _0x2f8af2;}[_0x2f019f(0x18a)](_0x37bce6){const _0x1961e3=_0x2f019f,_0x4446f3=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x37bce6[_0x1961e3(0x15f)](_0x4446f3,'');}async[_0x2f019f(0x1ad)](_0x293572){const _0x43fb7f=_0x2f019f,_0x5546f2=await this['balanceEntity'][_0x43fb7f(0x1bc)]({'where':{'userId':_0x293572[_0x43fb7f(0x1b9)]['id']}}),{id:_0x2185f6,balance:_0x3e2eaf}=_0x5546f2;if(!_0x3e2eaf||(_0x5546f2===null||_0x5546f2===void 0x0?void 0x0:_0x5546f2[_0x43fb7f(0x15a)])<0x1)throw new common_1['HttpException'](_0x43fb7f(0x16c),common_1['HttpStatus'][_0x43fb7f(0x181)]);}async[_0x2f019f(0x16b)](_0x467602){const _0x17467a=_0x2f019f,{id:_0x3568bf,role:_0xd28221}=_0x467602[_0x17467a(0x1b9)];!this['freeQueueUsers'][_0x3568bf]?this[_0x17467a(0x1c2)][_0x3568bf]=0x1:this[_0x17467a(0x1c2)][_0x3568bf]=this[_0x17467a(0x1c2)][_0x3568bf]+0x1,console[_0x17467a(0x15c)](_0x17467a(0x1d3)+_0x3568bf+_0x17467a(0x1ec),this[_0x17467a(0x1c2)][_0x3568bf]);}async[_0x2f019f(0x159)](_0x8a0269){const _0x48f985=_0x2f019f,{id:_0x2be716,role:_0x13c8da}=_0x8a0269[_0x48f985(0x1b9)];if([_0x48f985(0x175),'super'][_0x48f985(0x1bf)](_0x13c8da))return!![];const {mjRateLimit:_0x55414a}=await this['getMjDefaultParams']();if(this[_0x48f985(0x185)][_0x2be716]){const _0x1b8295=this['rateLimits'][_0x2be716];if(_0x1b8295>Date['now']()){console[_0x48f985(0x15c)](_0x48f985(0x1ef)+_0x2be716+'\x20请求过于频繁！');throw new common_1[(_0x48f985(0x173))](_0x48f985(0x1cd)+_0x55414a+_0x48f985(0x1a5),common_1[_0x48f985(0x16e)]['BAD_REQUEST']);}else this[_0x48f985(0x185)][_0x2be716]=Date[_0x48f985(0x1a1)]()+Number(_0x55414a)*0x3e8;}else{const _0x5c28be=Date[_0x48f985(0x1a1)]();this[_0x48f985(0x185)][_0x2be716]=_0x5c28be+0x3e8*Number(_0x55414a);}}async[_0x2f019f(0x166)](_0x4e6e4f){const _0x3ab22b=_0x2f019f;await this[_0x3ab22b(0x163)][_0x3ab22b(0x17c)]()[_0x3ab22b(0x180)](balance_entity_1[_0x3ab22b(0x1e4)])[_0x3ab22b(0x1aa)]({'balance':()=>_0x3ab22b(0x19e)})[_0x3ab22b(0x1b0)]('userId\x20=\x20:userId',{'userId':_0x4e6e4f[_0x3ab22b(0x1b9)]['id']})[_0x3ab22b(0x184)]();}async[_0x2f019f(0x1e9)](){return 0x1;}};function _0x2538(_0x322fd4,_0x8e5876){const _0x48b307=_0x48b3();return _0x2538=function(_0x2538cc,_0x5255d5){_0x2538cc=_0x2538cc-0x14f;let _0x42ab69=_0x48b307[_0x2538cc];return _0x42ab69;},_0x2538(_0x322fd4,_0x8e5876);}MjService=__decorate([(0x0,common_1[_0x2f019f(0x1cf)])(),__param(0x0,(0x0,typeorm_2[_0x2f019f(0x193)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x2f019f(0x193)])(balance_entity_1['BalanceEntity'])),__metadata(_0x2f019f(0x1d6),[typeorm_1['Repository'],typeorm_1['Repository'],upload_service_1[_0x2f019f(0x19a)],chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x2f019f(0x197)],fanyi_service_1[_0x2f019f(0x1b2)],badwords_service_1['BadwordsService']])],MjService),exports['MjService']=MjService;