'use strict';const _0x397711=_0x2a07;(function(_0x228d5f,_0x561fc7){const _0x120013=_0x2a07,_0x2b3d46=_0x228d5f();while(!![]){try{const _0x100b31=parseInt(_0x120013(0xcc))/0x1*(-parseInt(_0x120013(0xa6))/0x2)+-parseInt(_0x120013(0xb3))/0x3+parseInt(_0x120013(0xa7))/0x4+-parseInt(_0x120013(0xbe))/0x5+parseInt(_0x120013(0xa0))/0x6+parseInt(_0x120013(0xba))/0x7+parseInt(_0x120013(0xc7))/0x8*(parseInt(_0x120013(0xa8))/0x9);if(_0x100b31===_0x561fc7)break;else _0x2b3d46['push'](_0x2b3d46['shift']());}catch(_0x373bde){_0x2b3d46['push'](_0x2b3d46['shift']());}}}(_0x16ce,0x4bb5a));function _0x16ce(){const _0x2826c8=['dall','当前请求已过载、请稍等会儿再试试吧！','message','__esModule','split','图片上传成功，URL:\x20','@dqbd/tiktoken','gpt-4-vision-preview','log','stream','\x20[DONE]','b64_json','detail','axios','choices','data','application/json','110400ollaeS','openai-draw\x20error:\x20','Bearer\x20','content','@nestjs/common','length','478TXCgeK','1638968MUzerv','9elHuva','replace','/v1/images/generations','[DONE]','filter','parse','debug','uuid','getTokenCount','上传图片过程中出现错误:\x20','slice','972819eEIStb','stringify','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','from','finish_reason','response','forEach','1430079FPOwGR','error','endsWith','trim','2253605OXYpXD','.png','encode','Logger','get_encoding','toString','cl100k_base','uploadFile','Billing\x20hard\x20limit\x20has\x20been\x20reached','7451024SXdeXh','绘制图片失败，请稍后试试吧！','text','default','[DONE]\x20','2003FiyNTR','POST','stop','delta','includes','usage','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','MidjourneyService','parse\x20Error','base64'];_0x16ce=function(){return _0x2826c8;};return _0x16ce();}Object['defineProperty'](exports,_0x397711(0xd9),{'value':!![]}),exports['getTokenCount']=exports['sendMessageFromOpenAi']=void 0x0;const axios_1=require(_0x397711(0x9c)),tiktoken_1=require(_0x397711(0xdc)),common_1=require(_0x397711(0xa4)),uuid=require(_0x397711(0xaf)),tokenizer=(0x0,tiktoken_1[_0x397711(0xc2)])(_0x397711(0xc4));function _0x2a07(_0x112548,_0x3bb937){const _0x16ceaa=_0x16ce();return _0x2a07=function(_0x2a0760,_0x25b12e){_0x2a0760=_0x2a0760-0x9b;let _0x2b14d9=_0x16ceaa[_0x2a0760];return _0x2b14d9;},_0x2a07(_0x112548,_0x3bb937);}function getFullUrl(_0x266674){const _0x21c576=_0x397711,_0x391a65=_0x266674[_0x21c576(0xbc)]('/')?_0x266674[_0x21c576(0xb2)](0x0,-0x1):_0x266674,_0x3168c8=_0x391a65||'https://api.openai.com';return _0x3168c8+'/v1/chat/completions';}async function sendMessageFromOpenAi(_0x62f840,_0x2b5234,_0x9efe33){const _0x257ff7=_0x397711;var _0x5af39d,_0x57f147,_0x1d3e0a,_0x3e91a0;const {onProgress:_0x13a56d,maxToken:_0x5b6d05,apiKey:_0x1b6668,model:_0x2f1ab3,temperature:temperature=0.8,proxyUrl:_0x1d1514,prompt:_0x32a810}=_0x2b5234;if(_0x2f1ab3[_0x257ff7(0xd0)](_0x257ff7(0xd6))){let _0x1d6c7b={'text':'','imageUrl':''};try{const _0x4f0d3a={'method':_0x257ff7(0xcd),'url':_0x1d1514+_0x257ff7(0xaa),'headers':{'Content-Type':_0x257ff7(0x9f),'Authorization':_0x257ff7(0xa2)+_0x1b6668},'data':{'prompt':_0x32a810,'model':_0x2f1ab3,'response_format':_0x257ff7(0xe1)}},_0x160148=await(0x0,axios_1[_0x257ff7(0xca)])(_0x4f0d3a),{b64_json:_0x29b3b1,revised_prompt:_0x47bbf4}=_0x160148[_0x257ff7(0x9e)][_0x257ff7(0x9e)][0x0],_0x2b7a8a=Buffer[_0x257ff7(0xb6)](_0x29b3b1,_0x257ff7(0xd5));let _0x354b57='';try{const _0x3087c8=uuid['v4']()['slice'](0x0,0xa)+_0x257ff7(0xbf);common_1[_0x257ff7(0xc1)]['debug']('------>\x20开始上传图片！！！','MidjourneyService');const _0x5dd4b1=Buffer[_0x257ff7(0xb6)](_0x29b3b1,'base64');_0x354b57=await _0x9efe33[_0x257ff7(0xc5)]({'filename':_0x3087c8,'buffer':_0x5dd4b1}),common_1['Logger'][_0x257ff7(0xae)](_0x257ff7(0xdb)+_0x354b57,_0x257ff7(0xd3));}catch(_0x242dc7){common_1['Logger'][_0x257ff7(0xbb)](_0x257ff7(0xb1)+_0x242dc7,_0x257ff7(0xd3));}return _0x1d6c7b['imageUrl']=_0x354b57,_0x1d6c7b[_0x257ff7(0xc9)]=_0x47bbf4,_0x13a56d&&_0x13a56d({'text':_0x1d6c7b[_0x257ff7(0xc9)]}),_0x1d6c7b;}catch(_0x1eab77){const _0x5299cb=((_0x5af39d=_0x1eab77===null||_0x1eab77===void 0x0?void 0x0:_0x1eab77['response'])===null||_0x5af39d===void 0x0?void 0x0:_0x5af39d['status'])||0x1f4;console[_0x257ff7(0xde)](_0x257ff7(0xa1),JSON[_0x257ff7(0xb4)](_0x1eab77),_0x5299cb);const _0x3d3e9e=(_0x3e91a0=(_0x1d3e0a=(_0x57f147=_0x1eab77===null||_0x1eab77===void 0x0?void 0x0:_0x1eab77[_0x257ff7(0xb8)])===null||_0x57f147===void 0x0?void 0x0:_0x57f147['data'])===null||_0x1d3e0a===void 0x0?void 0x0:_0x1d3e0a[_0x257ff7(0xbb)])===null||_0x3e91a0===void 0x0?void 0x0:_0x3e91a0[_0x257ff7(0xd8)];if(_0x5299cb===0x1ad)return _0x1d6c7b[_0x257ff7(0xc9)]=_0x257ff7(0xd7),_0x1d6c7b;if(_0x5299cb===0x190&&_0x3d3e9e[_0x257ff7(0xd0)](_0x257ff7(0xb5)))return _0x1d6c7b['text']=_0x257ff7(0xd2),_0x1d6c7b;if(_0x5299cb===0x190&&_0x3d3e9e[_0x257ff7(0xd0)](_0x257ff7(0xc6)))return _0x1d6c7b[_0x257ff7(0xc9)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0x1d6c7b;if(_0x5299cb===0x1f4)return _0x1d6c7b[_0x257ff7(0xc9)]='绘制图片失败，请检查你的提示词是否有非法描述！',_0x1d6c7b;if(_0x5299cb===0x191)return _0x1d6c7b[_0x257ff7(0xc9)]='绘制图片失败，此次绘画被拒绝了！',_0x1d6c7b;return _0x1d6c7b['text']=_0x257ff7(0xc8),_0x1d6c7b;}}else{let _0x24a719={'text':''};const _0x200ac7={'method':_0x257ff7(0xcd),'url':getFullUrl(_0x1d1514),'responseType':_0x257ff7(0xdf),'headers':{'Content-Type':_0x257ff7(0x9f),'Accept':_0x257ff7(0x9f),'Authorization':_0x257ff7(0xa2)+_0x1b6668},'data':{'stream':!![],'temperature':temperature,'model':_0x2f1ab3,'messages':_0x62f840}};return _0x2f1ab3===_0x257ff7(0xdd)&&(_0x200ac7['data']['max_tokens']=0x800),new Promise(async(_0x893703,_0xaf0f70)=>{const _0xd5700=_0x257ff7;try{const _0x11950b=await(0x0,axios_1['default'])(_0x200ac7),_0x334132=_0x11950b[_0xd5700(0x9e)];_0x334132['on'](_0xd5700(0x9e),_0x585aba=>{const _0x4a8769=_0xd5700;var _0x5533a7;const _0x1809fa=_0x585aba[_0x4a8769(0xc3)]()[_0x4a8769(0xda)]('\x0a\x0a')[_0x4a8769(0xac)](_0x1b9d4d=>_0x1b9d4d[_0x4a8769(0xbd)]()!=='');for(const _0x339cc4 of _0x1809fa){const _0x3f29c1=_0x339cc4[_0x4a8769(0xa9)]('data:','');let _0x4695b5=![];try{_0x4695b5=JSON['parse'](_0x3f29c1)[_0x4a8769(0x9d)][0x0][_0x4a8769(0xb7)]===_0x4a8769(0xce);}catch(_0x5c7c97){_0x4695b5=![];}if(_0x4695b5)return _0x24a719[_0x4a8769(0xc9)]=_0x24a719[_0x4a8769(0xc9)][_0x4a8769(0xbd)](),_0x24a719;try{if(_0x3f29c1!==_0x4a8769(0xe0)&&_0x3f29c1!==_0x4a8769(0xab)&&_0x3f29c1!=_0x4a8769(0xcb)){const _0x2f00cb=JSON[_0x4a8769(0xad)](_0x3f29c1);_0x2f00cb['id']&&(_0x24a719['id']=_0x2f00cb['id']);if((_0x5533a7=_0x2f00cb[_0x4a8769(0x9d)])===null||_0x5533a7===void 0x0?void 0x0:_0x5533a7[_0x4a8769(0xa5)]){const _0x280210=_0x2f00cb[_0x4a8769(0x9d)][0x0]['delta'];_0x24a719[_0x4a8769(0xcf)]=_0x280210[_0x4a8769(0xa3)];if(_0x280210===null||_0x280210===void 0x0?void 0x0:_0x280210[_0x4a8769(0xa3)])_0x24a719[_0x4a8769(0xc9)]+=_0x280210[_0x4a8769(0xa3)];_0x280210['role']&&(_0x24a719['role']=_0x280210['role']),_0x24a719[_0x4a8769(0x9b)]=_0x2f00cb;}_0x13a56d&&_0x13a56d({'text':_0x24a719['text']});}}catch(_0x12f4bb){console[_0x4a8769(0xde)](_0x4a8769(0xd4),_0x3f29c1);}}});let _0xba14a9='';_0x62f840[_0xd5700(0xb9)](_0x2f4d4b=>{const _0x1606a1=_0xd5700;_0xba14a9+=_0x2f4d4b[_0x1606a1(0xa3)]+'\x20';}),_0x334132['on']('end',()=>{const _0x3eb48b=_0xd5700;if(_0x24a719[_0x3eb48b(0x9b)]&&_0x24a719[_0x3eb48b(0xc9)]){const _0x5752f8=getTokenCount(_0xba14a9),_0x567ec4=getTokenCount(_0x24a719[_0x3eb48b(0xc9)]);_0x24a719[_0x3eb48b(0x9b)][_0x3eb48b(0xd1)]={'prompt_tokens':_0x5752f8,'completion_tokens':_0x567ec4,'total_tokens':_0x5752f8+_0x567ec4,'estimated':!![]};}return _0x893703(_0x24a719);});}catch(_0x1f0681){_0xaf0f70(_0x1f0681);}});}}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0xa43400){const _0x29ca23=_0x397711;if(!_0xa43400)return 0x0;return typeof _0xa43400!=='string'&&(_0xa43400=String(_0xa43400)),_0xa43400=_0xa43400[_0x29ca23(0xa9)](/<\|endoftext\|>/g,''),tokenizer[_0x29ca23(0xc0)](_0xa43400)[_0x29ca23(0xa5)]*2.18;}exports[_0x397711(0xb0)]=getTokenCount;