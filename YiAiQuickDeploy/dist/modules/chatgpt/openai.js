'use strict';const _0x5d5787=_0x3aac;function _0x3aac(_0x5bfa9e,_0x54ecb7){const _0x159338=_0x1593();return _0x3aac=function(_0x3aac52,_0x4633f7){_0x3aac52=_0x3aac52-0xa5;let _0x523200=_0x159338[_0x3aac52];return _0x523200;},_0x3aac(_0x5bfa9e,_0x54ecb7);}(function(_0x499cf6,_0x1576c1){const _0x53902f=_0x3aac,_0x4cbc54=_0x499cf6();while(!![]){try{const _0x4a4dba=parseInt(_0x53902f(0xb0))/0x1+parseInt(_0x53902f(0xa9))/0x2*(-parseInt(_0x53902f(0xdf))/0x3)+parseInt(_0x53902f(0xc4))/0x4*(-parseInt(_0x53902f(0xcd))/0x5)+-parseInt(_0x53902f(0xbe))/0x6*(parseInt(_0x53902f(0xe7))/0x7)+-parseInt(_0x53902f(0xaf))/0x8*(parseInt(_0x53902f(0xb1))/0x9)+-parseInt(_0x53902f(0xad))/0xa+parseInt(_0x53902f(0xd7))/0xb;if(_0x4a4dba===_0x1576c1)break;else _0x4cbc54['push'](_0x4cbc54['shift']());}catch(_0x17904c){_0x4cbc54['push'](_0x4cbc54['shift']());}}}(_0x1593,0x76477));function _0x1593(){const _0x2e8ae2=['slice','debug','usage','parse','88HQRFZJ','base64','data','绘制图片失败，此次绘画被拒绝了！','6396200ditLJl','toString','24sMmoLj','417428BuLjni','469467DwqSHR','openai-draw\x20error:\x20','application/json','Bearer\x20','delta','------>\x20开始上传图片！！！','@nestjs/common','Logger','POST','default','detail','uuid','@dqbd/tiktoken','1738032GdfXVR','length','status','/v1/chat/completions','parse\x20Error','Billing\x20hard\x20limit\x20has\x20been\x20reached','244EdIaYu','/v1/images/generations','https://api.openai.com','绘制图片失败，请检查你的提示词是否有非法描述！','includes','当前请求已过载、请稍等会儿再试试吧！','stop','图片上传成功，URL:\x20','role','77030JjTXZE','上传图片过程中出现错误:\x20','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','choices','content','max_tokens','error','uploadFile','dall','.png','38234922pAdtfc','forEach','replace','getTokenCount','defineProperty','\x20[DONE]','sendMessageFromOpenAi','log','54816ZaQxgo','绘制图片失败，请稍后试试吧！','imageUrl','finish_reason','get_encoding','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','MidjourneyService','stream','21MbMbtY','data:','filter','from','response','text','cl100k_base','trim'];_0x1593=function(){return _0x2e8ae2;};return _0x1593();}Object[_0x5d5787(0xdb)](exports,'__esModule',{'value':!![]}),exports['getTokenCount']=exports[_0x5d5787(0xdd)]=void 0x0;const axios_1=require('axios'),tiktoken_1=require(_0x5d5787(0xbd)),common_1=require(_0x5d5787(0xb7)),uuid=require(_0x5d5787(0xbc)),tokenizer=(0x0,tiktoken_1[_0x5d5787(0xe3)])(_0x5d5787(0xed));function getFullUrl(_0x399123){const _0xc51ae4=_0x5d5787,_0x5bf86e=_0x399123['endsWith']('/')?_0x399123['slice'](0x0,-0x1):_0x399123,_0x4051d5=_0x5bf86e||_0xc51ae4(0xc6);return _0x4051d5+_0xc51ae4(0xc1);}async function sendMessageFromOpenAi(_0x1ce05f,_0x56b519,_0x25a8f6){const _0x2733a1=_0x5d5787;var _0x155159,_0x1edaa7,_0x5c4416,_0x3af329;const {onProgress:_0x50159e,maxToken:_0x5d6f68,apiKey:_0x3a1a0b,model:_0x1353d9,temperature:temperature=0.8,proxyUrl:_0x1b459e,prompt:_0xb05bbe}=_0x56b519;if(_0x1353d9[_0x2733a1(0xc8)](_0x2733a1(0xd5))){let _0x47f813={'text':'','imageUrl':''};try{const _0x1890ce={'method':_0x2733a1(0xb9),'url':_0x1b459e+_0x2733a1(0xc5),'headers':{'Content-Type':_0x2733a1(0xb3),'Authorization':_0x2733a1(0xb4)+_0x3a1a0b},'data':{'prompt':_0xb05bbe,'model':_0x1353d9,'response_format':'b64_json'}},_0x560be8=await(0x0,axios_1[_0x2733a1(0xba)])(_0x1890ce),{b64_json:_0x21073b,revised_prompt:_0x5c6dbf}=_0x560be8['data'][_0x2733a1(0xab)][0x0],_0xe9c334=Buffer[_0x2733a1(0xea)](_0x21073b,_0x2733a1(0xaa));let _0x1987d4='';try{const _0x288b11=uuid['v4']()[_0x2733a1(0xa5)](0x0,0xa)+_0x2733a1(0xd6);common_1[_0x2733a1(0xb8)]['debug'](_0x2733a1(0xb6),_0x2733a1(0xe5));const _0x3347dc=Buffer[_0x2733a1(0xea)](_0x21073b,'base64');_0x1987d4=await _0x25a8f6[_0x2733a1(0xd4)]({'filename':_0x288b11,'buffer':_0x3347dc}),common_1[_0x2733a1(0xb8)][_0x2733a1(0xa6)](_0x2733a1(0xcb)+_0x1987d4,'MidjourneyService');}catch(_0x3763d4){common_1[_0x2733a1(0xb8)]['error'](_0x2733a1(0xce)+_0x3763d4,'MidjourneyService');}return _0x47f813[_0x2733a1(0xe1)]=_0x1987d4,_0x47f813[_0x2733a1(0xec)]=_0x5c6dbf,_0x50159e&&_0x50159e({'text':_0x47f813[_0x2733a1(0xec)]}),_0x47f813;}catch(_0x2795e9){const _0xedb5ec=((_0x155159=_0x2795e9===null||_0x2795e9===void 0x0?void 0x0:_0x2795e9[_0x2733a1(0xeb)])===null||_0x155159===void 0x0?void 0x0:_0x155159[_0x2733a1(0xc0)])||0x1f4;console[_0x2733a1(0xde)](_0x2733a1(0xb2),JSON['stringify'](_0x2795e9),_0xedb5ec);const _0x3e226b=(_0x3af329=(_0x5c4416=(_0x1edaa7=_0x2795e9===null||_0x2795e9===void 0x0?void 0x0:_0x2795e9['response'])===null||_0x1edaa7===void 0x0?void 0x0:_0x1edaa7[_0x2733a1(0xab)])===null||_0x5c4416===void 0x0?void 0x0:_0x5c4416[_0x2733a1(0xd3)])===null||_0x3af329===void 0x0?void 0x0:_0x3af329['message'];if(_0xedb5ec===0x1ad)return _0x47f813['text']=_0x2733a1(0xc9),_0x47f813;if(_0xedb5ec===0x190&&_0x3e226b[_0x2733a1(0xc8)](_0x2733a1(0xcf)))return _0x47f813[_0x2733a1(0xec)]='您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',_0x47f813;if(_0xedb5ec===0x190&&_0x3e226b[_0x2733a1(0xc8)](_0x2733a1(0xc3)))return _0x47f813['text']=_0x2733a1(0xe4),_0x47f813;if(_0xedb5ec===0x1f4)return _0x47f813[_0x2733a1(0xec)]=_0x2733a1(0xc7),_0x47f813;if(_0xedb5ec===0x191)return _0x47f813[_0x2733a1(0xec)]=_0x2733a1(0xac),_0x47f813;return _0x47f813[_0x2733a1(0xec)]=_0x2733a1(0xe0),_0x47f813;}}else{let _0x4a71cf={'text':''};const _0x34ca3c={'method':_0x2733a1(0xb9),'url':getFullUrl(_0x1b459e),'responseType':_0x2733a1(0xe6),'headers':{'Content-Type':'application/json','Accept':_0x2733a1(0xb3),'Authorization':'Bearer\x20'+_0x3a1a0b},'data':{'stream':!![],'temperature':temperature,'model':_0x1353d9,'messages':_0x1ce05f}};return _0x1353d9==='gpt-4-vision-preview'&&(_0x34ca3c['data'][_0x2733a1(0xd2)]=0x800),new Promise(async(_0x3ba6f0,_0x55bd3a)=>{const _0x5e716f=_0x2733a1;try{const _0xef7e84=await(0x0,axios_1[_0x5e716f(0xba)])(_0x34ca3c),_0x4f2fbc=_0xef7e84[_0x5e716f(0xab)];_0x4f2fbc['on'](_0x5e716f(0xab),_0x537090=>{const _0x327a78=_0x5e716f;var _0x1a3cfa;const _0x205157=_0x537090[_0x327a78(0xae)]()['split']('\x0a\x0a')[_0x327a78(0xe9)](_0x1f90ce=>_0x1f90ce[_0x327a78(0xee)]()!=='');for(const _0x36928e of _0x205157){const _0x1d695d=_0x36928e[_0x327a78(0xd9)](_0x327a78(0xe8),'');let _0x4b9fd9=![];try{_0x4b9fd9=JSON[_0x327a78(0xa8)](_0x1d695d)[_0x327a78(0xd0)][0x0][_0x327a78(0xe2)]===_0x327a78(0xca);}catch(_0x53e3cb){_0x4b9fd9=![];}if(_0x4b9fd9)return _0x4a71cf[_0x327a78(0xec)]=_0x4a71cf[_0x327a78(0xec)][_0x327a78(0xee)](),_0x4a71cf;try{if(_0x1d695d!==_0x327a78(0xdc)&&_0x1d695d!=='[DONE]'&&_0x1d695d!='[DONE]\x20'){const _0x23f82f=JSON[_0x327a78(0xa8)](_0x1d695d);_0x23f82f['id']&&(_0x4a71cf['id']=_0x23f82f['id']);if((_0x1a3cfa=_0x23f82f[_0x327a78(0xd0)])===null||_0x1a3cfa===void 0x0?void 0x0:_0x1a3cfa['length']){const _0x1cc4a3=_0x23f82f[_0x327a78(0xd0)][0x0][_0x327a78(0xb5)];_0x4a71cf['delta']=_0x1cc4a3[_0x327a78(0xd1)];if(_0x1cc4a3===null||_0x1cc4a3===void 0x0?void 0x0:_0x1cc4a3[_0x327a78(0xd1)])_0x4a71cf['text']+=_0x1cc4a3['content'];_0x1cc4a3[_0x327a78(0xcc)]&&(_0x4a71cf['role']=_0x1cc4a3[_0x327a78(0xcc)]),_0x4a71cf['detail']=_0x23f82f;}_0x50159e&&_0x50159e({'text':_0x4a71cf['text']});}}catch(_0x490b4e){console[_0x327a78(0xde)](_0x327a78(0xc2),_0x1d695d);}}});let _0x557694='';_0x1ce05f[_0x5e716f(0xd8)](_0x152d65=>{const _0x72f1aa=_0x5e716f;_0x557694+=_0x152d65[_0x72f1aa(0xd1)]+'\x20';}),_0x4f2fbc['on']('end',()=>{const _0x53e850=_0x5e716f;if(_0x4a71cf[_0x53e850(0xbb)]&&_0x4a71cf[_0x53e850(0xec)]){const _0x3ecded=getTokenCount(_0x557694),_0x15f732=getTokenCount(_0x4a71cf[_0x53e850(0xec)]);_0x4a71cf['detail'][_0x53e850(0xa7)]={'prompt_tokens':_0x3ecded,'completion_tokens':_0x15f732,'total_tokens':_0x3ecded+_0x15f732,'estimated':!![]};}return _0x3ba6f0(_0x4a71cf);});}catch(_0x318235){_0x55bd3a(_0x318235);}});}}exports[_0x5d5787(0xdd)]=sendMessageFromOpenAi;function getTokenCount(_0x2f1a5d){const _0x1224c9=_0x5d5787;if(!_0x2f1a5d)return 0x0;return typeof _0x2f1a5d!=='string'&&(_0x2f1a5d=String(_0x2f1a5d)),_0x2f1a5d=_0x2f1a5d[_0x1224c9(0xd9)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x2f1a5d)[_0x1224c9(0xbf)]*2.18;}exports[_0x5d5787(0xda)]=getTokenCount;