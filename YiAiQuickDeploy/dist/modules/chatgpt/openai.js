'use strict';const _0x349bf9=_0x217b;function _0x217b(_0x1656ed,_0x5806fa){const _0x58fe71=_0x58fe();return _0x217b=function(_0x217b2f,_0x147fcd){_0x217b2f=_0x217b2f-0x170;let _0x19c100=_0x58fe71[_0x217b2f];return _0x19c100;},_0x217b(_0x1656ed,_0x5806fa);}(function(_0x564683,_0x5bd97f){const _0x227795=_0x217b,_0xb0522d=_0x564683();while(!![]){try{const _0x186c7b=-parseInt(_0x227795(0x1ab))/0x1*(parseInt(_0x227795(0x19d))/0x2)+-parseInt(_0x227795(0x1a4))/0x3+-parseInt(_0x227795(0x17c))/0x4*(-parseInt(_0x227795(0x184))/0x5)+parseInt(_0x227795(0x1b4))/0x6+parseInt(_0x227795(0x19f))/0x7+parseInt(_0x227795(0x187))/0x8*(-parseInt(_0x227795(0x197))/0x9)+parseInt(_0x227795(0x191))/0xa*(parseInt(_0x227795(0x18f))/0xb);if(_0x186c7b===_0x5bd97f)break;else _0xb0522d['push'](_0xb0522d['shift']());}catch(_0xc768bf){_0xb0522d['push'](_0xb0522d['shift']());}}}(_0x58fe,0x865b5));Object[_0x349bf9(0x1a2)](exports,_0x349bf9(0x19e),{'value':!![]}),exports['getTokenCount']=exports['sendMessageFromOpenAi']=void 0x0;const axios_1=require(_0x349bf9(0x188)),tiktoken_1=require('@dqbd/tiktoken'),common_1=require(_0x349bf9(0x19a)),uuid=require(_0x349bf9(0x1b6)),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x349bf9(0x1ac));function getFullUrl(_0xae8bf0){const _0x21ba12=_0x349bf9,_0x10f776=_0xae8bf0[_0x21ba12(0x179)]('/')?_0xae8bf0[_0x21ba12(0x182)](0x0,-0x1):_0xae8bf0,_0x3dbd81=_0x10f776||_0x21ba12(0x174);return _0x3dbd81+_0x21ba12(0x1aa);}async function sendMessageFromOpenAi(_0x49da9b,_0x25be2d,_0x4dad4a){const _0x13f8ce=_0x349bf9;var _0x1aa37e,_0xa27f3e,_0x1a70b6,_0x542618;const {onProgress:_0xc39d8a,maxToken:_0x26a509,apiKey:_0x513a60,model:_0x73e762,temperature:temperature=0.8,proxyUrl:_0x333dcd,prompt:_0x140fa4}=_0x25be2d;if(_0x73e762[_0x13f8ce(0x18e)](_0x13f8ce(0x17d))){let _0x60576e={'text':'','imageUrl':''};try{const _0x50c3d0={'method':_0x13f8ce(0x180),'url':_0x333dcd+_0x13f8ce(0x181),'headers':{'Content-Type':_0x13f8ce(0x17b),'Authorization':_0x13f8ce(0x175)+_0x513a60},'data':{'prompt':_0x140fa4,'model':_0x73e762,'response_format':'b64_json'}},_0xe2bd9e=await(0x0,axios_1[_0x13f8ce(0x17e)])(_0x50c3d0),{b64_json:_0x49d1e6,revised_prompt:_0x1724cf}=_0xe2bd9e[_0x13f8ce(0x1a1)][_0x13f8ce(0x1a1)][0x0],_0x382a05=Buffer[_0x13f8ce(0x1ad)](_0x49d1e6,_0x13f8ce(0x1b2));let _0x3e319a='';try{const _0x572d8a=uuid['v4']()[_0x13f8ce(0x182)](0x0,0xa)+'.png';common_1['Logger'][_0x13f8ce(0x1a5)](_0x13f8ce(0x1ae),_0x13f8ce(0x194));const _0x441605=Buffer['from'](_0x49d1e6,'base64');_0x3e319a=await _0x4dad4a[_0x13f8ce(0x173)]({'filename':_0x572d8a,'buffer':_0x441605}),common_1[_0x13f8ce(0x192)][_0x13f8ce(0x1a5)](_0x13f8ce(0x17f)+_0x3e319a,'MidjourneyService');}catch(_0x547acb){common_1[_0x13f8ce(0x192)][_0x13f8ce(0x1af)]('上传图片过程中出现错误:\x20'+_0x547acb,'MidjourneyService');}return _0x60576e[_0x13f8ce(0x177)]=_0x3e319a,_0x60576e[_0x13f8ce(0x196)]=_0x1724cf,_0xc39d8a&&_0xc39d8a({'text':_0x60576e[_0x13f8ce(0x196)]}),_0x60576e;}catch(_0x326489){const _0x4bf161=((_0x1aa37e=_0x326489===null||_0x326489===void 0x0?void 0x0:_0x326489['response'])===null||_0x1aa37e===void 0x0?void 0x0:_0x1aa37e[_0x13f8ce(0x18b)])||0x1f4;console[_0x13f8ce(0x18d)](_0x13f8ce(0x193),JSON[_0x13f8ce(0x18c)](_0x326489),_0x4bf161);const _0x4965c7=(_0x542618=(_0x1a70b6=(_0xa27f3e=_0x326489===null||_0x326489===void 0x0?void 0x0:_0x326489['response'])===null||_0xa27f3e===void 0x0?void 0x0:_0xa27f3e[_0x13f8ce(0x1a1)])===null||_0x1a70b6===void 0x0?void 0x0:_0x1a70b6[_0x13f8ce(0x1af)])===null||_0x542618===void 0x0?void 0x0:_0x542618['message'];if(_0x4bf161===0x1ad)return _0x60576e['text']=_0x13f8ce(0x1b3),_0x60576e;if(_0x4bf161===0x190&&_0x4965c7['includes'](_0x13f8ce(0x176)))return _0x60576e[_0x13f8ce(0x196)]=_0x13f8ce(0x1a6),_0x60576e;if(_0x4bf161===0x190&&_0x4965c7[_0x13f8ce(0x18e)]('Billing\x20hard\x20limit\x20has\x20been\x20reached'))return _0x60576e[_0x13f8ce(0x196)]='当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',_0x60576e;if(_0x4bf161===0x1f4)return _0x60576e[_0x13f8ce(0x196)]='绘制图片失败，请检查你的提示词是否有非法描述！',_0x60576e;if(_0x4bf161===0x191)return _0x60576e[_0x13f8ce(0x196)]=_0x13f8ce(0x195),_0x60576e;return _0x60576e[_0x13f8ce(0x196)]=_0x13f8ce(0x189),_0x60576e;}}else{let _0x13fd3a={'text':''};const _0x1669d0={'method':_0x13f8ce(0x180),'url':getFullUrl(_0x333dcd),'responseType':_0x13f8ce(0x190),'headers':{'Content-Type':_0x13f8ce(0x17b),'Accept':_0x13f8ce(0x17b),'Authorization':_0x13f8ce(0x175)+_0x513a60},'data':{'stream':!![],'temperature':temperature,'model':_0x73e762,'messages':_0x49da9b}};return _0x73e762==='gpt-4-vision-preview'&&(_0x1669d0[_0x13f8ce(0x1a1)][_0x13f8ce(0x171)]=0x800),new Promise(async(_0x3c5993,_0x1d7e7b)=>{const _0x22fbf4=_0x13f8ce;try{const _0x40cd3f=await(0x0,axios_1[_0x22fbf4(0x17e)])(_0x1669d0),_0x4f59d2=_0x40cd3f[_0x22fbf4(0x1a1)];_0x4f59d2['on']('data',_0x50c2b4=>{const _0x342c53=_0x22fbf4;var _0x1accff;const _0xbd0c56=_0x50c2b4[_0x342c53(0x1a8)]()[_0x342c53(0x18a)]('\x0a\x0a')[_0x342c53(0x198)](_0x39b899=>_0x39b899['trim']()!=='');for(const _0x4af10c of _0xbd0c56){const _0x3966e9=_0x4af10c[_0x342c53(0x183)](_0x342c53(0x19b),'');let _0x1c6d2d=![];try{_0x1c6d2d=JSON[_0x342c53(0x186)](_0x3966e9)[_0x342c53(0x170)][0x0]['finish_reason']===_0x342c53(0x17a);}catch(_0x29f10e){_0x1c6d2d=![];}if(_0x1c6d2d)return _0x13fd3a['text']=_0x13fd3a['text'][_0x342c53(0x1a9)](),_0x13fd3a;try{if(_0x3966e9!==_0x342c53(0x1b5)&&_0x3966e9!=='[DONE]'&&_0x3966e9!=_0x342c53(0x19c)){const _0x2be765=JSON[_0x342c53(0x186)](_0x3966e9);_0x2be765['id']&&(_0x13fd3a['id']=_0x2be765['id']);if((_0x1accff=_0x2be765[_0x342c53(0x170)])===null||_0x1accff===void 0x0?void 0x0:_0x1accff['length']){const _0x42f2ff=_0x2be765['choices'][0x0]['delta'];_0x13fd3a[_0x342c53(0x1a7)]=_0x42f2ff[_0x342c53(0x199)];if(_0x42f2ff===null||_0x42f2ff===void 0x0?void 0x0:_0x42f2ff['content'])_0x13fd3a[_0x342c53(0x196)]+=_0x42f2ff[_0x342c53(0x199)];_0x42f2ff[_0x342c53(0x185)]&&(_0x13fd3a[_0x342c53(0x185)]=_0x42f2ff[_0x342c53(0x185)]),_0x13fd3a[_0x342c53(0x1a0)]=_0x2be765;}_0xc39d8a&&_0xc39d8a({'text':_0x13fd3a[_0x342c53(0x196)]});}}catch(_0x19e14c){console['log']('parse\x20Error',_0x3966e9);}}});let _0x6f20b0='';_0x49da9b[_0x22fbf4(0x1a3)](_0x41935d=>{const _0x135ea2=_0x22fbf4;_0x6f20b0+=_0x41935d[_0x135ea2(0x199)]+'\x20';}),_0x4f59d2['on'](_0x22fbf4(0x1b0),()=>{const _0x1331fe=_0x22fbf4;if(_0x13fd3a[_0x1331fe(0x1a0)]&&_0x13fd3a[_0x1331fe(0x196)]){const _0x1877c7=getTokenCount(_0x6f20b0),_0x12f963=getTokenCount(_0x13fd3a[_0x1331fe(0x196)]);_0x13fd3a[_0x1331fe(0x1a0)][_0x1331fe(0x172)]={'prompt_tokens':_0x1877c7,'completion_tokens':_0x12f963,'total_tokens':_0x1877c7+_0x12f963,'estimated':!![]};}return _0x3c5993(_0x13fd3a);});}catch(_0x5ebb28){_0x1d7e7b(_0x5ebb28);}});}}exports[_0x349bf9(0x178)]=sendMessageFromOpenAi;function getTokenCount(_0x352d8c){const _0x543d8e=_0x349bf9;if(!_0x352d8c)return 0x0;return typeof _0x352d8c!=='string'&&(_0x352d8c=String(_0x352d8c)),_0x352d8c=_0x352d8c[_0x543d8e(0x183)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x352d8c)[_0x543d8e(0x1b1)]*2.18;}function _0x58fe(){const _0x28f7ac=['您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','delta','toString','trim','/v1/chat/completions','1lFBVLp','cl100k_base','from','------>\x20开始上传图片！！！','error','end','length','base64','当前请求已过载、请稍等会儿再试试吧！','1354254fNEMja','\x20[DONE]','uuid','choices','max_tokens','usage','uploadFile','https://api.openai.com','Bearer\x20','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','imageUrl','sendMessageFromOpenAi','endsWith','stop','application/json','1408EyGrDN','dall','default','图片上传成功，URL:\x20','POST','/v1/images/generations','slice','replace','6805QGFxRe','role','parse','475736devMCp','axios','绘制图片失败，请稍后试试吧！','split','status','stringify','log','includes','1881hpcHwR','stream','31990IsGxlD','Logger','openai-draw\x20error:\x20','MidjourneyService','绘制图片失败，此次绘画被拒绝了！','text','18YtuUTa','filter','content','@nestjs/common','data:','[DONE]\x20','646956gtkxTI','__esModule','2668421oFaHST','detail','data','defineProperty','forEach','1920828NtyXpy','debug'];_0x58fe=function(){return _0x28f7ac;};return _0x58fe();}exports['getTokenCount']=getTokenCount;