'use strict';const _0x3cfa70=_0x4c1a;function _0x4c1a(_0x5c839e,_0x177067){const _0xd7a76a=_0xd7a7();return _0x4c1a=function(_0x4c1a52,_0x467bf7){_0x4c1a52=_0x4c1a52-0x162;let _0x4e407b=_0xd7a76a[_0x4c1a52];return _0x4e407b;},_0x4c1a(_0x5c839e,_0x177067);}(function(_0x5ba564,_0x2ba06f){const _0x141f67=_0x4c1a,_0x5e7755=_0x5ba564();while(!![]){try{const _0x413aab=-parseInt(_0x141f67(0x205))/0x1*(-parseInt(_0x141f67(0x238))/0x2)+parseInt(_0x141f67(0x22a))/0x3+parseInt(_0x141f67(0x163))/0x4+parseInt(_0x141f67(0x18b))/0x5*(parseInt(_0x141f67(0x17a))/0x6)+-parseInt(_0x141f67(0x173))/0x7+parseInt(_0x141f67(0x185))/0x8*(parseInt(_0x141f67(0x175))/0x9)+-parseInt(_0x141f67(0x1c6))/0xa;if(_0x413aab===_0x2ba06f)break;else _0x5e7755['push'](_0x5e7755['shift']());}catch(_0x39dd2c){_0x5e7755['push'](_0x5e7755['shift']());}}}(_0xd7a7,0x63a03));var __decorate=this&&this[_0x3cfa70(0x22d)]||function(_0x1ea86b,_0x4402d6,_0xfd009f,_0x58b540){const _0xfa2cf2=_0x3cfa70;var _0x2f855a=arguments[_0xfa2cf2(0x1e1)],_0x4798f5=_0x2f855a<0x3?_0x4402d6:_0x58b540===null?_0x58b540=Object[_0xfa2cf2(0x16d)](_0x4402d6,_0xfd009f):_0x58b540,_0x1b4d62;if(typeof Reflect===_0xfa2cf2(0x236)&&typeof Reflect[_0xfa2cf2(0x24d)]===_0xfa2cf2(0x172))_0x4798f5=Reflect[_0xfa2cf2(0x24d)](_0x1ea86b,_0x4402d6,_0xfd009f,_0x58b540);else{for(var _0x2d10ea=_0x1ea86b['length']-0x1;_0x2d10ea>=0x0;_0x2d10ea--)if(_0x1b4d62=_0x1ea86b[_0x2d10ea])_0x4798f5=(_0x2f855a<0x3?_0x1b4d62(_0x4798f5):_0x2f855a>0x3?_0x1b4d62(_0x4402d6,_0xfd009f,_0x4798f5):_0x1b4d62(_0x4402d6,_0xfd009f))||_0x4798f5;}return _0x2f855a>0x3&&_0x4798f5&&Object['defineProperty'](_0x4402d6,_0xfd009f,_0x4798f5),_0x4798f5;},__metadata=this&&this[_0x3cfa70(0x266)]||function(_0x57ca44,_0x27b032){const _0x536037=_0x3cfa70;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x536037(0x172))return Reflect['metadata'](_0x57ca44,_0x27b032);},__param=this&&this[_0x3cfa70(0x20d)]||function(_0x5bb2f6,_0x1876d5){return function(_0x4460fd,_0x184cf7){_0x1876d5(_0x4460fd,_0x184cf7,_0x5bb2f6);};};Object[_0x3cfa70(0x199)](exports,_0x3cfa70(0x1f9),{'value':!![]}),exports[_0x3cfa70(0x195)]=void 0x0;function _0xd7a7(){const _0x19171c=['is_end','saveChatLog','error:\x20','nineai-chatlog','./../upload/upload.service','ChatgptService','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','@nestjs/typeorm','/v1/images/generations','defineProperty','filter','../chatGroup/chatGroup.service','1106','openaiModel4MaxTokens32kRes','dall','setChatBox','split','ChatBoxTypeEntity','lockKey','缺失必要参数！','formatModelToken','statusText:','ceil','AutoreplyService','chatBoxEntity','model3','.png','removeSpecialCharacters','delete','DESC','mjDraw','../models/models.service','UploadService','quality','ConfigService','chatPreEntity','assistant','ChatGroupService','dall-e-3','sendMessageFromZhipu','delChatPreType','16k','systemPreMessage','getUuid','uploadService','delChatBox','onModuleInit','appId','../badwords/badwords.service','findOne','abortController','openai-draw\x20error:\x20','../autoreply/autoreply.service','openaiTimeoutMs','2609100gZCsbe','提供了错误的模型秘钥','queryChatPreList','getBaseConfig','GlobalConfigService','setChatPreType','Incorrect\x20API\x20key\x20provided','Content-type','weight','childList','prompt','userService','response','maxModelTokens','statusText','base64','gptKeysEntity','code:\x20','all','billing','ConfigEntity','REDIS_PASSWORD','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','debug','buildMessageFromParentMessageId','close','includes','length','./../user/user.service','nestjs-config','当前模型调用过于频繁、请重新试试吧！','save','chatPreTypeEntity','compileNetwork','ChatPreTypeEntity','openaiModel4MaxTokensRes','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','deductFromBalance','proxyUrl','\x0a\x20Current\x20date:\x20','toISOString','typeInfo','draw','text','openaiModel3MaxTokens16kRes','uploadFile','nineStore','../chatLog/chatLog.service','keyv','../fanyi/fanyi.service','addOneIfOdd','__esModule','map','saveUseLog','fanyiService','./gptkeys.entity','当前分类下有未处理数据不可移除！','result','queryUserBalance','gpt-3','chatSyncFree','服务异常、请重新试试吧！！！','redis://','192uRnFoe','checkUserStatus','delChatPre','./helper','openaiBaseUrl','typeId','user','toLowerCase','__param','globalConfigService','chat-error-detail\x20\x20<----------------------------------------->','getUploadType','badwordsService','DeductionKey','update','size','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','queryChatPre','OpenAiErrorCodeMessage','./chatPreType.entity','getRandomDrawKey','post','当前模型key已被封禁','../../common/constants/errorMessage.constant','typeorm','getCurrentModelKeyInfo','slice','400\x20error','appInfo','status','gpt-4-1106','imageUrl','openaiModel4MaxTokens32k','openaiModel4MaxTokens','UserBalanceService','appEntity','coverImg','587019nNSFyw','getTokenCount','queryChatBoxFrontend','__decorate','model4','userBalanceService','PAINT_TYPE','queryChatPreType','非法操作！','https://api.openai.com','default','systemMessage','object','BadwordsService','106TVQpHq','configEntity','data','statusCode','config','openaiModel3MaxTokens','getClientIp','stringify','usage','Repository','message','./chatBoxType.entity','chat','../globalConfig/config.entity','keyPool','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','gpt-4','key','getModelProxyUrl','autoreplyService','../app/app.entity','decorate','32k','preset','setHeader','REDIS_PORT',',\x20消耗token:\x20','conversationId','ModelsService','find','setData','chatProcess','dall-e\x20draw\x20params:\x20','chatLogService','sendMessageFromOpenAi','b64_json','../globalConfig/globalConfig.service','application/octet-stream;\x20charset=utf-8','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','modelsService','当前模型不是聊天模型','model','./openai','log','checkBadWords','./zhipu','__metadata','forEach','configService','validateBalance','HttpStatus','assign','1702020Yyqshg','whiteListUser','chatGroupService','CHAT_TYPE','from','@nestjs/common','unifiedFormattingResponse','modelInfo','error','NineStore','getOwnPropertyDescriptor','push','./chatPre.entity','绘制图片失败，请稍后试试吧！','getRequestParams','function','2314235Aywrka','FanyiService','1512981xjYJDA','BAD_REQUEST','detail','write','env','1200714rYfXMn','parse','openaiModel3MaxTokensRes','./baidu','delChatBoxType','setChatPre','\x20模型名称:\x20','ChatLogService','end','当前Key余额已不足、请重新再试一次吧！','ChatBoxEntity','8oqPoTY','HttpException','queryChatBox','InjectRepository','chatBoxTypeEntity','uuid','5EMQhxn','setChatBoxType','getConfigs','importDynamic','REDIS_HOST'];_0xd7a7=function(){return _0x19171c;};return _0xd7a7();}const upload_service_1=require(_0x3cfa70(0x194)),user_service_1=require(_0x3cfa70(0x1e2)),nestjs_config_1=require(_0x3cfa70(0x1e3)),common_1=require(_0x3cfa70(0x168)),errorMessage_constant_1=require(_0x3cfa70(0x21c)),utils_1=require('../../common/utils'),axios_1=require('axios'),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x3cfa70(0x1f5)),uuid=require(_0x3cfa70(0x18a)),config_entity_1=require(_0x3cfa70(0x245)),typeorm_1=require(_0x3cfa70(0x21d)),typeorm_2=require(_0x3cfa70(0x197)),badwords_service_1=require(_0x3cfa70(0x1c0)),autoreply_service_1=require(_0x3cfa70(0x1c4)),gptkeys_entity_1=require(_0x3cfa70(0x1fd)),globalConfig_service_1=require(_0x3cfa70(0x25c)),fanyi_service_1=require(_0x3cfa70(0x1f7)),app_entity_1=require(_0x3cfa70(0x24c)),chatGroup_service_1=require(_0x3cfa70(0x19b)),models_service_1=require(_0x3cfa70(0x1af)),baidu_1=require(_0x3cfa70(0x17d)),helper_1=require(_0x3cfa70(0x208)),store_1=require('./store'),zhipu_1=require(_0x3cfa70(0x265)),openai_1=require(_0x3cfa70(0x262)),chatBoxType_entity_1=require(_0x3cfa70(0x243)),chatBox_entity_1=require('./chatBox.entity'),chatPre_entity_1=require(_0x3cfa70(0x16f)),chatPreType_entity_1=require(_0x3cfa70(0x218));let ChatgptService=class ChatgptService{constructor(_0x5def5e,_0x4979c9,_0x5d0b75,_0x42d836,_0x5ed690,_0x25a903,_0x4c74bb,_0x4bf405,_0x479e96,_0x3f9e2e,_0x2cb144,_0x4ad52c,_0x91a558,_0x35d028,_0x460195,_0x50e66f,_0x54b2a5,_0x10a59e){const _0x17768c=_0x3cfa70;this[_0x17768c(0x1d6)]=_0x5def5e,this[_0x17768c(0x239)]=_0x4979c9,this['chatBoxTypeEntity']=_0x5d0b75,this[_0x17768c(0x1a8)]=_0x42d836,this[_0x17768c(0x228)]=_0x5ed690,this[_0x17768c(0x1e6)]=_0x25a903,this[_0x17768c(0x1b3)]=_0x4c74bb,this[_0x17768c(0x268)]=_0x4bf405,this[_0x17768c(0x22f)]=_0x479e96,this['chatLogService']=_0x3f9e2e,this[_0x17768c(0x1d1)]=_0x2cb144,this[_0x17768c(0x1bc)]=_0x4ad52c,this[_0x17768c(0x211)]=_0x91a558,this[_0x17768c(0x24b)]=_0x35d028,this['globalConfigService']=_0x460195,this[_0x17768c(0x1fc)]=_0x50e66f,this[_0x17768c(0x165)]=_0x54b2a5,this[_0x17768c(0x25f)]=_0x10a59e,this[_0x17768c(0x1f4)]=null,this[_0x17768c(0x164)]=[],this[_0x17768c(0x246)]={'list3':[],'list4':[]};}async[_0x3cfa70(0x1be)](){const _0xa423b9=_0x3cfa70;let _0xdea2d1=await(0x0,utils_1[_0xa423b9(0x18e)])('chatgpt-ai-web'),_0x3ba03a=await(0x0,utils_1[_0xa423b9(0x18e)])('@keyv/redis'),_0x647887=await(0x0,utils_1[_0xa423b9(0x18e)])(_0xa423b9(0x1f6));_0xdea2d1=(_0xdea2d1===null||_0xdea2d1===void 0x0?void 0x0:_0xdea2d1[_0xa423b9(0x234)])?_0xdea2d1[_0xa423b9(0x234)]:_0xdea2d1,_0x3ba03a=(_0x3ba03a===null||_0x3ba03a===void 0x0?void 0x0:_0x3ba03a['default'])?_0x3ba03a[_0xa423b9(0x234)]:_0x3ba03a,_0x647887=(_0x647887===null||_0x647887===void 0x0?void 0x0:_0x647887[_0xa423b9(0x234)])?_0x647887[_0xa423b9(0x234)]:_0x647887;const {ChatGPTAPI:_0x490aa0,ChatGPTError:_0x3d0888,ChatGPTUnofficialProxyAPI:_0x53d784}=_0xdea2d1,_0x31d349=+process['env'][_0xa423b9(0x251)],_0x43ab2d=process[_0xa423b9(0x179)][_0xa423b9(0x18f)],_0x57feda=process[_0xa423b9(0x179)][_0xa423b9(0x1db)],_0x2fa640=process[_0xa423b9(0x179)]['REDIS_USER'],_0x4d7948=_0xa423b9(0x204)+(_0x2fa640||'')+':'+(_0x57feda||'')+'@'+_0x43ab2d+':'+_0x31d349,_0x3c6268=new _0x3ba03a(_0x4d7948),_0x487e8a=new _0x647887({'store':_0x3c6268,'namespace':_0xa423b9(0x193)});this[_0xa423b9(0x1f4)]=new store_1[(_0xa423b9(0x16c))]({'store':_0x487e8a,'namespace':_0xa423b9(0x244)});}async[_0x3cfa70(0x171)](_0x38a31a,_0x5aa17a,_0x1d57a9,_0xcbac6d=null){const _0x342543=_0x3cfa70;var _0x899189;!_0xcbac6d&&(_0xcbac6d=(_0x899189=await this[_0x342543(0x25f)][_0x342543(0x1c9)]())===null||_0x899189===void 0x0?void 0x0:_0x899189['modelInfo']);const {timeout:timeout=0x3c}=_0x1d57a9,{topN:_0x122572,model:_0x334ecc}=_0xcbac6d,{parentMessageId:parentMessageId=0x0}=_0x38a31a,_0x25ef9a=await this[_0x342543(0x20e)][_0x342543(0x18d)](['openaiTimeoutMs']),_0x27aa4c=timeout*0x3e8||_0x25ef9a||0x64*0x3e8,_0x184cdd={'parentMessageId':parentMessageId,'timeoutMs':+_0x27aa4c,'completionParams':{'model':_0x334ecc,'temperature':_0x122572}};return _0x5aa17a&&(_0x184cdd[_0x342543(0x235)]=_0x5aa17a),_0x184cdd;}async[_0x3cfa70(0x202)](_0x9f5d28){const _0x144f85=_0x3cfa70,_0x324874=await this[_0x144f85(0x25f)][_0x144f85(0x219)](),_0x28a1b0=await this[_0x144f85(0x20e)][_0x144f85(0x18d)]([_0x144f85(0x1ba)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x1a3ee8,model:_0x3b718a}=_0x324874,_0x39f7ff=await this[_0x144f85(0x24a)](_0x324874),{context:_0x3fc1fb}=await this[_0x144f85(0x1f4)][_0x144f85(0x1de)](_0x9f5d28,{'parentMessageId':'','systemMessage':_0x28a1b0});try{const _0x5535d5=await(0x0,openai_1[_0x144f85(0x25a)])(_0x3fc1fb,{'apiKey':(0x0,utils_1[_0x144f85(0x1ab)])(_0x1a3ee8),'model':_0x3b718a,'proxyUrl':_0x39f7ff,'onProgress':null});return _0x5535d5===null||_0x5535d5===void 0x0?void 0x0:_0x5535d5[_0x144f85(0x1f1)];}catch(_0xb73565){console[_0x144f85(0x263)](_0x144f85(0x192),_0xb73565);}}async[_0x3cfa70(0x257)](_0x49ac29,_0x4096d7,_0x1e06b9){const _0x309a55=_0x3cfa70;var _0x23cc87,_0x43ab8e,_0x492604,_0x577592;const _0x710aeb=_0x4096d7[_0x309a55(0x1c2)],{options:options={},appId:_0xb9a0dc,cusromPrompt:_0x244979,systemMessage:systemMessage=''}=_0x49ac29;let _0x3ce6b6=systemMessage;const {parentMessageId:_0x2b6da1}=options,{prompt:_0x48e2f4,imageUrl:_0x5d6a4f,model:_0x3598c2}=_0x49ac29,{groupId:_0x5263fd,usingNetwork:_0x3586c9}=options,_0x241194=await this[_0x309a55(0x165)]['getGroupInfoFromId'](_0x5263fd),_0xe1baeb=(_0x241194===null||_0x241194===void 0x0?void 0x0:_0x241194[_0x309a55(0x23c)])?JSON[_0x309a55(0x17b)](_0x241194[_0x309a55(0x23c)]):await this['modelsService'][_0x309a55(0x1c9)](),{keyType:_0xa1632b,model:_0x1ebf7a,topN:_0x4583ae,systemMessage:_0x5c0c2a,rounds:_0xd6162a}=_0xe1baeb['modelInfo'];let _0x2bf60a=null;!_0x244979?_0x2bf60a=await this[_0x309a55(0x25f)][_0x309a55(0x21e)](_0x1ebf7a):_0x2bf60a=await this[_0x309a55(0x25f)][_0x309a55(0x219)]();if(!_0x2bf60a)throw new common_1[(_0x309a55(0x186))](_0x309a55(0x25e),common_1['HttpStatus'][_0x309a55(0x176)]);const {deduct:_0x55f647,isTokenBased:_0x30446b,tokenFeeRatio:_0x1b0e9d,deductType:_0x388b3a,key:_0x37e1b8,secret:_0x31b661,modelName:_0x3db2b3,id:_0x2a4532,accessToken:_0x2a668c}=_0x2bf60a;await this[_0x309a55(0x1d1)][_0x309a55(0x206)](_0x4096d7['user']),await this[_0x309a55(0x22f)]['validateBalance'](_0x4096d7,_0x388b3a===0x1?_0x309a55(0x1a9):_0x309a55(0x22e),_0x55f647),_0x1e06b9&&_0x1e06b9[_0x309a55(0x250)](_0x309a55(0x1cd),_0x309a55(0x25d)),await this[_0x309a55(0x211)][_0x309a55(0x264)](_0x48e2f4,_0x4096d7['user']['id']);const _0xa37571=await this['autoreplyService']['checkAutoReply'](_0x48e2f4);if(_0xa37571&&_0x1e06b9){const _0x6de994={'message':_0xa37571,'code':0x1f4};return _0x1e06b9[_0x309a55(0x178)](JSON[_0x309a55(0x23f)](_0x6de994)),_0x1e06b9[_0x309a55(0x182)]();}if(_0xb9a0dc){const _0x185837=await this[_0x309a55(0x228)][_0x309a55(0x1c1)]({'where':{'id':_0xb9a0dc,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x185837)throw new common_1['HttpException'](_0x309a55(0x1dc),common_1[_0x309a55(0x26a)][_0x309a55(0x176)]);_0x185837[_0x309a55(0x24f)]&&(_0x3ce6b6=_0x185837[_0x309a55(0x24f)]);}else{if(_0x244979)_0x3ce6b6=systemMessage;else{if(_0x5c0c2a)_0x3ce6b6=_0x5c0c2a;else{const _0x221cf0=new Date()[_0x309a55(0x1ee)]()['split']('T')[0x0],_0x40ddeb=await this[_0x309a55(0x20e)][_0x309a55(0x18d)]([_0x309a55(0x1ba)]);_0x3ce6b6=_0x40ddeb+(_0x309a55(0x1ed)+_0x221cf0);}}}let _0x2c5ade='';if(_0x3586c9){_0x2c5ade=await(0x0,utils_1[_0x309a55(0x1e7)])(_0x48e2f4);const _0x513a57=new Date()['toISOString']()[_0x309a55(0x1a0)]('T')[0x0],_0xf2b828=await this['globalConfigService'][_0x309a55(0x18d)]([_0x309a55(0x1ba)]);_0x3ce6b6=_0xf2b828+('\x0a\x20Current\x20date:\x20'+_0x513a57);}const _0x5a83a8=await this[_0x309a55(0x171)](options,_0x3ce6b6,_0x2bf60a,_0xe1baeb[_0x309a55(0x16a)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x3fec6e}=_0x2bf60a;_0x1e06b9&&_0x1e06b9[_0x309a55(0x222)](0xc8);let _0x4e5d6b=null,_0x55b27a=null;try{if(_0x1e06b9){let _0x3a7e9b=null,_0x48109e=![];_0x1e06b9['on'](_0x309a55(0x1df),async()=>{const _0x3e9e64=_0x309a55;if(_0x48109e)return;_0x710aeb['abort']();const _0x48b41e=await(0x0,openai_1[_0x3e9e64(0x22b)])(_0x48e2f4)||0x0,_0x24c617=await(0x0,openai_1['getTokenCount'])(_0x3a7e9b===null||_0x3a7e9b===void 0x0?void 0x0:_0x3a7e9b['text'])||0x0,_0x535b16=_0x48b41e+_0x24c617,_0x1c6795=(0x0,utils_1[_0x3e9e64(0x23e)])(_0x4096d7);await this[_0x3e9e64(0x259)][_0x3e9e64(0x191)]({'appId':_0xb9a0dc,'curIp':_0x1c6795,'userId':_0x4096d7[_0x3e9e64(0x20b)]['id'],'type':balance_constant_1[_0x3e9e64(0x212)][_0x3e9e64(0x166)],'prompt':_0x48e2f4,'imageUrl':_0x5d6a4f,'activeModel':_0x3598c2,'answer':'','promptTokens':_0x48b41e,'completionTokens':0x0,'totalTokens':_0x48b41e,'model':_0x1ebf7a,'role':'user','groupId':_0x5263fd,'requestOptions':JSON[_0x3e9e64(0x23f)]({'options':null,'prompt':_0x48e2f4})}),await this[_0x3e9e64(0x259)][_0x3e9e64(0x191)]({'appId':_0xb9a0dc,'curIp':_0x1c6795,'userId':_0x4096d7[_0x3e9e64(0x20b)]['id'],'type':balance_constant_1[_0x3e9e64(0x212)][_0x3e9e64(0x166)],'prompt':_0x48e2f4,'answer':_0x3a7e9b===null||_0x3a7e9b===void 0x0?void 0x0:_0x3a7e9b[_0x3e9e64(0x1f1)],'promptTokens':_0x48b41e,'completionTokens':_0x24c617,'totalTokens':_0x535b16,'model':_0x1ebf7a,'role':_0x3e9e64(0x1b4),'groupId':_0x5263fd,'requestOptions':JSON[_0x3e9e64(0x23f)]({'options':{'model':_0x1ebf7a,'temperature':_0x4583ae},'prompt':_0x48e2f4}),'conversationOptions':JSON[_0x3e9e64(0x23f)]({'conversationId':_0x3a7e9b===null||_0x3a7e9b===void 0x0?void 0x0:_0x3a7e9b[_0x3e9e64(0x253)],'model':_0x1ebf7a,'parentMessageId':_0x3a7e9b===null||_0x3a7e9b===void 0x0?void 0x0:_0x3a7e9b['id'],'temperature':_0x4583ae})});let _0xcd0290=_0x55f647;_0x30446b===!![]&&(_0xcd0290=Math[_0x3e9e64(0x1a6)](_0x55f647*_0x535b16/_0x1b0e9d)),await this[_0x3e9e64(0x22f)][_0x3e9e64(0x1eb)](_0x4096d7[_0x3e9e64(0x20b)]['id'],_0x3e9e64(0x261)+(_0x388b3a===0x1?0x3:0x4),_0xcd0290,_0x535b16);});if(Number(_0xa1632b)===0x1){const {key:_0x41e8c9,maxToken:_0x5503bf,maxTokenRes:_0x474f1d,proxyResUrl:_0x3a5468}=await this[_0x309a55(0x1a4)](_0x2bf60a),{parentMessageId:_0x503c91,completionParams:_0x42bd6a,systemMessage:_0x3772dc}=_0x5a83a8,{model:_0x4047b7,temperature:_0x3dff5d}=_0x42bd6a,{context:_0x240ed5}=await this['nineStore'][_0x309a55(0x1de)](_0x3586c9?_0x2c5ade:_0x48e2f4,{'parentMessageId':_0x503c91,'systemMessage':_0x3772dc,'maxModelToken':_0x5503bf,'maxResponseTokens':_0x474f1d,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0xd6162a),'imageUrl':_0x5d6a4f,'activeModel':_0x3598c2});let _0x481cdc=!![];_0x4e5d6b=await(0x0,openai_1[_0x309a55(0x25a)])(_0x240ed5,{'maxToken':_0x5503bf,'maxTokenRes':_0x474f1d,'apiKey':_0x37e1b8,'model':_0x4047b7,'prompt':_0x48e2f4,'activeModel':_0x3598c2,'imageUrl':_0x5d6a4f,'temperature':_0x3dff5d,'proxyUrl':_0x3a5468,'onProgress':_0x4dca9d=>{const _0x3ea06c=_0x309a55;_0x1e06b9['write'](_0x481cdc?JSON[_0x3ea06c(0x23f)](_0x4dca9d):'\x0a'+JSON['stringify'](_0x4dca9d)),_0x3a7e9b=_0x4dca9d,_0x481cdc=![];}},this[_0x309a55(0x1bc)]),_0x48109e=!![];}if(Number(_0xa1632b)===0x2){let _0x44c9fc=!![];const {context:_0xba7af4}=await this['nineStore'][_0x309a55(0x1de)](_0x3586c9?_0x2c5ade:_0x48e2f4,{'parentMessageId':_0x2b6da1,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0xd6162a)});_0x4e5d6b=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x3586c9?_0x2c5ade:_0xba7af4,{'temperature':_0x4583ae,'accessToken':_0x2a668c,'model':_0x1ebf7a,'onProgress':_0x3a6ab1=>{const _0x454879=_0x309a55;_0x1e06b9[_0x454879(0x178)](_0x44c9fc?JSON[_0x454879(0x23f)](_0x3a6ab1):'\x0a'+JSON['stringify'](_0x3a6ab1)),_0x44c9fc=![],_0x3a7e9b=_0x3a6ab1;}}),_0x48109e=!![];}if(Number(_0xa1632b)===0x3){let _0x5ac393=!![];const {context:_0xbceaba}=await this[_0x309a55(0x1f4)][_0x309a55(0x1de)](_0x3586c9?_0x2c5ade:_0x48e2f4,{'parentMessageId':_0x2b6da1,'maxRounds':(0x0,helper_1[_0x309a55(0x1f8)])(_0xd6162a)});_0x4e5d6b=await(0x0,zhipu_1[_0x309a55(0x1b7)])(_0x3586c9?_0x2c5ade:_0xbceaba,{'temperature':_0x4583ae,'key':_0x3fec6e,'model':_0x1ebf7a,'onProgress':_0x2b7c0a=>{const _0x15cd6c=_0x309a55;_0x1e06b9[_0x15cd6c(0x178)](_0x5ac393?JSON[_0x15cd6c(0x23f)](_0x2b7c0a):'\x0a'+JSON[_0x15cd6c(0x23f)](_0x2b7c0a)),_0x5ac393=![],_0x3a7e9b=_0x2b7c0a;}}),_0x48109e=!![];}const _0x536153={'id':this[_0x309a55(0x1f4)][_0x309a55(0x1bb)](),'text':_0x48e2f4,'role':_0x309a55(0x20b),'name':undefined,'usage':null,'imageUrl':_0x5d6a4f,'activeModel':_0x3598c2,'parentMessageId':_0x2b6da1,'conversationId':_0x4e5d6b===null||_0x4e5d6b===void 0x0?void 0x0:_0x4e5d6b[_0x309a55(0x253)]};_0x55b27a={'model':_0x1ebf7a,'parentMessageId':_0x2b6da1},await this[_0x309a55(0x1f4)][_0x309a55(0x256)](_0x536153);const _0x595d1b={'id':_0x4e5d6b['id'],'text':_0x4e5d6b[_0x309a55(0x1f1)],'role':_0x309a55(0x1b4),'name':undefined,'usage':_0x4e5d6b===null||_0x4e5d6b===void 0x0?void 0x0:_0x4e5d6b['usage'],'imageUrl':_0x5d6a4f,'parentMessageId':_0x536153['id'],'conversationId':_0x4e5d6b===null||_0x4e5d6b===void 0x0?void 0x0:_0x4e5d6b['conversationId']};await this[_0x309a55(0x1f4)][_0x309a55(0x256)](_0x595d1b),_0x55b27a={'model':_0x1ebf7a,'parentMessageId':_0x536153['id']};}else{const {key:_0x20993a,maxToken:_0x374632,maxTokenRes:_0x40de09,proxyResUrl:_0x3ce4cc}=await this[_0x309a55(0x1a4)](_0x2bf60a),{parentMessageId:_0x2d1f70,completionParams:_0x65e331,systemMessage:_0x55b017}=_0x5a83a8,{model:_0xe5a796,temperature:_0x49fdfb}=_0x65e331,{context:_0x27f04f}=await this[_0x309a55(0x1f4)]['buildMessageFromParentMessageId'](_0x3586c9?_0x2c5ade:_0x48e2f4,{'parentMessageId':_0x2d1f70,'systemMessage':_0x55b017,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0xd6162a)});_0x4e5d6b=await(0x0,openai_1[_0x309a55(0x25a)])(_0x27f04f,{'apiKey':_0x37e1b8,'model':_0xe5a796,'temperature':_0x49fdfb,'proxyUrl':_0x3ce4cc,'onProgress':null,'prompt':_0x48e2f4});}let _0x1150d6=null,_0x321c8b=null;_0x1ebf7a['includes'](_0x309a55(0x19e))?_0x1150d6=((_0x23cc87=_0x4e5d6b[_0x309a55(0x177)])===null||_0x23cc87===void 0x0?void 0x0:_0x23cc87[_0x309a55(0x240)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x321c8b=await(0x0,helper_1[_0x309a55(0x169)])(_0xa1632b,_0x4e5d6b,_0x55b27a);const {prompt_tokens:_0x10d1ae,completion_tokens:_0x221934,total_tokens:_0x22775b}=_0x1ebf7a[_0x309a55(0x1e0)]('dall')?_0x1150d6:_0x321c8b['usage'];let _0xf0d643=_0x55f647;_0x30446b===!![]&&(_0xf0d643=Math['ceil'](_0x55f647*_0x22775b/_0x1b0e9d));await this['userBalanceService']['deductFromBalance'](_0x4096d7[_0x309a55(0x20b)]['id'],_0x309a55(0x261)+(_0x388b3a===0x1?0x3:0x4),_0xf0d643,_0x22775b),await this['modelsService'][_0x309a55(0x1fb)](_0x2a4532,_0x22775b);const _0x1bb8a7=(0x0,utils_1[_0x309a55(0x23e)])(_0x4096d7);await this['chatLogService']['saveChatLog']({'appId':_0xb9a0dc,'curIp':_0x1bb8a7,'userId':_0x4096d7['user']['id'],'type':balance_constant_1[_0x309a55(0x212)][_0x309a55(0x166)],'prompt':_0x48e2f4,'imageUrl':_0x5d6a4f,'activeModel':_0x3598c2,'answer':'','promptTokens':_0x10d1ae,'completionTokens':0x0,'totalTokens':_0x22775b,'model':_0x1ebf7a,'role':_0x309a55(0x20b),'groupId':_0x5263fd,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x48e2f4})}),await this['chatLogService']['saveChatLog']({'appId':_0xb9a0dc,'curIp':_0x1bb8a7,'userId':_0x4096d7[_0x309a55(0x20b)]['id'],'type':balance_constant_1[_0x309a55(0x212)][_0x309a55(0x166)],'prompt':_0x48e2f4,'imageUrl':_0x4e5d6b===null||_0x4e5d6b===void 0x0?void 0x0:_0x4e5d6b[_0x309a55(0x224)],'answer':_0x4e5d6b['text'],'promptTokens':_0x10d1ae,'completionTokens':_0x221934,'totalTokens':_0x22775b,'model':_0x1ebf7a,'role':_0x309a55(0x1b4),'groupId':_0x5263fd,'requestOptions':JSON[_0x309a55(0x23f)]({'options':{'model':_0x1ebf7a,'temperature':_0x4583ae},'prompt':_0x48e2f4}),'conversationOptions':JSON[_0x309a55(0x23f)]({'conversationId':_0x4e5d6b['conversationId'],'model':_0x1ebf7a,'parentMessageId':_0x4e5d6b['id'],'temperature':_0x4583ae})}),common_1['Logger'][_0x309a55(0x1dd)]('用户ID:\x20'+_0x4096d7[_0x309a55(0x20b)]['id']+_0x309a55(0x180)+_0x3db2b3+'-'+_0x3598c2+_0x309a55(0x252)+_0x22775b+',\x20消耗积分：\x20'+_0xf0d643,_0x309a55(0x195));const _0x184c3d=await this[_0x309a55(0x22f)][_0x309a55(0x200)](_0x4096d7[_0x309a55(0x20b)]['id']);return _0x4e5d6b['userBanance']=Object[_0x309a55(0x162)]({},_0x184c3d),_0x4e5d6b[_0x309a55(0x1ff)]&&(_0x4e5d6b[_0x309a55(0x1ff)]=''),_0x4e5d6b[_0x309a55(0x190)]=!![],_0x1e06b9?_0x1e06b9[_0x309a55(0x178)]('\x0a'+JSON[_0x309a55(0x23f)](_0x4e5d6b)):_0x4e5d6b['text'];}catch(_0xccca2f){console['log']('chat-error\x20<----------------------------------------->',_0x37e1b8,_0xccca2f);const _0x2c6263=(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f['statusCode'])||0x190,_0x1d751a=((_0x43ab8e=_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x1d2)])===null||_0x43ab8e===void 0x0?void 0x0:_0x43ab8e[_0x309a55(0x222)])||(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x23b)])||0x190;console[_0x309a55(0x263)](_0x309a55(0x20f),_0x309a55(0x1d7),_0x2c6263,_0x309a55(0x242),_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x242)],_0x309a55(0x1a5),(_0x492604=_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x1d2)])===null||_0x492604===void 0x0?void 0x0:_0x492604[_0x309a55(0x1d4)],_0x309a55(0x222),(_0x577592=_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x1d2)])===null||_0x577592===void 0x0?void 0x0:_0x577592[_0x309a55(0x222)]);if(_0xccca2f[_0x309a55(0x222)]&&_0xccca2f[_0x309a55(0x222)]===0x192){const _0x1e7b19={'message':'Catch\x20Error\x20'+_0xccca2f[_0x309a55(0x242)],'code':0x192};if(_0x1e06b9)return _0x1e06b9['write'](JSON['stringify'](_0x1e7b19));else throw new common_1[(_0x309a55(0x186))](_0xccca2f[_0x309a55(0x242)],common_1[_0x309a55(0x26a)]['PAYMENT_REQUIRED']);}if(!_0x1d751a){if(_0x1e06b9)return _0x1e06b9[_0x309a55(0x178)](JSON['stringify']({'message':_0xccca2f[_0x309a55(0x242)],'code':0x1f4}));else throw new common_1[(_0x309a55(0x186))](_0xccca2f['message'],common_1[_0x309a55(0x26a)][_0x309a55(0x176)]);}let _0x5af5e5=errorMessage_constant_1[_0x309a55(0x217)][_0x1d751a]?errorMessage_constant_1[_0x309a55(0x217)][_0x1d751a]:_0x309a55(0x203);(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x242)]['includes']('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.'))&&Number(_0xa1632b)===0x1&&(await this['modelsService'][_0x309a55(0x1a2)](_0x2a4532,_0x309a55(0x196),-0x1),_0x5af5e5=_0x309a55(0x21b));(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f['statusCode'])===0x1ad&&_0xccca2f[_0x309a55(0x242)][_0x309a55(0x1e0)](_0x309a55(0x1d9))&&Number(_0xa1632b)===0x1&&(await this[_0x309a55(0x25f)][_0x309a55(0x1a2)](_0x2a4532,_0x309a55(0x215),-0x3),_0x5af5e5='当前模型key余额已耗尽');(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x23b)])===0x1ad&&(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x1d4)])==='Too\x20Many\x20Requests'&&(_0x5af5e5=_0x309a55(0x1e4));(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f['statusCode'])===0x191&&_0xccca2f[_0x309a55(0x242)][_0x309a55(0x1e0)](_0x309a55(0x1cc))&&Number(_0xa1632b)===0x1&&(await this[_0x309a55(0x25f)]['lockKey'](_0x2a4532,_0x309a55(0x1c7),-0x2),_0x5af5e5=_0x309a55(0x1ea));(_0xccca2f===null||_0xccca2f===void 0x0?void 0x0:_0xccca2f[_0x309a55(0x23b)])===0x194&&_0xccca2f[_0x309a55(0x242)][_0x309a55(0x1e0)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0xa1632b)===0x1&&(await this[_0x309a55(0x25f)][_0x309a55(0x1a2)](_0x2a4532,_0x309a55(0x260),-0x4),_0x5af5e5='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x2c6263===0x190&&console[_0x309a55(0x263)](_0x309a55(0x220),_0xccca2f,_0xccca2f[_0x309a55(0x242)]);const _0x40168b={'message':_0x5af5e5||'Please\x20check\x20the\x20back-end\x20console','code':_0x2c6263===0x191?0x190:_0x2c6263||0x1f4};if(_0x1e06b9)return _0x1e06b9[_0x309a55(0x178)](JSON[_0x309a55(0x23f)](_0x40168b));else throw new common_1['HttpException'](_0x40168b[_0x309a55(0x242)],common_1[_0x309a55(0x26a)][_0x309a55(0x176)]);}finally{_0x1e06b9&&_0x1e06b9[_0x309a55(0x182)]();}}async[_0x3cfa70(0x1f0)](_0x4a4090,_0x4f5924){const _0x177d06=_0x3cfa70;var _0x4aa9a3,_0x3f0933,_0x46823e,_0x13597f;await this[_0x177d06(0x211)][_0x177d06(0x264)](_0x4a4090[_0x177d06(0x1d0)],_0x4f5924[_0x177d06(0x20b)]['id']),await this['userService']['checkUserStatus'](_0x4f5924[_0x177d06(0x20b)]);const _0x45c823=(_0x4a4090===null||_0x4a4090===void 0x0?void 0x0:_0x4a4090['quality'])==='hd'?0x4:0x2;await this[_0x177d06(0x22f)][_0x177d06(0x269)](_0x4f5924,_0x177d06(0x1ae),_0x45c823);let _0x16ef3e=[];const _0x38a5f2=await this[_0x177d06(0x25f)]['getCurrentModelKeyInfo'](_0x177d06(0x1b6)),_0xa4a379=_0x38a5f2===null||_0x38a5f2===void 0x0?void 0x0:_0x38a5f2['id'],{key:_0x410811,proxyResUrl:_0x1d7358}=await this[_0x177d06(0x1a4)](_0x38a5f2);common_1['Logger'][_0x177d06(0x263)]('draw\x20paompt\x20info\x20<==**==>\x20'+_0x4a4090['prompt']+',\x20key\x20===>\x20'+_0x410811,'DrawService');try{const _0x265e06=_0x1d7358+_0x177d06(0x198),_0xbfce03=Object[_0x177d06(0x162)](Object['assign']({},_0x4a4090),{'model':_0x177d06(0x1b6)});console[_0x177d06(0x263)](_0x177d06(0x258),_0xbfce03);const _0x2bbeee=await axios_1[_0x177d06(0x234)][_0x177d06(0x21a)](_0x265e06,Object[_0x177d06(0x162)](Object[_0x177d06(0x162)]({},_0xbfce03),{'response_format':_0x177d06(0x25b)}),{'headers':{'Authorization':'Bearer\x20'+_0x410811}});_0x16ef3e=_0x2bbeee[_0x177d06(0x23a)]['data'];const _0x18748a=[];for(const _0x175410 of _0x16ef3e){const _0x1f3021=uuid['v4']()[_0x177d06(0x21f)](0x0,0xa)+_0x177d06(0x1aa),_0x5382e0=Buffer[_0x177d06(0x167)](_0x175410['b64_json'],_0x177d06(0x1d5));_0x18748a['push'](this[_0x177d06(0x1bc)][_0x177d06(0x1f3)]({'filename':_0x1f3021,'buffer':_0x5382e0}));}const _0x19905e=await Promise['all'](_0x18748a);await this[_0x177d06(0x22f)]['deductFromBalance'](_0x4f5924[_0x177d06(0x20b)]['id'],'mjDraw',(_0xbfce03===null||_0xbfce03===void 0x0?void 0x0:_0xbfce03[_0x177d06(0x1b1)])==='standard'?0x2:0x4,_0x45c823);const _0x13ea86=(0x0,utils_1[_0x177d06(0x23e)])(_0x4f5924),_0x6fea16=[],_0x2bd6f0=await this['uploadService'][_0x177d06(0x210)](),[_0x45afad,_0x366a7f]=_0x4a4090[_0x177d06(0x214)][_0x177d06(0x1a0)]('x');return _0x19905e[_0x177d06(0x267)](_0x460881=>{const _0x31607=_0x177d06;_0x6fea16[_0x31607(0x16e)](this[_0x31607(0x259)][_0x31607(0x191)]({'curIp':_0x13ea86,'userId':_0x4f5924['user']['id'],'type':balance_constant_1[_0x31607(0x212)][_0x31607(0x230)],'prompt':_0x4a4090['prompt'],'answer':_0x460881,'fileInfo':JSON[_0x31607(0x23f)]({'cosType':_0x2bd6f0,'width':_0x45afad,'height':_0x366a7f,'cosUrl':_0x460881}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x31607(0x1b6)}));}),await Promise[_0x177d06(0x1d8)](_0x6fea16),_0x19905e;}catch(_0x1c746c){const _0x4dd022=((_0x4aa9a3=_0x1c746c===null||_0x1c746c===void 0x0?void 0x0:_0x1c746c[_0x177d06(0x1d2)])===null||_0x4aa9a3===void 0x0?void 0x0:_0x4aa9a3[_0x177d06(0x222)])||0x1f4;console[_0x177d06(0x263)](_0x177d06(0x1c3),JSON[_0x177d06(0x23f)](_0x1c746c),_0x410811,_0x4dd022);const _0x18c63d=(_0x13597f=(_0x46823e=(_0x3f0933=_0x1c746c===null||_0x1c746c===void 0x0?void 0x0:_0x1c746c[_0x177d06(0x1d2)])===null||_0x3f0933===void 0x0?void 0x0:_0x3f0933['data'])===null||_0x46823e===void 0x0?void 0x0:_0x46823e[_0x177d06(0x16b)])===null||_0x13597f===void 0x0?void 0x0:_0x13597f[_0x177d06(0x242)];if(_0x4dd022===0x1ad)throw new common_1[(_0x177d06(0x186))]('当前请求已过载、请稍等会儿再试试吧！',common_1[_0x177d06(0x26a)]['BAD_REQUEST']);if(_0x4dd022===0x190&&_0x18c63d[_0x177d06(0x1e0)](_0x177d06(0x247)))throw new common_1[(_0x177d06(0x186))]('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1['HttpStatus'][_0x177d06(0x176)]);if(_0x4dd022===0x190&&_0x18c63d[_0x177d06(0x1e0)]('Billing\x20hard\x20limit\x20has\x20been\x20reached')){await this[_0x177d06(0x25f)][_0x177d06(0x1a2)](_0xa4a379,_0x177d06(0x196),-0x1);throw new common_1[(_0x177d06(0x186))](_0x177d06(0x183),common_1[_0x177d06(0x26a)][_0x177d06(0x176)]);}if(_0x4dd022===0x1f4)throw new common_1[(_0x177d06(0x186))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x177d06(0x26a)][_0x177d06(0x176)]);if(_0x4dd022===0x191)throw new common_1[(_0x177d06(0x186))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x177d06(0x26a)][_0x177d06(0x176)]);throw new common_1['HttpException'](_0x177d06(0x170),common_1[_0x177d06(0x26a)][_0x177d06(0x176)]);}}async['getAllKeyList'](){const _0x325ace=_0x3cfa70,_0x3d919b=await this[_0x325ace(0x1d6)][_0x325ace(0x255)]({'where':{'status':0x1},'select':['id',_0x325ace(0x249),_0x325ace(0x1ce),'model',_0x325ace(0x1d3),'maxResponseTokens','openaiProxyUrl',_0x325ace(0x1c5)]}),_0x4a16a8=_0x3d919b[_0x325ace(0x19a)](_0x581cf5=>_0x581cf5[_0x325ace(0x261)][_0x325ace(0x1e0)]('gpt-3')),_0x549076=_0x3d919b[_0x325ace(0x19a)](_0x471bb1=>_0x471bb1[_0x325ace(0x261)][_0x325ace(0x1e0)](_0x325ace(0x248)));this[_0x325ace(0x246)]={'list3':_0x4a16a8,'list4':_0x549076};}async[_0x3cfa70(0x24a)](_0x4ab054){const _0x1f7026=_0x3cfa70,_0x58f378=await this['globalConfigService'][_0x1f7026(0x18d)]([_0x1f7026(0x209)]);return(_0x4ab054===null||_0x4ab054===void 0x0?void 0x0:_0x4ab054[_0x1f7026(0x1ec)])||_0x58f378||_0x1f7026(0x233);}async['formatModelToken'](_0x181586){const _0x4e7c03=_0x3cfa70,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x4e7c03(0x20e)]['getConfigs']([_0x4e7c03(0x23d),_0x4e7c03(0x17c),'openaiModel3MaxTokens16k',_0x4e7c03(0x1f2),_0x4e7c03(0x226),_0x4e7c03(0x1e9),_0x4e7c03(0x225),_0x4e7c03(0x19d),'openaiBaseUrl']);let _0x5cc33c=null,_0x1ac64e=null,_0x3a82ef=null,{model:_0x4b9026,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x18bee4}=_0x181586;return _0x4b9026[_0x4e7c03(0x20c)]()['includes']('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x1ac64e>=0x1000&&(maxModelTokens=0x1000),_0x5cc33c=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x1ac64e=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x4b9026[_0x4e7c03(0x20c)]()[_0x4e7c03(0x1e0)]('32k')&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x1ac64e>=0x4000&&(maxModelTokens=0x4000),_0x5cc33c=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x1ac64e=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x4b9026[_0x4e7c03(0x20c)]()[_0x4e7c03(0x1e0)]('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x1ac64e>=0x1000&&(maxModelTokens=0x1000),_0x5cc33c=maxModelTokens||0x3ffc,_0x1ac64e=maxResponseTokens||0x1000)),_0x4b9026[_0x4e7c03(0x20c)]()[_0x4e7c03(0x1e0)]('gpt-3')&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x1ac64e>=0x7d0&&(maxModelTokens=0x7d0),_0x5cc33c=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x1ac64e=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x4b9026[_0x4e7c03(0x20c)]()[_0x4e7c03(0x1e0)]('16k')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x1ac64e>=0x2000&&(maxModelTokens=0x2000),_0x5cc33c=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x1ac64e=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x4b9026[_0x4e7c03(0x20c)]()[_0x4e7c03(0x1e0)](_0x4e7c03(0x19c))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x1ac64e>=0x1000&&(maxModelTokens=0x1000),_0x5cc33c=maxModelTokens||0x4000,_0x1ac64e=maxResponseTokens||0x1000)),_0x3a82ef=proxyUrl||openaiBaseUrl||_0x4e7c03(0x233),_0x1ac64e>=_0x5cc33c&&(_0x1ac64e=Math['floor'](_0x5cc33c/0x2)),{'key':_0x18bee4,'maxToken':_0x5cc33c,'maxTokenRes':_0x1ac64e,'proxyResUrl':_0x3a82ef};}async[_0x3cfa70(0x18c)](_0x3de544,_0x3ecbeb){const _0x187808=_0x3cfa70;try{const {name:_0x559536,icon:_0x2bde9a,order:_0x59e7ac,id:_0x38fc7c,status:_0x5ecd4e}=_0x3ecbeb;return _0x38fc7c?await this[_0x187808(0x189)][_0x187808(0x213)]({'id':_0x38fc7c},{'name':_0x559536,'icon':_0x2bde9a,'order':_0x59e7ac,'status':_0x5ecd4e}):await this[_0x187808(0x189)][_0x187808(0x1e5)]({'name':_0x559536,'icon':_0x2bde9a,'order':_0x59e7ac,'status':_0x5ecd4e});}catch(_0xce3404){console[_0x187808(0x263)](_0x187808(0x192),_0xce3404);}}async[_0x3cfa70(0x17e)](_0x52106e,_0x145c35){const _0xc4fde=_0x3cfa70,{id:_0x1879b4}=_0x145c35;if(!_0x1879b4)throw new common_1[(_0xc4fde(0x186))]('非法操作！',common_1[_0xc4fde(0x26a)][_0xc4fde(0x176)]);const _0x1ace7d=await this[_0xc4fde(0x1a8)]['count']({'where':{'typeId':_0x1879b4}});if(_0x1ace7d)throw new common_1[(_0xc4fde(0x186))](_0xc4fde(0x1fe),common_1[_0xc4fde(0x26a)]['BAD_REQUEST']);return await this['chatBoxTypeEntity'][_0xc4fde(0x1ac)]({'id':_0x1879b4});}async['queryChatBoxType'](){const _0x599336=_0x3cfa70;return await this[_0x599336(0x189)][_0x599336(0x255)]({'order':{'order':_0x599336(0x1ad)}});}async[_0x3cfa70(0x19f)](_0x5784dd,_0xd50ab){const _0x677c68=_0x3cfa70,{title:_0x312c58,prompt:_0xa8b940,appId:_0x22f5cc,order:_0x36411c,status:_0x13b7c7,typeId:_0x723e74,id:_0x20c7f2,url:_0x17bb49}=_0xd50ab;if(!_0x723e74)throw new common_1[(_0x677c68(0x186))](_0x677c68(0x1a3),common_1[_0x677c68(0x26a)]['BAD_REQUEST']);try{const _0x5a1c72={'title':_0x312c58,'order':_0x36411c,'status':_0x13b7c7,'typeId':_0x723e74,'url':_0x17bb49};return _0x5a1c72[_0x677c68(0x1bf)]=_0x22f5cc||0x0,_0x5a1c72[_0x677c68(0x1d0)]=_0xa8b940||'',_0x20c7f2?await this['chatBoxEntity'][_0x677c68(0x213)]({'id':_0x20c7f2},_0x5a1c72):await this[_0x677c68(0x1a8)][_0x677c68(0x1e5)](_0x5a1c72);}catch(_0x5c5384){console[_0x677c68(0x263)](_0x677c68(0x192),_0x5c5384);}}async[_0x3cfa70(0x1bd)](_0x33dde7,_0x3a48e7){const _0x3caea3=_0x3cfa70,{id:_0xebd6ba}=_0x3a48e7;if(!_0xebd6ba)throw new common_1[(_0x3caea3(0x186))](_0x3caea3(0x232),common_1[_0x3caea3(0x26a)][_0x3caea3(0x176)]);return await this[_0x3caea3(0x1a8)]['delete']({'id':_0xebd6ba});}async[_0x3cfa70(0x187)](){const _0x10b4c3=_0x3cfa70,_0x227292=await this[_0x10b4c3(0x1a8)][_0x10b4c3(0x255)]({'order':{'order':_0x10b4c3(0x1ad)}}),_0x5a3c99=[...new Set(_0x227292[_0x10b4c3(0x1fa)](_0x323d1b=>_0x323d1b[_0x10b4c3(0x20a)]))],_0x1d79ed=[...new Set(_0x227292[_0x10b4c3(0x1fa)](_0x4b754c=>_0x4b754c['appId']))],_0x1ece9d=await this[_0x10b4c3(0x189)][_0x10b4c3(0x255)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5a3c99)}}),_0x1c4003=await this[_0x10b4c3(0x228)][_0x10b4c3(0x255)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1d79ed)}});return _0x227292['map'](_0x4c3bb3=>{const _0x5362f5=_0x10b4c3,{typeId:_0x2d66c6,appId:_0x533538}=_0x4c3bb3;return _0x4c3bb3[_0x5362f5(0x1ef)]=_0x1ece9d[_0x5362f5(0x255)](_0x4498b1=>_0x4498b1['id']===_0x2d66c6),_0x4c3bb3[_0x5362f5(0x221)]=_0x1c4003['find'](_0x59dfac=>_0x59dfac['id']===_0x533538),_0x4c3bb3;});}async[_0x3cfa70(0x22c)](){const _0x28b581=_0x3cfa70,_0x3e332c=await this[_0x28b581(0x189)]['find']({'order':{'order':_0x28b581(0x1ad)},'where':{'status':!![]}}),_0x201329=await this[_0x28b581(0x1a8)][_0x28b581(0x255)]({'where':{'status':!![]}}),_0x5a351c=[...new Set(_0x201329[_0x28b581(0x1fa)](_0x4ff822=>_0x4ff822[_0x28b581(0x1bf)]))],_0x1dfa3d=await this[_0x28b581(0x228)][_0x28b581(0x255)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5a351c)}});return _0x201329[_0x28b581(0x267)](_0x54d105=>{const _0x5d7c38=_0x28b581,_0x4e4bcb=_0x1dfa3d[_0x5d7c38(0x255)](_0x446a24=>_0x446a24['id']===_0x54d105[_0x5d7c38(0x1bf)]);return _0x54d105['coverImg']=_0x4e4bcb===null||_0x4e4bcb===void 0x0?void 0x0:_0x4e4bcb[_0x5d7c38(0x229)],_0x54d105;}),_0x3e332c[_0x28b581(0x1fa)](_0x198131=>{const _0x4ee268=_0x28b581;return _0x198131[_0x4ee268(0x1cf)]=_0x201329[_0x4ee268(0x19a)](_0x2c1d62=>_0x2c1d62[_0x4ee268(0x20a)]===_0x198131['id']&&_0x2c1d62[_0x4ee268(0x222)]),_0x198131;});}async[_0x3cfa70(0x1cb)](_0x1949ce,_0x33367f){const _0x484187=_0x3cfa70;try{const {name:_0x133c11,icon:_0x806d37,order:_0x39bbdc,id:_0x6c6ce,status:_0x184ca4}=_0x33367f;return _0x6c6ce?await this['chatPreTypeEntity'][_0x484187(0x213)]({'id':_0x6c6ce},{'name':_0x133c11,'icon':_0x806d37,'order':_0x39bbdc,'status':_0x184ca4}):await this[_0x484187(0x1e6)][_0x484187(0x1e5)]({'name':_0x133c11,'icon':_0x806d37,'order':_0x39bbdc,'status':_0x184ca4});}catch(_0xf246a4){console[_0x484187(0x263)](_0x484187(0x192),_0xf246a4);}}async[_0x3cfa70(0x1b8)](_0x4ae27d,_0x46cbea){const _0x38606e=_0x3cfa70,{id:_0x37128a}=_0x46cbea;if(!_0x37128a)throw new common_1['HttpException']('非法操作！',common_1[_0x38606e(0x26a)][_0x38606e(0x176)]);const _0x47383c=await this[_0x38606e(0x1a8)]['count']({'where':{'typeId':_0x37128a}});if(_0x47383c)throw new common_1['HttpException'](_0x38606e(0x1fe),common_1['HttpStatus'][_0x38606e(0x176)]);return await this[_0x38606e(0x1e6)][_0x38606e(0x1ac)]({'id':_0x37128a});}async[_0x3cfa70(0x231)](){const _0x467798=_0x3cfa70;return await this['chatPreTypeEntity'][_0x467798(0x255)]({'order':{'order':_0x467798(0x1ad)}});}async[_0x3cfa70(0x17f)](_0x3c9229,_0x98100d){const _0x3301c2=_0x3cfa70,{title:_0x53370f,prompt:_0x147c55,appId:_0xf23545,order:_0x480590,status:_0xdf82f6,typeId:_0x5e7ac5,id:_0x3f7d8e,url:_0x5e2844}=_0x98100d;if(!_0x5e7ac5)throw new common_1['HttpException'](_0x3301c2(0x1a3),common_1[_0x3301c2(0x26a)][_0x3301c2(0x176)]);try{const _0x134cd2={'title':_0x53370f,'prompt':_0x147c55,'order':_0x480590,'status':_0xdf82f6,'typeId':_0x5e7ac5,'url':_0x5e2844};return _0x3f7d8e?await this['chatPreEntity'][_0x3301c2(0x213)]({'id':_0x3f7d8e},_0x134cd2):await this[_0x3301c2(0x1b3)][_0x3301c2(0x1e5)](_0x134cd2);}catch(_0x350c7c){console[_0x3301c2(0x263)](_0x3301c2(0x192),_0x350c7c);}}async[_0x3cfa70(0x207)](_0x266c9b,_0x229b82){const _0x51d602=_0x3cfa70,{id:_0x198a20}=_0x229b82;if(!_0x198a20)throw new common_1[(_0x51d602(0x186))](_0x51d602(0x232),common_1['HttpStatus'][_0x51d602(0x176)]);return await this['chatPreEntity']['delete']({'id':_0x198a20});}async[_0x3cfa70(0x216)](){const _0x2236c0=_0x3cfa70,_0x57f612=await this[_0x2236c0(0x1b3)][_0x2236c0(0x255)]({'order':{'order':'DESC'}}),_0x51d237=[...new Set(_0x57f612['map'](_0x3e0665=>_0x3e0665['typeId']))],_0x575249=await this[_0x2236c0(0x1e6)][_0x2236c0(0x255)]({'where':{'id':(0x0,typeorm_1['In'])(_0x51d237)}});return _0x57f612['map'](_0x52246e=>{const _0x107627=_0x2236c0,{typeId:_0x244ec4,appId:_0x4210fe}=_0x52246e;return _0x52246e['typeInfo']=_0x575249[_0x107627(0x255)](_0x3ba018=>_0x3ba018['id']===_0x244ec4),_0x52246e;});}async[_0x3cfa70(0x1c8)](){const _0x42d188=_0x3cfa70,_0x4e807a=await this[_0x42d188(0x1e6)]['find']({'order':{'order':_0x42d188(0x1ad)},'where':{'status':!![]}}),_0x3b4ef2=await this['chatPreEntity']['find']({'where':{'status':!![]}});return _0x4e807a['map'](_0xc55ac7=>{const _0x4fddd4=_0x42d188;return _0xc55ac7['childList']=_0x3b4ef2[_0x4fddd4(0x19a)](_0x401df2=>_0x401df2[_0x4fddd4(0x20a)]===_0xc55ac7['id']&&_0x401df2[_0x4fddd4(0x222)]),_0xc55ac7;});}async['getMaxTokenFromModelWithOpenAi'](_0x457a8b,_0x4c241c,_0x100ff9){const _0x4bf683=_0x3cfa70;let _0x4b18f7=0x1000,_0x37029d=0x800;return _0x457a8b[_0x4bf683(0x20c)]()['includes'](_0x4bf683(0x248))&&(_0x4b18f7=_0x4c241c>=0x2004?0x2004:_0x4c241c,_0x37029d=_0x100ff9>=0x1000?0x1000:_0x100ff9,_0x457a8b[_0x4bf683(0x20c)]()[_0x4bf683(0x1e0)](_0x4bf683(0x24e))&&(_0x4b18f7=_0x4c241c>=0x8000?0x8000:_0x4c241c,_0x37029d=_0x100ff9>=0x3e80?0x3e80:_0x100ff9),(_0x457a8b[_0x4bf683(0x20c)]()[_0x4bf683(0x1e0)](_0x4bf683(0x223))||_0x457a8b[_0x4bf683(0x20c)]()[_0x4bf683(0x1e0)]('gpt-4-vision-preview'))&&(_0x4b18f7=_0x4c241c>=0x1f400?0x1f400:_0x4c241c,_0x37029d=_0x100ff9>=0x1000?0x1000:_0x100ff9)),_0x457a8b['toLowerCase']()[_0x4bf683(0x1e0)](_0x4bf683(0x201))&&(_0x4b18f7=_0x4c241c>=0x1000?0x1000:_0x4c241c,_0x37029d=_0x100ff9>=0x800?0x800:_0x100ff9,_0x457a8b['toLowerCase']()[_0x4bf683(0x1e0)](_0x4bf683(0x1b9))&&(_0x4b18f7=_0x4c241c>=0x4000?0x4000:_0x4c241c,_0x37029d=_0x100ff9>=0x1f40?0x1f40:_0x100ff9),_0x457a8b[_0x4bf683(0x20c)]()[_0x4bf683(0x1e0)](_0x4bf683(0x19c))&&(_0x4b18f7=_0x4c241c>=0x4000?0x4000:_0x4c241c,_0x37029d=_0x100ff9>=0x1f40?0x1f40:_0x100ff9)),{'maxToken':_0x4b18f7,'maxRes':_0x37029d};}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x3cfa70(0x188)])(gptkeys_entity_1['GptKeysEntity'])),__param(0x1,(0x0,typeorm_2[_0x3cfa70(0x188)])(config_entity_1[_0x3cfa70(0x1da)])),__param(0x2,(0x0,typeorm_2[_0x3cfa70(0x188)])(chatBoxType_entity_1[_0x3cfa70(0x1a1)])),__param(0x3,(0x0,typeorm_2[_0x3cfa70(0x188)])(chatBox_entity_1[_0x3cfa70(0x184)])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1['AppEntity'])),__param(0x5,(0x0,typeorm_2[_0x3cfa70(0x188)])(chatPreType_entity_1[_0x3cfa70(0x1e8)])),__param(0x6,(0x0,typeorm_2[_0x3cfa70(0x188)])(chatPre_entity_1['ChatPreEntity'])),__metadata('design:paramtypes',[typeorm_1['Repository'],typeorm_1['Repository'],typeorm_1[_0x3cfa70(0x241)],typeorm_1[_0x3cfa70(0x241)],typeorm_1[_0x3cfa70(0x241)],typeorm_1['Repository'],typeorm_1[_0x3cfa70(0x241)],nestjs_config_1[_0x3cfa70(0x1b2)],userBalance_service_1[_0x3cfa70(0x227)],chatLog_service_1[_0x3cfa70(0x181)],user_service_1['UserService'],upload_service_1[_0x3cfa70(0x1b0)],badwords_service_1[_0x3cfa70(0x237)],autoreply_service_1[_0x3cfa70(0x1a7)],globalConfig_service_1[_0x3cfa70(0x1ca)],fanyi_service_1[_0x3cfa70(0x174)],chatGroup_service_1[_0x3cfa70(0x1b5)],models_service_1[_0x3cfa70(0x254)]])],ChatgptService),exports['ChatgptService']=ChatgptService;