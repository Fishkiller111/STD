'use strict';const _0x33c984=_0x1e34;(function(_0x14b2f3,_0x49c822){const _0x2567b5=_0x1e34,_0x1894cf=_0x14b2f3();while(!![]){try{const _0x291204=-parseInt(_0x2567b5(0x207))/0x1*(parseInt(_0x2567b5(0x15e))/0x2)+parseInt(_0x2567b5(0x158))/0x3+-parseInt(_0x2567b5(0x1c5))/0x4+-parseInt(_0x2567b5(0x15c))/0x5+-parseInt(_0x2567b5(0x14f))/0x6*(-parseInt(_0x2567b5(0x1e6))/0x7)+-parseInt(_0x2567b5(0x140))/0x8+parseInt(_0x2567b5(0x191))/0x9*(parseInt(_0x2567b5(0x196))/0xa);if(_0x291204===_0x49c822)break;else _0x1894cf['push'](_0x1894cf['shift']());}catch(_0x5a58c1){_0x1894cf['push'](_0x1894cf['shift']());}}}(_0x1474,0x3ff47));function _0x1e34(_0x3b0021,_0x3a4101){const _0x1474a0=_0x1474();return _0x1e34=function(_0x1e34e1,_0x23aca2){_0x1e34e1=_0x1e34e1-0x101;let _0x3f4087=_0x1474a0[_0x1e34e1];return _0x3f4087;},_0x1e34(_0x3b0021,_0x3a4101);}var __decorate=this&&this['__decorate']||function(_0x2c59c9,_0x308a1f,_0xb044a1,_0x2f10fc){const _0x4b9187=_0x1e34;var _0x3571e6=arguments[_0x4b9187(0x15b)],_0x1e44ce=_0x3571e6<0x3?_0x308a1f:_0x2f10fc===null?_0x2f10fc=Object[_0x4b9187(0x1a6)](_0x308a1f,_0xb044a1):_0x2f10fc,_0x400552;if(typeof Reflect==='object'&&typeof Reflect[_0x4b9187(0x16b)]===_0x4b9187(0x114))_0x1e44ce=Reflect[_0x4b9187(0x16b)](_0x2c59c9,_0x308a1f,_0xb044a1,_0x2f10fc);else{for(var _0x576e6c=_0x2c59c9[_0x4b9187(0x15b)]-0x1;_0x576e6c>=0x0;_0x576e6c--)if(_0x400552=_0x2c59c9[_0x576e6c])_0x1e44ce=(_0x3571e6<0x3?_0x400552(_0x1e44ce):_0x3571e6>0x3?_0x400552(_0x308a1f,_0xb044a1,_0x1e44ce):_0x400552(_0x308a1f,_0xb044a1))||_0x1e44ce;}return _0x3571e6>0x3&&_0x1e44ce&&Object[_0x4b9187(0x156)](_0x308a1f,_0xb044a1,_0x1e44ce),_0x1e44ce;},__metadata=this&&this['__metadata']||function(_0x277551,_0x2790d2){const _0x131150=_0x1e34;if(typeof Reflect===_0x131150(0x1c2)&&typeof Reflect['metadata']===_0x131150(0x114))return Reflect[_0x131150(0x1b7)](_0x277551,_0x2790d2);},__param=this&&this[_0x33c984(0x1ed)]||function(_0x54b6de,_0x25197c){return function(_0x3baf72,_0x6808ff){_0x25197c(_0x3baf72,_0x6808ff,_0x54b6de);};};Object[_0x33c984(0x156)](exports,_0x33c984(0x159),{'value':!![]}),exports[_0x33c984(0x120)]=void 0x0;const upload_service_1=require(_0x33c984(0x16e)),user_service_1=require(_0x33c984(0x144)),nestjs_config_1=require('nestjs-config'),common_1=require('@nestjs/common'),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require('../../common/utils'),axios_1=require(_0x33c984(0x1c1)),userBalance_service_1=require(_0x33c984(0x18b)),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x33c984(0x20f)),uuid=require(_0x33c984(0x1bd)),config_entity_1=require(_0x33c984(0x15d)),typeorm_1=require(_0x33c984(0x18a)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x33c984(0x172)),autoreply_service_1=require(_0x33c984(0x1de)),gptkeys_entity_1=require(_0x33c984(0x11c)),globalConfig_service_1=require(_0x33c984(0x168)),fanyi_service_1=require(_0x33c984(0x1a0)),app_entity_1=require(_0x33c984(0x1ae)),chatGroup_service_1=require(_0x33c984(0x1fa)),models_service_1=require('../models/models.service'),baidu_1=require(_0x33c984(0x1c4)),helper_1=require('./helper'),store_1=require(_0x33c984(0x10d)),zhipu_1=require(_0x33c984(0x12d)),openai_1=require(_0x33c984(0x1b3)),chatBoxType_entity_1=require(_0x33c984(0x14e)),chatBox_entity_1=require('./chatBox.entity'),chatPre_entity_1=require(_0x33c984(0x10e)),chatPreType_entity_1=require(_0x33c984(0x208));function _0x1474(){const _0x3fee7c=['绘制图片失败，此次绘画被拒绝了！','getRandomDrawKey','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','当前请求已过载、请稍等会儿再试试吧！','当前模型key已被封禁','childList','OpenAiErrorCodeMessage','ChatLogService','conversationId','NineStore','log','chatBoxEntity','model3','proxyUrl','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','gpt-4-vision-preview','缺失必要参数！','AutoreplyService','DrawService','appId','gpt-3','typeorm','../userBalance/userBalance.service','REDIS_HOST','model','Injectable','userBalanceService','REDIS_PORT','9vWvxUe','sendMessageFromOpenAi','typeId','maxModelTokens','addOneIfOdd','10350190GRfpbZ','setChatBoxType','getModelProxyUrl','openaiModel4MaxTokensRes','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','b64_json','quality','chatPreEntity','chat-error\x20<----------------------------------------->','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','../fanyi/fanyi.service','result','ChatBoxEntity','configEntity','map','DESC','getOwnPropertyDescriptor','statusText','dall-e\x20draw\x20params:\x20','getCurrentModelKeyInfo','/v1/images/generations','redis://','openaiModel3MaxTokensRes','checkAutoReply','../app/app.entity','getClientIp','checkBadWords','validateBalance','toISOString','./openai','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','REDIS_USER','unifiedFormattingResponse','metadata','slice',',\x20消耗token:\x20','服务异常、请重新试试吧！！！','userService','forEach','uuid','当前分类下有未处理数据不可移除！','\x20模型名称:\x20','当前模型调用过于频繁、请重新试试吧！','axios','object','statusCode','./baidu','1926740rYsTPd','当前模型key余额已耗尽','16k','Please\x20check\x20the\x20back-end\x20console','getBaseConfig','32k','queryChatPreList','status','parse','sendMessageFromZhipu','formatModelToken','write','getTokenCount','appInfo','gpt-4-1106','chat','chatGroupService','AppEntity','openaiBaseUrl','当前Key余额已不足、请重新再试一次吧！','@keyv/redis','weight','Incorrect\x20API\x20key\x20provided','delChatBox','chatgpt-ai-web','../autoreply/autoreply.service','statusText:','standard','ConfigService','response','openaiModel3MaxTokens','HttpException','text','161959PljjWe','1106','config','modelsService','非法操作！','ModelsService','ChatBoxTypeEntity','__param','imageUrl','dall-e-3','push','configService','globalConfigService','UploadService','prompt','dall','default','GlobalConfigService','uploadFile','Catch\x20Error\x20','../chatGroup/chatGroup.service','BAD_REQUEST','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','abortController','chatProcess','keyv','preset','delChatBoxType','close','uploadService','UserBalanceService','data','PAINT_TYPE','1xfWVPS','./chatPreType.entity','systemPreMessage','chatBoxTypeEntity','queryUserBalance','model4','chatPreTypeEntity','UserService','../chatLog/chatLog.service','count','assign','queryChatBoxType','setChatBox','delChatPre','400\x20error','importDynamic','all','getAllKeyList','checkUserStatus','InjectRepository','from','./store','./chatPre.entity','getUploadType','assistant','coverImg','Repository','usage','function','lockKey','save','end','compileNetwork','chatLogService','user','systemMessage','./gptkeys.entity','filter','BadwordsService','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','ChatgptService','queryChatBox','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','keyPool','setChatPre','delete','findOne','env','getGroupInfoFromId','saveChatLog','getRequestParams','appEntity','getConfigs','./zhipu','mjDraw','openaiModel4MaxTokens','buildMessageFromParentMessageId','is_end','Bearer\x20','nineai-chatlog','nineStore','Logger','error:\x20','delChatPreType','update','Too\x20Many\x20Requests','openaiModel3MaxTokens16k','chatSyncFree','deductFromBalance','gpt-4','openaiModel4MaxTokens32k','gptKeysEntity','1359400ZUFlPc','draw\x20paompt\x20info\x20<==**==>\x20','\x0a\x20Current\x20date:\x20','toLowerCase','./../user/user.service','find','includes','autoreplyService','用户ID:\x20','setData','绘制图片失败，请稍后试试吧！','FanyiService','ChatGroupService','userBanance','./chatBoxType.entity','24LZLyaY','ChatPreTypeEntity','CHAT_TYPE','chat-error-detail\x20\x20<----------------------------------------->','stringify','提供了错误的模型秘钥','queryChatBoxFrontend','defineProperty','size','333429bGwmmx','__esModule','setHeader','length','1229110uSbjtU','../globalConfig/config.entity','158638jTsJRu','split','message','HttpStatus','DeductionKey','getUuid','ceil','PAYMENT_REQUIRED','badwordsService','getMaxTokenFromModelWithOpenAi','../globalConfig/globalConfig.service','floor','whiteListUser','decorate','onModuleInit','setChatPreType','./../upload/upload.service','design:paramtypes','.png','debug','../badwords/badwords.service','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','post'];_0x1474=function(){return _0x3fee7c;};return _0x1474();}let ChatgptService=class ChatgptService{constructor(_0x143122,_0x2fa7bf,_0x32acc4,_0x2b0ec7,_0x376286,_0x1b03d4,_0x43876f,_0x2efd6e,_0x324799,_0x3c1ce1,_0x34dffe,_0x7bdcf9,_0x282ac7,_0x721000,_0x3b5483,_0x33b9ae,_0xaa34a5,_0x4c5c96){const _0x493197=_0x33c984;this[_0x493197(0x13f)]=_0x143122,this[_0x493197(0x1a3)]=_0x2fa7bf,this['chatBoxTypeEntity']=_0x32acc4,this[_0x493197(0x180)]=_0x2b0ec7,this[_0x493197(0x12b)]=_0x376286,this['chatPreTypeEntity']=_0x1b03d4,this[_0x493197(0x19d)]=_0x43876f,this[_0x493197(0x1f1)]=_0x2efd6e,this[_0x493197(0x18f)]=_0x324799,this[_0x493197(0x119)]=_0x3c1ce1,this[_0x493197(0x1bb)]=_0x34dffe,this[_0x493197(0x203)]=_0x7bdcf9,this['badwordsService']=_0x282ac7,this[_0x493197(0x147)]=_0x721000,this[_0x493197(0x1f2)]=_0x3b5483,this['fanyiService']=_0x33b9ae,this[_0x493197(0x1d5)]=_0xaa34a5,this[_0x493197(0x1e9)]=_0x4c5c96,this[_0x493197(0x134)]=null,this[_0x493197(0x16a)]=[],this[_0x493197(0x123)]={'list3':[],'list4':[]};}async[_0x33c984(0x16c)](){const _0x224e0a=_0x33c984;let _0x1420d7=await(0x0,utils_1[_0x224e0a(0x107)])(_0x224e0a(0x1dd)),_0x1b219b=await(0x0,utils_1[_0x224e0a(0x107)])(_0x224e0a(0x1d9)),_0x12b203=await(0x0,utils_1[_0x224e0a(0x107)])(_0x224e0a(0x1ff));_0x1420d7=(_0x1420d7===null||_0x1420d7===void 0x0?void 0x0:_0x1420d7[_0x224e0a(0x1f6)])?_0x1420d7[_0x224e0a(0x1f6)]:_0x1420d7,_0x1b219b=(_0x1b219b===null||_0x1b219b===void 0x0?void 0x0:_0x1b219b['default'])?_0x1b219b[_0x224e0a(0x1f6)]:_0x1b219b,_0x12b203=(_0x12b203===null||_0x12b203===void 0x0?void 0x0:_0x12b203[_0x224e0a(0x1f6)])?_0x12b203[_0x224e0a(0x1f6)]:_0x12b203;const {ChatGPTAPI:_0x41e285,ChatGPTError:_0x5a2c6b,ChatGPTUnofficialProxyAPI:_0x180f8b}=_0x1420d7,_0xc7162a=+process[_0x224e0a(0x127)][_0x224e0a(0x190)],_0x4d4efa=process[_0x224e0a(0x127)][_0x224e0a(0x18c)],_0x14a1ce=process[_0x224e0a(0x127)]['REDIS_PASSWORD'],_0xf95758=process[_0x224e0a(0x127)][_0x224e0a(0x1b5)],_0x4251c5=_0x224e0a(0x1ab)+(_0xf95758||'')+':'+(_0x14a1ce||'')+'@'+_0x4d4efa+':'+_0xc7162a,_0x534326=new _0x1b219b(_0x4251c5),_0x1867c2=new _0x12b203({'store':_0x534326,'namespace':_0x224e0a(0x133)});this[_0x224e0a(0x134)]=new store_1[(_0x224e0a(0x17e))]({'store':_0x1867c2,'namespace':_0x224e0a(0x1d4)});}async[_0x33c984(0x12a)](_0x548a23,_0x1821f7,_0x125277,_0x267dcb=null){const _0x4812eb=_0x33c984;var _0x34db83;!_0x267dcb&&(_0x267dcb=(_0x34db83=await this['modelsService']['getBaseConfig']())===null||_0x34db83===void 0x0?void 0x0:_0x34db83['modelInfo']);const {timeout:timeout=0x3c}=_0x125277,{topN:_0x2d02a5,model:_0x25b2e4}=_0x267dcb,{parentMessageId:parentMessageId=0x0}=_0x548a23,_0x41d2ed=await this[_0x4812eb(0x1f2)]['getConfigs'](['openaiTimeoutMs']),_0x112ef2=timeout*0x3e8||_0x41d2ed||0x64*0x3e8,_0x302673={'parentMessageId':parentMessageId,'timeoutMs':+_0x112ef2,'completionParams':{'model':_0x25b2e4,'temperature':_0x2d02a5}};return _0x1821f7&&(_0x302673[_0x4812eb(0x11b)]=_0x1821f7),_0x302673;}async[_0x33c984(0x13b)](_0x5cc13a){const _0x1a80cd=_0x33c984,_0x30039f=await this[_0x1a80cd(0x1e9)][_0x1a80cd(0x176)](),_0x137bd6=await this[_0x1a80cd(0x1f2)][_0x1a80cd(0x12c)]([_0x1a80cd(0x209)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x2324e0,model:_0x38d657}=_0x30039f,_0x2f2396=await this[_0x1a80cd(0x198)](_0x30039f),{context:_0x4d2781}=await this['nineStore'][_0x1a80cd(0x130)](_0x5cc13a,{'parentMessageId':'','systemMessage':_0x137bd6});try{const _0x1612b1=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x4d2781,{'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x2324e0),'model':_0x38d657,'proxyUrl':_0x2f2396,'onProgress':null});return _0x1612b1===null||_0x1612b1===void 0x0?void 0x0:_0x1612b1[_0x1a80cd(0x1e5)];}catch(_0x56493e){console[_0x1a80cd(0x17f)](_0x1a80cd(0x136),_0x56493e);}}async[_0x33c984(0x1fe)](_0x2e2d7f,_0xd2fa05,_0x2660ba){const _0x2df811=_0x33c984;var _0x1b2ef9,_0x55748c,_0x29713a,_0x39d1cf;const _0x17b7b3=_0xd2fa05[_0x2df811(0x1fd)],{options:options={},appId:_0x1ff145,cusromPrompt:_0x95c680,systemMessage:systemMessage=''}=_0x2e2d7f;let _0x4ccb2e=systemMessage;const {parentMessageId:_0x1ff25e}=options,{prompt:_0x350d11,imageUrl:_0x3f99d0,model:_0x525d30}=_0x2e2d7f,{groupId:_0x1b5cbe,usingNetwork:_0x126daf}=options,_0x49a171=await this[_0x2df811(0x1d5)][_0x2df811(0x128)](_0x1b5cbe),_0x1bdcef=(_0x49a171===null||_0x49a171===void 0x0?void 0x0:_0x49a171['config'])?JSON[_0x2df811(0x1cd)](_0x49a171[_0x2df811(0x1e8)]):await this[_0x2df811(0x1e9)][_0x2df811(0x1c9)](),{keyType:_0x5a9c42,model:_0x4b36e2,topN:_0x369d89,systemMessage:_0x1829a3,rounds:_0xe76f72}=_0x1bdcef['modelInfo'];let _0x35d988=null;!_0x95c680?_0x35d988=await this[_0x2df811(0x1e9)][_0x2df811(0x1a9)](_0x4b36e2):_0x35d988=await this[_0x2df811(0x1e9)][_0x2df811(0x176)]();if(!_0x35d988)throw new common_1['HttpException'](_0x2df811(0x1b4),common_1[_0x2df811(0x161)][_0x2df811(0x1fb)]);const {deduct:_0x41bb09,isTokenBased:_0x4f7f9d,tokenFeeRatio:_0x59bfc1,deductType:_0x471531,key:_0x3c39e1,secret:_0x5901cb,modelName:_0x39cf55,id:_0x1b9b5c,accessToken:_0x4766ff}=_0x35d988;await this['userService'][_0x2df811(0x10a)](_0xd2fa05['user']),await this[_0x2df811(0x18f)][_0x2df811(0x1b1)](_0xd2fa05,_0x471531===0x1?_0x2df811(0x181):_0x2df811(0x20c),_0x41bb09),_0x2660ba&&_0x2660ba[_0x2df811(0x15a)]('Content-type','application/octet-stream;\x20charset=utf-8'),await this['badwordsService'][_0x2df811(0x1b0)](_0x350d11,_0xd2fa05[_0x2df811(0x11a)]['id']);const _0x329425=await this[_0x2df811(0x147)][_0x2df811(0x1ad)](_0x350d11);if(_0x329425&&_0x2660ba){const _0x14370b={'message':_0x329425,'code':0x1f4};return _0x2660ba[_0x2df811(0x1d0)](JSON['stringify'](_0x14370b)),_0x2660ba[_0x2df811(0x117)]();}if(_0x1ff145){const _0x34d017=await this[_0x2df811(0x12b)][_0x2df811(0x126)]({'where':{'id':_0x1ff145,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x34d017)throw new common_1[(_0x2df811(0x1e4))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0x2df811(0x161)]['BAD_REQUEST']);_0x34d017['preset']&&(_0x4ccb2e=_0x34d017[_0x2df811(0x200)]);}else{if(_0x95c680)_0x4ccb2e=systemMessage;else{if(_0x1829a3)_0x4ccb2e=_0x1829a3;else{const _0x3eb29b=new Date()[_0x2df811(0x1b2)]()[_0x2df811(0x15f)]('T')[0x0],_0x3723a4=await this[_0x2df811(0x1f2)][_0x2df811(0x12c)](['systemPreMessage']);_0x4ccb2e=_0x3723a4+('\x0a\x20Current\x20date:\x20'+_0x3eb29b);}}}let _0x23a035='';if(_0x126daf){_0x23a035=await(0x0,utils_1[_0x2df811(0x118)])(_0x350d11);const _0x5403ae=new Date()['toISOString']()[_0x2df811(0x15f)]('T')[0x0],_0x257673=await this[_0x2df811(0x1f2)][_0x2df811(0x12c)]([_0x2df811(0x209)]);_0x4ccb2e=_0x257673+(_0x2df811(0x142)+_0x5403ae);}const _0x4ff85c=await this['getRequestParams'](options,_0x4ccb2e,_0x35d988,_0x1bdcef['modelInfo']),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x1ff643}=_0x35d988;_0x2660ba&&_0x2660ba[_0x2df811(0x1cc)](0xc8);let _0x165abc=null,_0x4b855e=null;try{if(_0x2660ba){let _0x2b768e=null,_0x6fb6bb=![];_0x2660ba['on'](_0x2df811(0x202),async()=>{const _0x257bdb=_0x2df811;if(_0x6fb6bb)return;_0x17b7b3['abort']();const _0x53b696=await(0x0,openai_1[_0x257bdb(0x1d1)])(_0x350d11)||0x0,_0x4b5a98=await(0x0,openai_1['getTokenCount'])(_0x2b768e===null||_0x2b768e===void 0x0?void 0x0:_0x2b768e[_0x257bdb(0x1e5)])||0x0,_0x406b30=_0x53b696+_0x4b5a98,_0x10762f=(0x0,utils_1[_0x257bdb(0x1af)])(_0xd2fa05);await this[_0x257bdb(0x119)][_0x257bdb(0x129)]({'appId':_0x1ff145,'curIp':_0x10762f,'userId':_0xd2fa05['user']['id'],'type':balance_constant_1[_0x257bdb(0x162)][_0x257bdb(0x151)],'prompt':_0x350d11,'imageUrl':_0x3f99d0,'activeModel':_0x525d30,'answer':'','promptTokens':_0x53b696,'completionTokens':0x0,'totalTokens':_0x53b696,'model':_0x4b36e2,'role':_0x257bdb(0x11a),'groupId':_0x1b5cbe,'requestOptions':JSON[_0x257bdb(0x153)]({'options':null,'prompt':_0x350d11})}),await this[_0x257bdb(0x119)][_0x257bdb(0x129)]({'appId':_0x1ff145,'curIp':_0x10762f,'userId':_0xd2fa05[_0x257bdb(0x11a)]['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x350d11,'answer':_0x2b768e===null||_0x2b768e===void 0x0?void 0x0:_0x2b768e[_0x257bdb(0x1e5)],'promptTokens':_0x53b696,'completionTokens':_0x4b5a98,'totalTokens':_0x406b30,'model':_0x4b36e2,'role':_0x257bdb(0x110),'groupId':_0x1b5cbe,'requestOptions':JSON[_0x257bdb(0x153)]({'options':{'model':_0x4b36e2,'temperature':_0x369d89},'prompt':_0x350d11}),'conversationOptions':JSON[_0x257bdb(0x153)]({'conversationId':_0x2b768e===null||_0x2b768e===void 0x0?void 0x0:_0x2b768e[_0x257bdb(0x17d)],'model':_0x4b36e2,'parentMessageId':_0x2b768e===null||_0x2b768e===void 0x0?void 0x0:_0x2b768e['id'],'temperature':_0x369d89})});let _0x33bb56=_0x41bb09;_0x4f7f9d===!![]&&(_0x33bb56=Math['ceil'](_0x41bb09*_0x406b30/_0x59bfc1)),await this['userBalanceService'][_0x257bdb(0x13c)](_0xd2fa05[_0x257bdb(0x11a)]['id'],_0x257bdb(0x18d)+(_0x471531===0x1?0x3:0x4),_0x33bb56,_0x406b30);});if(Number(_0x5a9c42)===0x1){const {key:_0x89d2b5,maxToken:_0x26e0e0,maxTokenRes:_0x2b82f6,proxyResUrl:_0x594c63}=await this[_0x2df811(0x1cf)](_0x35d988),{parentMessageId:_0x578eb7,completionParams:_0x48310e,systemMessage:_0x81ea92}=_0x4ff85c,{model:_0x130335,temperature:_0x1d94d3}=_0x48310e,{context:_0x50c944}=await this[_0x2df811(0x134)][_0x2df811(0x130)](_0x126daf?_0x23a035:_0x350d11,{'parentMessageId':_0x578eb7,'systemMessage':_0x81ea92,'maxModelToken':_0x26e0e0,'maxResponseTokens':_0x2b82f6,'maxRounds':(0x0,helper_1[_0x2df811(0x195)])(_0xe76f72),'imageUrl':_0x3f99d0,'activeModel':_0x525d30});let _0xc626cb=!![];_0x165abc=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x50c944,{'maxToken':_0x26e0e0,'maxTokenRes':_0x2b82f6,'apiKey':_0x3c39e1,'model':_0x130335,'prompt':_0x350d11,'activeModel':_0x525d30,'imageUrl':_0x3f99d0,'temperature':_0x1d94d3,'proxyUrl':_0x594c63,'onProgress':_0x151e0e=>{const _0x334974=_0x2df811;_0x2660ba[_0x334974(0x1d0)](_0xc626cb?JSON['stringify'](_0x151e0e):'\x0a'+JSON[_0x334974(0x153)](_0x151e0e)),_0x2b768e=_0x151e0e,_0xc626cb=![];}},this[_0x2df811(0x203)]),_0x6fb6bb=!![];}if(Number(_0x5a9c42)===0x2){let _0x555f19=!![];const {context:_0x306a98}=await this[_0x2df811(0x134)][_0x2df811(0x130)](_0x126daf?_0x23a035:_0x350d11,{'parentMessageId':_0x1ff25e,'maxRounds':(0x0,helper_1[_0x2df811(0x195)])(_0xe76f72)});_0x165abc=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x126daf?_0x23a035:_0x306a98,{'temperature':_0x369d89,'accessToken':_0x4766ff,'model':_0x4b36e2,'onProgress':_0x4807e4=>{const _0x17ba73=_0x2df811;_0x2660ba[_0x17ba73(0x1d0)](_0x555f19?JSON[_0x17ba73(0x153)](_0x4807e4):'\x0a'+JSON[_0x17ba73(0x153)](_0x4807e4)),_0x555f19=![],_0x2b768e=_0x4807e4;}}),_0x6fb6bb=!![];}if(Number(_0x5a9c42)===0x3){let _0x22d0ef=!![];const {context:_0x46cd6e}=await this['nineStore'][_0x2df811(0x130)](_0x126daf?_0x23a035:_0x350d11,{'parentMessageId':_0x1ff25e,'maxRounds':(0x0,helper_1[_0x2df811(0x195)])(_0xe76f72)});_0x165abc=await(0x0,zhipu_1[_0x2df811(0x1ce)])(_0x126daf?_0x23a035:_0x46cd6e,{'temperature':_0x369d89,'key':_0x1ff643,'model':_0x4b36e2,'onProgress':_0x84c658=>{const _0x2a54f3=_0x2df811;_0x2660ba[_0x2a54f3(0x1d0)](_0x22d0ef?JSON[_0x2a54f3(0x153)](_0x84c658):'\x0a'+JSON[_0x2a54f3(0x153)](_0x84c658)),_0x22d0ef=![],_0x2b768e=_0x84c658;}}),_0x6fb6bb=!![];}const _0x133e07={'id':this[_0x2df811(0x134)][_0x2df811(0x163)](),'text':_0x350d11,'role':_0x2df811(0x11a),'name':undefined,'usage':null,'imageUrl':_0x3f99d0,'activeModel':_0x525d30,'parentMessageId':_0x1ff25e,'conversationId':_0x165abc===null||_0x165abc===void 0x0?void 0x0:_0x165abc[_0x2df811(0x17d)]};_0x4b855e={'model':_0x4b36e2,'parentMessageId':_0x1ff25e},await this[_0x2df811(0x134)][_0x2df811(0x149)](_0x133e07);const _0x5d8b54={'id':_0x165abc['id'],'text':_0x165abc[_0x2df811(0x1e5)],'role':'assistant','name':undefined,'usage':_0x165abc===null||_0x165abc===void 0x0?void 0x0:_0x165abc[_0x2df811(0x113)],'imageUrl':_0x3f99d0,'parentMessageId':_0x133e07['id'],'conversationId':_0x165abc===null||_0x165abc===void 0x0?void 0x0:_0x165abc[_0x2df811(0x17d)]};await this[_0x2df811(0x134)][_0x2df811(0x149)](_0x5d8b54),_0x4b855e={'model':_0x4b36e2,'parentMessageId':_0x133e07['id']};}else{const {key:_0x5392d4,maxToken:_0x2603d5,maxTokenRes:_0x5cc138,proxyResUrl:_0x5e25f2}=await this[_0x2df811(0x1cf)](_0x35d988),{parentMessageId:_0x2e0b22,completionParams:_0xa32309,systemMessage:_0x30b150}=_0x4ff85c,{model:_0x8ac01a,temperature:_0x39f880}=_0xa32309,{context:_0x1cd1e0}=await this[_0x2df811(0x134)][_0x2df811(0x130)](_0x126daf?_0x23a035:_0x350d11,{'parentMessageId':_0x2e0b22,'systemMessage':_0x30b150,'maxRounds':(0x0,helper_1[_0x2df811(0x195)])(_0xe76f72)});_0x165abc=await(0x0,openai_1[_0x2df811(0x192)])(_0x1cd1e0,{'apiKey':_0x3c39e1,'model':_0x8ac01a,'temperature':_0x39f880,'proxyUrl':_0x5e25f2,'onProgress':null,'prompt':_0x350d11});}let _0x140c9b=null,_0x5bcc60=null;_0x4b36e2[_0x2df811(0x146)]('dall')?_0x140c9b=((_0x1b2ef9=_0x165abc['detail'])===null||_0x1b2ef9===void 0x0?void 0x0:_0x1b2ef9['usage'])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x5bcc60=await(0x0,helper_1[_0x2df811(0x1b6)])(_0x5a9c42,_0x165abc,_0x4b855e);const {prompt_tokens:_0x4d2d43,completion_tokens:_0x4dbc39,total_tokens:_0x10e61b}=_0x4b36e2[_0x2df811(0x146)](_0x2df811(0x1f5))?_0x140c9b:_0x5bcc60[_0x2df811(0x113)];let _0x3f166e=_0x41bb09;_0x4f7f9d===!![]&&(_0x3f166e=Math[_0x2df811(0x164)](_0x41bb09*_0x10e61b/_0x59bfc1));await this[_0x2df811(0x18f)][_0x2df811(0x13c)](_0xd2fa05[_0x2df811(0x11a)]['id'],_0x2df811(0x18d)+(_0x471531===0x1?0x3:0x4),_0x3f166e,_0x10e61b),await this['modelsService']['saveUseLog'](_0x1b9b5c,_0x10e61b);const _0xe4c412=(0x0,utils_1['getClientIp'])(_0xd2fa05);await this[_0x2df811(0x119)]['saveChatLog']({'appId':_0x1ff145,'curIp':_0xe4c412,'userId':_0xd2fa05[_0x2df811(0x11a)]['id'],'type':balance_constant_1[_0x2df811(0x162)][_0x2df811(0x151)],'prompt':_0x350d11,'imageUrl':_0x3f99d0,'activeModel':_0x525d30,'answer':'','promptTokens':_0x4d2d43,'completionTokens':0x0,'totalTokens':_0x10e61b,'model':_0x4b36e2,'role':_0x2df811(0x11a),'groupId':_0x1b5cbe,'requestOptions':JSON[_0x2df811(0x153)]({'options':null,'prompt':_0x350d11})}),await this[_0x2df811(0x119)][_0x2df811(0x129)]({'appId':_0x1ff145,'curIp':_0xe4c412,'userId':_0xd2fa05['user']['id'],'type':balance_constant_1['DeductionKey'][_0x2df811(0x151)],'prompt':_0x350d11,'imageUrl':_0x165abc===null||_0x165abc===void 0x0?void 0x0:_0x165abc[_0x2df811(0x1ee)],'answer':_0x165abc[_0x2df811(0x1e5)],'promptTokens':_0x4d2d43,'completionTokens':_0x4dbc39,'totalTokens':_0x10e61b,'model':_0x4b36e2,'role':_0x2df811(0x110),'groupId':_0x1b5cbe,'requestOptions':JSON[_0x2df811(0x153)]({'options':{'model':_0x4b36e2,'temperature':_0x369d89},'prompt':_0x350d11}),'conversationOptions':JSON[_0x2df811(0x153)]({'conversationId':_0x165abc[_0x2df811(0x17d)],'model':_0x4b36e2,'parentMessageId':_0x165abc['id'],'temperature':_0x369d89})}),common_1['Logger'][_0x2df811(0x171)](_0x2df811(0x148)+_0xd2fa05['user']['id']+_0x2df811(0x1bf)+_0x39cf55+'-'+_0x525d30+_0x2df811(0x1b9)+_0x10e61b+',\x20消耗积分：\x20'+_0x3f166e,_0x2df811(0x120));const _0x3f4284=await this[_0x2df811(0x18f)][_0x2df811(0x20b)](_0xd2fa05[_0x2df811(0x11a)]['id']);return _0x165abc[_0x2df811(0x14d)]=Object['assign']({},_0x3f4284),_0x165abc[_0x2df811(0x1a1)]&&(_0x165abc[_0x2df811(0x1a1)]=''),_0x165abc[_0x2df811(0x131)]=!![],_0x2660ba?_0x2660ba[_0x2df811(0x1d0)]('\x0a'+JSON[_0x2df811(0x153)](_0x165abc)):_0x165abc[_0x2df811(0x1e5)];}catch(_0x491f8d){console[_0x2df811(0x17f)](_0x2df811(0x19e),_0x3c39e1,_0x491f8d);const _0x384b31=(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1c3)])||0x190,_0x4ce983=((_0x55748c=_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1e2)])===null||_0x55748c===void 0x0?void 0x0:_0x55748c[_0x2df811(0x1cc)])||(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1c3)])||0x190;console['log'](_0x2df811(0x152),'code:\x20',_0x384b31,_0x2df811(0x160),_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x160)],_0x2df811(0x1df),(_0x29713a=_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1e2)])===null||_0x29713a===void 0x0?void 0x0:_0x29713a['statusText'],_0x2df811(0x1cc),(_0x39d1cf=_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1e2)])===null||_0x39d1cf===void 0x0?void 0x0:_0x39d1cf[_0x2df811(0x1cc)]);if(_0x491f8d['status']&&_0x491f8d[_0x2df811(0x1cc)]===0x192){const _0x294061={'message':_0x2df811(0x1f9)+_0x491f8d['message'],'code':0x192};if(_0x2660ba)return _0x2660ba['write'](JSON[_0x2df811(0x153)](_0x294061));else throw new common_1['HttpException'](_0x491f8d[_0x2df811(0x160)],common_1[_0x2df811(0x161)][_0x2df811(0x165)]);}if(!_0x4ce983){if(_0x2660ba)return _0x2660ba[_0x2df811(0x1d0)](JSON[_0x2df811(0x153)]({'message':_0x491f8d[_0x2df811(0x160)],'code':0x1f4}));else throw new common_1[(_0x2df811(0x1e4))](_0x491f8d[_0x2df811(0x160)],common_1['HttpStatus'][_0x2df811(0x1fb)]);}let _0x2064ad=errorMessage_constant_1[_0x2df811(0x17b)][_0x4ce983]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x4ce983]:_0x2df811(0x1ba);(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x160)][_0x2df811(0x146)](_0x2df811(0x173)))&&Number(_0x5a9c42)===0x1&&(await this['modelsService']['lockKey'](_0x1b9b5c,_0x2df811(0x122),-0x1),_0x2064ad=_0x2df811(0x179));(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d['statusCode'])===0x1ad&&_0x491f8d[_0x2df811(0x160)][_0x2df811(0x146)]('billing')&&Number(_0x5a9c42)===0x1&&(await this[_0x2df811(0x1e9)]['lockKey'](_0x1b9b5c,_0x2df811(0x19f),-0x3),_0x2064ad=_0x2df811(0x1c6));(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1c3)])===0x1ad&&(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1a7)])===_0x2df811(0x139)&&(_0x2064ad=_0x2df811(0x1c0));(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1c3)])===0x191&&_0x491f8d[_0x2df811(0x160)][_0x2df811(0x146)](_0x2df811(0x1db))&&Number(_0x5a9c42)===0x1&&(await this['modelsService']['lockKey'](_0x1b9b5c,_0x2df811(0x154),-0x2),_0x2064ad=_0x2df811(0x1fc));(_0x491f8d===null||_0x491f8d===void 0x0?void 0x0:_0x491f8d[_0x2df811(0x1c3)])===0x194&&_0x491f8d[_0x2df811(0x160)][_0x2df811(0x146)](_0x2df811(0x11f))&&Number(_0x5a9c42)===0x1&&(await this[_0x2df811(0x1e9)]['lockKey'](_0x1b9b5c,'当前模型不是聊天模型',-0x4),_0x2064ad=_0x2df811(0x183));_0x384b31===0x190&&console[_0x2df811(0x17f)](_0x2df811(0x106),_0x491f8d,_0x491f8d[_0x2df811(0x160)]);const _0xc97dfb={'message':_0x2064ad||_0x2df811(0x1c8),'code':_0x384b31===0x191?0x190:_0x384b31||0x1f4};if(_0x2660ba)return _0x2660ba[_0x2df811(0x1d0)](JSON[_0x2df811(0x153)](_0xc97dfb));else throw new common_1[(_0x2df811(0x1e4))](_0xc97dfb['message'],common_1[_0x2df811(0x161)]['BAD_REQUEST']);}finally{_0x2660ba&&_0x2660ba[_0x2df811(0x117)]();}}async['draw'](_0x5ef1e3,_0x34c5a2){const _0x3a9914=_0x33c984;var _0x8df6fb,_0x21f9e7,_0x439905,_0x414e83;await this[_0x3a9914(0x166)][_0x3a9914(0x1b0)](_0x5ef1e3['prompt'],_0x34c5a2[_0x3a9914(0x11a)]['id']),await this[_0x3a9914(0x1bb)]['checkUserStatus'](_0x34c5a2[_0x3a9914(0x11a)]);const _0x1b8164=(_0x5ef1e3===null||_0x5ef1e3===void 0x0?void 0x0:_0x5ef1e3[_0x3a9914(0x19c)])==='hd'?0x4:0x2;await this[_0x3a9914(0x18f)]['validateBalance'](_0x34c5a2,_0x3a9914(0x12e),_0x1b8164);let _0x12df6f=[];const _0x1d13cc=await this[_0x3a9914(0x1e9)]['getCurrentModelKeyInfo'](_0x3a9914(0x1ef)),_0x1c6baa=_0x1d13cc===null||_0x1d13cc===void 0x0?void 0x0:_0x1d13cc['id'],{key:_0x4162eb,proxyResUrl:_0x5404d1}=await this[_0x3a9914(0x1cf)](_0x1d13cc);common_1[_0x3a9914(0x135)][_0x3a9914(0x17f)](_0x3a9914(0x141)+_0x5ef1e3[_0x3a9914(0x1f4)]+',\x20key\x20===>\x20'+_0x4162eb,_0x3a9914(0x187));try{const _0x3a49ff=_0x5404d1+_0x3a9914(0x1aa),_0x4e2e98=Object[_0x3a9914(0x102)](Object['assign']({},_0x5ef1e3),{'model':_0x3a9914(0x1ef)});console[_0x3a9914(0x17f)](_0x3a9914(0x1a8),_0x4e2e98);const _0x3dbf6d=await axios_1[_0x3a9914(0x1f6)][_0x3a9914(0x174)](_0x3a49ff,Object['assign'](Object[_0x3a9914(0x102)]({},_0x4e2e98),{'response_format':_0x3a9914(0x19b)}),{'headers':{'Authorization':_0x3a9914(0x132)+_0x4162eb}});_0x12df6f=_0x3dbf6d['data']['data'];const _0x142281=[];for(const _0x4b678c of _0x12df6f){const _0x4b665a=uuid['v4']()[_0x3a9914(0x1b8)](0x0,0xa)+_0x3a9914(0x170),_0x3e6880=Buffer[_0x3a9914(0x10c)](_0x4b678c[_0x3a9914(0x19b)],'base64');_0x142281[_0x3a9914(0x1f0)](this[_0x3a9914(0x203)][_0x3a9914(0x1f8)]({'filename':_0x4b665a,'buffer':_0x3e6880}));}const _0x3a71c1=await Promise[_0x3a9914(0x108)](_0x142281);await this['userBalanceService'][_0x3a9914(0x13c)](_0x34c5a2[_0x3a9914(0x11a)]['id'],_0x3a9914(0x12e),(_0x4e2e98===null||_0x4e2e98===void 0x0?void 0x0:_0x4e2e98[_0x3a9914(0x19c)])===_0x3a9914(0x1e0)?0x2:0x4,_0x1b8164);const _0x2ae594=(0x0,utils_1[_0x3a9914(0x1af)])(_0x34c5a2),_0x45c942=[],_0x55e373=await this['uploadService'][_0x3a9914(0x10f)](),[_0x507f40,_0x2bcb57]=_0x5ef1e3[_0x3a9914(0x157)]['split']('x');return _0x3a71c1[_0x3a9914(0x1bc)](_0x81a9c8=>{const _0x11ad0a=_0x3a9914;_0x45c942[_0x11ad0a(0x1f0)](this[_0x11ad0a(0x119)][_0x11ad0a(0x129)]({'curIp':_0x2ae594,'userId':_0x34c5a2['user']['id'],'type':balance_constant_1[_0x11ad0a(0x162)][_0x11ad0a(0x206)],'prompt':_0x5ef1e3[_0x11ad0a(0x1f4)],'answer':_0x81a9c8,'fileInfo':JSON['stringify']({'cosType':_0x55e373,'width':_0x507f40,'height':_0x2bcb57,'cosUrl':_0x81a9c8}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x11ad0a(0x1ef)}));}),await Promise[_0x3a9914(0x108)](_0x45c942),_0x3a71c1;}catch(_0x309393){const _0x565417=((_0x8df6fb=_0x309393===null||_0x309393===void 0x0?void 0x0:_0x309393[_0x3a9914(0x1e2)])===null||_0x8df6fb===void 0x0?void 0x0:_0x8df6fb['status'])||0x1f4;console[_0x3a9914(0x17f)]('openai-draw\x20error:\x20',JSON['stringify'](_0x309393),_0x4162eb,_0x565417);const _0x3cff1e=(_0x414e83=(_0x439905=(_0x21f9e7=_0x309393===null||_0x309393===void 0x0?void 0x0:_0x309393[_0x3a9914(0x1e2)])===null||_0x21f9e7===void 0x0?void 0x0:_0x21f9e7[_0x3a9914(0x205)])===null||_0x439905===void 0x0?void 0x0:_0x439905['error'])===null||_0x414e83===void 0x0?void 0x0:_0x414e83['message'];if(_0x565417===0x1ad)throw new common_1[(_0x3a9914(0x1e4))](_0x3a9914(0x178),common_1[_0x3a9914(0x161)][_0x3a9914(0x1fb)]);if(_0x565417===0x190&&_0x3cff1e[_0x3a9914(0x146)](_0x3a9914(0x19a)))throw new common_1[(_0x3a9914(0x1e4))](_0x3a9914(0x177),common_1[_0x3a9914(0x161)]['BAD_REQUEST']);if(_0x565417===0x190&&_0x3cff1e[_0x3a9914(0x146)]('Billing\x20hard\x20limit\x20has\x20been\x20reached')){await this['modelsService'][_0x3a9914(0x115)](_0x1c6baa,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1);throw new common_1['HttpException'](_0x3a9914(0x1d8),common_1[_0x3a9914(0x161)][_0x3a9914(0x1fb)]);}if(_0x565417===0x1f4)throw new common_1[(_0x3a9914(0x1e4))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x3a9914(0x161)]['BAD_REQUEST']);if(_0x565417===0x191)throw new common_1['HttpException'](_0x3a9914(0x175),common_1[_0x3a9914(0x161)][_0x3a9914(0x1fb)]);throw new common_1['HttpException'](_0x3a9914(0x14a),common_1[_0x3a9914(0x161)]['BAD_REQUEST']);}}async[_0x33c984(0x109)](){const _0x2cced4=_0x33c984,_0x1b1f4e=await this['gptKeysEntity'][_0x2cced4(0x145)]({'where':{'status':0x1},'select':['id','key',_0x2cced4(0x1da),'model',_0x2cced4(0x194),'maxResponseTokens','openaiProxyUrl','openaiTimeoutMs']}),_0x5c0224=_0x1b1f4e[_0x2cced4(0x11d)](_0x1e16e1=>_0x1e16e1[_0x2cced4(0x18d)][_0x2cced4(0x146)](_0x2cced4(0x189))),_0x1c25da=_0x1b1f4e[_0x2cced4(0x11d)](_0x5d64fa=>_0x5d64fa[_0x2cced4(0x18d)]['includes'](_0x2cced4(0x13d)));this[_0x2cced4(0x123)]={'list3':_0x5c0224,'list4':_0x1c25da};}async['getModelProxyUrl'](_0x5d9ac8){const _0x262af6=_0x33c984,_0x215ddf=await this[_0x262af6(0x1f2)][_0x262af6(0x12c)]([_0x262af6(0x1d7)]);return(_0x5d9ac8===null||_0x5d9ac8===void 0x0?void 0x0:_0x5d9ac8[_0x262af6(0x182)])||_0x215ddf||'https://api.openai.com';}async[_0x33c984(0x1cf)](_0xb5584c){const _0xf4f277=_0x33c984,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0xf4f277(0x1f2)][_0xf4f277(0x12c)]([_0xf4f277(0x1e3),_0xf4f277(0x1ac),_0xf4f277(0x13a),'openaiModel3MaxTokens16kRes',_0xf4f277(0x12f),_0xf4f277(0x199),_0xf4f277(0x13e),'openaiModel4MaxTokens32kRes',_0xf4f277(0x1d7)]);let _0xc11c4c=null,_0x401791=null,_0x429d97=null,{model:_0x200c78,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x50f6be}=_0xb5584c;return _0x200c78['toLowerCase']()[_0xf4f277(0x146)](_0xf4f277(0x13d))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x401791>=0x1000&&(maxModelTokens=0x1000),_0xc11c4c=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x401791=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x200c78[_0xf4f277(0x143)]()['includes'](_0xf4f277(0x1ca))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x401791>=0x4000&&(maxModelTokens=0x4000),_0xc11c4c=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x401791=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x200c78[_0xf4f277(0x143)]()['includes'](_0xf4f277(0x1e7))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x401791>=0x1000&&(maxModelTokens=0x1000),_0xc11c4c=maxModelTokens||0x3ffc,_0x401791=maxResponseTokens||0x1000)),_0x200c78[_0xf4f277(0x143)]()['includes']('gpt-3')&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x401791>=0x7d0&&(maxModelTokens=0x7d0),_0xc11c4c=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x401791=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x200c78[_0xf4f277(0x143)]()['includes'](_0xf4f277(0x1c7))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x401791>=0x2000&&(maxModelTokens=0x2000),_0xc11c4c=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x401791=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x200c78[_0xf4f277(0x143)]()['includes'](_0xf4f277(0x1e7))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x401791>=0x1000&&(maxModelTokens=0x1000),_0xc11c4c=maxModelTokens||0x4000,_0x401791=maxResponseTokens||0x1000)),_0x429d97=proxyUrl||openaiBaseUrl||'https://api.openai.com',_0x401791>=_0xc11c4c&&(_0x401791=Math[_0xf4f277(0x169)](_0xc11c4c/0x2)),{'key':_0x50f6be,'maxToken':_0xc11c4c,'maxTokenRes':_0x401791,'proxyResUrl':_0x429d97};}async[_0x33c984(0x197)](_0x8725d8,_0x1c8216){const _0x3a1f9f=_0x33c984;try{const {name:_0x31fafb,icon:_0x3d3cef,order:_0x104d92,id:_0x1702e0,status:_0x4a20ea}=_0x1c8216;return _0x1702e0?await this[_0x3a1f9f(0x20a)][_0x3a1f9f(0x138)]({'id':_0x1702e0},{'name':_0x31fafb,'icon':_0x3d3cef,'order':_0x104d92,'status':_0x4a20ea}):await this[_0x3a1f9f(0x20a)]['save']({'name':_0x31fafb,'icon':_0x3d3cef,'order':_0x104d92,'status':_0x4a20ea});}catch(_0x25bcb8){console[_0x3a1f9f(0x17f)](_0x3a1f9f(0x136),_0x25bcb8);}}async[_0x33c984(0x201)](_0x517f30,_0x2a48ed){const _0xd62025=_0x33c984,{id:_0x371d3b}=_0x2a48ed;if(!_0x371d3b)throw new common_1['HttpException']('非法操作！',common_1['HttpStatus'][_0xd62025(0x1fb)]);const _0x4b4049=await this['chatBoxEntity'][_0xd62025(0x101)]({'where':{'typeId':_0x371d3b}});if(_0x4b4049)throw new common_1[(_0xd62025(0x1e4))](_0xd62025(0x1be),common_1[_0xd62025(0x161)][_0xd62025(0x1fb)]);return await this[_0xd62025(0x20a)][_0xd62025(0x125)]({'id':_0x371d3b});}async[_0x33c984(0x103)](){const _0x457c83=_0x33c984;return await this['chatBoxTypeEntity'][_0x457c83(0x145)]({'order':{'order':'DESC'}});}async[_0x33c984(0x104)](_0x3e453f,_0x328979){const _0x3bb6f5=_0x33c984,{title:_0xbb9f88,prompt:_0x5ce9b0,appId:_0x3e1a72,order:_0xfc2caf,status:_0x152186,typeId:_0x471b75,id:_0x5223fb,url:_0x42a562}=_0x328979;if(!_0x471b75)throw new common_1['HttpException'](_0x3bb6f5(0x185),common_1[_0x3bb6f5(0x161)][_0x3bb6f5(0x1fb)]);try{const _0x156e16={'title':_0xbb9f88,'order':_0xfc2caf,'status':_0x152186,'typeId':_0x471b75,'url':_0x42a562};return _0x156e16[_0x3bb6f5(0x188)]=_0x3e1a72||0x0,_0x156e16[_0x3bb6f5(0x1f4)]=_0x5ce9b0||'',_0x5223fb?await this['chatBoxEntity'][_0x3bb6f5(0x138)]({'id':_0x5223fb},_0x156e16):await this['chatBoxEntity'][_0x3bb6f5(0x116)](_0x156e16);}catch(_0x1429a9){console[_0x3bb6f5(0x17f)](_0x3bb6f5(0x136),_0x1429a9);}}async[_0x33c984(0x1dc)](_0x238cf2,_0x30cf95){const _0x8b66d1=_0x33c984,{id:_0x272f66}=_0x30cf95;if(!_0x272f66)throw new common_1[(_0x8b66d1(0x1e4))](_0x8b66d1(0x1ea),common_1[_0x8b66d1(0x161)]['BAD_REQUEST']);return await this['chatBoxEntity'][_0x8b66d1(0x125)]({'id':_0x272f66});}async[_0x33c984(0x121)](){const _0xd4ef46=_0x33c984,_0x255eaa=await this['chatBoxEntity'][_0xd4ef46(0x145)]({'order':{'order':_0xd4ef46(0x1a5)}}),_0x231579=[...new Set(_0x255eaa[_0xd4ef46(0x1a4)](_0x34eb88=>_0x34eb88[_0xd4ef46(0x193)]))],_0x2fdc6e=[...new Set(_0x255eaa[_0xd4ef46(0x1a4)](_0x5b8782=>_0x5b8782[_0xd4ef46(0x188)]))],_0x44b110=await this[_0xd4ef46(0x20a)][_0xd4ef46(0x145)]({'where':{'id':(0x0,typeorm_1['In'])(_0x231579)}}),_0x572acd=await this['appEntity'][_0xd4ef46(0x145)]({'where':{'id':(0x0,typeorm_1['In'])(_0x2fdc6e)}});return _0x255eaa[_0xd4ef46(0x1a4)](_0x453494=>{const _0x300439=_0xd4ef46,{typeId:_0x3cb7f0,appId:_0x541068}=_0x453494;return _0x453494['typeInfo']=_0x44b110[_0x300439(0x145)](_0x21ce59=>_0x21ce59['id']===_0x3cb7f0),_0x453494[_0x300439(0x1d2)]=_0x572acd[_0x300439(0x145)](_0x289388=>_0x289388['id']===_0x541068),_0x453494;});}async[_0x33c984(0x155)](){const _0x2b8b15=_0x33c984,_0x434d2c=await this[_0x2b8b15(0x20a)][_0x2b8b15(0x145)]({'order':{'order':_0x2b8b15(0x1a5)},'where':{'status':!![]}}),_0x5bced7=await this[_0x2b8b15(0x180)][_0x2b8b15(0x145)]({'where':{'status':!![]}}),_0x49f2e1=[...new Set(_0x5bced7[_0x2b8b15(0x1a4)](_0x201af9=>_0x201af9[_0x2b8b15(0x188)]))],_0x51b1ee=await this[_0x2b8b15(0x12b)][_0x2b8b15(0x145)]({'where':{'id':(0x0,typeorm_1['In'])(_0x49f2e1)}});return _0x5bced7[_0x2b8b15(0x1bc)](_0x4e9659=>{const _0x18ce3d=_0x2b8b15,_0x1290d1=_0x51b1ee[_0x18ce3d(0x145)](_0x3be325=>_0x3be325['id']===_0x4e9659[_0x18ce3d(0x188)]);return _0x4e9659[_0x18ce3d(0x111)]=_0x1290d1===null||_0x1290d1===void 0x0?void 0x0:_0x1290d1[_0x18ce3d(0x111)],_0x4e9659;}),_0x434d2c[_0x2b8b15(0x1a4)](_0x322438=>{const _0x2d54c0=_0x2b8b15;return _0x322438[_0x2d54c0(0x17a)]=_0x5bced7['filter'](_0x2edaef=>_0x2edaef[_0x2d54c0(0x193)]===_0x322438['id']&&_0x2edaef['status']),_0x322438;});}async[_0x33c984(0x16d)](_0x2c472b,_0x31483d){const _0x498be3=_0x33c984;try{const {name:_0x520d26,icon:_0x1e79c6,order:_0x126eed,id:_0x5f32dc,status:_0x1d5570}=_0x31483d;return _0x5f32dc?await this[_0x498be3(0x20d)][_0x498be3(0x138)]({'id':_0x5f32dc},{'name':_0x520d26,'icon':_0x1e79c6,'order':_0x126eed,'status':_0x1d5570}):await this[_0x498be3(0x20d)]['save']({'name':_0x520d26,'icon':_0x1e79c6,'order':_0x126eed,'status':_0x1d5570});}catch(_0x21d4a4){console[_0x498be3(0x17f)](_0x498be3(0x136),_0x21d4a4);}}async[_0x33c984(0x137)](_0x2eb74c,_0x3b5b72){const _0x43ae03=_0x33c984,{id:_0x48ca88}=_0x3b5b72;if(!_0x48ca88)throw new common_1[(_0x43ae03(0x1e4))](_0x43ae03(0x1ea),common_1[_0x43ae03(0x161)]['BAD_REQUEST']);const _0xa79f25=await this[_0x43ae03(0x180)][_0x43ae03(0x101)]({'where':{'typeId':_0x48ca88}});if(_0xa79f25)throw new common_1[(_0x43ae03(0x1e4))]('当前分类下有未处理数据不可移除！',common_1[_0x43ae03(0x161)][_0x43ae03(0x1fb)]);return await this[_0x43ae03(0x20d)][_0x43ae03(0x125)]({'id':_0x48ca88});}async['queryChatPreType'](){const _0x41bd55=_0x33c984;return await this[_0x41bd55(0x20d)][_0x41bd55(0x145)]({'order':{'order':_0x41bd55(0x1a5)}});}async[_0x33c984(0x124)](_0x12fac5,_0x595fb4){const _0x5c21a1=_0x33c984,{title:_0x46ae5d,prompt:_0xd91c21,appId:_0x4cfd3f,order:_0x283540,status:_0x5df46e,typeId:_0x48cad4,id:_0x114f09,url:_0x1ea7f6}=_0x595fb4;if(!_0x48cad4)throw new common_1[(_0x5c21a1(0x1e4))](_0x5c21a1(0x185),common_1[_0x5c21a1(0x161)][_0x5c21a1(0x1fb)]);try{const _0x3990b8={'title':_0x46ae5d,'prompt':_0xd91c21,'order':_0x283540,'status':_0x5df46e,'typeId':_0x48cad4,'url':_0x1ea7f6};return _0x114f09?await this['chatPreEntity'][_0x5c21a1(0x138)]({'id':_0x114f09},_0x3990b8):await this[_0x5c21a1(0x19d)][_0x5c21a1(0x116)](_0x3990b8);}catch(_0x4aa964){console[_0x5c21a1(0x17f)]('error:\x20',_0x4aa964);}}async[_0x33c984(0x105)](_0x30e67c,_0x44b0bc){const _0x51d5ec=_0x33c984,{id:_0x56de3a}=_0x44b0bc;if(!_0x56de3a)throw new common_1[(_0x51d5ec(0x1e4))]('非法操作！',common_1[_0x51d5ec(0x161)][_0x51d5ec(0x1fb)]);return await this[_0x51d5ec(0x19d)][_0x51d5ec(0x125)]({'id':_0x56de3a});}async['queryChatPre'](){const _0x3ac1a8=_0x33c984,_0x543d75=await this[_0x3ac1a8(0x19d)][_0x3ac1a8(0x145)]({'order':{'order':_0x3ac1a8(0x1a5)}}),_0x4cd7ff=[...new Set(_0x543d75[_0x3ac1a8(0x1a4)](_0x22c488=>_0x22c488[_0x3ac1a8(0x193)]))],_0x1c7d5a=await this[_0x3ac1a8(0x20d)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x4cd7ff)}});return _0x543d75[_0x3ac1a8(0x1a4)](_0x4500f5=>{const _0x2bf410=_0x3ac1a8,{typeId:_0x1d05e1,appId:_0x2d069d}=_0x4500f5;return _0x4500f5['typeInfo']=_0x1c7d5a[_0x2bf410(0x145)](_0x300320=>_0x300320['id']===_0x1d05e1),_0x4500f5;});}async[_0x33c984(0x1cb)](){const _0x57cfd7=_0x33c984,_0x3943ed=await this[_0x57cfd7(0x20d)]['find']({'order':{'order':_0x57cfd7(0x1a5)},'where':{'status':!![]}}),_0x246c44=await this['chatPreEntity'][_0x57cfd7(0x145)]({'where':{'status':!![]}});return _0x3943ed[_0x57cfd7(0x1a4)](_0x1a4b4e=>{const _0x11d2b1=_0x57cfd7;return _0x1a4b4e[_0x11d2b1(0x17a)]=_0x246c44[_0x11d2b1(0x11d)](_0x44dd8a=>_0x44dd8a[_0x11d2b1(0x193)]===_0x1a4b4e['id']&&_0x44dd8a[_0x11d2b1(0x1cc)]),_0x1a4b4e;});}async[_0x33c984(0x167)](_0x38f9ce,_0x44013b,_0x312533){const _0x2b73b6=_0x33c984;let _0x2f0778=0x1000,_0x5eb290=0x800;return _0x38f9ce[_0x2b73b6(0x143)]()['includes'](_0x2b73b6(0x13d))&&(_0x2f0778=_0x44013b>=0x2004?0x2004:_0x44013b,_0x5eb290=_0x312533>=0x1000?0x1000:_0x312533,_0x38f9ce[_0x2b73b6(0x143)]()[_0x2b73b6(0x146)](_0x2b73b6(0x1ca))&&(_0x2f0778=_0x44013b>=0x8000?0x8000:_0x44013b,_0x5eb290=_0x312533>=0x3e80?0x3e80:_0x312533),(_0x38f9ce[_0x2b73b6(0x143)]()[_0x2b73b6(0x146)](_0x2b73b6(0x1d3))||_0x38f9ce['toLowerCase']()[_0x2b73b6(0x146)](_0x2b73b6(0x184)))&&(_0x2f0778=_0x44013b>=0x1f400?0x1f400:_0x44013b,_0x5eb290=_0x312533>=0x1000?0x1000:_0x312533)),_0x38f9ce[_0x2b73b6(0x143)]()['includes'](_0x2b73b6(0x189))&&(_0x2f0778=_0x44013b>=0x1000?0x1000:_0x44013b,_0x5eb290=_0x312533>=0x800?0x800:_0x312533,_0x38f9ce[_0x2b73b6(0x143)]()[_0x2b73b6(0x146)](_0x2b73b6(0x1c7))&&(_0x2f0778=_0x44013b>=0x4000?0x4000:_0x44013b,_0x5eb290=_0x312533>=0x1f40?0x1f40:_0x312533),_0x38f9ce[_0x2b73b6(0x143)]()['includes'](_0x2b73b6(0x1e7))&&(_0x2f0778=_0x44013b>=0x4000?0x4000:_0x44013b,_0x5eb290=_0x312533>=0x1f40?0x1f40:_0x312533)),{'maxToken':_0x2f0778,'maxRes':_0x5eb290};}};ChatgptService=__decorate([(0x0,common_1[_0x33c984(0x18e)])(),__param(0x0,(0x0,typeorm_2[_0x33c984(0x10b)])(gptkeys_entity_1['GptKeysEntity'])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x2,(0x0,typeorm_2[_0x33c984(0x10b)])(chatBoxType_entity_1[_0x33c984(0x1ec)])),__param(0x3,(0x0,typeorm_2[_0x33c984(0x10b)])(chatBox_entity_1[_0x33c984(0x1a2)])),__param(0x4,(0x0,typeorm_2[_0x33c984(0x10b)])(app_entity_1[_0x33c984(0x1d6)])),__param(0x5,(0x0,typeorm_2[_0x33c984(0x10b)])(chatPreType_entity_1[_0x33c984(0x150)])),__param(0x6,(0x0,typeorm_2[_0x33c984(0x10b)])(chatPre_entity_1['ChatPreEntity'])),__metadata(_0x33c984(0x16f),[typeorm_1[_0x33c984(0x112)],typeorm_1[_0x33c984(0x112)],typeorm_1[_0x33c984(0x112)],typeorm_1[_0x33c984(0x112)],typeorm_1[_0x33c984(0x112)],typeorm_1[_0x33c984(0x112)],typeorm_1[_0x33c984(0x112)],nestjs_config_1[_0x33c984(0x1e1)],userBalance_service_1[_0x33c984(0x204)],chatLog_service_1[_0x33c984(0x17c)],user_service_1[_0x33c984(0x20e)],upload_service_1[_0x33c984(0x1f3)],badwords_service_1[_0x33c984(0x11e)],autoreply_service_1[_0x33c984(0x186)],globalConfig_service_1[_0x33c984(0x1f7)],fanyi_service_1[_0x33c984(0x14b)],chatGroup_service_1[_0x33c984(0x14c)],models_service_1[_0x33c984(0x1eb)]])],ChatgptService),exports[_0x33c984(0x120)]=ChatgptService;