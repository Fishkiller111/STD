'use strict';const _0x28bf85=_0x107a;function _0x107a(_0x40194f,_0x2e952a){const _0x19888d=_0x1988();return _0x107a=function(_0x107a27,_0x4e2162){_0x107a27=_0x107a27-0x15f;let _0x450d90=_0x19888d[_0x107a27];return _0x450d90;},_0x107a(_0x40194f,_0x2e952a);}(function(_0x37df3a,_0x39f6ff){const _0x15d830=_0x107a,_0x1a8a2a=_0x37df3a();while(!![]){try{const _0x5393ac=-parseInt(_0x15d830(0x177))/0x1+-parseInt(_0x15d830(0x226))/0x2+-parseInt(_0x15d830(0x1e2))/0x3*(parseInt(_0x15d830(0x1a7))/0x4)+parseInt(_0x15d830(0x1dd))/0x5*(-parseInt(_0x15d830(0x185))/0x6)+-parseInt(_0x15d830(0x16f))/0x7*(-parseInt(_0x15d830(0x1de))/0x8)+parseInt(_0x15d830(0x21c))/0x9+parseInt(_0x15d830(0x228))/0xa;if(_0x5393ac===_0x39f6ff)break;else _0x1a8a2a['push'](_0x1a8a2a['shift']());}catch(_0x280155){_0x1a8a2a['push'](_0x1a8a2a['shift']());}}}(_0x1988,0x580cb));var __decorate=this&&this['__decorate']||function(_0x2b7f44,_0x58e59f,_0x3948c7,_0x1cc504){const _0x1e29cc=_0x107a;var _0x36fff0=arguments[_0x1e29cc(0x1b3)],_0x2ea0a7=_0x36fff0<0x3?_0x58e59f:_0x1cc504===null?_0x1cc504=Object['getOwnPropertyDescriptor'](_0x58e59f,_0x3948c7):_0x1cc504,_0x1e9f35;if(typeof Reflect===_0x1e29cc(0x209)&&typeof Reflect[_0x1e29cc(0x194)]===_0x1e29cc(0x1af))_0x2ea0a7=Reflect[_0x1e29cc(0x194)](_0x2b7f44,_0x58e59f,_0x3948c7,_0x1cc504);else{for(var _0x1a12a8=_0x2b7f44[_0x1e29cc(0x1b3)]-0x1;_0x1a12a8>=0x0;_0x1a12a8--)if(_0x1e9f35=_0x2b7f44[_0x1a12a8])_0x2ea0a7=(_0x36fff0<0x3?_0x1e9f35(_0x2ea0a7):_0x36fff0>0x3?_0x1e9f35(_0x58e59f,_0x3948c7,_0x2ea0a7):_0x1e9f35(_0x58e59f,_0x3948c7))||_0x2ea0a7;}return _0x36fff0>0x3&&_0x2ea0a7&&Object[_0x1e29cc(0x1e6)](_0x58e59f,_0x3948c7,_0x2ea0a7),_0x2ea0a7;},__metadata=this&&this[_0x28bf85(0x1fd)]||function(_0x53486a,_0x1b15ad){const _0x119492=_0x28bf85;if(typeof Reflect===_0x119492(0x209)&&typeof Reflect[_0x119492(0x25d)]==='function')return Reflect['metadata'](_0x53486a,_0x1b15ad);},__param=this&&this[_0x28bf85(0x205)]||function(_0x5ae388,_0x3365ef){return function(_0x523c71,_0x25e56c){_0x3365ef(_0x523c71,_0x25e56c,_0x5ae388);};};function _0x1988(){const _0x46de81=['map','当前分类下有未处理数据不可移除！','update','assign','ChatLogService','buildMessageFromParentMessageId','UploadService',',\x20消耗积分：\x20','error:\x20','application/octet-stream;\x20charset=utf-8','env','systemPreMessage','autoreplyService','design:paramtypes','nineai-chatlog','ChatgptService','dall-e\x20draw\x20params:\x20','statusText:','ConfigEntity','./baidu','checkBadWords','./zhipu','checkUserStatus','Injectable','axios','nineStore','default','提供了错误的模型秘钥',',\x20消耗token:\x20','chatLogService','standard','UserService','BadwordsService','getRequestParams','UserBalanceService','removeSpecialCharacters','sendMessageFromOpenAi','validateBalance','keyPool','./chatPreType.entity','size','whiteListUser','systemMessage','ModelsService','./chatBoxType.entity','delChatPre','chatSyncFree','metadata','./chatPre.entity','Repository','openaiModel4MaxTokensRes','text','push','当前模型key余额已耗尽','dall-e-3','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','Content-type','userService','FanyiService','../chatGroup/chatGroup.service','setChatBoxType','checkAutoReply','HttpStatus','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','prompt','data','end','gpt-4','childList','debug','1271263BhTuLr','uploadService','importDynamic','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','getClientIp','openaiModel4MaxTokens32kRes','../fanyi/fanyi.service','../app/app.entity','92211AGVYWE','userBalanceService','assistant','write','openaiProxyUrl','../models/models.service','REDIS_PASSWORD','1106','model4','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','delChatBox','./gptkeys.entity','sendMessageFromBaidu','maxResponseTokens','6YlPgYs','CHAT_TYPE','queryChatBox','./chatBox.entity','formatModelToken','getGroupInfoFromId','\x20模型名称:\x20','gpt-3','imageUrl','REDIS_HOST','Billing\x20hard\x20limit\x20has\x20been\x20reached','chatPreEntity','getRandomDrawKey','parse','addOneIfOdd','decorate','BAD_REQUEST','ChatBoxEntity','../userBalance/userBalance.service','response','stringify','nestjs-config','message','ChatGroupService','usage','delChatBoxType','typeInfo','preset','saveUseLog','sendMessageFromZhipu','toISOString','./../user/user.service','key','model','12OtzRwb','queryChatBoxFrontend','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','find','gpt-4-1106','getAllKeyList','redis://','\x0a\x20Current\x20date:\x20','function','b64_json','save','statusCode','length','chatBoxEntity','from','proxyUrl','abort','setChatPre','setData','chat-error-detail\x20\x20<----------------------------------------->','REDIS_PORT','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','toLowerCase','REDIS_USER','chatPreTypeEntity','getUuid','chatGroupService','getTokenCount','缺失必要参数！','GlobalConfigService','../globalConfig/config.entity','all','HttpException','PAINT_TYPE','lockKey','delete','getModelProxyUrl','非法操作！','compileNetwork','chatgpt-ai-web','chat-error\x20<----------------------------------------->','floor','appInfo','../../common/utils','is_end','../../common/constants/errorMessage.constant','deductFromBalance','Incorrect\x20API\x20key\x20provided','uuid','detail','count','split','getBaseConfig','OpenAiErrorCodeMessage','3521595qSHbqF','24Lkdlee','globalConfigService','getConfigs','400\x20error','509289RWBOQX','https://api.openai.com','16k','../autoreply/autoreply.service','defineProperty','当前请求已过载、请稍等会儿再试试吧！','Please\x20check\x20the\x20back-end\x20console','chatBoxTypeEntity','@nestjs/common','PAYMENT_REQUIRED','./store','modelsService','用户ID:\x20','mjDraw','includes','chatProcess','openaiTimeoutMs','setChatPreType','queryChatPreList','badwordsService','@nestjs/typeorm','openaiBaseUrl','appId','NineStore','DeductionKey','modelInfo','fanyiService','__metadata','filter','AppEntity','ceil','coverImg','base64','Too\x20Many\x20Requests','服务异常、请重新试试吧！！！','__param','conversationId','../globalConfig/globalConfig.service','queryChatBoxType','object','openaiModel3MaxTokens16kRes','Catch\x20Error\x20','log','/v1/images/generations','appEntity','../../common/constants/balance.constant','result','forEach','gpt-4-vision-preview','.png','InjectRepository','../chatLog/chatLog.service','setChatBox','saveChatLog',',\x20key\x20===>\x20','status','DESC','typeId','1180899qnwjNe','draw','slice','@keyv/redis','dall','statusText','Logger','setHeader','error','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','655838XMOrwt','config','13183510CURseh','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','ChatPreEntity','findOne','user','gptKeysEntity'];_0x1988=function(){return _0x46de81;};return _0x1988();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x28bf85(0x23d)]=void 0x0;const upload_service_1=require('./../upload/upload.service'),user_service_1=require(_0x28bf85(0x1a4)),nestjs_config_1=require(_0x28bf85(0x19a)),common_1=require(_0x28bf85(0x1ea)),errorMessage_constant_1=require(_0x28bf85(0x1d4)),utils_1=require(_0x28bf85(0x1d2)),axios_1=require(_0x28bf85(0x246)),userBalance_service_1=require(_0x28bf85(0x197)),balance_constant_1=require(_0x28bf85(0x20f)),chatLog_service_1=require(_0x28bf85(0x215)),uuid=require(_0x28bf85(0x1d7)),config_entity_1=require(_0x28bf85(0x1c5)),typeorm_1=require('typeorm'),typeorm_2=require(_0x28bf85(0x1f6)),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require(_0x28bf85(0x1e5)),gptkeys_entity_1=require(_0x28bf85(0x182)),globalConfig_service_1=require(_0x28bf85(0x207)),fanyi_service_1=require(_0x28bf85(0x175)),app_entity_1=require(_0x28bf85(0x176)),chatGroup_service_1=require(_0x28bf85(0x164)),models_service_1=require(_0x28bf85(0x17c)),baidu_1=require(_0x28bf85(0x241)),helper_1=require('./helper'),store_1=require(_0x28bf85(0x1ec)),zhipu_1=require(_0x28bf85(0x243)),openai_1=require('./openai'),chatBoxType_entity_1=require(_0x28bf85(0x25a)),chatBox_entity_1=require(_0x28bf85(0x188)),chatPre_entity_1=require(_0x28bf85(0x25e)),chatPreType_entity_1=require(_0x28bf85(0x255));let ChatgptService=class ChatgptService{constructor(_0x48c86e,_0x54407f,_0x1c63e6,_0x34a784,_0x573418,_0x2156a6,_0x50affa,_0x2a37a6,_0x3f3aec,_0x4810e1,_0x5129d3,_0x2620e3,_0x122e77,_0x4c77db,_0x1d3818,_0x5820da,_0x4016bf,_0x43cef9){const _0x348a96=_0x28bf85;this[_0x348a96(0x22d)]=_0x48c86e,this['configEntity']=_0x54407f,this[_0x348a96(0x1e9)]=_0x1c63e6,this[_0x348a96(0x1b4)]=_0x34a784,this['appEntity']=_0x573418,this[_0x348a96(0x1bf)]=_0x2156a6,this[_0x348a96(0x190)]=_0x50affa,this['configService']=_0x2a37a6,this[_0x348a96(0x178)]=_0x3f3aec,this[_0x348a96(0x24b)]=_0x4810e1,this[_0x348a96(0x162)]=_0x5129d3,this[_0x348a96(0x170)]=_0x2620e3,this['badwordsService']=_0x122e77,this['autoreplyService']=_0x4c77db,this[_0x348a96(0x1df)]=_0x1d3818,this[_0x348a96(0x1fc)]=_0x5820da,this['chatGroupService']=_0x4016bf,this[_0x348a96(0x1ed)]=_0x43cef9,this[_0x348a96(0x247)]=null,this[_0x348a96(0x257)]=[],this[_0x348a96(0x254)]={'list3':[],'list4':[]};}async['onModuleInit'](){const _0x28daeb=_0x28bf85;let _0x522221=await(0x0,utils_1[_0x28daeb(0x171)])(_0x28daeb(0x1ce)),_0x3b618d=await(0x0,utils_1[_0x28daeb(0x171)])(_0x28daeb(0x21f)),_0x350c22=await(0x0,utils_1['importDynamic'])('keyv');_0x522221=(_0x522221===null||_0x522221===void 0x0?void 0x0:_0x522221[_0x28daeb(0x248)])?_0x522221[_0x28daeb(0x248)]:_0x522221,_0x3b618d=(_0x3b618d===null||_0x3b618d===void 0x0?void 0x0:_0x3b618d[_0x28daeb(0x248)])?_0x3b618d[_0x28daeb(0x248)]:_0x3b618d,_0x350c22=(_0x350c22===null||_0x350c22===void 0x0?void 0x0:_0x350c22[_0x28daeb(0x248)])?_0x350c22[_0x28daeb(0x248)]:_0x350c22;const {ChatGPTAPI:_0x587194,ChatGPTError:_0x2c3ecb,ChatGPTUnofficialProxyAPI:_0x52b9c3}=_0x522221,_0x3edec1=+process[_0x28daeb(0x238)][_0x28daeb(0x1bb)],_0x1ed4ba=process[_0x28daeb(0x238)][_0x28daeb(0x18e)],_0x32aa9b=process[_0x28daeb(0x238)][_0x28daeb(0x17d)],_0x51c880=process['env'][_0x28daeb(0x1be)],_0xee2e9f=_0x28daeb(0x1ad)+(_0x51c880||'')+':'+(_0x32aa9b||'')+'@'+_0x1ed4ba+':'+_0x3edec1,_0x15e14=new _0x3b618d(_0xee2e9f),_0x10044c=new _0x350c22({'store':_0x15e14,'namespace':_0x28daeb(0x23c)});this[_0x28daeb(0x247)]=new store_1[(_0x28daeb(0x1f9))]({'store':_0x10044c,'namespace':'chat'});}async[_0x28bf85(0x24f)](_0x5e22e3,_0x182e25,_0x5784d5,_0x5e04ee=null){const _0x37cb18=_0x28bf85;var _0x543d82;!_0x5e04ee&&(_0x5e04ee=(_0x543d82=await this[_0x37cb18(0x1ed)][_0x37cb18(0x1db)]())===null||_0x543d82===void 0x0?void 0x0:_0x543d82[_0x37cb18(0x1fb)]);const {timeout:timeout=0x3c}=_0x5784d5,{topN:_0x11f8b4,model:_0x81a5aa}=_0x5e04ee,{parentMessageId:parentMessageId=0x0}=_0x5e22e3,_0x2c539e=await this['globalConfigService'][_0x37cb18(0x1e0)]([_0x37cb18(0x1f2)]),_0x1385b9=timeout*0x3e8||_0x2c539e||0x64*0x3e8,_0x583849={'parentMessageId':parentMessageId,'timeoutMs':+_0x1385b9,'completionParams':{'model':_0x81a5aa,'temperature':_0x11f8b4}};return _0x182e25&&(_0x583849[_0x37cb18(0x258)]=_0x182e25),_0x583849;}async[_0x28bf85(0x25c)](_0x2c0545){const _0x5ae1c0=_0x28bf85,_0x31aa3b=await this[_0x5ae1c0(0x1ed)][_0x5ae1c0(0x191)](),_0xd7f796=await this[_0x5ae1c0(0x1df)][_0x5ae1c0(0x1e0)]([_0x5ae1c0(0x239)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x1bdfd6,model:_0x227c0b}=_0x31aa3b,_0x5d4ceb=await this[_0x5ae1c0(0x1cb)](_0x31aa3b),{context:_0x1753dd}=await this['nineStore'][_0x5ae1c0(0x233)](_0x2c0545,{'parentMessageId':'','systemMessage':_0xd7f796});try{const _0x456656=await(0x0,openai_1[_0x5ae1c0(0x252)])(_0x1753dd,{'apiKey':(0x0,utils_1[_0x5ae1c0(0x251)])(_0x1bdfd6),'model':_0x227c0b,'proxyUrl':_0x5d4ceb,'onProgress':null});return _0x456656===null||_0x456656===void 0x0?void 0x0:_0x456656[_0x5ae1c0(0x261)];}catch(_0x389a3a){console[_0x5ae1c0(0x20c)](_0x5ae1c0(0x236),_0x389a3a);}}async[_0x28bf85(0x1f1)](_0x2dc396,_0x3d5d4d,_0x5a1597){const _0x22d510=_0x28bf85;var _0x4923c5,_0x32d642,_0x219e88,_0x581b9a;const _0x3af64e=_0x3d5d4d['abortController'],{options:options={},appId:_0x79275,cusromPrompt:_0x246ec8,systemMessage:systemMessage=''}=_0x2dc396;let _0x5dfb83=systemMessage;const {parentMessageId:_0x3693c2}=options,{prompt:_0x2cd353,imageUrl:_0x3b791c,model:_0xe3eb8b}=_0x2dc396,{groupId:_0x32394c,usingNetwork:_0x205c82}=options,_0x106d27=await this[_0x22d510(0x1c1)][_0x22d510(0x18a)](_0x32394c),_0x4c409a=(_0x106d27===null||_0x106d27===void 0x0?void 0x0:_0x106d27[_0x22d510(0x227)])?JSON[_0x22d510(0x192)](_0x106d27['config']):await this['modelsService'][_0x22d510(0x1db)](),{keyType:_0x3e5248,model:_0x288ac8,topN:_0x59ae60,systemMessage:_0x2f9ffe,rounds:_0x5e4cbf}=_0x4c409a['modelInfo'];let _0x20dfc0=null;!_0x246ec8?_0x20dfc0=await this[_0x22d510(0x1ed)]['getCurrentModelKeyInfo'](_0x288ac8):_0x20dfc0=await this['modelsService'][_0x22d510(0x191)]();if(!_0x20dfc0)throw new common_1['HttpException']('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1['HttpStatus'][_0x22d510(0x195)]);const {deduct:_0x5783b0,isTokenBased:_0x93c7ba,tokenFeeRatio:_0x1312db,deductType:_0x28299b,key:_0x1d888a,secret:_0x3ab1e6,modelName:_0x14414b,id:_0x2246ee,accessToken:_0x35176a}=_0x20dfc0;await this[_0x22d510(0x162)][_0x22d510(0x244)](_0x3d5d4d[_0x22d510(0x22c)]),await this[_0x22d510(0x178)]['validateBalance'](_0x3d5d4d,_0x28299b===0x1?'model3':_0x22d510(0x17f),_0x5783b0),_0x5a1597&&_0x5a1597[_0x22d510(0x223)](_0x22d510(0x161),_0x22d510(0x237)),await this['badwordsService'][_0x22d510(0x242)](_0x2cd353,_0x3d5d4d[_0x22d510(0x22c)]['id']);const _0xdc0c74=await this[_0x22d510(0x23a)][_0x22d510(0x166)](_0x2cd353);if(_0xdc0c74&&_0x5a1597){const _0x434e1a={'message':_0xdc0c74,'code':0x1f4};return _0x5a1597[_0x22d510(0x17a)](JSON[_0x22d510(0x199)](_0x434e1a)),_0x5a1597['end']();}if(_0x79275){const _0x110276=await this[_0x22d510(0x20e)][_0x22d510(0x22b)]({'where':{'id':_0x79275,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x110276)throw new common_1[(_0x22d510(0x1c7))](_0x22d510(0x229),common_1[_0x22d510(0x167)]['BAD_REQUEST']);_0x110276[_0x22d510(0x1a0)]&&(_0x5dfb83=_0x110276[_0x22d510(0x1a0)]);}else{if(_0x246ec8)_0x5dfb83=systemMessage;else{if(_0x2f9ffe)_0x5dfb83=_0x2f9ffe;else{const _0x3baed4=new Date()['toISOString']()[_0x22d510(0x1da)]('T')[0x0],_0x254a5b=await this[_0x22d510(0x1df)]['getConfigs'](['systemPreMessage']);_0x5dfb83=_0x254a5b+(_0x22d510(0x1ae)+_0x3baed4);}}}let _0x5b0a4f='';if(_0x205c82){_0x5b0a4f=await(0x0,utils_1[_0x22d510(0x1cd)])(_0x2cd353);const _0x2e3431=new Date()[_0x22d510(0x1a3)]()['split']('T')[0x0],_0x7df6ce=await this[_0x22d510(0x1df)][_0x22d510(0x1e0)]([_0x22d510(0x239)]);_0x5dfb83=_0x7df6ce+(_0x22d510(0x1ae)+_0x2e3431);}const _0x43a59f=await this[_0x22d510(0x24f)](options,_0x5dfb83,_0x20dfc0,_0x4c409a[_0x22d510(0x1fb)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x312b39}=_0x20dfc0;_0x5a1597&&_0x5a1597[_0x22d510(0x219)](0xc8);let _0x59df8e=null,_0x85833d=null;try{if(_0x5a1597){let _0x39fe5f=null,_0x3bad5e=![];_0x5a1597['on']('close',async()=>{const _0x10e4b6=_0x22d510;if(_0x3bad5e)return;_0x3af64e[_0x10e4b6(0x1b7)]();const _0x2aa6bd=await(0x0,openai_1[_0x10e4b6(0x1c2)])(_0x2cd353)||0x0,_0x907e6b=await(0x0,openai_1[_0x10e4b6(0x1c2)])(_0x39fe5f===null||_0x39fe5f===void 0x0?void 0x0:_0x39fe5f[_0x10e4b6(0x261)])||0x0,_0x590224=_0x2aa6bd+_0x907e6b,_0xc1aa64=(0x0,utils_1[_0x10e4b6(0x173)])(_0x3d5d4d);await this[_0x10e4b6(0x24b)][_0x10e4b6(0x217)]({'appId':_0x79275,'curIp':_0xc1aa64,'userId':_0x3d5d4d[_0x10e4b6(0x22c)]['id'],'type':balance_constant_1[_0x10e4b6(0x1fa)][_0x10e4b6(0x186)],'prompt':_0x2cd353,'imageUrl':_0x3b791c,'activeModel':_0xe3eb8b,'answer':'','promptTokens':_0x2aa6bd,'completionTokens':0x0,'totalTokens':_0x2aa6bd,'model':_0x288ac8,'role':_0x10e4b6(0x22c),'groupId':_0x32394c,'requestOptions':JSON[_0x10e4b6(0x199)]({'options':null,'prompt':_0x2cd353})}),await this[_0x10e4b6(0x24b)][_0x10e4b6(0x217)]({'appId':_0x79275,'curIp':_0xc1aa64,'userId':_0x3d5d4d['user']['id'],'type':balance_constant_1['DeductionKey'][_0x10e4b6(0x186)],'prompt':_0x2cd353,'answer':_0x39fe5f===null||_0x39fe5f===void 0x0?void 0x0:_0x39fe5f[_0x10e4b6(0x261)],'promptTokens':_0x2aa6bd,'completionTokens':_0x907e6b,'totalTokens':_0x590224,'model':_0x288ac8,'role':_0x10e4b6(0x179),'groupId':_0x32394c,'requestOptions':JSON['stringify']({'options':{'model':_0x288ac8,'temperature':_0x59ae60},'prompt':_0x2cd353}),'conversationOptions':JSON[_0x10e4b6(0x199)]({'conversationId':_0x39fe5f===null||_0x39fe5f===void 0x0?void 0x0:_0x39fe5f[_0x10e4b6(0x206)],'model':_0x288ac8,'parentMessageId':_0x39fe5f===null||_0x39fe5f===void 0x0?void 0x0:_0x39fe5f['id'],'temperature':_0x59ae60})});let _0x593304=_0x5783b0;_0x93c7ba===!![]&&(_0x593304=Math[_0x10e4b6(0x200)](_0x5783b0*_0x590224/_0x1312db)),await this[_0x10e4b6(0x178)]['deductFromBalance'](_0x3d5d4d[_0x10e4b6(0x22c)]['id'],_0x10e4b6(0x1a6)+(_0x28299b===0x1?0x3:0x4),_0x593304,_0x590224);});if(Number(_0x3e5248)===0x1){const {key:_0x1da1b2,maxToken:_0x11354b,maxTokenRes:_0x5c0b4a,proxyResUrl:_0x5ca460}=await this[_0x22d510(0x189)](_0x20dfc0),{parentMessageId:_0x1e9c65,completionParams:_0x11723d,systemMessage:_0x5031a2}=_0x43a59f,{model:_0x5eed31,temperature:_0x4728f9}=_0x11723d,{context:_0x53adbe}=await this[_0x22d510(0x247)][_0x22d510(0x233)](_0x205c82?_0x5b0a4f:_0x2cd353,{'parentMessageId':_0x1e9c65,'systemMessage':_0x5031a2,'maxModelToken':_0x11354b,'maxResponseTokens':_0x5c0b4a,'maxRounds':(0x0,helper_1[_0x22d510(0x193)])(_0x5e4cbf),'imageUrl':_0x3b791c,'activeModel':_0xe3eb8b});let _0x18374a=!![];_0x59df8e=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x53adbe,{'maxToken':_0x11354b,'maxTokenRes':_0x5c0b4a,'apiKey':_0x1d888a,'model':_0x5eed31,'prompt':_0x2cd353,'activeModel':_0xe3eb8b,'imageUrl':_0x3b791c,'temperature':_0x4728f9,'proxyUrl':_0x5ca460,'onProgress':_0x146e7a=>{const _0x22f129=_0x22d510;_0x5a1597['write'](_0x18374a?JSON[_0x22f129(0x199)](_0x146e7a):'\x0a'+JSON['stringify'](_0x146e7a)),_0x39fe5f=_0x146e7a,_0x18374a=![];}},this[_0x22d510(0x170)]),_0x3bad5e=!![];}if(Number(_0x3e5248)===0x2){let _0x8b6641=!![];const {context:_0xcf75d3}=await this[_0x22d510(0x247)][_0x22d510(0x233)](_0x205c82?_0x5b0a4f:_0x2cd353,{'parentMessageId':_0x3693c2,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x5e4cbf)});_0x59df8e=await(0x0,baidu_1[_0x22d510(0x183)])(_0x205c82?_0x5b0a4f:_0xcf75d3,{'temperature':_0x59ae60,'accessToken':_0x35176a,'model':_0x288ac8,'onProgress':_0x5ab093=>{const _0xb42ae5=_0x22d510;_0x5a1597[_0xb42ae5(0x17a)](_0x8b6641?JSON[_0xb42ae5(0x199)](_0x5ab093):'\x0a'+JSON[_0xb42ae5(0x199)](_0x5ab093)),_0x8b6641=![],_0x39fe5f=_0x5ab093;}}),_0x3bad5e=!![];}if(Number(_0x3e5248)===0x3){let _0x22a84c=!![];const {context:_0x4a121c}=await this[_0x22d510(0x247)][_0x22d510(0x233)](_0x205c82?_0x5b0a4f:_0x2cd353,{'parentMessageId':_0x3693c2,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x5e4cbf)});_0x59df8e=await(0x0,zhipu_1[_0x22d510(0x1a2)])(_0x205c82?_0x5b0a4f:_0x4a121c,{'temperature':_0x59ae60,'key':_0x312b39,'model':_0x288ac8,'onProgress':_0x4b48e0=>{const _0x36233c=_0x22d510;_0x5a1597[_0x36233c(0x17a)](_0x22a84c?JSON[_0x36233c(0x199)](_0x4b48e0):'\x0a'+JSON['stringify'](_0x4b48e0)),_0x22a84c=![],_0x39fe5f=_0x4b48e0;}}),_0x3bad5e=!![];}const _0x55002c={'id':this['nineStore'][_0x22d510(0x1c0)](),'text':_0x2cd353,'role':_0x22d510(0x22c),'name':undefined,'usage':null,'imageUrl':_0x3b791c,'activeModel':_0xe3eb8b,'parentMessageId':_0x3693c2,'conversationId':_0x59df8e===null||_0x59df8e===void 0x0?void 0x0:_0x59df8e[_0x22d510(0x206)]};_0x85833d={'model':_0x288ac8,'parentMessageId':_0x3693c2},await this['nineStore'][_0x22d510(0x1b9)](_0x55002c);const _0x5c492a={'id':_0x59df8e['id'],'text':_0x59df8e['text'],'role':_0x22d510(0x179),'name':undefined,'usage':_0x59df8e===null||_0x59df8e===void 0x0?void 0x0:_0x59df8e['usage'],'imageUrl':_0x3b791c,'parentMessageId':_0x55002c['id'],'conversationId':_0x59df8e===null||_0x59df8e===void 0x0?void 0x0:_0x59df8e['conversationId']};await this[_0x22d510(0x247)]['setData'](_0x5c492a),_0x85833d={'model':_0x288ac8,'parentMessageId':_0x55002c['id']};}else{const {key:_0x45435d,maxToken:_0x518a38,maxTokenRes:_0x556b00,proxyResUrl:_0x569c6c}=await this['formatModelToken'](_0x20dfc0),{parentMessageId:_0x228f13,completionParams:_0x3e1045,systemMessage:_0x509369}=_0x43a59f,{model:_0x3a16f5,temperature:_0x275582}=_0x3e1045,{context:_0x23da3c}=await this[_0x22d510(0x247)][_0x22d510(0x233)](_0x205c82?_0x5b0a4f:_0x2cd353,{'parentMessageId':_0x228f13,'systemMessage':_0x509369,'maxRounds':(0x0,helper_1[_0x22d510(0x193)])(_0x5e4cbf)});_0x59df8e=await(0x0,openai_1[_0x22d510(0x252)])(_0x23da3c,{'apiKey':_0x1d888a,'model':_0x3a16f5,'temperature':_0x275582,'proxyUrl':_0x569c6c,'onProgress':null,'prompt':_0x2cd353});}let _0x25e8bb=null,_0x74d90c=null;_0x288ac8[_0x22d510(0x1f0)]('dall')?_0x25e8bb=((_0x4923c5=_0x59df8e[_0x22d510(0x1d8)])===null||_0x4923c5===void 0x0?void 0x0:_0x4923c5[_0x22d510(0x19d)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x74d90c=await(0x0,helper_1['unifiedFormattingResponse'])(_0x3e5248,_0x59df8e,_0x85833d);const {prompt_tokens:_0x691e49,completion_tokens:_0x39d564,total_tokens:_0x5b5810}=_0x288ac8[_0x22d510(0x1f0)](_0x22d510(0x220))?_0x25e8bb:_0x74d90c[_0x22d510(0x19d)];let _0x5d3dde=_0x5783b0;_0x93c7ba===!![]&&(_0x5d3dde=Math[_0x22d510(0x200)](_0x5783b0*_0x5b5810/_0x1312db));await this['userBalanceService'][_0x22d510(0x1d5)](_0x3d5d4d[_0x22d510(0x22c)]['id'],_0x22d510(0x1a6)+(_0x28299b===0x1?0x3:0x4),_0x5d3dde,_0x5b5810),await this[_0x22d510(0x1ed)][_0x22d510(0x1a1)](_0x2246ee,_0x5b5810);const _0x2b441e=(0x0,utils_1['getClientIp'])(_0x3d5d4d);await this['chatLogService']['saveChatLog']({'appId':_0x79275,'curIp':_0x2b441e,'userId':_0x3d5d4d[_0x22d510(0x22c)]['id'],'type':balance_constant_1[_0x22d510(0x1fa)][_0x22d510(0x186)],'prompt':_0x2cd353,'imageUrl':_0x3b791c,'activeModel':_0xe3eb8b,'answer':'','promptTokens':_0x691e49,'completionTokens':0x0,'totalTokens':_0x5b5810,'model':_0x288ac8,'role':_0x22d510(0x22c),'groupId':_0x32394c,'requestOptions':JSON[_0x22d510(0x199)]({'options':null,'prompt':_0x2cd353})}),await this[_0x22d510(0x24b)][_0x22d510(0x217)]({'appId':_0x79275,'curIp':_0x2b441e,'userId':_0x3d5d4d[_0x22d510(0x22c)]['id'],'type':balance_constant_1['DeductionKey'][_0x22d510(0x186)],'prompt':_0x2cd353,'imageUrl':_0x59df8e===null||_0x59df8e===void 0x0?void 0x0:_0x59df8e[_0x22d510(0x18d)],'answer':_0x59df8e[_0x22d510(0x261)],'promptTokens':_0x691e49,'completionTokens':_0x39d564,'totalTokens':_0x5b5810,'model':_0x288ac8,'role':_0x22d510(0x179),'groupId':_0x32394c,'requestOptions':JSON[_0x22d510(0x199)]({'options':{'model':_0x288ac8,'temperature':_0x59ae60},'prompt':_0x2cd353}),'conversationOptions':JSON[_0x22d510(0x199)]({'conversationId':_0x59df8e[_0x22d510(0x206)],'model':_0x288ac8,'parentMessageId':_0x59df8e['id'],'temperature':_0x59ae60})}),common_1['Logger'][_0x22d510(0x16e)](_0x22d510(0x1ee)+_0x3d5d4d[_0x22d510(0x22c)]['id']+_0x22d510(0x18b)+_0x14414b+'-'+_0xe3eb8b+_0x22d510(0x24a)+_0x5b5810+_0x22d510(0x235)+_0x5d3dde,_0x22d510(0x23d));const _0x1657e0=await this[_0x22d510(0x178)]['queryUserBalance'](_0x3d5d4d['user']['id']);return _0x59df8e['userBanance']=Object[_0x22d510(0x231)]({},_0x1657e0),_0x59df8e['result']&&(_0x59df8e[_0x22d510(0x210)]=''),_0x59df8e[_0x22d510(0x1d3)]=!![],_0x5a1597?_0x5a1597['write']('\x0a'+JSON[_0x22d510(0x199)](_0x59df8e)):_0x59df8e[_0x22d510(0x261)];}catch(_0x69ad83){console[_0x22d510(0x20c)](_0x22d510(0x1cf),_0x1d888a,_0x69ad83);const _0x3a7b0f=(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83[_0x22d510(0x1b2)])||0x190,_0x3ef3b9=((_0x32d642=_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83['response'])===null||_0x32d642===void 0x0?void 0x0:_0x32d642[_0x22d510(0x219)])||(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83[_0x22d510(0x1b2)])||0x190;console['log'](_0x22d510(0x1ba),'code:\x20',_0x3a7b0f,'message',_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83['message'],_0x22d510(0x23f),(_0x219e88=_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83['response'])===null||_0x219e88===void 0x0?void 0x0:_0x219e88[_0x22d510(0x221)],'status',(_0x581b9a=_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83[_0x22d510(0x198)])===null||_0x581b9a===void 0x0?void 0x0:_0x581b9a[_0x22d510(0x219)]);if(_0x69ad83[_0x22d510(0x219)]&&_0x69ad83[_0x22d510(0x219)]===0x192){const _0xe1f8ac={'message':_0x22d510(0x20b)+_0x69ad83['message'],'code':0x192};if(_0x5a1597)return _0x5a1597[_0x22d510(0x17a)](JSON[_0x22d510(0x199)](_0xe1f8ac));else throw new common_1['HttpException'](_0x69ad83[_0x22d510(0x19b)],common_1['HttpStatus'][_0x22d510(0x1eb)]);}if(!_0x3ef3b9){if(_0x5a1597)return _0x5a1597[_0x22d510(0x17a)](JSON[_0x22d510(0x199)]({'message':_0x69ad83['message'],'code':0x1f4}));else throw new common_1[(_0x22d510(0x1c7))](_0x69ad83['message'],common_1[_0x22d510(0x167)][_0x22d510(0x195)]);}let _0x3cdaa9=errorMessage_constant_1[_0x22d510(0x1dc)][_0x3ef3b9]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x3ef3b9]:_0x22d510(0x204);(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83[_0x22d510(0x19b)][_0x22d510(0x1f0)](_0x22d510(0x225)))&&Number(_0x3e5248)===0x1&&(await this[_0x22d510(0x1ed)]['lockKey'](_0x2246ee,_0x22d510(0x180),-0x1),_0x3cdaa9='当前模型key已被封禁');(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83['statusCode'])===0x1ad&&_0x69ad83[_0x22d510(0x19b)]['includes']('billing')&&Number(_0x3e5248)===0x1&&(await this[_0x22d510(0x1ed)][_0x22d510(0x1c9)](_0x2246ee,_0x22d510(0x172),-0x3),_0x3cdaa9=_0x22d510(0x263));(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83['statusCode'])===0x1ad&&(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83['statusText'])===_0x22d510(0x203)&&(_0x3cdaa9='当前模型调用过于频繁、请重新试试吧！');(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83[_0x22d510(0x1b2)])===0x191&&_0x69ad83[_0x22d510(0x19b)][_0x22d510(0x1f0)](_0x22d510(0x1d6))&&Number(_0x3e5248)===0x1&&(await this[_0x22d510(0x1ed)][_0x22d510(0x1c9)](_0x2246ee,_0x22d510(0x249),-0x2),_0x3cdaa9=_0x22d510(0x1a9));(_0x69ad83===null||_0x69ad83===void 0x0?void 0x0:_0x69ad83['statusCode'])===0x194&&_0x69ad83['message'][_0x22d510(0x1f0)](_0x22d510(0x1bc))&&Number(_0x3e5248)===0x1&&(await this[_0x22d510(0x1ed)][_0x22d510(0x1c9)](_0x2246ee,'当前模型不是聊天模型',-0x4),_0x3cdaa9=_0x22d510(0x160));_0x3a7b0f===0x190&&console['log'](_0x22d510(0x1e1),_0x69ad83,_0x69ad83[_0x22d510(0x19b)]);const _0xf804d8={'message':_0x3cdaa9||_0x22d510(0x1e8),'code':_0x3a7b0f===0x191?0x190:_0x3a7b0f||0x1f4};if(_0x5a1597)return _0x5a1597[_0x22d510(0x17a)](JSON['stringify'](_0xf804d8));else throw new common_1['HttpException'](_0xf804d8[_0x22d510(0x19b)],common_1[_0x22d510(0x167)][_0x22d510(0x195)]);}finally{_0x5a1597&&_0x5a1597[_0x22d510(0x16b)]();}}async[_0x28bf85(0x21d)](_0x358695,_0x39a655){const _0x2e6241=_0x28bf85;var _0x181651,_0x42d511,_0x27d955,_0x2d95a2;await this[_0x2e6241(0x1f5)][_0x2e6241(0x242)](_0x358695[_0x2e6241(0x169)],_0x39a655[_0x2e6241(0x22c)]['id']),await this[_0x2e6241(0x162)]['checkUserStatus'](_0x39a655[_0x2e6241(0x22c)]);const _0x275d1f=(_0x358695===null||_0x358695===void 0x0?void 0x0:_0x358695['quality'])==='hd'?0x4:0x2;await this[_0x2e6241(0x178)][_0x2e6241(0x253)](_0x39a655,_0x2e6241(0x1ef),_0x275d1f);let _0x266580=[];const _0x1f524e=await this[_0x2e6241(0x1ed)]['getCurrentModelKeyInfo'](_0x2e6241(0x15f)),_0x6b2d36=_0x1f524e===null||_0x1f524e===void 0x0?void 0x0:_0x1f524e['id'],{key:_0x185237,proxyResUrl:_0x44b3e3}=await this['formatModelToken'](_0x1f524e);common_1[_0x2e6241(0x222)][_0x2e6241(0x20c)]('draw\x20paompt\x20info\x20<==**==>\x20'+_0x358695[_0x2e6241(0x169)]+_0x2e6241(0x218)+_0x185237,'DrawService');try{const _0x3d7db7=_0x44b3e3+_0x2e6241(0x20d),_0x126dce=Object[_0x2e6241(0x231)](Object[_0x2e6241(0x231)]({},_0x358695),{'model':'dall-e-3'});console['log'](_0x2e6241(0x23e),_0x126dce);const _0xe83337=await axios_1[_0x2e6241(0x248)]['post'](_0x3d7db7,Object[_0x2e6241(0x231)](Object[_0x2e6241(0x231)]({},_0x126dce),{'response_format':_0x2e6241(0x1b0)}),{'headers':{'Authorization':'Bearer\x20'+_0x185237}});_0x266580=_0xe83337[_0x2e6241(0x16a)][_0x2e6241(0x16a)];const _0x5f2737=[];for(const _0x1573a4 of _0x266580){const _0x52b531=uuid['v4']()[_0x2e6241(0x21e)](0x0,0xa)+_0x2e6241(0x213),_0x36ef2f=Buffer[_0x2e6241(0x1b5)](_0x1573a4['b64_json'],_0x2e6241(0x202));_0x5f2737[_0x2e6241(0x262)](this[_0x2e6241(0x170)]['uploadFile']({'filename':_0x52b531,'buffer':_0x36ef2f}));}const _0x5b2b4c=await Promise[_0x2e6241(0x1c6)](_0x5f2737);await this['userBalanceService'][_0x2e6241(0x1d5)](_0x39a655[_0x2e6241(0x22c)]['id'],_0x2e6241(0x1ef),(_0x126dce===null||_0x126dce===void 0x0?void 0x0:_0x126dce['quality'])===_0x2e6241(0x24c)?0x2:0x4,_0x275d1f);const _0x317a1a=(0x0,utils_1[_0x2e6241(0x173)])(_0x39a655),_0x23b257=[],_0x4fe742=await this[_0x2e6241(0x170)]['getUploadType'](),[_0x4ed3ce,_0x3e0508]=_0x358695[_0x2e6241(0x256)][_0x2e6241(0x1da)]('x');return _0x5b2b4c['forEach'](_0x1443b2=>{const _0x515ac1=_0x2e6241;_0x23b257['push'](this['chatLogService'][_0x515ac1(0x217)]({'curIp':_0x317a1a,'userId':_0x39a655['user']['id'],'type':balance_constant_1['DeductionKey'][_0x515ac1(0x1c8)],'prompt':_0x358695[_0x515ac1(0x169)],'answer':_0x1443b2,'fileInfo':JSON[_0x515ac1(0x199)]({'cosType':_0x4fe742,'width':_0x4ed3ce,'height':_0x3e0508,'cosUrl':_0x1443b2}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':'dall-e-3'}));}),await Promise[_0x2e6241(0x1c6)](_0x23b257),_0x5b2b4c;}catch(_0x25c04d){const _0x34b3d0=((_0x181651=_0x25c04d===null||_0x25c04d===void 0x0?void 0x0:_0x25c04d[_0x2e6241(0x198)])===null||_0x181651===void 0x0?void 0x0:_0x181651[_0x2e6241(0x219)])||0x1f4;console[_0x2e6241(0x20c)]('openai-draw\x20error:\x20',JSON[_0x2e6241(0x199)](_0x25c04d),_0x185237,_0x34b3d0);const _0x4e8a2c=(_0x2d95a2=(_0x27d955=(_0x42d511=_0x25c04d===null||_0x25c04d===void 0x0?void 0x0:_0x25c04d[_0x2e6241(0x198)])===null||_0x42d511===void 0x0?void 0x0:_0x42d511[_0x2e6241(0x16a)])===null||_0x27d955===void 0x0?void 0x0:_0x27d955[_0x2e6241(0x224)])===null||_0x2d95a2===void 0x0?void 0x0:_0x2d95a2['message'];if(_0x34b3d0===0x1ad)throw new common_1[(_0x2e6241(0x1c7))](_0x2e6241(0x1e7),common_1[_0x2e6241(0x167)][_0x2e6241(0x195)]);if(_0x34b3d0===0x190&&_0x4e8a2c[_0x2e6241(0x1f0)]('This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters'))throw new common_1[(_0x2e6241(0x1c7))](_0x2e6241(0x168),common_1[_0x2e6241(0x167)][_0x2e6241(0x195)]);if(_0x34b3d0===0x190&&_0x4e8a2c[_0x2e6241(0x1f0)](_0x2e6241(0x18f))){await this['modelsService'][_0x2e6241(0x1c9)](_0x6b2d36,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1);throw new common_1[(_0x2e6241(0x1c7))]('当前Key余额已不足、请重新再试一次吧！',common_1[_0x2e6241(0x167)][_0x2e6241(0x195)]);}if(_0x34b3d0===0x1f4)throw new common_1[(_0x2e6241(0x1c7))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x2e6241(0x167)]['BAD_REQUEST']);if(_0x34b3d0===0x191)throw new common_1[(_0x2e6241(0x1c7))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x2e6241(0x167)][_0x2e6241(0x195)]);throw new common_1[(_0x2e6241(0x1c7))]('绘制图片失败，请稍后试试吧！',common_1[_0x2e6241(0x167)][_0x2e6241(0x195)]);}}async[_0x28bf85(0x1ac)](){const _0x3ff485=_0x28bf85,_0x3be23d=await this[_0x3ff485(0x22d)][_0x3ff485(0x1aa)]({'where':{'status':0x1},'select':['id',_0x3ff485(0x1a5),'weight',_0x3ff485(0x1a6),'maxModelTokens',_0x3ff485(0x184),_0x3ff485(0x17b),_0x3ff485(0x1f2)]}),_0x54f581=_0x3be23d[_0x3ff485(0x1fe)](_0x511548=>_0x511548['model'][_0x3ff485(0x1f0)](_0x3ff485(0x18c))),_0x473c2f=_0x3be23d[_0x3ff485(0x1fe)](_0x3f2fb8=>_0x3f2fb8['model'][_0x3ff485(0x1f0)](_0x3ff485(0x16c)));this[_0x3ff485(0x254)]={'list3':_0x54f581,'list4':_0x473c2f};}async[_0x28bf85(0x1cb)](_0x4d164c){const _0x4b4c18=_0x28bf85,_0x1bdc41=await this[_0x4b4c18(0x1df)]['getConfigs']([_0x4b4c18(0x1f7)]);return(_0x4d164c===null||_0x4d164c===void 0x0?void 0x0:_0x4d164c[_0x4b4c18(0x1b6)])||_0x1bdc41||'https://api.openai.com';}async[_0x28bf85(0x189)](_0x398f5e){const _0x7f101=_0x28bf85,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x7f101(0x1df)][_0x7f101(0x1e0)](['openaiModel3MaxTokens','openaiModel3MaxTokensRes','openaiModel3MaxTokens16k',_0x7f101(0x20a),'openaiModel4MaxTokens',_0x7f101(0x260),'openaiModel4MaxTokens32k',_0x7f101(0x174),_0x7f101(0x1f7)]);let _0xf438f=null,_0xa96b7=null,_0x46d459=null,{model:_0xc192d,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x2cb353}=_0x398f5e;return _0xc192d[_0x7f101(0x1bd)]()[_0x7f101(0x1f0)](_0x7f101(0x16c))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0xa96b7>=0x1000&&(maxModelTokens=0x1000),_0xf438f=maxModelTokens||openaiModel4MaxTokens||0x2000,_0xa96b7=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0xc192d[_0x7f101(0x1bd)]()[_0x7f101(0x1f0)]('32k')&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0xa96b7>=0x4000&&(maxModelTokens=0x4000),_0xf438f=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0xa96b7=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0xc192d[_0x7f101(0x1bd)]()['includes']('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0xa96b7>=0x1000&&(maxModelTokens=0x1000),_0xf438f=maxModelTokens||0x3ffc,_0xa96b7=maxResponseTokens||0x1000)),_0xc192d['toLowerCase']()[_0x7f101(0x1f0)]('gpt-3')&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0xa96b7>=0x7d0&&(maxModelTokens=0x7d0),_0xf438f=maxModelTokens||openaiModel3MaxTokens||0x1000,_0xa96b7=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0xc192d[_0x7f101(0x1bd)]()[_0x7f101(0x1f0)](_0x7f101(0x1e4))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0xa96b7>=0x2000&&(maxModelTokens=0x2000),_0xf438f=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0xa96b7=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0xc192d['toLowerCase']()[_0x7f101(0x1f0)](_0x7f101(0x17e))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0xa96b7>=0x1000&&(maxModelTokens=0x1000),_0xf438f=maxModelTokens||0x4000,_0xa96b7=maxResponseTokens||0x1000)),_0x46d459=proxyUrl||openaiBaseUrl||_0x7f101(0x1e3),_0xa96b7>=_0xf438f&&(_0xa96b7=Math[_0x7f101(0x1d0)](_0xf438f/0x2)),{'key':_0x2cb353,'maxToken':_0xf438f,'maxTokenRes':_0xa96b7,'proxyResUrl':_0x46d459};}async[_0x28bf85(0x165)](_0x2957fe,_0x337f73){const _0x3564b3=_0x28bf85;try{const {name:_0x1ff549,icon:_0x4b222d,order:_0x1d1f90,id:_0xccf5f0,status:_0x18aeb5}=_0x337f73;return _0xccf5f0?await this[_0x3564b3(0x1e9)][_0x3564b3(0x230)]({'id':_0xccf5f0},{'name':_0x1ff549,'icon':_0x4b222d,'order':_0x1d1f90,'status':_0x18aeb5}):await this[_0x3564b3(0x1e9)][_0x3564b3(0x1b1)]({'name':_0x1ff549,'icon':_0x4b222d,'order':_0x1d1f90,'status':_0x18aeb5});}catch(_0x38cf8a){console[_0x3564b3(0x20c)](_0x3564b3(0x236),_0x38cf8a);}}async[_0x28bf85(0x19e)](_0x7e3c17,_0x207ed4){const _0x4b8d4b=_0x28bf85,{id:_0x40df5c}=_0x207ed4;if(!_0x40df5c)throw new common_1[(_0x4b8d4b(0x1c7))](_0x4b8d4b(0x1cc),common_1[_0x4b8d4b(0x167)][_0x4b8d4b(0x195)]);const _0x6ba4a5=await this['chatBoxEntity'][_0x4b8d4b(0x1d9)]({'where':{'typeId':_0x40df5c}});if(_0x6ba4a5)throw new common_1[(_0x4b8d4b(0x1c7))]('当前分类下有未处理数据不可移除！',common_1[_0x4b8d4b(0x167)][_0x4b8d4b(0x195)]);return await this[_0x4b8d4b(0x1e9)][_0x4b8d4b(0x1ca)]({'id':_0x40df5c});}async[_0x28bf85(0x208)](){const _0x2da15f=_0x28bf85;return await this['chatBoxTypeEntity'][_0x2da15f(0x1aa)]({'order':{'order':_0x2da15f(0x21a)}});}async[_0x28bf85(0x216)](_0x47b0c7,_0x7ae044){const _0x46c0c7=_0x28bf85,{title:_0x74ac5d,prompt:_0x1f5fab,appId:_0x31fa9c,order:_0x1584b3,status:_0x5e886d,typeId:_0x420aaf,id:_0x222f9d,url:_0x57afe8}=_0x7ae044;if(!_0x420aaf)throw new common_1[(_0x46c0c7(0x1c7))](_0x46c0c7(0x1c3),common_1[_0x46c0c7(0x167)][_0x46c0c7(0x195)]);try{const _0x1583f2={'title':_0x74ac5d,'order':_0x1584b3,'status':_0x5e886d,'typeId':_0x420aaf,'url':_0x57afe8};return _0x1583f2[_0x46c0c7(0x1f8)]=_0x31fa9c||0x0,_0x1583f2['prompt']=_0x1f5fab||'',_0x222f9d?await this[_0x46c0c7(0x1b4)]['update']({'id':_0x222f9d},_0x1583f2):await this[_0x46c0c7(0x1b4)]['save'](_0x1583f2);}catch(_0x2978f1){console[_0x46c0c7(0x20c)](_0x46c0c7(0x236),_0x2978f1);}}async[_0x28bf85(0x181)](_0x2496fc,_0x392a3a){const _0x1d6df5=_0x28bf85,{id:_0x32ebfd}=_0x392a3a;if(!_0x32ebfd)throw new common_1[(_0x1d6df5(0x1c7))](_0x1d6df5(0x1cc),common_1[_0x1d6df5(0x167)][_0x1d6df5(0x195)]);return await this[_0x1d6df5(0x1b4)][_0x1d6df5(0x1ca)]({'id':_0x32ebfd});}async[_0x28bf85(0x187)](){const _0x589610=_0x28bf85,_0x2f53f1=await this[_0x589610(0x1b4)]['find']({'order':{'order':_0x589610(0x21a)}}),_0x4226b8=[...new Set(_0x2f53f1[_0x589610(0x22e)](_0x225241=>_0x225241[_0x589610(0x21b)]))],_0x3d4bbe=[...new Set(_0x2f53f1[_0x589610(0x22e)](_0x5b8fd4=>_0x5b8fd4[_0x589610(0x1f8)]))],_0x3890b4=await this['chatBoxTypeEntity'][_0x589610(0x1aa)]({'where':{'id':(0x0,typeorm_1['In'])(_0x4226b8)}}),_0x4caf51=await this[_0x589610(0x20e)][_0x589610(0x1aa)]({'where':{'id':(0x0,typeorm_1['In'])(_0x3d4bbe)}});return _0x2f53f1[_0x589610(0x22e)](_0x2391e7=>{const _0x2dc5f9=_0x589610,{typeId:_0x4630b5,appId:_0x4ab949}=_0x2391e7;return _0x2391e7[_0x2dc5f9(0x19f)]=_0x3890b4[_0x2dc5f9(0x1aa)](_0x3067e3=>_0x3067e3['id']===_0x4630b5),_0x2391e7[_0x2dc5f9(0x1d1)]=_0x4caf51[_0x2dc5f9(0x1aa)](_0x5628ec=>_0x5628ec['id']===_0x4ab949),_0x2391e7;});}async[_0x28bf85(0x1a8)](){const _0x55ecde=_0x28bf85,_0x96ca5e=await this['chatBoxTypeEntity'][_0x55ecde(0x1aa)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x1e8fcc=await this[_0x55ecde(0x1b4)][_0x55ecde(0x1aa)]({'where':{'status':!![]}}),_0x1aa392=[...new Set(_0x1e8fcc[_0x55ecde(0x22e)](_0x3103c6=>_0x3103c6['appId']))],_0x1267b9=await this['appEntity'][_0x55ecde(0x1aa)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1aa392)}});return _0x1e8fcc[_0x55ecde(0x211)](_0x5e0a33=>{const _0x438efe=_0x55ecde,_0xf7713c=_0x1267b9[_0x438efe(0x1aa)](_0x1d4c44=>_0x1d4c44['id']===_0x5e0a33['appId']);return _0x5e0a33[_0x438efe(0x201)]=_0xf7713c===null||_0xf7713c===void 0x0?void 0x0:_0xf7713c[_0x438efe(0x201)],_0x5e0a33;}),_0x96ca5e[_0x55ecde(0x22e)](_0x3dea3c=>{const _0x49509f=_0x55ecde;return _0x3dea3c[_0x49509f(0x16d)]=_0x1e8fcc['filter'](_0x1da049=>_0x1da049[_0x49509f(0x21b)]===_0x3dea3c['id']&&_0x1da049[_0x49509f(0x219)]),_0x3dea3c;});}async[_0x28bf85(0x1f3)](_0x5ca1ef,_0x5e21f9){const _0x328d25=_0x28bf85;try{const {name:_0x1fe13b,icon:_0x36080d,order:_0x209394,id:_0x5e416e,status:_0x2d07ef}=_0x5e21f9;return _0x5e416e?await this[_0x328d25(0x1bf)][_0x328d25(0x230)]({'id':_0x5e416e},{'name':_0x1fe13b,'icon':_0x36080d,'order':_0x209394,'status':_0x2d07ef}):await this['chatPreTypeEntity']['save']({'name':_0x1fe13b,'icon':_0x36080d,'order':_0x209394,'status':_0x2d07ef});}catch(_0x60bede){console[_0x328d25(0x20c)](_0x328d25(0x236),_0x60bede);}}async['delChatPreType'](_0x1aea0d,_0x49bd99){const _0x1f1112=_0x28bf85,{id:_0xc80f37}=_0x49bd99;if(!_0xc80f37)throw new common_1['HttpException'](_0x1f1112(0x1cc),common_1[_0x1f1112(0x167)][_0x1f1112(0x195)]);const _0x43165e=await this['chatBoxEntity'][_0x1f1112(0x1d9)]({'where':{'typeId':_0xc80f37}});if(_0x43165e)throw new common_1['HttpException'](_0x1f1112(0x22f),common_1[_0x1f1112(0x167)]['BAD_REQUEST']);return await this[_0x1f1112(0x1bf)][_0x1f1112(0x1ca)]({'id':_0xc80f37});}async['queryChatPreType'](){const _0x2c243f=_0x28bf85;return await this[_0x2c243f(0x1bf)]['find']({'order':{'order':_0x2c243f(0x21a)}});}async[_0x28bf85(0x1b8)](_0x2cd1f4,_0x4b9b64){const _0x348fd0=_0x28bf85,{title:_0x1fde75,prompt:_0x3d4f6c,appId:_0x11a307,order:_0x1ba57f,status:_0x5caf72,typeId:_0x3a07ba,id:_0x4b5d9b,url:_0x11ed7a}=_0x4b9b64;if(!_0x3a07ba)throw new common_1[(_0x348fd0(0x1c7))](_0x348fd0(0x1c3),common_1[_0x348fd0(0x167)]['BAD_REQUEST']);try{const _0x57b207={'title':_0x1fde75,'prompt':_0x3d4f6c,'order':_0x1ba57f,'status':_0x5caf72,'typeId':_0x3a07ba,'url':_0x11ed7a};return _0x4b5d9b?await this[_0x348fd0(0x190)][_0x348fd0(0x230)]({'id':_0x4b5d9b},_0x57b207):await this[_0x348fd0(0x190)][_0x348fd0(0x1b1)](_0x57b207);}catch(_0x4bf427){console['log'](_0x348fd0(0x236),_0x4bf427);}}async[_0x28bf85(0x25b)](_0x4bc228,_0x26cffa){const _0x385ce8=_0x28bf85,{id:_0x20e748}=_0x26cffa;if(!_0x20e748)throw new common_1[(_0x385ce8(0x1c7))](_0x385ce8(0x1cc),common_1[_0x385ce8(0x167)][_0x385ce8(0x195)]);return await this[_0x385ce8(0x190)][_0x385ce8(0x1ca)]({'id':_0x20e748});}async['queryChatPre'](){const _0x3823d3=_0x28bf85,_0x39a851=await this['chatPreEntity'][_0x3823d3(0x1aa)]({'order':{'order':'DESC'}}),_0x5c3d70=[...new Set(_0x39a851[_0x3823d3(0x22e)](_0x24dcc5=>_0x24dcc5[_0x3823d3(0x21b)]))],_0x2669d4=await this[_0x3823d3(0x1bf)][_0x3823d3(0x1aa)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5c3d70)}});return _0x39a851[_0x3823d3(0x22e)](_0x2eccc6=>{const {typeId:_0x1747a3,appId:_0x47bc68}=_0x2eccc6;return _0x2eccc6['typeInfo']=_0x2669d4['find'](_0x260396=>_0x260396['id']===_0x1747a3),_0x2eccc6;});}async[_0x28bf85(0x1f4)](){const _0x5d906c=_0x28bf85,_0x52d436=await this[_0x5d906c(0x1bf)][_0x5d906c(0x1aa)]({'order':{'order':_0x5d906c(0x21a)},'where':{'status':!![]}}),_0x371368=await this[_0x5d906c(0x190)][_0x5d906c(0x1aa)]({'where':{'status':!![]}});return _0x52d436[_0x5d906c(0x22e)](_0x285bb1=>{const _0x15705d=_0x5d906c;return _0x285bb1[_0x15705d(0x16d)]=_0x371368[_0x15705d(0x1fe)](_0x3b6ec1=>_0x3b6ec1[_0x15705d(0x21b)]===_0x285bb1['id']&&_0x3b6ec1['status']),_0x285bb1;});}async['getMaxTokenFromModelWithOpenAi'](_0xc1f47b,_0x358804,_0x19addc){const _0x38a491=_0x28bf85;let _0x5c3e65=0x1000,_0x46e139=0x800;return _0xc1f47b[_0x38a491(0x1bd)]()[_0x38a491(0x1f0)]('gpt-4')&&(_0x5c3e65=_0x358804>=0x2004?0x2004:_0x358804,_0x46e139=_0x19addc>=0x1000?0x1000:_0x19addc,_0xc1f47b[_0x38a491(0x1bd)]()[_0x38a491(0x1f0)]('32k')&&(_0x5c3e65=_0x358804>=0x8000?0x8000:_0x358804,_0x46e139=_0x19addc>=0x3e80?0x3e80:_0x19addc),(_0xc1f47b[_0x38a491(0x1bd)]()['includes'](_0x38a491(0x1ab))||_0xc1f47b[_0x38a491(0x1bd)]()[_0x38a491(0x1f0)](_0x38a491(0x212)))&&(_0x5c3e65=_0x358804>=0x1f400?0x1f400:_0x358804,_0x46e139=_0x19addc>=0x1000?0x1000:_0x19addc)),_0xc1f47b[_0x38a491(0x1bd)]()['includes']('gpt-3')&&(_0x5c3e65=_0x358804>=0x1000?0x1000:_0x358804,_0x46e139=_0x19addc>=0x800?0x800:_0x19addc,_0xc1f47b[_0x38a491(0x1bd)]()[_0x38a491(0x1f0)](_0x38a491(0x1e4))&&(_0x5c3e65=_0x358804>=0x4000?0x4000:_0x358804,_0x46e139=_0x19addc>=0x1f40?0x1f40:_0x19addc),_0xc1f47b[_0x38a491(0x1bd)]()[_0x38a491(0x1f0)](_0x38a491(0x17e))&&(_0x5c3e65=_0x358804>=0x4000?0x4000:_0x358804,_0x46e139=_0x19addc>=0x1f40?0x1f40:_0x19addc)),{'maxToken':_0x5c3e65,'maxRes':_0x46e139};}};ChatgptService=__decorate([(0x0,common_1[_0x28bf85(0x245)])(),__param(0x0,(0x0,typeorm_2[_0x28bf85(0x214)])(gptkeys_entity_1['GptKeysEntity'])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x28bf85(0x240)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(chatBoxType_entity_1['ChatBoxTypeEntity'])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(chatBox_entity_1[_0x28bf85(0x196)])),__param(0x4,(0x0,typeorm_2[_0x28bf85(0x214)])(app_entity_1[_0x28bf85(0x1ff)])),__param(0x5,(0x0,typeorm_2[_0x28bf85(0x214)])(chatPreType_entity_1['ChatPreTypeEntity'])),__param(0x6,(0x0,typeorm_2[_0x28bf85(0x214)])(chatPre_entity_1[_0x28bf85(0x22a)])),__metadata(_0x28bf85(0x23b),[typeorm_1[_0x28bf85(0x25f)],typeorm_1[_0x28bf85(0x25f)],typeorm_1[_0x28bf85(0x25f)],typeorm_1[_0x28bf85(0x25f)],typeorm_1[_0x28bf85(0x25f)],typeorm_1[_0x28bf85(0x25f)],typeorm_1[_0x28bf85(0x25f)],nestjs_config_1['ConfigService'],userBalance_service_1[_0x28bf85(0x250)],chatLog_service_1[_0x28bf85(0x232)],user_service_1[_0x28bf85(0x24d)],upload_service_1[_0x28bf85(0x234)],badwords_service_1[_0x28bf85(0x24e)],autoreply_service_1['AutoreplyService'],globalConfig_service_1[_0x28bf85(0x1c4)],fanyi_service_1[_0x28bf85(0x163)],chatGroup_service_1[_0x28bf85(0x19c)],models_service_1[_0x28bf85(0x259)]])],ChatgptService),exports[_0x28bf85(0x23d)]=ChatgptService;