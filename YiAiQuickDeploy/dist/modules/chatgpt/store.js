'use strict';const _0x4cd147=_0x4fa7;(function(_0x3e9181,_0x41c3b3){const _0x13a9cd=_0x4fa7,_0x12e570=_0x3e9181();while(!![]){try{const _0x46db79=-parseInt(_0x13a9cd(0x77))/0x1+-parseInt(_0x13a9cd(0x7f))/0x2*(-parseInt(_0x13a9cd(0x98))/0x3)+parseInt(_0x13a9cd(0x81))/0x4*(parseInt(_0x13a9cd(0x70))/0x5)+-parseInt(_0x13a9cd(0x95))/0x6+parseInt(_0x13a9cd(0x96))/0x7+parseInt(_0x13a9cd(0x90))/0x8*(-parseInt(_0x13a9cd(0x92))/0x9)+parseInt(_0x13a9cd(0x76))/0xa;if(_0x46db79===_0x41c3b3)break;else _0x12e570['push'](_0x12e570['shift']());}catch(_0x24ac67){_0x12e570['push'](_0x12e570['shift']());}}}(_0x142b,0x68610));Object[_0x4cd147(0x88)](exports,_0x4cd147(0x71),{'value':!![]}),exports[_0x4cd147(0x99)]=void 0x0;function _0x142b(){const _0x2d8729=['2777187RgYmuC','formatOptions','808161uuPoru','NineStore','hunyuan','isArray','push','generateKey','user','some','set','setData','store','parentMessageId','_getTokenCount','gpt-4o-all','assistant','cl100k_base','expires','getData','515jeEReC','__esModule','content','gpt-4-all','length','log','2247270cnYYnJ','565610eqBvkD','buildMessageFromParentMessageId','min','namespace','gemini-pro','slice','filter','gpt-4-vision-preview','4LfuEnN','splice','24492NdoWvm','gpt-4o','claude-3-5-sonnet-20240620','_recursivePruning','本次携带上下文的长度','ERNIE','max','defineProperty','text','getUuid','join','includes','map','get','concat','47096oqMDTk','type','405rGozPt','encode','replace','3197100evEsDw'];_0x142b=function(){return _0x2d8729;};return _0x142b();}function _0x4fa7(_0x32c822,_0x5aaea2){const _0x142b82=_0x142b();return _0x4fa7=function(_0x4fa75d,_0x7aa935){_0x4fa75d=_0x4fa75d-0x6f;let _0xa51e34=_0x142b82[_0x4fa75d];return _0xa51e34;},_0x4fa7(_0x32c822,_0x5aaea2);}const uuid_1=require('uuid'),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1['get_encoding'])(_0x4cd147(0xa7));class NineStore{constructor(_0x2fb0bf){const _0x2e57f0=_0x4cd147,{store:_0x13094d,namespace:_0x4cccad,expires:_0x27e2d0}=this['formatOptions'](_0x2fb0bf);this[_0x2e57f0(0xa2)]=_0x13094d,this['namespace']=_0x4cccad,this['expires']=_0x27e2d0;}[_0x4cd147(0x97)](_0x1eeea0){const {store:_0x461b9d,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace='chat'}=_0x1eeea0;return{'store':_0x461b9d,'namespace':namespace,'expires':expires};}[_0x4cd147(0x9d)](_0x339242){const _0x390224=_0x4cd147;return this[_0x390224(0x7a)]?this[_0x390224(0x7a)]+'-'+_0x339242:_0x339242;}async[_0x4cd147(0x6f)](_0xadf934){const _0x432e84=_0x4cd147,_0x3c9bdc=await this[_0x432e84(0xa2)][_0x432e84(0x8e)](_0xadf934);return _0x3c9bdc;}async[_0x4cd147(0xa1)](_0x5617c6,_0x588061=this[_0x4cd147(0xa8)]){const _0x35c748=_0x4cd147;await this[_0x35c748(0xa2)][_0x35c748(0xa0)](_0x5617c6['id'],_0x5617c6,_0x588061);}async[_0x4cd147(0x78)](_0x107995,_0x4a5095){const _0x4aebbb=_0x4cd147;let {maxRounds:_0x5dc257,maxModelToken:_0x84879c,maxResponseTokens:_0x2a472d,systemMessage:systemMessage='',name:_0x146710,imageUrl:_0x49ac1c,model:_0x83afe,activeModel:_0x263d2d}=_0x4a5095,{parentMessageId:_0x1fba7f}=_0x4a5095,_0x583fd2=[],_0x47fdf6=0x0;if(systemMessage){const _0x4c36c4=[_0x4aebbb(0x7b),_0x4aebbb(0x86),_0x4aebbb(0x9a)],_0x1c2304=_0x263d2d&&_0x4c36c4[_0x4aebbb(0x9f)](_0x58a787=>_0x263d2d[_0x4aebbb(0x8c)](_0x58a787));_0x1c2304?(_0x583fd2[_0x4aebbb(0x9c)]({'role':_0x4aebbb(0x9e),'content':systemMessage,'name':_0x146710}),_0x583fd2[_0x4aebbb(0x9c)]({'role':_0x4aebbb(0xa6),'content':'好的','name':_0x146710})):_0x583fd2[_0x4aebbb(0x9c)]({'role':'system','content':systemMessage,'name':_0x146710});}const _0x2e24e1=_0x583fd2[_0x4aebbb(0x74)];let _0x2d5b5e=0x0;const _0x4f6b43=[_0x4aebbb(0x7e),_0x4aebbb(0x82),_0x4aebbb(0x83)];if(_0x4f6b43['includes'](_0x263d2d)&&_0x49ac1c){const _0x249b2c=[{'type':_0x4aebbb(0x89),'text':_0x107995},{'type':'image_url','image_url':{'url':_0x49ac1c}}];_0x583fd2[_0x4aebbb(0x9c)]({'role':_0x4aebbb(0x9e),'content':_0x249b2c,'name':_0x146710});}else{if(_0x4f6b43[_0x4aebbb(0x8c)](_0x263d2d)&&!_0x49ac1c){const _0x5e455a=[{'type':_0x4aebbb(0x89),'text':_0x107995}];_0x583fd2[_0x4aebbb(0x9c)]({'role':_0x4aebbb(0x9e),'content':_0x5e455a,'name':_0x146710});}else(_0x83afe===_0x4aebbb(0x73)||_0x83afe===_0x4aebbb(0xa5))&&_0x49ac1c&&(_0x107995=_0x49ac1c+'\x0a'+_0x107995),_0x583fd2['push']({'role':'user','content':_0x107995,'name':_0x146710});}let _0x341c08=_0x583fd2;do{if(!_0x1fba7f)break;const _0x4dc52c=await this[_0x4aebbb(0x6f)](_0x1fba7f);if(!_0x4dc52c)break;const {text:_0x29a6e0,name:_0x19f7c3,role:_0xc3fc1f,imageUrl:_0x3bc174}=_0x4dc52c;let _0x11a062=_0x29a6e0;if(_0x3bc174)_0x4f6b43[_0x4aebbb(0x8c)](_0x263d2d)&&(_0xc3fc1f===_0x4aebbb(0xa6)?_0x11a062=[{'type':_0x4aebbb(0x89),'text':_0x29a6e0}]:_0x11a062=[{'type':_0x4aebbb(0x89),'text':_0x29a6e0},{'type':'image_url','image_url':{'url':_0x3bc174}}]);else!_0x3bc174&&_0x4f6b43['includes'](_0x263d2d)&&(_0x11a062=[{'type':_0x4aebbb(0x89),'text':_0x29a6e0}]);_0x341c08=_0x341c08[_0x4aebbb(0x7c)](0x0,_0x2e24e1)[_0x4aebbb(0x8f)]([{'role':_0xc3fc1f,'content':_0x11a062,'name':_0x19f7c3},..._0x341c08['slice'](_0x2e24e1)]),_0x2d5b5e++;if(_0x5dc257&&_0x2d5b5e>=_0x5dc257)break;if(_0x84879c&&_0x2a472d){const _0x575969=_0x84879c-_0x2a472d;_0x47fdf6=await this[_0x4aebbb(0xa4)](_0x341c08);const _0x4fa8c2=_0x47fdf6+0xc8<=_0x575969;!_0x4fa8c2&&(_0x341c08=this[_0x4aebbb(0x84)](_0x341c08,_0x575969,systemMessage));}_0x1fba7f=_0x4dc52c[_0x4aebbb(0xa3)];}while(!![]);const _0x5bba2c=Math[_0x4aebbb(0x87)](0x1,Math[_0x4aebbb(0x79)](_0x84879c-_0x47fdf6,_0x2a472d));return console[_0x4aebbb(0x75)](_0x4aebbb(0x85),_0x341c08[_0x4aebbb(0x74)],_0x47fdf6),{'context':_0x341c08,'round':_0x341c08['length'],'historyToken':_0x47fdf6};}[_0x4cd147(0xa4)](_0x33b181){const _0x38a6e1=_0x4cd147;let _0x38b5e2=_0x33b181['reduce']((_0x3f4588,_0x37089d)=>{const _0x388293=_0x4fa7;if(Array[_0x388293(0x9b)](_0x37089d[_0x388293(0x72)])){const _0x1a9661=_0x37089d['content'][_0x388293(0x7d)](_0xf604bc=>_0xf604bc[_0x388293(0x91)]==='text')[_0x388293(0x8d)](_0x514d5a=>_0x514d5a[_0x388293(0x89)])[_0x388293(0x8b)]('\x20');return _0x3f4588+_0x1a9661;}else return _0x3f4588+(_0x37089d[_0x388293(0x72)]||'');},'');return _0x38b5e2=_0x38b5e2[_0x38a6e1(0x94)](/<\|endoftext\|>/g,''),tokenizer[_0x38a6e1(0x93)](_0x38b5e2)[_0x38a6e1(0x74)]*2.18;}['_recursivePruning'](_0x3ef190,_0x201f9c,_0x23f021){const _0x4431da=_0x4cd147,_0x183e7e=this[_0x4431da(0xa4)](_0x3ef190);if(_0x183e7e<=_0x201f9c)return _0x3ef190;return _0x3ef190[_0x4431da(0x80)](_0x23f021?0x1:0x0,0x1),this[_0x4431da(0x84)](_0x3ef190,_0x201f9c,_0x23f021);}[_0x4cd147(0x8a)](){return(0x0,uuid_1['v4'])();}}exports[_0x4cd147(0x99)]=NineStore;