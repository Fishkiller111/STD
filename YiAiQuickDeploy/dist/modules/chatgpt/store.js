'use strict';const _0x2735e4=_0x2aaa;function _0x5311(){const _0x3dc4fd=['get','ERNIE','min','_recursivePruning','1961796vZgwyb','parentMessageId','content','get_encoding','534054BBcCtL','buildMessageFromParentMessageId','uuid','219776QdIbZh','6430OxIUBY','298855BXcjmE','chat','join','cl100k_base','gpt-4-vision-preview','some','splice','84535VhyjMd','user','__esModule','assistant','type','image_url','_getTokenCount','namespace','12fJDYUJ','replace','log','@dqbd/tiktoken','system','11160ZmWACN','store','70WdzPTb','expires','generateKey','length','gpt-4-all','max','isArray','1260993nEZVei','push','setData','formatOptions','getData','concat','includes','slice','text','map','hunyuan','getUuid','claude-3-5-sonnet-20240620'];_0x5311=function(){return _0x3dc4fd;};return _0x5311();}(function(_0x2e02cf,_0x549acb){const _0x1d05a1=_0x2aaa,_0x4f1da0=_0x2e02cf();while(!![]){try{const _0xbdd051=-parseInt(_0x1d05a1(0x14d))/0x1+parseInt(_0x1d05a1(0x141))/0x2+parseInt(_0x1d05a1(0x12c))/0x3+-parseInt(_0x1d05a1(0x155))/0x4*(parseInt(_0x1d05a1(0x146))/0x5)+parseInt(_0x1d05a1(0x13d))/0x6+parseInt(_0x1d05a1(0x15c))/0x7*(parseInt(_0x1d05a1(0x144))/0x8)+-parseInt(_0x1d05a1(0x15a))/0x9*(parseInt(_0x1d05a1(0x145))/0xa);if(_0xbdd051===_0x549acb)break;else _0x4f1da0['push'](_0x4f1da0['shift']());}catch(_0x5cdd1f){_0x4f1da0['push'](_0x4f1da0['shift']());}}}(_0x5311,0x37a24));function _0x2aaa(_0x3fbf4a,_0x4ad158){const _0x531118=_0x5311();return _0x2aaa=function(_0x2aaabe,_0x4225dd){_0x2aaabe=_0x2aaabe-0x126;let _0x2bdca9=_0x531118[_0x2aaabe];return _0x2bdca9;},_0x2aaa(_0x3fbf4a,_0x4ad158);}Object['defineProperty'](exports,_0x2735e4(0x14f),{'value':!![]}),exports['NineStore']=void 0x0;const uuid_1=require(_0x2735e4(0x143)),tiktoken_1=require(_0x2735e4(0x158)),tokenizer=(0x0,tiktoken_1[_0x2735e4(0x140)])(_0x2735e4(0x149));class NineStore{constructor(_0x1c6490){const _0x1ab134=_0x2735e4,{store:_0x431d8b,namespace:_0x23ffb4,expires:_0x1f9571}=this[_0x1ab134(0x12f)](_0x1c6490);this['store']=_0x431d8b,this[_0x1ab134(0x154)]=_0x23ffb4,this[_0x1ab134(0x126)]=_0x1f9571;}[_0x2735e4(0x12f)](_0x48384c){const _0x3b353d=_0x2735e4,{store:_0xfddc72,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x3b353d(0x147)}=_0x48384c;return{'store':_0xfddc72,'namespace':namespace,'expires':expires};}[_0x2735e4(0x127)](_0xcab296){const _0x4229ff=_0x2735e4;return this[_0x4229ff(0x154)]?this[_0x4229ff(0x154)]+'-'+_0xcab296:_0xcab296;}async[_0x2735e4(0x130)](_0x223e02){const _0x482d0a=_0x2735e4,_0x2b8953=await this[_0x482d0a(0x15b)][_0x482d0a(0x139)](_0x223e02);return _0x2b8953;}async[_0x2735e4(0x12e)](_0x413116,_0x24567c=this['expires']){const _0x1d3f7b=_0x2735e4;await this[_0x1d3f7b(0x15b)]['set'](_0x413116['id'],_0x413116,_0x24567c);}async[_0x2735e4(0x142)](_0x5bd4ca,_0x37758d){const _0x37d132=_0x2735e4;let {maxRounds:_0x1cf452,maxModelToken:_0x1e2319,maxResponseTokens:_0x1be941,systemMessage:systemMessage='',name:_0x5bbca0,imageUrl:_0x1ad9e2,model:_0x487c35,activeModel:_0x17b93e}=_0x37758d,{parentMessageId:_0xa0680}=_0x37758d,_0x4a3c87=[],_0x4f698d=0x0;if(systemMessage){const _0x206f9d=['gemini-pro',_0x37d132(0x13a),_0x37d132(0x136)],_0x319794=_0x17b93e&&_0x206f9d[_0x37d132(0x14b)](_0x5409a5=>_0x17b93e[_0x37d132(0x132)](_0x5409a5));_0x319794?(_0x4a3c87[_0x37d132(0x12d)]({'role':_0x37d132(0x14e),'content':systemMessage,'name':_0x5bbca0}),_0x4a3c87[_0x37d132(0x12d)]({'role':_0x37d132(0x150),'content':'好的','name':_0x5bbca0})):_0x4a3c87[_0x37d132(0x12d)]({'role':_0x37d132(0x159),'content':systemMessage,'name':_0x5bbca0});}const _0x2eaed6=_0x4a3c87[_0x37d132(0x128)];let _0x48d9dd=0x0;const _0x1ae940=[_0x37d132(0x14a),'gpt-4o',_0x37d132(0x138)];if(_0x1ae940[_0x37d132(0x132)](_0x17b93e)&&_0x1ad9e2){const _0x216519=[{'type':'text','text':_0x5bd4ca},{'type':_0x37d132(0x152),'image_url':{'url':_0x1ad9e2}}];_0x4a3c87[_0x37d132(0x12d)]({'role':'user','content':_0x216519,'name':_0x5bbca0});}else{if(_0x1ae940[_0x37d132(0x132)](_0x17b93e)&&!_0x1ad9e2){const _0x2dcc34=[{'type':_0x37d132(0x134),'text':_0x5bd4ca}];_0x4a3c87[_0x37d132(0x12d)]({'role':_0x37d132(0x14e),'content':_0x2dcc34,'name':_0x5bbca0});}else(_0x487c35===_0x37d132(0x129)||_0x487c35==='gpt-4o-all')&&_0x1ad9e2&&(_0x5bd4ca=_0x1ad9e2+'\x0a'+_0x5bd4ca),_0x4a3c87[_0x37d132(0x12d)]({'role':_0x37d132(0x14e),'content':_0x5bd4ca,'name':_0x5bbca0});}let _0x6b8b75=_0x4a3c87;do{if(!_0xa0680)break;const _0x415afe=await this[_0x37d132(0x130)](_0xa0680);if(!_0x415afe)break;const {text:_0x3d4033,name:_0xe0da2f,role:_0x1e1a40,imageUrl:_0xa675b}=_0x415afe;let _0x11744f=_0x3d4033;if(_0xa675b)_0x1ae940[_0x37d132(0x132)](_0x17b93e)&&(_0x1e1a40===_0x37d132(0x150)?_0x11744f=[{'type':_0x37d132(0x134),'text':_0x3d4033}]:_0x11744f=[{'type':_0x37d132(0x134),'text':_0x3d4033},{'type':_0x37d132(0x152),'image_url':{'url':_0xa675b}}]);else!_0xa675b&&_0x1ae940['includes'](_0x17b93e)&&(_0x11744f=[{'type':_0x37d132(0x134),'text':_0x3d4033}]);_0x6b8b75=_0x6b8b75[_0x37d132(0x133)](0x0,_0x2eaed6)[_0x37d132(0x131)]([{'role':_0x1e1a40,'content':_0x11744f,'name':_0xe0da2f},..._0x6b8b75[_0x37d132(0x133)](_0x2eaed6)]),_0x48d9dd++;if(_0x1cf452&&_0x48d9dd>=_0x1cf452)break;if(_0x1e2319&&_0x1be941){const _0x36e4e1=_0x1e2319-_0x1be941;_0x4f698d=await this[_0x37d132(0x153)](_0x6b8b75);const _0x54596e=_0x4f698d+0xc8<=_0x36e4e1;!_0x54596e&&(_0x6b8b75=this[_0x37d132(0x13c)](_0x6b8b75,_0x36e4e1,systemMessage));}_0xa0680=_0x415afe[_0x37d132(0x13e)];}while(!![]);const _0x3c7f72=Math[_0x37d132(0x12a)](0x1,Math[_0x37d132(0x13b)](_0x1e2319-_0x4f698d,_0x1be941));return console[_0x37d132(0x157)]('本次携带上下文的长度',_0x6b8b75[_0x37d132(0x128)],_0x4f698d),{'context':_0x6b8b75,'round':_0x6b8b75[_0x37d132(0x128)],'historyToken':_0x4f698d};}[_0x2735e4(0x153)](_0x37c0a7){const _0x3e3b7c=_0x2735e4;let _0x43248a=_0x37c0a7['reduce']((_0x4b3537,_0x1b1ee4)=>{const _0x105405=_0x2aaa;if(Array[_0x105405(0x12b)](_0x1b1ee4[_0x105405(0x13f)])){const _0x354ceb=_0x1b1ee4[_0x105405(0x13f)]['filter'](_0xf235d1=>_0xf235d1[_0x105405(0x151)]===_0x105405(0x134))[_0x105405(0x135)](_0x53d662=>_0x53d662[_0x105405(0x134)])[_0x105405(0x148)]('\x20');return _0x4b3537+_0x354ceb;}else return _0x4b3537+(_0x1b1ee4[_0x105405(0x13f)]||'');},'');return _0x43248a=_0x43248a[_0x3e3b7c(0x156)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x43248a)[_0x3e3b7c(0x128)]*2.18;}['_recursivePruning'](_0x42ef1c,_0x50e92c,_0x73d25e){const _0x5747d3=_0x2735e4,_0x2809c2=this['_getTokenCount'](_0x42ef1c);if(_0x2809c2<=_0x50e92c)return _0x42ef1c;return _0x42ef1c[_0x5747d3(0x14c)](_0x73d25e?0x1:0x0,0x1),this['_recursivePruning'](_0x42ef1c,_0x50e92c,_0x73d25e);}[_0x2735e4(0x137)](){return(0x0,uuid_1['v4'])();}}exports['NineStore']=NineStore;