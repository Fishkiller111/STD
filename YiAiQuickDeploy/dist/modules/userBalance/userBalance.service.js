'use strict';function _0x39a2(_0x8c56e3,_0x18617f){const _0x10a0e0=_0x10a0();return _0x39a2=function(_0x39a2e7,_0x168056){_0x39a2e7=_0x39a2e7-0xce;let _0x189e2f=_0x10a0e0[_0x39a2e7];return _0x189e2f;},_0x39a2(_0x8c56e3,_0x18617f);}const _0x51ea89=_0x39a2;(function(_0x37c797,_0x500818){const _0x10f88e=_0x39a2,_0x1c60b0=_0x37c797();while(!![]){try{const _0x40118d=-parseInt(_0x10f88e(0x16d))/0x1+-parseInt(_0x10f88e(0x126))/0x2*(-parseInt(_0x10f88e(0xea))/0x3)+parseInt(_0x10f88e(0x188))/0x4*(parseInt(_0x10f88e(0x14c))/0x5)+parseInt(_0x10f88e(0x18b))/0x6*(-parseInt(_0x10f88e(0x187))/0x7)+parseInt(_0x10f88e(0x10e))/0x8+-parseInt(_0x10f88e(0x162))/0x9*(-parseInt(_0x10f88e(0x186))/0xa)+-parseInt(_0x10f88e(0xf4))/0xb*(-parseInt(_0x10f88e(0xdf))/0xc);if(_0x40118d===_0x500818)break;else _0x1c60b0['push'](_0x1c60b0['shift']());}catch(_0x313e0a){_0x1c60b0['push'](_0x1c60b0['shift']());}}}(_0x10a0,0x6c13a));function _0x10a0(){const _0x25cec4=['充值失败','saveRecordRechargeLog','findAndCount','registerSendModel4Count','visitor','userBalanceEntity','42uvhcnu','includes','reduce','refundMjBalance','salesUsersEntity','length','MidjourneyEntity','CramiPackageEntity','affected','firstRregisterSendModel3Count','AccountLogEntity','./fingerprint.entity','map','sumModel4Count','旧账户信息迁移失败','format','formatCreateOrUpdateDate','count','UserEntity','save','invitedGuestSendModel3Count','../sales/salesUsers.entity','add','email','HttpException','__metadata','../sales/sales.service','configVal','typeorm','model3','firstRregisterSendModel4Count','accountLogEntity','firstRregisterSendDrawMjCount','memberModel3Count','default','update','day','PAYMENT_REQUIRED','5XUbGyZ','../chatgpt/whiteList.entity','configEntity','当前用户无需创建账户信息！','ChatLogEntity','userId','createRandomUid','../../common/utils','DESC','充值的工单信息:','queryUserBalanceByIds','__param','inviteGiveSendModel3Count','createSalesRecords','../midjourney/midjourney.entity','YYYY-MM-DD\x20HH:mm:ss','invitedGuestSendModel4Count','__esModule','YYYY-MM-DD','getDate','HttpStatus','globalConfigService','9lePAgN','getMonth','UserBalanceService','username','getFullYear','缺失当前用户账户记录！','writeOldBalanceToNewTable','useModel4Token','headers','SalesService','chatLogEntity','712777mAIqHq','super','isInteger','addBalanceToUser','查询当前用户余额失败！','createBaseUserBalance','phone','UserBalanceEntity','useDrawMjToken','getOwnPropertyDescriptor','isUpdatedToday','model4','hideString','RechargeType','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','inviteGiveSendDrawMjCount','InjectRepository','log','Logger','salesService','../chatGroup/chatGroup.entity','goodsId','./userBalance.entity','BAD_REQUEST','useModel3Token','6157370RExcQT','343iloKMY','178904xevHAX','sumDrawMjCount','您已经升级过了、请勿重复操作！','107652QVfPOZ','REG_GIFT','mjDraw','error:\x20','useModel4Count','avatar','validateVisitorBalance','object','firstRegisterSendStatus','../globalConfig/globalConfig.service','findOne','当前用户不存在,记录充值日志异常','memberDrawMjCount','updatedAt','FingerprintLogEntity','balanceEntity','getVisitorCount','BalanceService','metadata','../globalConfig/config.entity','Repository','commissionAmount','12TLpsPQ','@nestjs/common','setConfig','function','getConfigs','whiteListEntity','registerSendModel3Count','visitorModel4Num','inviteGiveSendModel4Count','decorate','configKey','65517HkSIuN','rechargeType','user','fingerprintLogEntity','>\x20或购买专属套餐\x20！','GlobalConfigService','查询用户账户信息失败！','packageId','expireDateCn','chatGroupEntity','5115869BDMkSy','find','invitedGuestSendDrawMjCount','registerSendStatus','../../common/utils/date','visitorModel3Num','formatDate','queryUserBalance','debug','firstRegisterSendRank','status','旧账户信息迁移成功','deductFromBalance','MjCount','days','memberModel4Count','model4Count','userEntity','drawMjCount','upgradeBalance','REFER_GIFT','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','model3Count','SCAN_PAY','expirationTime','sumModel3Count','3603648zUQmKC','账户信息已经存在、迁移无效','visitorMJNum','cramiPackageEntity','design:paramtypes','validateBalance','inviteSendStatus','forEach','../user/user.entity','upgradeStatus','useModel3Count','then','addBalanceToNewUser','midjourneyEntity','LessThan','defineProperty','../crami/cramiPackage.entity','odel3'];_0x10a0=function(){return _0x25cec4;};return _0x10a0();}var __decorate=this&&this['__decorate']||function(_0x464789,_0x351ee9,_0xcf46a8,_0x4157b7){const _0x5227d3=_0x39a2;var _0x449a86=arguments[_0x5227d3(0x12b)],_0x3d1838=_0x449a86<0x3?_0x351ee9:_0x4157b7===null?_0x4157b7=Object[_0x5227d3(0x176)](_0x351ee9,_0xcf46a8):_0x4157b7,_0x116827;if(typeof Reflect===_0x5227d3(0xd0)&&typeof Reflect[_0x5227d3(0xe8)]===_0x5227d3(0xe2))_0x3d1838=Reflect[_0x5227d3(0xe8)](_0x464789,_0x351ee9,_0xcf46a8,_0x4157b7);else{for(var _0x5e5b0f=_0x464789[_0x5227d3(0x12b)]-0x1;_0x5e5b0f>=0x0;_0x5e5b0f--)if(_0x116827=_0x464789[_0x5e5b0f])_0x3d1838=(_0x449a86<0x3?_0x116827(_0x3d1838):_0x449a86>0x3?_0x116827(_0x351ee9,_0xcf46a8,_0x3d1838):_0x116827(_0x351ee9,_0xcf46a8))||_0x3d1838;}return _0x449a86>0x3&&_0x3d1838&&Object[_0x5227d3(0x11d)](_0x351ee9,_0xcf46a8,_0x3d1838),_0x3d1838;},__metadata=this&&this[_0x51ea89(0x13f)]||function(_0x4d3b8a,_0x3cc551){const _0x153be1=_0x51ea89;if(typeof Reflect===_0x153be1(0xd0)&&typeof Reflect['metadata']===_0x153be1(0xe2))return Reflect[_0x153be1(0xdb)](_0x4d3b8a,_0x3cc551);},__param=this&&this[_0x51ea89(0x157)]||function(_0x31d017,_0x2fe962){return function(_0x1dab20,_0x732cc8){_0x2fe962(_0x1dab20,_0x732cc8,_0x31d017);};};Object[_0x51ea89(0x11d)](exports,_0x51ea89(0x15d),{'value':!![]}),exports[_0x51ea89(0x164)]=void 0x0;const globalConfig_service_1=require(_0x51ea89(0xd2)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require('./balance.entity'),common_1=require(_0x51ea89(0xe0)),typeorm_2=require(_0x51ea89(0x142)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0x51ea89(0x153)),config_entity_1=require(_0x51ea89(0xdc)),cramiPackage_entity_1=require(_0x51ea89(0x11e)),userBalance_entity_1=require(_0x51ea89(0x183)),date_1=require(_0x51ea89(0xf8)),user_entity_1=require(_0x51ea89(0x116)),salesUsers_entity_1=require(_0x51ea89(0x13b)),sales_service_1=require(_0x51ea89(0x140)),whiteList_entity_1=require(_0x51ea89(0x14d)),fingerprint_entity_1=require(_0x51ea89(0x131)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x51ea89(0x181)),midjourney_entity_1=require(_0x51ea89(0x15a));let UserBalanceService=class UserBalanceService{constructor(_0x27bd41,_0x130570,_0x4134a7,_0x5780db,_0x3c9499,_0x186ff5,_0x7ddfa4,_0x40431c,_0x7c1839,_0x2b5220,_0x183101,_0x360fce,_0x3ee021,_0x6f6d2c){const _0x8624a6=_0x51ea89;this[_0x8624a6(0xd8)]=_0x27bd41,this[_0x8624a6(0x125)]=_0x130570,this[_0x8624a6(0x145)]=_0x4134a7,this['cramiPackageEntity']=_0x5780db,this[_0x8624a6(0x14e)]=_0x3c9499,this[_0x8624a6(0x105)]=_0x186ff5,this[_0x8624a6(0x12a)]=_0x7ddfa4,this[_0x8624a6(0xe4)]=_0x40431c,this[_0x8624a6(0xed)]=_0x7c1839,this[_0x8624a6(0xf3)]=_0x2b5220,this[_0x8624a6(0x16c)]=_0x183101,this['midjourneyEntity']=_0x360fce,this[_0x8624a6(0x180)]=_0x3ee021,this['globalConfigService']=_0x6f6d2c;}async[_0x51ea89(0x11a)](_0x2d2419,_0x4ee735){const _0x4b9fc1=_0x51ea89;try{const _0x3d6209=await this[_0x4b9fc1(0x14e)][_0x4b9fc1(0xf5)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4b9fc1(0xf7),_0x4b9fc1(0xe5),_0x4b9fc1(0x123),'registerSendDrawMjCount','firstRegisterSendStatus',_0x4b9fc1(0xfd),_0x4b9fc1(0x12f),'firstRregisterSendModel4Count',_0x4b9fc1(0x146),_0x4b9fc1(0x114),_0x4b9fc1(0x158),_0x4b9fc1(0xe7),_0x4b9fc1(0x17c),'invitedGuestSendModel3Count',_0x4b9fc1(0xf6),_0x4b9fc1(0x15c)])}}),_0x59b07b=_0x3d6209[_0x4b9fc1(0x128)]((_0x1fc687,_0x1fc975)=>{const _0x2cb4f0=_0x4b9fc1,_0x1e32c5=Number(_0x1fc975[_0x2cb4f0(0x141)]),_0x24a7ca=Number[_0x2cb4f0(0x16f)](_0x1e32c5)&&_0x1e32c5>0x0?_0x1e32c5:0x0;return _0x1fc687[_0x1fc975[_0x2cb4f0(0xe9)]]=_0x24a7ca,_0x1fc687;},{});let _0x55c510=0x0,_0x33cc1a=0x0,_0x191592=0x0;_0x59b07b['registerSendStatus']===0x1&&(_0x55c510=_0x55c510+_0x59b07b[_0x4b9fc1(0xe5)],_0x33cc1a=_0x33cc1a+_0x59b07b[_0x4b9fc1(0x123)],_0x191592=_0x191592+_0x59b07b['registerSendDrawMjCount']),_0x59b07b[_0x4b9fc1(0xf7)]===0x1&&_0x59b07b[_0x4b9fc1(0xd1)]===0x1&&_0x2d2419<=_0x59b07b[_0x4b9fc1(0xfd)]&&(_0x55c510=_0x55c510+_0x59b07b[_0x4b9fc1(0x12f)],_0x33cc1a=_0x33cc1a+_0x59b07b[_0x4b9fc1(0x144)],_0x191592=_0x191592+_0x59b07b[_0x4b9fc1(0x146)]),await this[_0x4b9fc1(0x121)]({'userId':_0x2d2419,'rechargeType':balance_constant_1[_0x4b9fc1(0x17a)][_0x4b9fc1(0x18c)],'model3Count':_0x55c510,'drawMjCount':_0x191592,'model4Count':_0x33cc1a}),_0x4ee735&&(Number(_0x59b07b[_0x4b9fc1(0x114)])===0x1&&(_0x55c510=_0x55c510+Number(_0x59b07b[_0x4b9fc1(0x13a)]),_0x33cc1a=_0x33cc1a+Number(_0x59b07b[_0x4b9fc1(0x15c)]),_0x191592=_0x191592+Number(_0x59b07b[_0x4b9fc1(0xf6)]),await this['saveRecordRechargeLog']({'userId':_0x2d2419,'rechargeType':balance_constant_1[_0x4b9fc1(0x17a)]['INVITE_GIFT'],'model3Count':_0x59b07b[_0x4b9fc1(0x13a)],'model4Count':_0x59b07b['invitedGuestSendModel4Count'],'drawMjCount':_0x59b07b[_0x4b9fc1(0xf6)]}),await this[_0x4b9fc1(0x170)](_0x4ee735,{'model3Count':_0x59b07b[_0x4b9fc1(0x158)],'model4Count':_0x59b07b['inviteGiveSendModel4Count'],'drawMjCount':_0x59b07b[_0x4b9fc1(0x17c)]}),await this[_0x4b9fc1(0x121)]({'userId':_0x4ee735,'rechargeType':balance_constant_1[_0x4b9fc1(0x17a)][_0x4b9fc1(0x108)],'model3Count':_0x59b07b[_0x4b9fc1(0x158)],'model4Count':_0x59b07b['inviteGiveSendModel4Count'],'drawMjCount':_0x59b07b[_0x4b9fc1(0x17c)]}))),await this[_0x4b9fc1(0x125)]['save']({'userId':_0x2d2419,'model3Count':_0x55c510,'model4Count':_0x33cc1a,'drawMjCount':_0x191592,'useTokens':0x0});}catch(_0x19993b){console[_0x4b9fc1(0x17e)]('error:\x20',_0x19993b);throw new common_1[(_0x4b9fc1(0x13e))]('注册赠送失败,请联系管理员！',common_1[_0x4b9fc1(0x160)]['BAD_REQUEST']);}}async[_0x51ea89(0x113)](_0xb1bccb,_0x35ab2f,_0x1e82cd){const _0x48b607=_0x51ea89,{id:_0x491b02,role:_0x3f7e88}=_0xb1bccb['user'];let _0xceeb44=await this[_0x48b607(0x125)][_0x48b607(0xd3)]({'where':{'userId':_0x491b02}});!_0xceeb44&&(_0xceeb44=await this['createBaseUserBalance'](_0x491b02));if(_0x3f7e88===_0x48b607(0x124))return this[_0x48b607(0xcf)](_0xb1bccb,_0x35ab2f,_0x1e82cd);const _0x357709=await this[_0x48b607(0x14e)]['findOne']({'where':{'configKey':'vxNumber'}}),_0x4f8a1e=_0x357709?_0x357709[_0x48b607(0x141)]:'---',_0x3e9abc=_0x35ab2f===_0x48b607(0x143)?_0x48b607(0x147):_0x35ab2f===_0x48b607(0x178)?_0x48b607(0x103):_0x35ab2f===_0x48b607(0x18d)?_0x48b607(0xd5):null,_0x16ce90=_0x35ab2f===_0x48b607(0x143)?_0x48b607(0x10a):_0x35ab2f===_0x48b607(0x178)?_0x48b607(0x104):_0x35ab2f===_0x48b607(0x18d)?_0x48b607(0x106):null;if(_0xceeb44['packageId']&&_0xceeb44[_0x3e9abc]<_0x1e82cd){if(_0xceeb44[_0x16ce90]<_0x1e82cd)throw new common_1[(_0x48b607(0x13e))](_0x48b607(0x109)+_0x4f8a1e+_0x48b607(0xee),common_1[_0x48b607(0x160)][_0x48b607(0x14b)]);}if(!_0xceeb44[_0x48b607(0xf1)]&&_0xceeb44[_0x16ce90]<_0x1e82cd)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x4f8a1e+_0x48b607(0xee),common_1[_0x48b607(0x160)][_0x48b607(0x14b)]);return _0xceeb44;}async[_0x51ea89(0xcf)](_0x816cab,_0x5400d0,_0x1ff2ba){const _0x4b92ae=_0x51ea89,{id:_0x1ecde0}=_0x816cab[_0x4b92ae(0xec)],_0x49c827=_0x5400d0==='model3'?_0x4b92ae(0x10a):_0x5400d0===_0x4b92ae(0x178)?_0x4b92ae(0x104):_0x5400d0===_0x4b92ae(0x18d)?_0x4b92ae(0x106):null,_0x4dc622=new Date(),_0x4918c5=await this['fingerprintLogEntity'][_0x4b92ae(0xd3)]({'where':{'fingerprint':_0x1ecde0}}),{visitorModel3Num:_0x31af71,visitorModel4Num:_0x57c8ae,visitorMJNum:_0x516704}=await this['globalConfigService'][_0x4b92ae(0xe3)]([_0x4b92ae(0xf9),_0x4b92ae(0xe6),_0x4b92ae(0x110)]),_0x2a0cad={'model3Count':_0x31af71?Number(_0x31af71):0x0,'model4Count':_0x57c8ae?Number(_0x57c8ae):0x0,'drawMjCount':_0x516704?Number(_0x516704):0x0};if(!_0x4918c5){const _0x5b14f3={'fingerprint':_0x1ecde0,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x5b14f3[_0x49c827]=_0x5b14f3[_0x49c827]+_0x1ff2ba;if(_0x5b14f3[_0x49c827]>_0x2a0cad[_0x49c827])throw new common_1[(_0x4b92ae(0x13e))](_0x4b92ae(0x17b),common_1['HttpStatus'][_0x4b92ae(0x14b)]);else return await this['fingerprintLogEntity'][_0x4b92ae(0x139)](_0x5b14f3),!![];}else{const {model3Count:_0x4f2b50,model4Count:_0xbd5f45,drawMjCount:_0x181c48}=_0x4918c5;let _0x46c14f={'model3Count':_0x4f2b50,'model4Count':_0xbd5f45,'drawMjCount':_0x181c48};const _0x2bbc04=Number(new Date(_0x4918c5[_0x4b92ae(0xd6)])),_0x3bd881=this[_0x4b92ae(0x177)](_0x2bbc04);_0x3bd881?_0x46c14f[_0x49c827]=_0x46c14f[_0x49c827]+_0x1ff2ba:(_0x46c14f={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x46c14f[_0x49c827]=_0x46c14f[_0x49c827]+_0x1ff2ba);if(_0x46c14f[_0x49c827]>_0x2a0cad[_0x49c827])throw new common_1[(_0x4b92ae(0x13e))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1['HttpStatus'][_0x4b92ae(0x14b)]);else return await this[_0x4b92ae(0xed)][_0x4b92ae(0x149)]({'fingerprint':_0x1ecde0},_0x46c14f),!![];}}[_0x51ea89(0x177)](_0xef04c2){const _0x4cb7b0=_0x51ea89,_0x584a92=new Date(),_0x515cf7=new Date(_0x584a92[_0x4cb7b0(0x166)](),_0x584a92[_0x4cb7b0(0x163)](),_0x584a92[_0x4cb7b0(0x15f)]());return _0xef04c2>=_0x515cf7;}async[_0x51ea89(0x100)](_0x1440a8,_0x46f33d,_0xf20b01,_0x38b3e0=0x0){const _0x4a04fb=_0x51ea89,_0x46cafa=await this[_0x4a04fb(0x125)][_0x4a04fb(0xd3)]({'where':{'userId':_0x1440a8}});if(!_0x46cafa)throw new common_1[(_0x4a04fb(0x13e))](_0x4a04fb(0x167),common_1[_0x4a04fb(0x160)][_0x4a04fb(0x184)]);const _0x89f01c=_0x46f33d===_0x4a04fb(0x143)?_0x4a04fb(0x147):_0x46f33d===_0x4a04fb(0x178)?_0x4a04fb(0x103):_0x46f33d===_0x4a04fb(0x18d)?_0x4a04fb(0xd5):null,_0x25a35e=_0x46f33d===_0x4a04fb(0x143)?_0x4a04fb(0x10a):_0x46f33d===_0x4a04fb(0x178)?_0x4a04fb(0x104):_0x46f33d==='mjDraw'?_0x4a04fb(0x106):null,_0x5daab5=_0x46cafa[_0x4a04fb(0xf1)]&&_0x46cafa[_0x89f01c]<_0xf20b01?_0x25a35e:_0x46cafa[_0x4a04fb(0xf1)]?_0x89f01c:_0x25a35e;let _0x4abc74=null;_0x5daab5[_0x4a04fb(0x127)](_0x4a04fb(0x11f))&&(_0x4abc74=_0x4a04fb(0x185));_0x5daab5[_0x4a04fb(0x127)]('odel4')&&(_0x4abc74=_0x4a04fb(0x169));_0x5daab5[_0x4a04fb(0x127)](_0x4a04fb(0x101))&&(_0x4abc74=_0x4a04fb(0x175));const _0x5b52cf={[_0x5daab5]:_0x46cafa[_0x5daab5]-_0xf20b01<0x0?0x0:_0x46cafa[_0x5daab5]-_0xf20b01,[_0x4abc74]:_0x46cafa[_0x4abc74]+_0x38b3e0};_0x4abc74===_0x4a04fb(0x185)&&(_0x5b52cf[_0x4a04fb(0x118)]=_0x46cafa[_0x4a04fb(0x118)]+_0xf20b01),_0x4abc74==='useModel4Token'&&(_0x5b52cf[_0x4a04fb(0x18f)]=_0x46cafa[_0x4a04fb(0x18f)]+_0xf20b01);const _0x4618fc=await this[_0x4a04fb(0x125)][_0x4a04fb(0x149)]({'userId':_0x1440a8},_0x5b52cf);if(_0x4618fc[_0x4a04fb(0x12e)]===0x0)throw new common_1[(_0x4a04fb(0x13e))]('消费余额失败！',common_1[_0x4a04fb(0x160)][_0x4a04fb(0x184)]);}async[_0x51ea89(0xfb)](_0x47f943){const _0x59e9e3=_0x51ea89;try{const _0x38ce48=await this['userBalanceEntity'][_0x59e9e3(0xd3)]({'where':{'userId':_0x47f943},'select':[_0x59e9e3(0xf1),_0x59e9e3(0x10a),_0x59e9e3(0x104),'drawMjCount',_0x59e9e3(0x147),_0x59e9e3(0x103),_0x59e9e3(0xd5),_0x59e9e3(0x118),_0x59e9e3(0x18f),_0x59e9e3(0x185),_0x59e9e3(0x169),_0x59e9e3(0x175),_0x59e9e3(0x10c)]});if(!_0x38ce48){const _0x50ab89=await this[_0x59e9e3(0x172)](_0x47f943);if(_0x50ab89)return await this['queryUserBalance'](_0x47f943);else throw new common_1[(_0x59e9e3(0x13e))](_0x59e9e3(0x171),common_1['HttpStatus'][_0x59e9e3(0x184)]);}return _0x38ce48[_0x59e9e3(0x10d)]=_0x38ce48['packageId']?_0x38ce48['model3Count']+_0x38ce48['memberModel3Count']:_0x38ce48[_0x59e9e3(0x10a)],_0x38ce48[_0x59e9e3(0x133)]=_0x38ce48[_0x59e9e3(0xf1)]?_0x38ce48[_0x59e9e3(0x104)]+_0x38ce48[_0x59e9e3(0x103)]:_0x38ce48['model4Count'],_0x38ce48[_0x59e9e3(0x189)]=_0x38ce48[_0x59e9e3(0xf1)]?_0x38ce48['drawMjCount']+_0x38ce48['memberDrawMjCount']:_0x38ce48[_0x59e9e3(0x106)],_0x38ce48[_0x59e9e3(0x10c)]=_0x38ce48['expirationTime']?(0x0,date_1[_0x59e9e3(0xfa)])(_0x38ce48[_0x59e9e3(0x10c)],_0x59e9e3(0x15e)):null,_0x38ce48;}catch(_0x24b862){console[_0x59e9e3(0x17e)](_0x59e9e3(0x18e),_0x24b862);}}async[_0x51ea89(0x121)](_0x5d6db6){const _0x41904e=_0x51ea89,{userId:_0x298a6d,rechargeType:_0x2f019b,model3Count:_0x1ff9c6,model4Count:_0xb9940b,drawMjCount:_0x4dadb8,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x5d6db6;if(!_0x298a6d)throw new common_1[(_0x41904e(0x13e))](_0x41904e(0xd4),common_1[_0x41904e(0x160)][_0x41904e(0x184)]);const _0x20f026=(0x0,utils_1[_0x41904e(0x152)])();return await this[_0x41904e(0x145)]['save']({'userId':_0x298a6d,'rechargeType':_0x2f019b,'model3Count':_0x1ff9c6,'model4Count':_0xb9940b,'drawMjCount':_0x4dadb8,'days':days,'extent':extent,'uid':_0x20f026,'pkgName':pkgName});}async[_0x51ea89(0x172)](_0x949e81,_0x4e70df={}){const _0x215f02=_0x51ea89,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4e70df,_0x59fc1c=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x949e81}});if(_0x59fc1c)throw new common_1[(_0x215f02(0x13e))](_0x215f02(0x14f),common_1[_0x215f02(0x160)]['BAD_REQUEST']);return await this[_0x215f02(0x125)][_0x215f02(0x139)]({'userId':_0x949e81,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x51ea89(0x170)](_0x587302,_0x5876df,_0x4c4f31=-0x1){const _0x719d0d=_0x51ea89;try{const _0x5b26dc=await this[_0x719d0d(0x125)][_0x719d0d(0xd3)]({'where':{'userId':_0x587302}})||await this[_0x719d0d(0x172)](_0x587302);if(!_0x5b26dc)throw new common_1[(_0x719d0d(0x13e))](_0x719d0d(0xf0),common_1[_0x719d0d(0x160)]['BAD_REQUEST']);const {model3Count:_0x2b4bdd,model4Count:_0x411c15,drawMjCount:_0x1bae18,memberModel3Count:_0x465f19,memberModel4Count:_0x35c9bc,memberDrawMjCount:_0x18462f}=_0x5b26dc;let _0x24dcac={};if(_0x4c4f31>0x0){const {packageId:_0x5c6d2e}=_0x5876df;if(!_0x5c6d2e)throw new common_1[(_0x719d0d(0x13e))]('缺失当前套餐ID、充值失败！',common_1[_0x719d0d(0x160)][_0x719d0d(0x184)]);const _0x235e20=await this[_0x719d0d(0x111)][_0x719d0d(0xd3)]({'where':{'id':_0x5c6d2e}});if(!_0x235e20)throw new common_1[(_0x719d0d(0x13e))]('当前套餐不存在！',common_1[_0x719d0d(0x160)][_0x719d0d(0x184)]);const {weight:_0x57f99c}=_0x235e20;if(!_0x5b26dc[_0x719d0d(0xf1)])_0x24dcac={'memberModel3Count':_0x2b4bdd+_0x5876df[_0x719d0d(0x10a)],'memberModel4Count':_0x411c15+_0x5876df['model4Count'],'memberDrawMjCount':_0x1bae18+_0x5876df[_0x719d0d(0x106)],'expirationTime':(0x0,date_1[_0x719d0d(0x148)])()[_0x719d0d(0x13c)](_0x4c4f31>0x0?_0x4c4f31:0x0,_0x719d0d(0x14a))[_0x719d0d(0x135)](_0x719d0d(0x15b)),'packageId':_0x5c6d2e};else{const _0x5305b4=await this[_0x719d0d(0x111)][_0x719d0d(0xd3)]({'where':{'id':_0x5b26dc[_0x719d0d(0xf1)]}});_0x57f99c>=_0x5305b4['weight']&&(_0x24dcac={'memberModel3Count':_0x465f19+_0x5876df['model3Count'],'memberModel4Count':_0x35c9bc+_0x5876df[_0x719d0d(0x104)],'memberDrawMjCount':_0x18462f+_0x5876df[_0x719d0d(0x106)],'expirationTime':(0x0,date_1[_0x719d0d(0x148)])(_0x5b26dc['expirationTime'])[_0x719d0d(0x13c)](_0x4c4f31>0x0?_0x4c4f31:0x0,_0x719d0d(0x14a))[_0x719d0d(0x135)](_0x719d0d(0x15b)),'packageId':_0x5c6d2e}),_0x57f99c<_0x5305b4['weight']&&(_0x24dcac={'memberModel3Count':_0x465f19+_0x5876df['model3Count'],'memberModel4Count':_0x35c9bc+_0x5876df['model4Count'],'memberDrawMjCount':_0x18462f+_0x5876df[_0x719d0d(0x106)]});}}_0x4c4f31<=0x0&&(_0x24dcac={'model3Count':_0x2b4bdd+_0x5876df['model3Count'],'model4Count':_0x411c15+_0x5876df[_0x719d0d(0x104)],'drawMjCount':_0x1bae18+_0x5876df[_0x719d0d(0x106)]});const _0x5998ed=await this['userBalanceEntity']['update']({'userId':_0x587302},_0x24dcac);if(_0x5998ed['affected']===0x0)throw new common_1[(_0x719d0d(0x13e))](_0x587302+_0x719d0d(0x120),common_1['HttpStatus'][_0x719d0d(0x184)]);}catch(_0x4e2a2b){console['log'](_0x719d0d(0x18e),_0x4e2a2b);throw new common_1[(_0x719d0d(0x13e))]('用户充值失败！',common_1['HttpStatus'][_0x719d0d(0x184)]);}}async['addBalanceToOrder'](_0x55e861){const _0x217460=_0x51ea89;console['log'](_0x217460(0x155),_0x55e861);try{const {userId:_0x28db88,goodsId:_0x3389f6}=_0x55e861,_0x5f28da=await this[_0x217460(0x111)][_0x217460(0xd3)]({'where':{'id':_0x55e861[_0x217460(0x182)],'status':0x1}});if(!_0x5f28da)throw new common_1[(_0x217460(0x13e))]('非法操作、当前充值套餐暂不存在！',common_1['HttpStatus']['BAD_REQUEST']);const {model3Count:_0x2fb6e9,model4Count:_0x5bbac7,drawMjCount:_0x495927,days:_0x52b573,name:_0x1be487}=_0x5f28da,_0x4cdd88={'model3Count':_0x2fb6e9,'model4Count':_0x5bbac7,'drawMjCount':_0x495927,'days':_0x52b573,'packageId':_0x55e861['goodsId']};await this[_0x217460(0x170)](_0x28db88,_0x4cdd88,_0x52b573),await this[_0x217460(0x121)]({'userId':_0x28db88,'rechargeType':balance_constant_1[_0x217460(0x17a)][_0x217460(0x10b)],'model3Count':_0x2fb6e9,'model4Count':_0x5bbac7,'drawMjCount':_0x495927,'pkgName':_0x1be487,'days':_0x52b573});const _0x389415=await this['userEntity']['findOne']({'where':{'id':_0x28db88}}),{invitedBy:_0x32e41c}=_0x389415;if(_0x32e41c){const _0x1e9fae=await this['userEntity'][_0x217460(0xd3)]({'where':{'inviteCode':_0x32e41c}}),_0x100e4c=await this['salesUsersEntity'][_0x217460(0xd3)]({'where':{'userId':_0x1e9fae['id']}});if(!_0x1e9fae)return;const {id:_0x2a3714}=_0x1e9fae,{performanceRatio:_0x4c6d27}=_0x100e4c,_0x51db0b={'inviterUserId':_0x2a3714,'inviteeUserId':_0x28db88,'orderId':_0x55e861['id'],'orderPrice':_0x55e861['total'],'commissionPercentage':_0x4c6d27,'commissionAmount':(_0x55e861['total']*_0x4c6d27/0x64)['toFixed'](0x2)};await this['salesService'][_0x217460(0x159)](_0x51db0b),await this[_0x217460(0x180)]['saveCommissionAmount'](_0x2a3714,_0x51db0b[_0x217460(0xde)]);}}catch(_0x320b2f){console[_0x217460(0x17e)](_0x217460(0x18e),_0x320b2f);throw new common_1[(_0x217460(0x13e))]('充值失败！',common_1[_0x217460(0x160)][_0x217460(0x184)]);}}async['getRechargeLog'](_0x5690e6,_0x19a214){const _0x1f8d81=_0x51ea89,{page:page=0x1,size:size=0x14}=_0x19a214,{id:_0x2e254c}=_0x5690e6[_0x1f8d81(0xec)],[_0x5a9b41,_0x4f49dc]=await this[_0x1f8d81(0x145)][_0x1f8d81(0x122)]({'where':{'userId':_0x2e254c},'order':{'id':_0x1f8d81(0x154)},'skip':(page-0x1)*size,'take':size});return _0x5a9b41['forEach'](_0xf8c986=>{const _0xd98beb=_0x1f8d81;_0xf8c986[_0xd98beb(0xf2)]=_0xf8c986[_0xd98beb(0x102)]>0x0?_0xf8c986[_0xd98beb(0x102)]+'天':'永久';}),{'rows':(0x0,date_1[_0x1f8d81(0x136)])(_0x5a9b41),'count':_0x4f49dc};}async['getAccountLog'](_0x1d15a0,_0x34722d){const _0x487cff=_0x51ea89;try{const {page:page=0x1,size:size=0xa,userId:_0x4d6422,rechargeType:_0x5f4f7b,packageId:_0xea3861}=_0x34722d,{role:_0x51b795}=_0x1d15a0[_0x487cff(0xec)],_0x7c86d0={};_0x5f4f7b&&(_0x7c86d0[_0x487cff(0xeb)]=_0x5f4f7b),_0x7c86d0['userId']=_0x4d6422||(0x0,typeorm_2[_0x487cff(0x11c)])(0x186a0),_0xea3861&&(_0x7c86d0[_0x487cff(0xf1)]={'$like':'%'+_0xea3861+'%'});const [_0x2cd06c,_0x5e7a3e]=await this[_0x487cff(0x145)][_0x487cff(0x122)]({'where':_0x7c86d0,'order':{'id':_0x487cff(0x154)},'skip':(page-0x1)*size,'take':size}),_0x5f1910=_0x2cd06c[_0x487cff(0x132)](_0x1ecfd0=>_0x1ecfd0['userId']),_0x4c8367=await this[_0x487cff(0x105)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x5f1910)}});return _0x2cd06c[_0x487cff(0x115)](_0x4d319f=>{const _0xd6301d=_0x487cff,_0x59ef1f=_0x4c8367['find'](_0x1b7989=>_0x1b7989['id']===_0x4d319f[_0xd6301d(0x151)]);_0x4d319f[_0xd6301d(0x165)]=_0x59ef1f===null||_0x59ef1f===void 0x0?void 0x0:_0x59ef1f['username'],_0x4d319f[_0xd6301d(0x13d)]=_0x59ef1f===null||_0x59ef1f===void 0x0?void 0x0:_0x59ef1f[_0xd6301d(0x13d)],_0x4d319f[_0xd6301d(0x173)]=_0x59ef1f===null||_0x59ef1f===void 0x0?void 0x0:_0x59ef1f['phone'],_0x4d319f[_0xd6301d(0xfe)]=_0x59ef1f===null||_0x59ef1f===void 0x0?void 0x0:_0x59ef1f[_0xd6301d(0xfe)],_0x4d319f[_0xd6301d(0xce)]=_0x59ef1f===null||_0x59ef1f===void 0x0?void 0x0:_0x59ef1f[_0xd6301d(0xce)];}),_0x51b795!==_0x487cff(0x16e)&&_0x2cd06c['forEach'](_0xd8dd0f=>{const _0x3f0399=_0x487cff;_0xd8dd0f[_0x3f0399(0x13d)]=_0xd8dd0f['email']?(0x0,utils_1[_0x3f0399(0x179)])(_0xd8dd0f[_0x3f0399(0x13d)]):'',_0xd8dd0f[_0x3f0399(0x173)]=_0xd8dd0f[_0x3f0399(0x173)]?(0x0,utils_1[_0x3f0399(0x179)])(_0xd8dd0f['phone']):'';}),{'rows':_0x2cd06c,'count':_0x5e7a3e};}catch(_0x12c03c){console['log'](_0x487cff(0x18e),_0x12c03c);throw new common_1[(_0x487cff(0x13e))]('查询用户账户失败！',common_1[_0x487cff(0x160)][_0x487cff(0x184)]);}}async[_0x51ea89(0x156)](_0x6b9fc3){const _0x2c4402=_0x51ea89;return await this[_0x2c4402(0x125)][_0x2c4402(0xf5)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x6b9fc3)}});}async[_0x51ea89(0x129)](_0x21b2c4,_0x301966){const _0x413577=_0x51ea89;return await this[_0x413577(0x100)](_0x21b2c4,_0x413577(0x18d),-_0x301966);}async[_0x51ea89(0x107)](){const _0x5b76a1=_0x51ea89,_0x2abecd=await this[_0x5b76a1(0x105)][_0x5b76a1(0xf5)]();if(!_0x2abecd[_0x5b76a1(0x12b)])return;const _0xe1db7a=await this[_0x5b76a1(0x161)]['getConfigs']([_0x5b76a1(0x117)]);if(!_0xe1db7a)await this[_0x5b76a1(0x161)][_0x5b76a1(0xe1)]({'settings':[{'configKey':_0x5b76a1(0x117),'configVal':'1'}]});else throw new common_1[(_0x5b76a1(0x13e))](_0x5b76a1(0x18a),common_1[_0x5b76a1(0x160)][_0x5b76a1(0x184)]);_0x2abecd['forEach'](_0x5da673=>{const _0x282c83=_0x5b76a1,{id:_0x3840df}=_0x5da673;this[_0x282c83(0xd8)][_0x282c83(0xd3)]({'where':{'userId':_0x3840df}})[_0x282c83(0x119)](_0x1443fc=>{const _0x891251=_0x282c83;if(!_0x1443fc)return;this[_0x891251(0x168)](_0x3840df,_0x1443fc);});});}async[_0x51ea89(0x168)](_0x36e948,_0x520c09){const _0x27b609=_0x51ea89,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x520c09,_0x462bf5=await this[_0x27b609(0xe4)][_0x27b609(0xd3)]({'where':{'userId':_0x36e948}}),_0x4add0b={'userId':_0x36e948,'model3Count':Number(usesLeft),'model4Count':(_0x462bf5===null||_0x462bf5===void 0x0?void 0x0:_0x462bf5[_0x27b609(0x137)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x462bf5===null||_0x462bf5===void 0x0?void 0x0:_0x462bf5['useCount'])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x306efa=await this[_0x27b609(0x125)][_0x27b609(0xd3)]({'where':{'userId':_0x36e948}});_0x306efa?common_1[_0x27b609(0x17f)][_0x27b609(0xfc)]('用户'+_0x36e948+_0x27b609(0x10f),'BalanceService'):this[_0x27b609(0x125)][_0x27b609(0x139)](_0x4add0b)['then'](_0x123157=>{const _0xb57a98=_0x27b609;common_1[_0xb57a98(0x17f)]['debug']('用户'+_0x36e948+_0xb57a98(0xff),_0xb57a98(0xda));})['catch'](_0x4212ba=>{const _0x437449=_0x27b609;console[_0x437449(0x17e)](_0x437449(0x18e),_0x4212ba),common_1[_0x437449(0x17f)]['debug']('用户'+_0x36e948+_0x437449(0x134),_0x437449(0xda));});}async['inheritVisitorData'](_0x412164){const _0x550be7=_0x51ea89,{fingerprint:_0x3a2ac5}=_0x412164[_0x550be7(0x16a)],{id:_0x380c1c}=_0x412164[_0x550be7(0xec)];return await this[_0x550be7(0x16c)][_0x550be7(0x149)]({'userId':Number(_0x3a2ac5)},{'userId':_0x380c1c}),await this[_0x550be7(0xf3)][_0x550be7(0x149)]({'userId':Number(_0x3a2ac5)},{'userId':_0x380c1c}),await this[_0x550be7(0x11b)][_0x550be7(0x149)]({'userId':Number(_0x3a2ac5)},{'userId':_0x380c1c}),0x1;}async[_0x51ea89(0xd9)](_0x14dec8){const _0x26fc20=_0x51ea89,{fingerprint:_0xe5e77}=_0x14dec8['headers'],_0x46861e=await this[_0x26fc20(0x16c)][_0x26fc20(0x137)]({'where':{'userId':_0xe5e77}}),_0x13e672=await this[_0x26fc20(0xf3)][_0x26fc20(0x137)]({'where':{'userId':_0xe5e77}}),_0x3222eb=await this['midjourneyEntity'][_0x26fc20(0x137)]({'where':{'userId':_0xe5e77}});return _0x46861e||_0x13e672||_0x3222eb||0x0;}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x51ea89(0x17d)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x51ea89(0x174)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x51ea89(0x130)])),__param(0x3,(0x0,typeorm_1[_0x51ea89(0x17d)])(cramiPackage_entity_1[_0x51ea89(0x12d)])),__param(0x4,(0x0,typeorm_1[_0x51ea89(0x17d)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x51ea89(0x17d)])(user_entity_1[_0x51ea89(0x138)])),__param(0x6,(0x0,typeorm_1[_0x51ea89(0x17d)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1[_0x51ea89(0x17d)])(whiteList_entity_1['WhiteListEntity'])),__param(0x8,(0x0,typeorm_1[_0x51ea89(0x17d)])(fingerprint_entity_1[_0x51ea89(0xd7)])),__param(0x9,(0x0,typeorm_1[_0x51ea89(0x17d)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0xa,(0x0,typeorm_1[_0x51ea89(0x17d)])(chatLog_entity_1[_0x51ea89(0x150)])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x51ea89(0x12c)])),__metadata(_0x51ea89(0x112),[typeorm_2[_0x51ea89(0xdd)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],typeorm_2[_0x51ea89(0xdd)],sales_service_1[_0x51ea89(0x16b)],globalConfig_service_1[_0x51ea89(0xef)]])],UserBalanceService),exports[_0x51ea89(0x164)]=UserBalanceService;