'use strict';const _0x8c6ab4=_0x33ea;(function(_0x4c7bca,_0x3c988f){const _0x2e22f0=_0x33ea,_0x5e98c3=_0x4c7bca();while(!![]){try{const _0x2a4cba=-parseInt(_0x2e22f0(0x12a))/0x1*(-parseInt(_0x2e22f0(0xad))/0x2)+-parseInt(_0x2e22f0(0x9e))/0x3*(parseInt(_0x2e22f0(0x96))/0x4)+parseInt(_0x2e22f0(0x101))/0x5*(parseInt(_0x2e22f0(0xc0))/0x6)+-parseInt(_0x2e22f0(0x83))/0x7+-parseInt(_0x2e22f0(0xf1))/0x8*(-parseInt(_0x2e22f0(0x122))/0x9)+-parseInt(_0x2e22f0(0xba))/0xa*(-parseInt(_0x2e22f0(0x10d))/0xb)+-parseInt(_0x2e22f0(0xdf))/0xc*(-parseInt(_0x2e22f0(0xa1))/0xd);if(_0x2a4cba===_0x3c988f)break;else _0x5e98c3['push'](_0x5e98c3['shift']());}catch(_0x59c732){_0x5e98c3['push'](_0x5e98c3['shift']());}}}(_0x2a5f,0x8cd05));var __decorate=this&&this[_0x8c6ab4(0x6d)]||function(_0x1f950a,_0x5d1af9,_0x22e019,_0x597113){const _0x534dde=_0x8c6ab4;var _0x41e70c=arguments[_0x534dde(0xce)],_0x3a7578=_0x41e70c<0x3?_0x5d1af9:_0x597113===null?_0x597113=Object['getOwnPropertyDescriptor'](_0x5d1af9,_0x22e019):_0x597113,_0x7e9cef;if(typeof Reflect===_0x534dde(0x76)&&typeof Reflect[_0x534dde(0x111)]===_0x534dde(0x97))_0x3a7578=Reflect[_0x534dde(0x111)](_0x1f950a,_0x5d1af9,_0x22e019,_0x597113);else{for(var _0x43e1df=_0x1f950a[_0x534dde(0xce)]-0x1;_0x43e1df>=0x0;_0x43e1df--)if(_0x7e9cef=_0x1f950a[_0x43e1df])_0x3a7578=(_0x41e70c<0x3?_0x7e9cef(_0x3a7578):_0x41e70c>0x3?_0x7e9cef(_0x5d1af9,_0x22e019,_0x3a7578):_0x7e9cef(_0x5d1af9,_0x22e019))||_0x3a7578;}return _0x41e70c>0x3&&_0x3a7578&&Object['defineProperty'](_0x5d1af9,_0x22e019,_0x3a7578),_0x3a7578;},__metadata=this&&this[_0x8c6ab4(0xeb)]||function(_0x154da8,_0x3d2b21){const _0x1ccc68=_0x8c6ab4;if(typeof Reflect===_0x1ccc68(0x76)&&typeof Reflect['metadata']===_0x1ccc68(0x97))return Reflect[_0x1ccc68(0x7b)](_0x154da8,_0x3d2b21);},__param=this&&this[_0x8c6ab4(0x9c)]||function(_0x1c1678,_0x15bb9d){return function(_0x4da20b,_0x153c26){_0x15bb9d(_0x4da20b,_0x153c26,_0x1c1678);};};Object[_0x8c6ab4(0x109)](exports,_0x8c6ab4(0xff),{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require(_0x8c6ab4(0x67)),typeorm_1=require(_0x8c6ab4(0xd9)),balance_entity_1=require('./balance.entity'),common_1=require('@nestjs/common'),typeorm_2=require('typeorm'),balance_constant_1=require(_0x8c6ab4(0xfe)),accountLog_entity_1=require(_0x8c6ab4(0xd4)),utils_1=require(_0x8c6ab4(0xde)),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require(_0x8c6ab4(0xb7)),userBalance_entity_1=require(_0x8c6ab4(0x9d)),date_1=require('../../common/utils/date'),user_entity_1=require(_0x8c6ab4(0x11a)),salesUsers_entity_1=require(_0x8c6ab4(0x11e)),sales_service_1=require(_0x8c6ab4(0xb5)),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x8c6ab4(0xd6)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x8c6ab4(0x98)),midjourney_entity_1=require('../midjourney/midjourney.entity');let UserBalanceService=class UserBalanceService{constructor(_0x4fa85e,_0x279e0b,_0x3efcf9,_0x3b1a85,_0x3203af,_0x53d9c0,_0x5209f0,_0x5787fd,_0x3424b1,_0x3c527a,_0x17ed05,_0x3114e3,_0x1518d0,_0x29188e){const _0x47b6f6=_0x8c6ab4;this[_0x47b6f6(0x9f)]=_0x4fa85e,this[_0x47b6f6(0xea)]=_0x279e0b,this[_0x47b6f6(0xa5)]=_0x3efcf9,this[_0x47b6f6(0xed)]=_0x3b1a85,this[_0x47b6f6(0x90)]=_0x3203af,this[_0x47b6f6(0xe7)]=_0x53d9c0,this['salesUsersEntity']=_0x5209f0,this['whiteListEntity']=_0x5787fd,this['fingerprintLogEntity']=_0x3424b1,this[_0x47b6f6(0x9b)]=_0x3c527a,this[_0x47b6f6(0x75)]=_0x17ed05,this[_0x47b6f6(0x117)]=_0x3114e3,this[_0x47b6f6(0x10b)]=_0x1518d0,this[_0x47b6f6(0x94)]=_0x29188e;}async['addBalanceToNewUser'](_0x53f447,_0x5348cc){const _0x3a6190=_0x8c6ab4;try{const _0x10154b=await this[_0x3a6190(0x90)][_0x3a6190(0x8d)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3a6190(0xf0),_0x3a6190(0x7a),_0x3a6190(0x123),'registerSendDrawMjCount',_0x3a6190(0x85),'firstRegisterSendRank',_0x3a6190(0x7e),'firstRregisterSendModel4Count',_0x3a6190(0xf2),'inviteSendStatus',_0x3a6190(0xd0),_0x3a6190(0xcd),_0x3a6190(0xbf),_0x3a6190(0xca),_0x3a6190(0xbe),_0x3a6190(0xe3)])}}),_0x53f335=_0x10154b[_0x3a6190(0x70)]((_0x378499,_0xc33136)=>{const _0x174472=_0x3a6190,_0x499766=Number(_0xc33136[_0x174472(0xfa)]),_0x42fccf=Number[_0x174472(0x118)](_0x499766)&&_0x499766>0x0?_0x499766:0x0;return _0x378499[_0xc33136[_0x174472(0x8f)]]=_0x42fccf,_0x378499;},{});let _0x1fce86=0x0,_0x14e93e=0x0,_0x68720e=0x0;_0x53f335[_0x3a6190(0xf0)]===0x1&&(_0x1fce86=_0x1fce86+_0x53f335[_0x3a6190(0x7a)],_0x14e93e=_0x14e93e+_0x53f335[_0x3a6190(0x123)],_0x68720e=_0x68720e+_0x53f335[_0x3a6190(0x124)]),_0x53f335[_0x3a6190(0xf0)]===0x1&&_0x53f335[_0x3a6190(0x85)]===0x1&&_0x53f447<=_0x53f335['firstRegisterSendRank']&&(_0x1fce86=_0x1fce86+_0x53f335[_0x3a6190(0x7e)],_0x14e93e=_0x14e93e+_0x53f335[_0x3a6190(0x9a)],_0x68720e=_0x68720e+_0x53f335[_0x3a6190(0xf2)]),await this[_0x3a6190(0xc9)]({'userId':_0x53f447,'rechargeType':balance_constant_1['RechargeType'][_0x3a6190(0x10f)],'model3Count':_0x1fce86,'drawMjCount':_0x68720e,'model4Count':_0x14e93e}),_0x5348cc&&(Number(_0x53f335['inviteSendStatus'])===0x1&&(_0x1fce86=_0x1fce86+Number(_0x53f335[_0x3a6190(0xca)]),_0x14e93e=_0x14e93e+Number(_0x53f335[_0x3a6190(0xe3)]),_0x68720e=_0x68720e+Number(_0x53f335[_0x3a6190(0xbe)]),await this[_0x3a6190(0xc9)]({'userId':_0x53f447,'rechargeType':balance_constant_1[_0x3a6190(0xd1)]['INVITE_GIFT'],'model3Count':_0x53f335[_0x3a6190(0xca)],'model4Count':_0x53f335[_0x3a6190(0xe3)],'drawMjCount':_0x53f335[_0x3a6190(0xbe)]}),await this[_0x3a6190(0xc2)](_0x5348cc,{'model3Count':_0x53f335[_0x3a6190(0xd0)],'model4Count':_0x53f335['inviteGiveSendModel4Count'],'drawMjCount':_0x53f335[_0x3a6190(0xbf)]}),await this['saveRecordRechargeLog']({'userId':_0x5348cc,'rechargeType':balance_constant_1['RechargeType']['REFER_GIFT'],'model3Count':_0x53f335[_0x3a6190(0xd0)],'model4Count':_0x53f335[_0x3a6190(0xcd)],'drawMjCount':_0x53f335[_0x3a6190(0xbf)]}))),await this[_0x3a6190(0xea)]['save']({'userId':_0x53f447,'model3Count':_0x1fce86,'model4Count':_0x14e93e,'drawMjCount':_0x68720e,'useTokens':0x0});}catch(_0x145dc7){console['log'](_0x3a6190(0x108),_0x145dc7);throw new common_1[(_0x3a6190(0xdd))](_0x3a6190(0xc3),common_1[_0x3a6190(0x79)][_0x3a6190(0x110)]);}}async[_0x8c6ab4(0xb3)](_0x5849be,_0x3669c8,_0x36ded2){const _0x13fc30=_0x8c6ab4,{id:_0x20600a,role:_0x5d782d}=_0x5849be['user'];let _0x598acb=await this[_0x13fc30(0xea)][_0x13fc30(0x125)]({'where':{'userId':_0x20600a}});!_0x598acb&&(_0x598acb=await this['createBaseUserBalance'](_0x20600a));if(_0x5d782d==='visitor')return this[_0x13fc30(0xe0)](_0x5849be,_0x3669c8,_0x36ded2);const _0x1f44e6=await this['configEntity']['findOne']({'where':{'configKey':_0x13fc30(0x87)}}),_0x5aac6a=_0x1f44e6?_0x1f44e6[_0x13fc30(0xfa)]:_0x13fc30(0x105),_0xe997fa=_0x3669c8===_0x13fc30(0xae)?_0x13fc30(0x103):_0x3669c8===_0x13fc30(0xb1)?_0x13fc30(0x115):_0x3669c8===_0x13fc30(0x68)?'memberDrawMjCount':null,_0x9855e7=_0x3669c8===_0x13fc30(0xae)?_0x13fc30(0xd8):_0x3669c8==='model4'?'model4Count':_0x3669c8===_0x13fc30(0x68)?_0x13fc30(0x10a):null;if(_0x598acb[_0x13fc30(0x11b)]&&_0x598acb[_0xe997fa]<_0x36ded2){if(_0x598acb[_0x9855e7]<_0x36ded2)throw new common_1[(_0x13fc30(0xdd))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x5aac6a+_0x13fc30(0x6a),common_1[_0x13fc30(0x79)]['PAYMENT_REQUIRED']);}if(!_0x598acb[_0x13fc30(0x11b)]&&_0x598acb[_0x9855e7]<_0x36ded2)throw new common_1[(_0x13fc30(0xdd))](_0x13fc30(0xcb)+_0x5aac6a+_0x13fc30(0x6a),common_1[_0x13fc30(0x79)][_0x13fc30(0xe2)]);return _0x598acb;}async[_0x8c6ab4(0xe0)](_0x249daf,_0x266a98,_0x91401){const _0x10de87=_0x8c6ab4,{id:_0x2ce2d8}=_0x249daf['user'],_0x35445e=_0x266a98===_0x10de87(0xae)?'model3Count':_0x266a98===_0x10de87(0xb1)?_0x10de87(0x7c):_0x266a98===_0x10de87(0x68)?_0x10de87(0x10a):null,_0x4b7816=new Date(),_0x3847bf=await this['fingerprintLogEntity']['findOne']({'where':{'fingerprint':_0x2ce2d8}}),{visitorModel3Num:_0x718613,visitorModel4Num:_0x454923,visitorMJNum:_0x2a710f}=await this[_0x10de87(0x94)][_0x10de87(0xd2)]([_0x10de87(0x127),'visitorModel4Num','visitorMJNum']),_0x2008cc={'model3Count':_0x718613?Number(_0x718613):0x0,'model4Count':_0x454923?Number(_0x454923):0x0,'drawMjCount':_0x2a710f?Number(_0x2a710f):0x0};if(!_0x3847bf){const _0xb4ac1d={'fingerprint':_0x2ce2d8,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0xb4ac1d[_0x35445e]=_0xb4ac1d[_0x35445e]+_0x91401;if(_0xb4ac1d[_0x35445e]>_0x2008cc[_0x35445e])throw new common_1[(_0x10de87(0xdd))](_0x10de87(0xe1),common_1[_0x10de87(0x79)][_0x10de87(0xe2)]);else return await this[_0x10de87(0xee)][_0x10de87(0x92)](_0xb4ac1d),!![];}else{const {model3Count:_0x17dd44,model4Count:_0x400cca,drawMjCount:_0x4542a3}=_0x3847bf;let _0x2a805a={'model3Count':_0x17dd44,'model4Count':_0x400cca,'drawMjCount':_0x4542a3};const _0x5cd498=Number(new Date(_0x3847bf['updatedAt'])),_0x43f326=this[_0x10de87(0x120)](_0x5cd498);_0x43f326?_0x2a805a[_0x35445e]=_0x2a805a[_0x35445e]+_0x91401:(_0x2a805a={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x2a805a[_0x35445e]=_0x2a805a[_0x35445e]+_0x91401);if(_0x2a805a[_0x35445e]>_0x2008cc[_0x35445e])throw new common_1[(_0x10de87(0xdd))](_0x10de87(0xe1),common_1[_0x10de87(0x79)][_0x10de87(0xe2)]);else return await this[_0x10de87(0xee)]['update']({'fingerprint':_0x2ce2d8},_0x2a805a),!![];}}[_0x8c6ab4(0x120)](_0x4ade0e){const _0x5c57c6=_0x8c6ab4,_0x55d2f4=new Date(),_0x427c84=new Date(_0x55d2f4[_0x5c57c6(0xc4)](),_0x55d2f4[_0x5c57c6(0xc5)](),_0x55d2f4['getDate']());return _0x4ade0e>=_0x427c84;}async[_0x8c6ab4(0x10c)](_0xcb557a,_0xb78ede,_0x2ea1c6,_0x27d228=0x0){const _0x2076e9=_0x8c6ab4,_0x3654cb=await this['userBalanceEntity'][_0x2076e9(0x125)]({'where':{'userId':_0xcb557a}});if(!_0x3654cb)throw new common_1['HttpException'](_0x2076e9(0x11f),common_1[_0x2076e9(0x79)]['BAD_REQUEST']);const _0x5f563e=_0xb78ede===_0x2076e9(0xae)?_0x2076e9(0x103):_0xb78ede==='model4'?'memberModel4Count':_0xb78ede===_0x2076e9(0x68)?_0x2076e9(0x8e):null,_0x40079e=_0xb78ede==='model3'?_0x2076e9(0xd8):_0xb78ede===_0x2076e9(0xb1)?_0x2076e9(0x7c):_0xb78ede==='mjDraw'?_0x2076e9(0x10a):null,_0x2c4ee9=_0x3654cb[_0x2076e9(0x11b)]&&_0x3654cb[_0x5f563e]<_0x2ea1c6?_0x40079e:_0x3654cb[_0x2076e9(0x11b)]?_0x5f563e:_0x40079e;let _0x5bd2d5=null;_0x2c4ee9['includes'](_0x2076e9(0x126))&&(_0x5bd2d5='useModel3Token');_0x2c4ee9['includes']('odel4')&&(_0x5bd2d5='useModel4Token');_0x2c4ee9[_0x2076e9(0xc8)](_0x2076e9(0xa0))&&(_0x5bd2d5=_0x2076e9(0xa9));const _0xeddce1={[_0x2c4ee9]:_0x3654cb[_0x2c4ee9]-_0x2ea1c6<0x0?0x0:_0x3654cb[_0x2c4ee9]-_0x2ea1c6,[_0x5bd2d5]:_0x3654cb[_0x5bd2d5]+_0x27d228};_0x5bd2d5===_0x2076e9(0xfc)&&(_0xeddce1[_0x2076e9(0x114)]=_0x3654cb[_0x2076e9(0x114)]+_0x2ea1c6),_0x5bd2d5==='useModel4Token'&&(_0xeddce1[_0x2076e9(0xe5)]=_0x3654cb[_0x2076e9(0xe5)]+_0x2ea1c6);const _0x55587d=await this[_0x2076e9(0xea)][_0x2076e9(0xe9)]({'userId':_0xcb557a},_0xeddce1);if(_0x55587d['affected']===0x0)throw new common_1[(_0x2076e9(0xdd))](_0x2076e9(0xbc),common_1[_0x2076e9(0x79)]['BAD_REQUEST']);}async[_0x8c6ab4(0x6c)](_0x42448c){const _0x55c436=_0x8c6ab4;try{const _0x20687b=await this[_0x55c436(0xea)][_0x55c436(0x125)]({'where':{'userId':_0x42448c},'select':[_0x55c436(0x11b),_0x55c436(0xd8),_0x55c436(0x7c),_0x55c436(0x10a),'memberModel3Count',_0x55c436(0x115),_0x55c436(0x8e),'useModel3Count',_0x55c436(0xe5),_0x55c436(0xfc),_0x55c436(0x11c),_0x55c436(0xa9),_0x55c436(0xac)]});if(!_0x20687b){const _0x188c55=await this[_0x55c436(0x84)](_0x42448c);if(_0x188c55)return await this[_0x55c436(0x6c)](_0x42448c);else throw new common_1[(_0x55c436(0xdd))](_0x55c436(0x8a),common_1[_0x55c436(0x79)][_0x55c436(0x110)]);}return _0x20687b[_0x55c436(0x74)]=_0x20687b[_0x55c436(0x11b)]?_0x20687b[_0x55c436(0xd8)]+_0x20687b['memberModel3Count']:_0x20687b['model3Count'],_0x20687b[_0x55c436(0x71)]=_0x20687b['packageId']?_0x20687b[_0x55c436(0x7c)]+_0x20687b[_0x55c436(0x115)]:_0x20687b[_0x55c436(0x7c)],_0x20687b[_0x55c436(0xa8)]=_0x20687b[_0x55c436(0x11b)]?_0x20687b[_0x55c436(0x10a)]+_0x20687b['memberDrawMjCount']:_0x20687b[_0x55c436(0x10a)],_0x20687b[_0x55c436(0xac)]=_0x20687b[_0x55c436(0xac)]?(0x0,date_1[_0x55c436(0xdc)])(_0x20687b[_0x55c436(0xac)],'YYYY-MM-DD'):null,_0x20687b;}catch(_0x2d7b5c){console[_0x55c436(0x113)](_0x55c436(0x108),_0x2d7b5c);}}async['saveRecordRechargeLog'](_0x3021d0){const _0x513305=_0x8c6ab4,{userId:_0x1b0d2e,rechargeType:_0x4b4078,model3Count:_0x40e4c7,model4Count:_0x3aa47e,drawMjCount:_0x49dc96,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x3021d0;if(!_0x1b0d2e)throw new common_1[(_0x513305(0xdd))](_0x513305(0x89),common_1[_0x513305(0x79)][_0x513305(0x110)]);const _0xcf1024=(0x0,utils_1[_0x513305(0x77)])();return await this[_0x513305(0xa5)]['save']({'userId':_0x1b0d2e,'rechargeType':_0x4b4078,'model3Count':_0x40e4c7,'model4Count':_0x3aa47e,'drawMjCount':_0x49dc96,'days':days,'extent':extent,'uid':_0xcf1024,'pkgName':pkgName});}async['createBaseUserBalance'](_0x4e28e6,_0x4019dc={}){const _0xb69ef=_0x8c6ab4,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4019dc,_0x1e0685=await this[_0xb69ef(0xea)][_0xb69ef(0x125)]({'where':{'userId':_0x4e28e6}});if(_0x1e0685)throw new common_1[(_0xb69ef(0xdd))](_0xb69ef(0xcf),common_1[_0xb69ef(0x79)][_0xb69ef(0x110)]);return await this['userBalanceEntity'][_0xb69ef(0x92)]({'userId':_0x4e28e6,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x8c6ab4(0xc2)](_0x457022,_0x7971b7,_0x3a4121=-0x1){const _0x35f38a=_0x8c6ab4;try{const _0x52ef9f=await this[_0x35f38a(0xea)]['findOne']({'where':{'userId':_0x457022}})||await this[_0x35f38a(0x84)](_0x457022);if(!_0x52ef9f)throw new common_1['HttpException'](_0x35f38a(0x7d),common_1[_0x35f38a(0x79)][_0x35f38a(0x110)]);const {model3Count:_0x25c821,model4Count:_0x2c805f,drawMjCount:_0x16dc49,memberModel3Count:_0x1e4b1c,memberModel4Count:_0xf4026b,memberDrawMjCount:_0x32d4ea}=_0x52ef9f;let _0x1c42c2={};if(_0x3a4121>0x0){const {packageId:_0x5a5c45}=_0x7971b7;if(!_0x5a5c45)throw new common_1[(_0x35f38a(0xdd))](_0x35f38a(0xef),common_1[_0x35f38a(0x79)][_0x35f38a(0x110)]);const _0x33b119=await this['cramiPackageEntity'][_0x35f38a(0x125)]({'where':{'id':_0x5a5c45}});if(!_0x33b119)throw new common_1[(_0x35f38a(0xdd))]('当前套餐不存在！',common_1[_0x35f38a(0x79)]['BAD_REQUEST']);const {weight:_0xc9a5e5}=_0x33b119;if(!_0x52ef9f['packageId'])_0x1c42c2={'memberModel3Count':_0x25c821+_0x7971b7[_0x35f38a(0xd8)],'memberModel4Count':_0x2c805f+_0x7971b7[_0x35f38a(0x7c)],'memberDrawMjCount':_0x16dc49+_0x7971b7[_0x35f38a(0x10a)],'expirationTime':(0x0,date_1[_0x35f38a(0x12b)])()[_0x35f38a(0x78)](_0x3a4121>0x0?_0x3a4121:0x0,_0x35f38a(0x106))[_0x35f38a(0xfb)](_0x35f38a(0x8b)),'packageId':_0x5a5c45};else{const _0xf4c710=await this['cramiPackageEntity'][_0x35f38a(0x125)]({'where':{'id':_0x52ef9f[_0x35f38a(0x11b)]}});_0xc9a5e5>=_0xf4c710[_0x35f38a(0x82)]&&(_0x1c42c2={'memberModel3Count':_0x1e4b1c+_0x7971b7[_0x35f38a(0xd8)],'memberModel4Count':_0xf4026b+_0x7971b7[_0x35f38a(0x7c)],'memberDrawMjCount':_0x32d4ea+_0x7971b7['drawMjCount'],'expirationTime':(0x0,date_1[_0x35f38a(0x12b)])(_0x52ef9f[_0x35f38a(0xac)])[_0x35f38a(0x78)](_0x3a4121>0x0?_0x3a4121:0x0,_0x35f38a(0x106))[_0x35f38a(0xfb)](_0x35f38a(0x8b)),'packageId':_0x5a5c45}),_0xc9a5e5<_0xf4c710[_0x35f38a(0x82)]&&(_0x1c42c2={'memberModel3Count':_0x1e4b1c+_0x7971b7['model3Count'],'memberModel4Count':_0xf4026b+_0x7971b7[_0x35f38a(0x7c)],'memberDrawMjCount':_0x32d4ea+_0x7971b7[_0x35f38a(0x10a)]});}}_0x3a4121<=0x0&&(_0x1c42c2={'model3Count':_0x25c821+_0x7971b7[_0x35f38a(0xd8)],'model4Count':_0x2c805f+_0x7971b7[_0x35f38a(0x7c)],'drawMjCount':_0x16dc49+_0x7971b7[_0x35f38a(0x10a)]});const _0x352d5e=await this['userBalanceEntity'][_0x35f38a(0xe9)]({'userId':_0x457022},_0x1c42c2);if(_0x352d5e[_0x35f38a(0xe6)]===0x0)throw new common_1['HttpException'](_0x457022+_0x35f38a(0x104),common_1[_0x35f38a(0x79)][_0x35f38a(0x110)]);}catch(_0x3dce10){console[_0x35f38a(0x113)]('error:\x20',_0x3dce10);throw new common_1['HttpException'](_0x35f38a(0xf9),common_1[_0x35f38a(0x79)][_0x35f38a(0x110)]);}}async['addBalanceToOrder'](_0x2c2fb4){const _0x4340b5=_0x8c6ab4;console['log'](_0x4340b5(0x88),_0x2c2fb4);try{const {userId:_0x48d1bb,goodsId:_0x596c3c}=_0x2c2fb4,_0x28effb=await this[_0x4340b5(0xed)][_0x4340b5(0x125)]({'where':{'id':_0x2c2fb4[_0x4340b5(0xb2)],'status':0x1}});if(!_0x28effb)throw new common_1[(_0x4340b5(0xdd))](_0x4340b5(0xc7),common_1[_0x4340b5(0x79)][_0x4340b5(0x110)]);const {model3Count:_0x2fa19b,model4Count:_0x4c7f91,drawMjCount:_0x1fe99c,days:_0x10e0ec,name:_0x2fc99d}=_0x28effb,_0x20ac02={'model3Count':_0x2fa19b,'model4Count':_0x4c7f91,'drawMjCount':_0x1fe99c,'days':_0x10e0ec,'packageId':_0x2c2fb4[_0x4340b5(0xb2)]};await this[_0x4340b5(0xc2)](_0x48d1bb,_0x20ac02,_0x10e0ec),await this[_0x4340b5(0xc9)]({'userId':_0x48d1bb,'rechargeType':balance_constant_1[_0x4340b5(0xd1)][_0x4340b5(0x11d)],'model3Count':_0x2fa19b,'model4Count':_0x4c7f91,'drawMjCount':_0x1fe99c,'pkgName':_0x2fc99d,'days':_0x10e0ec});const _0x4ab1a7=await this['userEntity'][_0x4340b5(0x125)]({'where':{'id':_0x48d1bb}}),{invitedBy:_0x232d32}=_0x4ab1a7;if(_0x232d32){const _0x42c419=await this[_0x4340b5(0xe7)]['findOne']({'where':{'inviteCode':_0x232d32}}),_0x5e9dec=await this['salesUsersEntity'][_0x4340b5(0x125)]({'where':{'userId':_0x42c419['id']}});if(!_0x42c419)return;const {id:_0x1dfc10}=_0x42c419,{performanceRatio:_0x467f81}=_0x5e9dec,_0x1ad2e1={'inviterUserId':_0x1dfc10,'inviteeUserId':_0x48d1bb,'orderId':_0x2c2fb4['id'],'orderPrice':_0x2c2fb4[_0x4340b5(0x121)],'commissionPercentage':_0x467f81,'commissionAmount':(_0x2c2fb4['total']*_0x467f81/0x64)[_0x4340b5(0xdb)](0x2)};await this[_0x4340b5(0x10b)][_0x4340b5(0x86)](_0x1ad2e1),await this[_0x4340b5(0x10b)][_0x4340b5(0xf4)](_0x1dfc10,_0x1ad2e1[_0x4340b5(0x107)]);}}catch(_0x5d3cee){console['log'](_0x4340b5(0x108),_0x5d3cee);throw new common_1[(_0x4340b5(0xdd))](_0x4340b5(0xe4),common_1[_0x4340b5(0x79)][_0x4340b5(0x110)]);}}async[_0x8c6ab4(0xa7)](_0x1787b2,_0x3af2eb){const _0xcfe10b=_0x8c6ab4,{page:page=0x1,size:size=0x14}=_0x3af2eb,{id:_0x21a482}=_0x1787b2[_0xcfe10b(0xbb)],[_0xb4f6b8,_0x149f1b]=await this['accountLogEntity'][_0xcfe10b(0xda)]({'where':{'userId':_0x21a482},'order':{'id':_0xcfe10b(0xf8)},'skip':(page-0x1)*size,'take':size});return _0xb4f6b8['forEach'](_0x51aa3d=>{const _0x31983f=_0xcfe10b;_0x51aa3d[_0x31983f(0x73)]=_0x51aa3d['days']>0x0?_0x51aa3d[_0x31983f(0xc1)]+'天':'永久';}),{'rows':(0x0,date_1[_0xcfe10b(0x102)])(_0xb4f6b8),'count':_0x149f1b};}async['getAccountLog'](_0x4fd2ab,_0x12fa46){const _0x5ca83f=_0x8c6ab4;try{const {page:page=0x1,size:size=0xa,userId:_0x1c9c6f,rechargeType:_0x1924d0,packageId:_0x43c558}=_0x12fa46,{role:_0x55abdd}=_0x4fd2ab[_0x5ca83f(0xbb)],_0xc3d197={};_0x1924d0&&(_0xc3d197[_0x5ca83f(0xd7)]=_0x1924d0),_0xc3d197[_0x5ca83f(0xd5)]=_0x1c9c6f||(0x0,typeorm_2[_0x5ca83f(0xab)])(0x186a0),_0x43c558&&(_0xc3d197[_0x5ca83f(0x11b)]={'$like':'%'+_0x43c558+'%'});const [_0x322104,_0x229414]=await this[_0x5ca83f(0xa5)]['findAndCount']({'where':_0xc3d197,'order':{'id':_0x5ca83f(0xf8)},'skip':(page-0x1)*size,'take':size}),_0x2a3096=_0x322104[_0x5ca83f(0x128)](_0x244075=>_0x244075[_0x5ca83f(0xd5)]),_0x4d12ce=await this['userEntity'][_0x5ca83f(0x8d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2a3096)}});return _0x322104['forEach'](_0x11dc5d=>{const _0x4744d3=_0x5ca83f,_0x48f4c8=_0x4d12ce[_0x4744d3(0x8d)](_0x33fa09=>_0x33fa09['id']===_0x11dc5d[_0x4744d3(0xd5)]);_0x11dc5d[_0x4744d3(0xc6)]=_0x48f4c8===null||_0x48f4c8===void 0x0?void 0x0:_0x48f4c8[_0x4744d3(0xc6)],_0x11dc5d[_0x4744d3(0x95)]=_0x48f4c8===null||_0x48f4c8===void 0x0?void 0x0:_0x48f4c8[_0x4744d3(0x95)],_0x11dc5d[_0x4744d3(0x10e)]=_0x48f4c8===null||_0x48f4c8===void 0x0?void 0x0:_0x48f4c8[_0x4744d3(0x10e)],_0x11dc5d[_0x4744d3(0x119)]=_0x48f4c8===null||_0x48f4c8===void 0x0?void 0x0:_0x48f4c8[_0x4744d3(0x119)],_0x11dc5d[_0x4744d3(0x129)]=_0x48f4c8===null||_0x48f4c8===void 0x0?void 0x0:_0x48f4c8[_0x4744d3(0x129)];}),_0x55abdd!==_0x5ca83f(0x6f)&&_0x322104['forEach'](_0x548310=>{const _0x408ab8=_0x5ca83f;_0x548310[_0x408ab8(0x95)]=_0x548310['email']?(0x0,utils_1['hideString'])(_0x548310[_0x408ab8(0x95)]):'',_0x548310[_0x408ab8(0x10e)]=_0x548310[_0x408ab8(0x10e)]?(0x0,utils_1[_0x408ab8(0x7f)])(_0x548310['phone']):'';}),{'rows':_0x322104,'count':_0x229414};}catch(_0x346103){console['log'](_0x5ca83f(0x108),_0x346103);throw new common_1['HttpException']('查询用户账户失败！',common_1[_0x5ca83f(0x79)][_0x5ca83f(0x110)]);}}async[_0x8c6ab4(0xa6)](_0x57df34){const _0x324948=_0x8c6ab4;return await this[_0x324948(0xea)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x57df34)}});}async[_0x8c6ab4(0x99)](_0x20ad13,_0x36640c){const _0x3bfb8b=_0x8c6ab4;return await this[_0x3bfb8b(0x10c)](_0x20ad13,_0x3bfb8b(0x68),-_0x36640c);}async['upgradeBalance'](){const _0x22fcbb=_0x8c6ab4,_0x451af2=await this['userEntity']['find']();if(!_0x451af2[_0x22fcbb(0xce)])return;const _0x154c28=await this['globalConfigService'][_0x22fcbb(0xd2)](['upgradeStatus']);if(!_0x154c28)await this[_0x22fcbb(0x94)][_0x22fcbb(0xb4)]({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x22fcbb(0xdd))]('您已经升级过了、请勿重复操作！',common_1['HttpStatus'][_0x22fcbb(0x110)]);_0x451af2[_0x22fcbb(0x6b)](_0x3b34a7=>{const _0x2169be=_0x22fcbb,{id:_0x2635c1}=_0x3b34a7;this[_0x2169be(0x9f)][_0x2169be(0x125)]({'where':{'userId':_0x2635c1}})[_0x2169be(0xec)](_0xab5333=>{const _0x3e9691=_0x2169be;if(!_0xab5333)return;this[_0x3e9691(0xf5)](_0x2635c1,_0xab5333);});});}async['writeOldBalanceToNewTable'](_0x152be4,_0x72a8f3){const _0x3bf9b1=_0x8c6ab4,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x72a8f3,_0x4971bf=await this[_0x3bf9b1(0xaa)][_0x3bf9b1(0x125)]({'where':{'userId':_0x152be4}}),_0x2c98cd={'userId':_0x152be4,'model3Count':Number(usesLeft),'model4Count':(_0x4971bf===null||_0x4971bf===void 0x0?void 0x0:_0x4971bf[_0x3bf9b1(0x93)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x4971bf===null||_0x4971bf===void 0x0?void 0x0:_0x4971bf[_0x3bf9b1(0xcc)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x4bd22b=await this[_0x3bf9b1(0xea)][_0x3bf9b1(0x125)]({'where':{'userId':_0x152be4}});_0x4bd22b?common_1[_0x3bf9b1(0xe8)][_0x3bf9b1(0x81)]('用户'+_0x152be4+_0x3bf9b1(0xb9),_0x3bf9b1(0xb6)):this[_0x3bf9b1(0xea)]['save'](_0x2c98cd)['then'](_0x67ac43=>{const _0x1a5a74=_0x3bf9b1;common_1[_0x1a5a74(0xe8)][_0x1a5a74(0x81)]('用户'+_0x152be4+'旧账户信息迁移成功',_0x1a5a74(0xb6));})[_0x3bf9b1(0x112)](_0x1a26aa=>{const _0x2e7fb1=_0x3bf9b1;console[_0x2e7fb1(0x113)](_0x2e7fb1(0x108),_0x1a26aa),common_1[_0x2e7fb1(0xe8)][_0x2e7fb1(0x81)]('用户'+_0x152be4+_0x2e7fb1(0x72),_0x2e7fb1(0xb6));});}async[_0x8c6ab4(0xa4)](_0x427d4f){const _0x174a6d=_0x8c6ab4,{fingerprint:_0x39606c}=_0x427d4f[_0x174a6d(0x6e)],{id:_0x18700b}=_0x427d4f[_0x174a6d(0xbb)];return await this[_0x174a6d(0x75)][_0x174a6d(0xe9)]({'userId':Number(_0x39606c)},{'userId':_0x18700b}),await this[_0x174a6d(0x9b)]['update']({'userId':Number(_0x39606c)},{'userId':_0x18700b}),await this['midjourneyEntity'][_0x174a6d(0xe9)]({'userId':Number(_0x39606c)},{'userId':_0x18700b}),0x1;}async[_0x8c6ab4(0xaf)](_0x21ed6d){const _0x5c1fef=_0x8c6ab4,{fingerprint:_0x4dcf5b}=_0x21ed6d[_0x5c1fef(0x6e)],_0x3384d3=await this[_0x5c1fef(0x75)][_0x5c1fef(0x93)]({'where':{'userId':_0x4dcf5b}}),_0x128ab1=await this[_0x5c1fef(0x9b)][_0x5c1fef(0x93)]({'where':{'userId':_0x4dcf5b}}),_0x583490=await this[_0x5c1fef(0x117)][_0x5c1fef(0x93)]({'where':{'userId':_0x4dcf5b}});return _0x3384d3||_0x128ab1||_0x583490||0x0;}};function _0x2a5f(){const _0x179388=['save','count','globalConfigService','email','88RVbfxf','function','../chatGroup/chatGroup.entity','refundMjBalance','firstRregisterSendModel4Count','chatGroupEntity','__param','./userBalance.entity','117132qvGfJm','balanceEntity','MjCount','30797plhtfF','BalanceEntity','WhiteListEntity','inheritVisitorData','accountLogEntity','queryUserBalanceByIds','getRechargeLog','sumDrawMjCount','useDrawMjToken','whiteListEntity','LessThan','expirationTime','4NTxkRU','model3','getVisitorCount','InjectRepository','model4','goodsId','validateBalance','setConfig','../sales/sales.service','BalanceService','../crami/cramiPackage.entity','UserEntity','账户信息已经存在、迁移无效','10IuByxD','user','消费余额失败！','UserBalanceEntity','invitedGuestSendDrawMjCount','inviteGiveSendDrawMjCount','906120iciWUd','days','addBalanceToUser','注册赠送失败,请联系管理员！','getFullYear','getMonth','username','非法操作、当前充值套餐暂不存在！','includes','saveRecordRechargeLog','invitedGuestSendModel3Count','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','useCount','inviteGiveSendModel4Count','length','当前用户无需创建账户信息！','inviteGiveSendModel3Count','RechargeType','getConfigs','AccountLogEntity','./accountLog.entity','userId','./fingerprint.entity','rechargeType','model3Count','@nestjs/typeorm','findAndCount','toFixed','formatDate','HttpException','../../common/utils','660Eajnba','validateVisitorBalance','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','PAYMENT_REQUIRED','invitedGuestSendModel4Count','充值失败！','useModel4Count','affected','userEntity','Logger','update','userBalanceEntity','__metadata','then','cramiPackageEntity','fingerprintLogEntity','缺失当前套餐ID、充值失败！','registerSendStatus','152624DPgzsg','firstRregisterSendDrawMjCount','ChatGroupEntity','saveCommissionAmount','writeOldBalanceToNewTable','Injectable','SalesService','DESC','用户充值失败！','configVal','format','useModel3Token','design:paramtypes','../../common/constants/balance.constant','__esModule','Repository','5ZNFIXz','formatCreateOrUpdateDate','memberModel3Count','充值失败','---','day','commissionAmount','error:\x20','defineProperty','drawMjCount','salesService','deductFromBalance','418451xtAxjU','phone','REG_GIFT','BAD_REQUEST','decorate','catch','log','useModel3Count','memberModel4Count','CramiPackageEntity','midjourneyEntity','isInteger','status','../user/user.entity','packageId','useModel4Token','SCAN_PAY','../sales/salesUsers.entity','缺失当前用户账户记录！','isUpdatedToday','total','351HFrwGt','registerSendModel4Count','registerSendDrawMjCount','findOne','odel3','visitorModel3Num','map','avatar','247743MpEBKL','default','../globalConfig/globalConfig.service','mjDraw','GlobalConfigService','>\x20或购买专属套餐\x20！','forEach','queryUserBalance','__decorate','headers','super','reduce','sumModel4Count','旧账户信息迁移失败','expireDateCn','sumModel3Count','chatLogEntity','object','createRandomUid','add','HttpStatus','registerSendModel3Count','metadata','model4Count','查询用户账户信息失败！','firstRregisterSendModel3Count','hideString','ChatLogEntity','debug','weight','862001WjMUke','createBaseUserBalance','firstRegisterSendStatus','createSalesRecords','vxNumber','充值的工单信息:','当前用户不存在,记录充值日志异常','查询当前用户余额失败！','YYYY-MM-DD\x20HH:mm:ss','MidjourneyEntity','find','memberDrawMjCount','configKey','configEntity','ConfigEntity'];_0x2a5f=function(){return _0x179388;};return _0x2a5f();}function _0x33ea(_0x33a60a,_0x3447c0){const _0x2a5fa4=_0x2a5f();return _0x33ea=function(_0x33eaba,_0x1603e9){_0x33eaba=_0x33eaba-0x67;let _0x250f82=_0x2a5fa4[_0x33eaba];return _0x250f82;},_0x33ea(_0x33a60a,_0x3447c0);}UserBalanceService=__decorate([(0x0,common_1[_0x8c6ab4(0xf6)])(),__param(0x0,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(balance_entity_1[_0x8c6ab4(0xa2)])),__param(0x1,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(userBalance_entity_1[_0x8c6ab4(0xbd)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x8c6ab4(0xd3)])),__param(0x3,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(cramiPackage_entity_1[_0x8c6ab4(0x116)])),__param(0x4,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(config_entity_1[_0x8c6ab4(0x91)])),__param(0x5,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(user_entity_1[_0x8c6ab4(0xb8)])),__param(0x6,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(whiteList_entity_1[_0x8c6ab4(0xa3)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x8c6ab4(0xf3)])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x8c6ab4(0x80)])),__param(0xb,(0x0,typeorm_1[_0x8c6ab4(0xb0)])(midjourney_entity_1[_0x8c6ab4(0x8c)])),__metadata(_0x8c6ab4(0xfd),[typeorm_2['Repository'],typeorm_2[_0x8c6ab4(0x100)],typeorm_2[_0x8c6ab4(0x100)],typeorm_2[_0x8c6ab4(0x100)],typeorm_2[_0x8c6ab4(0x100)],typeorm_2[_0x8c6ab4(0x100)],typeorm_2[_0x8c6ab4(0x100)],typeorm_2[_0x8c6ab4(0x100)],typeorm_2[_0x8c6ab4(0x100)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],sales_service_1[_0x8c6ab4(0xf7)],globalConfig_service_1[_0x8c6ab4(0x69)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;