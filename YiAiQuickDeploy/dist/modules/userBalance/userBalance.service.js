'use strict';const _0x4b5a0f=_0x1ca8;(function(_0x53a435,_0x42fa18){const _0x3f21b8=_0x1ca8,_0x5067f5=_0x53a435();while(!![]){try{const _0x3c2f3d=parseInt(_0x3f21b8(0x193))/0x1*(parseInt(_0x3f21b8(0x23f))/0x2)+parseInt(_0x3f21b8(0x1af))/0x3+parseInt(_0x3f21b8(0x184))/0x4+-parseInt(_0x3f21b8(0x1b1))/0x5*(-parseInt(_0x3f21b8(0x215))/0x6)+parseInt(_0x3f21b8(0x1fa))/0x7+-parseInt(_0x3f21b8(0x216))/0x8+-parseInt(_0x3f21b8(0x1d6))/0x9;if(_0x3c2f3d===_0x42fa18)break;else _0x5067f5['push'](_0x5067f5['shift']());}catch(_0xf8079e){_0x5067f5['push'](_0x5067f5['shift']());}}}(_0x2c53,0xc2d32));var __decorate=this&&this['__decorate']||function(_0x16d2ca,_0xf04927,_0x3a29bd,_0x2381d3){const _0x2dc5bd=_0x1ca8;var _0x21f9c2=arguments[_0x2dc5bd(0x231)],_0x5ad8da=_0x21f9c2<0x3?_0xf04927:_0x2381d3===null?_0x2381d3=Object[_0x2dc5bd(0x1fb)](_0xf04927,_0x3a29bd):_0x2381d3,_0x3047b0;if(typeof Reflect===_0x2dc5bd(0x18c)&&typeof Reflect['decorate']===_0x2dc5bd(0x1fe))_0x5ad8da=Reflect['decorate'](_0x16d2ca,_0xf04927,_0x3a29bd,_0x2381d3);else{for(var _0x5e54a9=_0x16d2ca['length']-0x1;_0x5e54a9>=0x0;_0x5e54a9--)if(_0x3047b0=_0x16d2ca[_0x5e54a9])_0x5ad8da=(_0x21f9c2<0x3?_0x3047b0(_0x5ad8da):_0x21f9c2>0x3?_0x3047b0(_0xf04927,_0x3a29bd,_0x5ad8da):_0x3047b0(_0xf04927,_0x3a29bd))||_0x5ad8da;}return _0x21f9c2>0x3&&_0x5ad8da&&Object[_0x2dc5bd(0x180)](_0xf04927,_0x3a29bd,_0x5ad8da),_0x5ad8da;},__metadata=this&&this[_0x4b5a0f(0x22a)]||function(_0x506366,_0x4c69e5){const _0x34d973=_0x4b5a0f;if(typeof Reflect===_0x34d973(0x18c)&&typeof Reflect['metadata']===_0x34d973(0x1fe))return Reflect[_0x34d973(0x1c5)](_0x506366,_0x4c69e5);},__param=this&&this[_0x4b5a0f(0x1eb)]||function(_0x5719a7,_0x39a9f1){return function(_0x5027c0,_0x5458f4){_0x39a9f1(_0x5027c0,_0x5458f4,_0x5719a7);};};Object[_0x4b5a0f(0x180)](exports,_0x4b5a0f(0x23b),{'value':!![]}),exports[_0x4b5a0f(0x202)]=void 0x0;function _0x1ca8(_0x394d7d,_0x4dbb2c){const _0x2c531c=_0x2c53();return _0x1ca8=function(_0x1ca8f,_0x2e4eb6){_0x1ca8f=_0x1ca8f-0x176;let _0x8e40ae=_0x2c531c[_0x1ca8f];return _0x8e40ae;},_0x1ca8(_0x394d7d,_0x4dbb2c);}const globalConfig_service_1=require(_0x4b5a0f(0x1b4)),typeorm_1=require(_0x4b5a0f(0x1cd)),balance_entity_1=require(_0x4b5a0f(0x1a8)),common_1=require(_0x4b5a0f(0x1c9)),typeorm_2=require(_0x4b5a0f(0x17a)),balance_constant_1=require(_0x4b5a0f(0x198)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0x4b5a0f(0x1a7)),config_entity_1=require(_0x4b5a0f(0x1bf)),cramiPackage_entity_1=require(_0x4b5a0f(0x1c8)),userBalance_entity_1=require(_0x4b5a0f(0x21b)),date_1=require(_0x4b5a0f(0x1e0)),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x4b5a0f(0x1dd)),sales_service_1=require(_0x4b5a0f(0x187)),whiteList_entity_1=require(_0x4b5a0f(0x1ce)),fingerprint_entity_1=require('./fingerprint.entity'),chatLog_entity_1=require(_0x4b5a0f(0x1f1)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),midjourney_entity_1=require('../midjourney/midjourney.entity');let UserBalanceService=class UserBalanceService{constructor(_0x2e2d32,_0x4a7f12,_0x558b8c,_0x213479,_0x899bc8,_0x34a0b1,_0x126ea9,_0x12dbfc,_0x5a8a62,_0x125eef,_0x42acbb,_0x49c135,_0x537657,_0x185110){const _0x1bfde9=_0x4b5a0f;this[_0x1bfde9(0x19a)]=_0x2e2d32,this[_0x1bfde9(0x1a9)]=_0x4a7f12,this['accountLogEntity']=_0x558b8c,this['cramiPackageEntity']=_0x213479,this[_0x1bfde9(0x201)]=_0x899bc8,this[_0x1bfde9(0x18e)]=_0x34a0b1,this[_0x1bfde9(0x17b)]=_0x126ea9,this['whiteListEntity']=_0x12dbfc,this[_0x1bfde9(0x1bc)]=_0x5a8a62,this[_0x1bfde9(0x1f0)]=_0x125eef,this[_0x1bfde9(0x199)]=_0x42acbb,this[_0x1bfde9(0x1f4)]=_0x49c135,this['salesService']=_0x537657,this[_0x1bfde9(0x1e5)]=_0x185110;}async[_0x4b5a0f(0x220)](_0x32ae63,_0x14236d){const _0x54c339=_0x4b5a0f;try{const _0x55ab4d=await this[_0x54c339(0x201)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x54c339(0x22d),_0x54c339(0x1cc),_0x54c339(0x207),_0x54c339(0x211),_0x54c339(0x22e),'firstRegisterSendRank',_0x54c339(0x1e8),'firstRregisterSendModel4Count',_0x54c339(0x1ae),_0x54c339(0x22c),_0x54c339(0x1a6),_0x54c339(0x1f2),_0x54c339(0x1ea),'invitedGuestSendModel3Count',_0x54c339(0x17c),'invitedGuestSendModel4Count'])}}),_0x460e3a=_0x55ab4d[_0x54c339(0x176)]((_0x789e6d,_0xc802be)=>{const _0x41f841=_0x54c339,_0x3ba5b5=Number(_0xc802be['configVal']),_0x1401e6=Number[_0x41f841(0x185)](_0x3ba5b5)&&_0x3ba5b5>0x0?_0x3ba5b5:0x0;return _0x789e6d[_0xc802be[_0x41f841(0x1b7)]]=_0x1401e6,_0x789e6d;},{});let _0x422873=0x0,_0x52118f=0x0,_0x5772b0=0x0;_0x460e3a[_0x54c339(0x22d)]===0x1&&(_0x422873=_0x422873+_0x460e3a[_0x54c339(0x1cc)],_0x52118f=_0x52118f+_0x460e3a[_0x54c339(0x207)],_0x5772b0=_0x5772b0+_0x460e3a[_0x54c339(0x211)]),_0x460e3a[_0x54c339(0x22d)]===0x1&&_0x460e3a[_0x54c339(0x22e)]===0x1&&_0x32ae63<=_0x460e3a[_0x54c339(0x233)]&&(_0x422873=_0x422873+_0x460e3a[_0x54c339(0x1e8)],_0x52118f=_0x52118f+_0x460e3a[_0x54c339(0x188)],_0x5772b0=_0x5772b0+_0x460e3a['firstRregisterSendDrawMjCount']),await this[_0x54c339(0x1e6)]({'userId':_0x32ae63,'rechargeType':balance_constant_1[_0x54c339(0x213)][_0x54c339(0x19e)],'model3Count':_0x422873,'drawMjCount':_0x5772b0,'model4Count':_0x52118f}),_0x14236d&&(Number(_0x460e3a[_0x54c339(0x22c)])===0x1&&(_0x422873=_0x422873+Number(_0x460e3a[_0x54c339(0x1a5)]),_0x52118f=_0x52118f+Number(_0x460e3a[_0x54c339(0x1d3)]),_0x5772b0=_0x5772b0+Number(_0x460e3a[_0x54c339(0x17c)]),await this[_0x54c339(0x1e6)]({'userId':_0x32ae63,'rechargeType':balance_constant_1['RechargeType'][_0x54c339(0x210)],'model3Count':_0x460e3a[_0x54c339(0x1a5)],'model4Count':_0x460e3a[_0x54c339(0x1d3)],'drawMjCount':_0x460e3a[_0x54c339(0x17c)]}),await this[_0x54c339(0x206)](_0x14236d,{'model3Count':_0x460e3a[_0x54c339(0x1a6)],'model4Count':_0x460e3a[_0x54c339(0x1f2)],'drawMjCount':_0x460e3a[_0x54c339(0x1ea)]}),await this[_0x54c339(0x1e6)]({'userId':_0x14236d,'rechargeType':balance_constant_1['RechargeType']['REFER_GIFT'],'model3Count':_0x460e3a[_0x54c339(0x1a6)],'model4Count':_0x460e3a[_0x54c339(0x1f2)],'drawMjCount':_0x460e3a[_0x54c339(0x1ea)]}))),await this[_0x54c339(0x1a9)][_0x54c339(0x214)]({'userId':_0x32ae63,'model3Count':_0x422873,'model4Count':_0x52118f,'drawMjCount':_0x5772b0,'useTokens':0x0});}catch(_0x41f6c0){console['log'](_0x54c339(0x1b0),_0x41f6c0);throw new common_1[(_0x54c339(0x238))](_0x54c339(0x221),common_1[_0x54c339(0x1e2)][_0x54c339(0x227)]);}}async['validateBalance'](_0x3cb2f2,_0xf17a2f,_0x58f4d5){const _0x3b9d0d=_0x4b5a0f,{id:_0x26c258,role:_0xf0fc7}=_0x3cb2f2[_0x3b9d0d(0x1f6)];let _0x1d38a2=await this[_0x3b9d0d(0x1a9)][_0x3b9d0d(0x197)]({'where':{'userId':_0x26c258}});!_0x1d38a2&&(_0x1d38a2=await this[_0x3b9d0d(0x1bb)](_0x26c258));if(_0xf0fc7===_0x3b9d0d(0x234))return this[_0x3b9d0d(0x237)](_0x3cb2f2,_0xf17a2f,_0x58f4d5);const _0x4c776e=await this[_0x3b9d0d(0x201)][_0x3b9d0d(0x197)]({'where':{'configKey':'vxNumber'}}),_0x8291e1=_0x4c776e?_0x4c776e[_0x3b9d0d(0x1ab)]:_0x3b9d0d(0x218),_0x3db602=_0xf17a2f==='model3'?_0x3b9d0d(0x1e3):_0xf17a2f===_0x3b9d0d(0x20d)?_0x3b9d0d(0x1ba):_0xf17a2f===_0x3b9d0d(0x1df)?_0x3b9d0d(0x1d4):null,_0xc552fb=_0xf17a2f===_0x3b9d0d(0x1ef)?_0x3b9d0d(0x1db):_0xf17a2f==='model4'?_0x3b9d0d(0x191):_0xf17a2f===_0x3b9d0d(0x1df)?'drawMjCount':null;if(_0x1d38a2[_0x3b9d0d(0x228)]&&_0x1d38a2[_0x3db602]<_0x58f4d5){if(_0x1d38a2[_0xc552fb]<_0x58f4d5)throw new common_1[(_0x3b9d0d(0x238))](_0x3b9d0d(0x1d5)+_0x8291e1+_0x3b9d0d(0x1f7),common_1['HttpStatus'][_0x3b9d0d(0x1c3)]);}if(!_0x1d38a2['packageId']&&_0x1d38a2[_0xc552fb]<_0x58f4d5)throw new common_1[(_0x3b9d0d(0x238))](_0x3b9d0d(0x1d5)+_0x8291e1+_0x3b9d0d(0x1f7),common_1[_0x3b9d0d(0x1e2)][_0x3b9d0d(0x1c3)]);return _0x1d38a2;}async[_0x4b5a0f(0x237)](_0x66aea8,_0xf41497,_0x57278c){const _0x3575f2=_0x4b5a0f,{id:_0x292a92}=_0x66aea8[_0x3575f2(0x1f6)],_0x5dfd70=_0xf41497==='model3'?_0x3575f2(0x1db):_0xf41497===_0x3575f2(0x20d)?_0x3575f2(0x191):_0xf41497===_0x3575f2(0x1df)?'drawMjCount':null,_0x177173=new Date(),_0x23d636=await this[_0x3575f2(0x1bc)][_0x3575f2(0x197)]({'where':{'fingerprint':_0x292a92}}),{visitorModel3Num:_0x285372,visitorModel4Num:_0x1b8817,visitorMJNum:_0x305fda}=await this[_0x3575f2(0x1e5)][_0x3575f2(0x200)]([_0x3575f2(0x1f3),_0x3575f2(0x1ca),_0x3575f2(0x1a3)]),_0x23a29b={'model3Count':_0x285372?Number(_0x285372):0x0,'model4Count':_0x1b8817?Number(_0x1b8817):0x0,'drawMjCount':_0x305fda?Number(_0x305fda):0x0};if(!_0x23d636){const _0x622f59={'fingerprint':_0x292a92,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x622f59[_0x5dfd70]=_0x622f59[_0x5dfd70]+_0x57278c;if(_0x622f59[_0x5dfd70]>_0x23a29b[_0x5dfd70])throw new common_1[(_0x3575f2(0x238))](_0x3575f2(0x18d),common_1[_0x3575f2(0x1e2)][_0x3575f2(0x1c3)]);else return await this[_0x3575f2(0x1bc)]['save'](_0x622f59),!![];}else{const {model3Count:_0x197b6a,model4Count:_0x47c8c5,drawMjCount:_0x51fca7}=_0x23d636;let _0x2d095d={'model3Count':_0x197b6a,'model4Count':_0x47c8c5,'drawMjCount':_0x51fca7};const _0x3b5fb=Number(new Date(_0x23d636[_0x3575f2(0x17f)])),_0x4a396a=this[_0x3575f2(0x230)](_0x3b5fb);_0x4a396a?_0x2d095d[_0x5dfd70]=_0x2d095d[_0x5dfd70]+_0x57278c:(_0x2d095d={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x2d095d[_0x5dfd70]=_0x2d095d[_0x5dfd70]+_0x57278c);if(_0x2d095d[_0x5dfd70]>_0x23a29b[_0x5dfd70])throw new common_1['HttpException']('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1[_0x3575f2(0x1e2)][_0x3575f2(0x1c3)]);else return await this[_0x3575f2(0x1bc)][_0x3575f2(0x190)]({'fingerprint':_0x292a92},_0x2d095d),!![];}}['isUpdatedToday'](_0x4d4fd2){const _0x1256dc=_0x4b5a0f,_0x1ba64d=new Date(),_0x4a0d98=new Date(_0x1ba64d['getFullYear'](),_0x1ba64d[_0x1256dc(0x222)](),_0x1ba64d['getDate']());return _0x4d4fd2>=_0x4a0d98;}async[_0x4b5a0f(0x18a)](_0x14230f,_0x32d616,_0x55bfc1,_0x11d732=0x0){const _0x49bfdb=_0x4b5a0f,_0x43bda5=await this[_0x49bfdb(0x1a9)][_0x49bfdb(0x197)]({'where':{'userId':_0x14230f}});if(!_0x43bda5)throw new common_1[(_0x49bfdb(0x238))](_0x49bfdb(0x21f),common_1[_0x49bfdb(0x1e2)][_0x49bfdb(0x227)]);const _0x39ea51=_0x32d616==='model3'?_0x49bfdb(0x1e3):_0x32d616===_0x49bfdb(0x20d)?_0x49bfdb(0x1ba):_0x32d616===_0x49bfdb(0x1df)?_0x49bfdb(0x1d4):null,_0x59d033=_0x32d616===_0x49bfdb(0x1ef)?_0x49bfdb(0x1db):_0x32d616===_0x49bfdb(0x20d)?_0x49bfdb(0x191):_0x32d616===_0x49bfdb(0x1df)?_0x49bfdb(0x1c1):null,_0x24c98f=_0x43bda5[_0x49bfdb(0x228)]&&_0x43bda5[_0x39ea51]<_0x55bfc1?_0x59d033:_0x43bda5[_0x49bfdb(0x228)]?_0x39ea51:_0x59d033;let _0x57e3c4=null;_0x24c98f['includes'](_0x49bfdb(0x1ad))&&(_0x57e3c4='useModel3Token');_0x24c98f[_0x49bfdb(0x20e)]('odel4')&&(_0x57e3c4=_0x49bfdb(0x1bd));_0x24c98f[_0x49bfdb(0x20e)](_0x49bfdb(0x1fd))&&(_0x57e3c4=_0x49bfdb(0x1da));const _0x3ff3e8={[_0x24c98f]:_0x43bda5[_0x24c98f]-_0x55bfc1<0x0?0x0:_0x43bda5[_0x24c98f]-_0x55bfc1,[_0x57e3c4]:_0x43bda5[_0x57e3c4]+_0x11d732};_0x57e3c4==='useModel3Token'&&(_0x3ff3e8['useModel3Count']=_0x43bda5['useModel3Count']+_0x55bfc1),_0x57e3c4===_0x49bfdb(0x1bd)&&(_0x3ff3e8[_0x49bfdb(0x186)]=_0x43bda5['useModel4Count']+_0x55bfc1);const _0x275b99=await this[_0x49bfdb(0x1a9)]['update']({'userId':_0x14230f},_0x3ff3e8);if(_0x275b99['affected']===0x0)throw new common_1['HttpException'](_0x49bfdb(0x225),common_1['HttpStatus']['BAD_REQUEST']);}async['queryUserBalance'](_0x4982a8){const _0xd546ff=_0x4b5a0f;try{const _0x1d55d7=await this[_0xd546ff(0x1a9)][_0xd546ff(0x197)]({'where':{'userId':_0x4982a8},'select':[_0xd546ff(0x228),_0xd546ff(0x1db),_0xd546ff(0x191),_0xd546ff(0x1c1),_0xd546ff(0x1e3),_0xd546ff(0x1ba),_0xd546ff(0x1d4),'useModel3Count','useModel4Count',_0xd546ff(0x21a),'useModel4Token',_0xd546ff(0x1da),'expirationTime']});if(!_0x1d55d7){const _0x1717fd=await this[_0xd546ff(0x1bb)](_0x4982a8);if(_0x1717fd)return await this[_0xd546ff(0x1cf)](_0x4982a8);else throw new common_1[(_0xd546ff(0x238))](_0xd546ff(0x1d8),common_1['HttpStatus']['BAD_REQUEST']);}return _0x1d55d7[_0xd546ff(0x1a4)]=_0x1d55d7[_0xd546ff(0x228)]?_0x1d55d7[_0xd546ff(0x1db)]+_0x1d55d7[_0xd546ff(0x1e3)]:_0x1d55d7['model3Count'],_0x1d55d7[_0xd546ff(0x1fc)]=_0x1d55d7[_0xd546ff(0x228)]?_0x1d55d7[_0xd546ff(0x191)]+_0x1d55d7[_0xd546ff(0x1ba)]:_0x1d55d7[_0xd546ff(0x191)],_0x1d55d7[_0xd546ff(0x1a1)]=_0x1d55d7[_0xd546ff(0x228)]?_0x1d55d7[_0xd546ff(0x1c1)]+_0x1d55d7[_0xd546ff(0x1d4)]:_0x1d55d7[_0xd546ff(0x1c1)],_0x1d55d7[_0xd546ff(0x1f8)]=_0x1d55d7[_0xd546ff(0x1f8)]?(0x0,date_1[_0xd546ff(0x1ec)])(_0x1d55d7[_0xd546ff(0x1f8)],_0xd546ff(0x1ee)):null,_0x1d55d7;}catch(_0x5a515e){console[_0xd546ff(0x1ed)](_0xd546ff(0x1b0),_0x5a515e);}}async['saveRecordRechargeLog'](_0x149cba){const _0x5a6d30=_0x4b5a0f,{userId:_0x152dff,rechargeType:_0x1605e7,model3Count:_0x43124a,model4Count:_0x5a1a77,drawMjCount:_0x1261b5,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x149cba;if(!_0x152dff)throw new common_1[(_0x5a6d30(0x238))](_0x5a6d30(0x1d2),common_1[_0x5a6d30(0x1e2)][_0x5a6d30(0x227)]);const _0x2e6b84=(0x0,utils_1[_0x5a6d30(0x23d)])();return await this['accountLogEntity'][_0x5a6d30(0x214)]({'userId':_0x152dff,'rechargeType':_0x1605e7,'model3Count':_0x43124a,'model4Count':_0x5a1a77,'drawMjCount':_0x1261b5,'days':days,'extent':extent,'uid':_0x2e6b84,'pkgName':pkgName});}async['createBaseUserBalance'](_0x5a058a,_0x4ba82b={}){const _0x2422bc=_0x4b5a0f,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4ba82b,_0x29d6f1=await this[_0x2422bc(0x1a9)][_0x2422bc(0x197)]({'where':{'userId':_0x5a058a}});if(_0x29d6f1)throw new common_1[(_0x2422bc(0x238))](_0x2422bc(0x1a0),common_1[_0x2422bc(0x1e2)]['BAD_REQUEST']);return await this['userBalanceEntity'][_0x2422bc(0x214)]({'userId':_0x5a058a,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x3ef99b,_0x1dd40b,_0x1460b4=-0x1){const _0x17205d=_0x4b5a0f;try{const _0x35dbd3=await this[_0x17205d(0x1a9)][_0x17205d(0x197)]({'where':{'userId':_0x3ef99b}})||await this['createBaseUserBalance'](_0x3ef99b);if(!_0x35dbd3)throw new common_1[(_0x17205d(0x238))](_0x17205d(0x208),common_1['HttpStatus']['BAD_REQUEST']);const {model3Count:_0x34be61,model4Count:_0x43deed,drawMjCount:_0x4ee801,memberModel3Count:_0x50fc01,memberModel4Count:_0x50f021,memberDrawMjCount:_0x4a38db}=_0x35dbd3;let _0x26c661={};if(_0x1460b4>0x0){const {packageId:_0xb7ec30}=_0x1dd40b;if(!_0xb7ec30)throw new common_1['HttpException'](_0x17205d(0x219),common_1[_0x17205d(0x1e2)][_0x17205d(0x227)]);const _0x40b206=await this[_0x17205d(0x22f)][_0x17205d(0x197)]({'where':{'id':_0xb7ec30}});if(!_0x40b206)throw new common_1[(_0x17205d(0x238))](_0x17205d(0x182),common_1['HttpStatus'][_0x17205d(0x227)]);const {weight:_0x34b7fb}=_0x40b206;if(!_0x35dbd3['packageId'])_0x26c661={'memberModel3Count':_0x34be61+_0x1dd40b['model3Count'],'memberModel4Count':_0x43deed+_0x1dd40b['model4Count'],'memberDrawMjCount':_0x4ee801+_0x1dd40b[_0x17205d(0x1c1)],'expirationTime':(0x0,date_1[_0x17205d(0x17d)])()[_0x17205d(0x192)](_0x1460b4>0x0?_0x1460b4:0x0,_0x17205d(0x1a2))[_0x17205d(0x239)](_0x17205d(0x209)),'packageId':_0xb7ec30};else{const _0xc4f391=await this[_0x17205d(0x22f)][_0x17205d(0x197)]({'where':{'id':_0x35dbd3['packageId']}});_0x34b7fb>=_0xc4f391[_0x17205d(0x1f5)]&&(_0x26c661={'memberModel3Count':_0x50fc01+_0x1dd40b['model3Count'],'memberModel4Count':_0x50f021+_0x1dd40b[_0x17205d(0x191)],'memberDrawMjCount':_0x4a38db+_0x1dd40b[_0x17205d(0x1c1)],'expirationTime':(0x0,date_1[_0x17205d(0x17d)])(_0x35dbd3['expirationTime'])['add'](_0x1460b4>0x0?_0x1460b4:0x0,'day')[_0x17205d(0x239)](_0x17205d(0x209)),'packageId':_0xb7ec30}),_0x34b7fb<_0xc4f391['weight']&&(_0x26c661={'memberModel3Count':_0x50fc01+_0x1dd40b[_0x17205d(0x1db)],'memberModel4Count':_0x50f021+_0x1dd40b[_0x17205d(0x191)],'memberDrawMjCount':_0x4a38db+_0x1dd40b['drawMjCount']});}}_0x1460b4<=0x0&&(_0x26c661={'model3Count':_0x34be61+_0x1dd40b[_0x17205d(0x1db)],'model4Count':_0x43deed+_0x1dd40b[_0x17205d(0x191)],'drawMjCount':_0x4ee801+_0x1dd40b[_0x17205d(0x1c1)]});const _0x3bface=await this[_0x17205d(0x1a9)][_0x17205d(0x190)]({'userId':_0x3ef99b},_0x26c661);if(_0x3bface[_0x17205d(0x223)]===0x0)throw new common_1[(_0x17205d(0x238))](_0x3ef99b+_0x17205d(0x1b2),common_1[_0x17205d(0x1e2)][_0x17205d(0x227)]);}catch(_0x561878){console[_0x17205d(0x1ed)]('error:\x20',_0x561878);throw new common_1[(_0x17205d(0x238))](_0x17205d(0x1c6),common_1['HttpStatus'][_0x17205d(0x227)]);}}async[_0x4b5a0f(0x17e)](_0x4d4d75){const _0x42a98a=_0x4b5a0f;console[_0x42a98a(0x1ed)](_0x42a98a(0x212),_0x4d4d75);try{const {userId:_0x14af3e,goodsId:_0x3dcf84}=_0x4d4d75,_0x3c6f8b=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x4d4d75[_0x42a98a(0x19d)],'status':0x1}});if(!_0x3c6f8b)throw new common_1[(_0x42a98a(0x238))](_0x42a98a(0x20c),common_1['HttpStatus'][_0x42a98a(0x227)]);const {model3Count:_0x315b48,model4Count:_0x177b12,drawMjCount:_0x15d294,days:_0x57da7f,name:_0x30f96a}=_0x3c6f8b,_0x3ba46f={'model3Count':_0x315b48,'model4Count':_0x177b12,'drawMjCount':_0x15d294,'days':_0x57da7f,'packageId':_0x4d4d75[_0x42a98a(0x19d)]};await this[_0x42a98a(0x206)](_0x14af3e,_0x3ba46f,_0x57da7f),await this[_0x42a98a(0x1e6)]({'userId':_0x14af3e,'rechargeType':balance_constant_1[_0x42a98a(0x213)]['SCAN_PAY'],'model3Count':_0x315b48,'model4Count':_0x177b12,'drawMjCount':_0x15d294,'pkgName':_0x30f96a,'days':_0x57da7f});const _0x5e7efa=await this[_0x42a98a(0x18e)][_0x42a98a(0x197)]({'where':{'id':_0x14af3e}}),{invitedBy:_0x371fae}=_0x5e7efa;if(_0x371fae){const _0x55e9f5=await this['userEntity']['findOne']({'where':{'inviteCode':_0x371fae}}),_0x5ca86d=await this[_0x42a98a(0x17b)]['findOne']({'where':{'userId':_0x55e9f5['id']}});if(!_0x55e9f5)return;const {id:_0x563160}=_0x55e9f5,{performanceRatio:_0x9ea104}=_0x5ca86d,_0x481fa7={'inviterUserId':_0x563160,'inviteeUserId':_0x14af3e,'orderId':_0x4d4d75['id'],'orderPrice':_0x4d4d75[_0x42a98a(0x235)],'commissionPercentage':_0x9ea104,'commissionAmount':(_0x4d4d75[_0x42a98a(0x235)]*_0x9ea104/0x64)['toFixed'](0x2)};await this[_0x42a98a(0x1d0)]['createSalesRecords'](_0x481fa7),await this[_0x42a98a(0x1d0)][_0x42a98a(0x1e4)](_0x563160,_0x481fa7['commissionAmount']);}}catch(_0x3931f4){console[_0x42a98a(0x1ed)](_0x42a98a(0x1b0),_0x3931f4);throw new common_1[(_0x42a98a(0x238))](_0x42a98a(0x1e1),common_1['HttpStatus'][_0x42a98a(0x227)]);}}async[_0x4b5a0f(0x229)](_0x225aa9,_0x5682de){const _0x3af037=_0x4b5a0f,{page:page=0x1,size:size=0x14}=_0x5682de,{id:_0x32f613}=_0x225aa9[_0x3af037(0x1f6)],[_0x22e361,_0xc047af]=await this['accountLogEntity'][_0x3af037(0x189)]({'where':{'userId':_0x32f613},'order':{'id':_0x3af037(0x217)},'skip':(page-0x1)*size,'take':size});return _0x22e361[_0x3af037(0x194)](_0x3f62be=>{const _0x1702fc=_0x3af037;_0x3f62be[_0x1702fc(0x1aa)]=_0x3f62be[_0x1702fc(0x1e7)]>0x0?_0x3f62be['days']+'天':'永久';}),{'rows':(0x0,date_1[_0x3af037(0x1de)])(_0x22e361),'count':_0xc047af};}async[_0x4b5a0f(0x1c7)](_0x46fb94,_0x186e79){const _0x53750e=_0x4b5a0f;try{const {page:page=0x1,size:size=0xa,userId:_0x3584bd,rechargeType:_0x137da8,packageId:_0x28f962}=_0x186e79,{role:_0x46a74d}=_0x46fb94[_0x53750e(0x1f6)],_0x4421e4={};_0x137da8&&(_0x4421e4[_0x53750e(0x179)]=_0x137da8),_0x4421e4[_0x53750e(0x1cb)]=_0x3584bd||(0x0,typeorm_2[_0x53750e(0x1b5)])(0x186a0),_0x28f962&&(_0x4421e4['packageId']={'$like':'%'+_0x28f962+'%'});const [_0x4aeaec,_0x156a5e]=await this[_0x53750e(0x205)][_0x53750e(0x189)]({'where':_0x4421e4,'order':{'id':_0x53750e(0x217)},'skip':(page-0x1)*size,'take':size}),_0x3c75ce=_0x4aeaec[_0x53750e(0x177)](_0x13231c=>_0x13231c[_0x53750e(0x1cb)]),_0x241777=await this[_0x53750e(0x18e)][_0x53750e(0x1d9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3c75ce)}});return _0x4aeaec['forEach'](_0xbf72a4=>{const _0x23878e=_0x53750e,_0x5f59a0=_0x241777[_0x23878e(0x1d9)](_0x1cefb1=>_0x1cefb1['id']===_0xbf72a4[_0x23878e(0x1cb)]);_0xbf72a4[_0x23878e(0x23c)]=_0x5f59a0===null||_0x5f59a0===void 0x0?void 0x0:_0x5f59a0[_0x23878e(0x23c)],_0xbf72a4[_0x23878e(0x22b)]=_0x5f59a0===null||_0x5f59a0===void 0x0?void 0x0:_0x5f59a0[_0x23878e(0x22b)],_0xbf72a4[_0x23878e(0x21e)]=_0x5f59a0===null||_0x5f59a0===void 0x0?void 0x0:_0x5f59a0['phone'],_0xbf72a4[_0x23878e(0x224)]=_0x5f59a0===null||_0x5f59a0===void 0x0?void 0x0:_0x5f59a0[_0x23878e(0x224)],_0xbf72a4['avatar']=_0x5f59a0===null||_0x5f59a0===void 0x0?void 0x0:_0x5f59a0[_0x23878e(0x1b9)];}),_0x46a74d!==_0x53750e(0x1ac)&&_0x4aeaec['forEach'](_0xa90aba=>{const _0x2e8d2a=_0x53750e;_0xa90aba[_0x2e8d2a(0x22b)]=_0xa90aba[_0x2e8d2a(0x22b)]?(0x0,utils_1[_0x2e8d2a(0x20f)])(_0xa90aba[_0x2e8d2a(0x22b)]):'',_0xa90aba[_0x2e8d2a(0x21e)]=_0xa90aba[_0x2e8d2a(0x21e)]?(0x0,utils_1['hideString'])(_0xa90aba[_0x2e8d2a(0x21e)]):'';}),{'rows':_0x4aeaec,'count':_0x156a5e};}catch(_0x41e117){console['log'](_0x53750e(0x1b0),_0x41e117);throw new common_1[(_0x53750e(0x238))](_0x53750e(0x23a),common_1[_0x53750e(0x1e2)]['BAD_REQUEST']);}}async['queryUserBalanceByIds'](_0x3db4b3){const _0x21a7d3=_0x4b5a0f;return await this[_0x21a7d3(0x1a9)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x3db4b3)}});}async['refundMjBalance'](_0x4667eb,_0x4aa4e1){const _0xe0b6fa=_0x4b5a0f;return await this['deductFromBalance'](_0x4667eb,_0xe0b6fa(0x1df),-_0x4aa4e1);}async[_0x4b5a0f(0x1f9)](){const _0x2f59d4=_0x4b5a0f,_0x1268fb=await this['userEntity'][_0x2f59d4(0x1d9)]();if(!_0x1268fb[_0x2f59d4(0x231)])return;const _0x1e3ffb=await this[_0x2f59d4(0x1e5)][_0x2f59d4(0x200)](['upgradeStatus']);if(!_0x1e3ffb)await this[_0x2f59d4(0x1e5)][_0x2f59d4(0x204)]({'settings':[{'configKey':_0x2f59d4(0x1c0),'configVal':'1'}]});else throw new common_1[(_0x2f59d4(0x238))](_0x2f59d4(0x19b),common_1[_0x2f59d4(0x1e2)][_0x2f59d4(0x227)]);_0x1268fb[_0x2f59d4(0x194)](_0x10832d=>{const _0xbce303=_0x2f59d4,{id:_0x276020}=_0x10832d;this[_0xbce303(0x19a)]['findOne']({'where':{'userId':_0x276020}})[_0xbce303(0x1e9)](_0x32941c=>{const _0x4495c7=_0xbce303;if(!_0x32941c)return;this[_0x4495c7(0x1d7)](_0x276020,_0x32941c);});});}async['writeOldBalanceToNewTable'](_0x5b689e,_0x15dec5){const _0x391dc9=_0x4b5a0f,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x15dec5,_0x925ed6=await this[_0x391dc9(0x236)][_0x391dc9(0x197)]({'where':{'userId':_0x5b689e}}),_0x1df1f8={'userId':_0x5b689e,'model3Count':Number(usesLeft),'model4Count':(_0x925ed6===null||_0x925ed6===void 0x0?void 0x0:_0x925ed6['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x925ed6===null||_0x925ed6===void 0x0?void 0x0:_0x925ed6[_0x391dc9(0x1ff)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x1d21a4=await this['userBalanceEntity'][_0x391dc9(0x197)]({'where':{'userId':_0x5b689e}});_0x1d21a4?common_1['Logger'][_0x391dc9(0x23e)]('用户'+_0x5b689e+_0x391dc9(0x20b),'BalanceService'):this[_0x391dc9(0x1a9)][_0x391dc9(0x214)](_0x1df1f8)[_0x391dc9(0x1e9)](_0x50f849=>{const _0x5191f8=_0x391dc9;common_1[_0x5191f8(0x232)][_0x5191f8(0x23e)]('用户'+_0x5b689e+_0x5191f8(0x21c),_0x5191f8(0x1d1));})[_0x391dc9(0x19c)](_0x11d8c2=>{const _0x184a5a=_0x391dc9;console[_0x184a5a(0x1ed)](_0x184a5a(0x1b0),_0x11d8c2),common_1[_0x184a5a(0x232)][_0x184a5a(0x23e)]('用户'+_0x5b689e+_0x184a5a(0x18b),_0x184a5a(0x1d1));});}async[_0x4b5a0f(0x1c2)](_0x4eb41a){const _0x4f5107=_0x4b5a0f,{fingerprint:_0x4fe305}=_0x4eb41a[_0x4f5107(0x1b3)],{id:_0x16d750}=_0x4eb41a[_0x4f5107(0x1f6)];return await this[_0x4f5107(0x199)]['update']({'userId':Number(_0x4fe305)},{'userId':_0x16d750}),await this[_0x4f5107(0x1f0)][_0x4f5107(0x190)]({'userId':Number(_0x4fe305)},{'userId':_0x16d750}),await this['midjourneyEntity']['update']({'userId':Number(_0x4fe305)},{'userId':_0x16d750}),0x1;}async['getVisitorCount'](_0x505759){const _0x4bed71=_0x4b5a0f,{fingerprint:_0x56871e}=_0x505759[_0x4bed71(0x1b3)],_0x5270f6=await this[_0x4bed71(0x199)][_0x4bed71(0x195)]({'where':{'userId':_0x56871e}}),_0x16ea3e=await this['chatGroupEntity'][_0x4bed71(0x195)]({'where':{'userId':_0x56871e}}),_0x1272f0=await this[_0x4bed71(0x1f4)][_0x4bed71(0x195)]({'where':{'userId':_0x56871e}});return _0x5270f6||_0x16ea3e||_0x1272f0||0x0;}};function _0x2c53(){const _0x4ac4fb=['DESC','---','缺失当前套餐ID、充值失败！','useModel3Token','./userBalance.entity','旧账户信息迁移成功','FingerprintLogEntity','phone','缺失当前用户账户记录！','addBalanceToNewUser','注册赠送失败,请联系管理员！','getMonth','affected','status','消费余额失败！','SalesService','BAD_REQUEST','packageId','getRechargeLog','__metadata','email','inviteSendStatus','registerSendStatus','firstRegisterSendStatus','cramiPackageEntity','isUpdatedToday','length','Logger','firstRegisterSendRank','visitor','total','whiteListEntity','validateVisitorBalance','HttpException','format','查询用户账户失败！','__esModule','username','createRandomUid','debug','61840CyLLuO','reduce','map','Repository','rechargeType','typeorm','salesUsersEntity','invitedGuestSendDrawMjCount','default','addBalanceToOrder','updatedAt','defineProperty','UserBalanceEntity','当前套餐不存在！','design:paramtypes','4748268EhnmOC','isInteger','useModel4Count','../sales/sales.service','firstRregisterSendModel4Count','findAndCount','deductFromBalance','旧账户信息迁移失败','object','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','userEntity','GlobalConfigService','update','model4Count','add','33hSNfRR','forEach','count','ChatGroupEntity','findOne','../../common/constants/balance.constant','chatLogEntity','balanceEntity','您已经升级过了、请勿重复操作！','catch','goodsId','REG_GIFT','BalanceEntity','当前用户无需创建账户信息！','sumDrawMjCount','day','visitorMJNum','sumModel3Count','invitedGuestSendModel3Count','inviteGiveSendModel3Count','../../common/utils','./balance.entity','userBalanceEntity','expireDateCn','configVal','super','odel3','firstRregisterSendDrawMjCount','761655STJgeg','error:\x20','8035lBbhsq','充值失败','headers','../globalConfig/globalConfig.service','LessThan','ConfigEntity','configKey','CramiPackageEntity','avatar','memberModel4Count','createBaseUserBalance','fingerprintLogEntity','useModel4Token','WhiteListEntity','../globalConfig/config.entity','upgradeStatus','drawMjCount','inheritVisitorData','PAYMENT_REQUIRED','ChatLogEntity','metadata','用户充值失败！','getAccountLog','../crami/cramiPackage.entity','@nestjs/common','visitorModel4Num','userId','registerSendModel3Count','@nestjs/typeorm','../chatgpt/whiteList.entity','queryUserBalance','salesService','BalanceService','当前用户不存在,记录充值日志异常','invitedGuestSendModel4Count','memberDrawMjCount','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','15726762viUMAD','writeOldBalanceToNewTable','查询当前用户余额失败！','find','useDrawMjToken','model3Count','AccountLogEntity','../sales/salesUsers.entity','formatCreateOrUpdateDate','mjDraw','../../common/utils/date','充值失败！','HttpStatus','memberModel3Count','saveCommissionAmount','globalConfigService','saveRecordRechargeLog','days','firstRregisterSendModel3Count','then','inviteGiveSendDrawMjCount','__param','formatDate','log','YYYY-MM-DD','model3','chatGroupEntity','../chatLog/chatLog.entity','inviteGiveSendModel4Count','visitorModel3Num','midjourneyEntity','weight','user','>\x20或购买专属套餐\x20！','expirationTime','upgradeBalance','199871wycgXy','getOwnPropertyDescriptor','sumModel4Count','MjCount','function','useCount','getConfigs','configEntity','UserBalanceService','InjectRepository','setConfig','accountLogEntity','addBalanceToUser','registerSendModel4Count','查询用户账户信息失败！','YYYY-MM-DD\x20HH:mm:ss','MidjourneyEntity','账户信息已经存在、迁移无效','非法操作、当前充值套餐暂不存在！','model4','includes','hideString','INVITE_GIFT','registerSendDrawMjCount','充值的工单信息:','RechargeType','save','1104aTXlsX','1921064ZOiGtu'];_0x2c53=function(){return _0x4ac4fb;};return _0x2c53();}UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x4b5a0f(0x203)])(balance_entity_1[_0x4b5a0f(0x19f)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x4b5a0f(0x181)])),__param(0x2,(0x0,typeorm_1[_0x4b5a0f(0x203)])(accountLog_entity_1[_0x4b5a0f(0x1dc)])),__param(0x3,(0x0,typeorm_1[_0x4b5a0f(0x203)])(cramiPackage_entity_1[_0x4b5a0f(0x1b8)])),__param(0x4,(0x0,typeorm_1[_0x4b5a0f(0x203)])(config_entity_1[_0x4b5a0f(0x1b6)])),__param(0x5,(0x0,typeorm_1[_0x4b5a0f(0x203)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x4b5a0f(0x203)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1[_0x4b5a0f(0x203)])(whiteList_entity_1[_0x4b5a0f(0x1be)])),__param(0x8,(0x0,typeorm_1[_0x4b5a0f(0x203)])(fingerprint_entity_1[_0x4b5a0f(0x21d)])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x4b5a0f(0x196)])),__param(0xa,(0x0,typeorm_1[_0x4b5a0f(0x203)])(chatLog_entity_1[_0x4b5a0f(0x1c4)])),__param(0xb,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x4b5a0f(0x20a)])),__metadata(_0x4b5a0f(0x183),[typeorm_2['Repository'],typeorm_2[_0x4b5a0f(0x178)],typeorm_2[_0x4b5a0f(0x178)],typeorm_2[_0x4b5a0f(0x178)],typeorm_2[_0x4b5a0f(0x178)],typeorm_2[_0x4b5a0f(0x178)],typeorm_2[_0x4b5a0f(0x178)],typeorm_2[_0x4b5a0f(0x178)],typeorm_2['Repository'],typeorm_2[_0x4b5a0f(0x178)],typeorm_2[_0x4b5a0f(0x178)],typeorm_2['Repository'],sales_service_1[_0x4b5a0f(0x226)],globalConfig_service_1[_0x4b5a0f(0x18f)]])],UserBalanceService),exports[_0x4b5a0f(0x202)]=UserBalanceService;