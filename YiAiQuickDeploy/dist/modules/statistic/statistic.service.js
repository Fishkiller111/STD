'use strict';const _0x556b78=_0x143a;function _0x1d73(){const _0x121ab2=['../globalConfig/config.entity','../chatLog/chatLog.entity','countNewDrawsToday','configEntity','YYYYMMDD','user.createdAt\x20<\x20:tomorrow','Repository','../midjourney/midjourney.entity','1868500jHLSeg','34rCIHdQ','createQueryBuilder','baiduToken','midjourney','getRawMany','push','axios','baiduSiteId','&start_date=','../../common/utils/date','../../common/constants/balance.constant','InjectRepository','HttpException','midjourneyEntity','@nestjs/typeorm','chatlog','chatLog.createdAt\x20<\x20:tomorrow','getTime','countNewUsersToday','midjourney.status\x20=\x20:status','countNewOrdersToday','CHAT_TYPE','HttpStatus','groupBy','getCount','__decorate','&method=','@nestjs/common','getBaiduVisit','getBaiduStatistics','countDraws','chatLog.createdAt\x20>=\x20:today','countNewMidhourneysToday','BAD_REQUEST','map','countChats','result','configKey','user.createdAt\x20>=\x20:today','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','userEntity','PAINT_TYPE','__esModule','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','getOwnPropertyDescriptor','midjourney.createdAt\x20>=\x20:today','get','where','configVal','overview/getTimeTrendRpt','count','function','chatLog','data','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','countNewChatsToday','获取百度统计数据失败','countChatsByTimeRange','chatLogEntity','48761LBipiq','now','typeorm','543228dvAepr','date','formatDate','../user/user.entity','andWhere','orderEntity','MidjourneyEntity','orderBy','百度授权码过期','getChatStatistic','countOrders','../../common/constants/midjourney.constant','metadata','__param','countMjDrawsByTimeRange','select','value','setHours','chatlog.createdAt\x20>=\x20:startDate','defineProperty','StatisticService','object','chatLog.type\x20=\x20:type','M.DD','ConfigEntity','setDate','chatlog.type\x20=\x20:type','4285cjfXUT','413316fIzHoR','DRAWED','1880BxMCea','32814IDKgwZ','length','decorate','UserEntity','1044dbCVzz','getDate','MidjourneyStatusEnum','user','design:paramtypes','countDrawsByTimeRange','order.createdAt\x20>=\x20:today','find','请先配置百度统计accessToken','countUsers','19157470ngOcrP','getBaseStatistic','Injectable','midjourney.createdAt\x20>=\x20:startDate','DeductionKey'];_0x1d73=function(){return _0x121ab2;};return _0x1d73();}(function(_0x4c1c54,_0x53004a){const _0x2c8fee=_0x143a,_0x4375f4=_0x4c1c54();while(!![]){try{const _0x1c091a=-parseInt(_0x2c8fee(0x1bd))/0x1*(parseInt(_0x2c8fee(0x182))/0x2)+parseInt(_0x2c8fee(0x163))/0x3+parseInt(_0x2c8fee(0x181))/0x4+parseInt(_0x2c8fee(0x1db))/0x5*(-parseInt(_0x2c8fee(0x16a))/0x6)+-parseInt(_0x2c8fee(0x1c0))/0x7+-parseInt(_0x2c8fee(0x165))/0x8*(parseInt(_0x2c8fee(0x166))/0x9)+parseInt(_0x2c8fee(0x174))/0xa;if(_0x1c091a===_0x53004a)break;else _0x4375f4['push'](_0x4375f4['shift']());}catch(_0xcb452c){_0x4375f4['push'](_0x4375f4['shift']());}}}(_0x1d73,0x947af));function _0x143a(_0x5ea0bc,_0x9e8f26){const _0x1d7316=_0x1d73();return _0x143a=function(_0x143af2,_0x313e7d){_0x143af2=_0x143af2-0x163;let _0x2787de=_0x1d7316[_0x143af2];return _0x2787de;},_0x143a(_0x5ea0bc,_0x9e8f26);}var __decorate=this&&this[_0x556b78(0x19b)]||function(_0x2603a4,_0x58e5c5,_0x851139,_0x2f6364){const _0xc03b43=_0x556b78;var _0x4b7dcb=arguments[_0xc03b43(0x167)],_0x4aed8d=_0x4b7dcb<0x3?_0x58e5c5:_0x2f6364===null?_0x2f6364=Object[_0xc03b43(0x1ae)](_0x58e5c5,_0x851139):_0x2f6364,_0x2c6e98;if(typeof Reflect==='object'&&typeof Reflect[_0xc03b43(0x168)]==='function')_0x4aed8d=Reflect['decorate'](_0x2603a4,_0x58e5c5,_0x851139,_0x2f6364);else{for(var _0x286605=_0x2603a4[_0xc03b43(0x167)]-0x1;_0x286605>=0x0;_0x286605--)if(_0x2c6e98=_0x2603a4[_0x286605])_0x4aed8d=(_0x4b7dcb<0x3?_0x2c6e98(_0x4aed8d):_0x4b7dcb>0x3?_0x2c6e98(_0x58e5c5,_0x851139,_0x4aed8d):_0x2c6e98(_0x58e5c5,_0x851139))||_0x4aed8d;}return _0x4b7dcb>0x3&&_0x4aed8d&&Object[_0xc03b43(0x1d3)](_0x58e5c5,_0x851139,_0x4aed8d),_0x4aed8d;},__metadata=this&&this['__metadata']||function(_0x2f8602,_0x5b53e2){const _0x565305=_0x556b78;if(typeof Reflect===_0x565305(0x1d5)&&typeof Reflect['metadata']===_0x565305(0x1b5))return Reflect[_0x565305(0x1cc)](_0x2f8602,_0x5b53e2);},__param=this&&this[_0x556b78(0x1cd)]||function(_0x473e5c,_0x424165){return function(_0xf6a96e,_0x5a0f89){_0x424165(_0xf6a96e,_0x5a0f89,_0x473e5c);};};Object[_0x556b78(0x1d3)](exports,_0x556b78(0x1ac),{'value':!![]}),exports[_0x556b78(0x1d4)]=void 0x0;const common_1=require(_0x556b78(0x19d)),typeorm_1=require(_0x556b78(0x190)),user_entity_1=require(_0x556b78(0x1c3)),typeorm_2=require(_0x556b78(0x1bf)),chatLog_entity_1=require(_0x556b78(0x17a)),balance_constant_1=require(_0x556b78(0x18c)),date_1=require(_0x556b78(0x18b)),axios_1=require(_0x556b78(0x188)),config_entity_1=require(_0x556b78(0x179)),order_entity_1=require('../order/order.entity'),midjourney_entity_1=require(_0x556b78(0x180)),midjourney_constant_1=require(_0x556b78(0x1cb));let StatisticService=class StatisticService{constructor(_0x211f58,_0x31a15b,_0x2bebf8,_0x495a70,_0x41018f){const _0x17d4b6=_0x556b78;this[_0x17d4b6(0x1aa)]=_0x211f58,this[_0x17d4b6(0x1bc)]=_0x31a15b,this[_0x17d4b6(0x17c)]=_0x2bebf8,this[_0x17d4b6(0x1c5)]=_0x495a70,this[_0x17d4b6(0x18f)]=_0x41018f;}async[_0x556b78(0x175)](){const _0x5768dd=_0x556b78,_0x448225=await this[_0x5768dd(0x173)](),_0x45de0a=await this[_0x5768dd(0x194)](),_0xf9a95a=await this[_0x5768dd(0x1a5)](),_0x297657=await this[_0x5768dd(0x1b9)](),_0x47d1a5=await this[_0x5768dd(0x1a0)](),_0x11b9bf=await this[_0x5768dd(0x17b)](),_0x3a8a33=await this[_0x5768dd(0x1a2)](),_0x2edb1d=await this[_0x5768dd(0x1ca)](),_0x1fd855=await this[_0x5768dd(0x196)]();return{'userCount':_0x448225,'newUserCount':_0x45de0a,'chatCount':_0xf9a95a,'newChatCount':_0x297657,'drawCount':_0x47d1a5,'newDrawCount':_0x3a8a33+_0x11b9bf,'orderCount':_0x2edb1d,'newOrderCount':_0x1fd855};}async[_0x556b78(0x1c9)]({days:days=0x7}){const _0xde12f3=_0x556b78,_0x53c860=await this[_0xde12f3(0x1bb)](days),_0x55781e=await this['countDrawsByTimeRange'](days),_0x271d1e=await this[_0xde12f3(0x1ce)](days);return{'date':_0x53c860[_0xde12f3(0x1a4)](_0x5651c6=>_0x5651c6[_0xde12f3(0x1c1)]),'chat':_0x53c860[_0xde12f3(0x1a4)](_0x278541=>_0x278541[_0xde12f3(0x1d0)]),'draw':_0x55781e['map']((_0x4df5d8,_0x519ece)=>{const _0x6e3e44=_0xde12f3;return _0x4df5d8[_0x6e3e44(0x1d0)]+_0x271d1e[_0x519ece][_0x6e3e44(0x1d0)];})};}async[_0x556b78(0x19e)]({days:days=0x7}){const _0x298522=_0x556b78,_0x11429c=await this[_0x298522(0x19f)](days);return _0x11429c;}async[_0x556b78(0x173)](){const _0x3db654=_0x556b78,_0xa45353=await this[_0x3db654(0x1aa)][_0x3db654(0x1b4)]();return _0xa45353;}async[_0x556b78(0x194)](){const _0x28a57a=_0x556b78,_0x370dbc=new Date();_0x370dbc['setHours'](0x0,0x0,0x0,0x0);const _0x5cf50d=new Date(_0x370dbc[_0x28a57a(0x193)]()+0x18*0x3c*0x3c*0x3e8),_0x3a820e=this[_0x28a57a(0x1aa)][_0x28a57a(0x183)](_0x28a57a(0x16d)),_0x22a9f9=await _0x3a820e[_0x28a57a(0x1b1)](_0x28a57a(0x1a8),{'today':_0x370dbc})[_0x28a57a(0x1c4)](_0x28a57a(0x17e),{'tomorrow':_0x5cf50d})['getCount']();return _0x22a9f9;}async[_0x556b78(0x1a5)](){const _0x2c2a50=_0x556b78,_0x4fa78f=await this['chatLogEntity'][_0x2c2a50(0x1b4)]({'where':{'type':balance_constant_1[_0x2c2a50(0x178)][_0x2c2a50(0x197)]}});return _0x4fa78f;}async['countNewChatsToday'](){const _0x3aebca=_0x556b78,_0x4dc1f6=new Date();_0x4dc1f6[_0x3aebca(0x1d1)](0x0,0x0,0x0,0x0);const _0x4c9df9=new Date(_0x4dc1f6[_0x3aebca(0x193)]()+0x18*0x3c*0x3c*0x3e8),_0x609c6c=this[_0x3aebca(0x1bc)][_0x3aebca(0x183)](_0x3aebca(0x1b6)),_0x2511a2=await _0x609c6c[_0x3aebca(0x1b1)](_0x3aebca(0x1d6),{'type':balance_constant_1[_0x3aebca(0x178)][_0x3aebca(0x197)]})[_0x3aebca(0x1c4)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x4dc1f6})['andWhere']('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x4c9df9})['getCount']();return _0x2511a2;}async[_0x556b78(0x1a0)](){const _0x388df2=_0x556b78,_0xd3f379=await this[_0x388df2(0x1bc)][_0x388df2(0x1b4)]({'where':{'type':balance_constant_1[_0x388df2(0x178)][_0x388df2(0x1ab)]}});return _0xd3f379;}async[_0x556b78(0x17b)](){const _0x42529c=_0x556b78,_0x4163d2=new Date();_0x4163d2['setHours'](0x0,0x0,0x0,0x0);const _0x484e59=new Date(_0x4163d2['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x14a248=this[_0x42529c(0x1bc)][_0x42529c(0x183)](_0x42529c(0x1b6)),_0x254134=await _0x14a248[_0x42529c(0x1b1)](_0x42529c(0x1d6),{'type':balance_constant_1[_0x42529c(0x178)][_0x42529c(0x1ab)]})[_0x42529c(0x1c4)](_0x42529c(0x1a1),{'today':_0x4163d2})[_0x42529c(0x1c4)](_0x42529c(0x192),{'tomorrow':_0x484e59})[_0x42529c(0x19a)]();return _0x254134;}async[_0x556b78(0x1a2)](){const _0x5995a9=_0x556b78,_0x3606f8=new Date();_0x3606f8[_0x5995a9(0x1d1)](0x0,0x0,0x0,0x0);const _0x5a6cee=new Date(_0x3606f8[_0x5995a9(0x193)]()+0x18*0x3c*0x3c*0x3e8),_0x7a1f6e=this['midjourneyEntity'][_0x5995a9(0x183)](_0x5995a9(0x185)),_0x102c31=await _0x7a1f6e[_0x5995a9(0x1b1)](_0x5995a9(0x1af),{'today':_0x3606f8})['andWhere']('midjourney.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x5a6cee})[_0x5995a9(0x19a)]();return _0x102c31;}async[_0x556b78(0x1bb)](_0x1f8315){const _0x2e210c=_0x556b78;var _0x95cbf2,_0x651a16;const _0x450ae7=new Date();_0x450ae7[_0x2e210c(0x1d1)](0x0,0x0,0x0,0x0);const _0x49f5c3=new Date(_0x450ae7['getTime']()-(_0x1f8315-0x1)*0x18*0x3c*0x3c*0x3e8),_0xc18c0=this[_0x2e210c(0x1bc)][_0x2e210c(0x183)](_0x2e210c(0x191)),_0x34fa41=await _0xc18c0[_0x2e210c(0x1cf)](_0x2e210c(0x1ad))['where'](_0x2e210c(0x1da),{'type':balance_constant_1[_0x2e210c(0x178)][_0x2e210c(0x197)]})[_0x2e210c(0x1c4)](_0x2e210c(0x1d2),{'startDate':_0x49f5c3})[_0x2e210c(0x199)](_0x2e210c(0x1c1))[_0x2e210c(0x1c7)](_0x2e210c(0x1c1))[_0x2e210c(0x186)](),_0x38578e=[],_0x4eff9f=_0x49f5c3;for(let _0x54a308=0x0;_0x54a308<_0x1f8315;_0x54a308++){const _0x3271df=(0x0,date_1[_0x2e210c(0x1c2)])(new Date(_0x4eff9f),_0x2e210c(0x1d7)),_0x395572=(_0x651a16=(_0x95cbf2=_0x34fa41[_0x2e210c(0x171)](_0x4351d8=>(0x0,date_1['formatDate'])(new Date(_0x4351d8[_0x2e210c(0x1c1)]),_0x2e210c(0x1d7))===_0x3271df))===null||_0x95cbf2===void 0x0?void 0x0:_0x95cbf2['count'])!==null&&_0x651a16!==void 0x0?_0x651a16:0x0;_0x395572>0x0?_0x38578e[_0x2e210c(0x187)]({'date':_0x3271df,'value':Number(_0x395572)}):_0x38578e[_0x2e210c(0x187)]({'date':_0x3271df,'value':0x0}),_0x4eff9f['setDate'](_0x4eff9f[_0x2e210c(0x16b)]()+0x1);}return _0x38578e;}async[_0x556b78(0x16f)](_0x3c0181){const _0x490ad7=_0x556b78;var _0x43541b,_0x235556;const _0x7eccfc=new Date();_0x7eccfc[_0x490ad7(0x1d1)](0x0,0x0,0x0,0x0);const _0x49adff=new Date(_0x7eccfc['getTime']()-(_0x3c0181-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3881c0=this[_0x490ad7(0x1bc)][_0x490ad7(0x183)]('chatlog'),_0x32556c=await _0x3881c0[_0x490ad7(0x1cf)](_0x490ad7(0x1ad))[_0x490ad7(0x1b1)](_0x490ad7(0x1da),{'type':balance_constant_1[_0x490ad7(0x178)][_0x490ad7(0x1ab)]})['andWhere']('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x49adff})[_0x490ad7(0x199)](_0x490ad7(0x1c1))[_0x490ad7(0x1c7)](_0x490ad7(0x1c1))[_0x490ad7(0x186)](),_0x1348d1=[],_0x38fbec=_0x49adff;for(let _0x5b97a9=0x0;_0x5b97a9<_0x3c0181;_0x5b97a9++){const _0x15bf3b=(0x0,date_1[_0x490ad7(0x1c2)])(new Date(_0x38fbec),_0x490ad7(0x1d7)),_0x48c60c=(_0x235556=(_0x43541b=_0x32556c['find'](_0x23ad70=>(0x0,date_1[_0x490ad7(0x1c2)])(new Date(_0x23ad70['date']),_0x490ad7(0x1d7))===_0x15bf3b))===null||_0x43541b===void 0x0?void 0x0:_0x43541b[_0x490ad7(0x1b4)])!==null&&_0x235556!==void 0x0?_0x235556:0x0;_0x48c60c>0x0?_0x1348d1[_0x490ad7(0x187)]({'date':_0x15bf3b,'value':Number(_0x48c60c)}):_0x1348d1[_0x490ad7(0x187)]({'date':_0x15bf3b,'value':0x0}),_0x38fbec['setDate'](_0x38fbec['getDate']()+0x1);}return _0x1348d1;}async[_0x556b78(0x1ce)](_0x3daa50){const _0x20399c=_0x556b78;var _0x3bfe18,_0x43a494;const _0x51ed7a=new Date();_0x51ed7a[_0x20399c(0x1d1)](0x0,0x0,0x0,0x0);const _0xff09ec=new Date(_0x51ed7a['getTime']()-(_0x3daa50-0x1)*0x18*0x3c*0x3c*0x3e8),_0x12214a=this[_0x20399c(0x18f)]['createQueryBuilder'](_0x20399c(0x185)),_0x7b35d8=await _0x12214a['select']('DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x20399c(0x1b1)](_0x20399c(0x195),{'status':midjourney_constant_1[_0x20399c(0x16c)][_0x20399c(0x164)]})[_0x20399c(0x1c4)](_0x20399c(0x177),{'startDate':_0xff09ec})['groupBy'](_0x20399c(0x1c1))['orderBy'](_0x20399c(0x1c1))[_0x20399c(0x186)](),_0x4bd365=[],_0x216370=_0xff09ec;for(let _0x285c88=0x0;_0x285c88<_0x3daa50;_0x285c88++){const _0x8c11a5=(0x0,date_1[_0x20399c(0x1c2)])(new Date(_0x216370),_0x20399c(0x1d7)),_0x4e12b8=(_0x43a494=(_0x3bfe18=_0x7b35d8[_0x20399c(0x171)](_0x1827ef=>(0x0,date_1[_0x20399c(0x1c2)])(new Date(_0x1827ef[_0x20399c(0x1c1)]),_0x20399c(0x1d7))===_0x8c11a5))===null||_0x3bfe18===void 0x0?void 0x0:_0x3bfe18[_0x20399c(0x1b4)])!==null&&_0x43a494!==void 0x0?_0x43a494:0x0;_0x4e12b8>0x0?_0x4bd365[_0x20399c(0x187)]({'date':_0x8c11a5,'value':Number(_0x4e12b8)}):_0x4bd365['push']({'date':_0x8c11a5,'value':0x0}),_0x216370[_0x20399c(0x1d9)](_0x216370['getDate']()+0x1);}return _0x4bd365;}async['getBaiduStatistics'](_0x2c37c2){const _0x163a60=_0x556b78;var _0x1b9b1e,_0x3c570f;const _0x108f99=(0x0,date_1['formatDate'])(new Date(),_0x163a60(0x17d)),_0x35ed83=(0x0,date_1['formatDate'])(new Date(Date[_0x163a60(0x1be)]()-Number(_0x2c37c2-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x172539=_0x163a60(0x1a9),_0x57ef6f=_0x163a60(0x1b3),_0x492d39=await this['configEntity'][_0x163a60(0x171)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x163a60(0x184),_0x163a60(0x189)])}}),_0x9157a6=(_0x1b9b1e=_0x492d39[_0x163a60(0x171)](_0x502d14=>_0x502d14['configKey']===_0x163a60(0x189)))===null||_0x1b9b1e===void 0x0?void 0x0:_0x1b9b1e[_0x163a60(0x1b2)],_0x306e07=(_0x3c570f=_0x492d39[_0x163a60(0x171)](_0x3d5bbb=>_0x3d5bbb[_0x163a60(0x1a7)]==='baiduToken'))===null||_0x3c570f===void 0x0?void 0x0:_0x3c570f[_0x163a60(0x1b2)];if(!_0x9157a6||!_0x306e07)return[];if(!_0x9157a6)throw new common_1['HttpException']('请先配置百度统计siteId',common_1[_0x163a60(0x198)][_0x163a60(0x1a3)]);if(!_0x306e07)throw new common_1[(_0x163a60(0x18e))](_0x163a60(0x172),common_1[_0x163a60(0x198)]['BAD_REQUEST']);const _0x4ee358=_0x163a60(0x1b8)+_0x306e07+'&site_id='+_0x9157a6+_0x163a60(0x19c)+_0x57ef6f+_0x163a60(0x18a)+_0x35ed83+'&end_date='+_0x108f99+'&metrics='+_0x172539,_0xb9d762=await axios_1['default'][_0x163a60(0x1b0)](_0x4ee358),{error_code:_0x11a231,message:_0x4e989e}=_0xb9d762['data'];if(_0x11a231===0x6f)throw new common_1[(_0x163a60(0x18e))](_0x4e989e||_0x163a60(0x1c8),common_1['HttpStatus']['BAD_REQUEST']);if(_0x11a231&&_0x11a231!==0xc8)throw new common_1[(_0x163a60(0x18e))](_0x4e989e||_0x163a60(0x1ba),common_1[_0x163a60(0x198)][_0x163a60(0x1a3)]);return _0xb9d762[_0x163a60(0x1b7)][_0x163a60(0x1a6)];}async['countOrders'](){const _0x8ad137=_0x556b78,_0x2c9bab=await this[_0x8ad137(0x1c5)]['count']();return _0x2c9bab;}async[_0x556b78(0x196)](){const _0x537c84=_0x556b78,_0x35059f=new Date();_0x35059f[_0x537c84(0x1d1)](0x0,0x0,0x0,0x0);const _0x438147=new Date(_0x35059f[_0x537c84(0x193)]()+0x18*0x3c*0x3c*0x3e8),_0x50254a=this[_0x537c84(0x1c5)]['createQueryBuilder']('order'),_0x264674=await _0x50254a[_0x537c84(0x1b1)](_0x537c84(0x170),{'today':_0x35059f})[_0x537c84(0x1c4)]('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x438147})[_0x537c84(0x19a)]();return _0x264674;}};StatisticService=__decorate([(0x0,common_1[_0x556b78(0x176)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x556b78(0x169)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x556b78(0x1d8)])),__param(0x3,(0x0,typeorm_1[_0x556b78(0x18d)])(order_entity_1['OrderEntity'])),__param(0x4,(0x0,typeorm_1[_0x556b78(0x18d)])(midjourney_entity_1[_0x556b78(0x1c6)])),__metadata(_0x556b78(0x16e),[typeorm_2[_0x556b78(0x17f)],typeorm_2[_0x556b78(0x17f)],typeorm_2[_0x556b78(0x17f)],typeorm_2[_0x556b78(0x17f)],typeorm_2[_0x556b78(0x17f)]])],StatisticService),exports[_0x556b78(0x1d4)]=StatisticService;