'use strict';function _0x1ed0(){const _0x26f9e0=['user','getTime','midjourney.createdAt\x20>=\x20:today','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','chatlog','createQueryBuilder','10TDFYLs','&site_id=','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','@nestjs/common','configEntity','midjourney.createdAt\x20>=\x20:startDate','&metrics=','chatLog','select','midjourney.status\x20=\x20:status','countChatsByTimeRange','InjectRepository','../../common/constants/midjourney.constant','orderBy','7437529DuJTnx','458640PbVinm','UserEntity','design:paramtypes','BAD_REQUEST','orderEntity','OrderEntity','data','1894140KBmRzu','../chatLog/chatLog.entity','countMjDrawsByTimeRange','configKey','HttpStatus','../../common/constants/balance.constant','chatLog.type\x20=\x20:type','M.DD','andWhere','@nestjs/typeorm','Repository','StatisticService','../../common/utils/date','push','833uzthIC','6nuBGjK','&method=','baiduToken','userEntity','5kwgSPp','setHours','CHAT_TYPE','setDate','&end_date=','function','countDrawsByTimeRange','configVal','formatDate','__decorate','获取百度统计数据失败','chatlog.createdAt\x20>=\x20:startDate','countNewChatsToday','find','countDraws','default','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','chatLog.createdAt\x20>=\x20:today','user.createdAt\x20>=\x20:today','midjourneyEntity','getCount','countNewMidhourneysToday','midjourney.createdAt\x20<\x20:tomorrow','countNewDrawsToday','277929bXKDMU','midjourney','DeductionKey','&start_date=','__param','where','value','countNewOrdersToday','count','chatLog.createdAt\x20<\x20:tomorrow','groupBy','../order/order.entity','PAINT_TYPE','../globalConfig/config.entity','../user/user.entity','metadata','chatlog.type\x20=\x20:type','getBaiduVisit','chatLogEntity','baiduSiteId','../midjourney/midjourney.entity','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','countNewUsersToday','MidjourneyEntity','621924fhQyzG','object','getDate','countUsers','10984woMbiW','YYYYMMDD','497101vZKagS','length','map','HttpException','decorate','countChats','getBaiduStatistics','date','getRawMany','user.createdAt\x20<\x20:tomorrow','order.createdAt\x20<\x20:tomorrow','order.createdAt\x20>=\x20:today','MidjourneyStatusEnum'];_0x1ed0=function(){return _0x26f9e0;};return _0x1ed0();}function _0x5d20(_0x2d2da6,_0x4a8ab0){const _0x1ed05e=_0x1ed0();return _0x5d20=function(_0x5d20a0,_0x247d05){_0x5d20a0=_0x5d20a0-0x72;let _0x441272=_0x1ed05e[_0x5d20a0];return _0x441272;},_0x5d20(_0x2d2da6,_0x4a8ab0);}const _0x1926ec=_0x5d20;(function(_0x8bbdc6,_0x126d9b){const _0x1be4ba=_0x5d20,_0x4b8c75=_0x8bbdc6();while(!![]){try{const _0x2d782f=-parseInt(_0x1be4ba(0x73))/0x1+parseInt(_0x1be4ba(0xab))/0x2*(-parseInt(_0x1be4ba(0xc7))/0x3)+parseInt(_0x1be4ba(0x95))/0x4+-parseInt(_0x1be4ba(0xaf))/0x5*(parseInt(_0x1be4ba(0xdf))/0x6)+-parseInt(_0x1be4ba(0xaa))/0x7*(-parseInt(_0x1be4ba(0xe3))/0x8)+parseInt(_0x1be4ba(0x9c))/0x9+-parseInt(_0x1be4ba(0x86))/0xa*(-parseInt(_0x1be4ba(0x94))/0xb);if(_0x2d782f===_0x126d9b)break;else _0x4b8c75['push'](_0x4b8c75['shift']());}catch(_0x3ca3c8){_0x4b8c75['push'](_0x4b8c75['shift']());}}}(_0x1ed0,0x45d0a));var __decorate=this&&this[_0x1926ec(0xb8)]||function(_0x46235e,_0x1f7c83,_0x309ecd,_0x1a1414){const _0x411033=_0x1926ec;var _0x38c5a2=arguments['length'],_0x3ae329=_0x38c5a2<0x3?_0x1f7c83:_0x1a1414===null?_0x1a1414=Object['getOwnPropertyDescriptor'](_0x1f7c83,_0x309ecd):_0x1a1414,_0x1413e4;if(typeof Reflect===_0x411033(0xe0)&&typeof Reflect[_0x411033(0x77)]===_0x411033(0xb4))_0x3ae329=Reflect[_0x411033(0x77)](_0x46235e,_0x1f7c83,_0x309ecd,_0x1a1414);else{for(var _0x1c7bbc=_0x46235e[_0x411033(0x74)]-0x1;_0x1c7bbc>=0x0;_0x1c7bbc--)if(_0x1413e4=_0x46235e[_0x1c7bbc])_0x3ae329=(_0x38c5a2<0x3?_0x1413e4(_0x3ae329):_0x38c5a2>0x3?_0x1413e4(_0x1f7c83,_0x309ecd,_0x3ae329):_0x1413e4(_0x1f7c83,_0x309ecd))||_0x3ae329;}return _0x38c5a2>0x3&&_0x3ae329&&Object['defineProperty'](_0x1f7c83,_0x309ecd,_0x3ae329),_0x3ae329;},__metadata=this&&this['__metadata']||function(_0x3de5dc,_0x5a471e){const _0x54e22d=_0x1926ec;if(typeof Reflect==='object'&&typeof Reflect[_0x54e22d(0xd6)]===_0x54e22d(0xb4))return Reflect['metadata'](_0x3de5dc,_0x5a471e);},__param=this&&this[_0x1926ec(0xcb)]||function(_0x46526e,_0x45645a){return function(_0x23b648,_0x76bd5e){_0x45645a(_0x23b648,_0x76bd5e,_0x46526e);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x1926ec(0xa7)]=void 0x0;const common_1=require(_0x1926ec(0x89)),typeorm_1=require(_0x1926ec(0xa5)),user_entity_1=require(_0x1926ec(0xd5)),typeorm_2=require('typeorm'),chatLog_entity_1=require(_0x1926ec(0x9d)),balance_constant_1=require(_0x1926ec(0xa1)),date_1=require(_0x1926ec(0xa8)),axios_1=require('axios'),config_entity_1=require(_0x1926ec(0xd4)),order_entity_1=require(_0x1926ec(0xd2)),midjourney_entity_1=require(_0x1926ec(0xdb)),midjourney_constant_1=require(_0x1926ec(0x92));let StatisticService=class StatisticService{constructor(_0x41a3ea,_0x53e035,_0x54a2ac,_0x307ad5,_0x52da84){const _0x405cfa=_0x1926ec;this['userEntity']=_0x41a3ea,this['chatLogEntity']=_0x53e035,this[_0x405cfa(0x8a)]=_0x54a2ac,this[_0x405cfa(0x99)]=_0x307ad5,this['midjourneyEntity']=_0x52da84;}async['getBaseStatistic'](){const _0x2ccd6e=_0x1926ec,_0x4c99b8=await this[_0x2ccd6e(0xe2)](),_0x33f8bf=await this[_0x2ccd6e(0xdd)](),_0x1500ac=await this['countChats'](),_0x3f24a8=await this[_0x2ccd6e(0xbb)](),_0x3d8ae3=await this['countDraws'](),_0x5af6ba=await this[_0x2ccd6e(0xc6)](),_0x211be9=await this[_0x2ccd6e(0xc4)](),_0x24844f=await this['countOrders'](),_0x50efae=await this[_0x2ccd6e(0xce)]();return{'userCount':_0x4c99b8,'newUserCount':_0x33f8bf,'chatCount':_0x1500ac,'newChatCount':_0x3f24a8,'drawCount':_0x3d8ae3,'newDrawCount':_0x211be9+_0x5af6ba,'orderCount':_0x24844f,'newOrderCount':_0x50efae};}async['getChatStatistic']({days:days=0x7}){const _0x441940=_0x1926ec,_0x4b1290=await this[_0x441940(0x90)](days),_0x46b70f=await this[_0x441940(0xb5)](days),_0x2a7da3=await this[_0x441940(0x9e)](days);return{'date':_0x4b1290[_0x441940(0x75)](_0x119d4f=>_0x119d4f['date']),'chat':_0x4b1290[_0x441940(0x75)](_0x542c5f=>_0x542c5f[_0x441940(0xcd)]),'draw':_0x46b70f['map']((_0x4e5173,_0x5cba45)=>{const _0x369985=_0x441940;return _0x4e5173[_0x369985(0xcd)]+_0x2a7da3[_0x5cba45][_0x369985(0xcd)];})};}async[_0x1926ec(0xd8)]({days:days=0x7}){const _0x57ee6b=await this['getBaiduStatistics'](days);return _0x57ee6b;}async[_0x1926ec(0xe2)](){const _0x2b1582=_0x1926ec,_0x19f35f=await this[_0x2b1582(0xae)][_0x2b1582(0xcf)]();return _0x19f35f;}async[_0x1926ec(0xdd)](){const _0x888371=_0x1926ec,_0x519b50=new Date();_0x519b50[_0x888371(0xb0)](0x0,0x0,0x0,0x0);const _0x2f990c=new Date(_0x519b50['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x21c560=this[_0x888371(0xae)]['createQueryBuilder'](_0x888371(0x80)),_0x28298b=await _0x21c560[_0x888371(0xcc)](_0x888371(0xc1),{'today':_0x519b50})[_0x888371(0xa4)](_0x888371(0x7c),{'tomorrow':_0x2f990c})['getCount']();return _0x28298b;}async[_0x1926ec(0x78)](){const _0x2c1fd6=_0x1926ec,_0x148181=await this[_0x2c1fd6(0xd9)]['count']({'where':{'type':balance_constant_1[_0x2c1fd6(0xc9)][_0x2c1fd6(0xb1)]}});return _0x148181;}async[_0x1926ec(0xbb)](){const _0x196ca2=_0x1926ec,_0x2dbe37=new Date();_0x2dbe37['setHours'](0x0,0x0,0x0,0x0);const _0x47d6ad=new Date(_0x2dbe37['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x3553ef=this[_0x196ca2(0xd9)][_0x196ca2(0x85)]('chatLog'),_0xaf01b1=await _0x3553ef['where'](_0x196ca2(0xa2),{'type':balance_constant_1[_0x196ca2(0xc9)][_0x196ca2(0xb1)]})[_0x196ca2(0xa4)](_0x196ca2(0xc0),{'today':_0x2dbe37})[_0x196ca2(0xa4)](_0x196ca2(0xd0),{'tomorrow':_0x47d6ad})[_0x196ca2(0xc3)]();return _0xaf01b1;}async[_0x1926ec(0xbd)](){const _0x3bfdec=_0x1926ec,_0x414f7c=await this[_0x3bfdec(0xd9)][_0x3bfdec(0xcf)]({'where':{'type':balance_constant_1[_0x3bfdec(0xc9)][_0x3bfdec(0xd3)]}});return _0x414f7c;}async[_0x1926ec(0xc6)](){const _0xb223df=_0x1926ec,_0x39b918=new Date();_0x39b918[_0xb223df(0xb0)](0x0,0x0,0x0,0x0);const _0x56bc64=new Date(_0x39b918[_0xb223df(0x81)]()+0x18*0x3c*0x3c*0x3e8),_0x2b147f=this[_0xb223df(0xd9)]['createQueryBuilder'](_0xb223df(0x8d)),_0x43ed30=await _0x2b147f[_0xb223df(0xcc)](_0xb223df(0xa2),{'type':balance_constant_1[_0xb223df(0xc9)][_0xb223df(0xd3)]})['andWhere'](_0xb223df(0xc0),{'today':_0x39b918})[_0xb223df(0xa4)](_0xb223df(0xd0),{'tomorrow':_0x56bc64})[_0xb223df(0xc3)]();return _0x43ed30;}async['countNewMidhourneysToday'](){const _0x3fcf10=_0x1926ec,_0x33e17c=new Date();_0x33e17c['setHours'](0x0,0x0,0x0,0x0);const _0x138497=new Date(_0x33e17c[_0x3fcf10(0x81)]()+0x18*0x3c*0x3c*0x3e8),_0x2ec7d9=this[_0x3fcf10(0xc2)]['createQueryBuilder'](_0x3fcf10(0xc8)),_0x5af480=await _0x2ec7d9[_0x3fcf10(0xcc)](_0x3fcf10(0x82),{'today':_0x33e17c})['andWhere'](_0x3fcf10(0xc5),{'tomorrow':_0x138497})[_0x3fcf10(0xc3)]();return _0x5af480;}async[_0x1926ec(0x90)](_0x29a75d){const _0x55ddb8=_0x1926ec;var _0xdcd196,_0x8abc56;const _0xb87563=new Date();_0xb87563[_0x55ddb8(0xb0)](0x0,0x0,0x0,0x0);const _0x5eedf6=new Date(_0xb87563[_0x55ddb8(0x81)]()-(_0x29a75d-0x1)*0x18*0x3c*0x3c*0x3e8),_0x32d6a3=this[_0x55ddb8(0xd9)][_0x55ddb8(0x85)](_0x55ddb8(0x84)),_0x12bede=await _0x32d6a3[_0x55ddb8(0x8e)](_0x55ddb8(0x88))[_0x55ddb8(0xcc)](_0x55ddb8(0xd7),{'type':balance_constant_1[_0x55ddb8(0xc9)][_0x55ddb8(0xb1)]})[_0x55ddb8(0xa4)](_0x55ddb8(0xba),{'startDate':_0x5eedf6})['groupBy']('date')['orderBy'](_0x55ddb8(0x7a))['getRawMany'](),_0x1b909d=[],_0x53f98f=_0x5eedf6;for(let _0xafb7a7=0x0;_0xafb7a7<_0x29a75d;_0xafb7a7++){const _0x1fa53d=(0x0,date_1[_0x55ddb8(0xb7)])(new Date(_0x53f98f),_0x55ddb8(0xa3)),_0x504365=(_0x8abc56=(_0xdcd196=_0x12bede[_0x55ddb8(0xbc)](_0x3b71b6=>(0x0,date_1[_0x55ddb8(0xb7)])(new Date(_0x3b71b6[_0x55ddb8(0x7a)]),_0x55ddb8(0xa3))===_0x1fa53d))===null||_0xdcd196===void 0x0?void 0x0:_0xdcd196[_0x55ddb8(0xcf)])!==null&&_0x8abc56!==void 0x0?_0x8abc56:0x0;_0x504365>0x0?_0x1b909d[_0x55ddb8(0xa9)]({'date':_0x1fa53d,'value':Number(_0x504365)}):_0x1b909d[_0x55ddb8(0xa9)]({'date':_0x1fa53d,'value':0x0}),_0x53f98f[_0x55ddb8(0xb2)](_0x53f98f[_0x55ddb8(0xe1)]()+0x1);}return _0x1b909d;}async['countDrawsByTimeRange'](_0xd82a6e){const _0x11042f=_0x1926ec;var _0x42e77a,_0x17c8b2;const _0x3841d3=new Date();_0x3841d3['setHours'](0x0,0x0,0x0,0x0);const _0x23caf7=new Date(_0x3841d3['getTime']()-(_0xd82a6e-0x1)*0x18*0x3c*0x3c*0x3e8),_0x35ad62=this[_0x11042f(0xd9)][_0x11042f(0x85)](_0x11042f(0x84)),_0x68bfe5=await _0x35ad62[_0x11042f(0x8e)](_0x11042f(0x88))[_0x11042f(0xcc)](_0x11042f(0xd7),{'type':balance_constant_1[_0x11042f(0xc9)]['PAINT_TYPE']})[_0x11042f(0xa4)]('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x23caf7})[_0x11042f(0xd1)](_0x11042f(0x7a))['orderBy'](_0x11042f(0x7a))[_0x11042f(0x7b)](),_0x2c0dd7=[],_0x4f1dcd=_0x23caf7;for(let _0x589d2d=0x0;_0x589d2d<_0xd82a6e;_0x589d2d++){const _0x10e800=(0x0,date_1[_0x11042f(0xb7)])(new Date(_0x4f1dcd),_0x11042f(0xa3)),_0x1aded7=(_0x17c8b2=(_0x42e77a=_0x68bfe5[_0x11042f(0xbc)](_0xa275ab=>(0x0,date_1['formatDate'])(new Date(_0xa275ab['date']),_0x11042f(0xa3))===_0x10e800))===null||_0x42e77a===void 0x0?void 0x0:_0x42e77a[_0x11042f(0xcf)])!==null&&_0x17c8b2!==void 0x0?_0x17c8b2:0x0;_0x1aded7>0x0?_0x2c0dd7[_0x11042f(0xa9)]({'date':_0x10e800,'value':Number(_0x1aded7)}):_0x2c0dd7[_0x11042f(0xa9)]({'date':_0x10e800,'value':0x0}),_0x4f1dcd[_0x11042f(0xb2)](_0x4f1dcd[_0x11042f(0xe1)]()+0x1);}return _0x2c0dd7;}async[_0x1926ec(0x9e)](_0x923f8f){const _0x47ab51=_0x1926ec;var _0x978b57,_0x533f27;const _0x403c4d=new Date();_0x403c4d[_0x47ab51(0xb0)](0x0,0x0,0x0,0x0);const _0x54251a=new Date(_0x403c4d['getTime']()-(_0x923f8f-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2cdf8f=this['midjourneyEntity'][_0x47ab51(0x85)](_0x47ab51(0xc8)),_0x1571e7=await _0x2cdf8f[_0x47ab51(0x8e)](_0x47ab51(0xbf))[_0x47ab51(0xcc)](_0x47ab51(0x8f),{'status':midjourney_constant_1[_0x47ab51(0x7f)]['DRAWED']})[_0x47ab51(0xa4)](_0x47ab51(0x8b),{'startDate':_0x54251a})[_0x47ab51(0xd1)](_0x47ab51(0x7a))[_0x47ab51(0x93)](_0x47ab51(0x7a))[_0x47ab51(0x7b)](),_0x775ee5=[],_0x1f9d1a=_0x54251a;for(let _0xbe683d=0x0;_0xbe683d<_0x923f8f;_0xbe683d++){const _0x8739d5=(0x0,date_1[_0x47ab51(0xb7)])(new Date(_0x1f9d1a),_0x47ab51(0xa3)),_0x2e90e3=(_0x533f27=(_0x978b57=_0x1571e7[_0x47ab51(0xbc)](_0x6f56fe=>(0x0,date_1['formatDate'])(new Date(_0x6f56fe[_0x47ab51(0x7a)]),'M.DD')===_0x8739d5))===null||_0x978b57===void 0x0?void 0x0:_0x978b57[_0x47ab51(0xcf)])!==null&&_0x533f27!==void 0x0?_0x533f27:0x0;_0x2e90e3>0x0?_0x775ee5['push']({'date':_0x8739d5,'value':Number(_0x2e90e3)}):_0x775ee5[_0x47ab51(0xa9)]({'date':_0x8739d5,'value':0x0}),_0x1f9d1a['setDate'](_0x1f9d1a[_0x47ab51(0xe1)]()+0x1);}return _0x775ee5;}async[_0x1926ec(0x79)](_0x5d9d3b){const _0xc02a5=_0x1926ec;var _0x55f1e9,_0x5bc566;const _0x1b0bda=(0x0,date_1[_0xc02a5(0xb7)])(new Date(),_0xc02a5(0x72)),_0x312a74=(0x0,date_1[_0xc02a5(0xb7)])(new Date(Date['now']()-Number(_0x5d9d3b-0x1)*0x18*0x3c*0x3c*0x3e8),_0xc02a5(0x72)),_0x51223a=_0xc02a5(0xdc),_0x82f1c1='overview/getTimeTrendRpt',_0x28cf20=await this[_0xc02a5(0x8a)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0xc02a5(0xad),_0xc02a5(0xda)])}}),_0x4e5acc=(_0x55f1e9=_0x28cf20['find'](_0x2a4abb=>_0x2a4abb['configKey']===_0xc02a5(0xda)))===null||_0x55f1e9===void 0x0?void 0x0:_0x55f1e9[_0xc02a5(0xb6)],_0x30c142=(_0x5bc566=_0x28cf20[_0xc02a5(0xbc)](_0x435e93=>_0x435e93[_0xc02a5(0x9f)]==='baiduToken'))===null||_0x5bc566===void 0x0?void 0x0:_0x5bc566[_0xc02a5(0xb6)];if(!_0x4e5acc||!_0x30c142)return[];if(!_0x4e5acc)throw new common_1[(_0xc02a5(0x76))]('请先配置百度统计siteId',common_1[_0xc02a5(0xa0)][_0xc02a5(0x98)]);if(!_0x30c142)throw new common_1[(_0xc02a5(0x76))]('请先配置百度统计accessToken',common_1['HttpStatus']['BAD_REQUEST']);const _0x46c110=_0xc02a5(0x83)+_0x30c142+_0xc02a5(0x87)+_0x4e5acc+_0xc02a5(0xac)+_0x82f1c1+_0xc02a5(0xca)+_0x312a74+_0xc02a5(0xb3)+_0x1b0bda+_0xc02a5(0x8c)+_0x51223a,_0x4ef277=await axios_1[_0xc02a5(0xbe)]['get'](_0x46c110),{error_code:_0x114b24,message:_0x5bdb97}=_0x4ef277[_0xc02a5(0x9b)];if(_0x114b24===0x6f)throw new common_1[(_0xc02a5(0x76))](_0x5bdb97||'百度授权码过期',common_1[_0xc02a5(0xa0)][_0xc02a5(0x98)]);if(_0x114b24&&_0x114b24!==0xc8)throw new common_1[(_0xc02a5(0x76))](_0x5bdb97||_0xc02a5(0xb9),common_1[_0xc02a5(0xa0)]['BAD_REQUEST']);return _0x4ef277[_0xc02a5(0x9b)]['result'];}async['countOrders'](){const _0x590db9=_0x1926ec,_0x258562=await this[_0x590db9(0x99)][_0x590db9(0xcf)]();return _0x258562;}async['countNewOrdersToday'](){const _0x2e938a=_0x1926ec,_0x2b5d44=new Date();_0x2b5d44[_0x2e938a(0xb0)](0x0,0x0,0x0,0x0);const _0x2fb3b8=new Date(_0x2b5d44[_0x2e938a(0x81)]()+0x18*0x3c*0x3c*0x3e8),_0x2cd1fd=this[_0x2e938a(0x99)]['createQueryBuilder']('order'),_0x51137c=await _0x2cd1fd['where'](_0x2e938a(0x7e),{'today':_0x2b5d44})[_0x2e938a(0xa4)](_0x2e938a(0x7d),{'tomorrow':_0x2fb3b8})['getCount']();return _0x51137c;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1926ec(0x91)])(user_entity_1[_0x1926ec(0x96)])),__param(0x1,(0x0,typeorm_1[_0x1926ec(0x91)])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x1926ec(0x91)])(order_entity_1[_0x1926ec(0x9a)])),__param(0x4,(0x0,typeorm_1[_0x1926ec(0x91)])(midjourney_entity_1[_0x1926ec(0xde)])),__metadata(_0x1926ec(0x97),[typeorm_2['Repository'],typeorm_2[_0x1926ec(0xa6)],typeorm_2[_0x1926ec(0xa6)],typeorm_2[_0x1926ec(0xa6)],typeorm_2[_0x1926ec(0xa6)]])],StatisticService),exports[_0x1926ec(0xa7)]=StatisticService;