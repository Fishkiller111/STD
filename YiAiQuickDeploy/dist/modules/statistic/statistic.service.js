'use strict';function _0x33cf(){const _0x1a6e87=['typeorm','getOwnPropertyDescriptor','百度授权码过期','@nestjs/typeorm','countDraws','baiduToken','countNewOrdersToday','select','object','configKey','../../common/constants/balance.constant','result','now','setHours','chatlog.type\x20=\x20:type','CHAT_TYPE','user','countOrders','midjourney.status\x20=\x20:status','order.createdAt\x20<\x20:tomorrow','setDate','424415wMlDya','getBaiduVisit','获取百度统计数据失败','DRAWED','../globalConfig/config.entity','data','countDrawsByTimeRange','countChats','count','../../common/utils/date','value','60232QsUINi','BAD_REQUEST','getRawMany','where','midjourney.createdAt\x20<\x20:tomorrow','../../common/constants/midjourney.constant','orderBy','../user/user.entity','chatlog.createdAt\x20>=\x20:startDate','push','chatLog.createdAt\x20>=\x20:today','countNewUsersToday','user.createdAt\x20<\x20:tomorrow','date','design:paramtypes','default','chatlog','chatLog','请先配置百度统计siteId','order','../order/order.entity','OrderEntity','&site_id=','countUsers','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','3849630psMOkq','162yIKUEM','createQueryBuilder','andWhere','defineProperty','DeductionKey','&start_date=','InjectRepository','getBaseStatistic','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','length','midjourney','&method=','710090JjgHDD','9193752IBFVpQ','configVal','formatDate','getTime','&metrics=','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','__decorate','MidjourneyEntity','midjourney.createdAt\x20>=\x20:startDate','YYYYMMDD','getChatStatistic','476WyBQXi','UserEntity','countNewMidhourneysToday','map','21268xuDQSS','find','countChatsByTimeRange','baiduSiteId','order.createdAt\x20>=\x20:today','../midjourney/midjourney.entity','getDate','midjourneyEntity','countMjDrawsByTimeRange','getBaiduStatistics','midjourney.createdAt\x20>=\x20:today','MidjourneyStatusEnum','groupBy','user.createdAt\x20>=\x20:today','StatisticService','Repository','M.DD','metadata','@nestjs/common','__metadata','HttpStatus','get','PAINT_TYPE','393885ddPglL','function','decorate','countNewChatsToday','orderEntity','getCount','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','chatLogEntity','countNewDrawsToday','HttpException'];_0x33cf=function(){return _0x1a6e87;};return _0x33cf();}const _0x6654c9=_0x1cd5;(function(_0x14d455,_0x1028a6){const _0x52e14e=_0x1cd5,_0x13fae0=_0x14d455();while(!![]){try{const _0x3ca18d=parseInt(_0x52e14e(0xd5))/0x1+-parseInt(_0x52e14e(0x106))/0x2+parseInt(_0x52e14e(0xfa))/0x3*(parseInt(_0x52e14e(0x116))/0x4)+-parseInt(_0x52e14e(0xb6))/0x5+parseInt(_0x52e14e(0xf9))/0x6+-parseInt(_0x52e14e(0x112))/0x7*(-parseInt(_0x52e14e(0xe0))/0x8)+-parseInt(_0x52e14e(0x107))/0x9;if(_0x3ca18d===_0x1028a6)break;else _0x13fae0['push'](_0x13fae0['shift']());}catch(_0x5b480b){_0x13fae0['push'](_0x13fae0['shift']());}}}(_0x33cf,0x640a0));function _0x1cd5(_0x83544,_0x56e8f2){const _0x33cf89=_0x33cf();return _0x1cd5=function(_0x1cd5dd,_0x12aee2){_0x1cd5dd=_0x1cd5dd-0xb6;let _0x2fad0f=_0x33cf89[_0x1cd5dd];return _0x2fad0f;},_0x1cd5(_0x83544,_0x56e8f2);}var __decorate=this&&this[_0x6654c9(0x10d)]||function(_0x2c5ba9,_0x262ae5,_0x147b05,_0x56d983){const _0xf53526=_0x6654c9;var _0x564ccc=arguments['length'],_0x53c1e3=_0x564ccc<0x3?_0x262ae5:_0x56d983===null?_0x56d983=Object[_0xf53526(0xc1)](_0x262ae5,_0x147b05):_0x56d983,_0x8c9336;if(typeof Reflect===_0xf53526(0xc8)&&typeof Reflect[_0xf53526(0xb8)]==='function')_0x53c1e3=Reflect[_0xf53526(0xb8)](_0x2c5ba9,_0x262ae5,_0x147b05,_0x56d983);else{for(var _0x34909b=_0x2c5ba9[_0xf53526(0x103)]-0x1;_0x34909b>=0x0;_0x34909b--)if(_0x8c9336=_0x2c5ba9[_0x34909b])_0x53c1e3=(_0x564ccc<0x3?_0x8c9336(_0x53c1e3):_0x564ccc>0x3?_0x8c9336(_0x262ae5,_0x147b05,_0x53c1e3):_0x8c9336(_0x262ae5,_0x147b05))||_0x53c1e3;}return _0x564ccc>0x3&&_0x53c1e3&&Object['defineProperty'](_0x262ae5,_0x147b05,_0x53c1e3),_0x53c1e3;},__metadata=this&&this[_0x6654c9(0x129)]||function(_0x7473a7,_0x4d40f6){const _0x8eb2fd=_0x6654c9;if(typeof Reflect===_0x8eb2fd(0xc8)&&typeof Reflect['metadata']===_0x8eb2fd(0xb7))return Reflect[_0x8eb2fd(0x127)](_0x7473a7,_0x4d40f6);},__param=this&&this['__param']||function(_0x577346,_0x8f7412){return function(_0x42aded,_0x5ac394){_0x8f7412(_0x42aded,_0x5ac394,_0x577346);};};Object[_0x6654c9(0xfd)](exports,'__esModule',{'value':!![]}),exports[_0x6654c9(0x124)]=void 0x0;const common_1=require(_0x6654c9(0x128)),typeorm_1=require(_0x6654c9(0xc3)),user_entity_1=require(_0x6654c9(0xe7)),typeorm_2=require(_0x6654c9(0xc0)),chatLog_entity_1=require('../chatLog/chatLog.entity'),balance_constant_1=require(_0x6654c9(0xca)),date_1=require(_0x6654c9(0xde)),axios_1=require('axios'),config_entity_1=require(_0x6654c9(0xd9)),order_entity_1=require(_0x6654c9(0xf4)),midjourney_entity_1=require(_0x6654c9(0x11b)),midjourney_constant_1=require(_0x6654c9(0xe5));let StatisticService=class StatisticService{constructor(_0x248792,_0x2971f8,_0x536c90,_0x3ba492,_0x21bc74){const _0x2b4b40=_0x6654c9;this['userEntity']=_0x248792,this[_0x2b4b40(0xbd)]=_0x2971f8,this['configEntity']=_0x536c90,this['orderEntity']=_0x3ba492,this[_0x2b4b40(0x11d)]=_0x21bc74;}async[_0x6654c9(0x101)](){const _0x554cc7=_0x6654c9,_0x1a1a4a=await this[_0x554cc7(0xf7)](),_0x3e8703=await this[_0x554cc7(0xeb)](),_0x3075fd=await this['countChats'](),_0x3e792f=await this['countNewChatsToday'](),_0x4d9a66=await this[_0x554cc7(0xc4)](),_0x171a7a=await this[_0x554cc7(0xbe)](),_0x270666=await this[_0x554cc7(0x114)](),_0x345bc2=await this[_0x554cc7(0xd1)](),_0x45f9f5=await this[_0x554cc7(0xc6)]();return{'userCount':_0x1a1a4a,'newUserCount':_0x3e8703,'chatCount':_0x3075fd,'newChatCount':_0x3e792f,'drawCount':_0x4d9a66,'newDrawCount':_0x270666+_0x171a7a,'orderCount':_0x345bc2,'newOrderCount':_0x45f9f5};}async[_0x6654c9(0x111)]({days:days=0x7}){const _0xf28014=_0x6654c9,_0x1e6d91=await this['countChatsByTimeRange'](days),_0x24d6cb=await this[_0xf28014(0xdb)](days),_0x38aa29=await this[_0xf28014(0x11e)](days);return{'date':_0x1e6d91[_0xf28014(0x115)](_0x11c54e=>_0x11c54e[_0xf28014(0xed)]),'chat':_0x1e6d91[_0xf28014(0x115)](_0x32632e=>_0x32632e[_0xf28014(0xdf)]),'draw':_0x24d6cb[_0xf28014(0x115)]((_0x21a2d8,_0x2eb7f6)=>{const _0x37f80a=_0xf28014;return _0x21a2d8[_0x37f80a(0xdf)]+_0x38aa29[_0x2eb7f6][_0x37f80a(0xdf)];})};}async[_0x6654c9(0xd6)]({days:days=0x7}){const _0x164059=_0x6654c9,_0x278dbf=await this[_0x164059(0x11f)](days);return _0x278dbf;}async[_0x6654c9(0xf7)](){const _0x34d5c3=_0x6654c9,_0x386d27=await this['userEntity'][_0x34d5c3(0xdd)]();return _0x386d27;}async[_0x6654c9(0xeb)](){const _0x2adcd5=_0x6654c9,_0x59ec82=new Date();_0x59ec82['setHours'](0x0,0x0,0x0,0x0);const _0x41869b=new Date(_0x59ec82['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x4bd0f9=this['userEntity']['createQueryBuilder'](_0x2adcd5(0xd0)),_0x338adf=await _0x4bd0f9[_0x2adcd5(0xe3)](_0x2adcd5(0x123),{'today':_0x59ec82})[_0x2adcd5(0xfc)](_0x2adcd5(0xec),{'tomorrow':_0x41869b})['getCount']();return _0x338adf;}async[_0x6654c9(0xdc)](){const _0x5031ee=_0x6654c9,_0x3328da=await this[_0x5031ee(0xbd)][_0x5031ee(0xdd)]({'where':{'type':balance_constant_1[_0x5031ee(0xfe)][_0x5031ee(0xcf)]}});return _0x3328da;}async[_0x6654c9(0xb9)](){const _0x75f890=_0x6654c9,_0x4f3ad6=new Date();_0x4f3ad6['setHours'](0x0,0x0,0x0,0x0);const _0x2436f4=new Date(_0x4f3ad6[_0x75f890(0x10a)]()+0x18*0x3c*0x3c*0x3e8),_0x3c6837=this['chatLogEntity'][_0x75f890(0xfb)](_0x75f890(0xf1)),_0x5700be=await _0x3c6837[_0x75f890(0xe3)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1['DeductionKey'][_0x75f890(0xcf)]})['andWhere'](_0x75f890(0xea),{'today':_0x4f3ad6})[_0x75f890(0xfc)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x2436f4})['getCount']();return _0x5700be;}async[_0x6654c9(0xc4)](){const _0xf109a2=_0x6654c9,_0x756ec=await this[_0xf109a2(0xbd)][_0xf109a2(0xdd)]({'where':{'type':balance_constant_1[_0xf109a2(0xfe)][_0xf109a2(0x12c)]}});return _0x756ec;}async[_0x6654c9(0xbe)](){const _0x225962=_0x6654c9,_0x34abb8=new Date();_0x34abb8['setHours'](0x0,0x0,0x0,0x0);const _0x12c2ee=new Date(_0x34abb8[_0x225962(0x10a)]()+0x18*0x3c*0x3c*0x3e8),_0x389713=this[_0x225962(0xbd)][_0x225962(0xfb)](_0x225962(0xf1)),_0x556f7d=await _0x389713[_0x225962(0xe3)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x225962(0xfe)][_0x225962(0x12c)]})[_0x225962(0xfc)](_0x225962(0xea),{'today':_0x34abb8})[_0x225962(0xfc)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x12c2ee})[_0x225962(0xbb)]();return _0x556f7d;}async[_0x6654c9(0x114)](){const _0xef7f=_0x6654c9,_0x5f3666=new Date();_0x5f3666['setHours'](0x0,0x0,0x0,0x0);const _0x41b72a=new Date(_0x5f3666[_0xef7f(0x10a)]()+0x18*0x3c*0x3c*0x3e8),_0x4c8eb1=this['midjourneyEntity']['createQueryBuilder'](_0xef7f(0x104)),_0x4e819a=await _0x4c8eb1[_0xef7f(0xe3)](_0xef7f(0x120),{'today':_0x5f3666})[_0xef7f(0xfc)](_0xef7f(0xe4),{'tomorrow':_0x41b72a})[_0xef7f(0xbb)]();return _0x4e819a;}async[_0x6654c9(0x118)](_0x3ce888){const _0x426114=_0x6654c9;var _0x2edc51,_0x277427;const _0x1aead7=new Date();_0x1aead7[_0x426114(0xcd)](0x0,0x0,0x0,0x0);const _0x57a2d4=new Date(_0x1aead7[_0x426114(0x10a)]()-(_0x3ce888-0x1)*0x18*0x3c*0x3c*0x3e8),_0x40ce49=this['chatLogEntity'][_0x426114(0xfb)](_0x426114(0xf0)),_0x152928=await _0x40ce49['select'](_0x426114(0xf8))[_0x426114(0xe3)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x426114(0xfe)][_0x426114(0xcf)]})['andWhere'](_0x426114(0xe8),{'startDate':_0x57a2d4})[_0x426114(0x122)](_0x426114(0xed))[_0x426114(0xe6)]('date')[_0x426114(0xe2)](),_0x36fffe=[],_0x81f318=_0x57a2d4;for(let _0x4356b2=0x0;_0x4356b2<_0x3ce888;_0x4356b2++){const _0x2c43e9=(0x0,date_1[_0x426114(0x109)])(new Date(_0x81f318),_0x426114(0x126)),_0x5dd927=(_0x277427=(_0x2edc51=_0x152928[_0x426114(0x117)](_0x251008=>(0x0,date_1[_0x426114(0x109)])(new Date(_0x251008[_0x426114(0xed)]),_0x426114(0x126))===_0x2c43e9))===null||_0x2edc51===void 0x0?void 0x0:_0x2edc51[_0x426114(0xdd)])!==null&&_0x277427!==void 0x0?_0x277427:0x0;_0x5dd927>0x0?_0x36fffe[_0x426114(0xe9)]({'date':_0x2c43e9,'value':Number(_0x5dd927)}):_0x36fffe[_0x426114(0xe9)]({'date':_0x2c43e9,'value':0x0}),_0x81f318[_0x426114(0xd4)](_0x81f318[_0x426114(0x11c)]()+0x1);}return _0x36fffe;}async[_0x6654c9(0xdb)](_0x31edca){const _0x21d79e=_0x6654c9;var _0xcc50a9,_0x415f29;const _0x6385df=new Date();_0x6385df['setHours'](0x0,0x0,0x0,0x0);const _0x1ae1c2=new Date(_0x6385df['getTime']()-(_0x31edca-0x1)*0x18*0x3c*0x3c*0x3e8),_0x61f899=this[_0x21d79e(0xbd)]['createQueryBuilder'](_0x21d79e(0xf0)),_0x5ea5eb=await _0x61f899[_0x21d79e(0xc7)](_0x21d79e(0xf8))[_0x21d79e(0xe3)](_0x21d79e(0xce),{'type':balance_constant_1['DeductionKey'][_0x21d79e(0x12c)]})[_0x21d79e(0xfc)](_0x21d79e(0xe8),{'startDate':_0x1ae1c2})[_0x21d79e(0x122)]('date')[_0x21d79e(0xe6)](_0x21d79e(0xed))[_0x21d79e(0xe2)](),_0x4385d3=[],_0x244888=_0x1ae1c2;for(let _0x2a21cb=0x0;_0x2a21cb<_0x31edca;_0x2a21cb++){const _0x5a6fa4=(0x0,date_1[_0x21d79e(0x109)])(new Date(_0x244888),_0x21d79e(0x126)),_0x4156bd=(_0x415f29=(_0xcc50a9=_0x5ea5eb[_0x21d79e(0x117)](_0x2f4520=>(0x0,date_1[_0x21d79e(0x109)])(new Date(_0x2f4520[_0x21d79e(0xed)]),_0x21d79e(0x126))===_0x5a6fa4))===null||_0xcc50a9===void 0x0?void 0x0:_0xcc50a9[_0x21d79e(0xdd)])!==null&&_0x415f29!==void 0x0?_0x415f29:0x0;_0x4156bd>0x0?_0x4385d3['push']({'date':_0x5a6fa4,'value':Number(_0x4156bd)}):_0x4385d3['push']({'date':_0x5a6fa4,'value':0x0}),_0x244888[_0x21d79e(0xd4)](_0x244888[_0x21d79e(0x11c)]()+0x1);}return _0x4385d3;}async[_0x6654c9(0x11e)](_0x36d052){const _0x176106=_0x6654c9;var _0x352e11,_0x3cb684;const _0xe0596e=new Date();_0xe0596e[_0x176106(0xcd)](0x0,0x0,0x0,0x0);const _0x239177=new Date(_0xe0596e[_0x176106(0x10a)]()-(_0x36d052-0x1)*0x18*0x3c*0x3c*0x3e8),_0x42ea14=this[_0x176106(0x11d)]['createQueryBuilder']('midjourney'),_0x42eae8=await _0x42ea14[_0x176106(0xc7)](_0x176106(0xbc))[_0x176106(0xe3)](_0x176106(0xd2),{'status':midjourney_constant_1[_0x176106(0x121)][_0x176106(0xd8)]})['andWhere'](_0x176106(0x10f),{'startDate':_0x239177})[_0x176106(0x122)](_0x176106(0xed))['orderBy'](_0x176106(0xed))[_0x176106(0xe2)](),_0x4c27f2=[],_0x4fa484=_0x239177;for(let _0x122ccf=0x0;_0x122ccf<_0x36d052;_0x122ccf++){const _0x3fab59=(0x0,date_1[_0x176106(0x109)])(new Date(_0x4fa484),_0x176106(0x126)),_0x40af51=(_0x3cb684=(_0x352e11=_0x42eae8[_0x176106(0x117)](_0x33f256=>(0x0,date_1[_0x176106(0x109)])(new Date(_0x33f256[_0x176106(0xed)]),_0x176106(0x126))===_0x3fab59))===null||_0x352e11===void 0x0?void 0x0:_0x352e11['count'])!==null&&_0x3cb684!==void 0x0?_0x3cb684:0x0;_0x40af51>0x0?_0x4c27f2['push']({'date':_0x3fab59,'value':Number(_0x40af51)}):_0x4c27f2['push']({'date':_0x3fab59,'value':0x0}),_0x4fa484[_0x176106(0xd4)](_0x4fa484['getDate']()+0x1);}return _0x4c27f2;}async[_0x6654c9(0x11f)](_0x52f235){const _0x1f3ddf=_0x6654c9;var _0x3667b0,_0x3fbf61;const _0x1072cf=(0x0,date_1[_0x1f3ddf(0x109)])(new Date(),'YYYYMMDD'),_0x556ece=(0x0,date_1[_0x1f3ddf(0x109)])(new Date(Date[_0x1f3ddf(0xcc)]()-Number(_0x52f235-0x1)*0x18*0x3c*0x3c*0x3e8),_0x1f3ddf(0x110)),_0x5abd7c=_0x1f3ddf(0x102),_0x30ca86='overview/getTimeTrendRpt',_0x4bbe83=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x1f3ddf(0xc5),_0x1f3ddf(0x119)])}}),_0x20457c=(_0x3667b0=_0x4bbe83['find'](_0x13d134=>_0x13d134['configKey']===_0x1f3ddf(0x119)))===null||_0x3667b0===void 0x0?void 0x0:_0x3667b0[_0x1f3ddf(0x108)],_0x19c51c=(_0x3fbf61=_0x4bbe83['find'](_0x4df9d6=>_0x4df9d6[_0x1f3ddf(0xc9)]==='baiduToken'))===null||_0x3fbf61===void 0x0?void 0x0:_0x3fbf61['configVal'];if(!_0x20457c||!_0x19c51c)return[];if(!_0x20457c)throw new common_1[(_0x1f3ddf(0xbf))](_0x1f3ddf(0xf2),common_1['HttpStatus'][_0x1f3ddf(0xe1)]);if(!_0x19c51c)throw new common_1['HttpException']('请先配置百度统计accessToken',common_1['HttpStatus'][_0x1f3ddf(0xe1)]);const _0x3cb5a6=_0x1f3ddf(0x10c)+_0x19c51c+_0x1f3ddf(0xf6)+_0x20457c+_0x1f3ddf(0x105)+_0x30ca86+_0x1f3ddf(0xff)+_0x556ece+'&end_date='+_0x1072cf+_0x1f3ddf(0x10b)+_0x5abd7c,_0x3b1c46=await axios_1[_0x1f3ddf(0xef)][_0x1f3ddf(0x12b)](_0x3cb5a6),{error_code:_0x473a3c,message:_0x234468}=_0x3b1c46[_0x1f3ddf(0xda)];if(_0x473a3c===0x6f)throw new common_1['HttpException'](_0x234468||_0x1f3ddf(0xc2),common_1[_0x1f3ddf(0x12a)][_0x1f3ddf(0xe1)]);if(_0x473a3c&&_0x473a3c!==0xc8)throw new common_1[(_0x1f3ddf(0xbf))](_0x234468||_0x1f3ddf(0xd7),common_1['HttpStatus'][_0x1f3ddf(0xe1)]);return _0x3b1c46['data'][_0x1f3ddf(0xcb)];}async['countOrders'](){const _0x5dfc7e=_0x6654c9,_0x3c4eac=await this[_0x5dfc7e(0xba)]['count']();return _0x3c4eac;}async[_0x6654c9(0xc6)](){const _0x411a49=_0x6654c9,_0x13485c=new Date();_0x13485c['setHours'](0x0,0x0,0x0,0x0);const _0x46eb60=new Date(_0x13485c[_0x411a49(0x10a)]()+0x18*0x3c*0x3c*0x3e8),_0x17dbee=this[_0x411a49(0xba)][_0x411a49(0xfb)](_0x411a49(0xf3)),_0x13d6a5=await _0x17dbee[_0x411a49(0xe3)](_0x411a49(0x11a),{'today':_0x13485c})[_0x411a49(0xfc)](_0x411a49(0xd3),{'tomorrow':_0x46eb60})[_0x411a49(0xbb)]();return _0x13d6a5;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x6654c9(0x100)])(user_entity_1[_0x6654c9(0x113)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x6654c9(0x100)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_1[_0x6654c9(0x100)])(order_entity_1[_0x6654c9(0xf5)])),__param(0x4,(0x0,typeorm_1[_0x6654c9(0x100)])(midjourney_entity_1[_0x6654c9(0x10e)])),__metadata(_0x6654c9(0xee),[typeorm_2[_0x6654c9(0x125)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x6654c9(0x125)],typeorm_2[_0x6654c9(0x125)]])],StatisticService),exports['StatisticService']=StatisticService;