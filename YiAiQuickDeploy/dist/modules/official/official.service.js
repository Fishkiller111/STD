'use strict';const _0x402667=_0x77c5;(function(_0x83e65f,_0x4e6fea){const _0x2f01e5=_0x77c5,_0x3399af=_0x83e65f();while(!![]){try{const _0x3234c2=parseInt(_0x2f01e5(0x218))/0x1*(parseInt(_0x2f01e5(0x1d8))/0x2)+parseInt(_0x2f01e5(0x201))/0x3+-parseInt(_0x2f01e5(0x20f))/0x4*(parseInt(_0x2f01e5(0x225))/0x5)+parseInt(_0x2f01e5(0x22a))/0x6*(parseInt(_0x2f01e5(0x220))/0x7)+parseInt(_0x2f01e5(0x222))/0x8*(parseInt(_0x2f01e5(0x1f7))/0x9)+-parseInt(_0x2f01e5(0x209))/0xa*(parseInt(_0x2f01e5(0x228))/0xb)+parseInt(_0x2f01e5(0x229))/0xc;if(_0x3234c2===_0x4e6fea)break;else _0x3399af['push'](_0x3399af['shift']());}catch(_0x438f66){_0x3399af['push'](_0x3399af['shift']());}}}(_0x1c3b,0x870cf));var __decorate=this&&this[_0x402667(0x1ed)]||function(_0x1b5519,_0x5ac40a,_0x2db124,_0x472901){const _0x345ccf=_0x402667;var _0x2bde11=arguments['length'],_0x4ef118=_0x2bde11<0x3?_0x5ac40a:_0x472901===null?_0x472901=Object[_0x345ccf(0x226)](_0x5ac40a,_0x2db124):_0x472901,_0x341bf9;if(typeof Reflect==='object'&&typeof Reflect[_0x345ccf(0x1e7)]===_0x345ccf(0x1e2))_0x4ef118=Reflect[_0x345ccf(0x1e7)](_0x1b5519,_0x5ac40a,_0x2db124,_0x472901);else{for(var _0x42843f=_0x1b5519[_0x345ccf(0x221)]-0x1;_0x42843f>=0x0;_0x42843f--)if(_0x341bf9=_0x1b5519[_0x42843f])_0x4ef118=(_0x2bde11<0x3?_0x341bf9(_0x4ef118):_0x2bde11>0x3?_0x341bf9(_0x5ac40a,_0x2db124,_0x4ef118):_0x341bf9(_0x5ac40a,_0x2db124))||_0x4ef118;}return _0x2bde11>0x3&&_0x4ef118&&Object[_0x345ccf(0x1e1)](_0x5ac40a,_0x2db124,_0x4ef118),_0x4ef118;},__metadata=this&&this[_0x402667(0x1cf)]||function(_0x20f533,_0x4566aa){const _0x57fd5e=_0x402667;if(typeof Reflect===_0x57fd5e(0x21b)&&typeof Reflect[_0x57fd5e(0x1e5)]===_0x57fd5e(0x1e2))return Reflect[_0x57fd5e(0x1e5)](_0x20f533,_0x4566aa);};function _0x77c5(_0x54c5a2,_0x57f27d){const _0x1c3b0a=_0x1c3b();return _0x77c5=function(_0x77c52f,_0x240211){_0x77c52f=_0x77c52f-0x1cd;let _0x1f96e3=_0x1c3b0a[_0x77c52f];return _0x1f96e3;},_0x77c5(_0x54c5a2,_0x57f27d);}Object[_0x402667(0x1e1)](exports,_0x402667(0x21a),{'value':!![]}),exports['OfficialService']=void 0x0;function _0x1c3b(){const _0x365e78=['genXmlMsgByConfig','../autoreply/autoreply.service','&code=','bindWx','getConfigs','__metadata','非法参数','fromusername','../globalConfig/globalConfig.service','user','officialAutoReplyText','loginByOpenId','scan','now','89966PEIiOL','来自公众号的回复问题\x20=======>\x20超时导致问题无法回答完整','scanBindWx','../auth/auth.service','update','chatgptService','getQRSceneStr','sha1','createHash','defineProperty','function','globalConfigService','Injectable','metadata','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','decorate','sceneStrMap','authService','getUserFromOpenId','split','design:paramtypes','__decorate','aotoPlay','来自公众号的询问问题\x20=======>\x20','../../common/utils','jsapi_ticket=','log','wechatAccessToken','getQRSceneStrByBind','verify','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','9111096MaTATj','loginByCode','axios','@nestjs/common','post','getUserById','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','scanedSceneStrMap','AutoreplyService','../user/user.service','495510HkHfxB','join','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','BAD_REQUEST','wechatOfficialAppId','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','&url=','回跳跳转地址:\x20','10MMDBIF','wechatJsapiTicket','&timestamp=','default','toFixed',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','812mFZkCD','请求超时','userService','getTime','appId:\x20','jsapiTicket:\x20','../chatgpt/chatgpt.service','crypto','AuthService','4zkUHmG','autoreplyService','__esModule','object','bindWxBySceneStr','str:\x20','getJsapiTicket','&secret=','7PeOPiN','length','8shunRv','hex','&noncestr=','14745DYqNBj','getOwnPropertyDescriptor','HttpStatus','11602712DkquAw','2525616kXQPWC','3832152wMjxca','HttpException','loginBySceneStr','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','&redirect_uri=','createRandomNonceStr'];_0x1c3b=function(){return _0x365e78;};return _0x1c3b();}const chatgpt_service_1=require(_0x402667(0x215)),globalConfig_service_1=require(_0x402667(0x1d2)),auth_service_1=require(_0x402667(0x1db)),user_service_1=require(_0x402667(0x200)),autoreply_service_1=require(_0x402667(0x231)),common_1=require(_0x402667(0x1fa)),crypto=require(_0x402667(0x216)),axios_1=require(_0x402667(0x1f9)),utils_1=require(_0x402667(0x1f0));let OfficialService=class OfficialService{constructor(_0x5aa3c5,_0x3d13b7,_0x257d65,_0x3fbfbc,_0x3b550b){const _0x43bb74=_0x402667;this[_0x43bb74(0x219)]=_0x5aa3c5,this[_0x43bb74(0x211)]=_0x3d13b7,this[_0x43bb74(0x1e9)]=_0x257d65,this[_0x43bb74(0x1e3)]=_0x3fbfbc,this[_0x43bb74(0x1dd)]=_0x3b550b,this[_0x43bb74(0x1e8)]={},this[_0x43bb74(0x1fe)]={};}async['onModuleInit'](){const _0x46ecf6=_0x402667;await this[_0x46ecf6(0x1e3)]['getWechatAccessToken'](!![]);}async[_0x402667(0x1de)](_0x3d2397){const _0x485e21=_0x402667,{invitedBy:_0x5127fa}=_0x3d2397;let _0x576387=(0x0,utils_1['createRandomNonceStr'])(0x20);return _0x5127fa&&(_0x576387+=':'+_0x5127fa),this[_0x485e21(0x1e8)][_0x576387]=!![],_0x576387;}async[_0x402667(0x1f4)](_0x57859e){const _0x23cb3e=_0x402667,{id:_0x7cffc6}=_0x57859e[_0x23cb3e(0x1d3)],_0x5e1ecc=(0x0,utils_1[_0x23cb3e(0x22f)])(0x20)+'/'+_0x7cffc6;return this[_0x23cb3e(0x1e8)][_0x5e1ecc]=!![],_0x5e1ecc;}async['getQRCodeTicket'](_0x51103f){return this['fetchQRCodeTicket'](_0x51103f);}async['getRedirectUrl'](_0x1ef882){const _0x4618de=_0x402667,_0x4f43a8=await this[_0x4618de(0x1e3)][_0x4618de(0x1ce)]([_0x4618de(0x205)]),_0x35cb7c=_0x4618de(0x22d)+_0x4f43a8+_0x4618de(0x22e)+encodeURIComponent(_0x1ef882)+_0x4618de(0x1f6);return console[_0x4618de(0x1f2)](_0x4618de(0x208),_0x35cb7c),_0x35cb7c;}async[_0x402667(0x21e)](_0x75bc9d){const _0x1b0c11=_0x402667,_0x3e75c8=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x18e5f8=(Date[_0x1b0c11(0x1d7)]()/0x3e8)[_0x1b0c11(0x20d)](0x0),_0x1f1386=await this[_0x1b0c11(0x1e3)][_0x1b0c11(0x1ce)]([_0x1b0c11(0x20a)]);console[_0x1b0c11(0x1f2)](_0x1b0c11(0x214),_0x1f1386);const _0x38d820=await this[_0x1b0c11(0x1e3)][_0x1b0c11(0x1ce)]([_0x1b0c11(0x205)]);console['log'](_0x1b0c11(0x213),_0x38d820);const _0x471063=_0x1b0c11(0x1f1)+_0x1f1386+_0x1b0c11(0x224)+_0x3e75c8+_0x1b0c11(0x20b)+_0x18e5f8+_0x1b0c11(0x207)+_0x75bc9d;console[_0x1b0c11(0x1f2)](_0x1b0c11(0x21d),_0x471063);const _0x1d61cc=this[_0x1b0c11(0x1df)](_0x471063);return{'appId':_0x38d820,'nonceStr':_0x3e75c8,'timestamp':_0x18e5f8,'signature':_0x1d61cc};}async['fetchQRCodeTicket'](_0x3375b5){const _0x4a8708=_0x402667,_0x4b80ec=await this[_0x4a8708(0x1e3)]['getConfigs']([_0x4a8708(0x1f3)]),_0x1b0ebe={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x3375b5}}},_0xde793e=await axios_1[_0x4a8708(0x20c)][_0x4a8708(0x1fb)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x4b80ec,_0x1b0ebe),{data:{errmsg:_0x9b94bf,ticket:_0xa30c29}}=_0xde793e;if(_0x9b94bf)throw new common_1[(_0x4a8708(0x22b))](_0x9b94bf,common_1[_0x4a8708(0x227)][_0x4a8708(0x204)]);return _0xa30c29;}async[_0x402667(0x1f8)](_0x343f03,_0x822a0c){const _0x580b52=_0x402667,_0x2feb92=await this[_0x580b52(0x1e3)]['getConfigs']([_0x580b52(0x205)]),_0x53ddaa=await this[_0x580b52(0x1e3)][_0x580b52(0x1ce)](['wechatOfficialAppSecret']),_0x10a065=await axios_1['default']['get'](_0x580b52(0x1e6)+_0x2feb92+_0x580b52(0x21f)+_0x53ddaa+_0x580b52(0x232)+_0x822a0c+'&grant_type=authorization_code'),{data:{errmsg:_0x4b11b4,openid:_0x13437c}}=_0x10a065;if(_0x4b11b4)throw new common_1[(_0x580b52(0x22b))](_0x4b11b4,common_1[_0x580b52(0x227)]['BAD_REQUEST']);let _0x24e6b2;return _0x24e6b2=await this['userService']['getUserOpenId'](_0x13437c),!_0x24e6b2&&(_0x24e6b2=await this[_0x580b52(0x211)][_0x580b52(0x1ea)](_0x13437c)),this['authService'][_0x580b52(0x1d5)](_0x24e6b2,_0x343f03);}async[_0x402667(0x1d6)](_0x578624,_0x563324){const _0x23f510=_0x402667;if(!this[_0x23f510(0x1e8)][_0x563324])throw new common_1[(_0x23f510(0x22b))](_0x23f510(0x1d0),common_1[_0x23f510(0x227)][_0x23f510(0x204)]);const _0x214875=await this[_0x23f510(0x211)][_0x23f510(0x1ea)](_0x578624,_0x563324);this[_0x23f510(0x1fe)][_0x563324]=_0x214875['id'];}async[_0x402667(0x22c)](_0x3748ff,_0x26739a){const _0xc63ecc=_0x402667;if(!this[_0xc63ecc(0x1e8)][_0x26739a])return;const _0x169894=this[_0xc63ecc(0x1fe)][_0x26739a];if(!_0x169894)return'';const _0x3bb484=await this[_0xc63ecc(0x211)][_0xc63ecc(0x1fc)](_0x169894);return delete this[_0xc63ecc(0x1fe)][_0x26739a],this['authService']['loginByOpenId'](_0x3bb484,_0x3748ff);}async[_0x402667(0x1da)](_0x535b96,_0x49ffd0){const _0x2c068a=_0x402667;if(!this[_0x2c068a(0x1e8)][_0x49ffd0])throw new common_1['HttpException']('非法参数',common_1[_0x2c068a(0x227)][_0x2c068a(0x204)]);const _0xf43d16=_0x49ffd0[_0x2c068a(0x1eb)]('/')[0x1],_0x56bb45=await this['userService'][_0x2c068a(0x1cd)](_0x535b96,_0xf43d16);this['scanedSceneStrMap'][_0x49ffd0]=_0x56bb45;}async[_0x402667(0x21c)](_0x5456da,_0x21bcab){const _0x24d51c=_0x402667;if(!this[_0x24d51c(0x1e8)][_0x21bcab])throw new common_1['HttpException'](_0x24d51c(0x1d0),common_1[_0x24d51c(0x227)]['BAD_REQUEST']);const {id:_0x54a1e9}=_0x5456da[_0x24d51c(0x1d3)],_0x3d1930=this[_0x24d51c(0x1fe)][_0x21bcab];if(!_0x3d1930)return'';return delete this[_0x24d51c(0x1fe)][_0x21bcab],_0x3d1930;}async[_0x402667(0x1f5)](_0x312838,_0x4a626c,_0x59a240){const _0x5b92c8=_0x402667,_0x28e077=await this[_0x5b92c8(0x1e3)][_0x5b92c8(0x1ce)](['wechatOfficialToken'])||'jiangly';return await this[_0x5b92c8(0x1df)]([_0x28e077,_0x4a626c,_0x59a240]['sort']()[_0x5b92c8(0x202)](''))==_0x312838;}[_0x402667(0x1df)](_0xbbd969){const _0x3a5578=_0x402667;return crypto[_0x3a5578(0x1e0)]('sha1')[_0x3a5578(0x1dc)](_0xbbd969)['digest'](_0x3a5578(0x223));}async[_0x402667(0x230)](_0x3a9fd9,_0x3057b0){const _0x2dddbf=_0x402667,_0x449c28=await this[_0x2dddbf(0x1e3)][_0x2dddbf(0x1ce)]([_0x3057b0]);return this['genXmlMsg'](_0x3a9fd9,_0x449c28);}async['genXmlMsg'](_0x364944,_0x2096a7){const _0x9f88bc=_0x402667;return _0x9f88bc(0x1fd)+_0x364944[_0x9f88bc(0x1d1)][0x0]+_0x9f88bc(0x20e)+_0x364944['tousername'][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+new Date()[_0x9f88bc(0x212)]()+_0x9f88bc(0x206)+_0x2096a7+']]></Content>\x0a\x20\x20\x20\x20</xml>';}async[_0x402667(0x1ee)](_0x42d3a6){const _0x3d66c3=_0x402667,_0x4754d7=new Promise((_0x104a61,_0x14a7e)=>{setTimeout(()=>{const _0xdca26d=_0x77c5;_0x14a7e(new Error(_0xdca26d(0x210)));},0x12c0);});let _0x3e4f36='';try{console[_0x3d66c3(0x1f2)](_0x3d66c3(0x1ef),_0x42d3a6);const _0x3816b0=await Promise['race']([this[_0x3d66c3(0x1dd)]['chatSyncFree'](_0x42d3a6),_0x4754d7]);_0x3e4f36=_0x3816b0||await this[_0x3d66c3(0x219)]['checkAutoReply'](_0x42d3a6);}catch(_0x134aa6){console['log'](_0x3d66c3(0x1d9)),_0x3e4f36=await this[_0x3d66c3(0x1e3)][_0x3d66c3(0x1ce)]([_0x3d66c3(0x1d4)])||_0x3d66c3(0x203);}return _0x3e4f36;}};OfficialService=__decorate([(0x0,common_1[_0x402667(0x1e4)])(),__metadata(_0x402667(0x1ec),[autoreply_service_1[_0x402667(0x1ff)],user_service_1['UserService'],auth_service_1[_0x402667(0x217)],globalConfig_service_1['GlobalConfigService'],chatgpt_service_1['ChatgptService']])],OfficialService),exports['OfficialService']=OfficialService;