'use strict';const _0x5f18bb=_0x3da3;(function(_0xba1fb3,_0x264b76){const _0x5d1e6a=_0x3da3,_0x3bd4e6=_0xba1fb3();while(!![]){try{const _0x31c3aa=-parseInt(_0x5d1e6a(0x236))/0x1*(parseInt(_0x5d1e6a(0x253))/0x2)+parseInt(_0x5d1e6a(0x215))/0x3*(-parseInt(_0x5d1e6a(0x256))/0x4)+parseInt(_0x5d1e6a(0x24c))/0x5*(-parseInt(_0x5d1e6a(0x246))/0x6)+-parseInt(_0x5d1e6a(0x203))/0x7+parseInt(_0x5d1e6a(0x218))/0x8+parseInt(_0x5d1e6a(0x217))/0x9+parseInt(_0x5d1e6a(0x201))/0xa;if(_0x31c3aa===_0x264b76)break;else _0x3bd4e6['push'](_0x3bd4e6['shift']());}catch(_0x26cc34){_0x3bd4e6['push'](_0x3bd4e6['shift']());}}}(_0x1eff,0x284ad));function _0x3da3(_0x252998,_0x41e51a){const _0x1eff27=_0x1eff();return _0x3da3=function(_0x3da3e2,_0x1079f1){_0x3da3e2=_0x3da3e2-0x1f0;let _0x1cce7a=_0x1eff27[_0x3da3e2];return _0x1cce7a;},_0x3da3(_0x252998,_0x41e51a);}var __decorate=this&&this['__decorate']||function(_0x549038,_0x3bb671,_0x18ba88,_0x4ddaa9){const _0x5d2eaa=_0x3da3;var _0x3eedca=arguments['length'],_0x4e5d7d=_0x3eedca<0x3?_0x3bb671:_0x4ddaa9===null?_0x4ddaa9=Object[_0x5d2eaa(0x1fe)](_0x3bb671,_0x18ba88):_0x4ddaa9,_0x48c55a;if(typeof Reflect===_0x5d2eaa(0x205)&&typeof Reflect[_0x5d2eaa(0x249)]===_0x5d2eaa(0x242))_0x4e5d7d=Reflect[_0x5d2eaa(0x249)](_0x549038,_0x3bb671,_0x18ba88,_0x4ddaa9);else{for(var _0x1e3be4=_0x549038[_0x5d2eaa(0x216)]-0x1;_0x1e3be4>=0x0;_0x1e3be4--)if(_0x48c55a=_0x549038[_0x1e3be4])_0x4e5d7d=(_0x3eedca<0x3?_0x48c55a(_0x4e5d7d):_0x3eedca>0x3?_0x48c55a(_0x3bb671,_0x18ba88,_0x4e5d7d):_0x48c55a(_0x3bb671,_0x18ba88))||_0x4e5d7d;}return _0x3eedca>0x3&&_0x4e5d7d&&Object[_0x5d2eaa(0x23f)](_0x3bb671,_0x18ba88,_0x4e5d7d),_0x4e5d7d;},__metadata=this&&this[_0x5f18bb(0x23e)]||function(_0x48a953,_0x45e348){const _0x536969=_0x5f18bb;if(typeof Reflect===_0x536969(0x205)&&typeof Reflect[_0x536969(0x213)]===_0x536969(0x242))return Reflect['metadata'](_0x48a953,_0x45e348);};Object[_0x5f18bb(0x23f)](exports,_0x5f18bb(0x244),{'value':!![]}),exports[_0x5f18bb(0x21a)]=void 0x0;function _0x1eff(){const _0x2a3079=['chatSyncFree','../../common/utils','getJsapiTicket','sha1','wechatOfficialAppId','toFixed','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','AutoreplyService','post','../auth/auth.service','回跳跳转地址:\x20','getQRSceneStrByBind','getUserFromOpenId','metadata','loginByCode','3FAAutU','length','354231iTYFyK','1500544mcuDjJ','aotoPlay','OfficialService','globalConfigService','wechatAccessToken','get','userService','&url=','GlobalConfigService','crypto','wechatJsapiTicket','scanedSceneStrMap','&code=','HttpStatus','非法参数','getUserById','sceneStrMap','createRandomNonceStr','log','来自公众号的询问问题\x20=======>\x20','genXmlMsgByConfig','axios','checkAutoReply','../user/user.service','fromusername','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','verify','jsapi_ticket=','由于公众号的回复限制、过长的问题我们可能无法回复、您可以前往我们的官方站点享受更加完善的服务、如果您有更多问题、欢迎像我提问！','bindWx','2399kulEUX','officialAutoReplyText','loginByOpenId','split','getRedirectUrl','jsapiTicket:\x20','&grant_type=authorization_code','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','__metadata','defineProperty','chatgptService','getUserOpenId','function',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','__esModule','loginBySceneStr','90wvBoCA','default','../autoreply/autoreply.service','decorate','bindWxBySceneStr','AuthService','25055QrYisD','scanBindWx','scan','UserService','autoreplyService','QR_STR_SCENE','HttpException','48BNwQbC','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','请求超时','822028TUDCAi','tousername','user',']]></Content>\x0a\x20\x20\x20\x20</xml>','appId:\x20','来自公众号的回复问题\x20=======>\x20超时导致问题无法回答完整','onModuleInit','&noncestr=','fetchQRCodeTicket','genXmlMsg','getTime','now','../chatgpt/chatgpt.service','getQRSceneStr','BAD_REQUEST','authService','getOwnPropertyDescriptor','Injectable','jiangly','5533040ioNlpn','&secret=','1938622PMvoGz','getConfigs','object'];_0x1eff=function(){return _0x2a3079;};return _0x1eff();}const chatgpt_service_1=require(_0x5f18bb(0x1fa)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),auth_service_1=require(_0x5f18bb(0x20f)),user_service_1=require(_0x5f18bb(0x22f)),autoreply_service_1=require(_0x5f18bb(0x248)),common_1=require('@nestjs/common'),crypto=require(_0x5f18bb(0x221)),axios_1=require(_0x5f18bb(0x22d)),utils_1=require(_0x5f18bb(0x207));let OfficialService=class OfficialService{constructor(_0x5afeea,_0x85bcdd,_0x24d7ae,_0x21d2d3,_0x1b3508){const _0x748a8=_0x5f18bb;this['autoreplyService']=_0x5afeea,this['userService']=_0x85bcdd,this[_0x748a8(0x1fd)]=_0x24d7ae,this[_0x748a8(0x21b)]=_0x21d2d3,this[_0x748a8(0x240)]=_0x1b3508,this[_0x748a8(0x228)]={},this[_0x748a8(0x223)]={};}async[_0x5f18bb(0x1f4)](){const _0x54048b=_0x5f18bb;await this[_0x54048b(0x21b)]['getWechatAccessToken'](!![]);}async[_0x5f18bb(0x1fb)](_0xec36a4){const _0x1223ba=_0x5f18bb,{invitedBy:_0x4ce85a}=_0xec36a4;let _0x5271f7=(0x0,utils_1[_0x1223ba(0x229)])(0x20);return _0x4ce85a&&(_0x5271f7+=':'+_0x4ce85a),this[_0x1223ba(0x228)][_0x5271f7]=!![],_0x5271f7;}async[_0x5f18bb(0x211)](_0x2b78f8){const _0x319e18=_0x5f18bb,{id:_0x1b1d66}=_0x2b78f8[_0x319e18(0x1f0)],_0x32410e=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x1b1d66;return this[_0x319e18(0x228)][_0x32410e]=!![],_0x32410e;}async['getQRCodeTicket'](_0xddd158){return this['fetchQRCodeTicket'](_0xddd158);}async[_0x5f18bb(0x23a)](_0x423d09){const _0x64121e=_0x5f18bb,_0x1d2e46=await this[_0x64121e(0x21b)][_0x64121e(0x204)]([_0x64121e(0x20a)]),_0x48882e=_0x64121e(0x20c)+_0x1d2e46+'&redirect_uri='+encodeURIComponent(_0x423d09)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console[_0x64121e(0x22a)](_0x64121e(0x210),_0x48882e),_0x48882e;}async[_0x5f18bb(0x208)](_0x5be87c){const _0x5efe96=_0x5f18bb,_0x3dbbca=(0x0,utils_1[_0x5efe96(0x229)])(0x20),_0x46c309=(Date[_0x5efe96(0x1f9)]()/0x3e8)[_0x5efe96(0x20b)](0x0),_0x2c9598=await this[_0x5efe96(0x21b)][_0x5efe96(0x204)]([_0x5efe96(0x222)]);console[_0x5efe96(0x22a)](_0x5efe96(0x23b),_0x2c9598);const _0x4188fa=await this['globalConfigService'][_0x5efe96(0x204)]([_0x5efe96(0x20a)]);console['log'](_0x5efe96(0x1f2),_0x4188fa);const _0x2e1525=_0x5efe96(0x233)+_0x2c9598+_0x5efe96(0x1f5)+_0x3dbbca+'&timestamp='+_0x46c309+_0x5efe96(0x21f)+_0x5be87c;console[_0x5efe96(0x22a)]('str:\x20',_0x2e1525);const _0x3dc3c9=this[_0x5efe96(0x209)](_0x2e1525);return{'appId':_0x4188fa,'nonceStr':_0x3dbbca,'timestamp':_0x46c309,'signature':_0x3dc3c9};}async[_0x5f18bb(0x1f6)](_0x429a15){const _0x31a008=_0x5f18bb,_0x223259=await this[_0x31a008(0x21b)]['getConfigs']([_0x31a008(0x21c)]),_0x4e649f={'action_name':_0x31a008(0x251),'action_info':{'scene':{'scene_str':_0x429a15}}},_0x291b32=await axios_1[_0x31a008(0x247)][_0x31a008(0x20e)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x223259,_0x4e649f),{data:{errmsg:_0x22a372,ticket:_0x78eee3}}=_0x291b32;if(_0x22a372)throw new common_1[(_0x31a008(0x252))](_0x22a372,common_1[_0x31a008(0x225)][_0x31a008(0x1fc)]);return _0x78eee3;}async[_0x5f18bb(0x214)](_0x2756e9,_0x413d61){const _0x5c91ae=_0x5f18bb,_0x50e1ed=await this[_0x5c91ae(0x21b)]['getConfigs']([_0x5c91ae(0x20a)]),_0x1513ab=await this['globalConfigService'][_0x5c91ae(0x204)](['wechatOfficialAppSecret']),_0x49be3b=await axios_1['default'][_0x5c91ae(0x21d)](_0x5c91ae(0x23d)+_0x50e1ed+_0x5c91ae(0x202)+_0x1513ab+_0x5c91ae(0x224)+_0x413d61+_0x5c91ae(0x23c)),{data:{errmsg:_0x3f3562,openid:_0x587524}}=_0x49be3b;if(_0x3f3562)throw new common_1['HttpException'](_0x3f3562,common_1[_0x5c91ae(0x225)][_0x5c91ae(0x1fc)]);let _0x584c06;return _0x584c06=await this['userService'][_0x5c91ae(0x241)](_0x587524),!_0x584c06&&(_0x584c06=await this[_0x5c91ae(0x21e)][_0x5c91ae(0x212)](_0x587524)),this[_0x5c91ae(0x1fd)][_0x5c91ae(0x238)](_0x584c06,_0x2756e9);}async[_0x5f18bb(0x24e)](_0x164be2,_0x272f6a){const _0xfc2974=_0x5f18bb;if(!this[_0xfc2974(0x228)][_0x272f6a])throw new common_1['HttpException']('非法参数',common_1['HttpStatus'][_0xfc2974(0x1fc)]);const _0x16087c=await this[_0xfc2974(0x21e)]['getUserFromOpenId'](_0x164be2,_0x272f6a);this[_0xfc2974(0x223)][_0x272f6a]=_0x16087c['id'];}async[_0x5f18bb(0x245)](_0x12836d,_0x3589e5){const _0x15b2eb=_0x5f18bb;if(!this['sceneStrMap'][_0x3589e5])return;const _0x38d5a4=this[_0x15b2eb(0x223)][_0x3589e5];if(!_0x38d5a4)return'';const _0x624acc=await this[_0x15b2eb(0x21e)][_0x15b2eb(0x227)](_0x38d5a4);return delete this['scanedSceneStrMap'][_0x3589e5],this[_0x15b2eb(0x1fd)]['loginByOpenId'](_0x624acc,_0x12836d);}async[_0x5f18bb(0x24d)](_0x15fb11,_0xbd200b){const _0x4357ff=_0x5f18bb;if(!this[_0x4357ff(0x228)][_0xbd200b])throw new common_1[(_0x4357ff(0x252))](_0x4357ff(0x226),common_1[_0x4357ff(0x225)][_0x4357ff(0x1fc)]);const _0x40abe1=_0xbd200b[_0x4357ff(0x239)]('/')[0x1],_0x3b9b2b=await this[_0x4357ff(0x21e)][_0x4357ff(0x235)](_0x15fb11,_0x40abe1);this[_0x4357ff(0x223)][_0xbd200b]=_0x3b9b2b;}async[_0x5f18bb(0x24a)](_0x1b72e5,_0x5231d2){const _0x1236b6=_0x5f18bb;if(!this[_0x1236b6(0x228)][_0x5231d2])throw new common_1[(_0x1236b6(0x252))](_0x1236b6(0x226),common_1[_0x1236b6(0x225)][_0x1236b6(0x1fc)]);const {id:_0x48cf19}=_0x1b72e5['user'],_0x269652=this[_0x1236b6(0x223)][_0x5231d2];if(!_0x269652)return'';return delete this[_0x1236b6(0x223)][_0x5231d2],_0x269652;}async[_0x5f18bb(0x232)](_0xe13850,_0x151e0c,_0xb6fe5c){const _0x13235f=_0x5f18bb,_0x5bc851=await this['globalConfigService'][_0x13235f(0x204)](['wechatOfficialToken'])||_0x13235f(0x200);return await this[_0x13235f(0x209)]([_0x5bc851,_0x151e0c,_0xb6fe5c]['sort']()['join'](''))==_0xe13850;}[_0x5f18bb(0x209)](_0x5dc156){const _0x3f4c05=_0x5f18bb;return crypto['createHash'](_0x3f4c05(0x209))['update'](_0x5dc156)['digest']('hex');}async[_0x5f18bb(0x22c)](_0x110b47,_0x35ff76){const _0x76bf24=_0x5f18bb,_0x2ce490=await this['globalConfigService']['getConfigs']([_0x35ff76]);return this[_0x76bf24(0x1f7)](_0x110b47,_0x2ce490);}async['genXmlMsg'](_0x1e37a8,_0x339052){const _0x434222=_0x5f18bb;return _0x434222(0x254)+_0x1e37a8[_0x434222(0x230)][0x0]+_0x434222(0x243)+_0x1e37a8[_0x434222(0x257)][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+new Date()[_0x434222(0x1f8)]()+_0x434222(0x231)+_0x339052+_0x434222(0x1f1);}async[_0x5f18bb(0x219)](_0x4ec808){const _0x38ac2c=_0x5f18bb,_0x1cb361=new Promise((_0x3518fd,_0xea4b51)=>{setTimeout(()=>{const _0x584ea1=_0x3da3;_0xea4b51(new Error(_0x584ea1(0x255)));},0x12c0);});let _0x209ca2='';try{console[_0x38ac2c(0x22a)](_0x38ac2c(0x22b),_0x4ec808);const _0x1276fa=await Promise['race']([this[_0x38ac2c(0x240)][_0x38ac2c(0x206)](_0x4ec808),_0x1cb361]);_0x209ca2=_0x1276fa||await this[_0x38ac2c(0x250)][_0x38ac2c(0x22e)](_0x4ec808);}catch(_0x1b2138){console[_0x38ac2c(0x22a)](_0x38ac2c(0x1f3)),_0x209ca2=await this[_0x38ac2c(0x21b)][_0x38ac2c(0x204)]([_0x38ac2c(0x237)])||_0x38ac2c(0x234);}return _0x209ca2;}};OfficialService=__decorate([(0x0,common_1[_0x5f18bb(0x1ff)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x5f18bb(0x20d)],user_service_1[_0x5f18bb(0x24f)],auth_service_1[_0x5f18bb(0x24b)],globalConfig_service_1[_0x5f18bb(0x220)],chatgpt_service_1['ChatgptService']])],OfficialService),exports[_0x5f18bb(0x21a)]=OfficialService;